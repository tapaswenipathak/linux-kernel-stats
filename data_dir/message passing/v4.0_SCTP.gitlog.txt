commit dc1ccb4c0f850038a35eddc919a65b3131925a6c
Author: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
Date:   Tue Jan 24 02:47:21 2023 +0100

    netfilter: conntrack: unify established states for SCTP paths
    
    commit a44b7651489f26271ac784b70895e8a85d0cebf4 upstream.
    
    An SCTP endpoint can start an association through a path and tear it
    down over another one. That means the initial path will not see the
    shutdown sequence, and the conntrack entry will remain in ESTABLISHED
    state for 5 days.
    
    By merging the HEARTBEAT_ACKED and ESTABLISHED states into one
    ESTABLISHED state, there remains no difference between a primary or
    secondary path. The timeout for the merged ESTABLISHED state is set to
    210 seconds (hb_interval * max_path_retrans + rto_max). So, even if a
    path doesn't see the shutdown sequence, it will expire in a reasonable
    amount of time.
    
    With this change in place, there is now more than one state from which
    we can transition to ESTABLISHED, COOKIE_ECHOED and HEARTBEAT_SENT, so
    handle the setting of ASSURED bit whenever a state change has happened
    and the new state is ESTABLISHED. Removed the check for dir==REPLY since
    the transition to ESTABLISHED can happen only in the reply direction.
    
    Fixes: 9fb9cbb1082d ("[NETFILTER]: Add nf_conntrack subsystem.")
    Signed-off-by: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9f08bb650078dca24a13fea1c375358ed6292df3
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jan 23 14:59:33 2023 -0300

    sctp: fail if no bound addresses can be used for a given scope
    
    [ Upstream commit 458e279f861d3f61796894cd158b780765a1569f ]
    
    Currently, if you bind the socket to something like:
            servaddr.sin6_family = AF_INET6;
            servaddr.sin6_port = htons(0);
            servaddr.sin6_scope_id = 0;
            inet_pton(AF_INET6, "::1", &servaddr.sin6_addr);
    
    And then request a connect to:
            connaddr.sin6_family = AF_INET6;
            connaddr.sin6_port = htons(20000);
            connaddr.sin6_scope_id = if_nametoindex("lo");
            inet_pton(AF_INET6, "fe88::1", &connaddr.sin6_addr);
    
    What the stack does is:
     - bind the socket
     - create a new asoc
     - to handle the connect
       - copy the addresses that can be used for the given scope
       - try to connect
    
    But the copy returns 0 addresses, and the effect is that it ends up
    trying to connect as if the socket wasn't bound, which is not the
    desired behavior. This unexpected behavior also allows KASLR leaks
    through SCTP diag interface.
    
    The fix here then is, if when trying to copy the addresses that can
    be used for the scope used in connect() it returns 0 addresses, bail
    out. This is what TCP does with a similar reproducer.
    
    Reported-by: Pietro Borrello <borrello@diag.uniroma1.it>
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/9fcd182f1099f86c6661f3717f63712ddd1c676c.1674496737.git.marcelo.leitner@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 033636b32258de679fd990717528eed45b104a0d
Author: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
Date:   Tue Jan 24 02:47:21 2023 +0100

    netfilter: conntrack: unify established states for SCTP paths
    
    commit a44b7651489f26271ac784b70895e8a85d0cebf4 upstream.
    
    An SCTP endpoint can start an association through a path and tear it
    down over another one. That means the initial path will not see the
    shutdown sequence, and the conntrack entry will remain in ESTABLISHED
    state for 5 days.
    
    By merging the HEARTBEAT_ACKED and ESTABLISHED states into one
    ESTABLISHED state, there remains no difference between a primary or
    secondary path. The timeout for the merged ESTABLISHED state is set to
    210 seconds (hb_interval * max_path_retrans + rto_max). So, even if a
    path doesn't see the shutdown sequence, it will expire in a reasonable
    amount of time.
    
    With this change in place, there is now more than one state from which
    we can transition to ESTABLISHED, COOKIE_ECHOED and HEARTBEAT_SENT, so
    handle the setting of ASSURED bit whenever a state change has happened
    and the new state is ESTABLISHED. Removed the check for dir==REPLY since
    the transition to ESTABLISHED can happen only in the reply direction.
    
    Fixes: 9fb9cbb1082d ("[NETFILTER]: Add nf_conntrack subsystem.")
    Signed-off-by: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3391bd42351be0beb14f438c7556912b9f96cb32
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jan 23 14:59:33 2023 -0300

    sctp: fail if no bound addresses can be used for a given scope
    
    [ Upstream commit 458e279f861d3f61796894cd158b780765a1569f ]
    
    Currently, if you bind the socket to something like:
            servaddr.sin6_family = AF_INET6;
            servaddr.sin6_port = htons(0);
            servaddr.sin6_scope_id = 0;
            inet_pton(AF_INET6, "::1", &servaddr.sin6_addr);
    
    And then request a connect to:
            connaddr.sin6_family = AF_INET6;
            connaddr.sin6_port = htons(20000);
            connaddr.sin6_scope_id = if_nametoindex("lo");
            inet_pton(AF_INET6, "fe88::1", &connaddr.sin6_addr);
    
    What the stack does is:
     - bind the socket
     - create a new asoc
     - to handle the connect
       - copy the addresses that can be used for the given scope
       - try to connect
    
    But the copy returns 0 addresses, and the effect is that it ends up
    trying to connect as if the socket wasn't bound, which is not the
    desired behavior. This unexpected behavior also allows KASLR leaks
    through SCTP diag interface.
    
    The fix here then is, if when trying to copy the addresses that can
    be used for the scope used in connect() it returns 0 addresses, bail
    out. This is what TCP does with a similar reproducer.
    
    Reported-by: Pietro Borrello <borrello@diag.uniroma1.it>
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/9fcd182f1099f86c6661f3717f63712ddd1c676c.1674496737.git.marcelo.leitner@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 743435cd1705b4a3a4b8e73a538c4c1a1efc7edb
Author: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
Date:   Tue Jan 24 02:47:21 2023 +0100

    netfilter: conntrack: unify established states for SCTP paths
    
    commit a44b7651489f26271ac784b70895e8a85d0cebf4 upstream.
    
    An SCTP endpoint can start an association through a path and tear it
    down over another one. That means the initial path will not see the
    shutdown sequence, and the conntrack entry will remain in ESTABLISHED
    state for 5 days.
    
    By merging the HEARTBEAT_ACKED and ESTABLISHED states into one
    ESTABLISHED state, there remains no difference between a primary or
    secondary path. The timeout for the merged ESTABLISHED state is set to
    210 seconds (hb_interval * max_path_retrans + rto_max). So, even if a
    path doesn't see the shutdown sequence, it will expire in a reasonable
    amount of time.
    
    With this change in place, there is now more than one state from which
    we can transition to ESTABLISHED, COOKIE_ECHOED and HEARTBEAT_SENT, so
    handle the setting of ASSURED bit whenever a state change has happened
    and the new state is ESTABLISHED. Removed the check for dir==REPLY since
    the transition to ESTABLISHED can happen only in the reply direction.
    
    Fixes: 9fb9cbb1082d ("[NETFILTER]: Add nf_conntrack subsystem.")
    Signed-off-by: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6ef652f35dcfaa1ab2b2cf6c1694718595148eee
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jan 23 14:59:33 2023 -0300

    sctp: fail if no bound addresses can be used for a given scope
    
    [ Upstream commit 458e279f861d3f61796894cd158b780765a1569f ]
    
    Currently, if you bind the socket to something like:
            servaddr.sin6_family = AF_INET6;
            servaddr.sin6_port = htons(0);
            servaddr.sin6_scope_id = 0;
            inet_pton(AF_INET6, "::1", &servaddr.sin6_addr);
    
    And then request a connect to:
            connaddr.sin6_family = AF_INET6;
            connaddr.sin6_port = htons(20000);
            connaddr.sin6_scope_id = if_nametoindex("lo");
            inet_pton(AF_INET6, "fe88::1", &connaddr.sin6_addr);
    
    What the stack does is:
     - bind the socket
     - create a new asoc
     - to handle the connect
       - copy the addresses that can be used for the given scope
       - try to connect
    
    But the copy returns 0 addresses, and the effect is that it ends up
    trying to connect as if the socket wasn't bound, which is not the
    desired behavior. This unexpected behavior also allows KASLR leaks
    through SCTP diag interface.
    
    The fix here then is, if when trying to copy the addresses that can
    be used for the scope used in connect() it returns 0 addresses, bail
    out. This is what TCP does with a similar reproducer.
    
    Reported-by: Pietro Borrello <borrello@diag.uniroma1.it>
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/9fcd182f1099f86c6661f3717f63712ddd1c676c.1674496737.git.marcelo.leitner@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 28b4387f0ec08d48634fcc3e3687c93edc1503f9
Merge: 262b42e02d1e 7083df59abbc
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Jan 26 10:20:12 2023 -0800

    Merge tag 'net-6.2-rc6' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from Paolo Abeni:
     "Including fixes from netfilter.
    
      Current release - regressions:
    
       - sched: sch_taprio: do not schedule in taprio_reset()
    
      Previous releases - regressions:
    
       - core: fix UaF in netns ops registration error path
    
       - ipv4: prevent potential spectre v1 gadgets
    
       - ipv6: fix reachability confirmation with proxy_ndp
    
       - netfilter: fix for the set rbtree
    
       - eth: fec: use page_pool_put_full_page when freeing rx buffers
    
       - eth: iavf: fix temporary deadlock and failure to set MAC address
    
      Previous releases - always broken:
    
       - netlink: prevent potential spectre v1 gadgets
    
       - netfilter: fixes for SCTP connection tracking
    
       - mctp: struct sock lifetime fixes
    
       - eth: ravb: fix possible hang if RIS2_QFF1 happen
    
       - eth: tg3: resolve deadlock in tg3_reset_task() during EEH
    
      Misc:
    
       - Mat stepped out as MPTCP co-maintainer"
    
    * tag 'net-6.2-rc6' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (40 commits)
      net: mdio-mux-meson-g12a: force internal PHY off on mux switch
      docs: networking: Fix bridge documentation URL
      tsnep: Fix TX queue stop/wake for multiple queues
      net/tg3: resolve deadlock in tg3_reset_task() during EEH
      net: mctp: mark socks as dead on unhash, prevent re-add
      net: mctp: hold key reference when looking up a general key
      net: mctp: move expiry timer delete to unhash
      net: mctp: add an explicit reference from a mctp_sk_key to sock
      net: ravb: Fix possible hang if RIS2_QFF1 happen
      net: ravb: Fix lack of register setting after system resumed for Gen3
      net/x25: Fix to not accept on connected socket
      ice: move devlink port creation/deletion
      sctp: fail if no bound addresses can be used for a given scope
      net/sched: sch_taprio: do not schedule in taprio_reset()
      Revert "Merge branch 'ethtool-mac-merge'"
      netrom: Fix use-after-free of a listening socket.
      netfilter: conntrack: unify established states for SCTP paths
      Revert "netfilter: conntrack: add sctp DATA_SENT state"
      netfilter: conntrack: fix bug in for_each_sctp_chunk
      netfilter: conntrack: fix vtag checks for ABORT/SHUTDOWN_COMPLETE
      ...

commit 2a48216cff7a2e3964fbed16f84d33f68b3e5e42
Merge: 418e53401e47 a44b7651489f
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Tue Jan 24 18:59:37 2023 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    1) Perform SCTP vtag verification for ABORT/SHUTDOWN_COMPLETE according
       to RFC 9260, Sect 8.5.1.
    
    2) Fix infinite loop if SCTP chunk size is zero in for_each_sctp_chunk().
       And remove useless check in this macro too.
    
    3) Revert DATA_SENT state in the SCTP tracker, this was applied in the
       previous merge window. Next patch in this series provides a more
       simple approach to multihoming support.
    
    4) Unify HEARTBEAT_ACKED and ESTABLISHED states for SCTP multihoming
       support, use default ESTABLISHED of 210 seconds based on
       heartbeat timeout * maximum number of retransmission + round-trip timeout.
       Otherwise, SCTP conntrack entry that represents secondary paths
       remain stale in the table for up to 5 days.
    
    This is a slightly large batch with fixes for the SCTP connection
    tracking helper, all patches from Sriram Yagnaraman.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf:
      netfilter: conntrack: unify established states for SCTP paths
      Revert "netfilter: conntrack: add sctp DATA_SENT state"
      netfilter: conntrack: fix bug in for_each_sctp_chunk
      netfilter: conntrack: fix vtag checks for ABORT/SHUTDOWN_COMPLETE
    ====================
    
    Link: https://lore.kernel.org/r/20230124183933.4752-1-pablo@netfilter.org
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 458e279f861d3f61796894cd158b780765a1569f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jan 23 14:59:33 2023 -0300

    sctp: fail if no bound addresses can be used for a given scope
    
    Currently, if you bind the socket to something like:
            servaddr.sin6_family = AF_INET6;
            servaddr.sin6_port = htons(0);
            servaddr.sin6_scope_id = 0;
            inet_pton(AF_INET6, "::1", &servaddr.sin6_addr);
    
    And then request a connect to:
            connaddr.sin6_family = AF_INET6;
            connaddr.sin6_port = htons(20000);
            connaddr.sin6_scope_id = if_nametoindex("lo");
            inet_pton(AF_INET6, "fe88::1", &connaddr.sin6_addr);
    
    What the stack does is:
     - bind the socket
     - create a new asoc
     - to handle the connect
       - copy the addresses that can be used for the given scope
       - try to connect
    
    But the copy returns 0 addresses, and the effect is that it ends up
    trying to connect as if the socket wasn't bound, which is not the
    desired behavior. This unexpected behavior also allows KASLR leaks
    through SCTP diag interface.
    
    The fix here then is, if when trying to copy the addresses that can
    be used for the scope used in connect() it returns 0 addresses, bail
    out. This is what TCP does with a similar reproducer.
    
    Reported-by: Pietro Borrello <borrello@diag.uniroma1.it>
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/9fcd182f1099f86c6661f3717f63712ddd1c676c.1674496737.git.marcelo.leitner@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit a44b7651489f26271ac784b70895e8a85d0cebf4
Author: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
Date:   Tue Jan 24 02:47:21 2023 +0100

    netfilter: conntrack: unify established states for SCTP paths
    
    An SCTP endpoint can start an association through a path and tear it
    down over another one. That means the initial path will not see the
    shutdown sequence, and the conntrack entry will remain in ESTABLISHED
    state for 5 days.
    
    By merging the HEARTBEAT_ACKED and ESTABLISHED states into one
    ESTABLISHED state, there remains no difference between a primary or
    secondary path. The timeout for the merged ESTABLISHED state is set to
    210 seconds (hb_interval * max_path_retrans + rto_max). So, even if a
    path doesn't see the shutdown sequence, it will expire in a reasonable
    amount of time.
    
    With this change in place, there is now more than one state from which
    we can transition to ESTABLISHED, COOKIE_ECHOED and HEARTBEAT_SENT, so
    handle the setting of ASSURED bit whenever a state change has happened
    and the new state is ESTABLISHED. Removed the check for dir==REPLY since
    the transition to ESTABLISHED can happen only in the reply direction.
    
    Fixes: 9fb9cbb1082d ("[NETFILTER]: Add nf_conntrack subsystem.")
    Signed-off-by: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit ae5d96bae3cce68aca11571963ee509586c949f8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:40 2021 +0800

    net: igc: use skb_csum_is_sctp instead of protocol check
    
    [ Upstream commit 609d29a9d2429a840a2f1f44e77b71d58e3e9a33 ]
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP CRC
    checksum offload packet, and yet it also makes igc support SCTP
    CRC checksum offload for UDP and GRE encapped packets, just as it
    does in igb driver.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Stable-dep-of: db0b124f02ba ("igc: Enhance Qbv scheduling by using first flag bit")
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4794d07fe635a87b959db3383fd01d081a65c937
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:37 2021 +0800

    net: add inline function skb_csum_is_sctp
    
    [ Upstream commit fa82117010430aff2ce86400f7328f55a31b48a6 ]
    
    This patch is to define a inline function skb_csum_is_sctp(), and
    also replace all places where it checks if it's a SCTP CSUM skb.
    This function would be used later in many networking drivers in
    the following patches.
    
    Suggested-by: Alexander Duyck <alexander.duyck@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Stable-dep-of: db0b124f02ba ("igc: Enhance Qbv scheduling by using first flag bit")
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7ae9888d6e1ce4062d27367a28e46a26270a3e52
Merge: 2d4ee16d969c f9645abe4255
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Tue Dec 13 19:32:52 2022 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS fixes for net
    
    1) Fix NAT IPv6 flowtable hardware offload, from Qingfang DENG.
    
    2) Add a safety check to IPVS socket option interface report a
       warning if unsupported command is seen, this. From Li Qiong.
    
    3) Document SCTP conntrack timeouts, from Sriram Yagnaraman.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf:
      netfilter: conntrack: document sctp timeouts
      ipvs: add a 'default' case in do_ip_vs_set_ctl()
      netfilter: flowtable: really fix NAT IPv6 offload
    ====================
    
    Link: https://lore.kernel.org/r/20221213140923.154594-1-pablo@netfilter.org
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 7e68dd7d07a28faa2e6574dd6b9dbd90cdeaae91
Merge: 1ca06f1c1ace 7c4a6309e27f
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Dec 13 15:47:48 2022 -0800

    Merge tag 'net-next-6.2' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next
    
    Pull networking updates from Paolo Abeni:
     "Core:
    
       - Allow live renaming when an interface is up
    
       - Add retpoline wrappers for tc, improving considerably the
         performances of complex queue discipline configurations
    
       - Add inet drop monitor support
    
       - A few GRO performance improvements
    
       - Add infrastructure for atomic dev stats, addressing long standing
         data races
    
       - De-duplicate common code between OVS and conntrack offloading
         infrastructure
    
       - A bunch of UBSAN_BOUNDS/FORTIFY_SOURCE improvements
    
       - Netfilter: introduce packet parser for tunneled packets
    
       - Replace IPVS timer-based estimators with kthreads to scale up the
         workload with the number of available CPUs
    
       - Add the helper support for connection-tracking OVS offload
    
      BPF:
    
       - Support for user defined BPF objects: the use case is to allocate
         own objects, build own object hierarchies and use the building
         blocks to build own data structures flexibly, for example, linked
         lists in BPF
    
       - Make cgroup local storage available to non-cgroup attached BPF
         programs
    
       - Avoid unnecessary deadlock detection and failures wrt BPF task
         storage helpers
    
       - A relevant bunch of BPF verifier fixes and improvements
    
       - Veristat tool improvements to support custom filtering, sorting,
         and replay of results
    
       - Add LLVM disassembler as default library for dumping JITed code
    
       - Lots of new BPF documentation for various BPF maps
    
       - Add bpf_rcu_read_{,un}lock() support for sleepable programs
    
       - Add RCU grace period chaining to BPF to wait for the completion of
         access from both sleepable and non-sleepable BPF programs
    
       - Add support storing struct task_struct objects as kptrs in maps
    
       - Improve helper UAPI by explicitly defining BPF_FUNC_xxx integer
         values
    
       - Add libbpf *_opts API-variants for bpf_*_get_fd_by_id() functions
    
      Protocols:
    
       - TCP: implement Protective Load Balancing across switch links
    
       - TCP: allow dynamically disabling TCP-MD5 static key, reverting back
         to fast[er]-path
    
       - UDP: Introduce optional per-netns hash lookup table
    
       - IPv6: simplify and cleanup sockets disposal
    
       - Netlink: support different type policies for each generic netlink
         operation
    
       - MPTCP: add MSG_FASTOPEN and FastOpen listener side support
    
       - MPTCP: add netlink notification support for listener sockets events
    
       - SCTP: add VRF support, allowing sctp sockets binding to VRF devices
    
       - Add bridging MAC Authentication Bypass (MAB) support
    
       - Extensions for Ethernet VPN bridging implementation to better
         support multicast scenarios
    
       - More work for Wi-Fi 7 support, comprising conversion of all the
         existing drivers to internal TX queue usage
    
       - IPSec: introduce a new offload type (packet offload) allowing
         complete header processing and crypto offloading
    
       - IPSec: extended ack support for more descriptive XFRM error
         reporting
    
       - RXRPC: increase SACK table size and move processing into a
         per-local endpoint kernel thread, reducing considerably the
         required locking
    
       - IEEE 802154: synchronous send frame and extended filtering support,
         initial support for scanning available 15.4 networks
    
       - Tun: bump the link speed from 10Mbps to 10Gbps
    
       - Tun/VirtioNet: implement UDP segmentation offload support
    
      Driver API:
    
       - PHY/SFP: improve power level switching between standard level 1 and
         the higher power levels
    
       - New API for netdev <-> devlink_port linkage
    
       - PTP: convert existing drivers to new frequency adjustment
         implementation
    
       - DSA: add support for rx offloading
    
       - Autoload DSA tagging driver when dynamically changing protocol
    
       - Add new PCP and APPTRUST attributes to Data Center Bridging
    
       - Add configuration support for 800Gbps link speed
    
       - Add devlink port function attribute to enable/disable RoCE and
         migratable
    
       - Extend devlink-rate to support strict prioriry and weighted fair
         queuing
    
       - Add devlink support to directly reading from region memory
    
       - New device tree helper to fetch MAC address from nvmem
    
       - New big TCP helper to simplify temporary header stripping
    
      New hardware / drivers:
    
       - Ethernet:
          - Marvel Octeon CNF95N and CN10KB Ethernet Switches
          - Marvel Prestera AC5X Ethernet Switch
          - WangXun 10 Gigabit NIC
          - Motorcomm yt8521 Gigabit Ethernet
          - Microchip ksz9563 Gigabit Ethernet Switch
          - Microsoft Azure Network Adapter
          - Linux Automation 10Base-T1L adapter
    
       - PHY:
          - Aquantia AQR112 and AQR412
          - Motorcomm YT8531S
    
       - PTP:
          - Orolia ART-CARD
    
       - WiFi:
          - MediaTek Wi-Fi 7 (802.11be) devices
          - RealTek rtw8821cu, rtw8822bu, rtw8822cu and rtw8723du USB
            devices
    
       - Bluetooth:
          - Broadcom BCM4377/4378/4387 Bluetooth chipsets
          - Realtek RTL8852BE and RTL8723DS
          - Cypress.CYW4373A0 WiFi + Bluetooth combo device
    
      Drivers:
    
       - CAN:
          - gs_usb: bus error reporting support
          - kvaser_usb: listen only and bus error reporting support
    
       - Ethernet NICs:
          - Intel (100G):
             - extend action skbedit to RX queue mapping
             - implement devlink-rate support
             - support direct read from memory
          - nVidia/Mellanox (mlx5):
             - SW steering improvements, increasing rules update rate
             - Support for enhanced events compression
             - extend H/W offload packet manipulation capabilities
             - implement IPSec packet offload mode
          - nVidia/Mellanox (mlx4):
             - better big TCP support
          - Netronome Ethernet NICs (nfp):
             - IPsec offload support
             - add support for multicast filter
          - Broadcom:
             - RSS and PTP support improvements
          - AMD/SolarFlare:
             - netlink extened ack improvements
             - add basic flower matches to offload, and related stats
          - Virtual NICs:
             - ibmvnic: introduce affinity hint support
          - small / embedded:
             - FreeScale fec: add initial XDP support
             - Marvel mv643xx_eth: support MII/GMII/RGMII modes for Kirkwood
             - TI am65-cpsw: add suspend/resume support
             - Mediatek MT7986: add RX wireless wthernet dispatch support
             - Realtek 8169: enable GRO software interrupt coalescing per
               default
    
       - Ethernet high-speed switches:
          - Microchip (sparx5):
             - add support for Sparx5 TC/flower H/W offload via VCAP
          - Mellanox mlxsw:
             - add 802.1X and MAC Authentication Bypass offload support
             - add ip6gre support
    
       - Embedded Ethernet switches:
          - Mediatek (mtk_eth_soc):
             - improve PCS implementation, add DSA untag support
             - enable flow offload support
          - Renesas:
             - add rswitch R-Car Gen4 gPTP support
          - Microchip (lan966x):
             - add full XDP support
             - add TC H/W offload via VCAP
             - enable PTP on bridge interfaces
          - Microchip (ksz8):
             - add MTU support for KSZ8 series
    
       - Qualcomm 802.11ax WiFi (ath11k):
          - support configuring channel dwell time during scan
    
       - MediaTek WiFi (mt76):
          - enable Wireless Ethernet Dispatch (WED) offload support
          - add ack signal support
          - enable coredump support
          - remain_on_channel support
    
       - Intel WiFi (iwlwifi):
          - enable Wi-Fi 7 Extremely High Throughput (EHT) PHY capabilities
          - 320 MHz channels support
    
       - RealTek WiFi (rtw89):
          - new dynamic header firmware format support
          - wake-over-WLAN support"
    
    * tag 'net-next-6.2' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next: (2002 commits)
      ipvs: fix type warning in do_div() on 32 bit
      net: lan966x: Remove a useless test in lan966x_ptp_add_trap()
      net: ipa: add IPA v4.7 support
      dt-bindings: net: qcom,ipa: Add SM6350 compatible
      bnxt: Use generic HBH removal helper in tx path
      IPv6/GRO: generic helper to remove temporary HBH/jumbo header in driver
      selftests: forwarding: Add bridge MDB test
      selftests: forwarding: Rename bridge_mdb test
      bridge: mcast: Support replacement of MDB port group entries
      bridge: mcast: Allow user space to specify MDB entry routing protocol
      bridge: mcast: Allow user space to add (*, G) with a source list and filter mode
      bridge: mcast: Add support for (*, G) with a source list and filter mode
      bridge: mcast: Avoid arming group timer when (S, G) corresponds to a source
      bridge: mcast: Add a flag for user installed source entries
      bridge: mcast: Expose __br_multicast_del_group_src()
      bridge: mcast: Expose br_multicast_new_group_src()
      bridge: mcast: Add a centralized error path
      bridge: mcast: Place netlink policy before validation functions
      bridge: mcast: Split (*, G) and (S, G) addition into different functions
      bridge: mcast: Do not derive entry type from its filter mode
      ...

commit 95d1815f0970d2f8e980a9a53dd0bf215de4d90a
Merge: 15eb16217621 144361c1949f
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Mon Dec 12 14:45:36 2022 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS updates for net-next
    
    1) Incorrect error check in nft_expr_inner_parse(), from Dan Carpenter.
    
    2) Add DATA_SENT state to SCTP connection tracking helper, from
       Sriram Yagnaraman.
    
    3) Consolidate nf_confirm for ipv4 and ipv6, from Florian Westphal.
    
    4) Add bitmask support for ipset, from Vishwanath Pai.
    
    5) Handle icmpv6 redirects as RELATED, from Florian Westphal.
    
    6) Add WARN_ON_ONCE() to impossible case in flowtable datapath,
       from Li Qiong.
    
    7) A large batch of IPVS updates to replace timer-based estimators by
       kthreads to scale up wrt. CPUs and workload (millions of estimators).
    
    Julian Anastasov says:
    
            This patchset implements stats estimation in kthread context.
    It replaces the code that runs on single CPU in timer context every 2
    seconds and causing latency splats as shown in reports [1], [2], [3].
    The solution targets setups with thousands of IPVS services,
    destinations and multi-CPU boxes.
    
            Spread the estimation on multiple (configured) CPUs and multiple
    time slots (timer ticks) by using multiple chains organized under RCU
    rules.  When stats are not needed, it is recommended to use
    run_estimation=0 as already implemented before this change.
    
    RCU Locking:
    
    - As stats are now RCU-locked, tot_stats, svc and dest which
    hold estimator structures are now always freed from RCU
    callback. This ensures RCU grace period after the
    ip_vs_stop_estimator() call.
    
    Kthread data:
    
    - every kthread works over its own data structure and all
    such structures are attached to array. For now we limit
    kthreads depending on the number of CPUs.
    
    - even while there can be a kthread structure, its task
    may not be running, eg. before first service is added or
    while the sysctl var is set to an empty cpulist or
    when run_estimation is set to 0 to disable the estimation.
    
    - the allocated kthread context may grow from 1 to 50
    allocated structures for timer ticks which saves memory for
    setups with small number of estimators
    
    - a task and its structure may be released if all
    estimators are unlinked from its chains, leaving the
    slot in the array empty
    
    - every kthread data structure allows limited number
    of estimators. Kthread 0 is also used to initially
    calculate the max number of estimators to allow in every
    chain considering a sub-100 microsecond cond_resched
    rate. This number can be from 1 to hundreds.
    
    - kthread 0 has an additional job of optimizing the
    adding of estimators: they are first added in
    temp list (est_temp_list) and later kthread 0
    distributes them to other kthreads. The optimization
    is based on the fact that newly added estimator
    should be estimated after 2 seconds, so we have the
    time to offload the adding to chain from controlling
    process to kthread 0.
    
    - to add new estimators we use the last added kthread
    context (est_add_ktid). The new estimators are linked to
    the chains just before the estimated one, based on add_row.
    This ensures their estimation will start after 2 seconds.
    If estimators are added in bursts, common case if all
    services and dests are initially configured, we may
    spread the estimators to more chains and as result,
    reducing the initial delay below 2 seconds.
    
    Many thanks to Jiri Wiesner for his valuable comments
    and for spending a lot of time reviewing and testing
    the changes on different platforms with 48-256 CPUs and
    1-8 NUMA nodes under different cpufreq governors.
    
    The new IPVS estimators do not use workqueue infrastructure
    because:
    
    - The estimation can take long time when using multiple IPVS rules (eg.
      millions estimator structures) and especially when box has multiple
      CPUs due to the for_each_possible_cpu usage that expects packets from
      any CPU. With est_nice sysctl we have more control how to prioritize the
      estimation kthreads compared to other processes/kthreads that have
      latency requirements (such as servers). As a benefit, we can see these
      kthreads in top and decide if we will need some further control to limit
      their CPU usage (max number of structure to estimate per kthread).
    
    - with kthreads we run code that is read-mostly, no write/lock
      operations to process the estimators in 2-second intervals.
    
    - work items are one-shot: as estimators are processed every
      2 seconds, they need to be re-added every time. This again
      loads the timers (add_timer) if we use delayed works, as there are
      no kthreads to do the timings.
    
    [1] Report from Yunhong Jiang:
        https://lore.kernel.org/netdev/D25792C1-1B89-45DE-9F10-EC350DC04ADC@gmail.com/
    [2] https://marc.info/?l=linux-virtual-server&m=159679809118027&w=2
    [3] Report from Dust:
        https://archive.linuxvirtualserver.org/html/lvs-devel/2020-12/msg00000.html
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf-next:
      ipvs: run_estimation should control the kthread tasks
      ipvs: add est_cpulist and est_nice sysctl vars
      ipvs: use kthreads for stats estimation
      ipvs: use u64_stats_t for the per-cpu counters
      ipvs: use common functions for stats allocation
      ipvs: add rcu protection to stats
      netfilter: flowtable: add a 'default' case to flowtable datapath
      netfilter: conntrack: set icmpv6 redirects as RELATED
      netfilter: ipset: Add support for new bitmask parameter
      netfilter: conntrack: merge ipv4+ipv6 confirm functions
      netfilter: conntrack: add sctp DATA_SENT state
      netfilter: nft_inner: fix IS_ERR() vs NULL check
    ====================
    
    Link: https://lore.kernel.org/r/20221211101204.1751-1-pablo@netfilter.org
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit bff3d0534804452e19c097ae6b4eb4b4d846d67f
Author: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
Date:   Fri Nov 4 18:18:35 2022 +0100

    netfilter: conntrack: add sctp DATA_SENT state
    
    SCTP conntrack currently assumes that the SCTP endpoints will
    probe secondary paths using HEARTBEAT before sending traffic.
    
    But, according to RFC 9260, SCTP endpoints can send any traffic
    on any of the confirmed paths after SCTP association is up.
    SCTP endpoints that sends INIT will confirm all peer addresses
    that upper layer configures, and the SCTP endpoint that receives
    COOKIE_ECHO will only confirm the address it sent the INIT_ACK to.
    
    So, we can have a situation where the INIT sender can start to
    use secondary paths without the need to send HEARTBEAT. This patch
    allows DATA/SACK packets to create new connection tracking entry.
    
    A new state has been added to indicate that a DATA/SACK chunk has
    been seen in the original direction - SCTP_CONNTRACK_DATA_SENT.
    State transitions mostly follows the HEARTBEAT_SENT, except on
    receiving HEARTBEAT/HEARTBEAT_ACK/DATA/SACK in the reply direction.
    
    State transitions in original direction:
    - DATA_SENT behaves similar to HEARTBEAT_SENT for all chunks,
       except that it remains in DATA_SENT on receving HEARTBEAT,
       HEARTBEAT_ACK/DATA/SACK chunks
    State transitions in reply direction:
    - DATA_SENT behaves similar to HEARTBEAT_SENT for all chunks,
       except that it moves to HEARTBEAT_ACKED on receiving
       HEARTBEAT/HEARTBEAT_ACK/DATA/SACK chunks
    
    Note: This patch still doesn't solve the problem when the SCTP
    endpoint decides to use primary paths for association establishment
    but uses a secondary path for association shutdown. We still have
    to depend on timeout for connections to expire in such a case.
    
    Signed-off-by: Sriram Yagnaraman <sriram.yagnaraman@est.tech>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 4f567acb0b8622fe265aac4b0037a03ef544ba24
Author: Alexander Aring <aahringo@redhat.com>
Date:   Thu Nov 17 17:11:50 2022 -0500

    fs: dlm: remove socket shutdown handling
    
    Since commit 489d8e559c65 ("fs: dlm: add reliable connection if
    reconnect") we have functionality like TCP offers for half-closed
    sockets on dlm application protocol layer. This feature is required
    because the cluster manager events about leaving resource memberships
    can be locally already occurred but other cluster nodes having a pending
    leaving membership over the cluster manager protocol happening. In this
    time the local dlm node already shutdown it's connection and don't
    transmit anymore any new dlm messages, but however it still needs to be
    able to accept dlm messages because the pending leave membership request
    of the cluster manager protocol which the dlm kernel implementation has
    no control about it.
    
    We have this functionality on the application for two reasons, the main
    reason is that SCTP does not support such functionality on socket
    layer. But we can do it inside application layer.
    
    Another small issue is that this feature is broken in the TCP world
    because some NAT devices does not implement such functionality
    correctly. This is the same reason why the reliable connection session
    layer in DLM exists. We give up on middle devices in the networking
    which sends e.g. TCP resets out. In DLM we cannot have any message
    dropping and we ensure it over a session layer that it can't happen.
    
    Back to the half-closed grace shutdown handling. It's not necessary
    anymore to do it on socket layer (which is only support for TCP sockets)
    because we do it on application layer. This patch removes this handling,
    if there are still issues then we have a problem on the application
    layer for such handling.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 22700706adac57608ca78ef527b0df56c11f85e6
Merge: 0b6ffefbb018 a61bd7b9fef3
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Nov 18 11:42:54 2022 +0000

    Merge branch 'sctp-vrf'
    
    Xin Long says:
    
    ====================
    sctp: support vrf processing
    
    This patchset adds the VRF processing in SCTP. Simliar to TCP/UDP,
    it includes socket bind and socket/association lookup changes.
    
    For socket bind change, it allows sockets to bind to a VRF device
    and allows multiple sockets with the same IP and PORT to bind to
    different interfaces in patch 1-3.
    
    For socket/association lookup change, it adds dif and sdif check
    in both asoc and ep lookup in patch 4 and 5, and when binding to
    nodev, users can decide if accept the packets received from one
    l3mdev by setup a sysctl option in patch 6.
    
    Note with VRF support, in a netns, an association will be decided
    by src ip + src port + dst ip + dst port + bound_dev_if, and it's
    possible for ss to have:
    
      State       Local Address:Port      Peer Address:Port
       ESTAB     192.168.1.2%vrf-s1:1234
       `- ESTAB   192.168.1.2%veth1:1234   192.168.1.1:1234
       ESTAB     192.168.1.2%vrf-s2:1234
       `- ESTAB   192.168.1.2%veth2:1234   192.168.1.1:1234
    
    See the selftest in patch 7 for more usage.
    
    Also, thanks Carlo for testing this patch series on their use.
    
    v1->v2:
      - In Patch 5, move sctp_sk_bound_dev_eq() definition to net/sctp/
        input.c to avoid a build error when IP_SCTP is disabled, as Paolo
        suggested.
      - In Patch 7, avoid one sleep by disabling the IPv6 dad, and remove
        another sleep by using ss to check if the server's ready, and also
        delete two unncessary sleeps in sctp_hello.c, as Paolo suggested.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a61bd7b9fef34484a3fe144a62f4ec78cc42e20e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Nov 16 15:01:22 2022 -0500

    selftests: add a selftest for sctp vrf
    
    This patch adds 12 small test cases: 01-04 test for the sysctl
    net.sctp.l3mdev_accept. 05-10 test for only binding to a right
    l3mdev device, the connection can be created. 11-12 test for
    two socks binding to different l3mdev devices at the same time,
    each of them can process the packets from the corresponding
    peer. The tests run for both IPv4 and IPv6 SCTP.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0af03170637f47fb5cc6501d4b2dcbf1c14772a9
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Nov 16 15:01:20 2022 -0500

    sctp: add dif and sdif check in asoc and ep lookup
    
    This patch at first adds a pernet global l3mdev_accept to decide if it
    accepts the packets from a l3mdev when a SCTP socket doesn't bind to
    any interface. It's set to 1 to avoid any possible incompatible issue,
    and in next patch, a sysctl will be introduced to allow to change it.
    
    Then similar to inet/udp_sk_bound_dev_eq(), sctp_sk_bound_dev_eq() is
    added to check either dif or sdif is equal to sk_bound_dev_if, and to
    check sid is 0 or l3mdev_accept is 1 if sk_bound_dev_if is not set.
    This function is used to match a association or a endpoint, namely
    called by sctp_addrs_lookup_transport() and sctp_endpoint_is_match().
    All functions that needs updating are:
    
    sctp_rcv():
      asoc:
      __sctp_rcv_lookup()
        __sctp_lookup_association() -> sctp_addrs_lookup_transport()
        __sctp_rcv_lookup_harder()
          __sctp_rcv_init_lookup()
             __sctp_lookup_association() -> sctp_addrs_lookup_transport()
          __sctp_rcv_walk_lookup()
             __sctp_rcv_asconf_lookup()
               __sctp_lookup_association() -> sctp_addrs_lookup_transport()
    
      ep:
      __sctp_rcv_lookup_endpoint() -> sctp_endpoint_is_match()
    
    sctp_connect():
      sctp_endpoint_is_peeled_off()
        __sctp_lookup_association()
          sctp_has_association()
            sctp_lookup_association()
              __sctp_lookup_association() -> sctp_addrs_lookup_transport()
    
    sctp_diag_dump_one():
      sctp_transport_lookup_process() -> sctp_addrs_lookup_transport()
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 33e93ed2209d5971043bed41dd194bc583b57ef3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Nov 16 15:01:19 2022 -0500

    sctp: add skb_sdif in struct sctp_af
    
    Add skb_sdif function in struct sctp_af to get the enslaved device
    for both ipv4 and ipv6 when adding SCTP VRF support in sctp_rcv in
    the next patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 647541ea06a7bbbcf941e501c726b3e26328c102
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 15 10:40:21 2022 -0500

    sctp: move SCTP_PAD4 and SCTP_TRUNC4 to linux/sctp.h
    
    Move these two macros from net/sctp/sctp.h to linux/sctp.h, so that
    it will be enough to include only linux/sctp.h in nft_exthdr.c and
    xt_sctp.c. It should not include "net/sctp/sctp.h" if a module does
    not have a dependence on SCTP module.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Saeed Mahameed <saeed@kernel.org>
    Link: https://lore.kernel.org/r/ef6468a687f36da06f575c2131cd4612f6b7be88.1668526821.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit b78c4162823dddc621649edae704b14c5973298c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 15 10:39:53 2022 -0500

    sctp: change to include linux/sctp.h in net/sctp/checksum.h
    
    Currently "net/sctp/checksum.h" including "net/sctp/sctp.h" is
    included in quite some places in netfilter and openswitch and
    net/sched. It's not necessary to include "net/sctp/sctp.h" if
    a module does not have dependence on SCTP, "linux/sctp.h" is
    the right one to include.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Saeed Mahameed <saeed@kernel.org>
    Link: https://lore.kernel.org/r/ca7ea96d62a26732f0491153c3979dc1c0d8d34a.1668526793.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 89bbe785b4d196cc3d00056adc58da8484a824a1
Merge: 1c075b192fe4 2f201ae14ae0
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Mon Nov 7 19:59:05 2022 -0800

    Merge branch 'sctp-fix-a-null-pointer-dereference-in-sctp_sched_dequeue_common'
    
    Xin Long says:
    
    ====================
    sctp: fix a NULL pointer dereference in sctp_sched_dequeue_common
    
    This issue was triggered with SCTP_PR_SCTP_PRIO in sctp,
    and caused by not checking and fixing stream->out_curr
    after removing a chunk from this stream.
    
    Patch 1 removes an unnecessary check and makes the real
    fix easier to add in Patch 2.
    ====================
    
    Link: https://lore.kernel.org/r/cover.1667598261.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 036b8f5b8970e387eb3224eda45348de39135177
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Thu Mar 19 11:42:56 2020 -0300

    tools headers uapi: Update linux/in.h copy
    
    To get the changes in:
    
      65b32f801bfbc54d ("uapi: move IPPROTO_L2TP to in.h")
      5854a09b49574da5 ("net/ipv4: Use __DECLARE_FLEX_ARRAY() helper")
    
    That ends up automatically adding the new IPPROTO_L2TP to the socket
    args beautifiers:
    
      $ tools/perf/trace/beauty/socket.sh > before
      $ cp include/uapi/linux/in.h tools/include/uapi/linux/in.h
      $ tools/perf/trace/beauty/socket.sh > after
      $ diff -u before after
      --- before    2022-10-25 12:17:02.577892416 -0300
      +++ after     2022-10-25 12:17:10.806113033 -0300
      @@ -20,6 +20,7 @@
            [98] = "ENCAP",
            [103] = "PIM",
            [108] = "COMP",
      +     [115] = "L2TP",
            [132] = "SCTP",
            [136] = "UDPLITE",
            [137] = "MPLS",
      $
    
    Now 'perf trace' will decode that 115 into "L2TP" and it will also be
    possible to use it in tracepoint filter expressions.
    
    Addresses this tools/perf build warning:
    
      Warning: Kernel ABI header at 'tools/include/uapi/linux/in.h' differs from latest version at 'include/uapi/linux/in.h'
      diff -u tools/include/uapi/linux/in.h include/uapi/linux/in.h
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: Ian Rogers <irogers@google.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Paolo Abeni <pabeni@redhat.com>
    Cc: Wojciech Drewek <wojciech.drewek@intel.com>
    Cc: David S. Miller <davem@davemloft.net>
    Cc: Gustavo A. R. Silva <gustavoars@kernel.org>
    Link: https://lore.kernel.org/lkml/Y1f%2FGe6vjQrGjYiK@kernel.org/
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 3a07327d10a09379315c844c63f27941f5081e0a
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Tue Oct 25 13:48:15 2022 +0200

    netfilter: nft_inner: support for inner tunnel header matching
    
    This new expression allows you to match on the inner headers that are
    encapsulated by any of the existing tunneling protocols.
    
    This expression parses the inner packet to set the link, network and
    transport offsets, so the existing expressions (with a few updates) can
    be reused to match on the inner headers.
    
    The inner expression supports for different tunnel combinations such as:
    
    - ethernet frame over IPv4/IPv6 packet, eg. VxLAN.
    - IPv4/IPv6 packet over IPv4/IPv6 packet, eg. IPIP.
    - IPv4/IPv6 packet over IPv4/IPv6 + transport header, eg. GRE.
    - transport header (ESP or SCTP) over transport header (usually UDP)
    
    The following fields are used to describe the tunnel protocol:
    
    - flags, which describe how to parse the inner headers:
    
      NFT_PAYLOAD_CTX_INNER_TUN, the tunnel provides its own header.
      NFT_PAYLOAD_CTX_INNER_ETHER, the ethernet frame is available as inner header.
      NFT_PAYLOAD_CTX_INNER_NH, the network header is available as inner header.
      NFT_PAYLOAD_CTX_INNER_TH, the transport header is available as inner header.
    
    For example, VxLAN sets on all of these flags. While GRE only sets on
    NFT_PAYLOAD_CTX_INNER_NH and NFT_PAYLOAD_CTX_INNER_TH. Then, ESP over
    UDP only sets on NFT_PAYLOAD_CTX_INNER_TH.
    
    The tunnel description is composed of the following attributes:
    
    - header size: in case the tunnel comes with its own header, eg. VxLAN.
    
    - type: this provides a hint to userspace on how to delinearize the rule.
      This is useful for VxLAN and Geneve since they run over UDP, since
      transport does not provide a hint. This is also useful in case hardware
      offload is ever supported. The type is not currently interpreted by the
      kernel.
    
    - expression: currently only payload supported. Follow up patch adds
      also inner meta support which is required by autogenerated
      dependencies. The exthdr expression should be supported too
      at some point. There is a new inner_ops operation that needs to be
      set on to allow to use an existing expression from the inner expression.
    
    This patch adds a new NFT_PAYLOAD_TUN_HEADER base which allows to match
    on the tunnel header fields, eg. vxlan vni.
    
    The payload expression is embedded into nft_inner private area and this
    private data area is passed to the payload inner eval function via
    direct call.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 6431b0f6ff1633ae598667e4cdd93830074a03e8
Author: Kuniyuki Iwashima <kuniyu@amazon.com>
Date:   Wed Oct 19 15:36:01 2022 -0700

    sctp: Call inet6_destroy_sock() via sk->sk_destruct().
    
    After commit d38afeec26ed ("tcp/udp: Call inet6_destroy_sock()
    in IPv6 sk->sk_destruct()."), we call inet6_destroy_sock() in
    sk->sk_destruct() by setting inet6_sock_destruct() to it to make
    sure we do not leak inet6-specific resources.
    
    SCTP sets its own sk->sk_destruct() in the sctp_init_sock(), and
    SCTPv6 socket reuses it as the init function.
    
    To call inet6_sock_destruct() from SCTPv6 sk->sk_destruct(), we
    set sctp_v6_destruct_sock() in a new init function.
    
    Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b5fc29233d28be7a3322848ebe73ac327559cdb9
Author: Kuniyuki Iwashima <kuniyu@amazon.com>
Date:   Wed Oct 19 15:35:59 2022 -0700

    inet6: Remove inet6_destroy_sock() in sk->sk_prot->destroy().
    
    After commit d38afeec26ed ("tcp/udp: Call inet6_destroy_sock()
    in IPv6 sk->sk_destruct()."), we call inet6_destroy_sock() in
    sk->sk_destruct() by setting inet6_sock_destruct() to it to make
    sure we do not leak inet6-specific resources.
    
    Now we can remove unnecessary inet6_destroy_sock() calls in
    sk->sk_prot->destroy().
    
    DCCP and SCTP have their own sk->sk_destruct() function, so we
    change them separately in the following patches.
    
    Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
    Reviewed-by: Matthieu Baerts <matthieu.baerts@tessares.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3210e0780e10e886bc2fe9456b673cdea9591dc1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    [ Upstream commit aa709da0e032cee7c202047ecd75f437bb0126ed ]
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ef6ed9aeb254c321de393f4c9511e6fbc3333635
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    [ Upstream commit aa709da0e032cee7c202047ecd75f437bb0126ed ]
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 830582c16be1ce0c8fa489d8973871587da617c9
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    [ Upstream commit aa709da0e032cee7c202047ecd75f437bb0126ed ]
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 034bfadc8f511397d55ad5a6851d796342d3c1f5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    [ Upstream commit aa709da0e032cee7c202047ecd75f437bb0126ed ]
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c2b57a4d3ff6ba2298db974c4e9c35fc9b18db17
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    [ Upstream commit aa709da0e032cee7c202047ecd75f437bb0126ed ]
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit aa709da0e032cee7c202047ecd75f437bb0126ed
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jul 21 10:35:46 2022 -0400

    Documentation: fix sctp_wmem in ip-sysctl.rst
    
    Since commit 1033990ac5b2 ("sctp: implement memory accounting on tx path"),
    SCTP has supported memory accounting on tx path where 'sctp_wmem' is used
    by sk_wmem_schedule(). So we should fix the description for this option in
    ip-sysctl.rst accordingly.
    
    v1->v2:
      - Improve the description as Marcelo suggested.
    
    Fixes: 1033990ac5b2 ("sctp: implement memory accounting on tx path")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dc794fa2b3c42dc1d22bfb4f201eae98658de564
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5dbd7937423e90bbacdbe101f31bb30e0c7c36e1
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit dd6a93031407ba4a9b954e2410b043613a747443
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b342a88bbcddcbfc83e50d712f332f2da1e4e89e
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 249eddaf651fda7cb32e9ebae4c6d5904b390d81
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jun 9 11:17:15 2022 -0400

    Documentation: add description for net.sctp.ecn_enable
    
    Describe it in networking/ip-sysctl.rst like other SCTP options.
    
    Fixes: 2f5268a9249b ("sctp: allow users to set netns ecn flag with sysctl")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit e65775fdd389e4f47eb1972ef6372e20c6c2cc05
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jun 9 11:17:14 2022 -0400

    Documentation: add description for net.sctp.intl_enable
    
    Describe it in networking/ip-sysctl.rst like other SCTP options.
    We need to document this especially as when using the feature
    of User Message Interleaving, some socket options also needs
    to be set.
    
    Fixes: 463118c34a35 ("sctp: support sysctl to allow users to use stream interleave")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit c349ae5f831cb9817a45e4e36705d2f7d47c7bc3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jun 9 11:17:13 2022 -0400

    Documentation: add description for net.sctp.reconf_enable
    
    Describe it in networking/ip-sysctl.rst like other SCTP options.
    
    Fixes: c0d8bab6ae51 ("sctp: add get and set sockopt for reconf_enable")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit e10b02ee5b6c95872064cf0a8e65f31951a31967
Merge: 5c281b4e529c 0f2c2693988a
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Fri Jun 10 16:21:39 2022 -0700

    Merge branch 'net-reduce-tcp_memory_allocated-inflation'
    
    Eric Dumazet says:
    
    ====================
    net: reduce tcp_memory_allocated inflation
    
    Hosts with a lot of sockets tend to hit so called TCP memory pressure,
    leading to very bad TCP performance and/or OOM.
    
    The problem is that some TCP sockets can hold up to 2MB of 'forward
    allocations' in their per-socket cache (sk->sk_forward_alloc),
    and there is no mechanism to make them relinquish their share
    under mem pressure.
    Only under some potentially rare events their share is reclaimed,
    one socket at a time.
    
    In this series, I implemented a per-cpu cache instead of a per-socket one.
    
    Each CPU has a +1/-1 MB (256 pages on x86) forward alloc cache, in order
    to not dirty tcp_memory_allocated shared cache line too often.
    
    We keep sk->sk_forward_alloc values as small as possible, to meet
    memcg page granularity constraint.
    
    Note that memcg already has a per-cpu cache, although MEMCG_CHARGE_BATCH
    is defined to 32 pages, which seems a bit small.
    
    Note that while this cover letter mentions TCP, this work is generic
    and supports TCP, UDP, DECNET, SCTP.
    ====================
    
    Link: https://lore.kernel.org/r/20220609063412.2205738-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 0523625c0524380c6836b3a840cee9c7b31b9c44
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 62bdcbd560dac411a4162acbab1bd4f509f40842
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9b01252e6c205c1e93f0fb00b6030cfa44c0e2bd
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8113eedbab85f28fd52ba54de0a3dfa59dacf086
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    [ Upstream commit a20ea298071f46effa3aaf965bf9bb34c901db3f ]
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a20ea298071f46effa3aaf965bf9bb34c901db3f
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri May 13 11:55:42 2022 -0700

    sctp: read sk->sk_bound_dev_if once in sctp_rcv()
    
    sctp_rcv() reads sk->sk_bound_dev_if twice while the socket
    is not locked. Another cpu could change this field under us.
    
    Fixes: 0fd9a65a76e8 ("[SCTP] Support SO_BINDTODEVICE socket option on incoming packets.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b4b52179ce84d3de859284f778ec3e33fae8ddec
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    [ Upstream commit 8467dda0c26583547731e7f3ea73fc3856bae3bf ]
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5d4b2cf4fc330937c6d8a6022c9e34f802f9efa5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 7 09:24:22 2022 -0400

    sctp: use the correct skb for security_sctp_assoc_request
    
    [ Upstream commit e2d88f9ce678cd33763826ae2f0412f181251314 ]
    
    Yi Chen reported an unexpected sctp connection abort, and it occurred when
    COOKIE_ECHO is bundled with DATA Fragment by SCTP HW GSO. As the IP header
    is included in chunk->head_skb instead of chunk->skb, it failed to check
    IP header version in security_sctp_assoc_request().
    
    According to Ondrej, SELinux only looks at IP header (address and IPsec
    options) and XFRM state data, and these are all included in head_skb for
    SCTP HW GSO packets. So fix it by using head_skb when calling
    security_sctp_assoc_request() in processing COOKIE_ECHO.
    
    v1->v2:
      - As Ondrej noticed, chunk->head_skb should also be used for
        security_sctp_assoc_established() in sctp_sf_do_5_1E_ca().
    
    Fixes: e215dab1c490 ("security: call security_sctp_assoc_request in sctp_sf_do_5_1D_ce")
    Reported-by: Yi Chen <yiche@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Ondrej Mosnacek <omosnace@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/71becb489e51284edf0c11fc15246f4ed4cef5b6.1649337862.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 90c153ca45da86342e1b5105bce1a96ab4f603e2
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    [ Upstream commit 8467dda0c26583547731e7f3ea73fc3856bae3bf ]
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eb8873b324d918eeaa572d08d1d05785f4fb1e0a
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    [ Upstream commit 8467dda0c26583547731e7f3ea73fc3856bae3bf ]
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 37e54d151eab6c796dfea7cafa32efb010d92b4b
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    [ Upstream commit 8467dda0c26583547731e7f3ea73fc3856bae3bf ]
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 268d58f5400b9ca4d24c046c5281716dc0cf638a
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    [ Upstream commit 8467dda0c26583547731e7f3ea73fc3856bae3bf ]
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2cb2b3fb20a2a9448285628c6da97a283a5a73b4
Author: Jamie Bainbridge <jamie.bainbridge@gmail.com>
Date:   Mon Apr 4 09:47:48 2022 +1000

    sctp: count singleton chunks in assoc user stats
    
    [ Upstream commit e3d37210df5c41c51147a2d5d465de1a4d77be7a ]
    
    Singleton chunks (INIT, HEARTBEAT PMTU probes, and SHUTDOWN-
    COMPLETE) are not counted in SCTP_GET_ASOC_STATS "sas_octrlchunks"
    counter available to the assoc owner.
    
    These are all control chunks so they should be counted as such.
    
    Add counting of singleton chunks so they are properly accounted for.
    
    Fixes: 196d67593439 ("sctp: Add support to per-association statistics via a new SCTP_GET_ASSOC_STATS call")
    Signed-off-by: Jamie Bainbridge <jamie.bainbridge@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/c9ba8785789880cf07923b8a5051e174442ea9ee.1649029663.git.jamie.bainbridge@gmail.com
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a231679929c0401661bdab2c62aa79316e36573d
Author: Jamie Bainbridge <jamie.bainbridge@gmail.com>
Date:   Mon Apr 4 09:47:48 2022 +1000

    sctp: count singleton chunks in assoc user stats
    
    [ Upstream commit e3d37210df5c41c51147a2d5d465de1a4d77be7a ]
    
    Singleton chunks (INIT, HEARTBEAT PMTU probes, and SHUTDOWN-
    COMPLETE) are not counted in SCTP_GET_ASOC_STATS "sas_octrlchunks"
    counter available to the assoc owner.
    
    These are all control chunks so they should be counted as such.
    
    Add counting of singleton chunks so they are properly accounted for.
    
    Fixes: 196d67593439 ("sctp: Add support to per-association statistics via a new SCTP_GET_ASSOC_STATS call")
    Signed-off-by: Jamie Bainbridge <jamie.bainbridge@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/c9ba8785789880cf07923b8a5051e174442ea9ee.1649029663.git.jamie.bainbridge@gmail.com
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9fbe2b4e243a13ba94eb751a0186710268d225d6
Author: Jamie Bainbridge <jamie.bainbridge@gmail.com>
Date:   Mon Apr 4 09:47:48 2022 +1000

    sctp: count singleton chunks in assoc user stats
    
    [ Upstream commit e3d37210df5c41c51147a2d5d465de1a4d77be7a ]
    
    Singleton chunks (INIT, HEARTBEAT PMTU probes, and SHUTDOWN-
    COMPLETE) are not counted in SCTP_GET_ASOC_STATS "sas_octrlchunks"
    counter available to the assoc owner.
    
    These are all control chunks so they should be counted as such.
    
    Add counting of singleton chunks so they are properly accounted for.
    
    Fixes: 196d67593439 ("sctp: Add support to per-association statistics via a new SCTP_GET_ASSOC_STATS call")
    Signed-off-by: Jamie Bainbridge <jamie.bainbridge@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/c9ba8785789880cf07923b8a5051e174442ea9ee.1649029663.git.jamie.bainbridge@gmail.com
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8467dda0c26583547731e7f3ea73fc3856bae3bf
Author: Petr Malat <oss@malat.biz>
Date:   Sat Apr 9 08:36:11 2022 +0200

    sctp: Initialize daddr on peeled off socket
    
    Function sctp_do_peeloff() wrongly initializes daddr of the original
    socket instead of the peeled off socket, which makes getpeername()
    return zeroes instead of the primary address. Initialize the new socket
    instead.
    
    Fixes: d570ee490fb1 ("[SCTP]: Correctly set daddr for IPv6 sockets during peeloff")
    Signed-off-by: Petr Malat <oss@malat.biz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/20220409063611.673193-1-oss@malat.biz
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit e2d88f9ce678cd33763826ae2f0412f181251314
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 7 09:24:22 2022 -0400

    sctp: use the correct skb for security_sctp_assoc_request
    
    Yi Chen reported an unexpected sctp connection abort, and it occurred when
    COOKIE_ECHO is bundled with DATA Fragment by SCTP HW GSO. As the IP header
    is included in chunk->head_skb instead of chunk->skb, it failed to check
    IP header version in security_sctp_assoc_request().
    
    According to Ondrej, SELinux only looks at IP header (address and IPsec
    options) and XFRM state data, and these are all included in head_skb for
    SCTP HW GSO packets. So fix it by using head_skb when calling
    security_sctp_assoc_request() in processing COOKIE_ECHO.
    
    v1->v2:
      - As Ondrej noticed, chunk->head_skb should also be used for
        security_sctp_assoc_established() in sctp_sf_do_5_1E_ca().
    
    Fixes: e215dab1c490 ("security: call security_sctp_assoc_request in sctp_sf_do_5_1D_ce")
    Reported-by: Yi Chen <yiche@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Ondrej Mosnacek <omosnace@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/71becb489e51284edf0c11fc15246f4ed4cef5b6.1649337862.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 4c69932ed1e42135e3027f22ed7aadf9b8bdf0cf
Author: Wan Jiabing <wanjiabing@vivo.com>
Date:   Mon Feb 28 10:56:41 2022 +0800

    docs: fix 'make htmldocs' warning in SCTP.rst
    
    commit 70868c6b8fd80db585da57a264c50a69af8fd3c3 upstream.
    
    Fix following 'make htmldocs' warnings:
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    Fixes: 5e50f5d4ff31 ("security: add sctp_assoc_established hook")
    Signed-off-by: Wan Jiabing <wanjiabing@vivo.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1904c8e42c51f9b68f7ccebf4426d2856250097c
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:22 2022 +0100

    security: implement sctp_assoc_established hook in selinux
    
    [ Upstream commit 3eb8eaf2ca3e98d4f6e52bed6148ee8fe3069a3d ]
    
    Do this by extracting the peer labeling per-association logic from
    selinux_sctp_assoc_request() into a new helper
    selinux_sctp_process_new_assoc() and use this helper in both
    selinux_sctp_assoc_request() and selinux_sctp_assoc_established(). This
    ensures that the peer labeling behavior as documented in
    Documentation/security/SCTP.rst is applied both on the client and server
    side:
    """
    An SCTP socket will only have one peer label assigned to it. This will be
    assigned during the establishment of the first association. Any further
    associations on this socket will have their packet peer label compared to
    the sockets peer label, and only if they are different will the
    ``association`` permission be validated. This is validated by checking the
    socket peer sid against the received packets peer sid to determine whether
    the association should be allowed or denied.
    """
    
    At the same time, it also ensures that the peer label of the association
    is set to the correct value, such that if it is peeled off into a new
    socket, the socket's peer label  will then be set to the association's
    peer label, same as it already works on the server side.
    
    While selinux_inet_conn_established() (which we are replacing by
    selinux_sctp_assoc_established() for SCTP) only deals with assigning a
    peer label to the connection (socket), in case of SCTP we need to also
    copy the (local) socket label to the association, so that
    selinux_sctp_sk_clone() can then pick it up for the new socket in case
    of SCTP peeloff.
    
    Careful readers will notice that the selinux_sctp_process_new_assoc()
    helper also includes the "IPv4 packet received over an IPv6 socket"
    check, even though it hadn't been in selinux_sctp_assoc_request()
    before. While such check is not necessary in
    selinux_inet_conn_request() (because struct request_sock's family field
    is already set according to the skb's family), here it is needed, as we
    don't have request_sock and we take the initial family from the socket.
    In selinux_sctp_assoc_established() it is similarly needed as well (and
    also selinux_inet_conn_established() already has it).
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fa11feb9ca99581242e4dfd1e12cccb5b6bd0aba
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:21 2022 +0100

    security: add sctp_assoc_established hook
    
    [ Upstream commit 5e50f5d4ff31e95599d695df1f0a4e7d2d6fef99 ]
    
    security_sctp_assoc_established() is added to replace
    security_inet_conn_established() called in
    sctp_sf_do_5_1E_ca(), so that asoc can be accessed in security
    subsystem and save the peer secid to asoc->peer_secid.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d3e0db54cec4f8f0fcfb8daf3d1be7f4e3871b00
Author: Wan Jiabing <wanjiabing@vivo.com>
Date:   Mon Feb 28 10:56:41 2022 +0800

    docs: fix 'make htmldocs' warning in SCTP.rst
    
    commit 70868c6b8fd80db585da57a264c50a69af8fd3c3 upstream.
    
    Fix following 'make htmldocs' warnings:
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    Fixes: 5e50f5d4ff31 ("security: add sctp_assoc_established hook")
    Signed-off-by: Wan Jiabing <wanjiabing@vivo.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c7230236060fa9d92fdeed4cd6122e9e64f232c2
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:22 2022 +0100

    security: implement sctp_assoc_established hook in selinux
    
    [ Upstream commit 3eb8eaf2ca3e98d4f6e52bed6148ee8fe3069a3d ]
    
    Do this by extracting the peer labeling per-association logic from
    selinux_sctp_assoc_request() into a new helper
    selinux_sctp_process_new_assoc() and use this helper in both
    selinux_sctp_assoc_request() and selinux_sctp_assoc_established(). This
    ensures that the peer labeling behavior as documented in
    Documentation/security/SCTP.rst is applied both on the client and server
    side:
    """
    An SCTP socket will only have one peer label assigned to it. This will be
    assigned during the establishment of the first association. Any further
    associations on this socket will have their packet peer label compared to
    the sockets peer label, and only if they are different will the
    ``association`` permission be validated. This is validated by checking the
    socket peer sid against the received packets peer sid to determine whether
    the association should be allowed or denied.
    """
    
    At the same time, it also ensures that the peer label of the association
    is set to the correct value, such that if it is peeled off into a new
    socket, the socket's peer label  will then be set to the association's
    peer label, same as it already works on the server side.
    
    While selinux_inet_conn_established() (which we are replacing by
    selinux_sctp_assoc_established() for SCTP) only deals with assigning a
    peer label to the connection (socket), in case of SCTP we need to also
    copy the (local) socket label to the association, so that
    selinux_sctp_sk_clone() can then pick it up for the new socket in case
    of SCTP peeloff.
    
    Careful readers will notice that the selinux_sctp_process_new_assoc()
    helper also includes the "IPv4 packet received over an IPv6 socket"
    check, even though it hadn't been in selinux_sctp_assoc_request()
    before. While such check is not necessary in
    selinux_inet_conn_request() (because struct request_sock's family field
    is already set according to the skb's family), here it is needed, as we
    don't have request_sock and we take the initial family from the socket.
    In selinux_sctp_assoc_established() it is similarly needed as well (and
    also selinux_inet_conn_established() already has it).
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d75c2127c9749c8b32863adcfc7fe9825ea678f5
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:21 2022 +0100

    security: add sctp_assoc_established hook
    
    [ Upstream commit 5e50f5d4ff31e95599d695df1f0a4e7d2d6fef99 ]
    
    security_sctp_assoc_established() is added to replace
    security_inet_conn_established() called in
    sctp_sf_do_5_1E_ca(), so that asoc can be accessed in security
    subsystem and save the peer secid to asoc->peer_secid.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e3d37210df5c41c51147a2d5d465de1a4d77be7a
Author: Jamie Bainbridge <jamie.bainbridge@gmail.com>
Date:   Mon Apr 4 09:47:48 2022 +1000

    sctp: count singleton chunks in assoc user stats
    
    Singleton chunks (INIT, HEARTBEAT PMTU probes, and SHUTDOWN-
    COMPLETE) are not counted in SCTP_GET_ASOC_STATS "sas_octrlchunks"
    counter available to the assoc owner.
    
    These are all control chunks so they should be counted as such.
    
    Add counting of singleton chunks so they are properly accounted for.
    
    Fixes: 196d67593439 ("sctp: Add support to per-association statistics via a new SCTP_GET_ASSOC_STATS call")
    Signed-off-by: Jamie Bainbridge <jamie.bainbridge@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/c9ba8785789880cf07923b8a5051e174442ea9ee.1649029663.git.jamie.bainbridge@gmail.com
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>

commit 0ad6f021f6c354ab8daf29ec10f3c2340918d5d3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    commit 438b95a7c98f77d51cbf4db021f41b602d750a3f upstream.
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8a7952ec41de8f855f0cddb552cf3f5340a80482
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    commit 438b95a7c98f77d51cbf4db021f41b602d750a3f upstream.
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c269497d248e43558aafc6b3f87b49d4dd3c2713
Merge: 7f313ff0acde cdbec3ede0b8
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Mar 21 20:47:54 2022 -0700

    Merge tag 'selinux-pr-20220321' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull selinux updates from Paul Moore:
     "We've got a number of SELinux patches queued up, the highlights are:
    
       - Fixup the security_fs_context_parse_param() LSM hook so it executes
         all of the LSM hook implementations unless a serious error occurs.
    
         We also correct the SELinux hook implementation so that it returns
         zero on success.
    
       - In addition to a few SELinux mount option parsing fixes, we
         simplified the parsing by moving it earlier in the process.
    
         The logic was that it was unlikely an admin/user would use the new
         mount API and not have the policy loaded before passing the SELinux
         options.
    
       - Properly fixed the LSM/SELinux/SCTP hooks with the addition of the
         security_sctp_assoc_established() hook.
    
         This work was done in conjunction with the netdev folks and should
         complete the move of the SCTP labeling from the endpoints to the
         associations.
    
       - Fixed a variety of sparse warnings caused by changes in the "__rcu"
         markings of some core kernel structures.
    
       - Ensure we access the superblock's LSM security blob using the
         stacking-safe accessors.
    
       - Added the ability for the kernel to always allow FIOCLEX and
         FIONCLEX if the "ioctl_skip_cloexec" policy capability is
         specified.
    
       - Various constifications improvements, type casting improvements,
         additional return value checks, and dead code/parameter removal.
    
       - Documentation fixes"
    
    * tag 'selinux-pr-20220321' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux: (23 commits)
      selinux: shorten the policy capability enum names
      docs: fix 'make htmldocs' warning in SCTP.rst
      selinux: allow FIOCLEX and FIONCLEX with policy capability
      selinux: use correct type for context length
      selinux: drop return statement at end of void functions
      security: implement sctp_assoc_established hook in selinux
      security: add sctp_assoc_established hook
      selinux: parse contexts for mount options early
      selinux: various sparse fixes
      selinux: try to use preparsed sid before calling parse_sid()
      selinux: Fix selinux_sb_mnt_opts_compat()
      LSM: general protection fault in legacy_parse_param
      selinux: fix a type cast problem in cred_init_security()
      selinux: drop unused macro
      selinux: simplify cred_init_security
      selinux: do not discard const qualifier in cast
      selinux: drop unused parameter of avtab_insert_node
      selinux: drop cast to same type
      selinux: enclose macro arguments in parenthesis
      selinux: declare name parameter of hash_eval const
      ...

commit d828b0fe6631f3ae8709ac9a10c77c5836c76a08
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1502f15b9f29c41883a6139f2923523873282a83
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b7e4d9ba2ddb78801488b4c623875b81fb46b545
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit bbf59d7ae558940cfa2b36a287fd1e88d83f89f8
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2d8fa3fdf4542a2174a72d92018f488d65d848c5
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 41a2864cf719c17294f417726edd411643462ab8
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3fc0fd724d199e061432b66a8d85b7d48fe485f7
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    [ Upstream commit 633593a808980f82d251d0ca89730d8bb8b0220c ]
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 186d32bbf034417b40e2b4e773eeb8ef106c16c1
Merge: 3bcb6451cc96 e0ae713023a9
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Mar 10 16:47:58 2022 -0800

    Merge tag 'net-5.17-rc8' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from Jakub Kicinski:
     "Including fixes from bluetooth, and ipsec.
    
      Current release - regressions:
    
       - Bluetooth: fix unbalanced unlock in set_device_flags()
    
       - Bluetooth: fix not processing all entries on cmd_sync_work, make
         connect with qualcomm and intel adapters reliable
    
       - Revert "xfrm: state and policy should fail if XFRMA_IF_ID 0"
    
       - xdp: xdp_mem_allocator can be NULL in trace_mem_connect()
    
       - eth: ice: fix race condition and deadlock during interface enslave
    
      Current release - new code bugs:
    
       - tipc: fix incorrect order of state message data sanity check
    
      Previous releases - regressions:
    
       - esp: fix possible buffer overflow in ESP transformation
    
       - dsa: unlock the rtnl_mutex when dsa_master_setup() fails
    
       - phy: meson-gxl: fix interrupt handling in forced mode
    
       - smsc95xx: ignore -ENODEV errors when device is unplugged
    
      Previous releases - always broken:
    
       - xfrm: fix tunnel mode fragmentation behavior
    
       - esp: fix inter address family tunneling on GSO
    
       - tipc: fix null-deref due to race when enabling bearer
    
       - sctp: fix kernel-infoleak for SCTP sockets
    
       - eth: macb: fix lost RX packet wakeup race in NAPI receive
    
       - eth: intel stop disabling VFs due to PF error responses
    
       - eth: bcmgenet: don't claim WOL when its not available"
    
    * tag 'net-5.17-rc8' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (50 commits)
      xdp: xdp_mem_allocator can be NULL in trace_mem_connect().
      ice: Fix race condition during interface enslave
      net: phy: meson-gxl: improve link-up behavior
      net: bcmgenet: Don't claim WOL when its not available
      net: arc_emac: Fix use after free in arc_mdio_probe()
      sctp: fix kernel-infoleak for SCTP sockets
      net: phy: correct spelling error of media in documentation
      net: phy: DP83822: clear MISR2 register to disable interrupts
      gianfar: ethtool: Fix refcount leak in gfar_get_ts_info
      selftests: pmtu.sh: Kill nettest processes launched in subshell.
      selftests: pmtu.sh: Kill tcpdump processes launched by subshell.
      NFC: port100: fix use-after-free in port100_send_complete
      net/mlx5e: SHAMPO, reduce TIR indication
      net/mlx5e: Lag, Only handle events from highest priority multipath entry
      net/mlx5: Fix offloading with ESWITCH_IPV4_TTL_MODIFY_ENABLE
      net/mlx5: Fix a race on command flush flow
      net/mlx5: Fix size field in bufferx_reg struct
      ax25: Fix NULL pointer dereference in ax25_kill_by_device
      net: marvell: prestera: Add missing of_node_put() in prestera_switch_set_base_mac_addr
      net: ethernet: lpc_eth: Handle error for clk_enable
      ...

commit 633593a808980f82d251d0ca89730d8bb8b0220c
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Mar 9 16:11:45 2022 -0800

    sctp: fix kernel-infoleak for SCTP sockets
    
    syzbot reported a kernel infoleak [1] of 4 bytes.
    
    After analysis, it turned out r->idiag_expires is not initialized
    if inet_sctp_diag_fill() calls inet_diag_msg_common_fill()
    
    Make sure to clear idiag_timer/idiag_retrans/idiag_expires
    and let inet_diag_msg_sctpasoc_fill() fill them again if needed.
    
    [1]
    
    BUG: KMSAN: kernel-infoleak in instrument_copy_to_user include/linux/instrumented.h:121 [inline]
    BUG: KMSAN: kernel-infoleak in copyout lib/iov_iter.c:154 [inline]
    BUG: KMSAN: kernel-infoleak in _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     instrument_copy_to_user include/linux/instrumented.h:121 [inline]
     copyout lib/iov_iter.c:154 [inline]
     _copy_to_iter+0x6ef/0x25a0 lib/iov_iter.c:668
     copy_to_iter include/linux/uio.h:162 [inline]
     simple_copy_to_iter+0xf3/0x140 net/core/datagram.c:519
     __skb_datagram_iter+0x2d5/0x11b0 net/core/datagram.c:425
     skb_copy_datagram_iter+0xdc/0x270 net/core/datagram.c:533
     skb_copy_datagram_msg include/linux/skbuff.h:3696 [inline]
     netlink_recvmsg+0x669/0x1c80 net/netlink/af_netlink.c:1977
     sock_recvmsg_nosec net/socket.c:948 [inline]
     sock_recvmsg net/socket.c:966 [inline]
     __sys_recvfrom+0x795/0xa10 net/socket.c:2097
     __do_sys_recvfrom net/socket.c:2115 [inline]
     __se_sys_recvfrom net/socket.c:2111 [inline]
     __x64_sys_recvfrom+0x19d/0x210 net/socket.c:2111
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Uninit was created at:
     slab_post_alloc_hook mm/slab.h:737 [inline]
     slab_alloc_node mm/slub.c:3247 [inline]
     __kmalloc_node_track_caller+0xe0c/0x1510 mm/slub.c:4975
     kmalloc_reserve net/core/skbuff.c:354 [inline]
     __alloc_skb+0x545/0xf90 net/core/skbuff.c:426
     alloc_skb include/linux/skbuff.h:1158 [inline]
     netlink_dump+0x3e5/0x16c0 net/netlink/af_netlink.c:2248
     __netlink_dump_start+0xcf8/0xe90 net/netlink/af_netlink.c:2373
     netlink_dump_start include/linux/netlink.h:254 [inline]
     inet_diag_handler_cmd+0x2e7/0x400 net/ipv4/inet_diag.c:1341
     sock_diag_rcv_msg+0x24a/0x620
     netlink_rcv_skb+0x40c/0x7e0 net/netlink/af_netlink.c:2494
     sock_diag_rcv+0x63/0x80 net/core/sock_diag.c:277
     netlink_unicast_kernel net/netlink/af_netlink.c:1317 [inline]
     netlink_unicast+0x1093/0x1360 net/netlink/af_netlink.c:1343
     netlink_sendmsg+0x14d9/0x1720 net/netlink/af_netlink.c:1919
     sock_sendmsg_nosec net/socket.c:705 [inline]
     sock_sendmsg net/socket.c:725 [inline]
     sock_write_iter+0x594/0x690 net/socket.c:1061
     do_iter_readv_writev+0xa7f/0xc70
     do_iter_write+0x52c/0x1500 fs/read_write.c:851
     vfs_writev fs/read_write.c:924 [inline]
     do_writev+0x645/0xe00 fs/read_write.c:967
     __do_sys_writev fs/read_write.c:1040 [inline]
     __se_sys_writev fs/read_write.c:1037 [inline]
     __x64_sys_writev+0xe5/0x120 fs/read_write.c:1037
     do_syscall_x64 arch/x86/entry/common.c:51 [inline]
     do_syscall_64+0x54/0xd0 arch/x86/entry/common.c:82
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Bytes 68-71 of 2508 are uninitialized
    Memory access of size 2508 starts at ffff888114f9b000
    Data copied to user address 00007f7fe09ff2e0
    
    CPU: 1 PID: 3478 Comm: syz-executor306 Not tainted 5.17.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    
    Fixes: 8f840e47f190 ("sctp: add the sctp_diag.c file")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/20220310001145.297371-1-eric.dumazet@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 70868c6b8fd80db585da57a264c50a69af8fd3c3
Author: Wan Jiabing <wanjiabing@vivo.com>
Date:   Mon Feb 28 10:56:41 2022 +0800

    docs: fix 'make htmldocs' warning in SCTP.rst
    
    Fix following 'make htmldocs' warnings:
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:123: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    ./Documentation/security/SCTP.rst:273: WARNING: Title underline too short.
    security_sctp_assoc_established()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    Fixes: 5e50f5d4ff31 ("security: add sctp_assoc_established hook")
    Signed-off-by: Wan Jiabing <wanjiabing@vivo.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 5d71ab7b01d3d0bcdd1241e8e497c1b3aa053844
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    [ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7afed8b3608e15422ad2a5ffa7d329b627673804
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    [ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eefb68794f9434c9a0545a9bb686967a4fca2467
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    [ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ba4b40356abd526a18c9804d93dbf63b20b2eebc
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    [ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1e36ab99ae5c5c77e2254bfe54df76c33312ebf7
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    [ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3eb8eaf2ca3e98d4f6e52bed6148ee8fe3069a3d
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:22 2022 +0100

    security: implement sctp_assoc_established hook in selinux
    
    Do this by extracting the peer labeling per-association logic from
    selinux_sctp_assoc_request() into a new helper
    selinux_sctp_process_new_assoc() and use this helper in both
    selinux_sctp_assoc_request() and selinux_sctp_assoc_established(). This
    ensures that the peer labeling behavior as documented in
    Documentation/security/SCTP.rst is applied both on the client and server
    side:
    """
    An SCTP socket will only have one peer label assigned to it. This will be
    assigned during the establishment of the first association. Any further
    associations on this socket will have their packet peer label compared to
    the sockets peer label, and only if they are different will the
    ``association`` permission be validated. This is validated by checking the
    socket peer sid against the received packets peer sid to determine whether
    the association should be allowed or denied.
    """
    
    At the same time, it also ensures that the peer label of the association
    is set to the correct value, such that if it is peeled off into a new
    socket, the socket's peer label  will then be set to the association's
    peer label, same as it already works on the server side.
    
    While selinux_inet_conn_established() (which we are replacing by
    selinux_sctp_assoc_established() for SCTP) only deals with assigning a
    peer label to the connection (socket), in case of SCTP we need to also
    copy the (local) socket label to the association, so that
    selinux_sctp_sk_clone() can then pick it up for the new socket in case
    of SCTP peeloff.
    
    Careful readers will notice that the selinux_sctp_process_new_assoc()
    helper also includes the "IPv4 packet received over an IPv6 socket"
    check, even though it hadn't been in selinux_sctp_assoc_request()
    before. While such check is not necessary in
    selinux_inet_conn_request() (because struct request_sock's family field
    is already set according to the skb's family), here it is needed, as we
    don't have request_sock and we take the initial family from the socket.
    In selinux_sctp_assoc_established() it is similarly needed as well (and
    also selinux_inet_conn_established() already has it).
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 5e50f5d4ff31e95599d695df1f0a4e7d2d6fef99
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Sat Feb 12 18:59:21 2022 +0100

    security: add sctp_assoc_established hook
    
    security_sctp_assoc_established() is added to replace
    security_inet_conn_established() called in
    sctp_sf_do_5_1E_ca(), so that asoc can be accessed in security
    subsystem and save the peer secid to asoc->peer_secid.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Based-on-patch-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 40106e005bd9764f84ef9e6c0979fe1126d7ff02
Merge: fe68195daf34 d1ca60efc53d
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Fri Feb 4 08:47:41 2022 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    1) Don't refresh timeout for SCTP flows in CLOSED state.
    
    2) Don't allow access to transport header if fragment offset is set on.
    
    3) Reinitialize internal conntrack state for retransmitted TCP
       syn-ack packet.
    
    4) Update MAINTAINER file to add the Netfilter group tree. Moving
       forward, Florian Westphal has access to this tree so he can also
       send pull requests.
    
    5) Set on IPS_HELPER for entries created via ctnetlink, otherwise NAT
       might zap it.
    
    All patches from Florian Westphal.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netfilter/nf:
      netfilter: ctnetlink: disable helper autoassign
      MAINTAINERS: netfilter: update git links
      netfilter: conntrack: re-init state for retransmitted syn-ack
      netfilter: conntrack: move synack init code to helper
      netfilter: nft_payload: don't allow th access for fragments
      netfilter: conntrack: don't refresh sctp entries in closed state
    ====================
    
    Link: https://lore.kernel.org/r/20220204151903.320786-1-pablo@netfilter.org
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jan 28 13:13:32 2022 +0100

    netfilter: conntrack: don't refresh sctp entries in closed state
    
    Vivek Thrivikraman reported:
     An SCTP server application which is accessed continuously by client
     application.
     When the session disconnects the client retries to establish a connection.
     After restart of SCTP server application the session is not established
     because of stale conntrack entry with connection state CLOSED as below.
    
     (removing this entry manually established new connection):
    
     sctp 9 CLOSED src=10.141.189.233 [..]  [ASSURED]
    
    Just skip timeout update of closed entries, we don't want them to
    stay around forever.
    
    Reported-and-tested-by: Vivek Thrivikraman <vivek.thrivikraman@est.tech>
    Closes: https://bugzilla.netfilter.org/show_bug.cgi?id=1579
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 0a90729278ae7b31084d2d436b0eee4d83b11506
Merge: 7c3737c70607 32a370abf12f
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Nov 13 10:27:50 2021 -0800

    Merge tag 'selinux-pr-20211112' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull selinux fixes from Paul Moore:
     "Unfortunately I need to request a revert for two LSM/SELinux patches
      that came in via the network tree. The two patches in question add a
      new SCTP/LSM hook as well as an SELinux implementation of that LSM
      hook. The short version of "why?" is in the commit description of the
      revert patch, but I'll copy-n-paste the important bits below to save
      some time for the curious:
    
          ... Unfortunately these two patches were merged without proper
          review (the Reviewed-by and Tested-by tags from Richard Haines
          were for previous revisions of these patches that were
          significantly different) and there are outstanding objections from
          the SELinux maintainers regarding these patches.
    
          Work is currently ongoing to correct the problems identified in
          the reverted patches, as well as others that have come up during
          review, but it is unclear at this point in time when that work
          will be ready for inclusion in the mainline kernel. In the
          interest of not keeping objectionable code in the kernel for
          multiple weeks, and potentially a kernel release, we are reverting
          the two problematic patches.
    
      As usual with these things there is plenty of context to go with this
      and I'll try to do my best to provide that now. This effort started
      with a report of SCTP client side peel-offs not working correctly with
      SELinux, Ondrej Mosnacek put forth a patch which he believed properly
      addressed the problem but upon review by the netdev folks Xin Long
      described some additional issues and submitted an improved patchset
      for review. The SELinux folks reviewed Xin Long's initial patchset and
      suggested some changes which resulted in a second patchset (v2) from
      Xin Long; this is the patchset that is currently in your tree.
      Unfortunately this v2 patchset from Xin Long was merged before it had
      spent even just 24 hours on the mailing lists during the early days of
      the merge window, a time when many of us were busy doing verification
      of the newly released v5.15 kernel as well final review and testing of
      our v5.16 pull requests. Making matters worse, upon reviewing the v2
      patchset there were both changes which were found objectionable by
      SELinux standards as well as additional outstanding SCTP/SELinux
      interaction problems. At this point we did two things: resumed working
      on a better fix for the SCTP/SELinux issue(s) - thank you Ondrej - and
      we asked the networking folks to revert the v2 patchset.
    
      The revert request was obviously rejected, but at the time I believed
      it was just going to be an issue for linux-next; I wasn't expecting
      something this significant that was merged into the networking tree
      during the merge window to make it into your tree in the same window,
      yet as of last night that is exactly what happened. While we continue
      to try and resolve the SCTP/SELinux problem I am asking once again to
      revert the v2 patches and not ship the current
      security_sctp_assoc_established() hook in a v5.16-rcX kernel. If I was
      confident that we could solve these issues in a week, maybe two, I
      would refrain from asking for the revert but our current estimate is
      for a minimum of two weeks for the next patch revision. With the
      likelihood of additional delays due to normal patch review follow-up
      and/or holidays it seems to me that the safest course of action is to
      revert the patch both to try and keep some objectionable code out of a
      release kernel and limit the chances of any new breakages from such a
      change. While the SCTP/SELinux code in v5.15 and earlier has problems,
      they are known problems, and I'd like to try and avoid creating new
      and different problems while we work to fix things properly.
    
      One final thing to mention: Xin Long's v2 patchset consisted of four
      patches, yet this revert is for only the last two. We see the first
      two patches as good, reasonable, and not likely to cause an issue. In
      an attempt to create a cleaner revert patch we suggest leaving the
      first two patches in the tree as they are currently"
    
    * tag 'selinux-pr-20211112' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      net,lsm,selinux: revert the security_sctp_assoc_established() hook

commit ecf0a35ba22126160bd4bd2bf59d662e53d6e247
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Mon Nov 8 10:48:13 2021 -0300

    perf beauty socket: Add generator for socket level (SOL_*) string table
    
      $ tools/perf/trace/beauty/socket.sh
      static const char *socket_ipproto[] = {
            [0] = "IP",
            [1] = "ICMP",
      <SNIP>
            [255] = "RAW",
            [262] = "MPTCP",
      };
    
      static const char *socket_level[] = {
            [0] = "IP",
            [6] = "TCP",
            [17] = "UDP",
            [41] = "IPV6",
            [58] = "ICMPV6",
            [132] = "SCTP",
            [136] = "UDPLITE",
            [255] = "RAW",
            [256] = "IPX",
            [257] = "AX25",
            [258] = "ATALK",
            [259] = "NETROM",
            [260] = "ROSE",
            [261] = "DECNET",
            [262] = "X25",
            [263] = "PACKET",
            [264] = "ATM",
            [265] = "AAL",
            [266] = "IRDA",
            [267] = "NETBEUI",
            [268] = "LLC",
            [269] = "DCCP",
            [270] = "NETLINK",
            [271] = "TIPC",
            [272] = "RXRPC",
            [273] = "PPPOL2TP",
            [274] = "BLUETOOTH",
            [275] = "PNPIPE",
            [276] = "RDS",
            [277] = "IUCV",
            [278] = "CAIF",
            [279] = "ALG",
            [280] = "NFC",
            [281] = "KCM",
            [282] = "TLS",
            [283] = "XDP",
            [284] = "MPTCP",
            [285] = "MCTP",
      };
      $
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 2bd080b0961d776f90e7b1ef9788c56da3638c73
Merge: 843c3cbbdf89 e7310c94024c
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Nov 3 11:09:21 2021 +0000

    Merge branch 'sctp-=security-hook-fixes'
    
    Xin Long says:
    
    ====================
    security: fixups for the security hooks in sctp
    
    There are a couple of problems in the currect security hooks in sctp:
    
    1. The hooks incorrectly treat sctp_endpoint in SCTP as request_sock in
       TCP, while it's in fact no more than an extension of the sock, and
       represents the local host. It is created when sock is created, not
       when a conn request comes. sctp_association is actually the correct
       one to represent the connection, and created when a conn request
       arrives.
    
    2. security_sctp_assoc_request() hook should also be called in processing
       COOKIE ECHO, as that's the place where the real assoc is created and
       used in the future.
    
    The problems above may cause accept sk, peeloff sk or client sk having
    the incorrect security labels.
    
    So this patchset is to change some hooks and pass asoc into them and save
    these secids into asoc, as well as add the missing sctp_assoc_request
    hook into the COOKIE ECHO processing.
    
    v1->v2:
      - See each patch, and thanks the help from Ondrej, Paul and Richard.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e7310c94024cdf099c0d29e6903dd6fe9205bb60
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 2 08:02:50 2021 -0400

    security: implement sctp_assoc_established hook in selinux
    
    Different from selinux_inet_conn_established(), it also gives the
    secid to asoc->peer_secid in selinux_sctp_assoc_established(),
    as one UDP-type socket may have more than one asocs.
    
    Note that peer_secid in asoc will save the peer secid for this
    asoc connection, and peer_sid in sksec will just keep the peer
    secid for the latest connection. So the right use should be do
    peeloff for UDP-type socket if there will be multiple asocs in
    one socket, so that the peeloff socket has the right label for
    its asoc.
    
    v1->v2:
      - call selinux_inet_conn_established() to reduce some code
        duplication in selinux_sctp_assoc_established(), as Ondrej
        suggested.
      - when doing peeloff, it calls sock_create() where it actually
        gets secid for socket from socket_sockcreate_sid(). So reuse
        SECSID_WILD to ensure the peeloff socket keeps using that
        secid after calling selinux_sctp_sk_clone() for client side.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Reviewed-by: Richard Haines <richard_c_haines@btinternet.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c2ef0240e6abfd3cc59511339517358350a8910
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 2 08:02:49 2021 -0400

    security: add sctp_assoc_established hook
    
    security_sctp_assoc_established() is added to replace
    security_inet_conn_established() called in
    sctp_sf_do_5_1E_ca(), so that asoc can be accessed in security
    subsystem and save the peer secid to asoc->peer_secid.
    
    v1->v2:
      - fix the return value of security_sctp_assoc_established() in
        security.h, found by kernel test robot and Ondrej.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Reviewed-by: Richard Haines <richard_c_haines@btinternet.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e215dab1c49070cd75620afd801f777207a5b65c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 2 08:02:48 2021 -0400

    security: call security_sctp_assoc_request in sctp_sf_do_5_1D_ce
    
    The asoc created when receives the INIT chunk is a temporary one, it
    will be deleted after INIT_ACK chunk is replied. So for the real asoc
    created in sctp_sf_do_5_1D_ce() when the COOKIE_ECHO chunk is received,
    security_sctp_assoc_request() should also be called.
    
    v1->v2:
      - fix some typo and grammar errors, noticed by Ondrej.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Reviewed-by: Richard Haines <richard_c_haines@btinternet.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c081d53f97a1a90a38e4296dd3d6fda5e38dca2c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Nov 2 08:02:47 2021 -0400

    security: pass asoc to sctp_assoc_request and sctp_sk_clone
    
    This patch is to move secid and peer_secid from endpoint to association,
    and pass asoc to sctp_assoc_request and sctp_sk_clone instead of ep. As
    ep is the local endpoint and asoc represents a connection, and in SCTP
    one sk/ep could have multiple asoc/connection, saving secid/peer_secid
    for new asoc will overwrite the old asoc's.
    
    Note that since asoc can be passed as NULL, security_sctp_assoc_request()
    is moved to the place right after the new_asoc is created in
    sctp_sf_do_5_1B_init() and sctp_sf_do_unexpected_init().
    
    v1->v2:
      - fix the description of selinux_netlbl_skbuff_setsid(), as Jakub noticed.
      - fix the annotation in selinux_sctp_assoc_request(), as Richard Noticed.
    
    Fixes: 72e89f50084c ("security: Add support for SCTP security hooks")
    Reported-by: Prashanth Prahlad <pprahlad@redhat.com>
    Reviewed-by: Richard Haines <richard_c_haines@btinternet.com>
    Tested-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fe93367541bcedaba1dd5cb9cf138eec0267ea56
Author: Alexander Aring <aahringo@redhat.com>
Date:   Tue Nov 2 15:17:10 2021 -0400

    fs: dlm: remove check SCTP is loaded message
    
    Since commit 764ff4011424 ("fs: dlm: auto load sctp module") we try
    load the sctp module before we try to create a sctp kernel socket. That
    a socket creation fails now has more likely other reasons. This patch
    removes the part of error to load the sctp module and instead printout
    the error code.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 0717c71deae69aa3511492c302dd44a2f3722184
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    [ Upstream commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3 ]
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1c255b5f68f4dac3f1f0f24741575aac2325470a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    [ Upstream commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998 ]
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit dd82b3a345abf6fc325e748469d9d7f477a0b718
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7975f42f10380ff9743a7ee94ef3cb81f1a8275d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    [ Upstream commit 438b95a7c98f77d51cbf4db021f41b602d750a3f ]
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 332933f9ae0a17f6e362ec0f35ed51e7bc8e76d6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a7112b8eeb14b3db21bc96abc79ca7525d77e129
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    [ Upstream commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3 ]
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c2442f721972ea7c317fbfd55c902616b3151ad5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    [ Upstream commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998 ]
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 14c1e02b11c2233343573aff90766ef8472f27e7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8c50693d25e4ab6873b32bc3cea23b382a94d05f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    [ Upstream commit 438b95a7c98f77d51cbf4db021f41b602d750a3f ]
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ad111d4435d85fd3eeb2c09692030d89f8862401
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0f5b4c57dc8573bdb9926b17748065ac2104b1d1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    [ Upstream commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3 ]
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit df527764072c5fb7ede93a41cc8f3acbf41dde8c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    [ Upstream commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998 ]
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0aa322b5fe70204d3d7f9d1d4cd265fdff2e5a1f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5fe74d5e4d58262e4adde277ef773032c57e873d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    [ Upstream commit 438b95a7c98f77d51cbf4db021f41b602d750a3f ]
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5953ee99bab134d74c805a00eaa20fed33f54255
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1ff3c379248ea579aa122d4ca245028e4bc9af23
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    [ Upstream commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3 ]
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d9a4f990aab48dd5c134a9e76c7b651d404b05d3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    [ Upstream commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998 ]
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7bf2f6a30d1851c530ad5e4ee7e5c45fb6be0128
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1f52dfacca7bb315d89f5ece5660b0337809798e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a9ded117c98b0aa20e20cb82943ba5f0c34c8881
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    [ Upstream commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3 ]
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 32ceffec2a9a23346d33c0b48f4a7269ede2480d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    [ Upstream commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998 ]
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 202d5cd14f2e707259d45a3db05a9097725ed9fb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 82ad781d98040b4a5eea4eeb9a5acdd200a420c6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 16d0bfb045abf587c72d46dfea56c20c4aeda927
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 42ce7a69f8140783bab908dc29a93c0bcda315d5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c0b5302e3a74997b57985b561e776269d1951ac7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    [ Upstream commit aa0f697e45286a6b5f0ceca9418acf54b9099d99 ]
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 629d2823abf957bcbcba32154f1f6fd49bdb850c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    [ Upstream commit 4f7019c7eb33967eb87766e0e4602b5576873680 ]
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 411a44c24a561e449b592ff631b7ae321f1eb559
Merge: 4fb7d85b2ebf 35392da51b1a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Oct 28 10:17:31 2021 -0700

    Merge tag 'net-5.15-rc8' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from Jakub Kicinski:
     "Including fixes from WiFi (mac80211), and BPF.
    
      Current release - regressions:
    
       - skb_expand_head: adjust skb->truesize to fix socket memory
         accounting
    
       - mptcp: fix corrupt receiver key in MPC + data + checksum
    
      Previous releases - regressions:
    
       - multicast: calculate csum of looped-back and forwarded packets
    
       - cgroup: fix memory leak caused by missing cgroup_bpf_offline
    
       - cfg80211: fix management registrations locking, prevent list
         corruption
    
       - cfg80211: correct false positive in bridge/4addr mode check
    
       - tcp_bpf: fix race in the tcp_bpf_send_verdict resulting in reusing
         previous verdict
    
      Previous releases - always broken:
    
       - sctp: enhancements for the verification tag, prevent attackers from
         killing SCTP sessions
    
       - tipc: fix size validations for the MSG_CRYPTO type
    
       - mac80211: mesh: fix HE operation element length check, prevent out
         of bound access
    
       - tls: fix sign of socket errors, prevent positive error codes being
         reported from read()/write()
    
       - cfg80211: scan: extend RCU protection in
         cfg80211_add_nontrans_list()
    
       - implement ->sock_is_readable() for UDP and AF_UNIX, fix poll() for
         sockets in a BPF sockmap
    
       - bpf: fix potential race in tail call compatibility check resulting
         in two operations which would make the map incompatible succeeding
    
       - bpf: prevent increasing bpf_jit_limit above max
    
       - bpf: fix error usage of map_fd and fdget() in generic batch update
    
       - phy: ethtool: lock the phy for consistency of results
    
       - prevent infinite while loop in skb_tx_hash() when Tx races with
         driver reconfiguring the queue <> traffic class mapping
    
       - usbnet: fixes for bad HW conjured by syzbot
    
       - xen: stop tx queues during live migration, prevent UAF
    
       - net-sysfs: initialize uid and gid before calling
         net_ns_get_ownership
    
       - mlxsw: prevent Rx stalls under memory pressure"
    
    * tag 'net-5.15-rc8' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (67 commits)
      Revert "net: hns3: fix pause config problem after autoneg disabled"
      mptcp: fix corrupt receiver key in MPC + data + checksum
      riscv, bpf: Fix potential NULL dereference
      octeontx2-af: Fix possible null pointer dereference.
      octeontx2-af: Display all enabled PF VF rsrc_alloc entries.
      octeontx2-af: Check whether ipolicers exists
      net: ethernet: microchip: lan743x: Fix skb allocation failure
      net/tls: Fix flipped sign in async_wait.err assignment
      net/tls: Fix flipped sign in tls_err_abort() calls
      net/smc: Correct spelling mistake to TCPF_SYN_RECV
      net/smc: Fix smc_link->llc_testlink_time overflow
      nfp: bpf: relax prog rejection for mtu check through max_pkt_offset
      vmxnet3: do not stop tx queues after netif_device_detach()
      r8169: Add device 10ec:8162 to driver r8169
      ptp: Document the PTP_CLK_MAGIC ioctl number
      usbnet: fix error return code in usbnet_probe()
      net: hns3: adjust string spaces of some parameters of tx bd info in debugfs
      net: hns3: expand buffer len for some debugfs command
      net: hns3: add more string spaces for dumping packets number of queue info in debugfs
      net: hns3: fix data endian problem of some functions of debugfs
      ...

commit 32f8807a48ae55be0e76880cfe8607a18b5bb0df
Merge: 7f678def99d2 9d02831e517a
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Fri Oct 22 12:36:47 2021 -0700

    Merge branch 'sctp-enhancements-for-the-verification-tag'
    
    Xin Long says:
    
    ====================
    sctp: enhancements for the verification tag
    
    This patchset is to address CVE-2021-3772:
    
      A flaw was found in the Linux SCTP stack. A blind attacker may be able to
      kill an existing SCTP association through invalid chunks if the attacker
      knows the IP-addresses and port numbers being used and the attacker can
      send packets with spoofed IP addresses.
    
    This is caused by the missing VTAG verification for the received chunks
    and the incorrect vtag for the ABORT used to reply to these invalid
    chunks.
    
    This patchset is to go over all processing functions for the received
    chunks and do:
    
    1. Make sure sctp_vtag_verify() is called firstly to verify the vtag from
       the received chunk and discard this chunk if it fails. With some
       exceptions:
    
       a. sctp_sf_do_5_1B_init()/5_2_2_dupinit()/9_2_reshutack(), processing
          INIT chunk, as sctphdr vtag is always 0 in INIT chunk.
    
       b. sctp_sf_do_5_2_4_dupcook(), processing dupicate COOKIE_ECHO chunk,
          as the vtag verification will be done by sctp_tietags_compare() and
          then it takes right actions according to the return.
    
       c. sctp_sf_shut_8_4_5(), processing SHUTDOWN_ACK chunk for cookie_wait
          and cookie_echoed state, as RFC demand sending a SHUTDOWN_COMPLETE
          even if the vtag verification failed.
    
       d. sctp_sf_ootb(), called in many types of chunks for closed state or
          no asoc, as the same reason to c.
    
    2. Always use the vtag from the received INIT chunk to make the response
       ABORT in sctp_ootb_pkt_new().
    
    3. Fix the order for some checks and add some missing checks for the
       received chunk.
    
    This patch series has been tested with SCTP TAHI testing to make sure no
    regression caused on protocol conformance.
    ====================
    
    Link: https://lore.kernel.org/r/cover.1634730082.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 9d02831e517aa36ee6bdb453a0eb47bd49923fe3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:47 2021 -0400

    sctp: add vtag check in sctp_sf_ootb
    
    sctp_sf_ootb() is called when processing DATA chunk in closed state,
    and many other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    When fails to verify the vtag from the chunk, this patch sets asoc
    to NULL, so that the abort will be made with the vtag from the
    received chunk later.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit ef16b1734f0a176277b7bb9c71a6d977a6ef3998
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:46 2021 -0400

    sctp: add vtag check in sctp_sf_do_8_5_1_E_sa
    
    sctp_sf_do_8_5_1_E_sa() is called when processing SHUTDOWN_ACK chunk
    in cookie_wait and cookie_echoed state.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Note that when fails to verify the vtag from SHUTDOWN-ACK chunk,
    SHUTDOWN COMPLETE message will still be sent back to peer, but
    with the vtag from SHUTDOWN-ACK chunk, as said in 5) of
    rfc4960#section-8.4.
    
    While at it, also remove the unnecessary chunk length check from
    sctp_sf_shut_8_4_5(), as it's already done in both places where
    it calls sctp_sf_shut_8_4_5().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit aa0f697e45286a6b5f0ceca9418acf54b9099d99
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:45 2021 -0400

    sctp: add vtag check in sctp_sf_violation
    
    sctp_sf_violation() is called when processing HEARTBEAT_ACK chunk
    in cookie_wait state, and some other places are also using it.
    
    The vtag in the chunk's sctphdr should be verified, otherwise, as
    later in chunk length check, it may send abort with the existent
    asoc's vtag, which can be exploited by one to cook a malicious
    chunk to terminate a SCTP asoc.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 438b95a7c98f77d51cbf4db021f41b602d750a3f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:43 2021 -0400

    sctp: fix the processing for INIT_ACK chunk
    
    Currently INIT_ACK chunk in non-cookie_echoed state is processed in
    sctp_sf_discard_chunk() to send an abort with the existent asoc's
    vtag if the chunk length is not valid. But the vtag in the chunk's
    sctphdr is not verified, which may be exploited by one to cook a
    malicious chunk to terminal a SCTP asoc.
    
    sctp_sf_discard_chunk() also is called in many other places to send
    an abort, and most of those have this problem. This patch is to fix
    it by sending abort with the existent asoc's vtag only if the vtag
    from the chunk's sctphdr is verified in sctp_sf_discard_chunk().
    
    Note on sctp_sf_do_9_1_abort() and sctp_sf_shutdown_pending_abort(),
    the chunk length has been verified before sctp_sf_discard_chunk(),
    so replace it with sctp_sf_discard(). On sctp_sf_do_asconf_ack() and
    sctp_sf_do_asconf(), move the sctp_chunk_length_valid check ahead of
    sctp_sf_discard_chunk(), then replace it with sctp_sf_discard().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 4f7019c7eb33967eb87766e0e4602b5576873680
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 20 07:42:41 2021 -0400

    sctp: use init_tag from inithdr for ABORT chunk
    
    Currently Linux SCTP uses the verification tag of the existing SCTP
    asoc when failing to process and sending the packet with the ABORT
    chunk. This will result in the peer accepting the ABORT chunk and
    removing the SCTP asoc. One could exploit this to terminate a SCTP
    asoc.
    
    This patch is to fix it by always using the initiate tag of the
    received INIT chunk for the ABORT chunk to be sent.
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 4f0bc44b9191b176d7b558f1f5ca1865339a27ef
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    commit a2d859e3fc97e79d907761550dbc03ff1b36479c upstream.
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d84a69ac410f6228873d05d35120f6bdddab7fc3
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    commit a2d859e3fc97e79d907761550dbc03ff1b36479c upstream.
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d88774539539dcbf825a25e61234f110513f5963
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    commit a2d859e3fc97e79d907761550dbc03ff1b36479c upstream.
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c57fdeff69b152185fafabd37e6bfecfce51efda
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    commit a2d859e3fc97e79d907761550dbc03ff1b36479c upstream.
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 41f0bcc7d9eac315259d4e9fb441552f60e8ec9e
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    commit a2d859e3fc97e79d907761550dbc03ff1b36479c upstream.
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a2d859e3fc97e79d907761550dbc03ff1b36479c
Author: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
Date:   Wed Oct 13 17:27:29 2021 -0300

    sctp: account stream padding length for reconf chunk
    
    sctp_make_strreset_req() makes repeated calls to sctp_addto_chunk()
    which will automatically account for padding on each call. inreq and
    outreq are already 4 bytes aligned, but the payload is not and doing
    SCTP_PAD4(a + b) (which _sctp_make_chunk() did implicitly here) is
    different from SCTP_PAD4(a) + SCTP_PAD4(b) and not enough. It led to
    possible attempt to use more buffer than it was allocated and triggered
    a BUG_ON.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Greg KH <gregkh@linuxfoundation.org>
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Eiichi Tsukata <eiichi.tsukata@nutanix.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/b97c1f8b0c7ff79ac4ed206fc2c49d3612e0850c.1634156849.git.mleitner@redhat.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit ccb79116c37242c07c34c991868acded87509e4c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ffca46766850d4b96a26ad511a7997f74da2df8c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2f4b67bceb09cabbaeceeb278eeed27862c386ec
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cbd10b118902ca8a86851e5c4749fbb12cd9ebad
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 718094012d82a9e925a839fbab11a1eaa3220669
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 194d21f10ef6a2e1109c31d775fb23ffdb41657f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6c4a5606951cf2be8cbed4d4aefbbeaedb4cb24f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e58e3511b3c2080071ce451917d032f1e39c0788
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4d2de0d232ee386fceacf7cdb20a6398c3c0854b
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6b5361868870e9a097745446798aa10ee92c159c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 27431d3549dd567bc1ad5ccc969f7a9d0742bfac
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9 upstream.
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 061694089d817da3e82d938d70a876090f1bfac2
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    commit b6ffe7671b24689c09faa5675dd58f93758a97ae upstream.
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0de0c167392785d25f31a7a3666bd1abbf1fd46c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    [ Upstream commit f4919ff59c2828064b4156e3c3600a169909bcf4 ]
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ef306a7dd849d3e623716cb539e56fe4c0f4c64f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    [ Upstream commit f4919ff59c2828064b4156e3c3600a169909bcf4 ]
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 24c75df12b9522fb9d880abb549234b1173157fb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    [ Upstream commit f4919ff59c2828064b4156e3c3600a169909bcf4 ]
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 064b2d2bb5ffb54b12bf09aacd99e89b4e2d968e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    [ Upstream commit f4919ff59c2828064b4156e3c3600a169909bcf4 ]
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit cca61275874a8807ba357905206961a5decdc326
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    [ Upstream commit f4919ff59c2828064b4156e3c3600a169909bcf4 ]
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 43b699d129a08fc0bd6735b6d25686712a9bdabb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9172d455994f4d5da04cf3a1df9091619630552f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 615595faefb2bda6fc23546ef075a8597cc13050
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 53012dd6ca2f3c9420b5cc447279375a90290fb4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f65b7f377ccaea3cee00c910729ed6170ae13324
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4d972881f8d8e80e0320169e681284785cfe51e2
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 83af97f615276a2788b7e7881d92bfccca11bcae
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    [ Upstream commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08 ]
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c9437655302c503caa2a7ecf7a3167ee6a02cbef
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 17 17:19:19 2021 -0400

    sctp: trim optlen when it's a huge value in sctp_setsockopt
    
    [ Upstream commit 2f3fdd8d4805015fa964807e1c7f3d88f31bd389 ]
    
    After commit ca84bd058dae ("sctp: copy the optval from user space in
    sctp_setsockopt"), it does memory allocation in sctp_setsockopt with
    the optlen, and it would fail the allocation and return error if the
    optlen from user space is a huge value.
    
    This breaks some sockopts, like SCTP_HMAC_IDENT, SCTP_RESET_STREAMS and
    SCTP_AUTH_KEY, as when processing these sockopts before, optlen would
    be trimmed to a biggest value it needs when optlen is a huge value,
    instead of failing the allocation and returning error.
    
    This patch is to fix the allocation failure when it's a huge optlen from
    user space by trimming it to the biggest size sctp sockopt may need when
    necessary, and this biggest size is from sctp_setsockopt_reset_streams()
    for SCTP_RESET_STREAMS, which is bigger than those for SCTP_HMAC_IDENT
    and SCTP_AUTH_KEY.
    
    Fixes: ca84bd058dae ("sctp: copy the optval from user space in sctp_setsockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 096a8dca8ca5191292bcc6409c552a7b7f5e7362
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 17 17:19:19 2021 -0400

    sctp: trim optlen when it's a huge value in sctp_setsockopt
    
    [ Upstream commit 2f3fdd8d4805015fa964807e1c7f3d88f31bd389 ]
    
    After commit ca84bd058dae ("sctp: copy the optval from user space in
    sctp_setsockopt"), it does memory allocation in sctp_setsockopt with
    the optlen, and it would fail the allocation and return error if the
    optlen from user space is a huge value.
    
    This breaks some sockopts, like SCTP_HMAC_IDENT, SCTP_RESET_STREAMS and
    SCTP_AUTH_KEY, as when processing these sockopts before, optlen would
    be trimmed to a biggest value it needs when optlen is a huge value,
    instead of failing the allocation and returning error.
    
    This patch is to fix the allocation failure when it's a huge optlen from
    user space by trimming it to the biggest size sctp sockopt may need when
    necessary, and this biggest size is from sctp_setsockopt_reset_streams()
    for SCTP_RESET_STREAMS, which is bigger than those for SCTP_HMAC_IDENT
    and SCTP_AUTH_KEY.
    
    Fixes: ca84bd058dae ("sctp: copy the optval from user space in sctp_setsockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 56af5e749f20c3a540310c207dcc373f4f09156e
Author: Peilin Ye <peilin.ye@bytedance.com>
Date:   Tue Jul 27 18:33:15 2021 -0700

    net/sched: act_skbmod: Add SKBMOD_F_ECN option support
    
    Currently, when doing rate limiting using the tc-police(8) action, the
    easiest way is to simply drop the packets which exceed or conform the
    configured bandwidth limit.  Add a new option to tc-skbmod(8), so that
    users may use the ECN [1] extension to explicitly inform the receiver
    about the congestion instead of dropping packets "on the floor".
    
    The 2 least significant bits of the Traffic Class field in IPv4 and IPv6
    headers are used to represent different ECN states [2]:
    
            0b00: "Non ECN-Capable Transport", Non-ECT
            0b10: "ECN Capable Transport", ECT(0)
            0b01: "ECN Capable Transport", ECT(1)
            0b11: "Congestion Encountered", CE
    
    As an example:
    
            $ tc filter add dev eth0 parent 1: protocol ip prio 10 \
                    matchall action skbmod ecn
    
    Doing the above marks all ECT(0) and ECT(1) packets as CE.  It does NOT
    affect Non-ECT or non-IP packets.  In the tc-police scenario mentioned
    above, users may pipe a tc-police action and a tc-skbmod "ecn" action
    together to achieve ECN-based rate limiting.
    
    For TCP connections, upon receiving a CE packet, the receiver will respond
    with an ECE packet, asking the sender to reduce their congestion window.
    However ECN also works with other L4 protocols e.g. DCCP and SCTP [2], and
    our implementation does not touch or care about L4 headers.
    
    The updated tc-skbmod SYNOPSIS looks like the following:
    
            tc ... action skbmod { set SETTABLE | swap SWAPPABLE | ecn } ...
    
    Only one of "set", "swap" or "ecn" shall be used in a single tc-skbmod
    command.  Trying to use more than one of them at a time is considered
    undefined behavior; pipe multiple tc-skbmod commands together instead.
    "set" and "swap" only affect Ethernet packets, while "ecn" only affects
    IPv{4,6} packets.
    
    It is also worth mentioning that, in theory, the same effect could be
    achieved by piping a "police" action and a "bpf" action using the
    bpf_skb_ecn_set_ce() helper, but this requires eBPF programming from the
    user, thus impractical.
    
    Depends on patch "net/sched: act_skbmod: Skip non-Ethernet packets".
    
    [1] https://datatracker.ietf.org/doc/html/rfc3168
    [2] https://en.wikipedia.org/wiki/Explicit_Congestion_Notification
    
    Reviewed-by: Cong Wang <cong.wang@bytedance.com>
    Signed-off-by: Peilin Ye <peilin.ye@bytedance.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ddaed6b09b09eb8b5d8c7c216a8b285f897370e
Merge: 58acd1009226 ece1278a9b81
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jul 21 08:50:52 2021 -0700

    Merge branch 'pmtu-esp'
    
    Vadim Fedorenko ays:
    
    ====================
    Fix PMTU for ESP-in-UDP encapsulation
    
    Bug 213669 uncovered regression in PMTU discovery for UDP-encapsulated
    routes and some incorrect usage in udp tunnel fields. This series fixes
    problems and also adds such case for selftests
    
    v3:
     - update checking logic to account SCTP use case
    v2:
     - remove refactor code that was in first patch
     - move checking logic to __udp{4,6}_lib_err_encap
     - add more tests, especially routed configuration
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c557d06b420b08e380e2875f04aff8624fb8dcc
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    [ Upstream commit 364745fbe981a4370f50274475da4675661104df ]
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8728a455d20ddadecd767337475fc1371e031d79
Author: Alexander Aring <aahringo@redhat.com>
Date:   Fri Jul 16 16:22:43 2021 -0400

    fs: dlm: generic connect func
    
    This patch adds a generic connect function for TCP and SCTP. If the
    connect functionality differs from each other additional callbacks in
    dlm_proto_ops were added. The sockopts callback handling will guarantee
    that sockets created by connect() will use the same options as sockets
    created by accept().
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 90d21fc0479dc0b5d338d664ddb55e5017b44f3e
Author: Alexander Aring <aahringo@redhat.com>
Date:   Fri Jul 16 16:22:42 2021 -0400

    fs: dlm: auto load sctp module
    
    This patch adds a "for now" better handling of missing SCTP support in
    the kernel and try to load the sctp module if SCTP is set.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 2f3fdd8d4805015fa964807e1c7f3d88f31bd389
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 17 17:19:19 2021 -0400

    sctp: trim optlen when it's a huge value in sctp_setsockopt
    
    After commit ca84bd058dae ("sctp: copy the optval from user space in
    sctp_setsockopt"), it does memory allocation in sctp_setsockopt with
    the optlen, and it would fail the allocation and return error if the
    optlen from user space is a huge value.
    
    This breaks some sockopts, like SCTP_HMAC_IDENT, SCTP_RESET_STREAMS and
    SCTP_AUTH_KEY, as when processing these sockopts before, optlen would
    be trimmed to a biggest value it needs when optlen is a huge value,
    instead of failing the allocation and returning error.
    
    This patch is to fix the allocation failure when it's a huge optlen from
    user space by trimming it to the biggest size sctp sockopt may need when
    necessary, and this biggest size is from sctp_setsockopt_reset_streams()
    for SCTP_RESET_STREAMS, which is bigger than those for SCTP_HMAC_IDENT
    and SCTP_AUTH_KEY.
    
    Fixes: ca84bd058dae ("sctp: copy the optval from user space in sctp_setsockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f4919ff59c2828064b4156e3c3600a169909bcf4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 16 17:44:07 2021 -0400

    tipc: keep the skb in rcv queue until the whole data is read
    
    Currently, when userspace reads a datagram with a buffer that is
    smaller than this datagram, the data will be truncated and only
    part of it can be received by users. It doesn't seem right that
    users don't know the datagram size and have to use a huge buffer
    to read it to avoid the truncation.
    
    This patch to fix it by keeping the skb in rcv queue until the
    whole data is read by users. Only the last msg of the datagram
    will be marked with MSG_EOR, just as TCP/SCTP does.
    
    Note that this will work as above only when MSG_EOR is set in the
    flags parameter of recvmsg(), so that it won't break any old user
    applications.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 138fa2ab24aef2ca8e55ea25194b5b3d062aeeae
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    [ Upstream commit 364745fbe981a4370f50274475da4675661104df ]
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 871166f159b367c4ee5dc5e9b65493e7c448b738
Author: Alexander Aring <aahringo@redhat.com>
Date:   Fri May 21 15:08:39 2021 -0400

    fs: dlm: fix connection tcp EOF handling
    
    [ Upstream commit 8aa31cbf20ad168c35dd83476629402aacbf5a44 ]
    
    This patch fixes the EOF handling for TCP that if and EOF is received we
    will close the socket next time the writequeue runs empty. This is a
    half-closed socket functionality which doesn't exists in SCTP. The
    midcomms layer will do a half closed socket functionality on DLM side to
    solve this problem for the SCTP case. However there is still the last ack
    flying around but other reset functionality will take care of it if it got
    lost.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f1893eb256e4ddba57b306b77ce44933d27b18a0
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    [ Upstream commit 364745fbe981a4370f50274475da4675661104df ]
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit aefa9277440886b8b17c258669b86bef8379a3a1
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    [ Upstream commit 364745fbe981a4370f50274475da4675661104df ]
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5e98c708a471836edac3791be58dbbc93e6aa0a9
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    [ Upstream commit 364745fbe981a4370f50274475da4675661104df ]
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1d11fa231cabeae09a95cb3e4cf1d9dd34e00f08
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 29 23:34:08 2021 -0400

    sctp: move 198 addresses from unusable to private scope
    
    The doc draft-stewart-tsvwg-sctp-ipv4-00 that restricts 198 addresses
    was never published. These addresses as private addresses should be
    allowed to use in SCTP.
    
    As Michael Tuexen suggested, this patch is to move 198 addresses from
    unusable to private scope.
    
    Reported-by: Srgio <surkamp@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f9beb95e6a2669fa35e34a6ff52808b181efa20f
Merge: 9ea3e52c5bc8 ef6c8d6ccf0c
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jun 28 15:34:50 2021 -0700

    Merge branch 'sctp-size-validations'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    sctp: add some size validations
    
    Ilja Van Sprundel reported that some size validations on inbound
    SCTP packets were missing. After some code review, I noticed two
    others that are all fixed here.
    
    Thanks Ilja for reporting this.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ef6c8d6ccf0c1dccdda092ebe8782777cd7803c9
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:44 2021 -0300

    sctp: add param size validation for SCTP_PARAM_SET_PRIMARY
    
    When SCTP handles an INIT chunk, it calls for example:
    sctp_sf_do_5_1B_init
      sctp_verify_init
        sctp_verify_param
      sctp_process_init
        sctp_process_param
          handling of SCTP_PARAM_SET_PRIMARY
    
    sctp_verify_init() wasn't doing proper size validation and neither the
    later handling, allowing it to work over the chunk itself, possibly being
    uninitialized memory.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b6ffe7671b24689c09faa5675dd58f93758a97ae
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Jun 28 16:13:43 2021 -0300

    sctp: validate chunk size in __rcv_asconf_lookup
    
    In one of the fallbacks that SCTP has for identifying an association for an
    incoming packet, it looks for AddIp chunk (from ASCONF) and take a peek.
    Thing is, at this stage nothing was validating that the chunk actually had
    enough content for that, allowing the peek to happen over uninitialized
    memory.
    
    Similar check already exists in actual asconf handling in
    sctp_verify_asconf().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0dac127c05579854405ef14480936b32371ddaed
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jun 24 11:48:08 2021 -0400

    sctp: do black hole detection in search complete state
    
    Currently the PLPMUTD probe will stop for a long period (interval * 30)
    after it enters search complete state. If there's a pmtu change on the
    route path, it takes a long time to be aware if the ICMP TooBig packet
    is lost or filtered.
    
    As it says in rfc8899#section-4.3:
    
      "A DPLPMTUD method MUST NOT rely solely on this method."
      (ICMP PTB message).
    
    This patch is to enable the other method for search complete state:
    
      "A PL can use the DPLPMTUD probing mechanism to periodically
       generate probe packets of the size of the current PLPMTU."
    
    With this patch, the probe will continue with the current pmtu every
    'interval' until the PMTU_RAISE_TIMER 'timeout', which we implement
    by adding raise_count to raise the probe size when it counts to 30
    and removing the SCTP_PL_COMPLETE check for PMTU_RAISE_TIMER.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 364745fbe981a4370f50274475da4675661104df
Author: Maciej enczykowski <maze@google.com>
Date:   Wed Jun 16 17:09:51 2021 -0700

    bpf: Do not change gso_size during bpf_skb_change_proto()
    
    This is technically a backwards incompatible change in behaviour, but I'm
    going to argue that it is very unlikely to break things, and likely to fix
    *far* more then it breaks.
    
    In no particular order, various reasons follow:
    
    (a) I've long had a bug assigned to myself to debug a super rare kernel crash
    on Android Pixel phones which can (per stacktrace) be traced back to BPF clat
    IPv6 to IPv4 protocol conversion causing some sort of ugly failure much later
    on during transmit deep in the GSO engine, AFAICT precisely because of this
    change to gso_size, though I've never been able to manually reproduce it. I
    believe it may be related to the particular network offload support of attached
    USB ethernet dongle being used for tethering off of an IPv6-only cellular
    connection. The reason might be we end up with more segments than max permitted,
    or with a GSO packet with only one segment... (either way we break some
    assumption and hit a BUG_ON)
    
    (b) There is no check that the gso_size is > 20 when reducing it by 20, so we
    might end up with a negative (or underflowing) gso_size or a gso_size of 0.
    This can't possibly be good. Indeed this is probably somehow exploitable (or
    at least can result in a kernel crash) by delivering crafted packets and perhaps
    triggering an infinite loop or a divide by zero... As a reminder: gso_size (MSS)
    is related to MTU, but not directly derived from it: gso_size/MSS may be
    significantly smaller then one would get by deriving from local MTU. And on
    some NICs (which do loose MTU checking on receive, it may even potentially be
    larger, for example my work pc with 1500 MTU can receive 1520 byte frames [and
    sometimes does due to bugs in a vendor plat46 implementation]). Indeed even just
    going from 21 to 1 is potentially problematic because it increases the number
    of segments by a factor of 21 (think DoS, or some other crash due to too many
    segments).
    
    (c) It's always safe to not increase the gso_size, because it doesn't result in
    the max packet size increasing.  So the skb_increase_gso_size() call was always
    unnecessary for correctness (and outright undesirable, see later). As such the
    only part which is potentially dangerous (ie. could cause backwards compatibility
    issues) is the removal of the skb_decrease_gso_size() call.
    
    (d) If the packets are ultimately destined to the local device, then there is
    absolutely no benefit to playing around with gso_size. It only matters if the
    packets will egress the device. ie. we're either forwarding, or transmitting
    from the device.
    
    (e) This logic only triggers for packets which are GSO. It does not trigger for
    skbs which are not GSO. It will not convert a non-GSO MTU sized packet into a
    GSO packet (and you don't even know what the MTU is, so you can't even fix it).
    As such your transmit path must *already* be able to handle an MTU 20 bytes
    larger then your receive path (for IPv4 to IPv6 translation) - and indeed 28
    bytes larger due to IPv4 fragments. Thus removing the skb_decrease_gso_size()
    call doesn't actually increase the size of the packets your transmit side must
    be able to handle. ie. to handle non-GSO max-MTU packets, the IPv4/IPv6 device/
    route MTUs must already be set correctly. Since for example with an IPv4 egress
    MTU of 1500, IPv4 to IPv6 translation will already build 1520 byte IPv6 frames,
    so you need a 1520 byte device MTU. This means if your IPv6 device's egress
    MTU is 1280, your IPv4 route must be 1260 (and actually 1252, because of the
    need to handle fragments). This is to handle normal non-GSO packets. Thus the
    reduction is simply not needed for GSO packets, because when they're correctly
    built, they will already be the right size.
    
    (f) TSO/GSO should be able to exactly undo GRO: the number of packets (TCP
    segments) should not be modified, so that TCP's MSS counting works correctly
    (this matters for congestion control). If protocol conversion changes the
    gso_size, then the number of TCP segments may increase or decrease. Packet loss
    after protocol conversion can result in partial loss of MSS segments that the
    sender sent. How's the sending TCP stack going to react to receiving ACKs/SACKs
    in the middle of the segments it sent?
    
    (g) skb_{decrease,increase}_gso_size() are already no-ops for GSO_BY_FRAGS
    case (besides triggering WARN_ON_ONCE). This means you already cannot guarantee
    that gso_size (and thus resulting packet MTU) is changed. ie. you must assume
    it won't be changed.
    
    (h) changing gso_size is outright buggy for UDP GSO packets, where framing
    matters (I believe that's also the case for SCTP, but it's already excluded
    by [g]).  So the only remaining case is TCP, which also doesn't want it
    (see [f]).
    
    (i) see also the reasoning on the previous attempt at fixing this
    (commit fa7b83bf3b156c767f3e4a25bbf3817b08f3ff8e) which shows that the current
    behaviour causes TCP packet loss:
    
      In the forwarding path GRO -> BPF 6 to 4 -> GSO for TCP traffic, the
      coalesced packet payload can be > MSS, but < MSS + 20.
    
      bpf_skb_proto_6_to_4() will upgrade the MSS and it can be > the payload
      length. After then tcp_gso_segment checks for the payload length if it
      is <= MSS. The condition is causing the packet to be dropped.
    
      tcp_gso_segment():
        [...]
        mss = skb_shinfo(skb)->gso_size;
        if (unlikely(skb->len <= mss)) goto out;
        [...]
    
    Thus changing the gso_size is simply a very bad idea. Increasing is unnecessary
    and buggy, and decreasing can go negative.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Signed-off-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Dongseok Yi <dseok.yi@samsung.com>
    Cc: Willem de Bruijn <willemb@google.com>
    Link: https://lore.kernel.org/bpf/CANP3RGfjLikQ6dg=YpBU0OeHvyv7JOki7CyOUS9modaXAi-9vQ@mail.gmail.com
    Link: https://lore.kernel.org/bpf/20210617000953.2787453-2-zenczykowski@gmail.com

commit a7b62112f0abf58a7f6d2bdfef40b637a4a1c4d4
Merge: 0a36a75c6818 24610ed80df6
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jun 23 12:31:28 2021 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter updates for net-next
    
    The following patchset contains Netfilter updates for net-next:
    
    1) Skip non-SCTP packets in the new SCTP chunk support for nft_exthdr,
       from Phil Sutter.
    
    2) Simplify TCP option sanity check for TCP packets, also from Phil.
    
    3) Add a new expression to store when the rule has been used last time.
    
    4) Pass the hook state object to log function, from Florian Westphal.
    
    5) Document the new sysctl knobs to tune the flowtable timeouts,
       from Oz Shlomo.
    
    6) Fix snprintf error check in the new nfnetlink_hook infrastructure,
       from Dan Carpenter.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a432c771e2d9bc059ffe3028faf040c08b6a9f98
Merge: aff0824dc4d6 9e47df005cab
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jun 22 11:28:52 2021 -0700

    Merge branch 'sctp-packetization-path-MTU'
    
    Xin Long says:
    
    ====================
    sctp: implement RFC8899: Packetization Layer Path MTU Discovery for SCTP transport
    
    Overview(From RFC8899):
    
      In contrast to PMTUD, Packetization Layer Path MTU Discovery
      (PLPMTUD) [RFC4821] introduces a method that does not rely upon
      reception and validation of PTB messages.  It is therefore more
      robust than Classical PMTUD.  This has become the recommended
      approach for implementing discovery of the PMTU [BCP145].
    
      It uses a general strategy in which the PL sends probe packets to
      search for the largest size of unfragmented datagram that can be sent
      over a network path.  Probe packets are sent to explore using a
      larger packet size.  If a probe packet is successfully delivered (as
      determined by the PL), then the PLPMTU is raised to the size of the
      successful probe.  If a black hole is detected (e.g., where packets
      of size PLPMTU are consistently not received), the method reduces the
      PLPMTU.
    
    SCTP Probe Packets:
    
      As the RFC suggested, the probe packets consist of an SCTP common header
      followed by a HEARTBEAT chunk and a PAD chunk. The PAD chunk is used to
      control the length of the probe packet.  The HEARTBEAT chunk is used to
      trigger the sending of a HEARTBEAT ACK chunk to confirm this probe on
      the HEARTBEAT sender.
    
      The HEARTBEAT chunk also carries a Heartbeat Information parameter that
      includes the probe size to help an implementation associate a HEARTBEAT
      ACK with the size of probe that was sent. The sender use the nonce and
      the probe size to verify the information returned.
    
    Detailed Implementation on SCTP:
    
                           +------+
                  +------->| Base |-----------------+ Connectivity
                  |        +------+                 | or BASE_PLPMTU
                  |           |                     | confirmation failed
                  |           |                     v
                  |           | Connectivity    +-------+
                  |           | and BASE_PLPMTU | Error |
                  |           | confirmed       +-------+
                  |           |                     | Consistent
                  |           v                     | connectivity
       Black Hole |       +--------+                | and BASE_PLPMTU
        detected  |       | Search |<---------------+ confirmed
                  |       +--------+
                  |          ^  |
                  |          |  |
                  |    Raise |  | Search
                  |    timer |  | algorithm
                  |  expired |  | completed
                  |          |  |
                  |          |  v
                  |   +-----------------+
                  +---| Search Complete |
                      +-----------------+
    
      When PLPMTUD is enabled, it's in Base state, and starts to probe with
      BASE_PLPMTU (1200). If this probe succeeds, it goes to Search state;
      If this probe fails, it goes to Error state under which pl.pmtu goes
      down to MIN_PLPMTU (512) and keeps probing with BASE_PLPMTU until it
      succeeds and goes to Search state.
    
      During the Search state, the probe size is growing by a Big step (32)
      every time when the last probe succeeds at the beginning. Once a probe
      (such as 1420) fails after trying MAX_PROBES (3) times, the probe_size
      goes back to the last one (1420 - 32 = 1388), meanwhile 'probe_high'
      is set to 1420 and the growing step becomes a Small one (4). Then the
      probe is continuing with a Small step grown each round. Until it gets
      the optimal size (such as 1400) when probe with its next probe size
      (1404) fails, it sync this size to pathmtu and goes to Complete state.
    
      In Complete state, it will only does a probe check for the pathmtu just
      set, if it fails, which means a Black Hole is detected and it goes back
      to Base state. If it succeeds, it goes back to Search state again, and
      probe is continuing with growing a Small step (1400 + 4). If this probe
      fails, probe_high is set and goes back to 1388 and then Complete state,
      which is kind of a loop normally. However if the env's pathmtu changes
      to a big size somehow, this probe will succeed and then probe continues
      with growing a Big step (1400 + 32) each round until another probe fails.
    
    PTB Messages Process:
    
      PLPMTUD doesn't rely on these package to find the pmtu, and shouldn't
      trust it either. When processing them, it only changes the probe_size
      to PL_PTB_SIZE(info - hlen) if 'pl.pmtu < PL_PTB_SIZE < the current
      probe_size' druing Search state. As this could help probe_size to get
      to the optimal size faster, for exmaple:
    
      pl.pmtu = 1388, probe_size = 1420, while the env's pathmtu = 1400.
      When probe_size is 1420, a Toobig packet with 1400 comes back. If probe
      size changes to use 1400, it will save quite a few rounds to get there.
      But of course after having this value, PLPMTUD will still verify it on
      its own before using it.
    
    Patches:
    
      - Patch 1-6: introduce some new constants/variables from the RFC, systcl
        and members in transport, APIs for the following patches, chunks and
        a timer for the probe sending and some codes for the probe receiving.
    
      - Patch 7-9: implement the state transition on the tx path, rx path and
        toobig ICMP packet processing. This is the main algorithm part.
    
      - Patch 10: activate this feature
    
      - Patch 11-14: improve the process for ICMP packets for SCTP over UDP,
        so that it can also be covered by this feature.
    
    Tests:
    
      - do sysctl and setsockopt tests for this feature's enabling and disabling.
    
      - get these pr_debug points for this feature by
          # cat /sys/kernel/debug/dynamic_debug/control | grep PLP
        and enable them on kernel dynamic debug, then play with the pathmtu and
        check if the state transition and plpmtu change match the RFC.
    
      - do the above tests for SCTP over IPv4/IPv6 and SCTP over UDP.
    
    v1->v2:
      - See Patch 06/14.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 83696408317735d105ad86a5470b39879ad2ec4d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:55 2021 -0400

    sctp: do state transition when receiving an icmp TOOBIG packet
    
    PLPMTUD will short-circuit the old process for icmp TOOBIG packets.
    This part is described in rfc8899#section-4.6.2 (PL_PTB_SIZE =
    PTB_SIZE - other_headers_len). Note that from rfc8899#section-5.2
    State Machine, each case below is for some specific states only:
    
      a) PL_PTB_SIZE < MIN_PLPMTU || PL_PTB_SIZE >= PROBED_SIZE,
         discard it, for any state
    
      b) MIN_PLPMTU < PL_PTB_SIZE < BASE_PLPMTU,
         Base -> Error, for Base state
    
      c) BASE_PLPMTU <= PL_PTB_SIZE < PLPMTU,
         Search -> Base or Complete -> Base, for Search and Complete states.
    
      d) PLPMTU < PL_PTB_SIZE < PROBED_SIZE,
         set pl.probe_size to PL_PTB_SIZE then verify it, for Search state.
    
    The most important one is case d), which will help find the optimal
    fast during searching. Like when pathmtu = 1392 for SCTP over IPv4,
    the search will be (20 is iphdr_len):
    
      1. probe with 1200 - 20
      2. probe with 1232 - 20
      3. probe with 1264 - 20
      ...
      7. probe with 1388 - 20
      8. probe with 1420 - 20
    
    When sending the probe with 1420 - 20, TOOBIG may come with PL_PTB_SIZE =
    1392 - 20. Then it matches case d), and saves some rounds to try with the
    1392 - 20 probe. But of course, PLPMTUD doesn't trust TOOBIG packets, and
    it will go back to the common searching once the probe with the new size
    can't be verified.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b87641aff9e772fda15d3386d159646eada2ceef
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:54 2021 -0400

    sctp: do state transition when a probe succeeds on HB ACK recv path
    
    As described in rfc8899#section-5.2, when a probe succeeds, there might
    be the following state transitions:
    
      - Base -> Search, occurs when probe succeeds with BASE_PLPMTU,
        pl.pmtu is not changing,
        pl.probe_size increases by SCTP_PL_BIG_STEP,
    
      - Error -> Search, occurs when probe succeeds with BASE_PLPMTU,
        pl.pmtu is changed from SCTP_MIN_PLPMTU to SCTP_BASE_PLPMTU,
        pl.probe_size increases by SCTP_PL_BIG_STEP.
    
      - Search -> Search Complete, occurs when probe succeeds with the probe
        size SCTP_MAX_PLPMTU less than pl.probe_high,
        pl.pmtu is not changing, but update *pathmtu* with it,
        pl.probe_size is set back to pl.pmtu to double check it.
    
      - Search Complete -> Search, occurs when probe succeeds with the probe
        size equal to pl.pmtu,
        pl.pmtu is not changing,
        pl.probe_size increases by SCTP_PL_MIN_STEP.
    
    So search process can be described as:
    
     1. When it just enters 'Search' state, *pathmtu* is not updated with
        pl.pmtu, and probe_size increases by a big step (SCTP_PL_BIG_STEP)
        each round.
    
     2. Until pl.probe_high is set when a probe fails, and probe_size
        decreases back to pl.pmtu, as described in the last patch.
    
     3. When the probe with the new size succeeds, probe_size changes to
        increase by a small step (SCTP_PL_MIN_STEP) due to pl.probe_high
        is set.
    
     4. Until probe_size is next to pl.probe_high, the searching finishes and
        it goes to 'Complete' state and updates *pathmtu* with pl.pmtu, and
        then probe_size is set to pl.pmtu to confirm by once more probe.
    
     5. This probe occurs after "30 * probe_inteval", a much longer time than
        that in Search state. Once it is done it goes to 'Search' state again
        with probe_size increased by SCTP_PL_MIN_STEP.
    
    As we can see above, during the searching, pl.pmtu changes while *pathmtu*
    doesn't. *pathmtu* is only updated when the search finishes by which it
    gets an optimal value for it. A big step is used at the beginning until
    it gets close to the optimal value, then it changes to a small step until
    it has this optimal value.
    
    The small step is also used in 'Complete' until it goes to 'Search' state
    again and the probe with 'pmtu + the small step' succeeds, which means a
    higher size could be used. Then probe_size changes to increase by a big
    step again until it gets close to the next optimal value.
    
    Note that anytime when black hole is detected, it goes directly to 'Base'
    state with pl.pmtu set to SCTP_BASE_PLPMTU, as described in the last patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1dc68c194571acc4027de5f8378227d0c0ff7e13
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:53 2021 -0400

    sctp: do state transition when PROBE_COUNT == MAX_PROBES on HB send path
    
    The state transition is described in rfc8899#section-5.2,
    PROBE_COUNT == MAX_PROBES means the probe fails for MAX times, and the
    state transition includes:
    
      - Base -> Error, occurs when BASE_PLPMTU Confirmation Fails,
        pl.pmtu is set to SCTP_MIN_PLPMTU,
        probe_size is still SCTP_BASE_PLPMTU;
    
      - Search -> Base, occurs when Black Hole Detected,
        pl.pmtu is set to SCTP_BASE_PLPMTU,
        probe_size is set back to SCTP_BASE_PLPMTU;
    
      - Search Complete -> Base, occurs when Black Hole Detected
        pl.pmtu is set to SCTP_BASE_PLPMTU,
        probe_size is set back to SCTP_BASE_PLPMTU;
    
    Note a black hole is encountered when a sender is unaware that packets
    are not being delivered to the destination endpoint. So it includes the
    probe failures with equal probe_size to pl.pmtu, and definitely not
    include that with greater probe_size than pl.pmtu. The later one is the
    normal probe failure where probe_size should decrease back to pl.pmtu
    and pl.probe_high is set.  pl.probe_high would be used on HB ACK recv
    path in the next patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fe59379b9ab7ddad157f5379fa47dbf84c9b5e09
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:52 2021 -0400

    sctp: do the basic send and recv for PLPMTUD probe
    
    This patch does exactly what rfc8899#section-6.2.1.2 says:
    
       The SCTP sender needs to be able to determine the total size of a
       probe packet.  The HEARTBEAT chunk could carry a Heartbeat
       Information parameter that includes, besides the information
       suggested in [RFC4960], the probe size to help an implementation
       associate a HEARTBEAT ACK with the size of probe that was sent.  The
       sender could also use other methods, such as sending a nonce and
       verifying the information returned also contains the corresponding
       nonce.  The length of the PAD chunk is computed by reducing the
       probing size by the size of the SCTP common header and the HEARTBEAT
       chunk.
    
    Note that HB ACK chunk will carry back whatever HB chunk carried, including
    the probe_size we put it in; We also check hbinfo->probe_size in the HB ACK
    against link->pl.probe_size to validate this HB ACK chunk.
    
    v1->v2:
      - Remove the unused 'sp' and add static for sctp_packet_bundle_pad().
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 92548ec2f1f92d0c0b60ce59592b645571672568
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:51 2021 -0400

    sctp: add the probe timer in transport for PLPMTUD
    
    There are 3 timers described in rfc8899#section-5.1.1:
    
      PROBE_TIMER, PMTU_RAISE_TIMER, CONFIRMATION_TIMER
    
    This patches adds a 'probe_timer' in transport, and it works as either
    PROBE_TIMER or PMTU_RAISE_TIMER. At most time, it works as PROBE_TIMER
    and expires every a 'probe_interval' time to send the HB probe packet.
    When transport pl enters COMPLETE state, it works as PMTU_RAISE_TIMER
    and expires in 'probe_interval * 30' time to go back to SEARCH state
    and do searching again.
    
    SCTP HB is an acknowledged packet, CONFIRMATION_TIMER is not needed.
    
    The timer will start when transport pl enters BASE state and stop
    when it enters DISABLED state.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3190b649b4d9391be7bde3edd8e924e451c5d2f6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:49 2021 -0400

    sctp: add SCTP_PLPMTUD_PROBE_INTERVAL sockopt for sock/asoc/transport
    
    With this socket option, users can change probe_interval for
    a transport, asoc or sock after it's created.
    
    Note that if the change is for an asoc, also apply the change
    to each transport in this asoc.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 745a32117b5a0799ce1dd28d5a74dc2b7bf37692
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 22 14:04:47 2021 -0400

    sctp: add pad chunk and its make function and event table
    
    This chunk is defined in rfc4820#section-3, and used to pad an
    SCTP packet. The receiver must discard this chunk and continue
    processing the rest of the chunks in the packet.
    
    Add it now, as it will be bundled with a heartbeat chunk to probe
    pmtu in the following patches.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5acc44f39458f43dac9724cefa4da29847cfe997
Author: Phil Sutter <phil@nwl.cc>
Date:   Fri Jun 11 19:06:45 2021 +0200

    netfilter: nft_exthdr: Search chunks in SCTP packets only
    
    Since user space does not generate a payload dependency, plain sctp
    chunk matches cause searching in non-SCTP packets, too. Avoid this
    potential mis-interpretation of packet data by checking pkt->tprot.
    
    Fixes: 133dc203d77df ("netfilter: nft_exthdr: Support SCTP chunks")
    Signed-off-by: Phil Sutter <phil@nwl.cc>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 7f3579e1893f66edef95a0436a4e10073d085fda
Merge: 4e744cb8126d c5c6accd7b7e
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jun 9 14:50:35 2021 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter updates for net-next
    
    The following patchset contains Netfilter updates for net-next:
    
    1) Add nfgenmsg field to nfnetlink's struct nfnl_info and use it.
    
    2) Remove nft_ctx_init_from_elemattr() and nft_ctx_init_from_setattr()
       helper functions.
    
    3) Add the nf_ct_pernet() helper function to fetch the conntrack
       pernetns data area.
    
    4) Expose TCP and UDP flowtable offload timeouts through sysctl,
       from Oz Shlomo.
    
    5) Add nfnetlink_hook subsystem to fetch the netfilter hook
       pipeline configuration, from Florian Westphal. This also includes
       a new field to annotate the hook type as metadata.
    
    6) Fix unsafe memory access to non-linear skbuff in the new SCTP
       chunk support for nft_exthdr, from Phil Sutter.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cf6b5ffdce5a78b2fcb0e53b3a2487c490bcbf7f
Author: Phil Sutter <phil@nwl.cc>
Date:   Tue Jun 8 11:40:57 2021 +0200

    netfilter: nft_exthdr: Fix for unsafe packet data read
    
    While iterating through an SCTP packet's chunks, skb_header_pointer() is
    called for the minimum expected chunk header size. If (that part of) the
    skbuff is non-linear, the following memcpy() may read data past
    temporary buffer '_sch'. Use skb_copy_bits() instead which does the
    right thing in this situation.
    
    Fixes: 133dc203d77df ("netfilter: nft_exthdr: Support SCTP chunks")
    Suggested-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Phil Sutter <phil@nwl.cc>
    Reviewed-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit eb9bc1defe4bd151dbeeaaa631b7b49d1da0d75d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 24 22:49:24 2021 -0400

    sctp: add the missing setting for asoc encap_port
    
    commit 297739bd73f6e49d80bac4bfd27f3598b798c0d4 upstream.
    
    This patch is to add the missing setting back for asoc encap_port.
    
    Fixes: 8dba29603b5c ("sctp: add SCTP_REMOTE_UDP_ENCAPS_PORT sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ac7d5d036dc93710971f532ed57f9a6858a2b262
Author: Alexander Aring <aahringo@redhat.com>
Date:   Wed Jun 2 09:45:19 2021 -0400

    fs: dlm: introduce proto values
    
    Currently the dlm protocol values are that TCP is 0 and everything else
    is SCTP. This makes it difficult to introduce possible other transport
    layers. The only one user space tool dlm_controld, which I am aware of,
    handles the protocol value 1 for SCTP. We change it now to handle SCTP
    as 1, this will break user space API but it will fix it so we can add
    possible other transport layers.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 5fe8e519e44fde639f8f4977561f1b68b2ec4960
Merge: 92c35cfd9366 8a1c08ad19b6
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jun 1 17:15:14 2021 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter updates for net-next
    
    The following patchset contains Netfilter updates for net-next:
    
    1) Support for SCTP chunks matching on nf_tables, from Phil Sutter.
    
    2) Skip LDMXCSR, we don't need a valid MXCSR state. From Stefano Brivio.
    
    3) CONFIG_RETPOLINE for nf_tables set lookups, from Florian Westphal.
    
    4) A few Kconfig leading spaces removal, from Juerg Haefliger.
    
    5) Remove spinlock from xt_limit, from Jason Baron.
    
    6) Remove useless initialization in xt_CT, oneliner from Yang Li.
    
    7) Tree-wide replacement of netlink_unicast() by nfnetlink_unicast().
    
    8) Reduce footprint of several structures: xt_action_param,
       nft_pktinfo and nf_hook_state, from Florian.
    
    10) Add nft_thoff() and nft_sk() helpers and use them, also from Florian.
    
    11) Fix documentation in nf_tables pipapo avx2, from Florian Westphal.
    
    12) Fix clang-12 fmt string warnings, also from Florian.
    ====================

commit 133dc203d77dff617d9c4673973ef3859be2c476
Author: Phil Sutter <phil@nwl.cc>
Date:   Tue May 4 17:54:06 2021 +0200

    netfilter: nft_exthdr: Support SCTP chunks
    
    Chunks are SCTP header extensions similar in implementation to IPv6
    extension headers or TCP options. Reusing exthdr expression to find and
    extract field values from them is therefore pretty straightforward.
    
    For now, this supports extracting data from chunks at a fixed offset
    (and length) only - chunks themselves are an extensible data structure;
    in order to make all fields available, a nested extension search is
    needed.
    
    Signed-off-by: Phil Sutter <phil@nwl.cc>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 297739bd73f6e49d80bac4bfd27f3598b798c0d4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 24 22:49:24 2021 -0400

    sctp: add the missing setting for asoc encap_port
    
    This patch is to add the missing setting back for asoc encap_port.
    
    Fixes: 8dba29603b5c ("sctp: add SCTP_REMOTE_UDP_ENCAPS_PORT sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 489d8e559c6596eb08e16447d9830bc39afbe54e
Author: Alexander Aring <aahringo@redhat.com>
Date:   Fri May 21 15:08:46 2021 -0400

    fs: dlm: add reliable connection if reconnect
    
    This patch introduce to make a tcp lowcomms connection reliable even if
    reconnects occurs. This is done by an application layer re-transmission
    handling and sequence numbers in dlm protocols. There are three new dlm
    commands:
    
    DLM_OPTS:
    
    This will encapsulate an existing dlm message (and rcom message if they
    don't have an own application side re-transmission handling). As optional
    handling additional tlv's (type length fields) can be appended. This can
    be for example a sequence number field. However because in DLM_OPTS the
    lockspace field is unused and a sequence number is a mandatory field it
    isn't made as a tlv and we put the sequence number inside the lockspace
    id. The possibility to add optional options are still there for future
    purposes.
    
    DLM_ACK:
    
    Just a dlm header to acknowledge the receive of a DLM_OPTS message to
    it's sender.
    
    DLM_FIN:
    
    This provides a 4 way handshake for connection termination inclusive
    support for half-closed connections. It's provided on application layer
    because SCTP doesn't support half-closed sockets, the shutdown() call
    can interrupted by e.g. TCP resets itself and a hard logic to implement
    it because the othercon paradigm in lowcomms. The 4-way termination
    handshake also solve problems to synchronize peer EOF arrival and that
    the cluster manager removes the peer in the node membership handling of
    DLM. In some cases messages can be still transmitted in this time and we
    need to wait for the node membership event.
    
    To provide a reliable connection the node will retransmit all
    unacknowledges message to it's peer on reconnect. The receiver will then
    filtering out the next received message and drop all messages which are
    duplicates.
    
    As RCOM_STATUS and RCOM_NAMES messages are the first messages which are
    exchanged and they have they own re-transmission handling, there exists
    logic that these messages must be first. If these messages arrives we
    store the dlm version field. This handling is on DLM 3.1 and after this
    patch 3.2 the same. A backwards compatibility handling has been added
    which seems to work on tests without tcpkill, however it's not recommended
    to use DLM 3.1 and 3.2 at the same time, because DLM 3.2 tries to fix long
    term bugs in the DLM protocol.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 8aa31cbf20ad168c35dd83476629402aacbf5a44
Author: Alexander Aring <aahringo@redhat.com>
Date:   Fri May 21 15:08:39 2021 -0400

    fs: dlm: fix connection tcp EOF handling
    
    This patch fixes the EOF handling for TCP that if and EOF is received we
    will close the socket next time the writequeue runs empty. This is a
    half-closed socket functionality which doesn't exists in SCTP. The
    midcomms layer will do a half closed socket functionality on DLM side to
    solve this problem for the SCTP case. However there is still the last ack
    flying around but other reset functionality will take care of it if it got
    lost.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 80ff006023cc5f1430a73063ec4de415d82df424
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2a64aca15c8c7eda1b5d7e2542af2aeba7b030e1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d3104ec7b9e23a23845bf9c4b1f44fcfc3190e7d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit dc9d299c1a189930dc9501458ffcdad84c6ddf96
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0492084fa4c68114ad3dd0e599f85966fc020c21
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 71af6139c067779eb29f4198434cc32f48a494b5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit db5f1c6f776d7f02e490ba2943d388a0b6140949
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7a0a9f5cf8b5e676b17e574bf9028a60b06867d0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fc858a5231089b972076642a86cf62481d95d82e
Merge: dd860052c99b 55bc1af3d911
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat May 8 08:31:46 2021 -0700

    Merge tag 'net-5.13-rc1' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from Jakub Kicinski:
     "Networking fixes for 5.13-rc1, including fixes from bpf, can and
      netfilter trees. Self-contained fixes, nothing risky.
    
      Current release - new code bugs:
    
       - dsa: ksz: fix a few bugs found by static-checker in the new driver
    
       - stmmac: fix frame preemption handshake not triggering after
         interface restart
    
      Previous releases - regressions:
    
       - make nla_strcmp handle more then one trailing null character
    
       - fix stack OOB reads while fragmenting IPv4 packets in openvswitch
         and net/sched
    
       - sctp: do asoc update earlier in sctp_sf_do_dupcook_a
    
       - sctp: delay auto_asconf init until binding the first addr
    
       - stmmac: clear receive all(RA) bit when promiscuous mode is off
    
       - can: mcp251x: fix resume from sleep before interface was brought up
    
      Previous releases - always broken:
    
       - bpf: fix leakage of uninitialized bpf stack under speculation
    
       - bpf: fix masking negation logic upon negative dst register
    
       - netfilter: don't assume that skb_header_pointer() will never fail
    
       - only allow init netns to set default tcp cong to a restricted algo
    
       - xsk: fix xp_aligned_validate_desc() when len == chunk_size to avoid
         false positive errors
    
       - ethtool: fix missing NLM_F_MULTI flag when dumping
    
       - can: m_can: m_can_tx_work_queue(): fix tx_skb race condition
    
       - sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
       - bridge: fix NULL-deref caused by a races between assigning
         rx_handler_data and setting the IFF_BRIDGE_PORT bit
    
      Latecomer:
    
       - seg6: add counters support for SRv6 Behaviors"
    
    * tag 'net-5.13-rc1' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (73 commits)
      atm: firestream: Use fallthrough pseudo-keyword
      net: stmmac: Do not enable RX FIFO overflow interrupts
      mptcp: fix splat when closing unaccepted socket
      i40e: Remove LLDP frame filters
      i40e: Fix PHY type identifiers for 2.5G and 5G adapters
      i40e: fix the restart auto-negotiation after FEC modified
      i40e: Fix use-after-free in i40e_client_subtask()
      i40e: fix broken XDP support
      netfilter: nftables: avoid potential overflows on 32bit arches
      netfilter: nftables: avoid overflows in nft_hash_buckets()
      tcp: Specify cmsgbuf is user pointer for receive zerocopy.
      mlxsw: spectrum_mr: Update egress RIF list before route's action
      net: ipa: fix inter-EE IRQ register definitions
      can: m_can: m_can_tx_work_queue(): fix tx_skb race condition
      can: mcp251x: fix resume from sleep before interface was brought up
      can: mcp251xfd: mcp251xfd_probe(): add missing can_rx_offload_del() in error path
      can: mcp251xfd: mcp251xfd_probe(): fix an error pointer dereference in probe
      netfilter: nftables: Fix a memleak from userdata error path in new objects
      netfilter: remove BUG_ON() after skb_header_pointer()
      netfilter: nfnetlink_osf: Fix a missing skb_header_pointer() NULL check
      ...

commit f282df0391267fb2b263da1cc3233aa6fb81defc
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 51eac7f2f06b5f60d22dfb06c48d98a227507b8e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat May 1 04:03:00 2021 +0800

    sctp: do asoc update earlier in sctp_sf_do_dupcook_b
    
    The same thing should be done for sctp_sf_do_dupcook_b().
    Meanwhile, SCTP_CMD_UPDATE_ASSOC cmd can be removed.
    
    v1->v2:
      - Fix the return value in sctp_sf_do_assoc_update().
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9904e1ee962b338a68ff4db647cb6218a087472a
Merge: 3197a98c7081 e41985f0fe8b
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Apr 22 13:57:21 2021 -0700

    Merge branch '100GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/tnguy/next-queue
    
    Tony Nguyen says:
    
    ====================
    100GbE Intel Wired LAN Driver Updates 2021-04-22
    
    This series contains updates to virtchnl header file, ice, and iavf
    drivers.
    
    Vignesh adds support to warn about potentially malicious VFs; those that
    are overflowing the mailbox for the ice driver.
    
    Michal adds support for an allowlist/denylist of VF commands based on
    supported capabilities for the ice driver.
    
    Brett adds support for iavf UDP segmentation offload by adding the
    capability bit to virtchnl, advertising support in the ice driver, and
    enabling it in the iavf driver. He also adds a helper function for
    getting the VF VSI for ice.
    
    Colin Ian King removes an unneeded pointer assignment.
    
    Qi enables support in the ice driver to support virtchnl requests from
    the iavf to configure its own RSS input set. This includes adding new
    capability bits, structures, and commands to virtchnl header file.
    
    Haiyue enables configuring RSS flow hash via ethtool to support TCP, UDP
    and SCTP protocols in iavf.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e41985f0fe8b68d1ac321bd4eda460fb553e65ad
Author: Haiyue Wang <haiyue.wang@intel.com>
Date:   Tue Apr 13 08:48:44 2021 +0800

    iavf: Support for modifying SCTP RSS flow hashing
    
    Provide the ability to enable SCTP RSS hashing by ethtool.
    
    It gives users option of generating RSS hash based on the SCTP source
    and destination ports numbers, IPv4 or IPv6 source and destination
    addresses.
    
    Signed-off-by: Haiyue Wang <haiyue.wang@intel.com>
    Tested-by: Konrad Jankowski <konrad0.jankowski@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>

commit 7ccd73a4446b941a7fc09101b898f58d5e2b1186
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Mar 19 15:35:07 2021 +0800

    esp: delete NETIF_F_SCTP_CRC bit from features for esp offload
    
    [ Upstream commit 154deab6a3ba47792936edf77f2f13a1cbc4351d ]
    
    Now in esp4/6_gso_segment(), before calling inner proto .gso_segment,
    NETIF_F_CSUM_MASK bits are deleted, as HW won't be able to do the
    csum for inner proto due to the packet encrypted already.
    
    So the UDP/TCP packet has to do the checksum on its own .gso_segment.
    But SCTP is using CRC checksum, and for that NETIF_F_SCTP_CRC should
    be deleted to make SCTP do the csum in own .gso_segment as well.
    
    In Xiumei's testing with SCTP over IPsec/veth, the packets are kept
    dropping due to the wrong CRC checksum.
    
    Reported-by: Xiumei Mu <xmu@redhat.com>
    Fixes: 7862b4058b9f ("esp: Add gso handlers for esp4 and esp6")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ef4ddd1d6d9376072d8cbd4e3d51cbcaf20567c5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Mar 19 15:35:07 2021 +0800

    esp: delete NETIF_F_SCTP_CRC bit from features for esp offload
    
    [ Upstream commit 154deab6a3ba47792936edf77f2f13a1cbc4351d ]
    
    Now in esp4/6_gso_segment(), before calling inner proto .gso_segment,
    NETIF_F_CSUM_MASK bits are deleted, as HW won't be able to do the
    csum for inner proto due to the packet encrypted already.
    
    So the UDP/TCP packet has to do the checksum on its own .gso_segment.
    But SCTP is using CRC checksum, and for that NETIF_F_SCTP_CRC should
    be deleted to make SCTP do the csum in own .gso_segment as well.
    
    In Xiumei's testing with SCTP over IPsec/veth, the packets are kept
    dropping due to the wrong CRC checksum.
    
    Reported-by: Xiumei Mu <xmu@redhat.com>
    Fixes: 7862b4058b9f ("esp: Add gso handlers for esp4 and esp6")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 540ddeed5c513f0a40159bd370dd97927529ec6f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Mar 19 15:35:07 2021 +0800

    esp: delete NETIF_F_SCTP_CRC bit from features for esp offload
    
    [ Upstream commit 154deab6a3ba47792936edf77f2f13a1cbc4351d ]
    
    Now in esp4/6_gso_segment(), before calling inner proto .gso_segment,
    NETIF_F_CSUM_MASK bits are deleted, as HW won't be able to do the
    csum for inner proto due to the packet encrypted already.
    
    So the UDP/TCP packet has to do the checksum on its own .gso_segment.
    But SCTP is using CRC checksum, and for that NETIF_F_SCTP_CRC should
    be deleted to make SCTP do the csum in own .gso_segment as well.
    
    In Xiumei's testing with SCTP over IPsec/veth, the packets are kept
    dropping due to the wrong CRC checksum.
    
    Reported-by: Xiumei Mu <xmu@redhat.com>
    Fixes: 7862b4058b9f ("esp: Add gso handlers for esp4 and esp6")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4e04e7513b0fa2fe8966a1c83fb473f1667e2810
Merge: 3b9784350f99 27f0ad71699d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 9 15:26:51 2021 -0700

    Merge tag 'net-5.12-rc7' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from Jakub Kicinski:
     "Networking fixes for 5.12-rc7, including fixes from can, ipsec,
      mac80211, wireless, and bpf trees.
    
      No scary regressions here or in the works, but small fixes for 5.12
      changes keep coming.
    
      Current release - regressions:
    
       - virtio: do not pull payload in skb->head
    
       - virtio: ensure mac header is set in virtio_net_hdr_to_skb()
    
       - Revert "net: correct sk_acceptq_is_full()"
    
       - mptcp: revert "mptcp: provide subflow aware release function"
    
       - ethernet: lan743x: fix ethernet frame cutoff issue
    
       - dsa: fix type was not set for devlink port
    
       - ethtool: remove link_mode param and derive link params from driver
    
       - sched: htb: fix null pointer dereference on a null new_q
    
       - wireless: iwlwifi: Fix softirq/hardirq disabling in
         iwl_pcie_enqueue_hcmd()
    
       - wireless: iwlwifi: fw: fix notification wait locking
    
       - wireless: brcmfmac: p2p: Fix deadlock introduced by avoiding the
         rtnl dependency
    
      Current release - new code bugs:
    
       - napi: fix hangup on napi_disable for threaded napi
    
       - bpf: take module reference for trampoline in module
    
       - wireless: mt76: mt7921: fix airtime reporting and related tx hangs
    
       - wireless: iwlwifi: mvm: rfi: don't lock mvm->mutex when sending
         config command
    
      Previous releases - regressions:
    
       - rfkill: revert back to old userspace API by default
    
       - nfc: fix infinite loop, refcount & memory leaks in LLCP sockets
    
       - let skb_orphan_partial wake-up waiters
    
       - xfrm/compat: Cleanup WARN()s that can be user-triggered
    
       - vxlan, geneve: do not modify the shared tunnel info when PMTU
         triggers an ICMP reply
    
       - can: fix msg_namelen values depending on CAN_REQUIRED_SIZE
    
       - can: uapi: mark union inside struct can_frame packed
    
       - sched: cls: fix action overwrite reference counting
    
       - sched: cls: fix err handler in tcf_action_init()
    
       - ethernet: mlxsw: fix ECN marking in tunnel decapsulation
    
       - ethernet: nfp: Fix a use after free in nfp_bpf_ctrl_msg_rx
    
       - ethernet: i40e: fix receiving of single packets in xsk zero-copy
         mode
    
       - ethernet: cxgb4: avoid collecting SGE_QBASE regs during traffic
    
      Previous releases - always broken:
    
       - bpf: Refuse non-O_RDWR flags in BPF_OBJ_GET
    
       - bpf: Refcount task stack in bpf_get_task_stack
    
       - bpf, x86: Validate computation of branch displacements
    
       - ieee802154: fix many similar syzbot-found bugs
           - fix NULL dereferences in netlink attribute handling
           - reject unsupported operations on monitor interfaces
           - fix error handling in llsec_key_alloc()
    
       - xfrm: make ipv4 pmtu check honor ip header df
    
       - xfrm: make hash generation lock per network namespace
    
       - xfrm: esp: delete NETIF_F_SCTP_CRC bit from features for esp
         offload
    
       - ethtool: fix incorrect datatype in set_eee ops
    
       - xdp: fix xdp_return_frame() kernel BUG throw for page_pool memory
         model
    
       - openvswitch: fix send of uninitialized stack memory in ct limit
         reply
    
      Misc:
    
       - udp: add get handling for UDP_GRO sockopt"
    
    * tag 'net-5.12-rc7' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (182 commits)
      net: fix hangup on napi_disable for threaded napi
      net: hns3: Trivial spell fix in hns3 driver
      lan743x: fix ethernet frame cutoff issue
      net: ipv6: check for validity before dereferencing cfg->fc_nlinfo.nlh
      net: dsa: lantiq_gswip: Configure all remaining GSWIP_MII_CFG bits
      net: dsa: lantiq_gswip: Don't use PHY auto polling
      net: sched: sch_teql: fix null-pointer dereference
      ipv6: report errors for iftoken via netlink extack
      net: sched: fix err handler in tcf_action_init()
      net: sched: fix action overwrite reference counting
      Revert "net: sched: bump refcount for new action in ACT replace mode"
      ice: fix memory leak of aRFS after resuming from suspend
      i40e: Fix sparse warning: missing error code 'err'
      i40e: Fix sparse error: 'vsi->netdev' could be null
      i40e: Fix sparse error: uninitialized symbol 'ring'
      i40e: Fix sparse errors in i40e_txrx.c
      i40e: Fix parameters in aq_get_phy_register()
      nl80211: fix beacon head validation
      bpf, x86: Validate computation of branch displacements for x86-32
      bpf, x86: Validate computation of branch displacements for x86-64
      ...

commit 154deab6a3ba47792936edf77f2f13a1cbc4351d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Mar 19 15:35:07 2021 +0800

    esp: delete NETIF_F_SCTP_CRC bit from features for esp offload
    
    Now in esp4/6_gso_segment(), before calling inner proto .gso_segment,
    NETIF_F_CSUM_MASK bits are deleted, as HW won't be able to do the
    csum for inner proto due to the packet encrypted already.
    
    So the UDP/TCP packet has to do the checksum on its own .gso_segment.
    But SCTP is using CRC checksum, and for that NETIF_F_SCTP_CRC should
    be deleted to make SCTP do the csum in own .gso_segment as well.
    
    In Xiumei's testing with SCTP over IPsec/veth, the packets are kept
    dropping due to the wrong CRC checksum.
    
    Reported-by: Xiumei Mu <xmu@redhat.com>
    Fixes: 7862b4058b9f ("esp: Add gso handlers for esp4 and esp6")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>

commit efca91e89b67a6f824aca6abcd8a2e5188aa061c
Author: Przemyslaw Patynowski <przemyslawx.patynowski@intel.com>
Date:   Fri Dec 18 10:36:19 2020 +0000

    i40e: Add flow director support for IPv6
    
    Flow director for IPv6 is not supported.
    1) Implementation of support for IPv6 flow director.
    2) Added handlers for addition of TCP6, UDP6, SCTP6, IPv6.
    3) Refactored legacy code to make it more generic.
    4) Added packet templates for TCP6, UDP6, SCTP6, IPv6.
    5) Added handling of IPv6 source and destination address for flow director.
    6) Improved argument passing for source and destination portin TCP6, UDP6
       and SCTP6.
    7) Added handling of ethtool -n for IPv6, TCP6,UDP6, SCTP6.
    8) Used correct bit flag regarding FLEXOFF field of flow director data
       descriptor.
    
    Without this patch, there would be no support for flow director on IPv6,
    TCP6, UDP6, SCTP6.
    Tested based on x710 datasheet by using:
    ethtool -N enp133s0f0 flow-type tcp4 src-port 13 dst-port 37 user-def 0x44142 action 1
    ethtool -N enp133s0f0 flow-type tcp6 src-port 13 dst-port 40 user-def 0x44142 action 2
    ethtool -N enp133s0f0 flow-type udp4 src-port 20 dst-port 40 user-def 0x44142 action 3
    ethtool -N enp133s0f0 flow-type udp6 src-port 25 dst-port 40 user-def 0x44142 action 4
    ethtool -N enp133s0f0 flow-type sctp4 src-port 55 dst-port 65 user-def 0x44142 action 5
    ethtool -N enp133s0f0 flow-type sctp6 src-port 60 dst-port 40 user-def 0x44142 action 6
    ethtool -N enp133s0f0 flow-type ip4 src-ip 1.1.1.1 dst-ip 1.1.1.4 user-def 0x44142 action 7
    ethtool -N enp133s0f0 flow-type ip6 src-ip fe80::3efd:feff:fe6f:bbbb dst-ip fe80::3efd:feff:fe6f:aaaa user-def 0x44142 action 8
    Then send traffic from client which matches the criteria provided to ethtool.
    Observe that packets are redirected to user set queues with ethtool -S <interface>
    
    Signed-off-by: Przemyslaw Patynowski <przemyslawx.patynowski@intel.com>
    Tested-by: Tony Brelinski <tonyx.brelinski@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>

commit efa1a65c7e1946ff174c56d36bf015ff9e11c4a1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jan 28 17:18:32 2021 +0800

    ip_gre: add csum offload support for gre header
    
    This patch is to add csum offload support for gre header:
    
    On the TX path in gre_build_header(), when CHECKSUM_PARTIAL's set
    for inner proto, it will calculate the csum for outer proto, and
    inner csum will be offloaded later. Otherwise, CHECKSUM_PARTIAL
    and csum_start/offset will be set for outer proto, and the outer
    csum will be offloaded later.
    
    On the GSO path in gre_gso_segment(), when CHECKSUM_PARTIAL is
    not set for inner proto and the hardware supports csum offload,
    CHECKSUM_PARTIAL and csum_start/offset will be set for outer
    proto, and outer csum will be offloaded later. Otherwise, it
    will do csum for outer proto by calling gso_make_checksum().
    
    Note that SCTP has to do the csum by itself for non GSO path in
    sctp_packet_pack(), as gre_build_header() can't handle the csum
    with CHECKSUM_PARTIAL set for SCTP CRC csum offload.
    
    v1->v2:
      - remove the SCTP part, as GRE dev doesn't support SCTP CRC CSUM
        and it will always do checksum for SCTP in sctp_packet_pack()
        when it's not a GSO packet.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 55bac51762c39ef033b488dd09b60d48908d317f
Author: Daniel Borkmann <daniel@iogearbox.net>
Date:   Fri Jan 22 01:08:31 2021 +0100

    net, sctp, filter: remap copy_from_user failure error
    
    [ no upstream commit ]
    
    Fix a potential kernel address leakage for the prerequisite where there is
    a BPF program attached to the cgroup/setsockopt hook. The latter can only
    be attached under root, however, if the attached program returns 1 to then
    run the related kernel handler, an unprivileged program could probe for
    kernel addresses that way. The reason this is possible is that we're under
    set_fs(KERNEL_DS) when running the kernel setsockopt handler. Aside from
    old cBPF there is also SCTP's struct sctp_getaddrs_old which contains
    pointers in the uapi struct that further need copy_from_user() inside the
    handler. In the normal case this would just return -EFAULT, but under a
    temporary KERNEL_DS setting the memory would be copied and we'd end up at
    a different error code, that is, -EINVAL, for both cases given subsequent
    validations fail, which then allows the app to distinguish and make use of
    this fact for probing the address space. In case of later kernel versions
    this issue won't work anymore thanks to Christoph Hellwig's work that got
    rid of the various temporary set_fs() address space overrides altogether.
    One potential option for 5.4 as the only affected stable kernel with the
    least complexity would be to remap those affected -EFAULT copy_from_user()
    error codes with -EINVAL such that they cannot be probed anymore. Risk of
    breakage should be rather low for this particular error case.
    
    Fixes: 0d01da6afc54 ("bpf: implement getsockopt and setsockopt hooks")
    Reported-by: Ryota Shiga (Flatt Security)
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Stanislav Fomichev <sdf@google.com>
    Cc: Eric Dumazet <edumazet@google.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1a2367665ac2a1a7ad2119e4175287b66c2f09be
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 12:44:11 2021 +0800

    ip_gre: remove CRC flag from dev features in gre_gso_segment
    
    This patch is to let it always do CRC checksum in sctp_gso_segment()
    by removing CRC flag from the dev features in gre_gso_segment() for
    SCTP over GRE, just as it does in Commit 527beb8ef9c0 ("udp: support
    sctp over udp in skb_udp_tunnel_segment") for SCTP over UDP.
    
    It could set csum/csum_start in GSO CB properly in sctp_gso_segment()
    after that commit, so it would do checksum with gso_make_checksum()
    in gre_gso_segment(), and Commit 622e32b7d4a6 ("net: gre: recompute
    gre csum for sctp over gre tunnels") can be reverted now.
    
    Note that when need_csum is false, we can still leave CRC checksum
    of SCTP to HW by not clearing this CRC flag if it's supported, as
    Jakub and Alex noticed.
    
    v1->v2:
      - improve the changelog.
      - fix "rev xmas tree" in varibles declaration.
    v2->v3:
      - remove CRC flag from dev features only when need_csum is true.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/00439f24d5f69e2c6fa2beadc681d056c15c258f.1610772251.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 4eb5d4a5b4d64bb9495141b2f323caf7524ef8a6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 13:59:17 2021 +0800

    udp: not remove the CRC flag from dev features when need_csum is false
    
    In __skb_udp_tunnel_segment(), when it's a SCTP over VxLAN/GENEVE
    packet and need_csum is false, which means the outer udp checksum
    doesn't need to be computed, csum_start and csum_offset could be
    used by the inner SCTP CRC CSUM for SCTP HW CRC offload.
    
    So this patch is to not remove the CRC flag from dev features when
    need_csum is false.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Link: https://lore.kernel.org/r/1e81b700642498546eaa3f298e023fd7ad394f85.1610776757.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 9f23de418f7e999cc48be915c514db9c54166c0e
Merge: 7eab14de73a8 fc186d0a4ef8
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Tue Jan 19 14:31:28 2021 -0800

    Merge branch 'net-support-sctp-crc-csum-offload-for-tunneling-packets-in-some-drivers'
    
    Xin Long says:
    
    ====================
    net: support SCTP CRC csum offload for tunneling packets in some drivers
    
    This patchset introduces inline function skb_csum_is_sctp(), and uses it
    to validate it's a sctp CRC csum offload packet, to make SCTP CRC csum
    offload for tunneling packets supported in some HW drivers.
    ====================
    
    Link: https://lore.kernel.org/r/cover.1610777159.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit fc186d0a4ef8cc493a04895e620c7d55052a9d93
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:42 2021 +0800

    net: ixgbevf: use skb_csum_is_sctp instead of protocol check
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP CRC
    checksum offload packet, and yet it also makes ixgbevf support SCTP
    CRC checksum offload for UDP and GRE encapped packets, just as it
    does in igb driver.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit f8c4b01d3a680de2144dd274df03ffaf69cfb881
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:41 2021 +0800

    net: ixgbe: use skb_csum_is_sctp instead of protocol check
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP CRC
    checksum offload packet, and yet it also makes ixgbe support SCTP
    CRC checksum offload for UDP and GRE encapped packets, just as it
    does in igb driver.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 609d29a9d2429a840a2f1f44e77b71d58e3e9a33
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:40 2021 +0800

    net: igc: use skb_csum_is_sctp instead of protocol check
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP CRC
    checksum offload packet, and yet it also makes igc support SCTP
    CRC checksum offload for UDP and GRE encapped packets, just as it
    does in igb driver.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit d2de44443cafa16f6c8c6e724632d57097991f55
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:39 2021 +0800

    net: igbvf: use skb_csum_is_sctp instead of protocol check
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP CRC
    checksum offload packet, and yet it also makes igbvf support SCTP
    CRC checksum offload for UDP and GRE encapped packets, just as it
    does in igb driver.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 8bcf02035bd5ab5f22110d16a1aaee1794aa8d3c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:38 2021 +0800

    net: igb: use skb_csum_is_sctp instead of protocol check
    
    Using skb_csum_is_sctp is a easier way to validate it's a SCTP
    CRC checksum offload packet, and there is no need to parse the
    packet to check its proto field, especially when it's a UDP or
    GRE encapped packet.
    
    So this patch also makes igb support SCTP CRC checksum offload
    for UDP and GRE encapped packets.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit fa82117010430aff2ce86400f7328f55a31b48a6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 16 14:13:37 2021 +0800

    net: add inline function skb_csum_is_sctp
    
    This patch is to define a inline function skb_csum_is_sctp(), and
    also replace all places where it checks if it's a SCTP CSUM skb.
    This function would be used later in many networking drivers in
    the following patches.
    
    Suggested-by: Alexander Duyck <alexander.duyck@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Alexander Duyck <alexanderduyck@fb.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit c080559a71539f8e7525e271f52a14f3cb50695c
Merge: 505e3f00c3f3 3224dcfd850f
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Mon Jan 18 19:57:04 2021 -0800

    Merge branch 'net-make-udp-tunnel-devices-support-fraglist'
    
    Xin Long says:
    
    ====================
    net: make udp tunnel devices support fraglist
    
    Like GRE device, UDP tunnel devices should also support fraglist, so
    that some protocol (like SCTP) HW GSO that requires NETIF_F_FRAGLIST
    in the dev can work. Especially when the lower device support both
    NETIF_F_GSO_UDP_TUNNEL and NETIF_F_GSO_SCTP.
    ====================
    
    Link: https://lore.kernel.org/r/cover.1610704037.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 18423e1a9d7d72c84f04e7f5fa31070855966ea7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jan 15 17:47:46 2021 +0800

    geneve: add NETIF_F_FRAGLIST flag for dev features
    
    Some protocol HW GSO requires fraglist supported by the device, like
    SCTP. Without NETIF_F_FRAGLIST set in the dev features of geneve, it
    would have to do SW GSO before the packets enter the driver, even
    when the geneve dev and lower dev (like veth) both have the feature
    of NETIF_F_GSO_SCTP.
    
    So this patch is to add it for geneve.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit cb2c57112432d5c77f97ea6320973d02beebf3ee
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jan 15 17:47:45 2021 +0800

    vxlan: add NETIF_F_FRAGLIST flag for dev features
    
    Some protocol HW GSO requires fraglist supported by the device, like
    SCTP. Without NETIF_F_FRAGLIST set in the dev features of vxlan, it
    would have to do SW GSO before the packets enter the driver, even
    when the vxlan dev and lower dev (like veth) both have the feature
    of NETIF_F_GSO_SCTP.
    
    So this patch is to add it for vxlan.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 1fef8544bf41fb77d6603feb9a31cd76b4578489
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jan 15 17:36:39 2021 +0800

    sctp: remove the NETIF_F_SG flag before calling skb_segment
    
    It makes more sense to clear NETIF_F_SG instead of set it when
    calling skb_segment() in sctp_gso_segment(), since SCTP GSO is
    using head_skb's fraglist, of which all frags are linear skbs.
    
    This will make SCTP GSO code more understandable.
    
    Suggested-by: Alexander Duyck <alexander.duyck@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit d635a69dd4981cc51f90293f5f64268620ed1565
Merge: ac73e3dc8acd efd5a1584537
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Dec 15 13:22:29 2020 -0800

    Merge tag 'net-next-5.11' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next
    
    Pull networking updates from Jakub Kicinski:
     "Core:
    
       - support "prefer busy polling" NAPI operation mode, where we defer
         softirq for some time expecting applications to periodically busy
         poll
    
       - AF_XDP: improve efficiency by more batching and hindering the
         adjacency cache prefetcher
    
       - af_packet: make packet_fanout.arr size configurable up to 64K
    
       - tcp: optimize TCP zero copy receive in presence of partial or
         unaligned reads making zero copy a performance win for much smaller
         messages
    
       - XDP: add bulk APIs for returning / freeing frames
    
       - sched: support fragmenting IP packets as they come out of conntrack
    
       - net: allow virtual netdevs to forward UDP L4 and fraglist GSO skbs
    
      BPF:
    
       - BPF switch from crude rlimit-based to memcg-based memory accounting
    
       - BPF type format information for kernel modules and related tracing
         enhancements
    
       - BPF implement task local storage for BPF LSM
    
       - allow the FENTRY/FEXIT/RAW_TP tracing programs to use
         bpf_sk_storage
    
      Protocols:
    
       - mptcp: improve multiple xmit streams support, memory accounting and
         many smaller improvements
    
       - TLS: support CHACHA20-POLY1305 cipher
    
       - seg6: add support for SRv6 End.DT4/DT6 behavior
    
       - sctp: Implement RFC 6951: UDP Encapsulation of SCTP
    
       - ppp_generic: add ability to bridge channels directly
    
       - bridge: Connectivity Fault Management (CFM) support as is defined
         in IEEE 802.1Q section 12.14.
    
      Drivers:
    
       - mlx5: make use of the new auxiliary bus to organize the driver
         internals
    
       - mlx5: more accurate port TX timestamping support
    
       - mlxsw:
          - improve the efficiency of offloaded next hop updates by using
            the new nexthop object API
          - support blackhole nexthops
          - support IEEE 802.1ad (Q-in-Q) bridging
    
       - rtw88: major bluetooth co-existance improvements
    
       - iwlwifi: support new 6 GHz frequency band
    
       - ath11k: Fast Initial Link Setup (FILS)
    
       - mt7915: dual band concurrent (DBDC) support
    
       - net: ipa: add basic support for IPA v4.5
    
      Refactor:
    
       - a few pieces of in_interrupt() cleanup work from Sebastian Andrzej
         Siewior
    
       - phy: add support for shared interrupts; get rid of multiple driver
         APIs and have the drivers write a full IRQ handler, slight growth
         of driver code should be compensated by the simpler API which also
         allows shared IRQs
    
       - add common code for handling netdev per-cpu counters
    
       - move TX packet re-allocation from Ethernet switch tag drivers to a
         central place
    
       - improve efficiency and rename nla_strlcpy
    
       - number of W=1 warning cleanups as we now catch those in a patchwork
         build bot
    
      Old code removal:
    
       - wan: delete the DLCI / SDLA drivers
    
       - wimax: move to staging
    
       - wifi: remove old WDS wifi bridging support"
    
    * tag 'net-next-5.11' of git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next: (1922 commits)
      net: hns3: fix expression that is currently always true
      net: fix proc_fs init handling in af_packet and tls
      nfc: pn533: convert comma to semicolon
      af_vsock: Assign the vsock transport considering the vsock address flags
      af_vsock: Set VMADDR_FLAG_TO_HOST flag on the receive path
      vsock_addr: Check for supported flag values
      vm_sockets: Add VMADDR_FLAG_TO_HOST vsock flag
      vm_sockets: Add flags field in the vsock address data structure
      net: Disable NETIF_F_HW_TLS_TX when HW_CSUM is disabled
      tcp: Add logic to check for SYN w/ data in tcp_simple_retransmit
      net: mscc: ocelot: install MAC addresses in .ndo_set_rx_mode from process context
      nfc: s3fwrn5: Release the nfc firmware
      net: vxget: clean up sparse warnings
      mlxsw: spectrum_router: Use eXtended mezzanine to offload IPv4 router
      mlxsw: spectrum: Set KVH XLT cache mode for Spectrum2/3
      mlxsw: spectrum_router_xm: Introduce basic XM cache flushing
      mlxsw: reg: Add Router LPM Cache Enable Register
      mlxsw: reg: Add Router LPM Cache ML Delete Register
      mlxsw: spectrum_router_xm: Implement L-value tracking for M-index
      mlxsw: reg: Add XM Router M Table Register
      ...

commit 19633c7e204b99fe9b952c70b712778b24a8d137
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Nov 2 20:04:20 2020 -0500

    fs: dlm: handle non blocked connect event
    
    The manpage of connect shows that in non blocked mode a writeability
    indicates successful connection event. This patch is handling this event
    inside the writeability callback. In case of SCTP we use blocking
    connect functionality which indicates a successful connect when the
    function returns with a successful return value.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 0356010d825eb18d9157408e8ca4ec4613d61398
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Nov 4 14:55:32 2020 +0800

    sctp: bring inet(6)_skb_parm back to sctp_input_cb
    
    inet(6)_skb_parm was removed from sctp_input_cb by Commit a1dd2cf2f1ae
    ("sctp: allow changing transport encap_port by peer packets"), as it
    thought sctp_input_cb->header is not used any more in SCTP.
    
    syzbot reported a crash:
    
      [ ] BUG: KASAN: use-after-free in decode_session6+0xe7c/0x1580
      [ ]
      [ ] Call Trace:
      [ ]  <IRQ>
      [ ]  dump_stack+0x107/0x163
      [ ]  kasan_report.cold+0x1f/0x37
      [ ]  decode_session6+0xe7c/0x1580
      [ ]  __xfrm_policy_check+0x2fa/0x2850
      [ ]  sctp_rcv+0x12b0/0x2e30
      [ ]  sctp6_rcv+0x22/0x40
      [ ]  ip6_protocol_deliver_rcu+0x2e8/0x1680
      [ ]  ip6_input_finish+0x7f/0x160
      [ ]  ip6_input+0x9c/0xd0
      [ ]  ipv6_rcv+0x28e/0x3c0
    
    It was caused by sctp_input_cb->header/IP6CB(skb) still used in sctp rx
    path decode_session6() but some members overwritten by sctp6_rcv().
    
    This patch is to fix it by bring inet(6)_skb_parm back to sctp_input_cb
    and not overwriting it in sctp4/6_rcv() and sctp_udp_rcv().
    
    Reported-by: syzbot+5be8aebb1b7dfa90ef31@syzkaller.appspotmail.com
    Fixes: a1dd2cf2f1ae ("sctp: allow changing transport encap_port by peer packets")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Link: https://lore.kernel.org/r/136c1a7a419341487c504be6d1996928d9d16e02.1604472932.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit be25f43aed73475f2d23b89cc755c2594644d47e
Merge: 1fb74191988f 046c052b475e
Author: Jakub Kicinski <kuba@kernel.org>
Date:   Fri Oct 30 15:24:54 2020 -0700

    Merge branch 'sctp-implement-rfc6951-udp-encapsulation-of-sctp'
    
    Xin Long says:
    
    ====================
    sctp: Implement RFC6951: UDP Encapsulation of SCTP
    
    Description From the RFC:
    
       The Main Reasons:
    
       o  To allow SCTP traffic to pass through legacy NATs, which do not
          provide native SCTP support as specified in [BEHAVE] and
          [NATSUPP].
    
       o  To allow SCTP to be implemented on hosts that do not provide
          direct access to the IP layer.  In particular, applications can
          use their own SCTP implementation if the operating system does not
          provide one.
    
       Implementation Notes:
    
       UDP-encapsulated SCTP is normally communicated between SCTP stacks
       using the IANA-assigned UDP port number 9899 (sctp-tunneling) on both
       ends.  There are circumstances where other ports may be used on
       either end, and it might be required to use ports other than the
       registered port.
    
       Each SCTP stack uses a single local UDP encapsulation port number as
       the destination port for all its incoming SCTP packets, this greatly
       simplifies implementation design.
    
       An SCTP implementation supporting UDP encapsulation MUST maintain a
       remote UDP encapsulation port number per destination address for each
       SCTP association.  Again, because the remote stack may be using ports
       other than the well-known port, each port may be different from each
       stack.  However, because of remapping of ports by NATs, the remote
       ports associated with different remote IP addresses may not be
       identical, even if they are associated with the same stack.
    
       Because the well-known port might not be used, implementations need
       to allow other port numbers to be specified as a local or remote UDP
       encapsulation port number through APIs.
    
    Patches:
    
       This patchset is using the udp4/6 tunnel APIs to implement the UDP
       Encapsulation of SCTP with not much change in SCTP protocol stack
       and with all current SCTP features keeped in Linux Kernel.
    
       1 - 4: Fix some UDP issues that may be triggered by SCTP over UDP.
       5 - 7: Process incoming UDP encapsulated packets and ICMP packets.
       8 -10: Remote encap port's update by sysctl, sockopt and packets.
       11-14: Process outgoing pakects with UDP encapsulated and its GSO.
       15-16: Add the part from draft-tuexen-tsvwg-sctp-udp-encaps-cons-03.
          17: Enable this feature.
    
    Tests:
    
      - lksctp-tools/src/func_tests with UDP Encapsulation enabled/disabled:
    
          Both make v4test and v6test passed.
    
      - sctp-tests with UDP Encapsulation enabled/disabled:
    
          repeatability/procdumps/sctpdiag/gsomtuchange/extoverflow/
          sctphashtable passed. Others failed as expected due to those
          "iptables -p sctp" rules.
    
      - netperf on lo/netns/virtio_net, with gso enabled/disabled and
        with ip_checksum enabled/disabled, with UDP Encapsulation
        enabled/disabled:
    
          No clear performance dropped.
    
    v1->v2:
      - Fix some incorrect code in the patches 5,6,8,10,11,13,14,17, suggested
        by Marcelo.
      - Append two patches 15-16 to add the Additional Considerations for UDP
        Encapsulation of SCTP from draft-tuexen-tsvwg-sctp-udp-encaps-cons-03.
    v2->v3:
      - remove the cleanup code in patch 2, suggested by Willem.
      - remove the patch 3 and fix the checksum in the new patch 3 after
        talking with Paolo, Marcelo and Guillaume.
      - add 'select NET_UDP_TUNNEL' in patch 4 to solve a compiling error.
      - fix __be16 type cast warning in patch 8.
      - fix the wrong endian orders when setting values in 14,16.
    v3->v4:
      - add entries in ip-sysctl.rst in patch 7,16, as Marcelo Suggested.
      - not create udp socks when udp_port is set to 0 in patch 16, as
        Marcelo noticed.
    v4->v5:
      - improve the description for udp_port and encap_port entries in patch
        7, 16.
      - use 0 as the default udp_port.
    ====================
    
    Link: https://lore.kernel.org/r/cover.1603955040.git.lucien.xin@gmail.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 600af7fd809ad2a307b6c53b2a3e45453a75cdb6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:05:06 2020 +0800

    sctp: support for sending packet over udp4 sock
    
    This patch does what the rfc6951#section-5.3 says for ipv4:
    
      "Within the UDP header, the source port MUST be the local UDP
       encapsulation port number of the SCTP stack, and the destination port
       MUST be the remote UDP encapsulation port number maintained for the
       association and the destination address to which the packet is sent
       (see Section 5.1).
    
       Because the SCTP packet is the UDP payload, the length of the UDP
       packet MUST be the length of the SCTP packet plus the size of the UDP
       header.
    
       The SCTP checksum MUST be computed for IPv4 and IPv6, and the UDP
       checksum SHOULD be computed for IPv4 and IPv6."
    
    Some places need to be adjusted in sctp_packet_transmit():
    
      1. For non-gso packets, when transport's encap_port is set, sctp
         checksum has to be done in sctp_packet_pack(), as the outer
         udp will use ip_summed = CHECKSUM_PARTIAL to do the offload
         setting for checksum.
    
      2. Delay calling dst_clone() and skb_dst_set() for non-udp packets
         until sctp_v4_xmit(), as for udp packets, skb_dst_set() is not
         needed before calling udp_tunnel_xmit_skb().
    
    then in sctp_v4_xmit():
    
      1. Go to udp_tunnel_xmit_skb() only when transport->encap_port and
         net->sctp.udp_port both are set, as these are one for dst port
         and another for src port.
    
      2. For gso packet, SKB_GSO_UDP_TUNNEL_CSUM is set for gso_type, and
         with this udp checksum can be done in __skb_udp_tunnel_segment()
         for each segments after the sctp gso.
    
      3. inner_mac_header and inner_transport_header are set, as these
         will be needed in __skb_udp_tunnel_segment() to find the right
         headers.
    
      4. df and ttl are calculated, as these are the required params by
         udp_tunnel_xmit_skb().
    
      5. nocheck param has to be false, as "the UDP checksum SHOULD be
         computed for IPv4 and IPv6", says in rfc6951#section-5.3.
    
    v1->v2:
      - Use sp->udp_port instead in sctp_v4_xmit(), which is more safe.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit a1dd2cf2f1aedabc2ca9bb4f90231a521c52d8eb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:05:03 2020 +0800

    sctp: allow changing transport encap_port by peer packets
    
    As rfc6951#section-5.4 says:
    
      "After finding the SCTP association (which
       includes checking the verification tag), the UDP source port MUST be
       stored as the encapsulation port for the destination address the SCTP
       packet is received from (see Section 5.1).
    
       When a non-encapsulated SCTP packet is received by the SCTP stack,
       the encapsulation of outgoing packets belonging to the same
       association and the corresponding destination address MUST be
       disabled."
    
    transport encap_port should be updated by a validated incoming packet's
    udp src port.
    
    We save the udp src port in sctp_input_cb->encap_port, and then update
    the transport in two places:
    
      1. right after vtag is verified, which is required by RFC, and this
         allows the existent transports to be updated by the chunks that
         can only be processed on an asoc.
    
      2. right before processing the 'init' where the transports are added,
         and this allows building a sctp over udp connection by client with
         the server not knowing the remote encap port.
    
      3. when processing ootb_pkt and creating the temporary transport for
         the reply pkt.
    
    Note that sctp_input_cb->header is removed, as it's not used any more
    in sctp.
    
    v1->v2:
      - Change encap_port as __be16 for sctp_input_cb.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 8dba29603b5c8bfca2bf90aeb83d05a236df967b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:05:02 2020 +0800

    sctp: add SCTP_REMOTE_UDP_ENCAPS_PORT sockopt
    
    This patch is to implement:
    
      rfc6951#section-6.1: Get or Set the Remote UDP Encapsulation Port Number
    
    with the param of the struct:
    
      struct sctp_udpencaps {
        sctp_assoc_t sue_assoc_id;
        struct sockaddr_storage sue_address;
        uint16_t sue_port;
      };
    
    the encap_port of sock, assoc or transport can be changed by users,
    which also means it allows the different transports of the same asoc
    to have different encap_port value.
    
    v1->v2:
      - no change.
    v2->v3:
      - fix the endian warning when setting values between encap_port and
        sue_port.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 89ba49171fb22c130be4786d5ada9dda33dd7801
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:05:00 2020 +0800

    sctp: add encap_err_lookup for udp encap socks
    
    As it says in rfc6951#section-5.5:
    
      "When receiving ICMP or ICMPv6 response packets, there might not be
       enough bytes in the payload to identify the SCTP association that the
       SCTP packet triggering the ICMP or ICMPv6 packet belongs to.  If a
       received ICMP or ICMPv6 packet cannot be related to a specific SCTP
       association or the verification tag cannot be verified, it MUST be
       discarded silently.  In particular, this means that the SCTP stack
       MUST NOT rely on receiving ICMP or ICMPv6 messages.  Implementation
       constraints could prevent processing received ICMP or ICMPv6
       messages."
    
    ICMP or ICMPv6 packets need to be handled, and this is implemented by
    udp encap sock .encap_err_lookup function.
    
    The .encap_err_lookup function is called in __udp(6)_lib_err_encap()
    to confirm this path does need to be updated. For sctp, what we can
    do here is check if the corresponding asoc and transport exist.
    
    Note that icmp packet process for sctp over udp is done by udp sock
    .encap_err_lookup(), and it means for now we can't do as much as
    sctp_v4/6_err() does. Also we can't do the two mappings mentioned
    in rfc6951#section-5.5.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 9d6ba260a0734d5e56243929a69d57ebbf0cb245
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:04:59 2020 +0800

    sctp: create udp6 sock and set its encap_rcv
    
    This patch is to add the udp6 sock part in sctp_udp_sock_start/stop().
    udp_conf.use_udp6_rx_checksums is set to true, as:
    
       "The SCTP checksum MUST be computed for IPv4 and IPv6, and the UDP
        checksum SHOULD be computed for IPv4 and IPv6"
    
    says in rfc6951#section-5.3.
    
    v1->v2:
      - Add pr_err() when fails to create udp v6 sock.
      - Add #if IS_ENABLED(CONFIG_IPV6) not to create v6 sock when ipv6 is
        disabled.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 965ae44412f8c0c19945b3f62bc945ad0b15a8aa
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:04:58 2020 +0800

    sctp: create udp4 sock and add its encap_rcv
    
    This patch is to add the functions to create/release udp4 sock,
    and set the sock's encap_rcv to process the incoming udp encap
    sctp packets. In sctp_udp_rcv(), as we can see, all we need to
    do is fix the transport header for sctp_rcv(), then it would
    implement the part of rfc6951#section-5.4:
    
      "When an encapsulated packet is received, the UDP header is removed.
       Then, the generic lookup is performed, as done by an SCTP stack
       whenever a packet is received, to find the association for the
       received SCTP packet"
    
    Note that these functions will be called in the last patch of
    this patchset when enabling this feature.
    
    v1->v2:
      - Add pr_err() when fails to create udp v4 sock.
    v2->v3:
      - Add 'select NET_UDP_TUNNEL' in sctp Kconfig.
    v3->v4:
      - No change.
    v4->v5:
      - Change to set udp_port to 0 by default.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 527beb8ef9c02c11f8ca0d59fc46f7d081db1c33
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:04:57 2020 +0800

    udp: support sctp over udp in skb_udp_tunnel_segment
    
    For the gso of sctp over udp packets, sctp_gso_segment() will be called in
    skb_udp_tunnel_segment(), we need to set transport_header to sctp header.
    
    As all the current HWs can't handle both crc checksum and udp checksum at
    the same time, the crc checksum has to be done in sctp_gso_segment() by
    removing the NETIF_F_SCTP_CRC flag from the features.
    
    Meanwhile, if the HW can't do udp checksum, csum and csum_start has to be
    set correctly, and udp checksum will be done in __skb_udp_tunnel_segment()
    by calling gso_make_checksum().
    
    Thanks to Paolo, Marcelo and Guillaume for helping with this one.
    
    v1->v2:
      - no change.
    v2->v3:
      - remove the he NETIF_F_SCTP_CRC flag from the features.
      - set csum and csum_start in sctp_gso_make_checksum().
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 3c7d4415db6a2fa9312e3b5a3e7ca08ed09c9f57
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Oct 29 15:04:56 2020 +0800

    udp6: move the mss check after udp gso tunnel processing
    
    For some protocol's gso, like SCTP, it's using GSO_BY_FRAGS for
    gso_size. When using UDP to encapsulate its packet, it will
    return error in udp6_ufo_fragment() as skb->len < gso_size,
    and it will never go to the gso tunnel processing.
    
    So we should move this check after udp gso tunnel processing,
    the same as udp4_ufo_fragment() does.
    
    v1->v2:
      - no change.
    v2->v3:
      - not do any cleanup.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 346e320cb2103edef709c4466a29140c4a8e527a
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu Oct 15 18:39:27 2020 +0200

    netfilter: nftables: allow re-computing sctp CRC-32C in 'payload' statements
    
    nftables payload statements are used to mangle SCTP headers, but they can
    only replace the Internet Checksum. As a consequence, nftables rules that
    mangle sport/dport/vtag in SCTP headers potentially generate packets that
    are discarded by the receiver, unless the CRC-32C is "offloaded" (e.g the
    rule mangles a skb having 'ip_summed' equal to 'CHECKSUM_PARTIAL'.
    
    Fix this extending uAPI definitions and L4 checksum update function, in a
    way that userspace programs (e.g. nft) can instruct the kernel to compute
    CRC-32C in SCTP headers. Also ensure that LIBCRC32C is built if NF_TABLES
    is 'y' or 'm' in the kernel build configuration.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 9360901e714d702d3a89ec29d7159d1578764565
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fb3681c20fbfb990860cb9a19fbe96882298c21a
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a813aaee68809b5fc3935ec5ccf7cdba75a9c792
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9775dd63d526c54c2a2d11155916e05f6ef7d14f
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4b4471a89e1cc27be9179480a735979fa420216f
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1e33ef76e155925b9ea4ad053eeb4a5dbfb6d811
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e upstream.
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d42ee76ecb6c49d499fc5eb32ca34468d95dbc3e
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu Oct 8 01:38:31 2020 -0700

    sctp: fix sctp_auth_init_hmacs() error path
    
    After freeing ep->auth_hmacs we have to clear the pointer
    or risk use-after-free as reported by syzbot:
    
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
    BUG: KASAN: use-after-free in sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
    BUG: KASAN: use-after-free in sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
    Read of size 8 at addr ffff8880a8ff52c0 by task syz-executor941/6874
    
    CPU: 0 PID: 6874 Comm: syz-executor941 Not tainted 5.9.0-rc8-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:77 [inline]
     dump_stack+0x198/0x1fd lib/dump_stack.c:118
     print_address_description.constprop.0.cold+0xae/0x497 mm/kasan/report.c:383
     __kasan_report mm/kasan/report.c:513 [inline]
     kasan_report.cold+0x1f/0x37 mm/kasan/report.c:530
     sctp_auth_destroy_hmacs net/sctp/auth.c:509 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_free+0x17e/0x1d0 net/sctp/auth.c:1070
     sctp_endpoint_destroy+0x95/0x240 net/sctp/endpointola.c:203
     sctp_endpoint_put net/sctp/endpointola.c:236 [inline]
     sctp_endpoint_free+0xd6/0x110 net/sctp/endpointola.c:183
     sctp_destroy_sock+0x9c/0x3c0 net/sctp/socket.c:4981
     sctp_v6_destroy_sock+0x11/0x20 net/sctp/socket.c:9415
     sk_common_release+0x64/0x390 net/core/sock.c:3254
     sctp_close+0x4ce/0x8b0 net/sctp/socket.c:1533
     inet_release+0x12e/0x280 net/ipv4/af_inet.c:431
     inet6_release+0x4c/0x70 net/ipv6/af_inet6.c:475
     __sock_release+0xcd/0x280 net/socket.c:596
     sock_close+0x18/0x20 net/socket.c:1277
     __fput+0x285/0x920 fs/file_table.c:281
     task_work_run+0xdd/0x190 kernel/task_work.c:141
     exit_task_work include/linux/task_work.h:25 [inline]
     do_exit+0xb7d/0x29f0 kernel/exit.c:806
     do_group_exit+0x125/0x310 kernel/exit.c:903
     __do_sys_exit_group kernel/exit.c:914 [inline]
     __se_sys_exit_group kernel/exit.c:912 [inline]
     __x64_sys_exit_group+0x3a/0x50 kernel/exit.c:912
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x43f278
    Code: Bad RIP value.
    RSP: 002b:00007fffe0995c38 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 000000000043f278
    RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
    RBP: 00000000004bf068 R08: 00000000000000e7 R09: ffffffffffffffd0
    R10: 0000000020000000 R11: 0000000000000246 R12: 0000000000000001
    R13: 00000000006d1180 R14: 0000000000000000 R15: 0000000000000000
    
    Allocated by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track mm/kasan/common.c:56 [inline]
     __kasan_kmalloc.constprop.0+0xbf/0xd0 mm/kasan/common.c:461
     kmem_cache_alloc_trace+0x174/0x300 mm/slab.c:3554
     kmalloc include/linux/slab.h:554 [inline]
     kmalloc_array include/linux/slab.h:593 [inline]
     kcalloc include/linux/slab.h:605 [inline]
     sctp_auth_init_hmacs+0xdb/0x3b0 net/sctp/auth.c:464
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Freed by task 6874:
     kasan_save_stack+0x1b/0x40 mm/kasan/common.c:48
     kasan_set_track+0x1c/0x30 mm/kasan/common.c:56
     kasan_set_free_info+0x1b/0x30 mm/kasan/generic.c:355
     __kasan_slab_free+0xd8/0x120 mm/kasan/common.c:422
     __cache_free mm/slab.c:3422 [inline]
     kfree+0x10e/0x2b0 mm/slab.c:3760
     sctp_auth_destroy_hmacs net/sctp/auth.c:511 [inline]
     sctp_auth_destroy_hmacs net/sctp/auth.c:501 [inline]
     sctp_auth_init_hmacs net/sctp/auth.c:496 [inline]
     sctp_auth_init_hmacs+0x2b7/0x3b0 net/sctp/auth.c:454
     sctp_auth_init+0x8a/0x4a0 net/sctp/auth.c:1049
     sctp_setsockopt_auth_supported net/sctp/socket.c:4354 [inline]
     sctp_setsockopt+0x477e/0x97f0 net/sctp/socket.c:4631
     __sys_setsockopt+0x2db/0x610 net/socket.c:2132
     __do_sys_setsockopt net/socket.c:2143 [inline]
     __se_sys_setsockopt net/socket.c:2140 [inline]
     __x64_sys_setsockopt+0xba/0x150 net/socket.c:2140
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Fixes: 1f485649f529 ("[SCTP]: Implement SCTP-AUTH internals")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>

commit 95ceefc6f0ce47a68fcc01517d530b019d503b43
Author: Kevin Kou <qdkevin.kou@gmail.com>
Date:   Thu Dec 26 12:29:17 2019 +0000

    sctp: move trace_sctp_probe_path into sctp_outq_sack
    
    [ Upstream commit f643ee295c1c63bc117fb052d4da681354d6f732 ]
    
    The original patch bringed in the "SCTP ACK tracking trace event"
    feature was committed at Dec.20, 2017, it replaced jprobe usage
    with trace events, and bringed in two trace events, one is
    TRACE_EVENT(sctp_probe), another one is TRACE_EVENT(sctp_probe_path).
    The original patch intended to trigger the trace_sctp_probe_path in
    TRACE_EVENT(sctp_probe) as below code,
    
    +TRACE_EVENT(sctp_probe,
    +
    +       TP_PROTO(const struct sctp_endpoint *ep,
    +                const struct sctp_association *asoc,
    +                struct sctp_chunk *chunk),
    +
    +       TP_ARGS(ep, asoc, chunk),
    +
    +       TP_STRUCT__entry(
    +               __field(__u64, asoc)
    +               __field(__u32, mark)
    +               __field(__u16, bind_port)
    +               __field(__u16, peer_port)
    +               __field(__u32, pathmtu)
    +               __field(__u32, rwnd)
    +               __field(__u16, unack_data)
    +       ),
    +
    +       TP_fast_assign(
    +               struct sk_buff *skb = chunk->skb;
    +
    +               __entry->asoc = (unsigned long)asoc;
    +               __entry->mark = skb->mark;
    +               __entry->bind_port = ep->base.bind_addr.port;
    +               __entry->peer_port = asoc->peer.port;
    +               __entry->pathmtu = asoc->pathmtu;
    +               __entry->rwnd = asoc->peer.rwnd;
    +               __entry->unack_data = asoc->unack_data;
    +
    +               if (trace_sctp_probe_path_enabled()) {
    +                       struct sctp_transport *sp;
    +
    +                       list_for_each_entry(sp, &asoc->peer.transport_addr_list,
    +                                           transports) {
    +                               trace_sctp_probe_path(sp, asoc);
    +                       }
    +               }
    +       ),
    
    But I found it did not work when I did testing, and trace_sctp_probe_path
    had no output, I finally found that there is trace buffer lock
    operation(trace_event_buffer_reserve) in include/trace/trace_events.h:
    
    static notrace void                                                     \
    trace_event_raw_event_##call(void *__data, proto)                       \
    {                                                                       \
            struct trace_event_file *trace_file = __data;                   \
            struct trace_event_data_offsets_##call __maybe_unused __data_offsets;\
            struct trace_event_buffer fbuffer;                              \
            struct trace_event_raw_##call *entry;                           \
            int __data_size;                                                \
                                                                            \
            if (trace_trigger_soft_disabled(trace_file))                    \
                    return;                                                 \
                                                                            \
            __data_size = trace_event_get_offsets_##call(&__data_offsets, args); \
                                                                            \
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
                                                                            \
            trace_event_buffer_commit(&fbuffer);                            \
    }
    
    The reason caused no output of trace_sctp_probe_path is that
    trace_sctp_probe_path written in TP_fast_assign part of
    TRACE_EVENT(sctp_probe), and it will be placed( { assign; } ) after the
    trace_event_buffer_reserve() when compiler expands Macro,
    
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
    
    so trace_sctp_probe_path finally can not acquire trace_event_buffer
    and return no output, that is to say the nest of tracepoint entry function
    is not allowed. The function call flow is:
    
    trace_sctp_probe()
    -> trace_event_raw_event_sctp_probe()
     -> lock buffer
     -> trace_sctp_probe_path()
       -> trace_event_raw_event_sctp_probe_path()  --nested
       -> buffer has been locked and return no output.
    
    This patch is to remove trace_sctp_probe_path from the TP_fast_assign
    part of TRACE_EVENT(sctp_probe) to avoid the nest of entry function,
    and trigger sctp_probe_path_trace in sctp_outq_sack.
    
    After this patch, you can enable both events individually,
      # cd /sys/kernel/debug/tracing
      # echo 1 > events/sctp/sctp_probe/enable
      # echo 1 > events/sctp/sctp_probe_path/enable
    
    Or, you can enable all the events under sctp.
    
      # echo 1 > events/sctp/enable
    
    Signed-off-by: Kevin Kou <qdkevin.kou@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 479468bef2fa4845cd894ad352181b619195fe70
Author: Kevin Kou <qdkevin.kou@gmail.com>
Date:   Thu Dec 26 12:29:17 2019 +0000

    sctp: move trace_sctp_probe_path into sctp_outq_sack
    
    [ Upstream commit f643ee295c1c63bc117fb052d4da681354d6f732 ]
    
    The original patch bringed in the "SCTP ACK tracking trace event"
    feature was committed at Dec.20, 2017, it replaced jprobe usage
    with trace events, and bringed in two trace events, one is
    TRACE_EVENT(sctp_probe), another one is TRACE_EVENT(sctp_probe_path).
    The original patch intended to trigger the trace_sctp_probe_path in
    TRACE_EVENT(sctp_probe) as below code,
    
    +TRACE_EVENT(sctp_probe,
    +
    +       TP_PROTO(const struct sctp_endpoint *ep,
    +                const struct sctp_association *asoc,
    +                struct sctp_chunk *chunk),
    +
    +       TP_ARGS(ep, asoc, chunk),
    +
    +       TP_STRUCT__entry(
    +               __field(__u64, asoc)
    +               __field(__u32, mark)
    +               __field(__u16, bind_port)
    +               __field(__u16, peer_port)
    +               __field(__u32, pathmtu)
    +               __field(__u32, rwnd)
    +               __field(__u16, unack_data)
    +       ),
    +
    +       TP_fast_assign(
    +               struct sk_buff *skb = chunk->skb;
    +
    +               __entry->asoc = (unsigned long)asoc;
    +               __entry->mark = skb->mark;
    +               __entry->bind_port = ep->base.bind_addr.port;
    +               __entry->peer_port = asoc->peer.port;
    +               __entry->pathmtu = asoc->pathmtu;
    +               __entry->rwnd = asoc->peer.rwnd;
    +               __entry->unack_data = asoc->unack_data;
    +
    +               if (trace_sctp_probe_path_enabled()) {
    +                       struct sctp_transport *sp;
    +
    +                       list_for_each_entry(sp, &asoc->peer.transport_addr_list,
    +                                           transports) {
    +                               trace_sctp_probe_path(sp, asoc);
    +                       }
    +               }
    +       ),
    
    But I found it did not work when I did testing, and trace_sctp_probe_path
    had no output, I finally found that there is trace buffer lock
    operation(trace_event_buffer_reserve) in include/trace/trace_events.h:
    
    static notrace void                                                     \
    trace_event_raw_event_##call(void *__data, proto)                       \
    {                                                                       \
            struct trace_event_file *trace_file = __data;                   \
            struct trace_event_data_offsets_##call __maybe_unused __data_offsets;\
            struct trace_event_buffer fbuffer;                              \
            struct trace_event_raw_##call *entry;                           \
            int __data_size;                                                \
                                                                            \
            if (trace_trigger_soft_disabled(trace_file))                    \
                    return;                                                 \
                                                                            \
            __data_size = trace_event_get_offsets_##call(&__data_offsets, args); \
                                                                            \
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
                                                                            \
            trace_event_buffer_commit(&fbuffer);                            \
    }
    
    The reason caused no output of trace_sctp_probe_path is that
    trace_sctp_probe_path written in TP_fast_assign part of
    TRACE_EVENT(sctp_probe), and it will be placed( { assign; } ) after the
    trace_event_buffer_reserve() when compiler expands Macro,
    
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
    
    so trace_sctp_probe_path finally can not acquire trace_event_buffer
    and return no output, that is to say the nest of tracepoint entry function
    is not allowed. The function call flow is:
    
    trace_sctp_probe()
    -> trace_event_raw_event_sctp_probe()
     -> lock buffer
     -> trace_sctp_probe_path()
       -> trace_event_raw_event_sctp_probe_path()  --nested
       -> buffer has been locked and return no output.
    
    This patch is to remove trace_sctp_probe_path from the TP_fast_assign
    part of TRACE_EVENT(sctp_probe) to avoid the nest of entry function,
    and trigger sctp_probe_path_trace in sctp_outq_sack.
    
    After this patch, you can enable both events individually,
      # cd /sys/kernel/debug/tracing
      # echo 1 > events/sctp/sctp_probe/enable
      # echo 1 > events/sctp/sctp_probe_path/enable
    
    Or, you can enable all the events under sctp.
    
      # echo 1 > events/sctp/enable
    
    Signed-off-by: Kevin Kou <qdkevin.kou@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 24da79902efc4a8443fae09e6c8e25b515bd8db2
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Aug 26 06:50:16 2020 -0700

    inet: remove inet_sk_copy_descendant()
    
    This is no longer used, SCTP now uses a private helper.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a26aea2010601920ad3e61abdc22ad38a805be94
Merge: 7ef1fc57301f 1e105e6afa6c
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Aug 24 06:37:05 2020 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    The following patchset contains Netfilter fixes for net:
    
    1) Don't flag SCTP heartbeat as invalid for re-used connections,
       from Florian Westphal.
    
    2) Bogus overlap report due to rbtree tree rotations, from Stefano Brivio.
    
    3) Detect partial overlap with start end point match, also from Stefano.
    
    4) Skip netlink dump of NFTA_SET_USERDATA is unset.
    
    5) Incorrect nft_list_attributes enumeration definition.
    
    6) Missing zeroing before memcpy to destination register, also
       from Florian.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9d045ed1ebe1a6115d3fa9930c5371defb31d95a
Merge: f320ac6e1316 eeaac3634ee0
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sun Aug 23 10:52:33 2020 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from David Miller:
     "Nothing earth shattering here, lots of small fixes (f.e. missing RCU
      protection, bad ref counting, missing memset(), etc.) all over the
      place:
    
       1) Use get_file_rcu() in task_file iterator, from Yonghong Song.
    
       2) There are two ways to set remote source MAC addresses in macvlan
          driver, but only one of which validates things properly. Fix this.
          From Alvin ipraga.
    
       3) Missing of_node_put() in gianfar probing, from Sumera
          Priyadarsini.
    
       4) Preserve device wanted feature bits across multiple netlink
          ethtool requests, from Maxim Mikityanskiy.
    
       5) Fix rcu_sched stall in task and task_file bpf iterators, from
          Yonghong Song.
    
       6) Avoid reset after device destroy in ena driver, from Shay
          Agroskin.
    
       7) Missing memset() in netlink policy export reallocation path, from
          Johannes Berg.
    
       8) Fix info leak in __smc_diag_dump(), from Peilin Ye.
    
       9) Decapsulate ECN properly for ipv6 in ipv4 tunnels, from Mark
          Tomlinson.
    
      10) Fix number of data stream negotiation in SCTP, from David Laight.
    
      11) Fix double free in connection tracker action module, from Alaa
          Hleihel.
    
      12) Don't allow empty NHA_GROUP attributes, from Nikolay Aleksandrov"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (46 commits)
      net: nexthop: don't allow empty NHA_GROUP
      bpf: Fix two typos in uapi/linux/bpf.h
      net: dsa: b53: check for timeout
      tipc: call rcu_read_lock() in tipc_aead_encrypt_done()
      net/sched: act_ct: Fix skb double-free in tcf_ct_handle_fragments() error flow
      net: sctp: Fix negotiation of the number of data streams.
      dt-bindings: net: renesas, ether: Improve schema validation
      gre6: Fix reception with IP6_TNL_F_RCV_DSCP_COPY
      hv_netvsc: Fix the queue_mapping in netvsc_vf_xmit()
      hv_netvsc: Remove "unlikely" from netvsc_select_queue
      bpf: selftests: global_funcs: Check err_str before strstr
      bpf: xdp: Fix XDP mode when no mode flags specified
      selftests/bpf: Remove test_align leftovers
      tools/resolve_btfids: Fix sections with wrong alignment
      net/smc: Prevent kernel-infoleak in __smc_diag_dump()
      sfc: fix build warnings on 32-bit
      net: phy: mscc: Fix a couple of spelling mistakes "spcified" -> "specified"
      libbpf: Fix map index used in error message
      net: gemini: Fix missing free_netdev() in error path of gemini_ethernet_port_probe()
      net: atlantic: Use readx_poll_timeout() for large timeout
      ...

commit b3e3feb569e0c3628b8a0d68459a9318ce5d891e
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Jul 31 20:12:05 2020 +0200

    net: gre: recompute gre csum for sctp over gre tunnels
    
    [ Upstream commit 622e32b7d4a6492cf5c1f759ef833f817418f7b3 ]
    
    The GRE tunnel can be used to transport traffic that does not rely on a
    Internet checksum (e.g. SCTP). The issue can be triggered creating a GRE
    or GRETAP tunnel and transmitting SCTP traffic ontop of it where CRC
    offload has been disabled. In order to fix the issue we need to
    recompute the GRE csum in gre_gso_segment() not relying on the inner
    checksum.
    The issue is still present when we have the CRC offload enabled.
    In this case we need to disable the CRC offload if we require GRE
    checksum since otherwise skb_checksum() will report a wrong value.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a95ef2ddfdb091e136e997c7d8f6812803a8eef8
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Jul 31 20:12:05 2020 +0200

    net: gre: recompute gre csum for sctp over gre tunnels
    
    [ Upstream commit 622e32b7d4a6492cf5c1f759ef833f817418f7b3 ]
    
    The GRE tunnel can be used to transport traffic that does not rely on a
    Internet checksum (e.g. SCTP). The issue can be triggered creating a GRE
    or GRETAP tunnel and transmitting SCTP traffic ontop of it where CRC
    offload has been disabled. In order to fix the issue we need to
    recompute the GRE csum in gre_gso_segment() not relying on the inner
    checksum.
    The issue is still present when we have the CRC offload enabled.
    In this case we need to disable the CRC offload if we require GRE
    checksum since otherwise skb_checksum() will report a wrong value.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 786a9368be8cf862f1c290edb17c1a7ae363c059
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Jul 31 20:12:05 2020 +0200

    net: gre: recompute gre csum for sctp over gre tunnels
    
    [ Upstream commit 622e32b7d4a6492cf5c1f759ef833f817418f7b3 ]
    
    The GRE tunnel can be used to transport traffic that does not rely on a
    Internet checksum (e.g. SCTP). The issue can be triggered creating a GRE
    or GRETAP tunnel and transmitting SCTP traffic ontop of it where CRC
    offload has been disabled. In order to fix the issue we need to
    recompute the GRE csum in gre_gso_segment() not relying on the inner
    checksum.
    The issue is still present when we have the CRC offload enabled.
    In this case we need to disable the CRC offload if we require GRE
    checksum since otherwise skb_checksum() will report a wrong value.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9ffa0b33f48dfd226b039d272b7ea7db57383fc0
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Jul 31 20:12:05 2020 +0200

    net: gre: recompute gre csum for sctp over gre tunnels
    
    [ Upstream commit 622e32b7d4a6492cf5c1f759ef833f817418f7b3 ]
    
    The GRE tunnel can be used to transport traffic that does not rely on a
    Internet checksum (e.g. SCTP). The issue can be triggered creating a GRE
    or GRETAP tunnel and transmitting SCTP traffic ontop of it where CRC
    offload has been disabled. In order to fix the issue we need to
    recompute the GRE csum in gre_gso_segment() not relying on the inner
    checksum.
    The issue is still present when we have the CRC offload enabled.
    In this case we need to disable the CRC offload if we require GRE
    checksum since otherwise skb_checksum() will report a wrong value.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 622e32b7d4a6492cf5c1f759ef833f817418f7b3
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Jul 31 20:12:05 2020 +0200

    net: gre: recompute gre csum for sctp over gre tunnels
    
    The GRE tunnel can be used to transport traffic that does not rely on a
    Internet checksum (e.g. SCTP). The issue can be triggered creating a GRE
    or GRETAP tunnel and transmitting SCTP traffic ontop of it where CRC
    offload has been disabled. In order to fix the issue we need to
    recompute the GRE csum in gre_gso_segment() not relying on the inner
    checksum.
    The issue is still present when we have the CRC offload enabled.
    In this case we need to disable the CRC offload if we require GRE
    checksum since otherwise skb_checksum() will report a wrong value.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dfd3d5266dc1d9a2b06e5a09bbff4cee547eeb5f
Author: Christoph Hellwig <hch@lst.de>
Date:   Fri Jul 24 08:48:55 2020 +0200

    sctp: fix slab-out-of-bounds in SCTP_DELAYED_SACK processing
    
    This sockopt accepts two kinds of parameters, using struct
    sctp_sack_info and struct sctp_assoc_value. The mentioned commit didn't
    notice an implicit cast from the smaller (latter) struct to the bigger
    one (former) when copying the data from the user space, which now leads
    to an attempt to write beyond the buffer (because it assumes the storing
    buffer is bigger than the parameter itself).
    
    Fix it by allocating a sctp_sack_info on stack and filling it out based
    on the small struct for the compat case.
    
    Changelog stole from an earlier patch from Marcelo Ricardo Leitner.
    
    Fixes: ebb25defdc17 ("sctp: pass a kernel pointer to sctp_setsockopt_delayed_ack")
    Reported-by: syzbot+0e4699d000d8b874d8dc@syzkaller.appspotmail.com
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f1ee7d3a2c1ab17802321879c9a62ca690e71ab9
Author: Stanislav Fomichev <sdf@google.com>
Date:   Tue Jun 16 18:04:14 2020 -0700

    bpf: Don't return EINVAL from {get,set}sockopt when optlen > PAGE_SIZE
    
    [ Upstream commit d8fe449a9c51a37d844ab607e14e2f5c657d3cf2 ]
    
    Attaching to these hooks can break iptables because its optval is
    usually quite big, or at least bigger than the current PAGE_SIZE limit.
    David also mentioned some SCTP options can be big (around 256k).
    
    For such optvals we expose only the first PAGE_SIZE bytes to
    the BPF program. BPF program has two options:
    1. Set ctx->optlen to 0 to indicate that the BPF's optval
       should be ignored and the kernel should use original userspace
       value.
    2. Set ctx->optlen to something that's smaller than the PAGE_SIZE.
    
    v5:
    * use ctx->optlen == 0 with trimmed buffer (Alexei Starovoitov)
    * update the docs accordingly
    
    v4:
    * use temporary buffer to avoid optval == optval_end == NULL;
      this removes the corner case in the verifier that might assume
      non-zero PTR_TO_PACKET/PTR_TO_PACKET_END.
    
    v3:
    * don't increase the limit, bypass the argument
    
    v2:
    * proper comments formatting (Jakub Kicinski)
    
    Fixes: 0d01da6afc54 ("bpf: implement getsockopt and setsockopt hooks")
    Signed-off-by: Stanislav Fomichev <sdf@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Cc: David Laight <David.Laight@ACULAB.COM>
    Link: https://lore.kernel.org/bpf/20200617010416.93086-1-sdf@google.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fb63225de50476ad5d928cb3a69c303724d29901
Author: Stanislav Fomichev <sdf@google.com>
Date:   Tue Jun 16 18:04:14 2020 -0700

    bpf: Don't return EINVAL from {get,set}sockopt when optlen > PAGE_SIZE
    
    [ Upstream commit d8fe449a9c51a37d844ab607e14e2f5c657d3cf2 ]
    
    Attaching to these hooks can break iptables because its optval is
    usually quite big, or at least bigger than the current PAGE_SIZE limit.
    David also mentioned some SCTP options can be big (around 256k).
    
    For such optvals we expose only the first PAGE_SIZE bytes to
    the BPF program. BPF program has two options:
    1. Set ctx->optlen to 0 to indicate that the BPF's optval
       should be ignored and the kernel should use original userspace
       value.
    2. Set ctx->optlen to something that's smaller than the PAGE_SIZE.
    
    v5:
    * use ctx->optlen == 0 with trimmed buffer (Alexei Starovoitov)
    * update the docs accordingly
    
    v4:
    * use temporary buffer to avoid optval == optval_end == NULL;
      this removes the corner case in the verifier that might assume
      non-zero PTR_TO_PACKET/PTR_TO_PACKET_END.
    
    v3:
    * don't increase the limit, bypass the argument
    
    v2:
    * proper comments formatting (Jakub Kicinski)
    
    Fixes: 0d01da6afc54 ("bpf: implement getsockopt and setsockopt hooks")
    Signed-off-by: Stanislav Fomichev <sdf@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Cc: David Laight <David.Laight@ACULAB.COM>
    Link: https://lore.kernel.org/bpf/20200617010416.93086-1-sdf@google.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4a21185cda0fbb860580eeeb4f1a70a9cda332a4
Merge: 42e9c85f5c72 4c342f778fe2
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Jun 25 18:27:40 2020 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from David Miller:
    
     1) Don't insert ESP trailer twice in IPSEC code, from Huy Nguyen.
    
     2) The default crypto algorithm selection in Kconfig for IPSEC is out
        of touch with modern reality, fix this up. From Eric Biggers.
    
     3) bpftool is missing an entry for BPF_MAP_TYPE_RINGBUF, from Andrii
        Nakryiko.
    
     4) Missing init of ->frame_sz in xdp_convert_zc_to_xdp_frame(), from
        Hangbin Liu.
    
     5) Adjust packet alignment handling in ax88179_178a driver to match
        what the hardware actually does. From Jeremy Kerr.
    
     6) register_netdevice can leak in the case one of the notifiers fail,
        from Yang Yingliang.
    
     7) Use after free in ip_tunnel_lookup(), from Taehee Yoo.
    
     8) VLAN checks in sja1105 DSA driver need adjustments, from Vladimir
        Oltean.
    
     9) tg3 driver can sleep forever when we get enough EEH errors, fix from
        David Christensen.
    
    10) Missing {READ,WRITE}_ONCE() annotations in various Intel ethernet
        drivers, from Ciara Loftus.
    
    11) Fix scanning loop break condition in of_mdiobus_register(), from
        Florian Fainelli.
    
    12) MTU limit is incorrect in ibmveth driver, from Thomas Falcon.
    
    13) Endianness fix in mlxsw, from Ido Schimmel.
    
    14) Use after free in smsc95xx usbnet driver, from Tuomas Tynkkynen.
    
    15) Missing bridge mrp configuration validation, from Horatiu Vultur.
    
    16) Fix circular netns references in wireguard, from Jason A. Donenfeld.
    
    17) PTP initialization on recovery is not done properly in qed driver,
        from Alexander Lobakin.
    
    18) Endian conversion of L4 ports in filters of cxgb4 driver is wrong,
        from Rahul Lakkireddy.
    
    19) Don't clear bound device TX queue of socket prematurely otherwise we
        get problems with ktls hw offloading, from Tariq Toukan.
    
    20) ipset can do atomics on unaligned memory, fix from Russell King.
    
    21) Align ethernet addresses properly in bridging code, from Thomas
        Martitz.
    
    22) Don't advertise ipv4 addresses on SCTP sockets having ipv6only set,
        from Marcelo Ricardo Leitner.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (149 commits)
      rds: transport module should be auto loaded when transport is set
      sch_cake: fix a few style nits
      sch_cake: don't call diffserv parsing code when it is not needed
      sch_cake: don't try to reallocate or unshare skb unconditionally
      ethtool: fix error handling in linkstate_prepare_data()
      wil6210: account for napi_gro_receive never returning GRO_DROP
      hns: do not cast return value of napi_gro_receive to null
      socionext: account for napi_gro_receive never returning GRO_DROP
      wireguard: receive: account for napi_gro_receive never returning GRO_DROP
      vxlan: fix last fdb index during dump of fdb with nhid
      sctp: Don't advertise IPv4 addresses if ipv6only is set on the socket
      tc-testing: avoid action cookies with odd length.
      bpf: tcp: bpf_cubic: fix spurious HYSTART_DELAY exit upon drop in min RTT
      tcp_cubic: fix spurious HYSTART_DELAY exit upon drop in min RTT
      net: dsa: sja1105: fix tc-gate schedule with single element
      net: dsa: sja1105: recalculate gating subschedule after deleting tc-gate rules
      net: dsa: sja1105: unconditionally free old gating config
      net: dsa: sja1105: move sja1105_compose_gating_subschedule at the top
      net: macb: free resources on failure path of at91ether_open()
      net: macb: call pm_runtime_put_sync on failure path
      ...

commit d8fe449a9c51a37d844ab607e14e2f5c657d3cf2
Author: Stanislav Fomichev <sdf@google.com>
Date:   Tue Jun 16 18:04:14 2020 -0700

    bpf: Don't return EINVAL from {get,set}sockopt when optlen > PAGE_SIZE
    
    Attaching to these hooks can break iptables because its optval is
    usually quite big, or at least bigger than the current PAGE_SIZE limit.
    David also mentioned some SCTP options can be big (around 256k).
    
    For such optvals we expose only the first PAGE_SIZE bytes to
    the BPF program. BPF program has two options:
    1. Set ctx->optlen to 0 to indicate that the BPF's optval
       should be ignored and the kernel should use original userspace
       value.
    2. Set ctx->optlen to something that's smaller than the PAGE_SIZE.
    
    v5:
    * use ctx->optlen == 0 with trimmed buffer (Alexei Starovoitov)
    * update the docs accordingly
    
    v4:
    * use temporary buffer to avoid optval == optval_end == NULL;
      this removes the corner case in the verifier that might assume
      non-zero PTR_TO_PACKET/PTR_TO_PACKET_END.
    
    v3:
    * don't increase the limit, bypass the argument
    
    v2:
    * proper comments formatting (Jakub Kicinski)
    
    Fixes: 0d01da6afc54 ("bpf: implement getsockopt and setsockopt hooks")
    Signed-off-by: Stanislav Fomichev <sdf@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Cc: David Laight <David.Laight@ACULAB.COM>
    Link: https://lore.kernel.org/bpf/20200617010416.93086-1-sdf@google.com

commit 7264f7053779c632e74d2845145a7c3201a2253c
Author: Jonas Falkevik <jonas.falkevik@gmail.com>
Date:   Wed May 27 11:56:40 2020 +0200

    sctp: check assoc before SCTP_ADDR_{MADE_PRIM, ADDED} event
    
    [ Upstream commit 45ebf73ebcec88a34a778f5feaa0b82b1c76069e ]
    
    Make sure SCTP_ADDR_{MADE_PRIM,ADDED} are sent only for associations
    that have been established.
    
    These events are described in rfc6458#section-6.1
    SCTP_PEER_ADDR_CHANGE:
    This tag indicates that an address that is
    part of an existing association has experienced a change of
    state (e.g., a failure or return to service of the reachability
    of an endpoint via a specific transport address).
    
    Signed-off-by: Jonas Falkevik <jonas.falkevik@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c0425a4249e9d313eec5f81c0bde8a286ebf9a63
Author: Christoph Hellwig <hch@lst.de>
Date:   Fri May 29 14:09:42 2020 +0200

    net: add a new bind_add method
    
    The SCTP protocol allows to bind multiple address to a socket.  That
    feature is currently only exposed as a socket option.  Add a bind_add
    method struct proto that allows to bind additional addresses, and
    switch the dlm code to use the method instead of going through the
    socket option from kernel space.
    
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 40ef92c6ec09bd8aaffccfa41a715d1df5625f95
Author: Christoph Hellwig <hch@lst.de>
Date:   Fri May 29 14:09:40 2020 +0200

    sctp: add sctp_sock_set_nodelay
    
    Add a helper to directly set the SCTP_NODELAY sockopt from kernel space
    without going through a fake uaccess.
    
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 45ebf73ebcec88a34a778f5feaa0b82b1c76069e
Author: Jonas Falkevik <jonas.falkevik@gmail.com>
Date:   Wed May 27 11:56:40 2020 +0200

    sctp: check assoc before SCTP_ADDR_{MADE_PRIM, ADDED} event
    
    Make sure SCTP_ADDR_{MADE_PRIM,ADDED} are sent only for associations
    that have been established.
    
    These events are described in rfc6458#section-6.1
    SCTP_PEER_ADDR_CHANGE:
    This tag indicates that an address that is
    part of an existing association has experienced a change of
    state (e.g., a failure or return to service of the reachability
    of an endpoint via a specific transport address).
    
    Signed-off-by: Jonas Falkevik <jonas.falkevik@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0774dc7643db525f0bb9d0aa212cbfad3a412fc6
Author: Christoph Hellwig <hch@lst.de>
Date:   Wed May 27 20:22:28 2020 +0200

    dlm: use the tcp version of accept_from_sock for sctp as well
    
    The only difference between a few missing fixes applied to the SCTP
    one is that TCP uses ->getpeername to get the remote address, while
    SCTP uses kernel_getsockopt(.. SCTP_PRIMARY_ADDR).  But given that
    getpeername is defined to return the primary address for sctp, there
    doesn't seem to be any reason for the different way of quering the
    peername, or all the code duplication.
    
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9a233d329ec5cd2dd64737d24018c1463ad88f26
Author: Chris Packham <chris.packham@alliedtelesis.co.nz>
Date:   Tue May 26 10:55:59 2020 +1200

    net: sctp: Fix spelling in Kconfig help
    
    Change 'handeled' to 'handled' in the Kconfig help for SCTP.
    
    Signed-off-by: Chris Packham <chris.packham@alliedtelesis.co.nz>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4f65e2f483b6f764c15094d14dd53dda048a4048
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue May 19 15:50:12 2020 -0700

    net: unexport skb_gro_receive()
    
    skb_gro_receive() used to be used by SCTP, it is no longer the case.
    
    skb_gro_receive_list() is in the same category : never used from modules.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 755d6cc4f5b58ccd0547fa96dce21d7ab4af7cd3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    commit be7a7729207797476b6666f046d765bdf9630407 upstream.
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 29f36c168813f1beaf59812cc79ef46fb33c669a
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Thu Mar 19 11:42:56 2020 -0300

    tools headers uapi: Update linux/in.h copy
    
    To get the changes in:
    
      267762538705 ("seg6: fix SRv6 L2 tunnels to use IANA-assigned protocol number")
    
    That ends up automatically adding the new IPPROTO_ETHERNET to the socket
    args beautifiers:
    
      $ tools/perf/trace/beauty/socket_ipproto.sh > before
    
    Apply this patch:
    
      $ tools/perf/trace/beauty/socket_ipproto.sh > after
      $ diff -u before after
      --- before    2020-03-19 11:48:36.876673819 -0300
      +++ after     2020-03-19 11:49:00.148541377 -0300
      @@ -6,6 +6,7 @@
            [132] = "SCTP",
            [136] = "UDPLITE",
            [137] = "MPLS",
      +     [143] = "ETHERNET",
            [17] = "UDP",
            [1] = "ICMP",
            [22] = "IDP",
      $
    
    Addresses this tools/perf build warning:
    
      Warning: Kernel ABI header at 'tools/include/uapi/linux/in.h' differs from latest version at 'include/uapi/linux/in.h'
      diff -u tools/include/uapi/linux/in.h include/uapi/linux/in.h
    
    Cc: David S. Miller <davem@davemloft.net>
    Cc: Paolo Lungaroni <paolo.lungaroni@cnit.it>
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 564200ed8e71d91327d337e46bc778cee02da866
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Thu Mar 19 11:42:56 2020 -0300

    tools headers uapi: Update linux/in.h copy
    
    To get the changes in:
    
      267762538705 ("seg6: fix SRv6 L2 tunnels to use IANA-assigned protocol number")
    
    That ends up automatically adding the new IPPROTO_ETHERNET to the socket
    args beautifiers:
    
      $ tools/perf/trace/beauty/socket_ipproto.sh > before
    
    Apply this patch:
    
      $ tools/perf/trace/beauty/socket_ipproto.sh > after
      $ diff -u before after
      --- before    2020-03-19 11:48:36.876673819 -0300
      +++ after     2020-03-19 11:49:00.148541377 -0300
      @@ -6,6 +6,7 @@
            [132] = "SCTP",
            [136] = "UDPLITE",
            [137] = "MPLS",
      +     [143] = "ETHERNET",
            [17] = "UDP",
            [1] = "ICMP",
            [22] = "IDP",
      $
    
    Addresses this tools/perf build warning:
    
      Warning: Kernel ABI header at 'tools/include/uapi/linux/in.h' differs from latest version at 'include/uapi/linux/in.h'
      diff -u tools/include/uapi/linux/in.h include/uapi/linux/in.h
    
    Cc: David S. Miller <davem@davemloft.net>
    Cc: Paolo Lungaroni <paolo.lungaroni@cnit.it>
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 4dfb4833a549dfdf3b6771d722c08140fbe9c137
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 548e23fcab6d8a777bbddc60d937faa893e4aba5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4fd5220a5c9e289fbb1079fcfd8320ee859c8aa8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 04f1991d9ca964cca75dd365d40486b4a37faa3a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c360e0530107ebf7423222c54f13b07e8c0283da
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 487317df3e2e74edcb9ff05e7186b1a14f3bca30
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    [ Upstream commit 245709ec8be89af46ea7ef0444c9c80913999d99 ]
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 245709ec8be89af46ea7ef0444c9c80913999d99
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 18 12:07:53 2020 +0800

    sctp: move the format error check out of __sctp_sf_do_9_1_abort
    
    When T2 timer is to be stopped, the asoc should also be deleted,
    otherwise, there will be no chance to call sctp_association_free
    and the asoc could last in memory forever.
    
    However, in sctp_sf_shutdown_sent_abort(), after adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer, it may return error due to the
    format error from __sctp_sf_do_9_1_abort() and miss adding
    SCTP_CMD_ASSOC_FAILED where the asoc will be deleted.
    
    This patch is to fix it by moving the format error check out of
    __sctp_sf_do_9_1_abort(), and do it before adding the cmd
    SCTP_CMD_TIMER_STOP for T2 timer.
    
    Thanks Hangbin for reporting this issue by the fuzz testing.
    
    v1->v2:
      - improve the comment in the code as Marcelo's suggestion.
    
    Fixes: 96ca468b86b0 ("sctp: check invalid value of length parameter in error cause")
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 17d56cef7f93ac315f49e69c9fe2a0b7c8e745eb
Author: Jiri Wiesner <jwiesner@suse.com>
Date:   Sat Jan 18 13:10:50 2020 +0100

    netfilter: conntrack: sctp: use distinct states for new SCTP connections
    
    [ Upstream commit ab658b9fa7a2c467f79eac8b53ea308b8f98113d ]
    
    The netlink notifications triggered by the INIT and INIT_ACK chunks
    for a tracked SCTP association do not include protocol information
    for the corresponding connection - SCTP state and verification tags
    for the original and reply direction are missing. Since the connection
    tracking implementation allows user space programs to receive
    notifications about a connection and then create a new connection
    based on the values received in a notification, it makes sense that
    INIT and INIT_ACK notifications should contain the SCTP state
    and verification tags available at the time when a notification
    is sent. The missing verification tags cause a newly created
    netfilter connection to fail to verify the tags of SCTP packets
    when this connection has been created from the values previously
    received in an INIT or INIT_ACK notification.
    
    A PROTOINFO event is cached in sctp_packet() when the state
    of a connection changes. The CLOSED and COOKIE_WAIT state will
    be used for connections that have seen an INIT and INIT_ACK chunk,
    respectively. The distinct states will cause a connection state
    change in sctp_packet().
    
    Signed-off-by: Jiri Wiesner <jwiesner@suse.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b15a38ce955212cc9ad8f13deec67ef375cad1b1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:09:23 2019 +0800

    sctp: add chunks to sk_backlog when the newsk sk_socket is not set
    
    [ Upstream commit 819be8108fded0b9e710bbbf81193e52f7bab2f7 ]
    
    This patch is to fix a NULL-ptr deref in selinux_socket_connect_helper:
    
      [...] kasan: GPF could be caused by NULL-ptr deref or user memory access
      [...] RIP: 0010:selinux_socket_connect_helper+0x94/0x460
      [...] Call Trace:
      [...]  selinux_sctp_bind_connect+0x16a/0x1d0
      [...]  security_sctp_bind_connect+0x58/0x90
      [...]  sctp_process_asconf+0xa52/0xfd0 [sctp]
      [...]  sctp_sf_do_asconf+0x785/0x980 [sctp]
      [...]  sctp_do_sm+0x175/0x5a0 [sctp]
      [...]  sctp_assoc_bh_rcv+0x285/0x5b0 [sctp]
      [...]  sctp_backlog_rcv+0x482/0x910 [sctp]
      [...]  __release_sock+0x11e/0x310
      [...]  release_sock+0x4f/0x180
      [...]  sctp_accept+0x3f9/0x5a0 [sctp]
      [...]  inet_accept+0xe7/0x720
    
    It was caused by that the 'newsk' sk_socket was not set before going to
    security sctp hook when processing asconf chunk with SCTP_PARAM_ADD_IP
    or SCTP_PARAM_SET_PRIMARY:
    
      inet_accept()->
        sctp_accept():
          lock_sock():
              lock listening 'sk'
                                              do_softirq():
                                                sctp_rcv():  <-- [1]
                                                    asconf chunk arrives and
                                                    enqueued in 'sk' backlog
          sctp_sock_migrate():
              set asoc's sk to 'newsk'
          release_sock():
              sctp_backlog_rcv():
                lock 'newsk'
                sctp_process_asconf()  <-- [2]
                unlock 'newsk'
        sock_graft():
            set sk_socket  <-- [3]
    
    As it shows, at [1] the asconf chunk would be put into the listening 'sk'
    backlog, as accept() was holding its sock lock. Then at [2] asconf would
    get processed with 'newsk' as asoc's sk had been set to 'newsk'. However,
    'newsk' sk_socket is not set until [3], while selinux_sctp_bind_connect()
    would deref it, then kernel crashed.
    
    Here to fix it by adding the chunk to sk_backlog until newsk sk_socket is
    set when .accept() is done.
    
    Note that sk->sk_socket can be NULL when the sock is closed, so SOCK_DEAD
    flag is also needed to check in sctp_newsk_ready().
    
    Thanks to Ondrej for reviewing the code.
    
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 14a1d2468ab370c8f02d341b1551bc742a8975d3
Merge: 4d8773b68e83 18a8d3586310
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Jan 26 11:38:10 2020 +0100

    Merge branch '100GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    100GbE Intel Wired LAN Driver Updates 2020-01-25
    
    This series contains updates to the ice driver to add support for RSS.
    
    Henry and Tony enable the driver to write the filtering hardware tables
    to allow for changing of RSS rules, also introduced and initialized the
    structures for storing the configuration.  Then followed it up by
    creating an extraction sequence based on the packet header protocols to
    be programmed.  Next was storing the TCAM entry with the profile data
    and VSI group in the respective software structures.
    
    Md Fahad sets up the configuration to support RSS tables for the virtual
    function (VF) driver (iavf).  Add support for flow types TCP4, TCP6,
    UDP4, UDP6, SCTP4 and SCTP6 for RSS via ethtool.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 84809aaf78b5b4c2e6478dc6121a1c8fb439a024
Merge: f041eadad750 fa865ba183d6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Jan 25 14:19:32 2020 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net
    
    Pull networking fixes from David Miller:
    
     1) Off by one in mt76 airtime calculation, from Dan Carpenter.
    
     2) Fix TLV fragment allocation loop condition in iwlwifi, from Luca
        Coelho.
    
     3) Don't confirm neigh entries when doing ipsec pmtu updates, from Xu
        Wang.
    
     4) More checks to make sure we only send TSO packets to lan78xx chips
        that they can actually handle. From James Hughes.
    
     5) Fix ip_tunnel namespace move, from William Dauchy.
    
     6) Fix unintended packet reordering due to cooperation between
        listification done by GRO and non-GRO paths. From Maxim
        Mikityanskiy.
    
     7) Add Jakub Kicincki formally as networking co-maintainer.
    
     8) Info leak in airo ioctls, from Michael Ellerman.
    
     9) IFLA_MTU attribute needs validation during rtnl_create_link(), from
        Eric Dumazet.
    
    10) Use after free during reload in mlxsw, from Ido Schimmel.
    
    11) Dangling pointers are possible in tp->highest_sack, fix from Eric
        Dumazet.
    
    12) Missing *pos++ in various networking seq_next handlers, from Vasily
        Averin.
    
    13) CHELSIO_GET_MEM operation neds CAP_NET_ADMIN check, from Michael
        Ellerman.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net: (109 commits)
      firestream: fix memory leaks
      net: cxgb3_main: Add CAP_NET_ADMIN check to CHELSIO_GET_MEM
      net: bcmgenet: Use netif_tx_napi_add() for TX NAPI
      tipc: change maintainer email address
      net: stmmac: platform: fix probe for ACPI devices
      net/mlx5e: kTLS, Do not send decrypted-marked SKBs via non-accel path
      net/mlx5e: kTLS, Remove redundant posts in TX resync flow
      net/mlx5e: kTLS, Fix corner-case checks in TX resync flow
      net/mlx5e: Clear VF config when switching modes
      net/mlx5: DR, use non preemptible call to get the current cpu number
      net/mlx5: E-Switch, Prevent ingress rate configuration of uplink rep
      net/mlx5: DR, Enable counter on non-fwd-dest objects
      net/mlx5: Update the list of the PCI supported devices
      net/mlx5: Fix lowest FDB pool size
      net: Fix skb->csum update in inet_proto_csum_replace16().
      netfilter: nf_tables: autoload modules from the abort path
      netfilter: nf_tables: add __nft_chain_type_get()
      netfilter: nf_tables_offload: fix check the chain offload flag
      netfilter: conntrack: sctp: use distinct states for new SCTP connections
      ipv6_route_seq_next should increase position index
      ...

commit ab658b9fa7a2c467f79eac8b53ea308b8f98113d
Author: Jiri Wiesner <jwiesner@suse.com>
Date:   Sat Jan 18 13:10:50 2020 +0100

    netfilter: conntrack: sctp: use distinct states for new SCTP connections
    
    The netlink notifications triggered by the INIT and INIT_ACK chunks
    for a tracked SCTP association do not include protocol information
    for the corresponding connection - SCTP state and verification tags
    for the original and reply direction are missing. Since the connection
    tracking implementation allows user space programs to receive
    notifications about a connection and then create a new connection
    based on the values received in a notification, it makes sense that
    INIT and INIT_ACK notifications should contain the SCTP state
    and verification tags available at the time when a notification
    is sent. The missing verification tags cause a newly created
    netfilter connection to fail to verify the tags of SCTP packets
    when this connection has been created from the values previously
    received in an INIT or INIT_ACK notification.
    
    A PROTOINFO event is cached in sctp_packet() when the state
    of a connection changes. The CLOSED and COOKIE_WAIT state will
    be used for connections that have seen an INIT and INIT_ACK chunk,
    respectively. The distinct states will cause a connection state
    change in sctp_packet().
    
    Signed-off-by: Jiri Wiesner <jwiesner@suse.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 50027f1c78abced651d03e2a0d88b7caa2b9a0c2
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    [ Upstream commit be7a7729207797476b6666f046d765bdf9630407 ]
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5f52b9ebd47caf11e5ee11172c1db42ae2f26fe5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    [ Upstream commit be7a7729207797476b6666f046d765bdf9630407 ]
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2e2d29bacd3f70b13a3abfc7b7033aacdb4c2aee
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    [ Upstream commit be7a7729207797476b6666f046d765bdf9630407 ]
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 86c2a390086cf2f8cb3416f0eab950acc437ff57
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    [ Upstream commit be7a7729207797476b6666f046d765bdf9630407 ]
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7b39b6d38d09cff273bfb47d4f0043202300be18
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    [ Upstream commit be7a7729207797476b6666f046d765bdf9630407 ]
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit be7a7729207797476b6666f046d765bdf9630407
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jan 4 14:15:02 2020 +0800

    sctp: free cmd->obj.chunk for the unprocessed SCTP_CMD_REPLY
    
    This patch is to fix a memleak caused by no place to free cmd->obj.chunk
    for the unprocessed SCTP_CMD_REPLY. This issue occurs when failing to
    process a cmd while there're still SCTP_CMD_REPLY cmds on the cmd seq
    with an allocated chunk in cmd->obj.chunk.
    
    So fix it by freeing cmd->obj.chunk for each SCTP_CMD_REPLY cmd left on
    the cmd seq when any cmd returns error. While at it, also remove 'nomem'
    label.
    
    Reported-by: syzbot+107c4aff5f392bf1517f@syzkaller.appspotmail.com
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 62870e2a06467a52090373b18ddea073a6486401
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Dec 16 22:01:16 2019 -0300

    sctp: fix memleak on err handling of stream initialization
    
    [ Upstream commit 951c6db954a1adefab492f6da805decacabbd1a7 ]
    
    syzbot reported a memory leak when an allocation fails within
    genradix_prealloc() for output streams. That's because
    genradix_prealloc() leaves initialized members initialized when the
    issue happens and SCTP stack will abort the current initialization but
    without cleaning up such members.
    
    The fix here is to always call genradix_free() when genradix_prealloc()
    fails, for output and also input streams, as it suffers from the same
    issue.
    
    Reported-by: syzbot+772d9e36c490b18d51d1@syzkaller.appspotmail.com
    Fixes: 2075e50caf5e ("sctp: convert to genradix")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f398efc14a9277b55defff71f59a46fdf13c713f
Author: Kevin Kou <qdkevin.kou@gmail.com>
Date:   Fri Dec 27 13:11:16 2019 +0000

    sctp: add enabled check for path tracepoint loop.
    
    sctp_outq_sack is the main function handles SACK, it is called very
    frequently. As the commit "move trace_sctp_probe_path into sctp_outq_sack"
    added below code to this function, sctp tracepoint is disabled most of time,
    but the loop of transport list will be always called even though the
    tracepoint is disabled, this is unnecessary.
    
    +       /* SCTP path tracepoint for congestion control debugging. */
    +       list_for_each_entry(transport, transport_list, transports) {
    +               trace_sctp_probe_path(transport, asoc);
    +       }
    
    This patch is to add tracepoint enabled check at outside of the loop of
    transport list, and avoid traversing the loop when trace is disabled,
    it is a small optimization.
    
    Signed-off-by: Kevin Kou <qdkevin.kou@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 356b23c073dd063427102329b296061855b912d9
Author: Kevin Kou <qdkevin.kou@gmail.com>
Date:   Wed Dec 25 08:27:25 2019 +0000

    sctp: do trace_sctp_probe after SACK validation and check
    
    The function sctp_sf_eat_sack_6_2 now performs the Verification
    Tag validation, Chunk length validation, Bogu check, and also
    the detection of out-of-order SACK based on the RFC2960
    Section 6.2 at the beginning, and finally performs the further
    processing of SACK. The trace_sctp_probe now triggered before
    the above necessary validation and check.
    
    this patch is to do the trace_sctp_probe after the chunk sanity
    tests, but keep doing trace if the SACK received is out of order,
    for the out-of-order SACK is valuable to congestion control
    debugging.
    
    v1->v2:
     - keep doing SCTP trace if the SACK is out of order as Marcelo's
       suggestion.
    v2->v3:
     - regenerate the patch as v2 generated on top of v1, and add
       'net-next' tag to the new one as Marcelo's comments.
    
    Signed-off-by: Kevin Kou <qdkevin.kou@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f643ee295c1c63bc117fb052d4da681354d6f732
Author: Kevin Kou <qdkevin.kou@gmail.com>
Date:   Thu Dec 26 12:29:17 2019 +0000

    sctp: move trace_sctp_probe_path into sctp_outq_sack
    
    The original patch bringed in the "SCTP ACK tracking trace event"
    feature was committed at Dec.20, 2017, it replaced jprobe usage
    with trace events, and bringed in two trace events, one is
    TRACE_EVENT(sctp_probe), another one is TRACE_EVENT(sctp_probe_path).
    The original patch intended to trigger the trace_sctp_probe_path in
    TRACE_EVENT(sctp_probe) as below code,
    
    +TRACE_EVENT(sctp_probe,
    +
    +       TP_PROTO(const struct sctp_endpoint *ep,
    +                const struct sctp_association *asoc,
    +                struct sctp_chunk *chunk),
    +
    +       TP_ARGS(ep, asoc, chunk),
    +
    +       TP_STRUCT__entry(
    +               __field(__u64, asoc)
    +               __field(__u32, mark)
    +               __field(__u16, bind_port)
    +               __field(__u16, peer_port)
    +               __field(__u32, pathmtu)
    +               __field(__u32, rwnd)
    +               __field(__u16, unack_data)
    +       ),
    +
    +       TP_fast_assign(
    +               struct sk_buff *skb = chunk->skb;
    +
    +               __entry->asoc = (unsigned long)asoc;
    +               __entry->mark = skb->mark;
    +               __entry->bind_port = ep->base.bind_addr.port;
    +               __entry->peer_port = asoc->peer.port;
    +               __entry->pathmtu = asoc->pathmtu;
    +               __entry->rwnd = asoc->peer.rwnd;
    +               __entry->unack_data = asoc->unack_data;
    +
    +               if (trace_sctp_probe_path_enabled()) {
    +                       struct sctp_transport *sp;
    +
    +                       list_for_each_entry(sp, &asoc->peer.transport_addr_list,
    +                                           transports) {
    +                               trace_sctp_probe_path(sp, asoc);
    +                       }
    +               }
    +       ),
    
    But I found it did not work when I did testing, and trace_sctp_probe_path
    had no output, I finally found that there is trace buffer lock
    operation(trace_event_buffer_reserve) in include/trace/trace_events.h:
    
    static notrace void                                                     \
    trace_event_raw_event_##call(void *__data, proto)                       \
    {                                                                       \
            struct trace_event_file *trace_file = __data;                   \
            struct trace_event_data_offsets_##call __maybe_unused __data_offsets;\
            struct trace_event_buffer fbuffer;                              \
            struct trace_event_raw_##call *entry;                           \
            int __data_size;                                                \
                                                                            \
            if (trace_trigger_soft_disabled(trace_file))                    \
                    return;                                                 \
                                                                            \
            __data_size = trace_event_get_offsets_##call(&__data_offsets, args); \
                                                                            \
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
                                                                            \
            trace_event_buffer_commit(&fbuffer);                            \
    }
    
    The reason caused no output of trace_sctp_probe_path is that
    trace_sctp_probe_path written in TP_fast_assign part of
    TRACE_EVENT(sctp_probe), and it will be placed( { assign; } ) after the
    trace_event_buffer_reserve() when compiler expands Macro,
    
            entry = trace_event_buffer_reserve(&fbuffer, trace_file,        \
                                     sizeof(*entry) + __data_size);         \
                                                                            \
            if (!entry)                                                     \
                    return;                                                 \
                                                                            \
            tstruct                                                         \
                                                                            \
            { assign; }                                                     \
    
    so trace_sctp_probe_path finally can not acquire trace_event_buffer
    and return no output, that is to say the nest of tracepoint entry function
    is not allowed. The function call flow is:
    
    trace_sctp_probe()
    -> trace_event_raw_event_sctp_probe()
     -> lock buffer
     -> trace_sctp_probe_path()
       -> trace_event_raw_event_sctp_probe_path()  --nested
       -> buffer has been locked and return no output.
    
    This patch is to remove trace_sctp_probe_path from the TP_fast_assign
    part of TRACE_EVENT(sctp_probe) to avoid the nest of entry function,
    and trigger sctp_probe_path_trace in sctp_outq_sack.
    
    After this patch, you can enable both events individually,
      # cd /sys/kernel/debug/tracing
      # echo 1 > events/sctp/sctp_probe/enable
      # echo 1 > events/sctp/sctp_probe_path/enable
    
    Or, you can enable all the events under sctp.
    
      # echo 1 > events/sctp/enable
    
    Signed-off-by: Kevin Kou <qdkevin.kou@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 951c6db954a1adefab492f6da805decacabbd1a7
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Dec 16 22:01:16 2019 -0300

    sctp: fix memleak on err handling of stream initialization
    
    syzbot reported a memory leak when an allocation fails within
    genradix_prealloc() for output streams. That's because
    genradix_prealloc() leaves initialized members initialized when the
    issue happens and SCTP stack will abort the current initialization but
    without cleaning up such members.
    
    The fix here is to always call genradix_free() when genradix_prealloc()
    fails, for output and also input streams, as it suffers from the same
    issue.
    
    Reported-by: syzbot+772d9e36c490b18d51d1@syzkaller.appspotmail.com
    Fixes: 2075e50caf5e ("sctp: convert to genradix")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7da538c1e154635e1f84b2fc41e482680e770844
Merge: f8fc57e8d7c5 7acd9378dc65
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Dec 9 14:03:33 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    The following patchset contains Netfilter fixes for net:
    
    1) Wait for rcu grace period after releasing netns in ctnetlink,
       from Florian Westphal.
    
    2) Incorrect command type in flowtable offload ndo invocation,
       from wenxu.
    
    3) Incorrect callback type in flowtable offload flow tuple
       updates, also from wenxu.
    
    4) Fix compile warning on flowtable offload infrastructure due to
       possible reference to uninitialized variable, from Nathan Chancellor.
    
    5) Do not inline nf_ct_resolve_clash(), this is called from slow
       path / stress situations. From Florian Westphal.
    
    6) Missing IPv6 flow selector description in flowtable offload.
    
    7) Missing check for NETDEV_UNREGISTER in nf_tables offload
       infrastructure, from wenxu.
    
    8) Update NAT selftest to use randomized netns names, from
       Florian Westphal.
    
    9) Restore nfqueue bridge support, from Marco Oliverio.
    
    10) Compilation warning in SCTP_CHUNKMAP_*() on xt_sctp header.
        From Phil Sutter.
    
    11) Fix bogus lookup/get match for non-anonymous rbtree sets.
    
    12) Missing netlink validation for NFT_SET_ELEM_INTERVAL_END
        elements.
    
    13) Missing netlink validation for NFT_DATA_VALUE after
        nft_data_init().
    
    14) If rule specifies no actions, offload infrastructure returns
        EOPNOTSUPP.
    
    15) Module refcount leak in object updates.
    
    16) Missing sanitization for ARP traffic from br_netfilter, from
        Eric Dumazet.
    
    17) Compilation breakage on big-endian due to incorrect memcpy()
        size in the flowtable offload infrastructure.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8122b047dd18ef6e7e1c564e28f3c7067c5a2d71
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Mon Dec 2 12:03:49 2019 -0300

    tools arch x86: Sync the msr-index.h copy with the kernel sources
    
    To pick up the changes from these csets:
    
      3f3c8be973af Merge tag 'for-linus-5.5a-rc1-tag' of git://git.kernel.org/pub/scm/linux/kernel/git/xen/tip
      4e3f77d8419b ("xen/mcelog: add PPIN to record when available")
      db4d30fbb71b ("x86/bugs: Add ITLB_MULTIHIT bug infrastructure")
      1b42f017415b ("x86/speculation/taa: Add mitigation for TSX Async Abort")
      c2955f270a84 ("x86/msr: Add the IA32_TSX_CTRL MSR")
    
    These are the changes in tooling that this udpate ensues:
    
      $ tools/perf/trace/beauty/tracepoints/x86_msr.sh > /tmp/before
      $
      $ cp arch/x86/include/asm/msr-index.h tools/arch/x86/include/asm/msr-index.h
      $
      $ tools/perf/trace/beauty/tracepoints/x86_msr.sh > /tmp/after
      $ diff -u /tmp/before /tmp/after
      --- /tmp/before       2019-12-02 11:54:44.371035723 -0300
      +++ /tmp/after        2019-12-02 11:55:31.847859784 -0300
      @@ -48,6 +48,7 @@
            [0x00000119] = "IA32_BBL_CR_CTL",
            [0x0000011e] = "IA32_BBL_CR_CTL3",
            [0x00000120] = "IDT_MCR_CTRL",
      +     [0x00000122] = "IA32_TSX_CTRL",
            [0x00000140] = "MISC_FEATURES_ENABLES",
            [0x00000174] = "IA32_SYSENTER_CS",
            [0x00000175] = "IA32_SYSENTER_ESP",
      @@ -283,4 +284,6 @@
            [0xc0010240 - x86_AMD_V_KVM_MSRs_offset] = "F15H_NB_PERF_CTL",
            [0xc0010241 - x86_AMD_V_KVM_MSRs_offset] = "F15H_NB_PERF_CTR",
            [0xc0010280 - x86_AMD_V_KVM_MSRs_offset] = "F15H_PTSC",
      +     [0xc00102f0 - x86_AMD_V_KVM_MSRs_offset] = "AMD_PPIN_CTL",
      +     [0xc00102f1 - x86_AMD_V_KVM_MSRs_offset] = "AMD_PPIN",
       };
      $
    
      CC       /tmp/build/perf/trace/beauty/tracepoints/x86_msr.o
      LD       /tmp/build/perf/trace/beauty/tracepoints/perf-in.o
      LD       /tmp/build/perf/trace/beauty/perf-in.o
      LD       /tmp/build/perf/perf-in.o
    
    Now it is possible to use these strings when setting up filters for the msr:*
    tracepoints, like:
    
      # perf trace -e msr:* --filter=msr==IA32_TSX_CTRL
      ^C[root@quaco ~]#
    
    If we use an invalid operator we can check what is the filter that is put in
    place:
    
      # perf trace -e msr:* --filter=msr=IA32_TSX_CTRL
      Failed to set filter "(msr=0x122) && (common_pid != 25976 && common_pid != 25860)" on event msr:read_msr with 22 (Invalid argument)
    
    One can as well use -v to see the tracepoints and its filters:
    
      # perf trace -v -e msr:* --filter=msr==IA32_TSX_CTRL
      Using CPUID GenuineIntel-6-8E-A
      New filter for msr:read_msr: (msr==0x122) && (common_pid != 26110 && common_pid != 25860)
      New filter for msr:write_msr: (msr==0x122) && (common_pid != 26110 && common_pid != 25860)
      New filter for msr:rdpmc: (msr==0x122) && (common_pid != 26110 && common_pid != 25860)
      mmap size 528384B
      ^C#
    
    Better than keep looking up those numbers, works with callchains as
    well, e.g. for something more common:
    
      # perf trace -e msr:*/max-stack=16/ --filter="msr==IA32_SPEC_CTRL" --max-events=2
           0.000 SCTP timer/6158 msr:write_msr(msr: IA32_SPEC_CTRL, val: 6)
                                             do_trace_write_msr ([kernel.kallsyms])
                                             do_trace_write_msr ([kernel.kallsyms])
                                             __switch_to_xtra ([kernel.kallsyms])
                                             __switch_to ([kernel.kallsyms])
                                             __sched_text_start ([kernel.kallsyms])
                                             schedule ([kernel.kallsyms])
                                             schedule_hrtimeout_range_clock ([kernel.kallsyms])
                                             poll_schedule_timeout.constprop.0 ([kernel.kallsyms])
                                             do_select ([kernel.kallsyms])
                                             core_sys_select ([kernel.kallsyms])
                                             kern_select ([kernel.kallsyms])
                                             __x64_sys_select ([kernel.kallsyms])
                                             do_syscall_64 ([kernel.kallsyms])
                                             entry_SYSCALL_64 ([kernel.kallsyms])
                                             __select (/usr/lib64/libc-2.29.so)
                                             [0] ([unknown])
           0.024 :0/0 msr:write_msr(msr: IA32_SPEC_CTRL)
                                             do_trace_write_msr ([kernel.kallsyms])
                                             do_trace_write_msr ([kernel.kallsyms])
                                             __switch_to_xtra ([kernel.kallsyms])
                                             __switch_to ([kernel.kallsyms])
                                             __sched_text_start ([kernel.kallsyms])
                                             schedule_idle ([kernel.kallsyms])
                                             do_idle ([kernel.kallsyms])
                                             cpu_startup_entry ([kernel.kallsyms])
                                             start_secondary ([kernel.kallsyms])
                                             [0x2000d4] ([kernel.kallsyms])
      #
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: Jan Beulich <jbeulich@suse.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Juergen Gross <jgross@suse.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Vineela Tummalapalli <vineela.tummalapalli@intel.com>
    Link: https://lkml.kernel.org/n/tip-n1xd78fpd5lxn4q1brqi2jl6@git.kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 386403a115f95997c2715691226e11a7b5cffcfd
Merge: 642356cb5f4a 622dc5ad8052
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Nov 25 20:02:57 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next
    
    Pull networking updates from David Miller:
     "Another merge window, another pull full of stuff:
    
       1) Support alternative names for network devices, from Jiri Pirko.
    
       2) Introduce per-netns netdev notifiers, also from Jiri Pirko.
    
       3) Support MSG_PEEK in vsock/virtio, from Matias Ezequiel Vara
          Larsen.
    
       4) Allow compiling out the TLS TOE code, from Jakub Kicinski.
    
       5) Add several new tracepoints to the kTLS code, also from Jakub.
    
       6) Support set channels ethtool callback in ena driver, from Sameeh
          Jubran.
    
       7) New SCTP events SCTP_ADDR_ADDED, SCTP_ADDR_REMOVED,
          SCTP_ADDR_MADE_PRIM, and SCTP_SEND_FAILED_EVENT. From Xin Long.
    
       8) Add XDP support to mvneta driver, from Lorenzo Bianconi.
    
       9) Lots of netfilter hw offload fixes, cleanups and enhancements,
          from Pablo Neira Ayuso.
    
      10) PTP support for aquantia chips, from Egor Pomozov.
    
      11) Add UDP segmentation offload support to igb, ixgbe, and i40e. From
          Josh Hunt.
    
      12) Add smart nagle to tipc, from Jon Maloy.
    
      13) Support L2 field rewrite by TC offloads in bnxt_en, from Venkat
          Duvvuru.
    
      14) Add a flow mask cache to OVS, from Tonghao Zhang.
    
      15) Add XDP support to ice driver, from Maciej Fijalkowski.
    
      16) Add AF_XDP support to ice driver, from Krzysztof Kazimierczak.
    
      17) Support UDP GSO offload in atlantic driver, from Igor Russkikh.
    
      18) Support it in stmmac driver too, from Jose Abreu.
    
      19) Support TIPC encryption and auth, from Tuong Lien.
    
      20) Introduce BPF trampolines, from Alexei Starovoitov.
    
      21) Make page_pool API more numa friendly, from Saeed Mahameed.
    
      22) Introduce route hints to ipv4 and ipv6, from Paolo Abeni.
    
      23) Add UDP segmentation offload to cxgb4, Rahul Lakkireddy"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next: (1857 commits)
      libbpf: Fix usage of u32 in userspace code
      mm: Implement no-MMU variant of vmalloc_user_node_flags
      slip: Fix use-after-free Read in slip_open
      net: dsa: sja1105: fix sja1105_parse_rgmii_delays()
      macvlan: schedule bc_work even if error
      enetc: add support Credit Based Shaper(CBS) for hardware offload
      net: phy: add helpers phy_(un)lock_mdio_bus
      mdio_bus: don't use managed reset-controller
      ax88179_178a: add ethtool_op_get_ts_info()
      mlxsw: spectrum_router: Fix use of uninitialized adjacency index
      mlxsw: spectrum_router: After underlay moves, demote conflicting tunnels
      bpf: Simplify __bpf_arch_text_poke poke type handling
      bpf: Introduce BPF_TRACE_x helper for the tracing tests
      bpf: Add bpf_jit_blinding_enabled for !CONFIG_BPF_JIT
      bpf, testing: Add various tail call test cases
      bpf, x86: Emit patchable direct jump as tail call
      bpf: Constant map key tracking for prog array pokes
      bpf: Add poke dependency tracking for prog array maps
      bpf: Add initial poke descriptor table for jit images
      bpf: Move owner type, jited info into array auxiliary data
      ...

commit 206ff848a1abaa1755310fdb4b20a3303ccf23d9
Author: Kiran Kumar K <kirankumark@marvell.com>
Date:   Thu Nov 14 10:56:28 2019 +0530

    octeontx2-af: Add more RSS algorithms
    
    This patch adds support for few more RSS key types for flow key
    algorithm to compute rss hash index.
    
    Following flow key types have been added.
    - Tunnel types like NVGRE, VXLAN, GENEVE.
    - L2 offload type ETH_DMAC, Here we will consider only DMAC 6 bytes.
    - And extension header IPV6_EXT (1 byte followed by IPV6 header
    - Hashing inner protocol fields for inner DMAC, IPv4/v6, TCP, UDP, SCTP.
    
    Signed-off-by: Kiran Kumar K <kirankumark@marvell.com>
    Signed-off-by: Sunil Goutham <sgoutham@marvell.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 92da362c07d413786ab59db1665376fb63805586
Merge: a0c76345e3d3 d467ac0a3855
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Nov 8 14:18:32 2019 -0800

    Merge branch 'sctp-rfc7829'
    
    Xin Long says:
    
    ====================
    sctp: update from rfc7829
    
    SCTP-PF was implemented based on a Internet-Draft in 2012:
    
      https://tools.ietf.org/html/draft-nishida-tsvwg-sctp-failover-05
    
    It's been updated quite a few by rfc7829 in 2016.
    
    This patchset adds the following features:
    
      1. add SCTP_ADDR_POTENTIALLY_FAILED notification
      2. add pf_expose per netns/sock/asoc
      3. add SCTP_EXPOSE_POTENTIALLY_FAILED_STATE sockopt
      4. add ps_retrans per netns/sock/asoc/transport
         (Primary Path Switchover)
      5. add spt_pathcpthld for SCTP_PEER_ADDR_THLDS sockopt
    
    v1->v2:
      - See Patch 2/5 and Patch 5/5.
    v2->v3:
      - See Patch 1/5, 2/5 and 3/5.
    v3->v4:
      - See Patch 1/5, 2/5, 3/5 and 4/5.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d467ac0a38551a5904878b1f5a2fe20a040c0e11
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 8 13:20:36 2019 +0800

    sctp: add SCTP_PEER_ADDR_THLDS_V2 sockopt
    
    Section 7.2 of rfc7829: "Peer Address Thresholds (SCTP_PEER_ADDR_THLDS)
    Socket Option" extends 'struct sctp_paddrthlds' with 'spt_pathcpthld'
    added to allow a user to change ps_retrans per sock/asoc/transport, as
    other 2 paddrthlds: pf_retrans, pathmaxrxt.
    
    Note: to not break the user's program, here to support pf_retrans dump
    and setting by adding a new sockopt SCTP_PEER_ADDR_THLDS_V2, and a new
    structure sctp_paddrthlds_v2 instead of extending sctp_paddrthlds.
    
    Also, when setting ps_retrans, the value is not allowed to be greater
    than pf_retrans.
    
    v1->v2:
      - use SCTP_PEER_ADDR_THLDS_V2 to set/get pf_retrans instead,
        as Marcelo and David Laight suggested.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 34515e94c92c3f593cd696abca8609246cbd75e6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 8 13:20:35 2019 +0800

    sctp: add support for Primary Path Switchover
    
    This is a new feature defined in section 5 of rfc7829: "Primary Path
    Switchover". By introducing a new tunable parameter:
    
      Primary.Switchover.Max.Retrans (PSMR)
    
    The primary path will be changed to another active path when the path
    error counter on the old primary path exceeds PSMR, so that "the SCTP
    sender is allowed to continue data transmission on a new working path
    even when the old primary destination address becomes active again".
    
    This patch is to add this tunable parameter, 'ps_retrans' per netns,
    sock, asoc and transport. It also allows a user to change ps_retrans
    per netns by sysctl, and ps_retrans per sock/asoc/transport will be
    initialized with it.
    
    The check will be done in sctp_do_8_2_transport_strike() when this
    feature is enabled.
    
    Note this feature is disabled by initializing 'ps_retrans' per netns
    as 0xffff by default, and its value can't be less than 'pf_retrans'
    when changing by sysctl.
    
    v3->v4:
      - add define SCTP_PS_RETRANS_MAX 0xffff, and use it on extra2 of
        sysctl 'ps_retrans'.
      - add a new entry for ps_retrans on ip-sysctl.txt.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8d2a6935d842f12c25611b165eace778adb09a53
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 8 13:20:34 2019 +0800

    sctp: add SCTP_EXPOSE_POTENTIALLY_FAILED_STATE sockopt
    
    This is a sockopt defined in section 7.3 of rfc7829: "Exposing
    the Potentially Failed Path State", by which users can change
    pf_expose per sock and asoc.
    
    The new sockopt SCTP_EXPOSE_POTENTIALLY_FAILED_STATE is also
    known as SCTP_EXPOSE_PF_STATE for short.
    
    v2->v3:
      - return -EINVAL if params.assoc_value > SCTP_PF_EXPOSE_MAX.
      - define SCTP_EXPOSE_PF_STATE SCTP_EXPOSE_POTENTIALLY_FAILED_STATE.
    v3->v4:
      - improve changelog.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 768e15182dcb809e39c338290dda10c4e271d133
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 8 13:20:33 2019 +0800

    sctp: add SCTP_ADDR_POTENTIALLY_FAILED notification
    
    SCTP Quick failover draft section 5.1, point 5 has been removed
    from rfc7829. Instead, "the sender SHOULD (i) notify the Upper
    Layer Protocol (ULP) about this state transition", as said in
    section 3.2, point 8.
    
    So this patch is to add SCTP_ADDR_POTENTIALLY_FAILED, defined
    in section 7.1, "which is reported if the affected address
    becomes PF". Also remove transport cwnd's update when moving
    from PF back to ACTIVE , which is no longer in rfc7829 either.
    
    Note that ulp_notify will be set to false if asoc->expose is
    not 'enabled', according to last patch.
    
    v2->v3:
      - define SCTP_ADDR_PF SCTP_ADDR_POTENTIALLY_FAILED.
    v3->v4:
      - initialize spc_state with SCTP_ADDR_AVAILABLE, as Marcelo suggested.
      - check asoc->pf_expose in sctp_assoc_control_transport(), as Marcelo
        suggested.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit aef587be42925f92418083f08852d0011b2766ca
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 8 13:20:32 2019 +0800

    sctp: add pf_expose per netns and sock and asoc
    
    As said in rfc7829, section 3, point 12:
    
      The SCTP stack SHOULD expose the PF state of its destination
      addresses to the ULP as well as provide the means to notify the
      ULP of state transitions of its destination addresses from
      active to PF, and vice versa.  However, it is recommended that
      an SCTP stack implementing SCTP-PF also allows for the ULP to be
      kept ignorant of the PF state of its destinations and the
      associated state transitions, thus allowing for retention of the
      simpler state transition model of [RFC4960] in the ULP.
    
    Not only does it allow to expose the PF state to ULP, but also
    allow to ignore sctp-pf to ULP.
    
    So this patch is to add pf_expose per netns, sock and asoc. And in
    sctp_assoc_control_transport(), ulp_notify will be set to false if
    asoc->expose is not 'enabled' in next patch.
    
    It also allows a user to change pf_expose per netns by sysctl, and
    pf_expose per sock and asoc will be initialized with it.
    
    Note that pf_expose also works for SCTP_GET_PEER_ADDR_INFO sockopt,
    to not allow a user to query the state of a sctp-pf peer address
    when pf_expose is 'disabled', as said in section 7.3.
    
    v1->v2:
      - Fix a build warning noticed by Nathan Chancellor.
    v2->v3:
      - set pf_expose to UNUSED by default to keep compatible with old
        applications.
    v3->v4:
      - add a new entry for pf_expose on ip-sysctl.txt, as Marcelo suggested.
      - change this patch to 1/5, and move sctp_assoc_control_transport
        change into 2/5, as Marcelo suggested.
      - use SCTP_PF_EXPOSE_UNSET instead of SCTP_PF_EXPOSE_UNUSED, and
        set SCTP_PF_EXPOSE_UNSET to 0 in enum, as Marcelo suggested.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 39438490c9714378148f3b603f635362c8780b51
Merge: 985fd98ab5cc 70332577e4d9
Author: Jakub Kicinski <jakub.kicinski@netronome.com>
Date:   Mon Oct 21 20:16:12 2019 -0700

    Merge branch '1GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    1GbE Intel Wired LAN Driver Updates 2019-10-21
    
    This series contains updates to e1000e and igc only.
    
    Sasha adds stream control transmission protocol (SCTP) CRC checksum
    support for igc.  Also added S0ix support to the e1000e driver.  Then
    added multicast support by adding the address list to the MTA table and
    providing the option for IPv6 address for igc.  In addition, added
    receive checksum support to igc as well.  Lastly, cleaned up some code
    that was not fully implemented yet for the VLAN filter table array.
    
    v2: Dropped patch 1 & 2 from the original series.  Patch 1 is being sent
        to 'net' tree as a fix and patch 2 implementation needs to be
        re-worked.  Updated the patch to add support for S0ix to fix the
        reverse Xmas tree issues and made the entry/exit functions void
        since they constantly returned success.  All based on community
        feedback.
    v3: Cleaned up patch 4 of the series based on feedback from the
        community.  Cleaned up a stray comma in a code comment and removed
        the 'inline' of a function that would be inlined by the compiler
        anyways.
    ====================
    
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit 0ac960a8e135c902cb526903ff2ec457dfabf1b4
Author: Sasha Neftin <sasha.neftin@intel.com>
Date:   Wed Sep 11 11:17:58 2019 +0300

    igc: Add SCTP CRC checksumming functionality
    
    Add stream control transmission protocol CRC checksum.
    
    Signed-off-by: Sasha Neftin <sasha.neftin@intel.com>
    Tested-by: Aaron Brown <aaron.f.brown@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit bb91a073ed124d3f6224d8ac37ecb536c01970c1
Author: Jiri Olsa <jolsa@kernel.org>
Date:   Sun Oct 13 17:14:25 2019 +0200

    perf tools: Allow to build with -ltcmalloc
    
    By using "make TCMALLOC=1" you can enable perf to be build for usage
    with libtcmalloc.so (gperftools).
    
    Get heap profile (tools/perf directory):
    
      $ <install gperftools>
      $ make TCMALLOC=1 DEBUG=1
      $ HEAPPROFILE=/tmp/heapprof ./perf ...
      $ pprof ./perf /tmp/heapprof.000*
      (pprof) top
      Total: 2335.5 MB
        1735.1  74.3%  74.3%   1735.1  74.3% memdup
         402.0  17.2%  91.5%    402.0  17.2% zalloc
         140.2   6.0%  97.5%    145.8   6.2% map__new
          33.6   1.4%  98.9%     33.6   1.4% symbol__new
          12.4   0.5%  99.5%     12.4   0.5% alloc_event
           6.2   0.3%  99.7%      6.2   0.3% nsinfo__new
           5.5   0.2% 100.0%      5.5   0.2% nsinfo__copy
           0.3   0.0% 100.0%      0.3   0.0% dso__new
           0.1   0.0% 100.0%      0.1   0.0% do_read_string
           0.0   0.0% 100.0%      0.0   0.0% __GI__IO_file_doallocate
    
    See callstack:
      $ pprof --pdf ./perf /tmp/heapprof.00* > callstack.pdf
      $ pprof --web ./perf /tmp/heapprof.00*
    
    Committer testing:
    
    Install gperftools, on fedora:
    
      # dnf install gperftools-devel
    
    Then build:
    
     $ make TCMALLOC=1 DEBUG=1 -C tools/perf O=/tmp/build/perf install-bin
    
    Verify that it linked against the right library:
    
      $ ldd ~/bin/perf | grep tcma
            libtcmalloc.so.4 => /lib64/libtcmalloc.so.4 (0x00007fb2953a7000)
      $
    
    Run 'perf trace' system wide for 1 minute:
    
      # HEAPPROFILE=/tmp/heapprof perf trace -a sleep 1m
      <SNIP>
       59985.524 ( 0.006 ms): Web Content/20354 recvmsg(fd: 9<socket:[1762817]>, msg: 0x7ffee5fdafb0) = -1 EAGAIN (Resource temporarily unavailable)
       59985.536 ( 0.005 ms): Web Content/20354 recvmsg(fd: 9<socket:[1762817]>, msg: 0x7ffee5fdafc0) = -1 EAGAIN (Resource temporarily unavailable)
       59981.956 (10.143 ms): SCTP timer/21716  ... [continued]: select())                            = 0 (Timeout)
       59985.549 (         ): Web Content/20354 poll(ufds: 0x7f1df38af180, nfds: 3, timeout_msecs: 4294967295) ...
           0.926 (59999.481 ms): sleep/29764  ... [continued]: nanosleep())                           = 0
       59992.133 (         ): SCTP timer/21716 select(tvp: 0x7ff5bf7fee80)                            ...
       60000.477 ( 0.009 ms): sleep/29764 close(fd: 1)                                                = 0
       60000.493 ( 0.005 ms): sleep/29764 close(fd: 2)                                                = 0
       60000.514 (         ): sleep/29764 exit_group()                                                = ?
      Dumping heap profile to /tmp/heapprof.0001.heap (Exiting, 3 MB in use)
    [root@quaco ~]#
    
    Install pprof:
    
      # dnf install pprof
    
    And run it:
    
      # pprof ~/bin/perf /tmp/heapprof.0001.heap
      Using local file /root/bin/perf.
      Using local file /tmp/heapprof.0001.heap.
      Welcome to pprof!  For help, type 'help'.
      (pprof) top
      Total: 4.0 MB
           1.7  42.0%  42.0%      2.2  54.1% map__new
           0.9  23.3%  65.3%      0.9  23.3% zalloc
           0.5  11.4%  76.7%      0.5  11.4% dso__new
           0.2   5.6%  82.3%      0.3   8.5% trace__sys_enter
           0.2   4.9%  87.2%      0.2   4.9% __GI___strdup
           0.2   3.8%  91.0%      0.2   3.8% new_term
           0.1   2.2%  93.2%      0.4  10.1% __perf_pmu__new_alias
           0.0   1.0%  94.3%      0.0   1.2% event_read_fields
           0.0   0.8%  95.1%      0.0   0.8% nsinfo__new
           0.0   0.7%  95.8%      0.1   3.2% trace__read_syscall_info
      (pprof)
    
    Signed-off-by: Jiri Olsa <jolsa@kernel.org>
    Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
    Cc: Andi Kleen <ak@linux.intel.com>
    Cc: Michael Petlan <mpetlan@redhat.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Link: http://lore.kernel.org/lkml/20191013151427.11941-2-jolsa@kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit b2d8c273edfd214a5a022119841861095055a13e
Merge: 757926247836 b6e6b5f1da7e
Author: Jakub Kicinski <jakub.kicinski@netronome.com>
Date:   Wed Oct 9 17:10:44 2019 -0700

    Merge branch 'sctp-add-some-missing-events-from-rfc5061'
    
    Xin Long says:
    ====================
    There are 4 events defined in rfc5061 missed in linux sctp:
    SCTP_ADDR_ADDED, SCTP_ADDR_REMOVED, SCTP_ADDR_MADE_PRIM and
    SCTP_SEND_FAILED_EVENT.
    
    This patchset is to add them up.
    ====================
    
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit b6e6b5f1da7e8d092f86a4351802c27c0170c5a5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:27:36 2019 +0800

    sctp: add SCTP_SEND_FAILED_EVENT event
    
    This patch is to add a new event SCTP_SEND_FAILED_EVENT described in
    rfc6458#section-6.1.11. It's a update of SCTP_SEND_FAILED event:
    
      struct sctp_sndrcvinfo ssf_info is replaced with
      struct sctp_sndinfo ssfe_info in struct sctp_send_failed_event.
    
    SCTP_SEND_FAILED is being deprecated, but we don't remove it in this
    patch. Both are being processed in sctp_datamsg_destroy() when the
    corresp event flag is set.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit 5cd0b91733145be7260cf5988e25831d35e5e8fd
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:27:35 2019 +0800

    sctp: add SCTP_ADDR_MADE_PRIM event
    
    sctp_ulpevent_nofity_peer_addr_change() would be called in
    sctp_assoc_set_primary() to send SCTP_ADDR_MADE_PRIM event
    when this transport is set to the primary path of the asoc.
    
    This event is described in rfc6458#section-6.1.2:
    
      SCTP_ADDR_MADE_PRIM:  This address has now been made the primary
         destination address.  This notification is provided whenever an
         address is made primary.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit c446f50ce5f7ad116aedbdbf65e26876437f6b5a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:27:34 2019 +0800

    sctp: add SCTP_ADDR_REMOVED event
    
    sctp_ulpevent_nofity_peer_addr_change() is called in
    sctp_assoc_rm_peer() to send SCTP_ADDR_REMOVED event
    when this transport is removed from the asoc.
    
    This event is described in rfc6458#section-6.1.2:
    
      SCTP_ADDR_REMOVED:  The address is no longer part of the
         association.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit 4b7740324ed86aa4b02cef134da4b79078294d72
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:27:33 2019 +0800

    sctp: add SCTP_ADDR_ADDED event
    
    A helper sctp_ulpevent_nofity_peer_addr_change() will be extracted
    to make peer_addr_change event and enqueue it, and the helper will
    be called in sctp_assoc_add_peer() to send SCTP_ADDR_ADDED event.
    
    This event is described in rfc6458#section-6.1.2:
    
      SCTP_ADDR_ADDED:  The address is now part of the association.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit 819be8108fded0b9e710bbbf81193e52f7bab2f7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 8 19:09:23 2019 +0800

    sctp: add chunks to sk_backlog when the newsk sk_socket is not set
    
    This patch is to fix a NULL-ptr deref in selinux_socket_connect_helper:
    
      [...] kasan: GPF could be caused by NULL-ptr deref or user memory access
      [...] RIP: 0010:selinux_socket_connect_helper+0x94/0x460
      [...] Call Trace:
      [...]  selinux_sctp_bind_connect+0x16a/0x1d0
      [...]  security_sctp_bind_connect+0x58/0x90
      [...]  sctp_process_asconf+0xa52/0xfd0 [sctp]
      [...]  sctp_sf_do_asconf+0x785/0x980 [sctp]
      [...]  sctp_do_sm+0x175/0x5a0 [sctp]
      [...]  sctp_assoc_bh_rcv+0x285/0x5b0 [sctp]
      [...]  sctp_backlog_rcv+0x482/0x910 [sctp]
      [...]  __release_sock+0x11e/0x310
      [...]  release_sock+0x4f/0x180
      [...]  sctp_accept+0x3f9/0x5a0 [sctp]
      [...]  inet_accept+0xe7/0x720
    
    It was caused by that the 'newsk' sk_socket was not set before going to
    security sctp hook when processing asconf chunk with SCTP_PARAM_ADD_IP
    or SCTP_PARAM_SET_PRIMARY:
    
      inet_accept()->
        sctp_accept():
          lock_sock():
              lock listening 'sk'
                                              do_softirq():
                                                sctp_rcv():  <-- [1]
                                                    asconf chunk arrives and
                                                    enqueued in 'sk' backlog
          sctp_sock_migrate():
              set asoc's sk to 'newsk'
          release_sock():
              sctp_backlog_rcv():
                lock 'newsk'
                sctp_process_asconf()  <-- [2]
                unlock 'newsk'
        sock_graft():
            set sk_socket  <-- [3]
    
    As it shows, at [1] the asconf chunk would be put into the listening 'sk'
    backlog, as accept() was holding its sock lock. Then at [2] asconf would
    get processed with 'newsk' as asoc's sk had been set to 'newsk'. However,
    'newsk' sk_socket is not set until [3], while selinux_sctp_bind_connect()
    would deref it, then kernel crashed.
    
    Here to fix it by adding the chunk to sk_backlog until newsk sk_socket is
    set when .accept() is done.
    
    Note that sk->sk_socket can be NULL when the sock is closed, so SOCK_DEAD
    flag is also needed to check in sctp_newsk_ready().
    
    Thanks to Ondrej for reviewing the code.
    
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>

commit b4b1f8ed7290a00b05a52a165282e394a620c816
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    commit 25bff6d5478b2a02368097015b7d8eb727c87e16 upstream.
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b3873e34cbf2fb533091209aa1203338f66d5394
Author: Saeed Mahameed <saeedm@mellanox.com>
Date:   Mon Sep 23 12:40:29 2019 +0000

    net/mlx5e: Rx, Check ip headers sanity
    
    [ Upstream commit 0318a7b7fcad9765931146efa7ca3a034194737c ]
    
    In the two places is_last_ethertype_ip is being called, the caller will
    be looking inside the ip header, to be safe, add ip{4,6} header sanity
    check. And return true only on valid ip headers, i.e: the whole header
    is contained in the linear part of the skb.
    
    Note: Such situation is very rare and hard to reproduce, since mlx5e
    allocates a large enough headroom to contain the largest header one can
    imagine.
    
    Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets")
    Reported-by: Cong Wang <xiyou.wangcong@gmail.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8da68f79b3b3aaeeca2fd2ba08b9af91648a2d31
Author: Cong Wang <xiyou.wangcong@gmail.com>
Date:   Mon Sep 23 12:40:12 2019 +0000

    mlx5: fix get_ip_proto()
    
    [ Upstream commit ef6fcd455278c2be3032a346cc66d9dd9866b787 ]
    
    IP header is not necessarily located right after struct ethhdr,
    there could be multiple 802.1Q headers in between, this is why
    we call __vlan_get_protocol().
    
    Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets")
    Cc: Alaa Hleihel <alaa@mellanox.com>
    Cc: Or Gerlitz <ogerlitz@mellanox.com>
    Cc: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Acked-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 44da02576b5dd327c618ea7eebc33855f5f675d8
Author: Alaa Hleihel <alaa@mellanox.com>
Date:   Mon Sep 23 12:40:06 2019 +0000

    net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets
    
    [ Upstream commit fe1dc069990c1f290ef6b99adb46332c03258f38 ]
    
    CHECKSUM_COMPLETE is not applicable to SCTP protocol.
    Setting it for SCTP packets leads to CRC32c validation failure.
    
    Fixes: bbceefce9adf ("net/mlx5e: Support RX CHECKSUM_COMPLETE")
    Signed-off-by: Alaa Hleihel <alaa@mellanox.com>
    Reviewed-by: Or Gerlitz <ogerlitz@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f3724b27ca29953434861b5c78e3ec101c4561a3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Sep 9 15:33:29 2019 +0800

    sctp: fix the missing put_user when dumping transport thresholds
    
    [ Upstream commit f794dc2304d83ab998c2eee5bab0549aff5c53a2 ]
    
    This issue causes SCTP_PEER_ADDR_THLDS sockopt not to be able to dump
    a transport thresholds info.
    
    Fix it by adding 'goto' put_user in sctp_getsockopt_paddr_thresholds.
    
    Fixes: 8add543e369d ("sctp: add SCTP_FUTURE_ASSOC for SCTP_PEER_ADDR_THLDS sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f794dc2304d83ab998c2eee5bab0549aff5c53a2
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Sep 9 15:33:29 2019 +0800

    sctp: fix the missing put_user when dumping transport thresholds
    
    This issue causes SCTP_PEER_ADDR_THLDS sockopt not to be able to dump
    a transport thresholds info.
    
    Fix it by adding 'goto' put_user in sctp_getsockopt_paddr_thresholds.
    
    Fixes: 8add543e369d ("sctp: add SCTP_FUTURE_ASSOC for SCTP_PEER_ADDR_THLDS sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e93b4f0386621d2c6820fcafd4435c90f6fb4048
Merge: 7add83d93a94 d5886b919a72
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Aug 27 20:54:14 2019 -0700

    Merge branch 'sctp-add-SCTP_ECN_SUPPORTED-sockopt'
    
    Xin Long says:
    
    ====================
    sctp: add SCTP_ECN_SUPPORTED sockopt
    
    This patchset is to make ecn flag per netns and endpoint and then
    add SCTP_ECN_SUPPORTED sockopt, as does for other feature flags.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d5886b919a720ff859aebf569cb0f353b1d977a6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Aug 26 16:30:04 2019 +0800

    sctp: allow users to set ep ecn flag by sockopt
    
    SCTP_ECN_SUPPORTED sockopt will be added to allow users to change
    ep ecn flag, and it's similar with other feature flags.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5483ecefe9602502441b0b76968f9c4f888ad242
Merge: af809709e9df 2f7576347cf3
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Aug 19 18:27:29 2019 -0700

    Merge branch 'sctp-support-per-endpoint-auth-and-asconf-flags'
    
    Xin Long says:
    
    ====================
    sctp: support per endpoint auth and asconf flags
    
    This patchset mostly does 3 things:
    
      1. add per endpint asconf flag and use asconf flag properly
         and add SCTP_ASCONF_SUPPORTED sockopt.
      2. use auth flag properly and add SCTP_AUTH_SUPPORTED sockopt.
      3. remove the 'global feature switch' to discard chunks.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 56dd525abd56f7acd7b44a52935726e3ada4916c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Aug 19 22:02:49 2019 +0800

    sctp: add SCTP_AUTH_SUPPORTED sockopt
    
    SCTP_AUTH_SUPPORTED sockopt is used to set enpoint's auth
    flag. With this feature, each endpoint will have its own
    flag for its future asoc's auth_capable, instead of netns
    auth flag.
    
    Note that when both ep's auth_enable is enabled, endpoint
    auth related data should be initialized. If asconf_enable
    is also set, SCTP_CID_ASCONF/SCTP_CID_ASCONF_ACK should
    be added into auth_chunk_list.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 03f961270f4256fe9f47b94aea889bd26877216b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Aug 19 22:02:48 2019 +0800

    sctp: add sctp_auth_init and sctp_auth_free
    
    This patch is to factor out sctp_auth_init and sctp_auth_free
    functions, and sctp_auth_init will also be used in the next
    patch for SCTP_AUTH_SUPPORTED sockopt.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit df2c71ffdfae58961981d7cbcccea93688fc4e96
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Aug 19 22:02:46 2019 +0800

    sctp: add SCTP_ASCONF_SUPPORTED sockopt
    
    SCTP_ASCONF_SUPPORTED sockopt is used to set enpoint's asconf
    flag. With this feature, each endpoint will have its own flag
    for its future asoc's asconf_capable, instead of netns asconf
    flag.
    
    Note that when both ep's asconf_enable and auth_enable are
    enabled, SCTP_CID_ASCONF and SCTP_CID_ASCONF_ACK should be
    added into auth_chunk_list.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ef66b61b37b5e28dad11f3c3937f8be647e0e07
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    commit 273160ffc6b993c7c91627f5a84799c66dfe4dee upstream.
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 5d17c80f28dc9041b57aaa527057c5ad7b68cc41
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    commit e166e4fdaced850bee3d5ee12a5740258fb30587 upstream.
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    [bwh: Backported to 3.16: adjust filenames, context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 5e5412c365a32e452daa762eac36121cb8a370bb
Author: Qian Cai <cai@lca.pw>
Date:   Tue Jul 30 11:30:33 2019 -0400

    net/socket: fix GCC8+ Wpacked-not-aligned warnings
    
    There are a lot of those warnings with GCC8+ 64-bit,
    
    In file included from ./include/linux/sctp.h:42,
                     from net/core/skbuff.c:47:
    ./include/uapi/linux/sctp.h:395:1: warning: alignment 4 of 'struct
    sctp_paddr_change' is less than 8 [-Wpacked-not-aligned]
     } __attribute__((packed, aligned(4)));
     ^
    ./include/uapi/linux/sctp.h:728:1: warning: alignment 4 of 'struct
    sctp_setpeerprim' is less than 8 [-Wpacked-not-aligned]
     } __attribute__((packed, aligned(4)));
     ^
    ./include/uapi/linux/sctp.h:727:26: warning: 'sspp_addr' offset 4 in
    'struct sctp_setpeerprim' isn't aligned to 8 [-Wpacked-not-aligned]
      struct sockaddr_storage sspp_addr;
                              ^~~~~~~~~
    ./include/uapi/linux/sctp.h:741:1: warning: alignment 4 of 'struct
    sctp_prim' is less than 8 [-Wpacked-not-aligned]
     } __attribute__((packed, aligned(4)));
     ^
    ./include/uapi/linux/sctp.h:740:26: warning: 'ssp_addr' offset 4 in
    'struct sctp_prim' isn't aligned to 8 [-Wpacked-not-aligned]
      struct sockaddr_storage ssp_addr;
                              ^~~~~~~~
    ./include/uapi/linux/sctp.h:792:1: warning: alignment 4 of 'struct
    sctp_paddrparams' is less than 8 [-Wpacked-not-aligned]
     } __attribute__((packed, aligned(4)));
     ^
    ./include/uapi/linux/sctp.h:784:26: warning: 'spp_address' offset 4 in
    'struct sctp_paddrparams' isn't aligned to 8 [-Wpacked-not-aligned]
      struct sockaddr_storage spp_address;
                              ^~~~~~~~~~~
    ./include/uapi/linux/sctp.h:905:1: warning: alignment 4 of 'struct
    sctp_paddrinfo' is less than 8 [-Wpacked-not-aligned]
     } __attribute__((packed, aligned(4)));
     ^
    ./include/uapi/linux/sctp.h:899:26: warning: 'spinfo_address' offset 4
    in 'struct sctp_paddrinfo' isn't aligned to 8 [-Wpacked-not-aligned]
      struct sockaddr_storage spinfo_address;
                              ^~~~~~~~~~~~~~
    
    This is because the commit 20c9c825b12f ("[SCTP] Fix SCTP socket options
    to work with 32-bit apps on 64-bit kernels.") added "packed, aligned(4)"
    GCC attributes to some structures but one of the members, i.e, "struct
    sockaddr_storage" in those structures has the attribute,
    "aligned(__alignof__ (struct sockaddr *)" which is 8-byte on 64-bit
    systems, so the commit overwrites the designed alignments for
    "sockaddr_storage".
    
    To fix this, "struct sockaddr_storage" needs to be aligned to 4-byte as
    it is only used in those packed sctp structure which is part of UAPI,
    and "struct __kernel_sockaddr_storage" is used in some other
    places of UAPI that need not to change alignments in order to not
    breaking userspace.
    
    Use an implicit alignment for "struct __kernel_sockaddr_storage" so it
    can keep the same alignments as a member in both packed and un-packed
    structures without breaking UAPI.
    
    Suggested-by: David Laight <David.Laight@ACULAB.COM>
    Signed-off-by: Qian Cai <cai@lca.pw>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 92598c5db140940c1b1ef0c10894b5c9d5293930
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    [ Upstream commit 25bff6d5478b2a02368097015b7d8eb727c87e16 ]
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 17bcbe8589a7d1fece2c64d56fe8f32188441383
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    [ Upstream commit 25bff6d5478b2a02368097015b7d8eb727c87e16 ]
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 68ab5d1496a35f3a76b68fed57719bfc46a51e07
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Wed Jul 3 16:06:53 2019 +0200

    ipv6: provide and use ipv6 specific version for {recv, send}msg
    
    This will simplify indirect call wrapper invocation in the following
    patch.
    
    No functional change intended, any - out-of-tree - IPv6 user of
    inet_{recv,send}msg can keep using the existing functions.
    
    SCTP code still uses the existing version even for ipv6: as this series
    will not add ICW for SCTP, moving to the new helper would not give
    any benefit.
    
    The only other in-kernel user of inet_{recv,send}msg is
    pvcalls_conn_back_read(), but psvcalls explicitly creates only IPv4 socket,
    so no need to update that code path, too.
    
    v1 -> v2: drop inet6_{recv,send}msg declaration from header file,
       prefer ICW macro instead
    
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7af033010214f2c7cff31147d8970484d46cc14c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Jul 3 18:20:20 2019 +0800

    sctp: count data bundling sack chunk for outctrlchunks
    
    Now all ctrl chunks are counted for asoc stats.octrlchunks and net
    SCTP_MIB_OUTCTRLCHUNKS either after queuing up or bundling, other
    than the chunk maked and bundled in sctp_packet_bundle_sack, which
    caused 'outctrlchunks' not consistent with 'inctrlchunks' in peer.
    
    This issue exists since very beginning, here to fix it by increasing
    both net SCTP_MIB_OUTCTRLCHUNKS and asoc stats.octrlchunks when sack
    chunk is maked and bundled in sctp_packet_bundle_sack.
    
    Reported-by: Ja Ram Jeon <jajeon@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ee598530be89bfa12691d5df56ed2d9ba188f20b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    [ Upstream commit 25bff6d5478b2a02368097015b7d8eb727c87e16 ]
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit eeb770d6ab778941be5f2925f6a7aec137a18935
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    [ Upstream commit 25bff6d5478b2a02368097015b7d8eb727c87e16 ]
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6c616a135a6d9b8ff2f5aa65b6c0999530228058
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    [ Upstream commit 25bff6d5478b2a02368097015b7d8eb727c87e16 ]
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 25bff6d5478b2a02368097015b7d8eb727c87e16
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 25 00:21:45 2019 +0800

    sctp: change to hold sk after auth shkey is created successfully
    
    Now in sctp_endpoint_init(), it holds the sk then creates auth
    shkey. But when the creation fails, it doesn't release the sk,
    which causes a sk defcnf leak,
    
    Here to fix it by only holding the sk when auth shkey is created
    successfully.
    
    Fixes: a29a5bd4f5c3 ("[SCTP]: Implement SCTP-AUTH initializations.")
    Reported-by: syzbot+afabda3890cc2f765041@syzkaller.appspotmail.com
    Reported-by: syzbot+276ca1c77a19977c0130@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit da0f382029868806e88c046eb2560fdee7a9457c
Merge: eb7c825bf747 4fddbf8a99ee
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Jun 17 15:55:34 2019 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Lots of bug fixes here:
    
       1) Out of bounds access in __bpf_skc_lookup, from Lorenz Bauer.
    
       2) Fix rate reporting in cfg80211_calculate_bitrate_he(), from John
          Crispin.
    
       3) Use after free in psock backlog workqueue, from John Fastabend.
    
       4) Fix source port matching in fdb peer flow rule of mlx5, from Raed
          Salem.
    
       5) Use atomic_inc_not_zero() in fl6_sock_lookup(), from Eric Dumazet.
    
       6) Network header needs to be set for packet redirect in nfp, from
          John Hurley.
    
       7) Fix udp zerocopy refcnt, from Willem de Bruijn.
    
       8) Don't assume linear buffers in vxlan and geneve error handlers,
          from Stefano Brivio.
    
       9) Fix TOS matching in mlxsw, from Jiri Pirko.
    
      10) More SCTP cookie memory leak fixes, from Neil Horman.
    
      11) Fix VLAN filtering in rtl8366, from Linus Walluij.
    
      12) Various TCP SACK payload size and fragmentation memory limit fixes
          from Eric Dumazet.
    
      13) Use after free in pneigh_get_next(), also from Eric Dumazet.
    
      14) LAPB control block leak fix from Jeremy Sowden"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (145 commits)
      lapb: fixed leak of control-blocks.
      tipc: purge deferredq list for each grp member in tipc_group_delete
      ax25: fix inconsistent lock state in ax25_destroy_timer
      neigh: fix use-after-free read in pneigh_get_next
      tcp: fix compile error if !CONFIG_SYSCTL
      hv_sock: Suppress bogus "may be used uninitialized" warnings
      be2net: Fix number of Rx queues used for flow hashing
      net: handle 802.1P vlan 0 packets properly
      tcp: enforce tcp_min_snd_mss in tcp_mtu_probing()
      tcp: add tcp_min_snd_mss sysctl
      tcp: tcp_fragment() should apply sane memory limits
      tcp: limit payload size of sacked skbs
      Revert "net: phylink: set the autoneg state in phylink_phy_change"
      bpf: fix nested bpf tracepoints with per-cpu data
      bpf: Fix out of bounds memory access in bpf_sk_storage
      vsock/virtio: set SOCK_DONE on peer shutdown
      net: dsa: rtl8366: Fix up VLAN filtering
      net: phylink: set the autoneg state in phylink_phy_change
      net: add high_order_alloc_disable sysctl/static key
      tcp: add tcp_tx_skb_cache sysctl
      ...

commit 9c7db5004280767566e91a33445bf93aa479ef02
Merge: 2c1212de6f97 05174c95b83f
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue May 21 12:51:20 2019 -0700

    Merge tag 'selinux-pr-20190521' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull SELinux fix from Paul Moore:
     "One small SELinux patch to fix a problem when disconnecting a SCTP
      socket with connect(AF_UNSPEC)"
    
    * tag 'selinux-pr-20190521' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      selinux: do not report error on connect(AF_UNSPEC)

commit 6e361910119b67d3281c0b2d00f72e43f08ac100
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    [ Upstream commit e166e4fdaced850bee3d5ee12a5740258fb30587 ]
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin (Microsoft) <sashal@kernel.org>

commit dfdfad3d188f6c524c06b469d3bbfe6af5004f71
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Wed May 8 15:32:51 2019 +0200

    selinux: do not report error on connect(AF_UNSPEC)
    
    [ Upstream commit c7e0d6cca86581092cbbf2cd868b3601495554cf ]
    
    calling connect(AF_UNSPEC) on an already connected TCP socket is an
    established way to disconnect() such socket. After commit 68741a8adab9
    ("selinux: Fix ltp test connect-syscall failure") it no longer works
    and, in the above scenario connect() fails with EAFNOSUPPORT.
    
    Fix the above falling back to the generic/old code when the address family
    is not AF_INET{4,6}, but leave the SCTP code path untouched, as it has
    specific constraints.
    
    Fixes: 68741a8adab9 ("selinux: Fix ltp test connect-syscall failure")
    Reported-by: Tom Deseyn <tdeseyn@redhat.com>
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit be6a9818866dce876f65e7fba6030eabfca9721c
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Wed May 8 15:32:51 2019 +0200

    selinux: do not report error on connect(AF_UNSPEC)
    
    [ Upstream commit c7e0d6cca86581092cbbf2cd868b3601495554cf ]
    
    calling connect(AF_UNSPEC) on an already connected TCP socket is an
    established way to disconnect() such socket. After commit 68741a8adab9
    ("selinux: Fix ltp test connect-syscall failure") it no longer works
    and, in the above scenario connect() fails with EAFNOSUPPORT.
    
    Fix the above falling back to the generic/old code when the address family
    is not AF_INET{4,6}, but leave the SCTP code path untouched, as it has
    specific constraints.
    
    Fixes: 68741a8adab9 ("selinux: Fix ltp test connect-syscall failure")
    Reported-by: Tom Deseyn <tdeseyn@redhat.com>
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 17617cd5557ac5b82b3d7da71772e02f2258805b
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Wed May 8 15:32:51 2019 +0200

    selinux: do not report error on connect(AF_UNSPEC)
    
    [ Upstream commit c7e0d6cca86581092cbbf2cd868b3601495554cf ]
    
    calling connect(AF_UNSPEC) on an already connected TCP socket is an
    established way to disconnect() such socket. After commit 68741a8adab9
    ("selinux: Fix ltp test connect-syscall failure") it no longer works
    and, in the above scenario connect() fails with EAFNOSUPPORT.
    
    Fix the above falling back to the generic/old code when the address family
    is not AF_INET{4,6}, but leave the SCTP code path untouched, as it has
    specific constraints.
    
    Fixes: 68741a8adab9 ("selinux: Fix ltp test connect-syscall failure")
    Reported-by: Tom Deseyn <tdeseyn@redhat.com>
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c7e0d6cca86581092cbbf2cd868b3601495554cf
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Wed May 8 15:32:51 2019 +0200

    selinux: do not report error on connect(AF_UNSPEC)
    
    calling connect(AF_UNSPEC) on an already connected TCP socket is an
    established way to disconnect() such socket. After commit 68741a8adab9
    ("selinux: Fix ltp test connect-syscall failure") it no longer works
    and, in the above scenario connect() fails with EAFNOSUPPORT.
    
    Fix the above falling back to the generic/old code when the address family
    is not AF_INET{4,6}, but leave the SCTP code path untouched, as it has
    specific constraints.
    
    Fixes: 68741a8adab9 ("selinux: Fix ltp test connect-syscall failure")
    Reported-by: Tom Deseyn <tdeseyn@redhat.com>
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a5d0034533de766dc3b908da43b172d5d3c295a6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Apr 29 14:16:19 2019 +0800

    sctp: avoid running the sctp state machine recursively
    
    [ Upstream commit fbd019737d71e405f86549fd738f81e2ff3dd073 ]
    
    Ying triggered a call trace when doing an asconf testing:
    
      BUG: scheduling while atomic: swapper/12/0/0x10000100
      Call Trace:
       <IRQ>  [<ffffffffa4375904>] dump_stack+0x19/0x1b
       [<ffffffffa436fcaf>] __schedule_bug+0x64/0x72
       [<ffffffffa437b93a>] __schedule+0x9ba/0xa00
       [<ffffffffa3cd5326>] __cond_resched+0x26/0x30
       [<ffffffffa437bc4a>] _cond_resched+0x3a/0x50
       [<ffffffffa3e22be8>] kmem_cache_alloc_node+0x38/0x200
       [<ffffffffa423512d>] __alloc_skb+0x5d/0x2d0
       [<ffffffffc0995320>] sctp_packet_transmit+0x610/0xa20 [sctp]
       [<ffffffffc098510e>] sctp_outq_flush+0x2ce/0xc00 [sctp]
       [<ffffffffc098646c>] sctp_outq_uncork+0x1c/0x20 [sctp]
       [<ffffffffc0977338>] sctp_cmd_interpreter.isra.22+0xc8/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc099443d>] sctp_primitive_ASCONF+0x3d/0x50 [sctp]
       [<ffffffffc0977384>] sctp_cmd_interpreter.isra.22+0x114/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc097b3a4>] sctp_assoc_bh_rcv+0xf4/0x1b0 [sctp]
       [<ffffffffc09840f1>] sctp_inq_push+0x51/0x70 [sctp]
       [<ffffffffc099732b>] sctp_rcv+0xa8b/0xbd0 [sctp]
    
    As it shows, the first sctp_do_sm() running under atomic context (NET_RX
    softirq) invoked sctp_primitive_ASCONF() that uses GFP_KERNEL flag later,
    and this flag is supposed to be used in non-atomic context only. Besides,
    sctp_do_sm() was called recursively, which is not expected.
    
    Vlad tried to fix this recursive call in Commit c0786693404c ("sctp: Fix
    oops when sending queued ASCONF chunks") by introducing a new command
    SCTP_CMD_SEND_NEXT_ASCONF. But it didn't work as this command is still
    used in the first sctp_do_sm() call, and sctp_primitive_ASCONF() will
    be called in this command again.
    
    To avoid calling sctp_do_sm() recursively, we send the next queued ASCONF
    not by sctp_primitive_ASCONF(), but by sctp_sf_do_prm_asconf() in the 1st
    sctp_do_sm() directly.
    
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 80f232121b69cc69a31ccb2b38c1665d770b0710
Merge: 82efe4395994 a9e41a529681
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue May 7 22:03:58 2019 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Highlights:
    
       1) Support AES128-CCM ciphers in kTLS, from Vakul Garg.
    
       2) Add fib_sync_mem to control the amount of dirty memory we allow to
          queue up between synchronize RCU calls, from David Ahern.
    
       3) Make flow classifier more lockless, from Vlad Buslov.
    
       4) Add PHY downshift support to aquantia driver, from Heiner
          Kallweit.
    
       5) Add SKB cache for TCP rx and tx, from Eric Dumazet. This reduces
          contention on SLAB spinlocks in heavy RPC workloads.
    
       6) Partial GSO offload support in XFRM, from Boris Pismenny.
    
       7) Add fast link down support to ethtool, from Heiner Kallweit.
    
       8) Use siphash for IP ID generator, from Eric Dumazet.
    
       9) Pull nexthops even further out from ipv4/ipv6 routes and FIB
          entries, from David Ahern.
    
      10) Move skb->xmit_more into a per-cpu variable, from Florian
          Westphal.
    
      11) Improve eBPF verifier speed and increase maximum program size,
          from Alexei Starovoitov.
    
      12) Eliminate per-bucket spinlocks in rhashtable, and instead use bit
          spinlocks. From Neil Brown.
    
      13) Allow tunneling with GUE encap in ipvs, from Jacky Hu.
    
      14) Improve link partner cap detection in generic PHY code, from
          Heiner Kallweit.
    
      15) Add layer 2 encap support to bpf_skb_adjust_room(), from Alan
          Maguire.
    
      16) Remove SKB list implementation assumptions in SCTP, your's truly.
    
      17) Various cleanups, optimizations, and simplifications in r8169
          driver. From Heiner Kallweit.
    
      18) Add memory accounting on TX and RX path of SCTP, from Xin Long.
    
      19) Switch PHY drivers over to use dynamic featue detection, from
          Heiner Kallweit.
    
      20) Support flow steering without masking in dpaa2-eth, from Ioana
          Ciocoi.
    
      21) Implement ndo_get_devlink_port in netdevsim driver, from Jiri
          Pirko.
    
      22) Increase the strict parsing of current and future netlink
          attributes, also export such policies to userspace. From Johannes
          Berg.
    
      23) Allow DSA tag drivers to be modular, from Andrew Lunn.
    
      24) Remove legacy DSA probing support, also from Andrew Lunn.
    
      25) Allow ll_temac driver to be used on non-x86 platforms, from Esben
          Haabendal.
    
      26) Add a generic tracepoint for TX queue timeouts to ease debugging,
          from Cong Wang.
    
      27) More indirect call optimizations, from Paolo Abeni"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1763 commits)
      cxgb4: Fix error path in cxgb4_init_module
      net: phy: improve pause mode reporting in phy_print_status
      dt-bindings: net: Fix a typo in the phy-mode list for ethernet bindings
      net: macb: Change interrupt and napi enable order in open
      net: ll_temac: Improve error message on error IRQ
      net/sched: remove block pointer from common offload structure
      net: ethernet: support of_get_mac_address new ERR_PTR error
      net: usb: smsc: fix warning reported by kbuild test robot
      staging: octeon-ethernet: Fix of_get_mac_address ERR_PTR check
      net: dsa: support of_get_mac_address new ERR_PTR error
      net: dsa: sja1105: Fix status initialization in sja1105_get_ethtool_stats
      vrf: sit mtu should not be updated when vrf netdev is the link
      net: dsa: Fix error cleanup path in dsa_init_module
      l2tp: Fix possible NULL pointer dereference
      taprio: add null check on sched_nest to avoid potential null pointer dereference
      net: mvpp2: cls: fix less than zero check on a u32 variable
      net_sched: sch_fq: handle non connected flows
      net_sched: sch_fq: do not assume EDT packets are ordered
      net: hns3: use devm_kcalloc when allocating desc_cb
      net: hns3: some cleanup for struct hns3_enet_ring
      ...

commit 484d404fdc2a64261f95692d7e242ec717e4ea7b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Apr 29 14:16:19 2019 +0800

    sctp: avoid running the sctp state machine recursively
    
    [ Upstream commit fbd019737d71e405f86549fd738f81e2ff3dd073 ]
    
    Ying triggered a call trace when doing an asconf testing:
    
      BUG: scheduling while atomic: swapper/12/0/0x10000100
      Call Trace:
       <IRQ>  [<ffffffffa4375904>] dump_stack+0x19/0x1b
       [<ffffffffa436fcaf>] __schedule_bug+0x64/0x72
       [<ffffffffa437b93a>] __schedule+0x9ba/0xa00
       [<ffffffffa3cd5326>] __cond_resched+0x26/0x30
       [<ffffffffa437bc4a>] _cond_resched+0x3a/0x50
       [<ffffffffa3e22be8>] kmem_cache_alloc_node+0x38/0x200
       [<ffffffffa423512d>] __alloc_skb+0x5d/0x2d0
       [<ffffffffc0995320>] sctp_packet_transmit+0x610/0xa20 [sctp]
       [<ffffffffc098510e>] sctp_outq_flush+0x2ce/0xc00 [sctp]
       [<ffffffffc098646c>] sctp_outq_uncork+0x1c/0x20 [sctp]
       [<ffffffffc0977338>] sctp_cmd_interpreter.isra.22+0xc8/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc099443d>] sctp_primitive_ASCONF+0x3d/0x50 [sctp]
       [<ffffffffc0977384>] sctp_cmd_interpreter.isra.22+0x114/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc097b3a4>] sctp_assoc_bh_rcv+0xf4/0x1b0 [sctp]
       [<ffffffffc09840f1>] sctp_inq_push+0x51/0x70 [sctp]
       [<ffffffffc099732b>] sctp_rcv+0xa8b/0xbd0 [sctp]
    
    As it shows, the first sctp_do_sm() running under atomic context (NET_RX
    softirq) invoked sctp_primitive_ASCONF() that uses GFP_KERNEL flag later,
    and this flag is supposed to be used in non-atomic context only. Besides,
    sctp_do_sm() was called recursively, which is not expected.
    
    Vlad tried to fix this recursive call in Commit c0786693404c ("sctp: Fix
    oops when sending queued ASCONF chunks") by introducing a new command
    SCTP_CMD_SEND_NEXT_ASCONF. But it didn't work as this command is still
    used in the first sctp_do_sm() call, and sctp_primitive_ASCONF() will
    be called in this command again.
    
    To avoid calling sctp_do_sm() recursively, we send the next queued ASCONF
    not by sctp_primitive_ASCONF(), but by sctp_sf_do_prm_asconf() in the 1st
    sctp_do_sm() directly.
    
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b563e9bbabfeddf6d4da3b99e27b337778083018
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Apr 29 14:16:19 2019 +0800

    sctp: avoid running the sctp state machine recursively
    
    [ Upstream commit fbd019737d71e405f86549fd738f81e2ff3dd073 ]
    
    Ying triggered a call trace when doing an asconf testing:
    
      BUG: scheduling while atomic: swapper/12/0/0x10000100
      Call Trace:
       <IRQ>  [<ffffffffa4375904>] dump_stack+0x19/0x1b
       [<ffffffffa436fcaf>] __schedule_bug+0x64/0x72
       [<ffffffffa437b93a>] __schedule+0x9ba/0xa00
       [<ffffffffa3cd5326>] __cond_resched+0x26/0x30
       [<ffffffffa437bc4a>] _cond_resched+0x3a/0x50
       [<ffffffffa3e22be8>] kmem_cache_alloc_node+0x38/0x200
       [<ffffffffa423512d>] __alloc_skb+0x5d/0x2d0
       [<ffffffffc0995320>] sctp_packet_transmit+0x610/0xa20 [sctp]
       [<ffffffffc098510e>] sctp_outq_flush+0x2ce/0xc00 [sctp]
       [<ffffffffc098646c>] sctp_outq_uncork+0x1c/0x20 [sctp]
       [<ffffffffc0977338>] sctp_cmd_interpreter.isra.22+0xc8/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc099443d>] sctp_primitive_ASCONF+0x3d/0x50 [sctp]
       [<ffffffffc0977384>] sctp_cmd_interpreter.isra.22+0x114/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc097b3a4>] sctp_assoc_bh_rcv+0xf4/0x1b0 [sctp]
       [<ffffffffc09840f1>] sctp_inq_push+0x51/0x70 [sctp]
       [<ffffffffc099732b>] sctp_rcv+0xa8b/0xbd0 [sctp]
    
    As it shows, the first sctp_do_sm() running under atomic context (NET_RX
    softirq) invoked sctp_primitive_ASCONF() that uses GFP_KERNEL flag later,
    and this flag is supposed to be used in non-atomic context only. Besides,
    sctp_do_sm() was called recursively, which is not expected.
    
    Vlad tried to fix this recursive call in Commit c0786693404c ("sctp: Fix
    oops when sending queued ASCONF chunks") by introducing a new command
    SCTP_CMD_SEND_NEXT_ASCONF. But it didn't work as this command is still
    used in the first sctp_do_sm() call, and sctp_primitive_ASCONF() will
    be called in this command again.
    
    To avoid calling sctp_do_sm() recursively, we send the next queued ASCONF
    not by sctp_primitive_ASCONF(), but by sctp_sf_do_prm_asconf() in the 1st
    sctp_do_sm() directly.
    
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit eb213c54aaacbad41496302d805c9522a85c2d61
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    [ Upstream commit e166e4fdaced850bee3d5ee12a5740258fb30587 ]
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin (Microsoft) <sashal@kernel.org>

commit a5374a3086d65af1282a196f8303ca4b2ec635a7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    [ Upstream commit e166e4fdaced850bee3d5ee12a5740258fb30587 ]
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin (Microsoft) <sashal@kernel.org>

commit 208decebe101968ea9a9069b32c3f9883ac2298f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    [ Upstream commit e166e4fdaced850bee3d5ee12a5740258fb30587 ]
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin (Microsoft) <sashal@kernel.org>

commit 1ca3379d9613a4ec261c1e8f7aafa64039147d7b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    [ Upstream commit e166e4fdaced850bee3d5ee12a5740258fb30587 ]
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin (Microsoft) <sashal@kernel.org>

commit ea9866793d1e925b4d320eaea409263b2a568f38
Merge: 5ce3307b6d9d 4dd2b82d5adf
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu May 2 11:03:34 2019 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Out of bounds access in xfrm IPSEC policy unlink, from Yue Haibing.
    
     2) Missing length check for esp4 UDP encap, from Sabrina Dubroca.
    
     3) Fix byte order of RX STBC access in mac80211, from Johannes Berg.
    
     4) Inifnite loop in bpftool map create, from Alban Crequy.
    
     5) Register mark fix in ebpf verifier after pkt/null checks, from Paul
        Chaignon.
    
     6) Properly use rcu_dereference_sk_user_data in L2TP code, from Eric
        Dumazet.
    
     7) Buffer overrun in marvell phy driver, from Andrew Lunn.
    
     8) Several crash and statistics handling fixes to bnxt_en driver, from
        Michael Chan and Vasundhara Volam.
    
     9) Several fixes to the TLS layer from Jakub Kicinski (copying negative
        amounts of data in reencrypt, reencrypt frag copying, blind nskb->sk
        NULL deref, etc).
    
    10) Several UDP GRO fixes, from Paolo Abeni and Eric Dumazet.
    
    11) PID/UID checks on ipv6 flow labels are inverted, from Willem de
        Bruijn.
    
    12) Use after free in l2tp, from Eric Dumazet.
    
    13) IPV6 route destroy races, also from Eric Dumazet.
    
    14) SCTP state machine can erroneously run recursively, fix from Xin
        Long.
    
    15) Adjust AF_PACKET msg_name length checks, add padding bytes if
        necessary. From Willem de Bruijn.
    
    16) Preserve skb_iif, so that forwarded packets have consistent values
        even if fragmentation is involved. From Shmulik Ladkani.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (69 commits)
      udp: fix GRO packet of death
      ipv6: A few fixes on dereferencing rt->from
      rds: ib: force endiannes annotation
      selftests: fib_rule_tests: print the result and return 1 if any tests failed
      ipv4: ip_do_fragment: Preserve skb_iif during fragmentation
      net/tls: avoid NULL pointer deref on nskb->sk in fallback
      selftests: fib_rule_tests: Fix icmp proto with ipv6
      packet: validate msg_namelen in send directly
      packet: in recvmsg msg_name return at least sizeof sockaddr_ll
      sctp: avoid running the sctp state machine recursively
      stmmac: pci: Fix typo in IOT2000 comment
      Documentation: fix netdev-FAQ.rst markup warning
      ipv6: fix races in ip6_dst_destroy()
      l2ip: fix possible use-after-free
      appletalk: Set error code if register_snap_client failed
      net: dsa: bcm_sf2: fix buffer overflow doing set_rxnfc
      rxrpc: Fix net namespace cleanup
      ipv6/flowlabel: wait rcu grace period before put_pid()
      vrf: Use orig netdev to count Ip6InNoRoutes and a fresh route lookup when sending dest unreach
      tcp: add sanity tests in tcp_add_backlog()
      ...

commit fbd019737d71e405f86549fd738f81e2ff3dd073
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Apr 29 14:16:19 2019 +0800

    sctp: avoid running the sctp state machine recursively
    
    Ying triggered a call trace when doing an asconf testing:
    
      BUG: scheduling while atomic: swapper/12/0/0x10000100
      Call Trace:
       <IRQ>  [<ffffffffa4375904>] dump_stack+0x19/0x1b
       [<ffffffffa436fcaf>] __schedule_bug+0x64/0x72
       [<ffffffffa437b93a>] __schedule+0x9ba/0xa00
       [<ffffffffa3cd5326>] __cond_resched+0x26/0x30
       [<ffffffffa437bc4a>] _cond_resched+0x3a/0x50
       [<ffffffffa3e22be8>] kmem_cache_alloc_node+0x38/0x200
       [<ffffffffa423512d>] __alloc_skb+0x5d/0x2d0
       [<ffffffffc0995320>] sctp_packet_transmit+0x610/0xa20 [sctp]
       [<ffffffffc098510e>] sctp_outq_flush+0x2ce/0xc00 [sctp]
       [<ffffffffc098646c>] sctp_outq_uncork+0x1c/0x20 [sctp]
       [<ffffffffc0977338>] sctp_cmd_interpreter.isra.22+0xc8/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc099443d>] sctp_primitive_ASCONF+0x3d/0x50 [sctp]
       [<ffffffffc0977384>] sctp_cmd_interpreter.isra.22+0x114/0x1460 [sctp]
       [<ffffffffc0976ad1>] sctp_do_sm+0xe1/0x350 [sctp]
       [<ffffffffc097b3a4>] sctp_assoc_bh_rcv+0xf4/0x1b0 [sctp]
       [<ffffffffc09840f1>] sctp_inq_push+0x51/0x70 [sctp]
       [<ffffffffc099732b>] sctp_rcv+0xa8b/0xbd0 [sctp]
    
    As it shows, the first sctp_do_sm() running under atomic context (NET_RX
    softirq) invoked sctp_primitive_ASCONF() that uses GFP_KERNEL flag later,
    and this flag is supposed to be used in non-atomic context only. Besides,
    sctp_do_sm() was called recursively, which is not expected.
    
    Vlad tried to fix this recursive call in Commit c0786693404c ("sctp: Fix
    oops when sending queued ASCONF chunks") by introducing a new command
    SCTP_CMD_SEND_NEXT_ASCONF. But it didn't work as this command is still
    used in the first sctp_do_sm() call, and sctp_primitive_ASCONF() will
    be called in this command again.
    
    To avoid calling sctp_do_sm() recursively, we send the next queued ASCONF
    not by sctp_primitive_ASCONF(), but by sctp_sf_do_prm_asconf() in the 1st
    sctp_do_sm() directly.
    
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit abe4a1328a7838685aa551c1529f9d01f1fafab1
Author: Or Gerlitz <ogerlitz@mellanox.com>
Date:   Sun Mar 31 12:53:03 2019 +0000

    Revert "net/mlx5e: Enable reporting checksum unnecessary also for L3 packets"
    
    [ Upstream commit 8c8811d46d00d119ffbe039a6e52a0b504df1c2c ]
    
    This reverts commit b820e6fb0978f9c2ac438c199d2bb2f35950e9c9.
    
    Prior the commit we are reverting, checksum unnecessary was only set when
    both the L3 OK and L4 OK bits are set on the CQE. This caused packets
    of IP protocols such as SCTP which are not dealt by the current HW L4
    parser (hence the L4 OK bit is not set, but the L4 header type none bit
    is set) to go through the checksum none code, where currently we wrongly
    report checksum unnecessary for them, a regression. Fix this by a revert.
    
    Note that on our usual track we report checksum complete, so the revert
    isn't expected to have any notable performance impact. Also, when we are
    not on the checksum complete track, the L4 protocols for which we report
    checksum none are not high performance ones, we will still report
    checksum unnecessary for UDP/TCP.
    
    Fixes: b820e6fb0978 ("net/mlx5e: Enable reporting checksum unnecessary also for L3 packets")
    Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
    Reported-by: Avi Urman <aviu@mellanox.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit acf4d270942ad4d5e03e56e6c265594f1dc99d41
Author: Saeed Mahameed <saeedm@mellanox.com>
Date:   Mon Mar 25 22:10:59 2019 -0700

    net/mlx5e: Rx, Check ip headers sanity
    
    [ Upstream commit 0318a7b7fcad9765931146efa7ca3a034194737c ]
    
    In the two places is_last_ethertype_ip is being called, the caller will
    be looking inside the ip header, to be safe, add ip{4,6} header sanity
    check. And return true only on valid ip headers, i.e: the whole header
    is contained in the linear part of the skb.
    
    Note: Such situation is very rare and hard to reproduce, since mlx5e
    allocates a large enough headroom to contain the largest header one can
    imagine.
    
    Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets")
    Reported-by: Cong Wang <xiyou.wangcong@gmail.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8af9f7291e22d165ea630856da4171a9d5a6ced3
Merge: 9994677c968e 013b96ec6461
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Apr 11 21:33:37 2019 -0700

    Merge branch 'sctp-skb-list'
    
    David Miller says:
    
    ====================
    SCTP: Event skb list overhaul.
    
    This patch series eliminates the explicit reference to the skb list
    implementation via skb->prev dereferences.
    
    The approach used is to pass a non-empty skb list around instead of an
    event skb object which may or may not be on a list.
    
    I'd like to thank Marcelo Leitner, Xin Long, and Neil Horman for
    reviewing previous versions of this series.
    
    Testing would be very much appreciated, in addition to the review of
    course.
    
    v4 --> v5: Rebase to net-next
    
    v3 --> v4: Fix the logic in patch #4 so that we don't miss cases
               where we should add event to the on-stack temp list.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8c8811d46d00d119ffbe039a6e52a0b504df1c2c
Author: Or Gerlitz <ogerlitz@mellanox.com>
Date:   Sun Mar 31 12:53:03 2019 +0000

    Revert "net/mlx5e: Enable reporting checksum unnecessary also for L3 packets"
    
    This reverts commit b820e6fb0978f9c2ac438c199d2bb2f35950e9c9.
    
    Prior the commit we are reverting, checksum unnecessary was only set when
    both the L3 OK and L4 OK bits are set on the CQE. This caused packets
    of IP protocols such as SCTP which are not dealt by the current HW L4
    parser (hence the L4 OK bit is not set, but the L4 header type none bit
    is set) to go through the checksum none code, where currently we wrongly
    report checksum unnecessary for them, a regression. Fix this by a revert.
    
    Note that on our usual track we report checksum complete, so the revert
    isn't expected to have any notable performance impact. Also, when we are
    not on the checksum complete track, the L4 protocols for which we report
    checksum none are not high performance ones, we will still report
    checksum unnecessary for UDP/TCP.
    
    Fixes: b820e6fb0978 ("net/mlx5e: Enable reporting checksum unnecessary also for L3 packets")
    Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
    Reported-by: Avi Urman <aviu@mellanox.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>

commit 0318a7b7fcad9765931146efa7ca3a034194737c
Author: Saeed Mahameed <saeedm@mellanox.com>
Date:   Mon Mar 25 22:10:59 2019 -0700

    net/mlx5e: Rx, Check ip headers sanity
    
    In the two places is_last_ethertype_ip is being called, the caller will
    be looking inside the ip header, to be safe, add ip{4,6} header sanity
    check. And return true only on valid ip headers, i.e: the whole header
    is contained in the linear part of the skb.
    
    Note: Such situation is very rare and hard to reproduce, since mlx5e
    allocates a large enough headroom to contain the largest header one can
    imagine.
    
    Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets")
    Reported-by: Cong Wang <xiyou.wangcong@gmail.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>

commit 0548740e53e6fe674f850d36db51eccb0557d938
Merge: 8e22ba96d44c bbd669a868bb
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Apr 4 18:07:12 2019 -1000

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Several hash table refcount fixes in batman-adv, from Sven
        Eckelmann.
    
     2) Use after free in bpf_evict_inode(), from Daniel Borkmann.
    
     3) Fix mdio bus registration in ixgbe, from Ivan Vecera.
    
     4) Unbounded loop in __skb_try_recv_datagram(), from Paolo Abeni.
    
     5) ila rhashtable corruption fix from Herbert Xu.
    
     6) Don't allow upper-devices to be added to vrf devices, from Sabrina
        Dubroca.
    
     7) Add qmi_wwan device ID for Olicard 600, from Bjrn Mork.
    
     8) Don't leave skb->next poisoned in __netif_receive_skb_list_ptype,
        from Alexander Lobakin.
    
     9) Missing IDR checks in mlx5 driver, from Aditya Pakki.
    
    10) Fix false connection termination in ktls, from Jakub Kicinski.
    
    11) Work around some ASPM issues with r8169 by disabling rx interrupt
        coalescing on certain chips. From Heiner Kallweit.
    
    12) Properly use per-cpu qstat values on NOLOCK qdiscs, from Paolo
        Abeni.
    
    13) Fully initialize sockaddr_in structures in SCTP, from Xin Long.
    
    14) Various BPF flow dissector fixes from Stanislav Fomichev.
    
    15) Divide by zero in act_sample, from Davide Caratti.
    
    16) Fix bridging multicast regression introduced by rhashtable
        conversion, from Nikolay Aleksandrov.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (106 commits)
      ibmvnic: Fix completion structure initialization
      ipv6: sit: reset ip header pointer in ipip6_rcv
      net: bridge: always clear mcast matching struct on reports and leaves
      libcxgb: fix incorrect ppmax calculation
      vlan: conditional inclusion of FCoE hooks to match netdevice.h and bnx2x
      sch_cake: Make sure we can write the IP header before changing DSCP bits
      sch_cake: Use tc_skb_protocol() helper for getting packet protocol
      tcp: Ensure DCTCP reacts to losses
      net/sched: act_sample: fix divide by zero in the traffic path
      net: thunderx: fix NULL pointer dereference in nicvf_open/nicvf_stop
      net: hns: Fix sparse: some warnings in HNS drivers
      net: hns: Fix WARNING when remove HNS driver with SMMU enabled
      net: hns: fix ICMP6 neighbor solicitation messages discard problem
      net: hns: Fix probabilistic memory overwrite when HNS driver initialized
      net: hns: Use NAPI_POLL_WEIGHT for hns driver
      net: hns: fix KASAN: use-after-free in hns_nic_net_xmit_hw()
      flow_dissector: rst'ify documentation
      ipv6: Fix dangling pointer when ipv6 fragment
      net-gro: Fix GRO flush when receiving a GSO packet.
      flow_dissector: document BPF flow dissector environment
      ...

commit d2af0ce54b1cbc82813b388b759877a2c6e53265
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97265479d7cadf5fa6597ee74371d3d21d2e8f94
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d75259910db799b3db39d870c00eda72b74535f7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4f05457010d17012a3af167539f54c68ce6a68cc
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 981cb03ec5a650c9ea06a3f7a7d316be1e0f00f1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8567f315cdb59609e377d6356efce9dcd9931fb0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    [ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1a9df9e29c2afecf6e3089442d429b377279ca3c
Merge: 14c741de9386 8c838f53e149
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Mar 27 12:22:57 2019 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Fixes here and there, a couple new device IDs, as usual:
    
       1) Fix BQL race in dpaa2-eth driver, from Ioana Ciornei.
    
       2) Fix 64-bit division in iwlwifi, from Arnd Bergmann.
    
       3) Fix documentation for some eBPF helpers, from Quentin Monnet.
    
       4) Some UAPI bpf header sync with tools, also from Quentin Monnet.
    
       5) Set descriptor ownership bit at the right time for jumbo frames in
          stmmac driver, from Aaro Koskinen.
    
       6) Set IFF_UP properly in tun driver, from Eric Dumazet.
    
       7) Fix load/store doubleword instruction generation in powerpc eBPF
          JIT, from Naveen N. Rao.
    
       8) nla_nest_start() return value checks all over, from Kangjie Lu.
    
       9) Fix asoc_id handling in SCTP after the SCTP_*_ASSOC changes this
          merge window. From Marcelo Ricardo Leitner and Xin Long.
    
      10) Fix memory corruption with large MTUs in stmmac, from Aaro
          Koskinen.
    
      11) Do not use ipv4 header for ipv6 flows in TCP and DCCP, from Eric
          Dumazet.
    
      12) Fix topology subscription cancellation in tipc, from Erik Hugne.
    
      13) Memory leak in genetlink error path, from Yue Haibing.
    
      14) Valid control actions properly in packet scheduler, from Davide
          Caratti.
    
      15) Even if we get EEXIST, we still need to rehash if a shrink was
          delayed. From Herbert Xu.
    
      16) Fix interrupt mask handling in interrupt handler of r8169, from
          Heiner Kallweit.
    
      17) Fix leak in ehea driver, from Wen Yang"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (168 commits)
      dpaa2-eth: fix race condition with bql frame accounting
      chelsio: use BUG() instead of BUG_ON(1)
      net: devlink: skip info_get op call if it is not defined in dumpit
      net: phy: bcm54xx: Encode link speed and activity into LEDs
      tipc: change to check tipc_own_id to return in tipc_net_stop
      net: usb: aqc111: Extend HWID table by QNAP device
      net: sched: Kconfig: update reference link for PIE
      net: dsa: qca8k: extend slave-bus implementations
      net: dsa: qca8k: remove leftover phy accessors
      dt-bindings: net: dsa: qca8k: support internal mdio-bus
      dt-bindings: net: dsa: qca8k: fix example
      net: phy: don't clear BMCR in genphy_soft_reset
      bpf, libbpf: clarify bump in libbpf version info
      bpf, libbpf: fix version info and add it to shared object
      rxrpc: avoid clang -Wuninitialized warning
      tipc: tipc clang warning
      net: sched: fix cleanup NULL pointer exception in act_mirr
      r8169: fix cable re-plugging issue
      net: ethernet: ti: fix possible object reference leak
      net: ibm: fix possible object reference leak
      ...

commit 64f4b9437f7c36814966c2132c2ab443a67a6710
Author: Anirudh Venkataramanan <anirudh.venkataramanan@intel.com>
Date:   Tue Feb 19 15:04:11 2019 -0800

    ice: Remove "2 BITS" comment
    
    Some enums in ice_tx_desc_cmd_bits have a trailing /* 2 BITS */ comment,
    but the value has just one bit set (ex. ICE_TX_DESC_CMD_L4T_EOFT_SCTP
    has the value 0x200 (i.e. only bit 9 is set). This is confusing and
    misleading. So remove the comment.
    
    Signed-off-by: Anirudh Venkataramanan <anirudh.venkataramanan@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 7e30471146d2a450df421e2462ae220e8303a167
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Mar 9 00:07:34 2019 +0800

    selinux: add the missing walk_size + len check in selinux_sctp_bind_connect
    
    commit 292c997a1970f8d1e1dfa354ed770a22f7b5a434 upstream.
    
    As does in __sctp_connect(), when checking addrs in a while loop, after
    get the addr len according to sa_family, it's necessary to do the check
    walk_size + af->sockaddr_len > addrs_size to make sure it won't access
    an out-of-bounds addr.
    
    The same thing is needed in selinux_sctp_bind_connect(), otherwise an
    out-of-bounds issue can be triggered:
    
      [14548.772313] BUG: KASAN: slab-out-of-bounds in selinux_sctp_bind_connect+0x1aa/0x1f0
      [14548.927083] Call Trace:
      [14548.938072]  dump_stack+0x9a/0xe9
      [14548.953015]  print_address_description+0x65/0x22e
      [14548.996524]  kasan_report.cold.6+0x92/0x1a6
      [14549.015335]  selinux_sctp_bind_connect+0x1aa/0x1f0
      [14549.036947]  security_sctp_bind_connect+0x58/0x90
      [14549.058142]  __sctp_setsockopt_connectx+0x5a/0x150 [sctp]
      [14549.081650]  sctp_setsockopt.part.24+0x1322/0x3ce0 [sctp]
    
    Cc: stable@vger.kernel.org
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Reported-by: Chunyu Hu <chuhu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e4f6f82c9edc20387d51bc53081d1510c3943f31
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Mar 9 00:07:34 2019 +0800

    selinux: add the missing walk_size + len check in selinux_sctp_bind_connect
    
    commit 292c997a1970f8d1e1dfa354ed770a22f7b5a434 upstream.
    
    As does in __sctp_connect(), when checking addrs in a while loop, after
    get the addr len according to sa_family, it's necessary to do the check
    walk_size + af->sockaddr_len > addrs_size to make sure it won't access
    an out-of-bounds addr.
    
    The same thing is needed in selinux_sctp_bind_connect(), otherwise an
    out-of-bounds issue can be triggered:
    
      [14548.772313] BUG: KASAN: slab-out-of-bounds in selinux_sctp_bind_connect+0x1aa/0x1f0
      [14548.927083] Call Trace:
      [14548.938072]  dump_stack+0x9a/0xe9
      [14548.953015]  print_address_description+0x65/0x22e
      [14548.996524]  kasan_report.cold.6+0x92/0x1a6
      [14549.015335]  selinux_sctp_bind_connect+0x1aa/0x1f0
      [14549.036947]  security_sctp_bind_connect+0x58/0x90
      [14549.058142]  __sctp_setsockopt_connectx+0x5a/0x150 [sctp]
      [14549.081650]  sctp_setsockopt.part.24+0x1322/0x3ce0 [sctp]
    
    Cc: stable@vger.kernel.org
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Reported-by: Chunyu Hu <chuhu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 413e398520823d1a583bd35053e8472764310795
Author: Willem de Bruijn <willemb@google.com>
Date:   Thu Feb 7 14:54:16 2019 -0500

    bpf: only adjust gso_size on bytestream protocols
    
    [ Upstream commit b90efd2258749e04e1b3f71ef0d716f2ac2337e0 ]
    
    bpf_skb_change_proto and bpf_skb_adjust_room change skb header length.
    For GSO packets they adjust gso_size to maintain the same MTU.
    
    The gso size can only be safely adjusted on bytestream protocols.
    Commit d02f51cbcf12 ("bpf: fix bpf_skb_adjust_net/bpf_skb_proto_xlat
    to deal with gso sctp skbs") excluded SKB_GSO_SCTP.
    
    Since then type SKB_GSO_UDP_L4 has been added, whose contents are one
    gso_size unit per datagram. Also exclude these.
    
    Move from a blacklist to a whitelist check to future proof against
    additional such new GSO types, e.g., for fraglist based GRO.
    
    Fixes: bec1f6f69736 ("udp: generate gso with UDP_SEGMENT")
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e0831ef7160eb1d6f7a4b6867ea9d36e4f72b58a
Merge: ceabee6c5994 b25a31bf0ca0
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Mar 21 10:07:00 2019 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    The following patchset contains Netfilter fixes for your net tree:
    
    1) Remove a direct dependency with IPv6 introduced by the
       sip_external_media feature, from Alin Nastac.
    
    2) Fix bogus ENOENT when removing interval elements from set.
    
    3) Set transport_header from br_netfilter to mimic the stack
       behaviour, this partially fixes a checksum validation bug
       from the SCTP connection tracking, from Xin Long.
    
    4) Fix undefined reference to symbol in xt_TEE, due to missing
       Kconfig dependencies, from Arnd Bergmann.
    
    5) Check for NULL in skb_header_pointer() calls in ip6t_shr,
       from Kangjie Lu.
    
    6) Fix bogus EBUSY when removing an existing conntrack helper from
       a transaction.
    
    7) Fix module autoload of the redirect extension.
    
    8) Remove duplicated transition in flowtable diagram in the existing
       documentation.
    
    9) Missing .release_ops call from error path in newrule() which
       results module refcount leak, from Taehee Yoo.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c614682c8aed5f401ad84a18669c1ef602ad33d
Merge: 636d25d557d1 b59c19d9d901
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Mar 18 18:31:09 2019 -0700

    Merge branch 'sctp-fix-ignoring-asoc_id-for-tcp-style-sockets-on-some-setsockopts'
    
    Xin Long says:
    
    ====================
    sctp: fix ignoring asoc_id for tcp-style sockets on some setsockopts
    
    This is a patchset to fix ignoring asoc_id for tcp-style sockets on
    some setsockopts, introduced by SCTP_CURRENT_ASSOC of the patchset:
    
      [net-next,00/24] sctp: support SCTP_FUTURE/CURRENT/ALL_ASSOC
      (https://patchwork.ozlabs.org/cover/1031706/)
    
    As Marcelo suggested, we fix it on each setsockopt that is using
    SCTP_CURRENT_ASSOC one by one by adding the check:
    
        if (sctp_style(sk, TCP))
                    xxx.xxx_assoc_id = SCTP_FUTURE_ASSOC;
    
    so that assoc_id will be completely ingored for tcp-style socket on
    setsockopts, and works as SCTP_FUTURE_ASSOC.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b59c19d9d901a8eb04896ec027787a55acb71fc6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:11 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_STREAM_SCHEDULER sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_STREAM_SCHEDULER sockopt.
    
    Fixes: 7efba10d6bd2 ("sctp: add SCTP_FUTURE_ASOC and SCTP_CURRENT_ASSOC for SCTP_STREAM_SCHEDULER sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 995186193fd7a21c8fc6a2f2a96d33e26447eb01
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:10 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_EVENT sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_EVENT sockopt.
    
    Fixes: d251f05e3ba2 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_EVENT sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9430ff992644e9f9c3ba6283cc56d40b421522e9
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:09 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_ENABLE_STREAM_RESET sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_ENABLE_STREAM_RESET sockopt.
    
    Fixes: 99a62135e127 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_ENABLE_STREAM_RESET sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cbb45c6cd5e64c344798892d6e200b0b253d0b59
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:08 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_DEFAULT_PRINFO sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_DEFAULT_PRINFO sockopt.
    
    Fixes: 3a583059d187 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_PRINFO sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 200f3a3bcb293d8d55b860632b9d5c9b5e763273
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:07 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_AUTH_DEACTIVATE_KEY sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_AUTH_DEACTIVATE_KEY sockopt.
    
    Fixes: 2af66ff3edc7 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_DEACTIVATE_KEY sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 220675eb2e485519afbe7f3b457f7ce883086482
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:06 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_AUTH_DELETE_KEY sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_AUTH_DELETE_KEY sockopt.
    
    Fixes: 3adcc300603e ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_DELETE_KEY sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 06b39e8506f6dd4e11e1d8fc4d314d72d237ad10
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:05 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_AUTH_ACTIVE_KEY sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_AUTH_ACTIVE_KEY sockopt.
    
    Fixes: bf9fb6ad4f29 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_ACTIVE_KEY sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0685d6b72207a6de7ea6853e48b009e71d64fe1b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:04 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_AUTH_KEY sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_AUTH_KEY sockopt.
    
    Fixes: 7fb3be13a236 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_KEY sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 746bc215a6b223caf7eb6b33400458c15e742920
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:03 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_MAX_BURST sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_MAX_BURST sockopt.
    
    Fixes: e0651a0dc877 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_MAX_BURST sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cface2cb585e392995cc11a4a814b433e6099ec7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:02 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_CONTEXT sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_CONTEXT sockopt.
    
    Fixes: 49b037acca8c ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_CONTEXT sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a842e65b25a418363bf8196e2343123a984ee69b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:01 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_DEFAULT_SNDINFO sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_DEFAULT_SNDINFO sockopt.
    
    Fixes: 92fc3bd928c9 ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_SNDINFO sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8e2614fc1c2a525d3244df65da486fc914a2bf78
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 20:06:00 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_DELAYED_SACK sockopt
    
    A similar fix as Patch "sctp: fix ignoring asoc_id for tcp-style sockets on
    SCTP_DEFAULT_SEND_PARAM sockopt" on SCTP_DELAYED_SACK sockopt.
    
    Fixes: 9c5829e1c49e ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DELAYED_SACK sockopt")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1354e72fabf4d8763817564648984351755f0ccb
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Mar 18 20:05:59 2019 +0800

    sctp: fix ignoring asoc_id for tcp-style sockets on SCTP_DEFAULT_SEND_PARAM sockopt
    
    Currently if the user pass an invalid asoc_id to SCTP_DEFAULT_SEND_PARAM
    on a TCP-style socket, it will silently ignore the new parameters.
    That's because after not finding an asoc, it is checking asoc_id against
    the known values of CURRENT/FUTURE/ALL values and that fails to match.
    
    IOW, if the user supplies an invalid asoc id or not, it should either
    match the current asoc or the socket itself so that it will inherit
    these later. Fixes it by forcing asoc_id to SCTP_FUTURE_ASSOC in case it
    is a TCP-style socket without an asoc, so that the values get set on the
    socket.
    
    Fixes: 707e45b3dc5a ("sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_SEND_PARAM sockopt")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 273160ffc6b993c7c91627f5a84799c66dfe4dee
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 18 19:47:00 2019 +0800

    sctp: get sctphdr by offset in sctp_compute_cksum
    
    sctp_hdr(skb) only works when skb->transport_header is set properly.
    
    But in Netfilter, skb->transport_header for ipv6 is not guaranteed
    to be right value for sctphdr. It would cause to fail to check the
    checksum for sctp packets.
    
    So fix it by using offset, which is always right in all places.
    
    v1->v2:
      - Fix the changelog.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e166e4fdaced850bee3d5ee12a5740258fb30587
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 13 16:33:29 2019 +0800

    netfilter: bridge: set skb transport_header before entering NF_INET_PRE_ROUTING
    
    Since Commit 21d1196a35f5 ("ipv4: set transport header earlier"),
    skb->transport_header has been always set before entering INET
    netfilter. This patch is to set skb->transport_header for bridge
    before entering INET netfilter by bridge-nf-call-iptables.
    
    It also fixes an issue that sctp_error() couldn't compute a right
    csum due to unset skb->transport_header.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Reported-by: Li Shuang <shuali@redhat.com>
    Suggested-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit fa3d493f7a573b4e4e2538486e912093a0161c1b
Merge: 8636b1dbce85 3815a245b501
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Mar 13 11:10:42 2019 -0700

    Merge tag 'selinux-pr-20190312' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull selinux fixes from Paul Moore:
     "Two small fixes for SELinux in v5.1: one adds a buffer length check to
      the SELinux SCTP code, the other ensures that the SELinux labeling for
      a NFS mount is not disabled if the filesystem is mounted twice"
    
    * tag 'selinux-pr-20190312' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      security/selinux: fix SECURITY_LSM_NATIVE_LABELS on reused superblock
      selinux: add the missing walk_size + len check in selinux_sctp_bind_connect

commit 292c997a1970f8d1e1dfa354ed770a22f7b5a434
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Mar 9 00:07:34 2019 +0800

    selinux: add the missing walk_size + len check in selinux_sctp_bind_connect
    
    As does in __sctp_connect(), when checking addrs in a while loop, after
    get the addr len according to sa_family, it's necessary to do the check
    walk_size + af->sockaddr_len > addrs_size to make sure it won't access
    an out-of-bounds addr.
    
    The same thing is needed in selinux_sctp_bind_connect(), otherwise an
    out-of-bounds issue can be triggered:
    
      [14548.772313] BUG: KASAN: slab-out-of-bounds in selinux_sctp_bind_connect+0x1aa/0x1f0
      [14548.927083] Call Trace:
      [14548.938072]  dump_stack+0x9a/0xe9
      [14548.953015]  print_address_description+0x65/0x22e
      [14548.996524]  kasan_report.cold.6+0x92/0x1a6
      [14549.015335]  selinux_sctp_bind_connect+0x1aa/0x1f0
      [14549.036947]  security_sctp_bind_connect+0x58/0x90
      [14549.058142]  __sctp_setsockopt_connectx+0x5a/0x150 [sctp]
      [14549.081650]  sctp_setsockopt.part.24+0x1322/0x3ce0 [sctp]
    
    Cc: stable@vger.kernel.org
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Reported-by: Chunyu Hu <chuhu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 8085d6d03fe3702e9cf37fff3677c08b40b1007f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Mar 3 16:50:26 2019 +0800

    sctp: call iov_iter_revert() after sending ABORT
    
    [ Upstream commit 901efe12318b1ea8d3e2c88a7b75ed6e6d5d7245 ]
    
    The user msg is also copied to the abort packet when doing SCTP_ABORT in
    sctp_sendmsg_check_sflags(). When SCTP_SENDALL is set, iov_iter_revert()
    should have been called for sending abort on the next asoc with copying
    this msg. Otherwise, memcpy_from_msg() in sctp_make_abort_user() will
    fail and return error.
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dfbfb265aad42cb1ee834bc18e6097514ccb136a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Mar 3 16:50:26 2019 +0800

    sctp: call iov_iter_revert() after sending ABORT
    
    [ Upstream commit 901efe12318b1ea8d3e2c88a7b75ed6e6d5d7245 ]
    
    The user msg is also copied to the abort packet when doing SCTP_ABORT in
    sctp_sendmsg_check_sflags(). When SCTP_SENDALL is set, iov_iter_revert()
    should have been called for sending abort on the next asoc with copying
    this msg. Otherwise, memcpy_from_msg() in sctp_make_abort_user() will
    fail and return error.
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9dc9563fbb3885826d9786eb5d5000995dc57b75
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Mar 3 16:50:26 2019 +0800

    sctp: call iov_iter_revert() after sending ABORT
    
    [ Upstream commit 901efe12318b1ea8d3e2c88a7b75ed6e6d5d7245 ]
    
    The user msg is also copied to the abort packet when doing SCTP_ABORT in
    sctp_sendmsg_check_sflags(). When SCTP_SENDALL is set, iov_iter_revert()
    should have been called for sending abort on the next asoc with copying
    this msg. Otherwise, memcpy_from_msg() in sctp_make_abort_user() will
    fail and return error.
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 901efe12318b1ea8d3e2c88a7b75ed6e6d5d7245
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Mar 3 16:50:26 2019 +0800

    sctp: call iov_iter_revert() after sending ABORT
    
    The user msg is also copied to the abort packet when doing SCTP_ABORT in
    sctp_sendmsg_check_sflags(). When SCTP_SENDALL is set, iov_iter_revert()
    should have been called for sending abort on the next asoc with copying
    this msg. Otherwise, memcpy_from_msg() in sctp_make_abort_user() will
    fail and return error.
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4e7df119d9a621262f22cacf8ae5ca5060183bea
Merge: 2369afb6696c db8ab38880e0
Author: David S. Miller <davem@davemloft.net>
Date:   Sat Mar 2 14:01:04 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS updates for net-next
    
    The following patchset contains Netfilter/IPVS updates for net-next:
    
    1) Add .release_ops to properly unroll .select_ops, use it from nft_compat.
       After this change, we can remove list of extensions too to simplify this
       codebase.
    
    2) Update amanda conntrack helper to support v3.4, from Florian Tham.
    
    3) Get rid of the obsolete BUGPRINT macro in ebtables, from
       Florian Westphal.
    
    4) Merge IPv4 and IPv6 masquerading infrastructure into one single module.
       From Florian Westphal.
    
    5) Patchset to remove nf_nat_l3proto structure to get rid of
       indirections, from Florian Westphal.
    
    6) Skip unnecessary conntrack timeout updates in case the value is
       still the same, also from Florian Westphal.
    
    7) Remove unnecessary 'fall through' comments in empty switch cases,
       from Li RongQing.
    
    8) Fix lookup to fixed size hashtable sets on big endian with 32-bit keys.
    
    9) Incorrect logic to deactivate path of fixed size hashtable sets,
       element was being tested to self.
    
    10) Remove nft_hash_key(), the bitmap set is always selected for 16-bit
        keys.
    
    11) Use boolean whenever possible in IPVS codebase, from Andrea Claudi.
    
    12) Enter close state in conntrack if RST matches exact sequence number,
        from Florian Westphal.
    
    13) Initialize dst_cache in tunnel extension, from wenxu.
    
    14) Pass protocol as u16 to xt_check_match and xt_check_target, from
        Li RongQing.
    
    15) SCTP header is granted to be in a linear area from IPVS NAT handler,
        from Xin Long.
    
    16) Don't steal packets coming from slave VRF device from the
        ip_sabotage_in() path, from David Ahern.
    
    17) Fix unsafe update of basechain stats, from Li RongQing.
    
    18) Make sure CONNTRACK_LOCKS is power of 2 to let compiler optimize
        modulo operation as bitwise AND, from Li RongQing.
    
    19) Use device_attribute instead of internal definition in the IDLETIMER
        target, from Sami Tolvanen.
    
    20) Merge redir, masq and IPv4/IPv6 NAT chain types, from Florian Westphal.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5802a5c5d8d4949814da3b3677cee55dcc5b89a6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 12 18:47:30 2019 +0800

    sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
    
    [ Upstream commit fc228abc2347e106a44c0e9b29ab70b712c4ca51 ]
    
    Jianlin reported a panic when running sctp gso over gre over vlan device:
    
      [   84.772930] RIP: 0010:do_csum+0x6d/0x170
      [   84.790605] Call Trace:
      [   84.791054]  csum_partial+0xd/0x20
      [   84.791657]  gre_gso_segment+0x2c3/0x390
      [   84.792364]  inet_gso_segment+0x161/0x3e0
      [   84.793071]  skb_mac_gso_segment+0xb8/0x120
      [   84.793846]  __skb_gso_segment+0x7e/0x180
      [   84.794581]  validate_xmit_skb+0x141/0x2e0
      [   84.795297]  __dev_queue_xmit+0x258/0x8f0
      [   84.795949]  ? eth_header+0x26/0xc0
      [   84.796581]  ip_finish_output2+0x196/0x430
      [   84.797295]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.798183]  ? ip_finish_output+0x169/0x270
      [   84.798875]  ip_output+0x6c/0xe0
      [   84.799413]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.800145]  iptunnel_xmit+0x144/0x1c0
      [   84.800814]  ip_tunnel_xmit+0x62d/0x930 [ip_tunnel]
      [   84.801699]  gre_tap_xmit+0xac/0xf0 [ip_gre]
      [   84.802395]  dev_hard_start_xmit+0xa5/0x210
      [   84.803086]  sch_direct_xmit+0x14f/0x340
      [   84.803733]  __dev_queue_xmit+0x799/0x8f0
      [   84.804472]  ip_finish_output2+0x2e0/0x430
      [   84.805255]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.806154]  ip_output+0x6c/0xe0
      [   84.806721]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.807516]  sctp_packet_transmit+0x716/0xa10 [sctp]
      [   84.808337]  sctp_outq_flush+0xd7/0x880 [sctp]
    
    It was caused by SKB_GSO_CB(skb)->csum_start not set in sctp_gso_segment.
    sctp_gso_segment() calls skb_segment() with 'feature | NETIF_F_HW_CSUM',
    which causes SKB_GSO_CB(skb)->csum_start not to be set in skb_segment().
    
    For TCP/UDP, when feature supports HW_CSUM, CHECKSUM_PARTIAL will be set
    and gso_reset_checksum will be called to set SKB_GSO_CB(skb)->csum_start.
    
    So SCTP should do the same as TCP/UDP, to call gso_reset_checksum() when
    computing checksum in sctp_gso_segment.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e8eff9f4fc6a3b0e88ecf70e4f32fc2b68e26bfc
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 12 18:47:30 2019 +0800

    sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
    
    [ Upstream commit fc228abc2347e106a44c0e9b29ab70b712c4ca51 ]
    
    Jianlin reported a panic when running sctp gso over gre over vlan device:
    
      [   84.772930] RIP: 0010:do_csum+0x6d/0x170
      [   84.790605] Call Trace:
      [   84.791054]  csum_partial+0xd/0x20
      [   84.791657]  gre_gso_segment+0x2c3/0x390
      [   84.792364]  inet_gso_segment+0x161/0x3e0
      [   84.793071]  skb_mac_gso_segment+0xb8/0x120
      [   84.793846]  __skb_gso_segment+0x7e/0x180
      [   84.794581]  validate_xmit_skb+0x141/0x2e0
      [   84.795297]  __dev_queue_xmit+0x258/0x8f0
      [   84.795949]  ? eth_header+0x26/0xc0
      [   84.796581]  ip_finish_output2+0x196/0x430
      [   84.797295]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.798183]  ? ip_finish_output+0x169/0x270
      [   84.798875]  ip_output+0x6c/0xe0
      [   84.799413]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.800145]  iptunnel_xmit+0x144/0x1c0
      [   84.800814]  ip_tunnel_xmit+0x62d/0x930 [ip_tunnel]
      [   84.801699]  gre_tap_xmit+0xac/0xf0 [ip_gre]
      [   84.802395]  dev_hard_start_xmit+0xa5/0x210
      [   84.803086]  sch_direct_xmit+0x14f/0x340
      [   84.803733]  __dev_queue_xmit+0x799/0x8f0
      [   84.804472]  ip_finish_output2+0x2e0/0x430
      [   84.805255]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.806154]  ip_output+0x6c/0xe0
      [   84.806721]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.807516]  sctp_packet_transmit+0x716/0xa10 [sctp]
      [   84.808337]  sctp_outq_flush+0xd7/0x880 [sctp]
    
    It was caused by SKB_GSO_CB(skb)->csum_start not set in sctp_gso_segment.
    sctp_gso_segment() calls skb_segment() with 'feature | NETIF_F_HW_CSUM',
    which causes SKB_GSO_CB(skb)->csum_start not to be set in skb_segment().
    
    For TCP/UDP, when feature supports HW_CSUM, CHECKSUM_PARTIAL will be set
    and gso_reset_checksum will be called to set SKB_GSO_CB(skb)->csum_start.
    
    So SCTP should do the same as TCP/UDP, to call gso_reset_checksum() when
    computing checksum in sctp_gso_segment.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 77278f05f0bbc3409363b844d179aea19504acb6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 12 18:47:30 2019 +0800

    sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
    
    [ Upstream commit fc228abc2347e106a44c0e9b29ab70b712c4ca51 ]
    
    Jianlin reported a panic when running sctp gso over gre over vlan device:
    
      [   84.772930] RIP: 0010:do_csum+0x6d/0x170
      [   84.790605] Call Trace:
      [   84.791054]  csum_partial+0xd/0x20
      [   84.791657]  gre_gso_segment+0x2c3/0x390
      [   84.792364]  inet_gso_segment+0x161/0x3e0
      [   84.793071]  skb_mac_gso_segment+0xb8/0x120
      [   84.793846]  __skb_gso_segment+0x7e/0x180
      [   84.794581]  validate_xmit_skb+0x141/0x2e0
      [   84.795297]  __dev_queue_xmit+0x258/0x8f0
      [   84.795949]  ? eth_header+0x26/0xc0
      [   84.796581]  ip_finish_output2+0x196/0x430
      [   84.797295]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.798183]  ? ip_finish_output+0x169/0x270
      [   84.798875]  ip_output+0x6c/0xe0
      [   84.799413]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.800145]  iptunnel_xmit+0x144/0x1c0
      [   84.800814]  ip_tunnel_xmit+0x62d/0x930 [ip_tunnel]
      [   84.801699]  gre_tap_xmit+0xac/0xf0 [ip_gre]
      [   84.802395]  dev_hard_start_xmit+0xa5/0x210
      [   84.803086]  sch_direct_xmit+0x14f/0x340
      [   84.803733]  __dev_queue_xmit+0x799/0x8f0
      [   84.804472]  ip_finish_output2+0x2e0/0x430
      [   84.805255]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.806154]  ip_output+0x6c/0xe0
      [   84.806721]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.807516]  sctp_packet_transmit+0x716/0xa10 [sctp]
      [   84.808337]  sctp_outq_flush+0xd7/0x880 [sctp]
    
    It was caused by SKB_GSO_CB(skb)->csum_start not set in sctp_gso_segment.
    sctp_gso_segment() calls skb_segment() with 'feature | NETIF_F_HW_CSUM',
    which causes SKB_GSO_CB(skb)->csum_start not to be set in skb_segment().
    
    For TCP/UDP, when feature supports HW_CSUM, CHECKSUM_PARTIAL will be set
    and gso_reset_checksum will be called to set SKB_GSO_CB(skb)->csum_start.
    
    So SCTP should do the same as TCP/UDP, to call gso_reset_checksum() when
    computing checksum in sctp_gso_segment.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 176ef96c1900432ba7ef659f435a7320bf026ca6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 12 18:47:30 2019 +0800

    sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
    
    [ Upstream commit fc228abc2347e106a44c0e9b29ab70b712c4ca51 ]
    
    Jianlin reported a panic when running sctp gso over gre over vlan device:
    
      [   84.772930] RIP: 0010:do_csum+0x6d/0x170
      [   84.790605] Call Trace:
      [   84.791054]  csum_partial+0xd/0x20
      [   84.791657]  gre_gso_segment+0x2c3/0x390
      [   84.792364]  inet_gso_segment+0x161/0x3e0
      [   84.793071]  skb_mac_gso_segment+0xb8/0x120
      [   84.793846]  __skb_gso_segment+0x7e/0x180
      [   84.794581]  validate_xmit_skb+0x141/0x2e0
      [   84.795297]  __dev_queue_xmit+0x258/0x8f0
      [   84.795949]  ? eth_header+0x26/0xc0
      [   84.796581]  ip_finish_output2+0x196/0x430
      [   84.797295]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.798183]  ? ip_finish_output+0x169/0x270
      [   84.798875]  ip_output+0x6c/0xe0
      [   84.799413]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.800145]  iptunnel_xmit+0x144/0x1c0
      [   84.800814]  ip_tunnel_xmit+0x62d/0x930 [ip_tunnel]
      [   84.801699]  gre_tap_xmit+0xac/0xf0 [ip_gre]
      [   84.802395]  dev_hard_start_xmit+0xa5/0x210
      [   84.803086]  sch_direct_xmit+0x14f/0x340
      [   84.803733]  __dev_queue_xmit+0x799/0x8f0
      [   84.804472]  ip_finish_output2+0x2e0/0x430
      [   84.805255]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.806154]  ip_output+0x6c/0xe0
      [   84.806721]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.807516]  sctp_packet_transmit+0x716/0xa10 [sctp]
      [   84.808337]  sctp_outq_flush+0xd7/0x880 [sctp]
    
    It was caused by SKB_GSO_CB(skb)->csum_start not set in sctp_gso_segment.
    sctp_gso_segment() calls skb_segment() with 'feature | NETIF_F_HW_CSUM',
    which causes SKB_GSO_CB(skb)->csum_start not to be set in skb_segment().
    
    For TCP/UDP, when feature supports HW_CSUM, CHECKSUM_PARTIAL will be set
    and gso_reset_checksum will be called to set SKB_GSO_CB(skb)->csum_start.
    
    So SCTP should do the same as TCP/UDP, to call gso_reset_checksum() when
    computing checksum in sctp_gso_segment.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d61330c689df2ef7ac76b63be2bd0a8561e47fd9
Author: Kees Cook <keescook@chromium.org>
Date:   Sun Feb 17 14:08:36 2019 -0800

    doc: sctp: Merge and clean up rst files
    
    The SCTP sections were ending up at the top-level table of contents
    under the security section when they should have be sections with the
    SCTP chapters. In addition to correcting the section and subsection
    headings, this merges the SCTP documents into a single file to organize
    the chapters more clearly, internally linkifies them, and adds the
    missing SPDX header.
    
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Jonathan Corbet <corbet@lwn.net>

commit 6e7bd3b5494620265d39463b9289b7ba872f6df1
Merge: 02d75040897f f9bcc9f3ee4f
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Feb 15 08:00:11 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix MAC address setting in mac80211 pmsr code, from Johannes Berg.
    
     2) Probe SFP modules after being attached, from Russell King.
    
     3) Byte ordering bug in SMC rx_curs_confirmed code, from Ursula Braun.
    
     4) Revert some r8169 changes that are causing regressions, from Heiner
        Kallweit.
    
     5) Fix spurious connection timeouts in netfilter nat code, from Florian
        Westphal.
    
     6) SKB leak in tipc, from Hoang Le.
    
     7) Short packet checkum issue in mlx4, similar to a previous mlx5
        change, from Saeed Mahameed. The issue is that whilst padding bytes
        are usually zero, it is not guarateed and the hardware doesn't take
        the padding bytes into consideration when generating the checksum.
    
     8) Fix various races in cls_tcindex, from Cong Wang.
    
     9) Need to set stream ext to NULL before freeing in SCTP code, from Xin
        Long.
    
    10) Fix locking in phy_is_started, from Heiner Kallweit.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (54 commits)
      net: ethernet: freescale: set FEC ethtool regs version
      net: hns: Fix object reference leaks in hns_dsaf_roce_reset()
      mm: page_alloc: fix ref bias in page_frag_alloc() for 1-byte allocs
      net: phy: fix potential race in the phylib state machine
      net: phy: don't use locking in phy_is_started
      selftests: fix timestamping Makefile
      net: dsa: bcm_sf2: potential array overflow in bcm_sf2_sw_suspend()
      net: fix possible overflow in __sk_mem_raise_allocated()
      dsa: mv88e6xxx: Ensure all pending interrupts are handled prior to exit
      net: phy: fix interrupt handling in non-started states
      sctp: set stream ext to NULL after freeing it in sctp_stream_outq_migrate
      sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
      net/mlx5e: XDP, fix redirect resources availability check
      net/mlx5: Fix a compilation warning in events.c
      net/mlx5: No command allowed when command interface is not ready
      net/mlx5e: Fix NULL pointer derefernce in set channels error flow
      netfilter: nft_compat: use-after-free when deleting targets
      team: avoid complex list operations in team_nl_cmd_options_set()
      net_sched: fix two more memory leaks in cls_tcindex
      net_sched: fix a memory leak in cls_tcindex
      ...

commit 87486b23f8aa7cf55c2df4a927691c5e8540c813
Merge: dd27c2e3d0a0 0fde56e4385b
Author: Alexei Starovoitov <ast@kernel.org>
Date:   Wed Feb 13 18:27:56 2019 -0800

    Merge branch 'lwt_encap_ip'
    
    Peter Oskolkov says:
    
    ====================
    This patchset implements BPF_LWT_ENCAP_IP mode in bpf_lwt_push_encap
    BPF helper. It enables BPF programs (specifically, BPF_PROG_TYPE_LWT_IN
    and BPF_PROG_TYPE_LWT_XMIT prog types) to add IP encapsulation headers
    to packets (e.g. IP/GRE, GUE, IPIP).
    
    This is useful when thousands of different short-lived flows should be
    encapped, each with different and dynamically determined destination.
    Although lwtunnels can be used in some of these scenarios, the ability
    to dynamically generate encap headers adds more flexibility, e.g.
    when routing depends on the state of the host (reflected in global bpf
    maps).
    
    V2 changes: added flowi-based route lookup, IPv6 encapping, and
       encapping on ingress.
    
    V3 changes: incorporated David Ahern's suggestions:
       - added l3mdev check/oif (patch 2)
       - sync bpf.h from include/uapi into tools/include/uapi
       - selftest tweaks
    
    V4 changes: moved route lookup/dst change from bpf_push_ip_encap
       to when BPF_LWT_REROUTE is handled, as suggested by David Ahern.
    
    V5 changes: added a check in lwt_xmit that skb->protocol stays the
       same if the skb is to be passed back to the stack (ret == BPF_OK).
       Again, suggested by David Ahern.
    
    V6 changes: abandoned.
    
    V7 changes: added handling of GSO packets (patch 3 in the patchset added),
       as suggested by BPF maintainers.
    
    V8 changes:
       - fixed build errors when LWT or IPV6 are not enabled;
       - whitelisted TCP GSO instead of blacklisting SCTP and UDP GSO, as
         suggested by Willem de Bruijn;
       - added validation that pushed length cover needed headers when GRE/UDP
         encap is detected, as suggested by Willem de Bruijn;
       - a couple of minor/stylistic tweaks/fixed typos.
    
    V9 changes:
       - fixed a kbuild test robot compiler warning;
       - added ipv6_route_input to ipv6_stub (patch 4 in the patchset
         added), and IPv6 routing functions are now invoked via ipv6_stub,
         as suggested by David Ahern.
    
    V10 changes:
       - removed unnecessary IS_ENABLED and pr_warn_once from patch 5.
    
    V11 changes: fixed a potential dst leak in patch 5, as suggested by
        David Ahern.
    ====================
    
    Reviewed-by: David Ahern <dsahern@gmail.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>

commit ca78801a81e04a31f8088e96b2649a9cbace5499
Author: Peter Oskolkov <posk@google.com>
Date:   Wed Feb 13 11:53:37 2019 -0800

    bpf: handle GSO in bpf_lwt_push_encap
    
    This patch adds handling of GSO packets in bpf_lwt_push_ip_encap()
    (called from bpf_lwt_push_encap):
    
    * IPIP, GRE, and UDP encapsulation types are deduced by looking
      into iphdr->protocol or ipv6hdr->next_header;
    * SCTP GSO packets are not supported (as bpf_skb_proto_4_to_6
      and similar do);
    * UDP_L4 GSO packets are also not supported (although they are
      not blocked in bpf_skb_proto_4_to_6 and similar), as
      skb_decrease_gso_size() will break it;
    * SKB_GSO_DODGY bit is set.
    
    Note: it may be possible to support SCTP and UDP_L4 gso packets;
          but as these cases seem to be not well handled by other
          tunneling/encapping code paths, the solution should
          be generic enough to apply to all tunneling/encapping code.
    
    v8 changes:
       - make sure that if GRE or UDP encap is detected, there is
         enough of pushed bytes to cover both IP[v6] + GRE|UDP headers;
       - do not reject double-encapped packets;
       - whitelist TCP GSO packets rather than block SCTP GSO and
         UDP GSO.
    
    Signed-off-by: Peter Oskolkov <posk@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>

commit fc228abc2347e106a44c0e9b29ab70b712c4ca51
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Feb 12 18:47:30 2019 +0800

    sctp: call gso_reset_checksum when computing checksum in sctp_gso_segment
    
    Jianlin reported a panic when running sctp gso over gre over vlan device:
    
      [   84.772930] RIP: 0010:do_csum+0x6d/0x170
      [   84.790605] Call Trace:
      [   84.791054]  csum_partial+0xd/0x20
      [   84.791657]  gre_gso_segment+0x2c3/0x390
      [   84.792364]  inet_gso_segment+0x161/0x3e0
      [   84.793071]  skb_mac_gso_segment+0xb8/0x120
      [   84.793846]  __skb_gso_segment+0x7e/0x180
      [   84.794581]  validate_xmit_skb+0x141/0x2e0
      [   84.795297]  __dev_queue_xmit+0x258/0x8f0
      [   84.795949]  ? eth_header+0x26/0xc0
      [   84.796581]  ip_finish_output2+0x196/0x430
      [   84.797295]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.798183]  ? ip_finish_output+0x169/0x270
      [   84.798875]  ip_output+0x6c/0xe0
      [   84.799413]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.800145]  iptunnel_xmit+0x144/0x1c0
      [   84.800814]  ip_tunnel_xmit+0x62d/0x930 [ip_tunnel]
      [   84.801699]  gre_tap_xmit+0xac/0xf0 [ip_gre]
      [   84.802395]  dev_hard_start_xmit+0xa5/0x210
      [   84.803086]  sch_direct_xmit+0x14f/0x340
      [   84.803733]  __dev_queue_xmit+0x799/0x8f0
      [   84.804472]  ip_finish_output2+0x2e0/0x430
      [   84.805255]  ? skb_gso_validate_network_len+0x11/0x80
      [   84.806154]  ip_output+0x6c/0xe0
      [   84.806721]  ? ip_append_data.part.50+0xc0/0xc0
      [   84.807516]  sctp_packet_transmit+0x716/0xa10 [sctp]
      [   84.808337]  sctp_outq_flush+0xd7/0x880 [sctp]
    
    It was caused by SKB_GSO_CB(skb)->csum_start not set in sctp_gso_segment.
    sctp_gso_segment() calls skb_segment() with 'feature | NETIF_F_HW_CSUM',
    which causes SKB_GSO_CB(skb)->csum_start not to be set in skb_segment().
    
    For TCP/UDP, when feature supports HW_CSUM, CHECKSUM_PARTIAL will be set
    and gso_reset_checksum will be called to set SKB_GSO_CB(skb)->csum_start.
    
    So SCTP should do the same as TCP/UDP, to call gso_reset_checksum() when
    computing checksum in sctp_gso_segment.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7fc38225363dd8f19e667ad7c77b63bc4a5c065d
Author: Alin Nastac <alin.nastac@gmail.com>
Date:   Wed Feb 13 09:14:53 2019 +0100

    netfilter: reject: skip csum verification for protocols that don't support it
    
    Some protocols have other means to verify the payload integrity
    (AH, ESP, SCTP) while others are incompatible with nf_ip(6)_checksum
    implementation because checksum is either optional or might be
    partial (UDPLITE, DCCP, GRE). Because nf_ip(6)_checksum was used
    to validate the packets, ip(6)tables REJECT rules were not capable
    to generate ICMP(v6) errors for the protocols mentioned above.
    
    This commit also fixes the incorrect pseudo-header protocol used
    for IPv4 packets that carry other transport protocols than TCP or
    UDP (pseudo-header used protocol 0 iso the proper value).
    
    Signed-off-by: Alin Nastac <alin.nastac@gmail.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit cc3a83d1428693d6039387a8bedbfe970d629867
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Feb 1 15:15:22 2019 +0100

    sctp: walk the list of asoc safely
    
    [ Upstream commit ba59fb0273076637f0add4311faa990a5eec27c0 ]
    
    In sctp_sendmesg(), when walking the list of endpoint associations, the
    association can be dropped from the list, making the list corrupt.
    Properly handle this by using list_for_each_entry_safe()
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Secunia Research <vuln@secunia.com>
    Tested-by: Secunia Research <vuln@secunia.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c2361308e1727c3135ebb3b5c6906fb781bb261
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Feb 1 15:15:22 2019 +0100

    sctp: walk the list of asoc safely
    
    [ Upstream commit ba59fb0273076637f0add4311faa990a5eec27c0 ]
    
    In sctp_sendmesg(), when walking the list of endpoint associations, the
    association can be dropped from the list, making the list corrupt.
    Properly handle this by using list_for_each_entry_safe()
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Secunia Research <vuln@secunia.com>
    Tested-by: Secunia Research <vuln@secunia.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b90efd2258749e04e1b3f71ef0d716f2ac2337e0
Author: Willem de Bruijn <willemb@google.com>
Date:   Thu Feb 7 14:54:16 2019 -0500

    bpf: only adjust gso_size on bytestream protocols
    
    bpf_skb_change_proto and bpf_skb_adjust_room change skb header length.
    For GSO packets they adjust gso_size to maintain the same MTU.
    
    The gso size can only be safely adjusted on bytestream protocols.
    Commit d02f51cbcf12 ("bpf: fix bpf_skb_adjust_net/bpf_skb_proto_xlat
    to deal with gso sctp skbs") excluded SKB_GSO_SCTP.
    
    Since then type SKB_GSO_UDP_L4 has been added, whose contents are one
    gso_size unit per datagram. Also exclude these.
    
    Move from a blacklist to a whitelist check to future proof against
    additional such new GSO types, e.g., for fraglist based GRO.
    
    Fixes: bec1f6f69736 ("udp: generate gso with UDP_SEGMENT")
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>

commit 556e554a3b7478dba08585b5393384c973f36408
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:39:34 2019 +0800

    sctp: improve the events for sctp stream reset
    
    [ Upstream commit 2e6dc4d95110becfe0ff4c3d4749c33ea166e9e7 ]
    
    This patch is to improve sctp stream reset events in 4 places:
    
      1. In sctp_process_strreset_outreq(), the flag should always be set with
         SCTP_STREAM_RESET_INCOMING_SSN instead of OUTGOING, as receiver's in
         stream is reset here.
      2. In sctp_process_strreset_outreq(), move up SCTP_STRRESET_ERR_WRONG_SSN
         check, as the reset has to succeed after reconf_timer stops for the
         in stream reset request retransmission.
      3. In sctp_process_strreset_inreq(), no event should be sent, as no in
         or out stream is reset here.
      4. In sctp_process_strreset_resp(), SCTP_STREAM_RESET_INCOMING_SSN or
         OUTGOING event should always be sent for stream reset requests, no
         matter it fails or succeeds to process the request.
    
    Fixes: 810544764536 ("sctp: implement receiver-side procedures for the Outgoing SSN Reset Request Parameter")
    Fixes: 16e1a91965b0 ("sctp: implement receiver-side procedures for the Incoming SSN Reset Request Parameter")
    Fixes: 11ae76e67a17 ("sctp: implement receiver-side procedures for the Reconf Response Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f97e785670005f78188550ad21265edee03526d6
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:40:12 2019 +0800

    sctp: improve the events for sctp stream adding
    
    [ Upstream commit 8220c870cb0f4eaa4e335c9645dbd9a1c461c1dd ]
    
    This patch is to improve sctp stream adding events in 2 places:
    
      1. In sctp_process_strreset_addstrm_out(), move up SCTP_MAX_STREAM
         and in stream allocation failure checks, as the adding has to
         succeed after reconf_timer stops for the in stream adding
         request retransmission.
    
      3. In sctp_process_strreset_addstrm_in(), no event should be sent,
         as no in or out stream is added here.
    
    Fixes: 50a41591f110 ("sctp: implement receiver-side procedures for the Add Outgoing Streams Request Parameter")
    Fixes: c5c4ebb3ab87 ("sctp: implement receiver-side procedures for the Add Incoming Streams Request Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4ec13999d363d757c4078be9f4e3aaf7cdc62033
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:40:12 2019 +0800

    sctp: improve the events for sctp stream adding
    
    [ Upstream commit 8220c870cb0f4eaa4e335c9645dbd9a1c461c1dd ]
    
    This patch is to improve sctp stream adding events in 2 places:
    
      1. In sctp_process_strreset_addstrm_out(), move up SCTP_MAX_STREAM
         and in stream allocation failure checks, as the adding has to
         succeed after reconf_timer stops for the in stream adding
         request retransmission.
    
      3. In sctp_process_strreset_addstrm_in(), no event should be sent,
         as no in or out stream is added here.
    
    Fixes: 50a41591f110 ("sctp: implement receiver-side procedures for the Add Outgoing Streams Request Parameter")
    Fixes: c5c4ebb3ab87 ("sctp: implement receiver-side procedures for the Add Incoming Streams Request Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e569927a137553c6739e2e9a5bce8645c5dae10a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:39:34 2019 +0800

    sctp: improve the events for sctp stream reset
    
    [ Upstream commit 2e6dc4d95110becfe0ff4c3d4749c33ea166e9e7 ]
    
    This patch is to improve sctp stream reset events in 4 places:
    
      1. In sctp_process_strreset_outreq(), the flag should always be set with
         SCTP_STREAM_RESET_INCOMING_SSN instead of OUTGOING, as receiver's in
         stream is reset here.
      2. In sctp_process_strreset_outreq(), move up SCTP_STRRESET_ERR_WRONG_SSN
         check, as the reset has to succeed after reconf_timer stops for the
         in stream reset request retransmission.
      3. In sctp_process_strreset_inreq(), no event should be sent, as no in
         or out stream is reset here.
      4. In sctp_process_strreset_resp(), SCTP_STREAM_RESET_INCOMING_SSN or
         OUTGOING event should always be sent for stream reset requests, no
         matter it fails or succeeds to process the request.
    
    Fixes: 810544764536 ("sctp: implement receiver-side procedures for the Outgoing SSN Reset Request Parameter")
    Fixes: 16e1a91965b0 ("sctp: implement receiver-side procedures for the Incoming SSN Reset Request Parameter")
    Fixes: 11ae76e67a17 ("sctp: implement receiver-side procedures for the Reconf Response Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 031eda88739e06823a64e79eb6d5bb88afafa7b3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:40:12 2019 +0800

    sctp: improve the events for sctp stream adding
    
    [ Upstream commit 8220c870cb0f4eaa4e335c9645dbd9a1c461c1dd ]
    
    This patch is to improve sctp stream adding events in 2 places:
    
      1. In sctp_process_strreset_addstrm_out(), move up SCTP_MAX_STREAM
         and in stream allocation failure checks, as the adding has to
         succeed after reconf_timer stops for the in stream adding
         request retransmission.
    
      3. In sctp_process_strreset_addstrm_in(), no event should be sent,
         as no in or out stream is added here.
    
    Fixes: 50a41591f110 ("sctp: implement receiver-side procedures for the Add Outgoing Streams Request Parameter")
    Fixes: c5c4ebb3ab87 ("sctp: implement receiver-side procedures for the Add Incoming Streams Request Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7bc41f518300dada8c856eb4b61cbaabe83b4774
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:39:34 2019 +0800

    sctp: improve the events for sctp stream reset
    
    [ Upstream commit 2e6dc4d95110becfe0ff4c3d4749c33ea166e9e7 ]
    
    This patch is to improve sctp stream reset events in 4 places:
    
      1. In sctp_process_strreset_outreq(), the flag should always be set with
         SCTP_STREAM_RESET_INCOMING_SSN instead of OUTGOING, as receiver's in
         stream is reset here.
      2. In sctp_process_strreset_outreq(), move up SCTP_STRRESET_ERR_WRONG_SSN
         check, as the reset has to succeed after reconf_timer stops for the
         in stream reset request retransmission.
      3. In sctp_process_strreset_inreq(), no event should be sent, as no in
         or out stream is reset here.
      4. In sctp_process_strreset_resp(), SCTP_STREAM_RESET_INCOMING_SSN or
         OUTGOING event should always be sent for stream reset requests, no
         matter it fails or succeeds to process the request.
    
    Fixes: 810544764536 ("sctp: implement receiver-side procedures for the Outgoing SSN Reset Request Parameter")
    Fixes: 16e1a91965b0 ("sctp: implement receiver-side procedures for the Incoming SSN Reset Request Parameter")
    Fixes: 11ae76e67a17 ("sctp: implement receiver-side procedures for the Reconf Response Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ba59fb0273076637f0add4311faa990a5eec27c0
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Feb 1 15:15:22 2019 +0100

    sctp: walk the list of asoc safely
    
    In sctp_sendmesg(), when walking the list of endpoint associations, the
    association can be dropped from the list, making the list corrupt.
    Properly handle this by using list_for_each_entry_safe()
    
    Fixes: 4910280503f3 ("sctp: add support for snd flag SCTP_SENDALL process in sendmsg")
    Reported-by: Secunia Research <vuln@secunia.com>
    Tested-by: Secunia Research <vuln@secunia.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 804a15cdbbc3834504e161ee461c67f8eea959a4
Merge: bde527264307 7efba10d6bd2
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jan 30 00:44:08 2019 -0800

    Merge branch 'sctp-support-SCTP_FUTURE-CURRENT-ALL_ASSOC'
    
    Xin Long says:
    
    ====================
    sctp: support SCTP_FUTURE/CURRENT/ALL_ASSOC
    
    This patchset adds the support for 3 assoc_id constants: SCTP_FUTURE_ASSOC
    SCTP_CURRENT_ASSOC, SCTP_ALL_ASSOC, described in rfc6458#section-7.2:
    
       All socket options set on a one-to-one style listening socket also
       apply to all future accepted sockets.  For one-to-many style sockets,
       often a socket option will pass a structure that includes an assoc_id
       field.  This field can be filled with the association identifier of a
       particular association and unless otherwise specified can be filled
       with one of the following constants:
    
       SCTP_FUTURE_ASSOC:  Specifies that only future associations created
          after this socket option will be affected by this call.
    
       SCTP_CURRENT_ASSOC:  Specifies that only currently existing
          associations will be affected by this call, and future
          associations will still receive the previous default value.
    
       SCTP_ALL_ASSOC:  Specifies that all current and future associations
          will be affected by this call.
    
    The functions for many other sockopts that use assoc_id also need to be
    updated accordingly.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7efba10d6bd22030fb5931e50bf97496f932f00e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:46 2019 +0800

    sctp: add SCTP_FUTURE_ASOC and SCTP_CURRENT_ASSOC for SCTP_STREAM_SCHEDULER sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_scheduler and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_scheduler,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_STREAM_SCHEDULER in this
    patch. It also adds default_ss in sctp_sock to support
    SCTP_FUTURE_ASSOC.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d251f05e3ba2e6ab7f59c88b497facf2f61c5b2f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:45 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_EVENT sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_event and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_event,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_EVENT in this patch.
    
    It also adds sctp_assoc_ulpevent_type_set() to make code more
    readable.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 99a62135e127977c06f4c44b6b9f24492a4b2153
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:44 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_ENABLE_STREAM_RESET sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_enable_strreset and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_enable_strreset,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_ENABLE_STREAM_RESET in this patch.
    It also adjusts some code to keep a same check form as other functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3a583059d1870ad14437a6ac8730ccf7676f6df8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:43 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_PRINFO sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_default_prinfo and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_default_prinfo,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_DEFAULT_PRINFO in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2af66ff3edc79d225e52821fe2464a4cf0c8ba18
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:42 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_DEACTIVATE_KEY sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_deactivate_key.
    SCTP_CURRENT_ASSOC is supported for SCTP_AUTH_DEACTIVATE_KEY in this
    patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3adcc300603ee58038bc9e524160a625f3510e53
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:41 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_DELETE_KEY sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_del_key.
    SCTP_CURRENT_ASSOC is supported for SCTP_AUTH_DELETE_KEY in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bf9fb6ad4f297913d49ca44a7c0fcc0f791b1c24
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:40 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_ACTIVE_KEY sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_auth_key.
    SCTP_CURRENT_ASSOC is supported for SCTP_AUTH_ACTIVE_KEY in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7fb3be13a23697450f3609877c367a3750aba3b5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:39 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_AUTH_KEY sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_auth_key.
    SCTP_CURRENT_ASSOC is supported for SCTP_AUTH_KEY in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e0651a0dc87780c03683ca1613a30b982dbf964d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:38 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_MAX_BURST sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_maxburst and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_maxburst,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_CONTEXT in this patch.
    It also adjusts some code to keep a same check form as other
    functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 49b037acca8c3f7d7e43d64c6f7cec487a706e37
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:37 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_CONTEXT sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_context and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_context,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_CONTEXT in this patch.
    It also adjusts some code to keep a same check form as other
    functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 92fc3bd928c9329bf3f6f5c4210bbe4ba4bd3299
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:36 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_SNDINFO sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_default_sndinfo and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_default_sndinfo,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_DEFAULT_SNDINFO in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 707e45b3dc5a68243782de11e852e8d2cc63b739
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:35 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DEFAULT_SEND_PARAM sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_default_send_param and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_default_send_param,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_DEFAULT_SEND_PARAM in this patch.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9c5829e1c49e4e54defe5f1e5c8ff8bf48be6c52
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:34 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC and add SCTP_CURRENT_ASSOC for SCTP_DELAYED_SACK sockopt
    
    Check with SCTP_ALL_ASSOC instead in sctp_setsockopt_delayed_ack and
    check with SCTP_FUTURE_ASSOC instead in sctp_getsockopt_delayed_ack,
    it's compatible with 0.
    
    SCTP_CURRENT_ASSOC is supported for SCTP_DELAYED_SACK in this patch.
    
    It also adds sctp_apply_asoc_delayed_ack() to make code more readable.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e7f282489123d88f5d412c837775e3e8c0f5521f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:33 2019 +0800

    sctp: add SCTP_CURRENT_ASSOC for SCTP_STREAM_SCHEDULER_VALUE sockopt
    
    SCTP_STREAM_SCHEDULER_VALUE is a special one, as its value is not
    save in sctp_sock, but only in asoc. So only SCTP_CURRENT_ASSOC
    reserved assoc_id can be used in sctp_setsockopt_scheduler_value.
    
    This patch adds SCTP_CURRENT_ASOC support for
    SCTP_STREAM_SCHEDULER_VALUE.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2e7709d1cc665a5dbd079e49809907e9e17a9df3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:32 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_INTERLEAVING_SUPPORTED sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_reconfig_supported, it's compatible with 0.
    
    It also adjusts some code to keep a same check form as other functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit acce7f3b8d4f360d879762a81d4084f6ee1e3869
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:31 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_RECONFIG_SUPPORTED sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_reconfig_supported, it's compatible with 0.
    
    It also adjusts some code to keep a same check form as other functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fb1956050846331358ecd259cc1b632a092d73ff
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:30 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_PR_SUPPORTED sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_pr_supported, it's compatible with 0.
    
    It also adjusts some code to keep a same check form as other functions.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8add543e369d67ccd42f7e67d68866b4d606f632
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:29 2019 +0800

    sctp: add SCTP_FUTURE_ASSOC for SCTP_PEER_ADDR_THLDS sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_paddr_thresholds, it's compatible with 0.
    
    It also adds pf_retrans in sctp_sock to support SCTP_FUTURE_ASSOC.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 48c072174dea73c4c36ba95df87c1b4d6083df11
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:28 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_LOCAL_AUTH_CHUNKS sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_getsockopt_local_auth_chunks, it's compatible with 0.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6fd769beb0d9451739acaecebe8266550aafd268
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:27 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_MAXSEG sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_maxseg, it's compatible with 0.
    Also check asoc_id early as other sctp setsockopts does.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8889394df2aaf39aa4378fc87af300e9e813c729
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:26 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_ASSOCINFO sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_associnfo, it's compatible with 0.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7adb5ed5eec39fd829020b2568352e2745a05a50
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:25 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_RTOINFO sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_set/getsockopt_rtoinfo, it's compatible with 0.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b99e5e028bf42a65a67614bcc38547e3ece15d56
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:24 2019 +0800

    sctp: use SCTP_FUTURE_ASSOC for SCTP_PEER_ADDR_PARAMS sockopt
    
    Check with SCTP_FUTURE_ASSOC instead in
    sctp_/setgetsockopt_peer_addr_params, it's compatible with 0.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 80df2704a375bb4b3c9c5cce9c00052361b16d61
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jan 28 15:08:23 2019 +0800

    sctp: introduce SCTP_FUTURE/CURRENT/ALL_ASSOC
    
    This patch is to add 3 constants SCTP_FUTURE_ASSOC,
    SCTP_CURRENT_ASSOC and SCTP_ALL_ASSOC for reserved
    assoc_ids, as defined in rfc6458#section-7.2.
    
    And add the process for them when doing lookup and
    inserting in sctp_id2assoc and sctp_assoc_set_id.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 037222ad3f43a45c3a601dabf893efc9264ff5a0
Merge: 7c2614bf7a1f abfd04f738c2
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sun Jan 27 08:59:12 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Count ttl-dropped frames properly in mac80211, from Bob Copeland.
    
     2) Integer overflow in ktime handling of bcm can code, from Oliver
        Hartkopp.
    
     3) Fix RX desc handling wrt. hw checksumming in ravb, from Simon
        Horman.
    
     4) Various hash key fixes in hv_netvsc, from Haiyang Zhang.
    
     5) Use after free in ax25, from Eric Dumazet.
    
     6) Several fixes to the SSN support in SCTP, from Xin Long.
    
     7) Do not process frames after a NAPI reschedule in ibmveth, from
        Thomas Falcon.
    
     8) Fix NLA_POLICY_NESTED arguments, from Johannes Berg.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (42 commits)
      qed: Revert error handling changes.
      cfg80211: extend range deviation for DMG
      cfg80211: reg: remove warn_on for a normal case
      mac80211: Add attribute aligned(2) to struct 'action'
      mac80211: don't initiate TDLS connection if station is not associated to AP
      nl80211: fix NLA_POLICY_NESTED() arguments
      ibmveth: Do not process frames after calling napi_reschedule
      net: dev_is_mac_header_xmit() true for ARPHRD_RAWIP
      net: usb: asix: ax88772_bind return error when hw_reset fail
      MAINTAINERS: Update cavium networking drivers
      net/mlx4_core: Fix error handling when initializing CQ bufs in the driver
      net/mlx4_core: Add masking for a few queries on HCA caps
      sctp: set flow sport from saddr only when it's 0
      sctp: set chunk transport correctly when it's a new asoc
      sctp: improve the events for sctp stream adding
      sctp: improve the events for sctp stream reset
      ip_tunnel: Make none-tunnel-dst tunnel port work with lwtunnel
      ax25: fix possible use-after-free
      sfc: suppress duplicate nvmem partition types in efx_ef10_mtd_probe
      hv_netvsc: fix typos in code comments
      ...

commit 8220c870cb0f4eaa4e335c9645dbd9a1c461c1dd
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:40:12 2019 +0800

    sctp: improve the events for sctp stream adding
    
    This patch is to improve sctp stream adding events in 2 places:
    
      1. In sctp_process_strreset_addstrm_out(), move up SCTP_MAX_STREAM
         and in stream allocation failure checks, as the adding has to
         succeed after reconf_timer stops for the in stream adding
         request retransmission.
    
      3. In sctp_process_strreset_addstrm_in(), no event should be sent,
         as no in or out stream is added here.
    
    Fixes: 50a41591f110 ("sctp: implement receiver-side procedures for the Add Outgoing Streams Request Parameter")
    Fixes: c5c4ebb3ab87 ("sctp: implement receiver-side procedures for the Add Incoming Streams Request Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2e6dc4d95110becfe0ff4c3d4749c33ea166e9e7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jan 22 02:39:34 2019 +0800

    sctp: improve the events for sctp stream reset
    
    This patch is to improve sctp stream reset events in 4 places:
    
      1. In sctp_process_strreset_outreq(), the flag should always be set with
         SCTP_STREAM_RESET_INCOMING_SSN instead of OUTGOING, as receiver's in
         stream is reset here.
      2. In sctp_process_strreset_outreq(), move up SCTP_STRRESET_ERR_WRONG_SSN
         check, as the reset has to succeed after reconf_timer stops for the
         in stream reset request retransmission.
      3. In sctp_process_strreset_inreq(), no event should be sent, as no in
         or out stream is reset here.
      4. In sctp_process_strreset_resp(), SCTP_STREAM_RESET_INCOMING_SSN or
         OUTGOING event should always be sent for stream reset requests, no
         matter it fails or succeeds to process the request.
    
    Fixes: 810544764536 ("sctp: implement receiver-side procedures for the Outgoing SSN Reset Request Parameter")
    Fixes: 16e1a91965b0 ("sctp: implement receiver-side procedures for the Incoming SSN Reset Request Parameter")
    Fixes: 11ae76e67a17 ("sctp: implement receiver-side procedures for the Reconf Response Parameter")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e2f7cc72cbf42e037229d8bd998966569662442f
Author: Florian Westphal <fw@strlen.de>
Date:   Mon Jan 21 14:46:48 2019 +0100

    netfilter: conntrack: fix bogus port values for other l4 protocols
    
    We must only extract l4 proto information if we can track the layer 4
    protocol.
    
    Before removal of pkt_to_tuple callback, the code to extract port
    information was only reached for TCP/UDP/LITE/DCCP/SCTP.
    
    The other protocols were handled by the indirect call, and the
    'generic' tracker took care of other protocols that have no notion
    of 'ports'.
    
    After removal of the callback we must be more strict here and only
    init port numbers for those protocols that have ports.
    
    Fixes: df5e1629087a ("netfilter: conntrack: remove pkt_to_tuple callback")
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 9dde6da51297d751198d431b04b597e7679e5766
Merge: 7939f8beecf1 d671e3e0dac9
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jan 15 15:48:00 2019 -0800

    Merge branch '100GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    100GbE Intel Wired LAN Driver Updates 2019-01-15
    
    This series contains updates to the ice driver only.
    
    Bruce fixes an unused variable build warning, which was introduced with
    the commit 2fd527b72bb6 ("net: ndo_bridge_setlink: Add extack").  Added
    ethtool support for get_eeprom and get_eeprom_len operations.  Added
    support for bringing down the PHY link optional when the interface is
    administratively downed.
    
    Anirudh refactors the transmit scheduler functions, which results in
    reduced code duplication and adds a helper function, which all the
    scheduler functions call instead.  Added an LED blinking handler to
    ethtool.  Reworked the queue management code to allow for reuse in
    future XDP feature support.  Updates the driver to be able to preserve
    the aggregator list after reset by moving it out of port_info and into
    ice_hw.  Added the ability to offload SCTP checksum calculation to the
    hardware.  Added support for new PHY types, which support higher link
    speeds.
    
    Md Fahad makes sure that RSS lookup table and hash key get configured
    during the rebuild path after a reset.
    
    Brett updates the driver to set the physical link state according to the
    netdev state (up/down).  Added support for adaptive/dynamic interrupt
    moderation in the ice driver, along with the ethtool operations needed.
    
    Tony adds software timestamping support by using
    ethtool_op_get_ts_info().
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cf909e19acf373a2e1d9bd877846a11bc8e20a54
Author: Anirudh Venkataramanan <anirudh.venkataramanan@intel.com>
Date:   Wed Dec 19 10:03:32 2018 -0800

    ice: Offload SCTP checksum
    
    This patch adds the ability to offload SCTP checksum calculations to the
    NIC.
    
    Signed-off-by: Anirudh Venkataramanan <anirudh.venkataramanan@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 0302c665336fb5db03f2b0c84be21fa22ecfc09b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    [ Upstream commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3 ]
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 15c17f3654f74b4772a0a4813cf3b975d12a321c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    [ Upstream commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3 ]
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fff7f717863055643cf93378d31801e1c6091ef1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    [ Upstream commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3 ]
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a98fbfc3e37e5ba11226ccf3c0aa15e0126d4ec7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    [ Upstream commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3 ]
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit aa0c48d161954a700ba735e52d18af092079f460
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    [ Upstream commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3 ]
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 519be6995c31005ae3bad5421e09ef99d4eb0b82
Merge: ab63e725b49c d84e7bc0595a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Dec 19 23:34:33 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Off by one in netlink parsing of mac802154_hwsim, from Alexander
        Aring.
    
     2) nf_tables RCU usage fix from Taehee Yoo.
    
     3) Flow dissector needs nhoff and thoff clamping, from Stanislav
        Fomichev.
    
     4) Missing sin6_flowinfo initialization in SCTP, from Xin Long.
    
     5) Spectrev1 in ipmr and ip6mr, from Gustavo A. R. Silva.
    
     6) Fix r8169 crash when DEBUG_SHIRQ is enabled, from Heiner Kallweit.
    
     7) Fix SKB leak in rtlwifi, from Larry Finger.
    
     8) Fix state pruning in bpf verifier, from Jakub Kicinski.
    
     9) Don't handle completely duplicate fragments as overlapping, from
        Michal Kubecek.
    
    10) Fix memory corruption with macb and 64-bit DMA, from Anssi Hannula.
    
    11) Fix TCP fallback socket release in smc, from Myungho Jung.
    
    12) gro_cells_destroy needs to napi_disable, from Lorenzo Bianconi.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (130 commits)
      rds: Fix warning.
      neighbor: NTF_PROXY is a valid ndm_flag for a dump request
      net: mvpp2: fix the phylink mode validation
      net/sched: cls_flower: Remove old entries from rhashtable
      net/tls: allocate tls context using GFP_ATOMIC
      iptunnel: make TUNNEL_FLAGS available in uapi
      gro_cell: add napi_disable in gro_cells_destroy
      lan743x: Remove MAC Reset from initialization
      net/mlx5e: Remove the false indication of software timestamping support
      net/mlx5: Typo fix in del_sw_hw_rule
      net/mlx5e: RX, Fix wrong early return in receive queue poll
      ipv6: explicitly initialize udp6_addr in udp_sock_create6()
      bnxt_en: Fix ethtool self-test loopback.
      net/rds: remove user triggered WARN_ON in rds_sendmsg
      net/rds: fix warn in rds_message_alloc_sgs
      ath10k: skip sending quiet mode cmd for WCN3990
      mac80211: free skb fraglist before freeing the skb
      nl80211: fix memory leak if validate_pae_over_nl80211() fails
      net/smc: fix TCP fallback socket release
      vxge: ensure data0 is initialized in when fetching firmware version information
      ...

commit 298e11444788a49c7b8b26abe2761e26d0426a01
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    [ Upstream commit 66033f47ca60294a95fc85ec3a3cc909dab7b765 ]
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6699df6605891e6aa5d1d208fc0c0aff022a191b
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    [ Upstream commit 66033f47ca60294a95fc85ec3a3cc909dab7b765 ]
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 901936a1eab8575f94f2ee1a18fad83fa0546735
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    [ Upstream commit 66033f47ca60294a95fc85ec3a3cc909dab7b765 ]
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ece6a4b7efa8ec7764bda17ad37f46be5e141d16
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    [ Upstream commit 66033f47ca60294a95fc85ec3a3cc909dab7b765 ]
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fd018cb37ea086d62e9d6db635a3c8893d8ad58e
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    [ Upstream commit 66033f47ca60294a95fc85ec3a3cc909dab7b765 ]
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4a2eb0c37b4759416996fbb4c45b932500cf06d3
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 10 18:00:52 2018 +0800

    sctp: initialize sin6_flowinfo for ipv6 addrs in sctp_inet6addr_event
    
    syzbot reported a kernel-infoleak, which is caused by an uninitialized
    field(sin6_flowinfo) of addr->a.v6 in sctp_inet6addr_event().
    The call trace is as below:
    
      BUG: KMSAN: kernel-infoleak in _copy_to_user+0x19a/0x230 lib/usercopy.c:33
      CPU: 1 PID: 8164 Comm: syz-executor2 Not tainted 4.20.0-rc3+ #95
      Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
      Google 01/01/2011
      Call Trace:
        __dump_stack lib/dump_stack.c:77 [inline]
        dump_stack+0x32d/0x480 lib/dump_stack.c:113
        kmsan_report+0x12c/0x290 mm/kmsan/kmsan.c:683
        kmsan_internal_check_memory+0x32a/0xa50 mm/kmsan/kmsan.c:743
        kmsan_copy_to_user+0x78/0xd0 mm/kmsan/kmsan_hooks.c:634
        _copy_to_user+0x19a/0x230 lib/usercopy.c:33
        copy_to_user include/linux/uaccess.h:183 [inline]
        sctp_getsockopt_local_addrs net/sctp/socket.c:5998 [inline]
        sctp_getsockopt+0x15248/0x186f0 net/sctp/socket.c:7477
        sock_common_getsockopt+0x13f/0x180 net/core/sock.c:2937
        __sys_getsockopt+0x489/0x550 net/socket.c:1939
        __do_sys_getsockopt net/socket.c:1950 [inline]
        __se_sys_getsockopt+0xe1/0x100 net/socket.c:1947
        __x64_sys_getsockopt+0x62/0x80 net/socket.c:1947
        do_syscall_64+0xcf/0x110 arch/x86/entry/common.c:291
        entry_SYSCALL_64_after_hwframe+0x63/0xe7
    
    sin6_flowinfo is not really used by SCTP, so it will be fixed by simply
    setting it to 0.
    
    The issue exists since very beginning.
    Thanks Alexander for the reproducer provided.
    
    Reported-by: syzbot+ad5d327e6936a2e284be@syzkaller.appspotmail.com
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8b78903bc5f1786f7f988d26de48819144a13d6c
Merge: f9bfe4e6a9d0 e6ac64d4c4d0
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Dec 7 16:24:40 2018 -0800

    Merge branch 'skb-headroom-slab-out-of-bounds'
    
    Stefano Brivio says:
    
    ====================
    Fix slab out-of-bounds on insufficient headroom for IPv6 packets
    
    Patch 1/2 fixes a slab out-of-bounds occurring with short SCTP packets over
    IPv4 over L2TP over IPv6 on a configuration with relatively low HEADER_MAX.
    
    Patch 2/2 makes sure we avoid writing before the allocated buffer in
    neigh_hh_output() in case the headroom is enough for the unaligned hardware
    header size, but not enough for the aligned one, and that we warn if we hit
    this condition.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 66033f47ca60294a95fc85ec3a3cc909dab7b765
Author: Stefano Brivio <sbrivio@redhat.com>
Date:   Thu Dec 6 19:30:36 2018 +0100

    ipv6: Check available headroom in ip6_xmit() even without options
    
    Even if we send an IPv6 packet without options, MAX_HEADER might not be
    enough to account for the additional headroom required by alignment of
    hardware headers.
    
    On a configuration without HYPERV_NET, WLAN, AX25, and with IPV6_TUNNEL,
    sending short SCTP packets over IPv4 over L2TP over IPv6, we start with
    100 bytes of allocated headroom in sctp_packet_transmit(), end up with 54
    bytes after l2tp_xmit_skb(), and 14 bytes in ip6_finish_output2().
    
    Those would be enough to append our 14 bytes header, but we're going to
    align that to 16 bytes, and write 2 bytes out of the allocated slab in
    neigh_hh_output().
    
    KASan says:
    
    [  264.967848] ==================================================================
    [  264.967861] BUG: KASAN: slab-out-of-bounds in ip6_finish_output2+0x1aec/0x1c70
    [  264.967866] Write of size 16 at addr 000000006af1c7fe by task netperf/6201
    [  264.967870]
    [  264.967876] CPU: 0 PID: 6201 Comm: netperf Not tainted 4.20.0-rc4+ #1
    [  264.967881] Hardware name: IBM 2827 H43 400 (z/VM 6.4.0)
    [  264.967887] Call Trace:
    [  264.967896] ([<00000000001347d6>] show_stack+0x56/0xa0)
    [  264.967903]  [<00000000017e379c>] dump_stack+0x23c/0x290
    [  264.967912]  [<00000000007bc594>] print_address_description+0xf4/0x290
    [  264.967919]  [<00000000007bc8fc>] kasan_report+0x13c/0x240
    [  264.967927]  [<000000000162f5e4>] ip6_finish_output2+0x1aec/0x1c70
    [  264.967935]  [<000000000163f890>] ip6_finish_output+0x430/0x7f0
    [  264.967943]  [<000000000163fe44>] ip6_output+0x1f4/0x580
    [  264.967953]  [<000000000163882a>] ip6_xmit+0xfea/0x1ce8
    [  264.967963]  [<00000000017396e2>] inet6_csk_xmit+0x282/0x3f8
    [  264.968033]  [<000003ff805fb0ba>] l2tp_xmit_skb+0xe02/0x13e0 [l2tp_core]
    [  264.968037]  [<000003ff80631192>] l2tp_eth_dev_xmit+0xda/0x150 [l2tp_eth]
    [  264.968041]  [<0000000001220020>] dev_hard_start_xmit+0x268/0x928
    [  264.968069]  [<0000000001330e8e>] sch_direct_xmit+0x7ae/0x1350
    [  264.968071]  [<000000000122359c>] __dev_queue_xmit+0x2b7c/0x3478
    [  264.968075]  [<00000000013d2862>] ip_finish_output2+0xce2/0x11a0
    [  264.968078]  [<00000000013d9b14>] ip_finish_output+0x56c/0x8c8
    [  264.968081]  [<00000000013ddd1e>] ip_output+0x226/0x4c0
    [  264.968083]  [<00000000013dbd6c>] __ip_queue_xmit+0x894/0x1938
    [  264.968100]  [<000003ff80bc3a5c>] sctp_packet_transmit+0x29d4/0x3648 [sctp]
    [  264.968116]  [<000003ff80b7bf68>] sctp_outq_flush_ctrl.constprop.5+0x8d0/0xe50 [sctp]
    [  264.968131]  [<000003ff80b7c716>] sctp_outq_flush+0x22e/0x7d8 [sctp]
    [  264.968146]  [<000003ff80b35c68>] sctp_cmd_interpreter.isra.16+0x530/0x6800 [sctp]
    [  264.968161]  [<000003ff80b3410a>] sctp_do_sm+0x222/0x648 [sctp]
    [  264.968177]  [<000003ff80bbddac>] sctp_primitive_ASSOCIATE+0xbc/0xf8 [sctp]
    [  264.968192]  [<000003ff80b93328>] __sctp_connect+0x830/0xc20 [sctp]
    [  264.968208]  [<000003ff80bb11ce>] sctp_inet_connect+0x2e6/0x378 [sctp]
    [  264.968212]  [<0000000001197942>] __sys_connect+0x21a/0x450
    [  264.968215]  [<000000000119aff8>] sys_socketcall+0x3d0/0xb08
    [  264.968218]  [<000000000184ea7a>] system_call+0x2a2/0x2c0
    
    [...]
    
    Just like ip_finish_output2() does for IPv4, check that we have enough
    headroom in ip6_xmit(), and reallocate it if we don't.
    
    This issue is older than git history.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ef6fcd455278c2be3032a346cc66d9dd9866b787
Author: Cong Wang <xiyou.wangcong@gmail.com>
Date:   Wed Nov 28 15:04:05 2018 -0800

    mlx5: fix get_ip_proto()
    
    IP header is not necessarily located right after struct ethhdr,
    there could be multiple 802.1Q headers in between, this is why
    we call __vlan_get_protocol().
    
    Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets")
    Cc: Alaa Hleihel <alaa@mellanox.com>
    Cc: Or Gerlitz <ogerlitz@mellanox.com>
    Cc: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
    Acked-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 857fa628bbe93017c72ddd0d5304962a2608db07
Merge: abe72ff41340 07093b764769
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Nov 24 09:19:38 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Need to take mutex in ath9k_add_interface(), from Dan Carpenter.
    
     2) Fix mt76 build without CONFIG_LEDS_CLASS, from Arnd Bergmann.
    
     3) Fix socket wmem accounting in SCTP, from Xin Long.
    
     4) Fix failed resume crash in ena driver, from Arthur Kiyanovski.
    
     5) qed driver passes bytes instead of bits into second arg of
        bitmap_weight(). From Denis Bolotin.
    
     6) Fix reset deadlock in ibmvnic, from Juliet Kim.
    
     7) skb_scrube_packet() needs to scrub the fwd marks too, from Petr
        Machata.
    
     8) Make sure older TCP stacks see enough dup ACKs, and avoid doing SACK
        compression during this period, from Eric Dumazet.
    
     9) Add atomicity to SMC protocol cursor handling, from Ursula Braun.
    
    10) Don't leave dangling error pointer if bpf_prog_add() fails in
        thunderx driver, from Lorenzo Bianconi. Also, when we unmap TSO
        headers, set sq->tso_hdrs to NULL.
    
    11) Fix race condition over state variables in act_police, from Davide
        Caratti.
    
    12) Disable guest csum in the presence of XDP in virtio_net, from Jason
        Wang.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (64 commits)
      net: gemini: Fix copy/paste error
      net: phy: mscc: fix deadlock in vsc85xx_default_config
      dt-bindings: dsa: Fix typo in "probed"
      net: thunderx: set tso_hdrs pointer to NULL in nicvf_free_snd_queue
      net: amd: add missing of_node_put()
      team: no need to do team_notify_peers or team_mcast_rejoin when disabling port
      virtio-net: fail XDP set if guest csum is negotiated
      virtio-net: disable guest csum during XDP set
      net/sched: act_police: add missing spinlock initialization
      net: don't keep lonely packets forever in the gro hash
      net/ipv6: re-do dad when interface has IFF_NOARP flag change
      packet: copy user buffers before orphan or clone
      ibmvnic: Update driver queues after change in ring size support
      ibmvnic: Fix RX queue buffer cleanup
      net: thunderx: set xdp_prog to NULL if bpf_prog_add fails
      net/dim: Update DIM start sample after each DIM iteration
      net: faraday: ftmac100: remove netif_running(netdev) check before disabling interrupts
      net/smc: use after free fix in smc_wr_tx_put_slot()
      net/smc: atomic SMCD cursor handling
      net/smc: add SMC-D shutdown signal
      ...

commit 6bab51ff62cea6c9e0455aa748cb097a4a4ccd0a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 15:21:53 2018 +0800

    sctp: not allow to set asoc prsctp_enable by sockopt
    
    [ Upstream commit cc3ccf26f0649089b3a34a2781977755ea36e72c ]
    
    As rfc7496#section4.5 says about SCTP_PR_SUPPORTED:
    
       This socket option allows the enabling or disabling of the
       negotiation of PR-SCTP support for future associations.  For existing
       associations, it allows one to query whether or not PR-SCTP support
       was negotiated on a particular association.
    
    It means only sctp sock's prsctp_enable can be set.
    
    Note that for the limitation of SCTP_{CURRENT|ALL}_ASSOC, we will
    add it when introducing SCTP_{FUTURE|CURRENT|ALL}_ASSOC for linux
    sctp in another patchset.
    
    v1->v2:
      - drop the params.assoc_id check as Neil suggested.
    
    Fixes: 28aa4c26fce2 ("sctp: add SCTP_PR_SUPPORTED on sctp sockopt")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 56782f53537aaa10c1323c86236959e62bb75330
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 3 13:59:45 2018 +0800

    sctp: fix strchange_flags name for Stream Change Event
    
    [ Upstream commit fd82d61ba142f0b83463e47064bf5460aac57b6e ]
    
    As defined in rfc6525#section-6.1.3, SCTP_STREAM_CHANGE_DENIED
    and SCTP_STREAM_CHANGE_FAILED should be used instead of
    SCTP_ASSOC_CHANGE_DENIED and SCTP_ASSOC_CHANGE_FAILED.
    
    To keep the compatibility, fix it by adding two macros.
    
    Fixes: b444153fb5a6 ("sctp: add support for generating add stream change event notification")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c7051eb3acbe0908f29fa56b464a6c79c067f93f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 15:21:53 2018 +0800

    sctp: not allow to set asoc prsctp_enable by sockopt
    
    [ Upstream commit cc3ccf26f0649089b3a34a2781977755ea36e72c ]
    
    As rfc7496#section4.5 says about SCTP_PR_SUPPORTED:
    
       This socket option allows the enabling or disabling of the
       negotiation of PR-SCTP support for future associations.  For existing
       associations, it allows one to query whether or not PR-SCTP support
       was negotiated on a particular association.
    
    It means only sctp sock's prsctp_enable can be set.
    
    Note that for the limitation of SCTP_{CURRENT|ALL}_ASSOC, we will
    add it when introducing SCTP_{FUTURE|CURRENT|ALL}_ASSOC for linux
    sctp in another patchset.
    
    v1->v2:
      - drop the params.assoc_id check as Neil suggested.
    
    Fixes: 28aa4c26fce2 ("sctp: add SCTP_PR_SUPPORTED on sctp sockopt")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5811532fe8d1ddd95365a0893574fa8a859cc70a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 3 13:59:45 2018 +0800

    sctp: fix strchange_flags name for Stream Change Event
    
    [ Upstream commit fd82d61ba142f0b83463e47064bf5460aac57b6e ]
    
    As defined in rfc6525#section-6.1.3, SCTP_STREAM_CHANGE_DENIED
    and SCTP_STREAM_CHANGE_FAILED should be used instead of
    SCTP_ASSOC_CHANGE_DENIED and SCTP_ASSOC_CHANGE_FAILED.
    
    To keep the compatibility, fix it by adding two macros.
    
    Fixes: b444153fb5a6 ("sctp: add support for generating add stream change event notification")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cc8d2e5309ecc32162e70a285748fca4c5bd052e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 3 14:01:31 2018 +0800

    sctp: define SCTP_SS_DEFAULT for Stream schedulers
    
    [ Upstream commit 12480e3b16982c4026de10dd8155823219cd6391 ]
    
    According to rfc8260#section-4.3.2, SCTP_SS_DEFAULT is required to
    defined as SCTP_SS_FCFS or SCTP_SS_RR.
    
    SCTP_SS_FCFS is used for SCTP_SS_DEFAULT's value in this patch.
    
    Fixes: 5bbbbe32a431 ("sctp: introduce stream scheduler foundations")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7e86081c985cd690414aa7d46d500abbd988f911
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 15:21:53 2018 +0800

    sctp: not allow to set asoc prsctp_enable by sockopt
    
    [ Upstream commit cc3ccf26f0649089b3a34a2781977755ea36e72c ]
    
    As rfc7496#section4.5 says about SCTP_PR_SUPPORTED:
    
       This socket option allows the enabling or disabling of the
       negotiation of PR-SCTP support for future associations.  For existing
       associations, it allows one to query whether or not PR-SCTP support
       was negotiated on a particular association.
    
    It means only sctp sock's prsctp_enable can be set.
    
    Note that for the limitation of SCTP_{CURRENT|ALL}_ASSOC, we will
    add it when introducing SCTP_{FUTURE|CURRENT|ALL}_ASSOC for linux
    sctp in another patchset.
    
    v1->v2:
      - drop the params.assoc_id check as Neil suggested.
    
    Fixes: 28aa4c26fce2 ("sctp: add SCTP_PR_SUPPORTED on sctp sockopt")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5fe5a24a8cc8aad54ea6fce78929c61cebfbd707
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Tue Nov 13 16:16:08 2018 +0100

    selinux: check length properly in SCTP bind hook
    
    commit c138325fb8713472d5a0c3c7258b9131bab40725 upstream.
    
    selinux_sctp_bind_connect() must verify if the address buffer has
    sufficient length before accessing the 'sa_family' field. See
    __sctp_connect() for a similar check.
    
    The length of the whole address ('len') is already checked in the
    callees.
    
    Reported-by: Qian Cai <cai@gmx.us>
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Cc: <stable@vger.kernel.org> # 4.17+
    Cc: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Tested-by: Qian Cai <cai@gmx.us>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c75e3cbfd91b421747d1ff74f706315855706297
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Tue Nov 13 16:16:08 2018 +0100

    selinux: check length properly in SCTP bind hook
    
    commit c138325fb8713472d5a0c3c7258b9131bab40725 upstream.
    
    selinux_sctp_bind_connect() must verify if the address buffer has
    sufficient length before accessing the 'sa_family' field. See
    __sctp_connect() for a similar check.
    
    The length of the whole address ('len') is already checked in the
    callees.
    
    Reported-by: Qian Cai <cai@gmx.us>
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Cc: <stable@vger.kernel.org> # 4.17+
    Cc: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Tested-by: Qian Cai <cai@gmx.us>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cc3ccf26f0649089b3a34a2781977755ea36e72c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 15:21:53 2018 +0800

    sctp: not allow to set asoc prsctp_enable by sockopt
    
    As rfc7496#section4.5 says about SCTP_PR_SUPPORTED:
    
       This socket option allows the enabling or disabling of the
       negotiation of PR-SCTP support for future associations.  For existing
       associations, it allows one to query whether or not PR-SCTP support
       was negotiated on a particular association.
    
    It means only sctp sock's prsctp_enable can be set.
    
    Note that for the limitation of SCTP_{CURRENT|ALL}_ASSOC, we will
    add it when introducing SCTP_{FUTURE|CURRENT|ALL}_ASSOC for linux
    sctp in another patchset.
    
    v1->v2:
      - drop the params.assoc_id check as Neil suggested.
    
    Fixes: 28aa4c26fce2 ("sctp: add SCTP_PR_SUPPORTED on sctp sockopt")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cfc6731d2f793942cda664251faf353623e8aa10
Merge: f2be6d710d25 480ba9c18a27
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Nov 19 12:25:43 2018 -0800

    Merge branch 'sctp-add-subscribe-per-asoc-and-sockopt-SCTP_EVENT'
    
    Xin Long says:
    
    ====================
    sctp: add subscribe per asoc and sockopt SCTP_EVENT
    
    This patchset mainly adds the Event Subscription sockopt described in
    rfc6525#section-6.2:
    
    "Subscribing to events as described in [RFC6458] uses a setsockopt()
    call with the SCTP_EVENT socket option.  This option takes the
    following structure, which specifies the association, the event type
    (using the same value found in the event type field), and an on/off
    boolean.
    
      struct sctp_event {
        sctp_assoc_t se_assoc_id;
        uint16_t     se_type;
        uint8_t      se_on;
      };
    
    The user fills in the se_type field with the same value found in the
    strreset_type field, i.e., SCTP_STREAM_RESET_EVENT.  The user will
    also fill in the se_assoc_id field with either the association to set
    this event on (this field is ignored for one-to-one style sockets) or
    one of the reserved constant values defined in [RFC6458].  Finally,
    the se_on field is set with a 1 to enable the event or a 0 to disable
    the event."
    
    As for the old SCTP_EVENTS Option with struct sctp_event_subscribe,
    it's being DEPRECATED.
    
    v1->v2:
      - fix some key word in changelog that triggerred the filters at
        vger.kernel.org.
    v2->v3:
      - fix an array out of bounds noticed by Neil in patch 1/4.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 480ba9c18a27ff77b02a2012e50dfd3e20ee9f7a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 16:08:54 2018 +0800

    sctp: add sockopt SCTP_EVENT
    
    This patch adds sockopt SCTP_EVENT described in rfc6525#section-6.2.
    With this sockopt users can subscribe to an event from a specified
    asoc.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 88ee48c1f3b7092414fb93c3cf0838ba24f62e16
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 16:08:53 2018 +0800

    sctp: rename enum sctp_event to sctp_event_type
    
    sctp_event is a structure name defined in RFC for sockopt
    SCTP_EVENT. To avoid the conflict, rename it.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a1e3a0590f9bd232f3a03fd87226a4a99bd5ec92
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 18 16:08:52 2018 +0800

    sctp: add subscribe per asoc
    
    The member subscribe should be per asoc, so that sockopt SCTP_EVENT
    in the next patch can subscribe a event from one asoc only.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit da5322e65940e4e8426613a8ff3d99a08b350a52
Merge: 282fd2a2adb4 877181a8d9dc
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Nov 15 11:26:09 2018 -0600

    Merge tag 'selinux-pr-20181115' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull SELinux fixes from Paul Moore:
     "Two small SELinux fixes for v4.20.
    
      Ondrej's patch adds a check on user input, and my patch ensures we
      don't look past the end of a buffer.
    
      Both patches are quite small and pass the selinux-testsuite"
    
    * tag 'selinux-pr-20181115' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      selinux: fix non-MLS handling in mls_context_to_sid()
      selinux: check length properly in SCTP bind hook

commit a6ed6f2269d64b0eb65e27eac16c9852ff05e50f
Author: Dmitry Bogdanov <dmitry.bogdanov@aquantia.com>
Date:   Mon Nov 12 15:46:02 2018 +0000

    net: aquantia: add support of L3/L4 ntuple filters
    
    Add support of L3/L4 5-tuple {protocol, src-ip, dst-ip, src-port, dst-port}
    filters. Mask is not supported. Src-port and dst-port are only compared for
    TCP/UDP/SCTP packets. Both IPv4 and IPv6 are supported.
    The supported actions are the drop and the queue assignment.
    Due to fixed order of the rules in the NIC, the location 32-39 are
    reserved for L3/L4 5-tuple filters. The locations 32 and 36 are
    reserved for IPv6 filters.
    
    Examples:
    sudo ethtool -N eth0 flow-type ip6 src-ip 2001:db8:0:f101::2 \
    dst-ip 2001:db8:0:f101::5 action -1 loc 36
    
    sudo ethtool -N eth0 flow-type udp4 src-ip 10.0.0.4 \
    dst-ip 10.0.0.7 src-port 2000 dst-port 2001 action 2 loc 32
    
    Signed-off-by: Dmitry Bogdanov <dmitry.bogdanov@aquantia.com>
    Signed-off-by: Igor Russkikh <igor.russkikh@aquantia.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c138325fb8713472d5a0c3c7258b9131bab40725
Author: Ondrej Mosnacek <omosnace@redhat.com>
Date:   Tue Nov 13 16:16:08 2018 +0100

    selinux: check length properly in SCTP bind hook
    
    selinux_sctp_bind_connect() must verify if the address buffer has
    sufficient length before accessing the 'sa_family' field. See
    __sctp_connect() for a similar check.
    
    The length of the whole address ('len') is already checked in the
    callees.
    
    Reported-by: Qian Cai <cai@gmx.us>
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Cc: <stable@vger.kernel.org> # 4.17+
    Cc: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
    Tested-by: Qian Cai <cai@gmx.us>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 79d47dd686d09ad32af1ad2f9191dbc43909bf86
Author: Jia-Ju Bai <baijiaju1990@163.com>
Date:   Tue Oct 3 10:25:22 2017 +0800

    crypto: shash - Fix a sleep-in-atomic bug in shash_setkey_unaligned
    
    [ Upstream commit 9039f3ef446e9ffa200200c934f049add9e58426 ]
    
    The SCTP program may sleep under a spinlock, and the function call path is:
    sctp_generate_t3_rtx_event (acquire the spinlock)
      sctp_do_sm
        sctp_side_effects
          sctp_cmd_interpreter
            sctp_make_init_ack
              sctp_pack_cookie
                crypto_shash_setkey
                  shash_setkey_unaligned
                    kmalloc(GFP_KERNEL)
    
    For the same reason, the orinoco driver may sleep in interrupt handler,
    and the function call path is:
    orinoco_rx_isr_tasklet
      orinoco_rx
        orinoco_mic
          crypto_shash_setkey
            shash_setkey_unaligned
              kmalloc(GFP_KERNEL)
    
    To fix it, GFP_KERNEL is replaced with GFP_ATOMIC.
    This bug is found by my static analysis tool and my code review.
    
    Signed-off-by: Jia-Ju Bai <baijiaju1990@163.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1b0bb7e515b2292da2be1286b994ad1cf1096af3
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    [ Upstream commit b336decab22158937975293aea79396525f92bb3 ]
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 333de2f4131efde180eba58abe231f4ad35d8451
Author: Jia-Ju Bai <baijiaju1990@163.com>
Date:   Tue Oct 3 10:25:22 2017 +0800

    crypto: shash - Fix a sleep-in-atomic bug in shash_setkey_unaligned
    
    [ Upstream commit 9039f3ef446e9ffa200200c934f049add9e58426 ]
    
    The SCTP program may sleep under a spinlock, and the function call path is:
    sctp_generate_t3_rtx_event (acquire the spinlock)
      sctp_do_sm
        sctp_side_effects
          sctp_cmd_interpreter
            sctp_make_init_ack
              sctp_pack_cookie
                crypto_shash_setkey
                  shash_setkey_unaligned
                    kmalloc(GFP_KERNEL)
    
    For the same reason, the orinoco driver may sleep in interrupt handler,
    and the function call path is:
    orinoco_rx_isr_tasklet
      orinoco_rx
        orinoco_mic
          crypto_shash_setkey
            shash_setkey_unaligned
              kmalloc(GFP_KERNEL)
    
    To fix it, GFP_KERNEL is replaced with GFP_ATOMIC.
    This bug is found by my static analysis tool and my code review.
    
    Signed-off-by: Jia-Ju Bai <baijiaju1990@163.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fee37f15abcc273766186e13c2ff0338f14035cd
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    [ Upstream commit b336decab22158937975293aea79396525f92bb3 ]
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 55eb3e7e4f3000896abbf9955cbb0757e585b16d
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    [ Upstream commit b336decab22158937975293aea79396525f92bb3 ]
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a13511dfa836c8305a737436eed3ba9a8e74a826
Merge: 163c8d54a997 a422757e8c32
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Nov 6 07:44:04 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Handle errors mid-stream of an all dump, from Alexey Kodanev.
    
     2) Fix build of openvswitch with certain combinations of netfilter
        options, from Arnd Bergmann.
    
     3) Fix interactions between GSO and BQL, from Eric Dumazet.
    
     4) Don't put a '/' in RTL8201F's sysfs file name, from Holger
        Hoffsttte.
    
     5) S390 qeth driver fixes from Julian Wiedmann.
    
     6) Allow ipv6 link local addresses for netconsole when both source and
        destination are link local, from Matwey V. Kornilov.
    
     7) Fix the BPF program address seen in /proc/kallsyms, from Song Liu.
    
     8) Initialize mutex before use in dsa microchip driver, from Tristram
        Ha.
    
     9) Out-of-bounds access in hns3, from Yunsheng Lin.
    
    10) Various netfilter fixes from Stefano Brivio, Jozsef Kadlecsik, Jiri
        Slaby, Florian Westphal, Eric Westbrook, Andrey Ryabinin, and Pablo
        Neira Ayuso.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (50 commits)
      net: alx: make alx_drv_name static
      net: bpfilter: fix iptables failure if bpfilter_umh is disabled
      sock_diag: fix autoloading of the raw_diag module
      net: core: netpoll: Enable netconsole IPv6 link local address
      ipv6: properly check return value in inet6_dump_all()
      rtnetlink: restore handling of dumpit return value in rtnl_dump_all()
      net/ipv6: Move anycast init/cleanup functions out of CONFIG_PROC_FS
      bonding/802.3ad: fix link_failure_count tracking
      net: phy: realtek: fix RTL8201F sysfs name
      sctp: define SCTP_SS_DEFAULT for Stream schedulers
      sctp: fix strchange_flags name for Stream Change Event
      mlxsw: spectrum: Fix IP2ME CPU policer configuration
      openvswitch: fix linking without CONFIG_NF_CONNTRACK_LABELS
      qed: fix link config error handling
      net: hns3: Fix for out-of-bounds access when setting pfc back pressure
      net/mlx4_en: use __netdev_tx_sent_queue()
      net: do not abort bulk send on BQL status
      net: bql: add __netdev_tx_sent_queue()
      s390/qeth: report 25Gbit link speed
      s390/qeth: sanitize ARP requests
      ...

commit 606694e5ec81d598c0300f9e16db0464659df557
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    [ Upstream commit b336decab22158937975293aea79396525f92bb3 ]
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 721933262ef72a24595598ad6d20e98fc1b1ab82
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    [ Upstream commit b336decab22158937975293aea79396525f92bb3 ]
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2b52f2c4e5e7da9203b0e8762e68dc3f3305b634
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Oct 29 23:13:11 2018 +0800

    sctp: check policy more carefully when getting pr status
    
    [ Upstream commit 713358369382cebf92f6e98ce2005f94e7344931 ]
    
    When getting pr_assocstatus and pr_streamstatus by sctp_getsockopt,
    it doesn't correctly process the case when policy is set with
    SCTP_PR_SCTP_ALL | SCTP_PR_SCTP_MASK. It even causes a
    slab-out-of-bounds in sctp_getsockopt_pr_streamstatus().
    
    This patch fixes it by return -EINVAL for this case.
    
    Fixes: 0ac1077e3a54 ("sctp: get pr_assoc and pr_stream all status with SCTP_PR_SCTP_ALL")
    Reported-by: syzbot+5da0d0a72a9e7d791748@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 12480e3b16982c4026de10dd8155823219cd6391
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 3 14:01:31 2018 +0800

    sctp: define SCTP_SS_DEFAULT for Stream schedulers
    
    According to rfc8260#section-4.3.2, SCTP_SS_DEFAULT is required to
    defined as SCTP_SS_FCFS or SCTP_SS_RR.
    
    SCTP_SS_FCFS is used for SCTP_SS_DEFAULT's value in this patch.
    
    Fixes: 5bbbbe32a431 ("sctp: introduce stream scheduler foundations")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fd82d61ba142f0b83463e47064bf5460aac57b6e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 3 13:59:45 2018 +0800

    sctp: fix strchange_flags name for Stream Change Event
    
    As defined in rfc6525#section-6.1.3, SCTP_STREAM_CHANGE_DENIED
    and SCTP_STREAM_CHANGE_FAILED should be used instead of
    SCTP_ASSOC_CHANGE_DENIED and SCTP_ASSOC_CHANGE_FAILED.
    
    To keep the compatibility, fix it by adding two macros.
    
    Fixes: b444153fb5a6 ("sctp: add support for generating add stream change event notification")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 713358369382cebf92f6e98ce2005f94e7344931
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Oct 29 23:13:11 2018 +0800

    sctp: check policy more carefully when getting pr status
    
    When getting pr_assocstatus and pr_streamstatus by sctp_getsockopt,
    it doesn't correctly process the case when policy is set with
    SCTP_PR_SCTP_ALL | SCTP_PR_SCTP_MASK. It even causes a
    slab-out-of-bounds in sctp_getsockopt_pr_streamstatus().
    
    This patch fixes it by return -EINVAL for this case.
    
    Fixes: 0ac1077e3a54 ("sctp: get pr_assoc and pr_stream all status with SCTP_PR_SCTP_ALL")
    Reported-by: syzbot+5da0d0a72a9e7d791748@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 41a7aa7b800dd0a12d3bedc1947451e503dfee74
Author: Sunil Goutham <sgoutham@marvell.com>
Date:   Mon Oct 22 23:26:01 2018 +0530

    octeontx2-af: NIX Rx flowkey configuration for RSS
    
    Configure NIX RX flowkey algorithm configuration to support
    RSS (receive side scaling). Currently support for only L3/L4
    2-tuple and 4-tuple hash of IPv4/v6/TCP/UDP/SCTP is added.
    HW supports upto 32 different flowkey algorithms which SW
    can define, this patch defines 9. NPC RX ACTION has to point
    to one of these flowkey indices for RSS to work.
    
    The configuration is dependent on NPC parse result's layer
    info. So if NPC KPU profile changes suchthat LID/LTYPE values
    of above said protocols change then this configuration will
    most likely be effected.
    
    Signed-off-by: Sunil Goutham <sgoutham@marvell.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a97380aeb387c147bd44e82e82e77f4d2e96614d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    commit 1071ec9d453a38023579714b64a951a2fb982071 upstream.
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 91b15613ce7fb3e724ca0d433eef8e6bf15322af
Merge: 2a9666105445 d4d576f5ab7e
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Oct 19 09:16:20 2018 +0200

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    David writes:
      "Networking
    
       1) Fix gro_cells leak in xfrm layer, from Li RongQing.
    
       2) BPF selftests change RLIMIT_MEMLOCK blindly, don't do that.  From
          Eric Dumazet.
    
       3) AF_XDP calls synchronize_net() under RCU lock, fix from Bjrn
          Tpel.
    
       4) Out of bounds packet access in _decode_session6(), from Alexei
          Starovoitov.
    
       5) Several ethtool bugs, where we copy a struct into the kernel twice
          and our validations of the values in the first copy can be
          invalidated by the second copy due to asynchronous updates to the
          memory by the user.  From Wenwen Wang.
    
       6) Missing netlink attribute validation in cls_api, from Davide
          Caratti.
    
       7) LLC SAP sockets neet to be SOCK_RCU FREE, from Cong Wang.
    
       8) rxrpc operates on wrong kvec, from Yue Haibing.
    
       9) A regression was introduced by the disassosciation of route
          neighbour references in rt6_probe(), causing probe for
          neighbourless routes to not be properly rate limited.  Fix from
          Sabrina Dubroca.
    
       10) Unsafe RCU locking in tipc, from Tung Nguyen.
    
       11) Use after free in inet6_mc_check(), from Eric Dumazet.
    
       12) PMTU from icmp packets should update the SCTP transport pathmtu,
           from Xin Long.
    
       13) Missing peer put on error in rxrpc, from David Howells.
    
       14) Fix pedit in nfp driver, from Pieter Jansen van Vuuren.
    
       15) Fix overflowing shift statement in qla3xxx driver, from Nathan
           Chancellor.
    
       16) Fix Spectre v1 in ptp code, from Gustavo A. R. Silva.
    
       17) udp6_unicast_rcv_skb() interprets udpv6_queue_rcv_skb() return
           value in an inverted manner, fix from Paolo Abeni.
    
       18) Fix missed unresolved entries in ipmr dumps, from Nikolay
           Aleksandrov.
    
       19) Fix NAPI handling under high load, we can completely miss events
           when NAPI has to loop more than one time in a cycle.  From Heiner
           Kallweit."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (49 commits)
      ip6_tunnel: Fix encapsulation layout
      tipc: fix info leak from kernel tipc_event
      net: socket: fix a missing-check bug
      net: sched: Fix for duplicate class dump
      r8169: fix NAPI handling under high load
      net: ipmr: fix unresolved entry dumps
      net: mscc: ocelot: Fix comment in ocelot_vlant_wait_for_completion()
      sctp: fix the data size calculation in sctp_data_size
      virtio_net: avoid using netif_tx_disable() for serializing tx routine
      udp6: fix encap return code for resubmitting
      mlxsw: core: Fix use-after-free when flashing firmware during init
      sctp: not free the new asoc when sctp_wait_for_connect returns err
      sctp: fix race on sctp_id2asoc
      r8169: re-enable MSI-X on RTL8168g
      net: bpfilter: use get_pid_task instead of pid_task
      ptp: fix Spectre v1 vulnerability
      net: qla3xxx: Remove overflowing shift statement
      geneve, vxlan: Don't set exceptions if skb->len < mtu
      geneve, vxlan: Don't check skb_dst() twice
      sctp: get pr_assoc and pr_stream all status with SCTP_PR_SCTP_ALL instead
      ...

commit 605c0ac182c34867bda71bfbcc74958aabbe2fe0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Oct 17 03:07:50 2018 +0800

    sctp: count both sk and asoc sndbuf with skb truesize and sctp_chunk size
    
    Now it's confusing that asoc sndbuf_used is doing memory accounting with
    SCTP_DATA_SNDSIZE(chunk) + sizeof(sk_buff) + sizeof(sctp_chunk) while sk
    sk_wmem_alloc is doing that with skb->truesize + sizeof(sctp_chunk).
    
    It also causes sctp_prsctp_prune to count with a wrong freed memory when
    sndbuf_policy is not set.
    
    To make this right and also keep consistent between asoc sndbuf_used, sk
    sk_wmem_alloc and sk_wmem_queued, use skb->truesize + sizeof(sctp_chunk)
    for them.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b336decab22158937975293aea79396525f92bb3
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 16 15:18:17 2018 -0300

    sctp: fix race on sctp_id2asoc
    
    syzbot reported an use-after-free involving sctp_id2asoc.  Dmitry Vyukov
    helped to root cause it and it is because of reading the asoc after it
    was freed:
    
            CPU 1                       CPU 2
    (working on socket 1)            (working on socket 2)
                                     sctp_association_destroy
    sctp_id2asoc
       spin lock
         grab the asoc from idr
       spin unlock
                                       spin lock
                                         remove asoc from idr
                                       spin unlock
                                       free(asoc)
       if asoc->base.sk != sk ... [*]
    
    This can only be hit if trying to fetch asocs from different sockets. As
    we have a single IDR for all asocs, in all SCTP sockets, their id is
    unique on the system. An application can try to send stuff on an id
    that matches on another socket, and the if in [*] will protect from such
    usage. But it didn't consider that as that asoc may belong to another
    socket, it may be freed in parallel (read: under another socket lock).
    
    We fix it by moving the checks in [*] into the protected region. This
    fixes it because the asoc cannot be freed while the lock is held.
    
    Reported-by: syzbot+c7dd55d7aec49d48e49a@syzkaller.appspotmail.com
    Acked-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0ac1077e3a549bf8d35971613e2be05bdbb41a00
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 16 15:52:02 2018 +0800

    sctp: get pr_assoc and pr_stream all status with SCTP_PR_SCTP_ALL instead
    
    According to rfc7496 section 4.3 or 4.4:
    
       sprstat_policy:  This parameter indicates for which PR-SCTP policy
          the user wants the information.  It is an error to use
          SCTP_PR_SCTP_NONE in sprstat_policy.  If SCTP_PR_SCTP_ALL is used,
          the counters provided are aggregated over all supported policies.
    
    We change to dump pr_assoc and pr_stream all status by SCTP_PR_SCTP_ALL
    instead, and return error for SCTP_PR_SCTP_NONE, as it also said "It is
    an error to use SCTP_PR_SCTP_NONE in sprstat_policy. "
    
    Fixes: 826d253d57b1 ("sctp: add SCTP_PR_ASSOC_STATUS on sctp sockopt")
    Fixes: d229d48d183f ("sctp: add SCTP_PR_STREAM_STATUS sockopt for prsctp")
    Reported-by: Ying Xu <yinxu@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dd74f815dd41bdb6a979e36b4d35ba7d364281ae
Author: Jian Shen <shenjian15@huawei.com>
Date:   Mon Oct 1 12:46:43 2018 +0100

    net: hns3: Add support for rule add/delete for flow director
    
    This patch adds support for add and delete rule by ethtool commands.
    HNS3 driver supports several flow types, include ETHER_FLOW,
    IP_USER_FLOW, TCP_V4_FLOW, UDP_V4_FLOW, SCTP_V4_FLOW, IPV6_USER_FLOW,
    TCP_V6_FLOW, UDP_V6_FLOW and SCTP_V6_FLOW.
    
    Signed-off-by: Jian Shen <shenjian15@huawei.com>
    Signed-off-by: Peng Li <lipeng321@huawei.com>
    Signed-off-by: Salil Mehta <salil.mehta@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ddc9cc0131619382678771b0b85632f28bcf2521
Merge: 2002bc328ca3 fe1dc069990c
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Sep 6 15:42:04 2018 -0700

    Merge tag 'mlx5e-updates-2018-09-05' of git://git.kernel.org/pub/scm/linux/kernel/git/saeed/linux
    
    Saeed Mahameed says:
    
    ====================
    mlx5e-updates-2018-09-05
    
    This series provides updates to mlx5 ethernet driver.
    
    1) Starting with a four patches series to optimize flow counters updates,
    From Vlad Buslov:
    ==============================================
    
    By default mlx5 driver updates cached counters each second. Update function
    consumes noticeable amount of CPU resources. The goal of this patch series
    is to optimize update function.
    
    Investigation revealed following bottlenecks in fs counters
    implementation:
     1) Update code(scheduled each second) iterates over all counters twice.
     (first for finding and deleting counters that are marked for deletion,
     second iteration is for actually updating the counters)
     2) Counters are stored in rb tree. Linear iteration over all rb tree
     elements(rb_next in profiling data) consumed ~65% of time spent in
     update function.
    
    Following optimizations were implemented:
     1) Instead of just marking counters for deletion, store them in
     standalone list. This removes first iteration over whole counters tree.
     2) Store counters in sorted list to optimize traversing them and remove
     calls to rb_next.
    
    First implementation of these changes caused degradation of performance,
    instead of improving it. Investigation revealed that there first cache
    line of struct mlx5_fc is full and adding anything to it causes amount
    of cache misses to double. To mitigate that, following refactorings were
    implemented:
     - Change 'addlist' list type from double linked to single linked. This
     allowes to get free space for one additional pointer that is used to
     store deletion list(optimization 1)
     - Substitute rb tree with idr. Idr is non-intrusive data structure and
     doesn't require adding any new members to struct mlx5_fc. Use free
     space that became available for double linked sorted list that is used
     for traversing all counters. (optimization 2)
    
    Described changes reduced CPU time spent in mlx5_fc_stats_work from 70%
    to 44%. (global perf profile mode)
    ============================================
    
    The rest of the series are misc updates:
    
    2) From Kamal, Move mlx5e_priv_flags into en_ethtool.c, to avoid a
    compilation warning.
    
    3) From Roi Dayan, Move Q counters allocation and drop RQ to init_rx profile
    function to avoid allocating Q counters when not required.
    
    4) From Shay Agroskin, Replace PTP clock lock from RW lock to seq lock.
    Almost double the packet rate when timestamping is active on multiple TX
    queues.
    
    5) From: Natali Shechtman, set ECN for received packets using CQE indication.
    
    6) From: Alaa Hleihel, don't set CHECKSUM_COMPLETE on SCTP packets.
    CHECKSUM_COMPLETE is not applicable to SCTP protocol.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fe1dc069990c1f290ef6b99adb46332c03258f38
Author: Alaa Hleihel <alaa@mellanox.com>
Date:   Tue Jul 10 13:34:06 2018 +0300

    net/mlx5e: don't set CHECKSUM_COMPLETE on SCTP packets
    
    CHECKSUM_COMPLETE is not applicable to SCTP protocol.
    Setting it for SCTP packets leads to CRC32c validation failure.
    
    Fixes: bbceefce9adf ("net/mlx5e: Support RX CHECKSUM_COMPLETE")
    Signed-off-by: Alaa Hleihel <alaa@mellanox.com>
    Reviewed-by: Or Gerlitz <ogerlitz@mellanox.com>
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>

commit 9a76aba02a37718242d7cdc294f0a3901928aa57
Merge: 0a957467c5fd 26a1ccc6c117
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Aug 15 15:04:25 2018 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Highlights:
    
       - Gustavo A. R. Silva keeps working on the implicit switch fallthru
         changes.
    
       - Support 802.11ax High-Efficiency wireless in cfg80211 et al, From
         Luca Coelho.
    
       - Re-enable ASPM in r8169, from Kai-Heng Feng.
    
       - Add virtual XFRM interfaces, which avoids all of the limitations of
         existing IPSEC tunnels. From Steffen Klassert.
    
       - Convert GRO over to use a hash table, so that when we have many
         flows active we don't traverse a long list during accumluation.
    
       - Many new self tests for routing, TC, tunnels, etc. Too many
         contributors to mention them all, but I'm really happy to keep
         seeing this stuff.
    
       - Hardware timestamping support for dpaa_eth/fsl-fman from Yangbo Lu.
    
       - Lots of cleanups and fixes in L2TP code from Guillaume Nault.
    
       - Add IPSEC offload support to netdevsim, from Shannon Nelson.
    
       - Add support for slotting with non-uniform distribution to netem
         packet scheduler, from Yousuk Seung.
    
       - Add UDP GSO support to mlx5e, from Boris Pismenny.
    
       - Support offloading of Team LAG in NFP, from John Hurley.
    
       - Allow to configure TX queue selection based upon RX queue, from
         Amritha Nambiar.
    
       - Support ethtool ring size configuration in aquantia, from Anton
         Mikaev.
    
       - Support DSCP and flowlabel per-transport in SCTP, from Xin Long.
    
       - Support list based batching and stack traversal of SKBs, this is
         very exciting work. From Edward Cree.
    
       - Busyloop optimizations in vhost_net, from Toshiaki Makita.
    
       - Introduce the ETF qdisc, which allows time based transmissions. IGB
         can offload this in hardware. From Vinicius Costa Gomes.
    
       - Add parameter support to devlink, from Moshe Shemesh.
    
       - Several multiplication and division optimizations for BPF JIT in
         nfp driver, from Jiong Wang.
    
       - Lots of prepatory work to make more of the packet scheduler layer
         lockless, when possible, from Vlad Buslov.
    
       - Add ACK filter and NAT awareness to sch_cake packet scheduler, from
         Toke Hiland-Jrgensen.
    
       - Support regions and region snapshots in devlink, from Alex Vesker.
    
       - Allow to attach XDP programs to both HW and SW at the same time on
         a given device, with initial support in nfp. From Jakub Kicinski.
    
       - Add TLS RX offload and support in mlx5, from Ilya Lesokhin.
    
       - Use PHYLIB in r8169 driver, from Heiner Kallweit.
    
       - All sorts of changes to support Spectrum 2 in mlxsw driver, from
         Ido Schimmel.
    
       - PTP support in mv88e6xxx DSA driver, from Andrew Lunn.
    
       - Make TCP_USER_TIMEOUT socket option more accurate, from Jon
         Maxwell.
    
       - Support for templates in packet scheduler classifier, from Jiri
         Pirko.
    
       - IPV6 support in RDS, from Ka-Cheong Poon.
    
       - Native tproxy support in nf_tables, from Mt Eckl.
    
       - Maintain IP fragment queue in an rbtree, but optimize properly for
         in-order frags. From Peter Oskolkov.
    
       - Improvde handling of ACKs on hole repairs, from Yuchung Cheng"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1996 commits)
      bpf: test: fix spelling mistake "REUSEEPORT" -> "REUSEPORT"
      hv/netvsc: Fix NULL dereference at single queue mode fallback
      net: filter: mark expected switch fall-through
      xen-netfront: fix warn message as irq device name has '/'
      cxgb4: Add new T5 PCI device ids 0x50af and 0x50b0
      net: dsa: mv88e6xxx: missing unlock on error path
      rds: fix building with IPV6=m
      inet/connection_sock: prefer _THIS_IP_ to current_text_addr
      net: dsa: mv88e6xxx: bitwise vs logical bug
      net: sock_diag: Fix spectre v1 gadget in __sock_diag_cmd()
      ieee802154: hwsim: using right kind of iteration
      net: hns3: Add vlan filter setting by ethtool command -K
      net: hns3: Set tx ring' tc info when netdev is up
      net: hns3: Remove tx ring BD len register in hns3_enet
      net: hns3: Fix desc num set to default when setting channel
      net: hns3: Fix for phy link issue when using marvell phy driver
      net: hns3: Fix for information of phydev lost problem when down/up
      net: hns3: Fix for command format parsing error in hclge_is_all_function_id_zero
      net: hns3: Add support for serdes loopback selftest
      bnxt_en: take coredump_record structure off stack
      ...

commit 2b14e1ea212d6ce90a657ab8fe2161ea00518878
Merge: b70f1f3af47f 0d493b4d0be3
Author: David S. Miller <davem@davemloft.net>
Date:   Sat Aug 11 12:25:15 2018 -0700

    Merge branch 'net-sctp-Avoid-allocating-high-order-memory-with-kmalloc'
    
    Konstantin Khorenko says:
    
    ====================
    net/sctp: Avoid allocating high order memory with kmalloc()
    
    Each SCTP association can have up to 65535 input and output streams.
    For each stream type an array of sctp_stream_in or sctp_stream_out
    structures is allocated using kmalloc_array() function. This function
    allocates physically contiguous memory regions, so this can lead
    to allocation of memory regions of very high order, i.e.:
    
      sizeof(struct sctp_stream_out) == 24,
      ((65535 * 24) / 4096) == 383 memory pages (4096 byte per page),
      which means 9th memory order.
    
    This can lead to a memory allocation failures on the systems
    under a memory stress.
    
    We actually do not need these arrays of memory to be physically
    contiguous. Possible simple solution would be to use kvmalloc()
    instread of kmalloc() as kvmalloc() can allocate physically scattered
    pages if contiguous pages are not available. But the problem
    is that the allocation can happed in a softirq context with
    GFP_ATOMIC flag set, and kvmalloc() cannot be used in this scenario.
    
    So the other possible solution is to use flexible arrays instead of
    contiguios arrays of memory so that the memory would be allocated
    on a per-page basis.
    
    This patchset replaces kvmalloc() with flex_array usage.
    It consists of two parts:
    
      * First patch is preparatory - it mechanically wraps all direct
        access to assoc->stream.out[] and assoc->stream.in[] arrays
        with SCTP_SO() and SCTP_SI() wrappers so that later a direct
        array access could be easily changed to an access to a
        flex_array (or any other possible alternative).
      * Second patch replaces kmalloc_array() with flex_array usage.
    
    v2 changes:
     sctp_stream_in() users are updated to provide stream as an argument,
     sctp_stream_{in,out}_ptr() are now just sctp_stream_{in,out}().
    
    v3 changes:
     Move type chages struct sctp_stream_out -> flex_array to next patch.
     Make sctp_stream_{in,out}() static incline and move them to a header.
    
    Performance results (single stream):
    ====================================
      * Kernel: v4.18-rc6 - stock and with 2 patches from Oleg (earlier in this thread)
      * Node: CPU (8 cores): Intel(R) Xeon(R) CPU E31230 @ 3.20GHz
              RAM: 32 Gb
    
      * netperf: taken from https://github.com/HewlettPackard/netperf.git,
                 compiled from sources with sctp support
      * netperf server and client are run on the same node
      * ip link set lo mtu 1500
    
    The script used to run tests:
     # cat run_tests.sh
     #!/bin/bash
    
    for test in SCTP_STREAM SCTP_STREAM_MANY SCTP_RR SCTP_RR_MANY; do
      echo "TEST: $test";
      for i in `seq 1 3`; do
        echo "Iteration: $i";
        set -x
        netperf -t $test -H localhost -p 22222 -S 200000,200000 -s 200000,200000 \
                -l 60 -- -m 1452;
        set +x
      done
    done
    ================================================
    
    Results (a bit reformatted to be more readable):
    Recv   Send    Send
    Socket Socket  Message  Elapsed
    Size   Size    Size     Time     Throughput
    bytes  bytes   bytes    secs.    10^6bits/sec
    
                                    v4.18-rc7       v4.18-rc7 + fixes
    TEST: SCTP_STREAM
    212992 212992   1452    60.21   1125.52         1247.04
    212992 212992   1452    60.20   1376.38         1149.95
    212992 212992   1452    60.20   1131.40         1163.85
    TEST: SCTP_STREAM_MANY
    212992 212992   1452    60.00   1111.00         1310.05
    212992 212992   1452    60.00   1188.55         1130.50
    212992 212992   1452    60.00   1108.06         1162.50
    
    ===========
    Local /Remote
    Socket Size   Request  Resp.   Elapsed  Trans.
    Send   Recv   Size     Size    Time     Rate
    bytes  Bytes  bytes    bytes   secs.    per sec
    
                                            v4.18-rc7       v4.18-rc7 + fixes
    TEST: SCTP_RR
    212992 212992 1        1       60.00    45486.98        46089.43
    212992 212992 1        1       60.00    45584.18        45994.21
    212992 212992 1        1       60.00    45703.86        45720.84
    TEST: SCTP_RR_MANY
    212992 212992 1        1       60.00    40.75           40.77
    212992 212992 1        1       60.00    40.58           40.08
    212992 212992 1        1       60.00    39.98           39.97
    
    Performance results for many streams:
    =====================================
       * Kernel: v4.18-rc8 - stock and with 2 patches v3
       * Node: CPU (8 cores): Intel(R) Xeon(R) CPU E31230 @ 3.20GHz
               RAM: 32 Gb
    
       * sctp_test: https://github.com/sctp/lksctp-tools
       * both server and client are run on the same node
       * ip link set lo mtu 1500
       * sysctl -w vm.max_map_count=65530000 (need it to make memory fragmented)
    
    The script used to run tests:
    =============================
     # cat run_sctp_test.sh
     #!/bin/bash
    
    set -x
    
    uname -r
    ip link set lo mtu 1500
    swapoff -a
    
    free
    cat /proc/buddyinfo
    
    ./src/apps/sctp_test -H 127.0.0.1 -P 22222 -l -d 0 &
    sleep 3
    
    time ./src/apps/sctp_test -H 127.0.0.1 -P 22221 -h 127.0.0.1 -p 22222 \
             -s -c 1 -M 65535 -T -t 1 -x 100000 -d 0 1>/dev/null
    
    killall -9 lt-sctp_test
    ===============================
    
    Results (a bit reformatted to be more readable):
    
    1) ms stock kernel v4.18-rc8, no memory fragmentation
            test 1          test 2          test 3
    real    0m14.715s       0m14.593s       0m15.954s
    user    0m0.954s        0m0.955s        0m0.854s
    sys     0m13.388s       0m12.537s       0m13.749s
    
    2) kernel with fixes, no memory fragmentation
            test 1          test 2          test 3
    real    0m14.959s       0m14.693s       0m14.762s
    user    0m0.948s        0m0.921s        0m0.929s
    sys     0m13.538s       0m13.225s       0m13.217s
    
    3) kernel with fixes, memory fragmented
    'free':
                   total        used        free      shared  buff/cache   available
    Mem:       32906008    30555200      302740         764     2048068      266452
    Mem:       32906008    30379948      541436         764     1984624      442376
    Mem:       32906008    30717312      262380         764     1926316      109908
    
    /proc/buddyinfo:
    Node 0, zone   Normal  40773     37     34     29      0      0      0      0      0      0      0
    Node 0, zone   Normal 100332     68      8      4      2      1      1      0      0      0      0
    Node 0, zone   Normal  31113      7      2      1      0      0      0      0      0      0      0
    
            test 1          test 2          test 3
    real    0m14.159s       0m15.252s       0m15.826s
    user    0m0.839s        0m1.004s        0m1.048s
    sys     0m11.827s       0m14.240s       0m14.778s
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dc2248220a4aa61560c95aca98d4162095bd7e8a
Author: Toshiaki Makita <makita.toshiaki@lab.ntt.co.jp>
Date:   Fri Aug 3 16:58:11 2018 +0900

    veth: Avoid drops by oversized packets when XDP is enabled
    
    Oversized packets including GSO packets can be dropped if XDP is
    enabled on receiver side, so don't send such packets from peer.
    
    Drop TSO and SCTP fragmentation features so that veth devices themselves
    segment packets with XDP enabled. Also cap MTU accordingly.
    
    v4:
    - Don't auto-adjust MTU but cap max MTU.
    
    Signed-off-by: Toshiaki Makita <makita.toshiaki@lab.ntt.co.jp>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>

commit bc972ada4f85450ebf20c4981ee84a1a4b060161
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Thu Jul 26 15:30:33 2018 -0300

    perf trace beauty: Do not print NULL strarray entries
    
    We may have string tables where not all slots have values, in those
    cases its better to print the numeric value, for instance:
    
    In the table below we would show "protocol: (null)" for
    
          socket_ipproto[3]
    
    Where it would be better to show "protocol: 3".
    
          $ tools/perf/trace/beauty/socket_ipproto.sh
          static const char *socket_ipproto[] = {
                [0] = "IP",
                [103] = "PIM",
                [108] = "COMP",
                [12] = "PUP",
                [132] = "SCTP",
                [136] = "UDPLITE",
                [137] = "MPLS",
                [17] = "UDP",
                [1] = "ICMP",
                [22] = "IDP",
                [255] = "RAW",
                [29] = "TP",
                [2] = "IGMP",
                [33] = "DCCP",
                [41] = "IPV6",
                [46] = "RSVP",
                [47] = "GRE",
                [4] = "IPIP",
                [50] = "ESP",
                [51] = "AH",
                [6] = "TCP",
                [8] = "EGP",
                [92] = "MTP",
                [94] = "BEETPH",
                [98] = "ENCAP",
          };
          $
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Wang Nan <wangnan0@huawei.com>
    Link: https://lkml.kernel.org/n/tip-7djfak94eb3b9ltr79cpn3ti@git.kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 9849eec3a44c6f47948117c14d7afb8cf53bf0fb
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Thu Jul 26 09:26:13 2018 -0300

    perf beauty: Add a generator for IPPROTO_ socket's protocol constants
    
    It'll use tools/include copy of linux/in.h to generate a table to be
    used by tools, initially by the 'socket' and 'socketpair' beautifiers in
    'perf trace', but that could also be used to translate from a string
    constant to the integer value to be used in a eBPF or tracefs tracepoint
    filter.
    
    When used without any args it produces:
    
      $ tools/perf/trace/beauty/socket_ipproto.sh
      static const char *socket_ipproto[] = {
            [0] = "IP",
            [103] = "PIM",
            [108] = "COMP",
            [12] = "PUP",
            [132] = "SCTP",
            [136] = "UDPLITE",
            [137] = "MPLS",
            [17] = "UDP",
            [1] = "ICMP",
            [22] = "IDP",
            [255] = "RAW",
            [29] = "TP",
            [2] = "IGMP",
            [33] = "DCCP",
            [41] = "IPV6",
            [46] = "RSVP",
            [47] = "GRE",
            [4] = "IPIP",
            [50] = "ESP",
            [51] = "AH",
            [6] = "TCP",
            [8] = "EGP",
            [92] = "MTP",
            [94] = "BEETPH",
            [98] = "ENCAP",
      };
      $
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Wang Nan <wangnan0@huawei.com>
    Link: https://lkml.kernel.org/n/tip-v9rafqh3qn6b9kp9vfvj9f8s@git.kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>

commit 1ef66ca6fc045d9da6e4eb0231b2b38da2ce5604
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Apr 26 16:58:57 2018 -0300

    sctp: introduce sctp_dst_mtu
    
    [ Upstream commit 6ff0f871c20ec1769a481edca86f23c76b2b06d3 ]
    
    Which makes sure that the MTU respects the minimum value of
    SCTP_DEFAULT_MINSEGMENT and that it is correctly aligned.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0b0dce7a36fb9f1a9dd8245ea82d3a268c6943fe
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Jul 2 18:21:13 2018 +0800

    sctp: add spp_ipv6_flowlabel and spp_dscp for sctp_paddrparams
    
    spp_ipv6_flowlabel and spp_dscp are added in sctp_paddrparams in
    this patch so that users could set sctp_sock/asoc/transport dscp
    and flowlabel with spp_flags SPP_IPV6_FLOWLABEL or SPP_DSCP by
    SCTP_PEER_ADDR_PARAMS , as described section 8.1.12 in RFC6458.
    
    As said in last patch, it uses '| 0x100000' or '|0x1' to mark
    flowlabel or dscp is set,  so that their values could be set
    to 0.
    
    Note that to guarantee that an old app built with old kernel
    headers could work on the newer kernel, the param's check in
    sctp_g/setsockopt_peer_addr_params() is also improved, which
    follows the way that sctp_g/setsockopt_delayed_ack() or some
    other sockopts' process that accept two types of params does.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b0e9a2fe3ff971950833bc0ffc383babd9443bc4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Jun 28 15:31:00 2018 +0800

    sctp: add support for SCTP_REUSE_PORT sockopt
    
    This feature is actually already supported by sk->sk_reuse which can be
    set by socket level opt SO_REUSEADDR. But it's not working exactly as
    RFC6458 demands in section 8.1.27, like:
    
      - This option only supports one-to-one style SCTP sockets
      - This socket option must not be used after calling bind()
        or sctp_bindx().
    
    Besides, SCTP_REUSE_PORT sockopt should be provided for user's programs.
    Otherwise, the programs with SCTP_REUSE_PORT from other systems will not
    work in linux.
    
    To separate it from the socket level version, this patch adds 'reuse' in
    sctp_sock and it works pretty much as sk->sk_reuse, but with some extra
    setup limitations that are needed when it is being enabled.
    
    "It should be noted that the behavior of the socket-level socket option
    to reuse ports and/or addresses for SCTP sockets is unspecified", so it
    leaves SO_REUSEADDR as is for the compatibility.
    
    Note that the name SCTP_REUSE_PORT is somewhat confusing, as its
    functionality is nearly identical to SO_REUSEADDR, but with some
    extra restrictions. Here it uses 'reuse' in sctp_sock instead of
    'reuseport'. As for sk->sk_reuseport support for SCTP, it will be
    added in another patch.
    
    Thanks to Neil to make this clear.
    
    v1->v2:
      - add sctp_sk->reuse to separate it from the socket level version.
    v2->v3:
      - improve changelog according to Marcelo's suggestion.
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 94c5e532130207f6ecfe0e1afd4ed3495ec1706f
Author: Peng Li <lipeng321@huawei.com>
Date:   Thu Jun 28 12:12:22 2018 +0800

    net: hns3: add l4_type check for both ipv4 and ipv6
    
    HW supports UDP, TCP and SCTP packets checksum for both ipv4 and
    ipv6,  but do not support other type packets checksum for ipv4 or
    ipv6.
    
    Signed-off-by: Peng Li <lipeng321@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ca566c761ec34bb6bce3a65d1a3688818f29b64f
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c upstream.
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16:
     - Keep using WORD_ROUND() instead of SCTP_PAD4()
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 27d2d1dcad1852a8ddd4bf2068fde34d49f05bfe
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Tue May 26 17:30:17 2015 -0600

    sctp: Fix mangled IPv4 addresses on a IPv6 listening socket
    
    commit 9302d7bb0c5cd46be5706859301f18c137b2439f upstream.
    
    sctp_v4_map_v6 was subtly writing and reading from members
    of a union in a way the clobbered data it needed to read before
    it read it.
    
    Zeroing the v6 flowinfo overwrites the v4 sin_addr with 0, meaning
    that every place that calls sctp_v4_map_v6 gets ::ffff:0.0.0.0 as the
    result.
    
    Reorder things to guarantee correct behaviour no matter what the
    union layout is.
    
    This impacts user space clients that open an IPv6 SCTP socket and
    receive IPv4 connections. Prior to 299ee user space would see a
    sockaddr with AF_INET and a correct address, after 299ee the sockaddr
    is AF_INET6, but the address is wrong.
    
    Fixes: 299ee123e198 (sctp: Fixup v4mapped behaviour to comply with Sock API)
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2ed49aa1a49a3494de84041f087bcbce57a929f8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 5 12:16:58 2018 +0800

    sctp: not allow transport timeout value less than HZ/5 for hb_timer
    
    [ Upstream commit 1d88ba1ebb2763aa86172cd7ca05dedbeccc0d35 ]
    
    syzbot reported a rcu_sched self-detected stall on CPU which is caused
    by too small value set on rto_min with SCTP_RTOINFO sockopt. With this
    value, hb_timer will get stuck there, as in its timer handler it starts
    this timer again with this value, then goes to the timer handler again.
    
    This problem is there since very beginning, and thanks to Eric for the
    reproducer shared from a syzbot mail.
    
    This patch fixes it by not allowing sctp_transport_timeout to return a
    smaller value than HZ/5 for hb_timer, which is based on TCP's min rto.
    
    Note that it doesn't fix this issue by limiting rto_min, as some users
    are still using small rto and no proper value was found for it yet.
    
    Reported-by: syzbot+3dcd59a1f907245f891f@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 60473d7034eec45f7dfe94b59fafba2dc683dfe7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 5 12:16:58 2018 +0800

    sctp: not allow transport timeout value less than HZ/5 for hb_timer
    
    [ Upstream commit 1d88ba1ebb2763aa86172cd7ca05dedbeccc0d35 ]
    
    syzbot reported a rcu_sched self-detected stall on CPU which is caused
    by too small value set on rto_min with SCTP_RTOINFO sockopt. With this
    value, hb_timer will get stuck there, as in its timer handler it starts
    this timer again with this value, then goes to the timer handler again.
    
    This problem is there since very beginning, and thanks to Eric for the
    reproducer shared from a syzbot mail.
    
    This patch fixes it by not allowing sctp_transport_timeout to return a
    smaller value than HZ/5 for hb_timer, which is based on TCP's min rto.
    
    Note that it doesn't fix this issue by limiting rto_min, as some users
    are still using small rto and no proper value was found for it yet.
    
    Reported-by: syzbot+3dcd59a1f907245f891f@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 86b962864e73e4ba31e548e7445f44b39e289b88
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 5 12:16:58 2018 +0800

    sctp: not allow transport timeout value less than HZ/5 for hb_timer
    
    [ Upstream commit 1d88ba1ebb2763aa86172cd7ca05dedbeccc0d35 ]
    
    syzbot reported a rcu_sched self-detected stall on CPU which is caused
    by too small value set on rto_min with SCTP_RTOINFO sockopt. With this
    value, hb_timer will get stuck there, as in its timer handler it starts
    this timer again with this value, then goes to the timer handler again.
    
    This problem is there since very beginning, and thanks to Eric for the
    reproducer shared from a syzbot mail.
    
    This patch fixes it by not allowing sctp_transport_timeout to return a
    smaller value than HZ/5 for hb_timer, which is based on TCP's min rto.
    
    Note that it doesn't fix this issue by limiting rto_min, as some users
    are still using small rto and no proper value was found for it yet.
    
    Reported-by: syzbot+3dcd59a1f907245f891f@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f9c8107b982034bd727dc1da00b907275cf99cbf
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 5 12:16:58 2018 +0800

    sctp: not allow transport timeout value less than HZ/5 for hb_timer
    
    [ Upstream commit 1d88ba1ebb2763aa86172cd7ca05dedbeccc0d35 ]
    
    syzbot reported a rcu_sched self-detected stall on CPU which is caused
    by too small value set on rto_min with SCTP_RTOINFO sockopt. With this
    value, hb_timer will get stuck there, as in its timer handler it starts
    this timer again with this value, then goes to the timer handler again.
    
    This problem is there since very beginning, and thanks to Eric for the
    reproducer shared from a syzbot mail.
    
    This patch fixes it by not allowing sctp_transport_timeout to return a
    smaller value than HZ/5 for hb_timer, which is based on TCP's min rto.
    
    Note that it doesn't fix this issue by limiting rto_min, as some users
    are still using small rto and no proper value was found for it yet.
    
    Reported-by: syzbot+3dcd59a1f907245f891f@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1d88ba1ebb2763aa86172cd7ca05dedbeccc0d35
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 5 12:16:58 2018 +0800

    sctp: not allow transport timeout value less than HZ/5 for hb_timer
    
    syzbot reported a rcu_sched self-detected stall on CPU which is caused
    by too small value set on rto_min with SCTP_RTOINFO sockopt. With this
    value, hb_timer will get stuck there, as in its timer handler it starts
    this timer again with this value, then goes to the timer handler again.
    
    This problem is there since very beginning, and thanks to Eric for the
    reproducer shared from a syzbot mail.
    
    This patch fixes it by not allowing sctp_transport_timeout to return a
    smaller value than HZ/5 for hb_timer, which is based on TCP's min rto.
    
    Note that it doesn't fix this issue by limiting rto_min, as some users
    are still using small rto and no proper value was found for it yet.
    
    Reported-by: syzbot+3dcd59a1f907245f891f@syzkaller.appspotmail.com
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8a4631144b793590f1b5d2532a7f66df6de29423
Merge: 704996566f97 da3627c30d22
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Jun 4 14:34:06 2018 -0700

    Merge tag 'dlm-4.18' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm
    
    Pull dlm updates from David Teigland:
     "These three commits fix and clean up the flags dlm was using on its
      SCTP sockets. This improves performance and fixes some bad connection
      delays"
    
    * tag 'dlm-4.18' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm:
      dlm: remove O_NONBLOCK flag in sctp_connect_to_sock
      dlm: make sctp_connect_to_sock() return in specified time
      dlm: fix a clerical error when set SCTP_NODELAY

commit 61079d7091f4a673a337b5d63e7e7e38ac405d37
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c upstream.
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Keep using WORD_ROUND() instead of SCTP_PAD4()
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 43da4014d8fb05379f19abe26d61af608bd680fd
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Tue May 26 17:30:17 2015 -0600

    sctp: Fix mangled IPv4 addresses on a IPv6 listening socket
    
    commit 9302d7bb0c5cd46be5706859301f18c137b2439f upstream.
    
    sctp_v4_map_v6 was subtly writing and reading from members
    of a union in a way the clobbered data it needed to read before
    it read it.
    
    Zeroing the v6 flowinfo overwrites the v4 sin_addr with 0, meaning
    that every place that calls sctp_v4_map_v6 gets ::ffff:0.0.0.0 as the
    result.
    
    Reorder things to guarantee correct behaviour no matter what the
    union layout is.
    
    This impacts user space clients that open an IPv6 SCTP socket and
    receive IPv4 connections. Prior to 299ee user space would see a
    sockaddr with AF_INET and a correct address, after 299ee the sockaddr
    is AF_INET6, but the address is wrong.
    
    Fixes: 299ee123e198 (sctp: Fixup v4mapped behaviour to comply with Sock API)
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit be44fb5e423c635dd3b498e874620cdc21d3b5ac
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    [ Upstream commit 213d7f94775322ba44e0bbb55ec6946e9de88cea ]
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ce7da8b88f6a5602743337f4f08f4009591c4cc7
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    [ Upstream commit 213d7f94775322ba44e0bbb55ec6946e9de88cea ]
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6ef5b2e5241a2b74b9a8f6386eb742d2e42ad826
Author: Cathy Zhou <Cathy.Zhou@Oracle.COM>
Date:   Wed Mar 14 10:56:07 2018 -0700

    sunvnet: does not support GSO for sctp
    
    [ Upstream commit cf55612a945039476abfd73e39064b2e721c3272 ]
    
    The NETIF_F_GSO_SOFTWARE implies support for GSO on SCTP, but the
    sunvnet driver does not support GSO for sctp.  Here we remove the
    NETIF_F_GSO_SOFTWARE feature flag and only report NETIF_F_ALL_TSO
    instead.
    
    Signed-off-by: Cathy Zhou <Cathy.Zhou@Oracle.COM>
    Signed-off-by: Shannon Nelson <shannon.nelson@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f806ed5cfac6bbd23bd223b4b6e3d8dd1f71838a
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    [ Upstream commit 213d7f94775322ba44e0bbb55ec6946e9de88cea ]
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e1e08390525aba7df545ac29ef9379593d0caa94
Author: Cathy Zhou <Cathy.Zhou@Oracle.COM>
Date:   Wed Mar 14 10:56:07 2018 -0700

    sunvnet: does not support GSO for sctp
    
    [ Upstream commit cf55612a945039476abfd73e39064b2e721c3272 ]
    
    The NETIF_F_GSO_SOFTWARE implies support for GSO on SCTP, but the
    sunvnet driver does not support GSO for sctp.  Here we remove the
    NETIF_F_GSO_SOFTWARE feature flag and only report NETIF_F_ALL_TSO
    instead.
    
    Signed-off-by: Cathy Zhou <Cathy.Zhou@Oracle.COM>
    Signed-off-by: Shannon Nelson <shannon.nelson@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9f67e91e85f88d7a50206c460de6bf5c4f15e870
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    [ Upstream commit 213d7f94775322ba44e0bbb55ec6946e9de88cea ]
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7ccd1ddb0cbca8dfebeb040cda27ef726ff72862
Author: Cathy Zhou <Cathy.Zhou@Oracle.COM>
Date:   Wed Mar 14 10:56:07 2018 -0700

    sunvnet: does not support GSO for sctp
    
    [ Upstream commit cf55612a945039476abfd73e39064b2e721c3272 ]
    
    The NETIF_F_GSO_SOFTWARE implies support for GSO on SCTP, but the
    sunvnet driver does not support GSO for sctp.  Here we remove the
    NETIF_F_GSO_SOFTWARE feature flag and only report NETIF_F_ALL_TSO
    instead.
    
    Signed-off-by: Cathy Zhou <Cathy.Zhou@Oracle.COM>
    Signed-off-by: Shannon Nelson <shannon.nelson@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 90059d0cdbc49b8ac95bae53407a25b2588a45aa
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    [ Upstream commit 213d7f94775322ba44e0bbb55ec6946e9de88cea ]
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cb1603948a0b80f27d2525bb7ac0d4bbb3849926
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 24 17:49:35 2018 +0200

    vrf: add CRC32c offload to device features
    
    SCTP sockets originated in a VRF can improve their performance if CRC32c
    computation is delegated to underlying devices: update device features,
    setting NETIF_F_SCTP_CRC. Iterating the following command in the topology
    proposed with [1],
    
     # ip vrf exec vrf-h2 netperf -H 192.0.2.1 -t SCTP_STREAM -- -m 10K
    
    the measured throughput in Mbit/s improved from 2395  1% to 2720  1%.
    
    [1] https://www.spinics.net/lists/netdev/msg486007.html
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: David Ahern <dsa@cumulusnetworks.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 03250e1028057173b212341015d5fbf53327042c
Merge: 62d18ecfa641 eb110410b9f6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri May 25 19:54:42 2018 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Let's begin the holiday weekend with some networking fixes:
    
       1) Whoops need to restrict cfg80211 wiphy names even more to 64
          bytes. From Eric Biggers.
    
       2) Fix flags being ignored when using kernel_connect() with SCTP,
          from Xin Long.
    
       3) Use after free in DCCP, from Alexey Kodanev.
    
       4) Need to check rhltable_init() return value in ipmr code, from Eric
          Dumazet.
    
       5) XDP handling fixes in virtio_net from Jason Wang.
    
       6) Missing RTA_TABLE in rtm_ipv4_policy[], from Roopa Prabhu.
    
       7) Need to use IRQ disabling spinlocks in mlx4_qp_lookup(), from Jack
          Morgenstein.
    
       8) Prevent out-of-bounds speculation using indexes in BPF, from
          Daniel Borkmann.
    
       9) Fix regression added by AF_PACKET link layer cure, from Willem de
          Bruijn.
    
      10) Correct ENIC dma mask, from Govindarajulu Varadarajan.
    
      11) Missing config options for PMTU tests, from Stefano Brivio"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (48 commits)
      ibmvnic: Fix partial success login retries
      selftests/net: Add missing config options for PMTU tests
      mlx4_core: allocate ICM memory in page size chunks
      enic: set DMA mask to 47 bit
      ppp: remove the PPPIOCDETACH ioctl
      ipv4: remove warning in ip_recv_error
      net : sched: cls_api: deal with egdev path only if needed
      vhost: synchronize IOTLB message with dev cleanup
      packet: fix reserve calculation
      net/mlx5: IPSec, Fix a race between concurrent sandbox QP commands
      net/mlx5e: When RXFCS is set, add FCS data into checksum calculation
      bpf: properly enforce index mask to prevent out-of-bounds speculation
      net/mlx4: Fix irq-unsafe spinlock usage
      net: phy: broadcom: Fix bcm_write_exp()
      net: phy: broadcom: Fix auxiliary control register reads
      net: ipv4: add missing RTA_TABLE to rtm_ipv4_policy
      net/mlx4: fix spelling mistake: "Inrerface" -> "Interface" and rephrase message
      ibmvnic: Only do H_EOI for mobility events
      tuntap: correctly set SOCKWQ_ASYNC_NOSPACE
      virtio-net: fix leaking page for gso packet during mergeable XDP
      ...

commit f4e8e0e5234473b609a83e5ef7a596c4d0a436bf
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    [ Upstream commit 1071ec9d453a38023579714b64a951a2fb982071 ]
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>

commit 9f3baa53557ca01c735bfe59828ede76130fa1df
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>

commit f9714e8fb71a4cea129909b8a45d114c21ff39aa
Author: Andrey Vagin <avagin@openvz.org>
Date:   Wed Mar 15 17:41:14 2017 -0700

    net/8021q: create device with all possible features in wanted_features
    
    [ Upstream commit 88997e4208aea117627898e5f6f9801cf3cd42d2 ]
    
    wanted_features is a set of features which have to be enabled if a
    hardware allows that.
    
    Currently when a vlan device is created, its wanted_features is set to
    current features of its base device.
    
    The problem is that the base device can get new features and they are
    not propagated to vlan-s of this device.
    
    If we look at bonding devices, they doesn't have this problem and this
    patch suggests to fix this issue by the same way how it works for bonding
    devices.
    
    We meet this problem, when we try to create a vlan device over a bonding
    device. When a system are booting, real devices require time to be
    initialized, so bonding devices created without slaves, then vlan
    devices are created and only then ethernet devices are added to the
    bonding device. As a result we have vlan devices with disabled
    scatter-gather.
    
    * create a bonding device
      $ ip link add bond0 type bond
      $ ethtool -k bond0 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off [requested on]
            tx-scatter-gather-fraglist: off [requested on]
    
    * create a vlan device
      $ ip link add link bond0 name bond0.10 type vlan id 10
      $ ethtool -k bond0.10 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    * Add a slave device to bond0
      $ ip link set dev eth0 master bond0
    
    And now we can see that the bond0 device has got the scatter-gather
    feature, but the bond0.10 hasn't got it.
    [root@laptop linux-task-diag]# ethtool -k bond0 | grep scatter
    scatter-gather: on
            tx-scatter-gather: on
            tx-scatter-gather-fraglist: on
    [root@laptop linux-task-diag]# ethtool -k bond0.10 | grep scatter
    scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    With this patch the vlan device will get all new features from the
    bonding device.
    
    Here is a call trace how features which are set in this patch reach
    dev->wanted_features.
    
    register_netdevice
       vlan_dev_init
            ...
            dev->hw_features = NETIF_F_HW_CSUM | NETIF_F_SG |
                           NETIF_F_FRAGLIST | NETIF_F_GSO_SOFTWARE |
                           NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
                           NETIF_F_ALL_FCOE;
    
            dev->features |= dev->hw_features;
            ...
        dev->wanted_features = dev->features & dev->hw_features;
        __netdev_update_features(dev);
            vlan_dev_fix_features
               ...
    
    Cc: Alexey Kuznetsov <kuznet@virtuozzo.com>
    Cc: Patrick McHardy <kaber@trash.net>
    Cc: "David S. Miller" <davem@davemloft.net>
    Signed-off-by: Andrei Vagin <avagin@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>

commit 305bb55212822f13ddbfcb7518d999c6369942ba
Merge: 7f7ccc2ccc2e 4152dc91b593
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu May 17 10:02:19 2018 -0700

    Merge tag 'selinux-pr-20180516' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull SELinux fixes from Paul Moore:
     "A small pull request to fix a few regressions in the SELinux/SCTP code
      with applications that call bind() with AF_UNSPEC/INADDR_ANY.
    
      The individual commit descriptions have more information, but the
      commits themselves should be self explanatory"
    
    * tag 'selinux-pr-20180516' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      selinux: correctly handle sa_family cases in selinux_sctp_bind_connect()
      selinux: fix address family in bind() and connect() to match address/port
      selinux: add AF_UNSPEC and INADDR_ANY checks to selinux_socket_bind()

commit 4bf21b61f2bb3611ddb4fb75170c83905dd5c29e
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon May 14 14:34:41 2018 -0300

    sctp: move transport flush code out of sctp_outq_flush
    
    To the new sctp_outq_flush_transports.
    
    Comment on Nagle is outdated and removed. Nagle is performed earlier, while
    checking if the chunk fits the packet: if the outq length is not enough to
    fill the packet, it returns SCTP_XMIT_DELAY.
    
    So by when it gets to sctp_outq_flush_transports, it has to go through all
    enlisted transports.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 96e0418e812e9c30211b55ffcddc5f03bfd96919
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon May 14 14:34:39 2018 -0300

    sctp: move outq data rtx code out of sctp_outq_flush
    
    This patch renames current sctp_outq_flush_rtx to __sctp_outq_flush_rtx
    and create a new sctp_outq_flush_rtx, with the code that was on
    sctp_outq_flush. Again, the idea is to have functions with small and
    defined objectives.
    
    Yes, there is an open-coded path selection in the now sctp_outq_flush_rtx.
    That is kept as is for now because it may be very different when we
    implement retransmission path selection algorithms for CMT-SCTP.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4152dc91b5932e7fe49a5afed62a068b2f31d196
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri May 11 20:15:13 2018 +0300

    selinux: correctly handle sa_family cases in selinux_sctp_bind_connect()
    
    Allow to pass the socket address structure with AF_UNSPEC family for
    compatibility purposes. selinux_socket_bind() will further check it
    for INADDR_ANY and selinux_socket_connect_helper() should return
    EINVAL.
    
    For a bad address family return EINVAL instead of AFNOSUPPORT error,
    i.e. what is expected from SCTP protocol in such case.
    
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Suggested-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 88b7d370bb4b1280717ebdacd6748456f9ba484f
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri May 11 20:15:12 2018 +0300

    selinux: fix address family in bind() and connect() to match address/port
    
    Since sctp_bindx() and sctp_connectx() can have multiple addresses,
    sk_family can differ from sa_family. Therefore, selinux_socket_bind()
    and selinux_socket_connect_helper(), which process sockaddr structure
    (address and port), should use the address family from that structure
    too, and not from the socket one.
    
    The initialization of the data for the audit record is moved above,
    in selinux_socket_bind(), so that there is no duplicate changes and
    code.
    
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Suggested-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 0f8db8cc73df60b3de9a5eebd8f117b56eff5b03
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri May 11 20:15:11 2018 +0300

    selinux: add AF_UNSPEC and INADDR_ANY checks to selinux_socket_bind()
    
    Commit d452930fd3b9 ("selinux: Add SCTP support") breaks compatibility
    with the old programs that can pass sockaddr_in structure with AF_UNSPEC
    and INADDR_ANY to bind(). As a result, bind() returns EAFNOSUPPORT error.
    This was found with LTP/asapi_01 test.
    
    Similar to commit 29c486df6a20 ("net: ipv4: relax AF_INET check in
    bind()"), which relaxed AF_INET check for compatibility, add AF_UNSPEC
    case to AF_INET and make sure that the address is INADDR_ANY.
    
    Fixes: d452930fd3b9 ("selinux: Add SCTP support")
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit e523a2562a4457d9aae9b657125d193218631681
Merge: bb609316d406 a8d7aa17bbc9
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu May 3 18:57:03 2018 -1000

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Various sockmap fixes from John Fastabend (pinned map handling,
        blocking in recvmsg, double page put, error handling during redirect
        failures, etc.)
    
     2) Fix dead code handling in x86-64 JIT, from Gianluca Borello.
    
     3) Missing device put in RDS IB code, from Dag Moxnes.
    
     4) Don't process fast open during repair mode in TCP< from Yuchung
        Cheng.
    
     5) Move address/port comparison fixes in SCTP, from Xin Long.
    
     6) Handle add a bond slave's master into a bridge properly, from
        Hangbin Liu.
    
     7) IPv6 multipath code can operate on unitialized memory due to an
        assumption that the icmp header is in the linear SKB area. Fix from
        Eric Dumazet.
    
     8) Don't invoke do_tcp_sendpages() recursively via TLS, from Dave
        Watson.
    
    9) Fix memory leaks in x86-64 JIT, from Daniel Borkmann.
    
    10) RDS leaks kernel memory to userspace, from Eric Dumazet.
    
    11) DCCP can invoke a tasklet on a freed socket, take a refcount. Also
        from Eric Dumazet.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (78 commits)
      dccp: fix tasklet usage
      smc: fix sendpage() call
      net/smc: handle unregistered buffers
      net/smc: call consolidation
      qed: fix spelling mistake: "offloded" -> "offloaded"
      net/mlx5e: fix spelling mistake: "loobpack" -> "loopback"
      tcp: restore autocorking
      rds: do not leak kernel memory to user land
      qmi_wwan: do not steal interfaces from class drivers
      ipv4: fix fnhe usage by non-cached routes
      bpf: sockmap, fix error handling in redirect failures
      bpf: sockmap, zero sg_size on error when buffer is released
      bpf: sockmap, fix scatterlist update on error path in send with apply
      net_sched: fq: take care of throttled flows before reuse
      ipv6: Revert "ipv6: Allow non-gateway ECMP for IPv6"
      bpf, x64: fix memleak when not converging on calls
      bpf, x64: fix memleak when not converging after image
      net/smc: restrict non-blocking connect finish
      8139too: Use disable_irq_nosync() in rtl8139_poll_controller()
      sctp: fix the issue that the cookie-ack with auth can't get processed
      ...

commit f706d830154b6c8405c6b77595a60d135182c97e
Author: Gang He <ghe@suse.com>
Date:   Wed May 2 10:28:35 2018 -0500

    dlm: make sctp_connect_to_sock() return in specified time
    
    When the user setup a two-ring cluster, DLM kernel module
    will automatically selects to use SCTP protocol to communicate
    between each node. There will be about 5 minute hang in DLM
    kernel module, in case one ring is broken before switching to
    another ring, this will potentially affect the dependent upper
    applications, e.g. ocfs2, gfs2, clvm and clustered-MD, etc.
    Unfortunately, if the user setup a two-ring cluster, we can not
    specify DLM communication protocol with TCP explicitly, since
    DLM kernel module only supports SCTP protocol for multiple
    ring cluster.
    Base on my investigation, the time is spent in sock->ops->connect()
    function before returns ETIMEDOUT(-110) error, since O_NONBLOCK
    argument in connect() function does not work here, then we should
    make sock->ops->connect() function return in specified time via
    setting socket SO_SNDTIMEO atrribute.
    
    Signed-off-by: Gang He <ghe@suse.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit b09c603ca40fc6980188f9c7f419c0918a3f461e
Author: Gang He <ghe@suse.com>
Date:   Wed May 2 10:37:48 2018 +0800

    dlm: fix a clerical error when set SCTP_NODELAY
    
    There is a clerical error when turn off Nagle's algorithm in
    sctp_connect_to_sock() function, this results in turn off
    Nagle's algorithm failure.
    After this correction, DLM performance will be improved obviously
    when using SCTP procotol.
    
    Signed-off-by: Gang He <ghe@suse.com>
    Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 2cb5fb1454ef4990f44f3070226ee29201bd5c87
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Apr 27 16:46:11 2018 -0300

    MAINTAINERS: add myself as SCTP co-maintainer
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3278d7fa10c533d73de2a7fe33cda7acde7c1786
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    
    [ Upstream commit 1071ec9d453a38023579714b64a951a2fb982071 ]
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 29b623b60549d5897af0842bf439d897de0560d8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    
    [ Upstream commit 1071ec9d453a38023579714b64a951a2fb982071 ]
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2de74b91a85e4928600543841752b70af22d3d50
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    
    [ Upstream commit 1071ec9d453a38023579714b64a951a2fb982071 ]
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 14c81b811aae69641253ae86b83b8eba7677509c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    
    [ Upstream commit 1071ec9d453a38023579714b64a951a2fb982071 ]
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4422cc0d5b58fb1c1a7a1cbf630c2781459c76f8
Merge: 5a643c861d0f 38687b56c51b
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Apr 27 14:35:24 2018 -0400

    Merge branch 'sctp-refactor-MTU-handling'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    sctp: refactor MTU handling
    
    Currently MTU handling is spread over SCTP stack. There are multiple
    places doing same/similar calculations and updating them is error prone
    as one spot can easily be left out.
    
    This patchset converges it into a more concise and consistent code. In
    general, it moves MTU handling from functions with bigger objectives,
    such as sctp_assoc_add_peer(), to specific functions.
    
    It's also a preparation for the next patchset, which removes the
    duplication between sctp_make_op_error_space and
    sctp_make_op_error_fixed and relies on sctp_mtu_payload introduced here.
    
    More details on each patch.
    ====================
    
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 439ef0309cf4b743d76edc2abeca72b27ee1d996
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Apr 26 16:59:01 2018 -0300

    sctp: consider idata chunks when setting SCTP_MAXSEG
    
    When setting SCTP_MAXSEG sock option, it should consider which kind of
    data chunk is being used if the asoc is already available, so that the
    limit better reflect reality.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6ff0f871c20ec1769a481edca86f23c76b2b06d3
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Apr 26 16:58:57 2018 -0300

    sctp: introduce sctp_dst_mtu
    
    Which makes sure that the MTU respects the minimum value of
    SCTP_DEFAULT_MINSEGMENT and that it is correctly aligned.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c45698f89626177f8c51409142cbe9c5bbed4af7
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Apr 26 16:58:50 2018 -0300

    sctp: remove old and unused SCTP_MIN_PMTU
    
    This value is not used anywhere in the code. In essence it is a
    duplicate of SCTP_DEFAULT_MINSEGMENT, which is used by the stack.
    
    SCTP_MIN_PMTU value makes more sense, but we should not change to it now
    as it would risk breaking applications.
    
    So this patch removes SCTP_MIN_PMTU and adjust the comment above it.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a72db42cee37a43f8a40e1f47358ac86921ad8e4
Merge: b9abdcfd10f1 1255fcb2a655
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 20 09:34:39 2018 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Unbalanced refcounting in TIPC, from Jon Maloy.
    
     2) Only allow TCP_MD5SIG to be set on sockets in close or listen state.
        Once the connection is established it makes no sense to change this.
        From Eric Dumazet.
    
     3) Missing attribute validation in neigh_dump_table(), also from Eric
        Dumazet.
    
     4) Fix address comparisons in SCTP, from Xin Long.
    
     5) Neigh proxy table clearing can deadlock, from Wolfgang Bumiller.
    
     6) Fix tunnel refcounting in l2tp, from Guillaume Nault.
    
     7) Fix double list insert in team driver, from Paolo Abeni.
    
     8) af_vsock.ko module was accidently made unremovable, from Stefan
        Hajnoczi.
    
     9) Fix reference to freed llc_sap object in llc stack, from Cong Wang.
    
    10) Don't assume netdevice struct is DMA'able memory in virtio_net
        driver, from Michael S. Tsirkin.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (62 commits)
      net/smc: fix shutdown in state SMC_LISTEN
      bnxt_en: Fix memory fault in bnxt_ethtool_init()
      virtio_net: sparse annotation fix
      virtio_net: fix adding vids on big-endian
      virtio_net: split out ctrl buffer
      net: hns: Avoid action name truncation
      docs: ip-sysctl.txt: fix name of some ipv6 variables
      vmxnet3: fix incorrect dereference when rxvlan is disabled
      llc: hold llc_sap before release_sock()
      MAINTAINERS: Direct networking documentation changes to netdev
      atm: iphase: fix spelling mistake: "Tansmit" -> "Transmit"
      net: qmi_wwan: add Wistron Neweb D19Q1
      net: caif: fix spelling mistake "UKNOWN" -> "UNKNOWN"
      net: stmmac: Disable ACS Feature for GMAC >= 4
      net: mvpp2: Fix DMA address mask size
      net: change the comment of dev_mc_init
      net: qualcomm: rmnet: Fix warning seen with fill_info
      tun: fix vlan packet truncation
      tipc: fix infinite loop when dumping link monitor summary
      tipc: fix use-after-free in tipc_nametbl_stop
      ...

commit 1071ec9d453a38023579714b64a951a2fb982071
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Apr 12 14:24:31 2018 +0800

    sctp: do not check port in sctp_inet6_cmp_addr
    
    pf->cmp_addr() is called before binding a v6 address to the sock. It
    should not check ports, like in sctp_inet_cmp_addr.
    
    But sctp_inet6_cmp_addr checks the addr by invoking af(6)->cmp_addr,
    sctp_v6_cmp_addr where it also compares the ports.
    
    This would cause that setsockopt(SCTP_SOCKOPT_BINDX_ADD) could bind
    multiple duplicated IPv6 addresses after Commit 40b4f0fd74e4 ("sctp:
    lack the check for ports in sctp_v6_cmp_addr").
    
    This patch is to remove af->cmp_addr called in sctp_inet6_cmp_addr,
    but do the proper check for both v6 addrs and v4mapped addrs.
    
    v1->v2:
      - define __sctp_v6_cmp_addr to do the common address comparison
        used for both pf and af v6 cmp_addr.
    
    Fixes: 40b4f0fd74e4 ("sctp: lack the check for ports in sctp_v6_cmp_addr")
    Reported-by: Jianwen Ji <jiji@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c2b32840e2f62938662ae102a4fe5043b92cdcb6
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9eda2d2dca830f0f8923b1f377d0fb70f576af1d
Merge: 6ad11bdd57ad 6b6bc6205d98
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 6 15:39:26 2018 -0700

    Merge tag 'selinux-pr-20180403' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux
    
    Pull SELinux updates from Paul Moore:
     "A bigger than usual pull request for SELinux, 13 patches (lucky!)
      along with a scary looking diffstat.
    
      Although if you look a bit closer, excluding the usual minor
      tweaks/fixes, there are really only two significant changes in this
      pull request: the addition of proper SELinux access controls for SCTP
      and the encapsulation of a lot of internal SELinux state.
    
      The SCTP changes are the result of a multi-month effort (maybe even a
      year or longer?) between the SELinux folks and the SCTP folks to add
      proper SELinux controls. A special thanks go to Richard for seeing
      this through and keeping the effort moving forward.
    
      The state encapsulation work is a bit of janitorial work that came out
      of some early work on SELinux namespacing. The question of namespacing
      is still an open one, but I believe there is some real value in the
      encapsulation work so we've split that out and are now sending that up
      to you"
    
    * tag 'selinux-pr-20180403' of git://git.kernel.org/pub/scm/linux/kernel/git/pcmoore/selinux:
      selinux: wrap AVC state
      selinux: wrap selinuxfs state
      selinux: fix handling of uninitialized selinux state in get_bools/classes
      selinux: Update SELinux SCTP documentation
      selinux: Fix ltp test connect-syscall failure
      selinux: rename the {is,set}_enforcing() functions
      selinux: wrap global selinux state
      selinux: fix typo in selinux_netlbl_sctp_sk_clone declaration
      selinux: Add SCTP support
      sctp: Add LSM hooks
      sctp: Add ip option support
      security: Add support for SCTP security hooks
      netlabel: If PF_INET6, check sk_buff ip header version

commit 466c797f1f73f86fe1c28d81cab45d74e8f44cb6
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c5e6439e71ace4fb5a123b962c03a00e08c41d50
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 18c647456ac9d61371a69e447df74daf9730f987
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f1c344162052674b6bb1d67264c43186cc7f239e
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    
    [ Upstream commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e ]
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c4f4d2f917729e9b7b8bb452bf4971be93e7a15f
Merge: 9ce207880d8e 5dcd8400884c
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Mar 22 14:10:29 2018 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Always validate XFRM esn replay attribute, from Florian Westphal.
    
     2) Fix RCU read lock imbalance in xfrm_get_tos(), from Xin Long.
    
     3) Don't try to get firmware dump if not loaded in iwlwifi, from Shaul
        Triebitz.
    
     4) Fix BPF helpers to deal with SCTP GSO SKBs properly, from Daniel
        Axtens.
    
     5) Fix some interrupt handling issues in e1000e driver, from Benjamin
        Poitier.
    
     6) Use strlcpy() in several ethtool get_strings methods, from Florian
        Fainelli.
    
     7) Fix rhlist dup insertion, from Paul Blakey.
    
     8) Fix SKB leak in netem packet scheduler, from Alexey Kodanev.
    
     9) Fix driver unload crash when link is up in smsc911x, from Jeremy
        Linton.
    
    10) Purge out invalid socket types in l2tp_tunnel_create(), from Eric
        Dumazet.
    
    11) Need to purge the write queue when TCP connections are aborted,
        otherwise userspace using MSG_ZEROCOPY can't close the fd. From
        Soheil Hassas Yeganeh.
    
    12) Fix double free in error path of team driver, from Arkadi
        Sharshevsky.
    
    13) Filter fixes for hv_netvsc driver, from Stephen Hemminger.
    
    14) Fix non-linear packet access in ipv6 ndisc code, from Lorenzo
        Bianconi.
    
    15) Properly filter out unsupported feature flags in macvlan driver,
        from Shannon Nelson.
    
    16) Don't request loading the diag module for a protocol if the protocol
        itself is not even registered. From Xin Long.
    
    17) If datagram connect fails in ipv6, make sure the socket state is
        consistent afterwards. From Paolo Abeni.
    
    18) Use after free in qed driver, from Dan Carpenter.
    
    19) If received ipv4 PMTU is less than the min pmtu, lock the mtu in the
        entry. From Sabrina Dubroca.
    
    20) Fix sleep in atomic in tg3 driver, from Jonathan Toppins.
    
    21) Fix vlan in vlan untagging in some situations, from Toshiaki Makita.
    
    22) Fix double SKB free in genlmsg_mcast(). From Nicolas Dichtel.
    
    23) Fix NULL derefs in error paths of tcf_*_init(), from Davide Caratti.
    
    24) Unbalanced PM runtime calls in FEC driver, from Florian Fainelli.
    
    25) Memory leak in gemini driver, from Igor Pylypiv.
    
    26) IDR leaks in error paths of tcf_*_init() functions, from Davide
        Caratti.
    
    27) Need to use GFP_ATOMIC in seg6_build_state(), from David Lebrun.
    
    28) Missing dev_put() in error path of macsec_newlink(), from Dan
        Carpenter.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (201 commits)
      macsec: missing dev_put() on error in macsec_newlink()
      net: dsa: Fix functional dsa-loop dependency on FIXED_PHY
      hv_netvsc: common detach logic
      hv_netvsc: change GPAD teardown order on older versions
      hv_netvsc: use RCU to fix concurrent rx and queue changes
      hv_netvsc: disable NAPI before channel close
      net/ipv6: Handle onlink flag with multipath routes
      ppp: avoid loop in xmit recursion detection code
      ipv6: sr: fix NULL pointer dereference when setting encap source address
      ipv6: sr: fix scheduling in RCU when creating seg6 lwtunnel state
      net: aquantia: driver version bump
      net: aquantia: Implement pci shutdown callback
      net: aquantia: Allow live mac address changes
      net: aquantia: Add tx clean budget and valid budget handling logic
      net: aquantia: Change inefficient wait loop on fw data reads
      net: aquantia: Fix a regression with reset on old firmware
      net: aquantia: Fix hardware reset when SPI may rarely hangup
      s390/qeth: on channel error, reject further cmd requests
      s390/qeth: lock read device while queueing next buffer
      s390/qeth: when thread completes, wake up all waiters
      ...

commit d813b4903ff6d10f362dee6a33fa2ec052949f30
Author: Andrey Vagin <avagin@openvz.org>
Date:   Wed Mar 15 17:41:14 2017 -0700

    net/8021q: create device with all possible features in wanted_features
    
    
    [ Upstream commit 88997e4208aea117627898e5f6f9801cf3cd42d2 ]
    
    wanted_features is a set of features which have to be enabled if a
    hardware allows that.
    
    Currently when a vlan device is created, its wanted_features is set to
    current features of its base device.
    
    The problem is that the base device can get new features and they are
    not propagated to vlan-s of this device.
    
    If we look at bonding devices, they doesn't have this problem and this
    patch suggests to fix this issue by the same way how it works for bonding
    devices.
    
    We meet this problem, when we try to create a vlan device over a bonding
    device. When a system are booting, real devices require time to be
    initialized, so bonding devices created without slaves, then vlan
    devices are created and only then ethernet devices are added to the
    bonding device. As a result we have vlan devices with disabled
    scatter-gather.
    
    * create a bonding device
      $ ip link add bond0 type bond
      $ ethtool -k bond0 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off [requested on]
            tx-scatter-gather-fraglist: off [requested on]
    
    * create a vlan device
      $ ip link add link bond0 name bond0.10 type vlan id 10
      $ ethtool -k bond0.10 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    * Add a slave device to bond0
      $ ip link set dev eth0 master bond0
    
    And now we can see that the bond0 device has got the scatter-gather
    feature, but the bond0.10 hasn't got it.
    [root@laptop linux-task-diag]# ethtool -k bond0 | grep scatter
    scatter-gather: on
            tx-scatter-gather: on
            tx-scatter-gather-fraglist: on
    [root@laptop linux-task-diag]# ethtool -k bond0.10 | grep scatter
    scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    With this patch the vlan device will get all new features from the
    bonding device.
    
    Here is a call trace how features which are set in this patch reach
    dev->wanted_features.
    
    register_netdevice
       vlan_dev_init
            ...
            dev->hw_features = NETIF_F_HW_CSUM | NETIF_F_SG |
                           NETIF_F_FRAGLIST | NETIF_F_GSO_SOFTWARE |
                           NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
                           NETIF_F_ALL_FCOE;
    
            dev->features |= dev->hw_features;
            ...
        dev->wanted_features = dev->features & dev->hw_features;
        __netdev_update_features(dev);
            vlan_dev_fix_features
               ...
    
    Cc: Alexey Kuznetsov <kuznet@virtuozzo.com>
    Cc: Patrick McHardy <kaber@trash.net>
    Cc: "David S. Miller" <davem@davemloft.net>
    Signed-off-by: Andrei Vagin <avagin@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4c484f758c180c6f8374fada0d9872fe8557e41d
Author: Andrey Vagin <avagin@openvz.org>
Date:   Wed Mar 15 17:41:14 2017 -0700

    net/8021q: create device with all possible features in wanted_features
    
    
    [ Upstream commit 88997e4208aea117627898e5f6f9801cf3cd42d2 ]
    
    wanted_features is a set of features which have to be enabled if a
    hardware allows that.
    
    Currently when a vlan device is created, its wanted_features is set to
    current features of its base device.
    
    The problem is that the base device can get new features and they are
    not propagated to vlan-s of this device.
    
    If we look at bonding devices, they doesn't have this problem and this
    patch suggests to fix this issue by the same way how it works for bonding
    devices.
    
    We meet this problem, when we try to create a vlan device over a bonding
    device. When a system are booting, real devices require time to be
    initialized, so bonding devices created without slaves, then vlan
    devices are created and only then ethernet devices are added to the
    bonding device. As a result we have vlan devices with disabled
    scatter-gather.
    
    * create a bonding device
      $ ip link add bond0 type bond
      $ ethtool -k bond0 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off [requested on]
            tx-scatter-gather-fraglist: off [requested on]
    
    * create a vlan device
      $ ip link add link bond0 name bond0.10 type vlan id 10
      $ ethtool -k bond0.10 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    * Add a slave device to bond0
      $ ip link set dev eth0 master bond0
    
    And now we can see that the bond0 device has got the scatter-gather
    feature, but the bond0.10 hasn't got it.
    [root@laptop linux-task-diag]# ethtool -k bond0 | grep scatter
    scatter-gather: on
            tx-scatter-gather: on
            tx-scatter-gather-fraglist: on
    [root@laptop linux-task-diag]# ethtool -k bond0.10 | grep scatter
    scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    With this patch the vlan device will get all new features from the
    bonding device.
    
    Here is a call trace how features which are set in this patch reach
    dev->wanted_features.
    
    register_netdevice
       vlan_dev_init
            ...
            dev->hw_features = NETIF_F_HW_CSUM | NETIF_F_SG |
                           NETIF_F_FRAGLIST | NETIF_F_GSO_SOFTWARE |
                           NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
                           NETIF_F_ALL_FCOE;
    
            dev->features |= dev->hw_features;
            ...
        dev->wanted_features = dev->features & dev->hw_features;
        __netdev_update_features(dev);
            vlan_dev_fix_features
               ...
    
    Cc: Alexey Kuznetsov <kuznet@virtuozzo.com>
    Cc: Patrick McHardy <kaber@trash.net>
    Cc: "David S. Miller" <davem@davemloft.net>
    Signed-off-by: Andrei Vagin <avagin@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b434e837642049c96cf56c730279f410d520b33b
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>

commit d3cc2cd7c8d7adfb43075036878e319d5893280d
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Mar 19 17:33:36 2018 +0000

    selinux: Update SELinux SCTP documentation
    
    Update SELinux-sctp.rst "SCTP Peer Labeling" section to reflect
    how the association permission is validated.
    
    Reported-by: Dominick Grift <dac.override@gmail.com>
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 7b822932c14328844f31a610e986ff2ebd19fb9e
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Tue Mar 13 10:56:00 2018 +0100

    fixup: sctp: verify size of a new chunk in _sctp_make_chunk()
    
    Ben writes:
    > > +   int chunklen;
    > > +
    > > +   chunklen = sizeof(*chunk_hdr) + paylen;
    >
    > I think this length still needs to be rounded up (with WORD_ROUND here,
    > instead of SCTP_PAD4 upstream).
    
    So here's a fix for this problem.
    
    
    Reported-by: Ben Hutchings <ben.hutchings@codethink.co.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d8930f132b54a3abf0d12d506e9e9204ce23abb8
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Tue Mar 13 10:56:00 2018 +0100

    fixup: sctp: verify size of a new chunk in _sctp_make_chunk()
    
    Ben writes:
    > > +   int chunklen;
    > > +
    > > +   chunklen = sizeof(*chunk_hdr) + paylen;
    >
    > I think this length still needs to be rounded up (with WORD_ROUND here,
    > instead of SCTP_PAD4 upstream).
    
    So here's a fix for this problem.
    
    
    Reported-by: Ben Hutchings <ben.hutchings@codethink.co.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cf55612a945039476abfd73e39064b2e721c3272
Author: Cathy Zhou <Cathy.Zhou@Oracle.COM>
Date:   Wed Mar 14 10:56:07 2018 -0700

    sunvnet: does not support GSO for sctp
    
    The NETIF_F_GSO_SOFTWARE implies support for GSO on SCTP, but the
    sunvnet driver does not support GSO for sctp.  Here we remove the
    NETIF_F_GSO_SOFTWARE feature flag and only report NETIF_F_ALL_TSO
    instead.
    
    Signed-off-by: Cathy Zhou <Cathy.Zhou@Oracle.COM>
    Signed-off-by: Shannon Nelson <shannon.nelson@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c292566a7779f88ed63d555b1015ab29ca0d5530
Merge: c469012729bd 30f6ebf65bc4
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 14 13:48:28 2018 -0400

    Merge branch 'sctp-add-support-for-some-sctp-auth-APIs-from-RFC6458'
    
    Xin Long says:
    
    ====================
    sctp: add support for some sctp auth APIs from RFC6458
    
    This patchset mainly adds support for SCTP AUTH Information for sendmsg,
    described in RFC6458:
    
        5.3.8.  SCTP AUTH Information Structure (SCTP_AUTHINFO)
    
    and also adds a sockopt described in RFC6458:
    
        8.3.4.  Deactivate a Shared Key (SCTP_AUTH_DEACTIVATE_KEY)
    
    and two types of events for AUTHENTICATION_EVENT described in RFC6458:
    
        6.1.8.  SCTP_AUTHENTICATION_EVENT:
                 - SCTP_AUTH_NO_AUTH
                 - SCTP_AUTH_FREE_KEY
    
    After this patchset, we have fully support for sctp_sendv in kernel.
    
    Note that this patchset won't touch that sctp options merge conflict.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 30f6ebf65bc46161c5aaff1db2e6e7c76aa4a06b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 14 19:05:34 2018 +0800

    sctp: add SCTP_AUTH_NO_AUTH type for AUTHENTICATION_EVENT
    
    This patch is to add SCTP_AUTH_NO_AUTH type for AUTHENTICATION_EVENT,
    as described in section 6.1.8 of RFC6458.
    
          SCTP_AUTH_NO_AUTH:  This report indicates that the peer does not
             support SCTP authentication as defined in [RFC4895].
    
    Note that the implementation is quite similar as that of
    SCTP_ADAPTATION_INDICATION.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ec2e506c680deaa8e1a087986db6d73ba63a04be
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 14 19:05:33 2018 +0800

    sctp: add SCTP_AUTH_FREE_KEY type for AUTHENTICATION_EVENT
    
    This patch is to add SCTP_AUTH_FREE_KEY type for AUTHENTICATION_EVENT,
    as described in section 6.1.8 of RFC6458.
    
          SCTP_AUTH_FREE_KEY:  This report indicates that the SCTP
             implementation will no longer use the key identifier specified
             in auth_keynumber.
    
    After deactivating a key, it would never be used again, which means
    it's refcnt can't be held/increased by new chunks. But there may be
    some chunks in out queue still using it. So only when refcnt is 1,
    which means no chunk in outqueue is using/holding this key either,
    this EVENT would be sent.
    
    When users receive this notification, they could do DEL_KEY sockopt to
    remove this shkey, and also tell the peer that this key won't be used
    in any chunk thoroughly from now on, then the peer can remove it as
    well safely.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 601590ec155aadf5daa17a6f63a06d1bba5b5ce9
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 14 19:05:32 2018 +0800

    sctp: add sockopt SCTP_AUTH_DEACTIVATE_KEY
    
    This patch is to add sockopt SCTP_AUTH_DEACTIVATE_KEY, as described in
    section 8.3.4 of RFC6458.
    
    This set option indicates that the application will no longer send user
    messages using the indicated key identifier.
    
    Note that RFC requires that only deactivated keys that are no longer used
    by an association can be deleted, but for the backward compatibility, it
    is not to check deactivated when deleting or replacing one sh_key.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ff547c06a7d75d72d37dae2c064fcf0672e56c0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Mar 14 19:05:31 2018 +0800

    sctp: add support for SCTP AUTH Information for sendmsg
    
    This patch is to add support for SCTP AUTH Information for sendmsg,
    as described in section 5.3.8 of RFC6458.
    
    With this option, you can provide shared key identifier used for
    sending the user message.
    
    It's also a necessary send info for sctp_sendv.
    
    Note that it reuses sinfo->sinfo_tsn to indicate if this option is
    set and sinfo->sinfo_ssn to save the shkey ID which can be 0.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d98985dd6c2dc69e2ad5f5482a5237fb9487ed99
Author: Wei Yongjun <weiyongjun1@huawei.com>
Date:   Tue Mar 13 03:03:30 2018 +0000

    sctp: fix error return code in sctp_sendmsg_new_asoc()
    
    Return error code -EINVAL in the address len check error handling
    case since 'err' can be overwrite to 0 by 'err = sctp_verify_addr()'
    in the for loop.
    
    Fixes: 2c0dbaa0c43d ("sctp: add support for SCTP_DSTADDRV4/6 Information for sendmsg")
    Signed-off-by: Wei Yongjun <weiyongjun1@huawei.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bf2ae2e4bf9360e07c0cdfa166bcdc0afd92f4ce
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Mar 10 18:57:50 2018 +0800

    sock_diag: request _diag module only when the family or proto has been registered
    
    Now when using 'ss' in iproute, kernel would try to load all _diag
    modules, which also causes corresponding family and proto modules
    to be loaded as well due to module dependencies.
    
    Like after running 'ss', sctp, dccp, af_packet (if it works as a module)
    would be loaded.
    
    For example:
    
      $ lsmod|grep sctp
      $ ss
      $ lsmod|grep sctp
      sctp_diag              16384  0
      sctp                  323584  5 sctp_diag
      inet_diag              24576  4 raw_diag,tcp_diag,sctp_diag,udp_diag
      libcrc32c              16384  3 nf_conntrack,nf_nat,sctp
    
    As these family and proto modules are loaded unintentionally, it
    could cause some problems, like:
    
    - Some debug tools use 'ss' to collect the socket info, which loads all
      those diag and family and protocol modules. It's noisy for identifying
      issues.
    
    - Users usually expect to drop sctp init packet silently when they
      have no sense of sctp protocol instead of sending abort back.
    
    - It wastes resources (especially with multiple netns), and SCTP module
      can't be unloaded once it's loaded.
    
    ...
    
    In short, it's really inappropriate to have these family and proto
    modules loaded unexpectedly when just doing debugging with inet_diag.
    
    This patch is to introduce sock_load_diag_module() where it loads
    the _diag module only when it's corresponding family or proto has
    been already registered.
    
    Note that we can't just load _diag module without the family or
    proto loaded, as some symbols used in _diag module are from the
    family or proto module.
    
    v1->v2:
      - move inet proto check to inet_diag to avoid a compiling err.
    v2->v3:
      - define sock_load_diag_module in sock.c and export one symbol
        only.
      - improve the changelog.
    
    Reported-by: Sabrina Dubroca <sd@queasysnail.net>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Phil Sutter <phil@nwl.cc>
    Acked-by: Sabrina Dubroca <sd@queasysnail.net>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9b7d723439a444ea578462f50054641a09c45023
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 54b183ea4fe96c7b80439971ee04cf634a6e0459
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5b77504ae15267e8bc68b2622a7554076fe03e3b
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1dd27cde30e85774c77349c804229431616d594a
Author: Daniel Axtens <dja@axtens.net>
Date:   Fri Mar 9 14:06:09 2018 +1100

    net: use skb_is_gso_sctp() instead of open-coding
    
    As well as the basic conversion, I noticed that a lot of the
    SCTP code checks gso_type without first checking skb_is_gso()
    so I have added that where appropriate.
    
    Also, document the helper.
    
    Cc: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Daniel Axtens <dja@axtens.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9f62c15f28b0d1d746734666d88a79f08ba1e43e
Author: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
Date:   Thu Mar 8 17:00:02 2018 +0100

    ipv6: fix access to non-linear packet in ndisc_fill_redirect_hdr_option()
    
    Fix the following slab-out-of-bounds kasan report in
    ndisc_fill_redirect_hdr_option when the incoming ipv6 packet is not
    linear and the accessed data are not in the linear data region of orig_skb.
    
    [ 1503.122508] ==================================================================
    [ 1503.122832] BUG: KASAN: slab-out-of-bounds in ndisc_send_redirect+0x94e/0x990
    [ 1503.123036] Read of size 1184 at addr ffff8800298ab6b0 by task netperf/1932
    
    [ 1503.123220] CPU: 0 PID: 1932 Comm: netperf Not tainted 4.16.0-rc2+ #124
    [ 1503.123347] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-2.fc27 04/01/2014
    [ 1503.123527] Call Trace:
    [ 1503.123579]  <IRQ>
    [ 1503.123638]  print_address_description+0x6e/0x280
    [ 1503.123849]  kasan_report+0x233/0x350
    [ 1503.123946]  memcpy+0x1f/0x50
    [ 1503.124037]  ndisc_send_redirect+0x94e/0x990
    [ 1503.125150]  ip6_forward+0x1242/0x13b0
    [...]
    [ 1503.153890] Allocated by task 1932:
    [ 1503.153982]  kasan_kmalloc+0x9f/0xd0
    [ 1503.154074]  __kmalloc_track_caller+0xb5/0x160
    [ 1503.154198]  __kmalloc_reserve.isra.41+0x24/0x70
    [ 1503.154324]  __alloc_skb+0x130/0x3e0
    [ 1503.154415]  sctp_packet_transmit+0x21a/0x1810
    [ 1503.154533]  sctp_outq_flush+0xc14/0x1db0
    [ 1503.154624]  sctp_do_sm+0x34e/0x2740
    [ 1503.154715]  sctp_primitive_SEND+0x57/0x70
    [ 1503.154807]  sctp_sendmsg+0xaa6/0x1b10
    [ 1503.154897]  sock_sendmsg+0x68/0x80
    [ 1503.154987]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.155078]  __sys_sendmsg+0xa4/0x130
    [ 1503.155168]  do_syscall_64+0x171/0x3f0
    [ 1503.155259]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.155436] Freed by task 1932:
    [ 1503.155527]  __kasan_slab_free+0x134/0x180
    [ 1503.155618]  kfree+0xbc/0x180
    [ 1503.155709]  skb_release_data+0x27f/0x2c0
    [ 1503.155800]  consume_skb+0x94/0xe0
    [ 1503.155889]  sctp_chunk_put+0x1aa/0x1f0
    [ 1503.155979]  sctp_inq_pop+0x2f8/0x6e0
    [ 1503.156070]  sctp_assoc_bh_rcv+0x6a/0x230
    [ 1503.156164]  sctp_inq_push+0x117/0x150
    [ 1503.156255]  sctp_backlog_rcv+0xdf/0x4a0
    [ 1503.156346]  __release_sock+0x142/0x250
    [ 1503.156436]  release_sock+0x80/0x180
    [ 1503.156526]  sctp_sendmsg+0xbb0/0x1b10
    [ 1503.156617]  sock_sendmsg+0x68/0x80
    [ 1503.156708]  ___sys_sendmsg+0x431/0x4b0
    [ 1503.156799]  __sys_sendmsg+0xa4/0x130
    [ 1503.156889]  do_syscall_64+0x171/0x3f0
    [ 1503.156980]  entry_SYSCALL_64_after_hwframe+0x42/0xb7
    
    [ 1503.157158] The buggy address belongs to the object at ffff8800298ab600
                    which belongs to the cache kmalloc-1024 of size 1024
    [ 1503.157444] The buggy address is located 176 bytes inside of
                    1024-byte region [ffff8800298ab600, ffff8800298aba00)
    [ 1503.157702] The buggy address belongs to the page:
    [ 1503.157820] page:ffffea0000a62a00 count:1 mapcount:0 mapping:0000000000000000 index:0x0 compound_mapcount: 0
    [ 1503.158053] flags: 0x4000000000008100(slab|head)
    [ 1503.158171] raw: 4000000000008100 0000000000000000 0000000000000000 00000001800e000e
    [ 1503.158350] raw: dead000000000100 dead000000000200 ffff880036002600 0000000000000000
    [ 1503.158523] page dumped because: kasan: bad access detected
    
    [ 1503.158698] Memory state around the buggy address:
    [ 1503.158816]  ffff8800298ab900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.158988]  ffff8800298ab980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    [ 1503.159165] >ffff8800298aba00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
    [ 1503.159338]                    ^
    [ 1503.159436]  ffff8800298aba80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159610]  ffff8800298abb00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    [ 1503.159785] ==================================================================
    [ 1503.159964] Disabling lock debugging due to kernel taint
    
    The test scenario to trigger the issue consists of 4 devices:
    - H0: data sender, connected to LAN0
    - H1: data receiver, connected to LAN1
    - GW0 and GW1: routers between LAN0 and LAN1. Both of them have an
      ethernet connection on LAN0 and LAN1
    On H{0,1} set GW0 as default gateway while on GW0 set GW1 as next hop for
    data from LAN0 to LAN1.
    Moreover create an ip6ip6 tunnel between H0 and H1 and send 3 concurrent
    data streams (TCP/UDP/SCTP) from H0 to H1 through ip6ip6 tunnel (send
    buffer size is set to 16K). While data streams are active flush the route
    cache on HA multiple times.
    I have not been able to identify a given commit that introduced the issue
    since, using the reproducer described above, the kasan report has been
    triggered from 4.14 and I have not gone back further.
    
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
    Reviewed-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Lorenzo Bianconi <lorenzo.bianconi@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4fadd1aa760e40ee98507326cb714036b92d1fc1
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1fc74a57a8ae863c95afedef2510e7e42b194e56
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    
    [ Upstream commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c ]
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cfda06d7362b4151ad9acc4765ad15e8dd969e4a
Merge: b06ef18a4c25 6007b080d2e2
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 7 20:27:51 2018 -0500

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf
    
    Daniel Borkmann says:
    
    ====================
    pull-request: bpf 2018-03-08
    
    The following pull-request contains BPF updates for your *net* tree.
    
    The main changes are:
    
    1) Fix various BPF helpers which adjust the skb and its GSO information
       with regards to SCTP GSO. The latter is a special case where gso_size
       is of value GSO_BY_FRAGS, so mangling that will end up corrupting
       the skb, thus bail out when seeing SCTP GSO packets, from Daniel(s).
    
    2) Fix a compilation error in bpftool where BPF_FS_MAGIC is not defined
       due to too old kernel headers in the system, from Jiri.
    
    3) Increase the number of x64 JIT passes in order to allow larger images
       to converge instead of punting them to interpreter or having them
       rejected when the interpreter is not built into the kernel, from Daniel.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1c02e377e216b02c965be99338332be1b4f704ff
Merge: 5c3d0fd4b2c0 4910280503f3
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 7 10:55:30 2018 -0500

    Merge branch 'sctp-add-support-for-some-msg_control-options-from-RFC6458'
    
    Xin Long says:
    
    ====================
    sctp: add support for some msg_control options from RFC6458
    
    This patchset is to add support for 3 msg_control options described
    in RFC6458:
    
        5.3.7.  SCTP PR-SCTP Information Structure (SCTP_PRINFO)
        5.3.9.  SCTP Destination IPv4 Address Structure (SCTP_DSTADDRV4)
        5.3.10. SCTP Destination IPv6 Address Structure (SCTP_DSTADDRV6)
    
    one send flag described in RFC6458:
    
        SCTP_SENDALL:  This flag, if set, will cause a one-to-many
        style socket to send the message to all associations that
        are currently established on this socket.  For the one-to-
        one style socket, this flag has no effect.
    
    Note there is another msg_control option:
    
        5.3.8.  SCTP AUTH Information Structure (SCTP_AUTHINFO)
    
    It's a little complicated, I will post it in another patchset after
    this.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4910280503f3af2857d5aa77e35b22d93a8960a8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 5 20:44:20 2018 +0800

    sctp: add support for snd flag SCTP_SENDALL process in sendmsg
    
    This patch is to add support for snd flag SCTP_SENDALL process
    in sendmsg, as described in section 5.3.4 of RFC6458.
    
    With this flag, you can send the same data to all the asocs of
    this sk once.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2c0dbaa0c43d04d8d6daf52adb724c5789676b15
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 5 20:44:19 2018 +0800

    sctp: add support for SCTP_DSTADDRV4/6 Information for sendmsg
    
    This patch is to add support for Destination IPv4/6 Address options
    for sendmsg, as described in section 5.3.9/10 of RFC6458.
    
    With this option, you can provide more than one destination addrs
    to sendmsg when creating asoc, like sctp_connectx.
    
    It's also a necessary send info for sctp_sendv.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ed63afb8a318f6b3558d76afba7809daee4f28e5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Mar 5 20:44:18 2018 +0800

    sctp: add support for PR-SCTP Information for sendmsg
    
    This patch is to add support for PR-SCTP Information for sendmsg,
    as described in section 5.3.7 of RFC6458.
    
    With this option, you can specify pr_policy and pr_value for user
    data in sendmsg.
    
    It's also a necessary send info for sctp_sendv.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 19f6484fca3ff3089850345332fb48ae3ea1fe76
Merge: 4e00f5d5f9fc a4a77718ee40
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Mar 4 17:49:18 2018 -0500

    Merge branch 'GSO_BY_FRAGS-correctness-improvements'
    
    Daniel Axtens says:
    
    ====================
    GSO_BY_FRAGS correctness improvements
    
    As requested [1], I went through and had a look at users of gso_size to
    see if there were things that need to be fixed to consider
    GSO_BY_FRAGS, and I have tried to improve our helper functions to deal
    with this case.
    
    I found a few. This fixes bugs relating to the use of
    skb_gso_*_seglen() where GSO_BY_FRAGS is not considered.
    
    Patch 1 renames skb_gso_validate_mtu to skb_gso_validate_network_len.
    This is follow-up to my earlier patch 2b16f048729b ("net: create
    skb_gso_validate_mac_len()"), and just makes everything a bit clearer.
    
    Patches 2 and 3 replace the final users of skb_gso_network_seglen() -
    which doesn't consider GSO_BY_FRAGS - with
    skb_gso_validate_network_len(), which does. This allows me to make the
    skb_gso_*_seglen functions private in patch 4 - now future users won't
    accidentally do the wrong comparison.
    
    Two things remain. One is qdisc_pkt_len_init, which is discussed at
    [2] - it's caught up in the GSO_DODGY mess. I don't have any expertise
    in GSO_DODGY, and it looks like a good clean fix will involve
    unpicking the whole validation mess, so I have left it for now.
    
    Secondly, there are 3 eBPF opcodes that change the gso_size of an SKB
    and don't consider GSO_BY_FRAGS. This is going through the bpf tree.
    
    Regards,
    Daniel
    
    [1] https://patchwork.ozlabs.org/comment/1852414/
    [2] https://www.spinics.net/lists/netdev/msg482397.html
    
    PS: This is all in the core networking stack. For a driver to be
    affected by this it would need to support NETIF_F_GSO_SCTP /
    NETIF_F_GSO_SOFTWARE and then either use gso_size or not be a purely
    virtual device. (Many drivers look at gso_size, but do not support
    SCTP segmentation, so the core network will segment an SCTP gso before
    it hits them.) Based on that, the only driver that may be affected is
    sunvnet, but I have no way of testing it, so I haven't looked at it.
    
    v2: split out bpf stuff
        fix review comments from Dave Miller
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ee78bbef8d63202ca0f2485aecf30b8c2b0088cc
Author: Daniel Axtens <dja@axtens.net>
Date:   Thu Mar 1 17:13:38 2018 +1100

    net: sched: tbf: handle GSO_BY_FRAGS case in enqueue
    
    tbf_enqueue() checks the size of a packet before enqueuing it.
    However, the GSO size check does not consider the GSO_BY_FRAGS
    case, and so will drop GSO SCTP packets, causing a massive drop
    in throughput.
    
    Use skb_gso_validate_mac_len() instead, as it does consider that
    case.
    
    Signed-off-by: Daniel Axtens <dja@axtens.net>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e871cae7927ba5d86508066a5f4bec0ea1d7eb95
Merge: e4e31cf07d0c 0a3920d28b54
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Mar 4 13:00:58 2018 -0500

    Merge branch 'sctp-clean-up-sctp_sendmsg'
    
    Xin Long says:
    
    ====================
    sctp: clean up sctp_sendmsg
    
    This cleanup mostly does three things:
    
     - extract some codes into functions to make sendmsg more readable.
    
     - tidy up some codes to avoid the unnecessary checks.
    
     - adjust some logic so that it will be easier to add the send flags
       and cmsgs features that I will post after this.
    
    To make it easy to review and to check if the code is compatible with
    before, this patchset is to do it step by step in 9 patches.
    
    NOTE:
    There will be a conflict when merging
    Commit 2277c7cd75e3 ("sctp: Add LSM hooks") from selinux tree,
    the solution is to:
    
    1. remove all the lines in [B]:
    
        <<<<<<< HEAD
        [A]
        =======
        [B]
        >>>>>>> 2277c7c... sctp: Add LSM hooks
    
    2. and apply the following diff-output:
    
    diff --git a/net/sctp/socket.c b/net/sctp/socket.c
    index 980621e..d6803c8 100644
    --- a/net/sctp/socket.c
    +++ b/net/sctp/socket.c
    @@ -1686,6 +1686,7 @@ static int sctp_sendmsg_new_asoc(struct sock *sk, __u16 sflags,
            struct net *net = sock_net(sk);
            struct sctp_association *asoc;
            enum sctp_scope scope;
    +       struct sctp_af *af;
            int err = -EINVAL;
    
            *tp = NULL;
    @@ -1711,6 +1712,22 @@ static int sctp_sendmsg_new_asoc(struct sock *sk, __u16 sflags,
    
            scope = sctp_scope(daddr);
    
    +       /* Label connection socket for first association 1-to-many
    +        * style for client sequence socket()->sendmsg(). This
    +        * needs to be done before sctp_assoc_add_peer() as that will
    +        * set up the initial packet that needs to account for any
    +        * security ip options (CIPSO/CALIPSO) added to the packet.
    +        */
    +       af = sctp_get_af_specific(daddr->sa.sa_family);
    +       if (!af)
    +               return -EINVAL;
    +
    +       err = security_sctp_bind_connect(sk, SCTP_SENDMSG_CONNECT,
    +                                        (struct sockaddr *)daddr,
    +                                        af->sockaddr_len);
    +       if (err < 0)
    +               return err;
    +
            asoc = sctp_association_new(ep, sk, scope, GFP_KERNEL);
            if (!asoc)
                    return -ENOMEM;
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0a3920d28b5490e6c90110156135dbc12c7fc413
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Mar 1 23:05:18 2018 +0800

    sctp: adjust some codes in a better order in sctp_sendmsg
    
    sctp_sendmsg_new_asoc and SCTP_ADDR_OVER check is only necessary
    when daddr is set, so move them up to if (daddr) statement.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8e87c6eb18f9d7427054f28a284d495c174d9970
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Mar 1 23:05:16 2018 +0800

    sctp: remove the unnecessary transport looking up from sctp_sendmsg
    
    Now sctp_assoc_lookup_paddr can only be called only if daddr has
    been set. But if daddr has been set, sctp_endpoint_lookup_assoc
    would be done, where it could already have the transport.
    
    So this unnecessary transport looking up should be removed, but
    only reset transport as NULL when SCTP_ADDR_OVER is not set for
    UDP type socket.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d02f51cbcf12b09ab945873e35046045875eed9a
Author: Daniel Axtens <dja@axtens.net>
Date:   Sat Mar 3 03:03:46 2018 +0100

    bpf: fix bpf_skb_adjust_net/bpf_skb_proto_xlat to deal with gso sctp skbs
    
    SCTP GSO skbs have a gso_size of GSO_BY_FRAGS, so any sort of
    unconditionally mangling of that will result in nonsense value
    and would corrupt the skb later on.
    
    Therefore, i) add two helpers skb_increase_gso_size() and
    skb_decrease_gso_size() that would throw a one time warning and
    bail out for such skbs and ii) refuse and return early with an
    error in those BPF helpers that are affected. We do need to bail
    out as early as possible from there before any changes on the
    skb have been performed.
    
    Fixes: 6578171a7ff0 ("bpf: add bpf_skb_change_proto helper")
    Co-authored-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: Daniel Axtens <dja@axtens.net>
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Alexei Starovoitov <ast@kernel.org>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>

commit 128815d34149caf956c5a58f5052e51f23d73e2d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 26 20:16:07 2017 +0800

    sctp: force the params with right types for sctp csum apis
    
    commit af2697a0273f7665429c47d71ab26f2412af924e upstream.
    
    Now sctp_csum_xxx doesn't really match the param types of these common
    csum apis. As sctp_csum_xxx is defined in sctp/checksum.h, many sparse
    errors occur when make C=2 not only with M=net/sctp but also with other
    modules that include this header file.
    
    This patch is to force them fit in csum apis with the right types.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit aa8e712cee93d520e96a2ca8e3a20f807c937e3f
Author: Stephen Smalley <sds@tycho.nsa.gov>
Date:   Thu Mar 1 18:48:02 2018 -0500

    selinux: wrap global selinux state
    
    Define a selinux state structure (struct selinux_state) for
    global SELinux state and pass it explicitly to all security server
    functions.  The public portion of the structure contains state
    that is used throughout the SELinux code, such as the enforcing mode.
    The structure also contains a pointer to a selinux_ss structure whose
    definition is private to the security server and contains security
    server specific state such as the policy database and SID table.
    
    This change should have no effect on SELinux behavior or APIs
    (userspace or LSM).  It merely wraps SELinux state and passes it
    explicitly as needed.
    
    Signed-off-by: Stephen Smalley <sds@tycho.nsa.gov>
    [PM: minor fixups needed due to collisions with the SCTP patches]
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 2572f5b4245abf2b4e5a86cabf65a50efda09aac
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Fri Feb 23 22:12:09 2018 +0100

    selinux: fix typo in selinux_netlbl_sctp_sk_clone declaration
    
    A missing 'struct' keyword caused a build error when CONFIG_NETLABEL
    is disabled:
    
    In file included from security/selinux/hooks.c:99:
    security/selinux/include/netlabel.h:135:66: error: unknown type name 'sock'
     static inline void selinux_netlbl_sctp_sk_clone(struct sock *sk, sock *newsk)
                                                                      ^~~~
    security/selinux/hooks.c: In function 'selinux_sctp_sk_clone':
    security/selinux/hooks.c:5188:2: error: implicit declaration of function 'selinux_netlbl_sctp_sk_clone'; did you mean 'selinux_netlbl_inet_csk_clone'? [-Werror=implicit-function-declaration]
    
    Fixes: db97c9f9d312 ("selinux: Add SCTP support")
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit d452930fd3b9031e59abfeddb2fa383f1403d61a
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Tue Feb 13 20:57:18 2018 +0000

    selinux: Add SCTP support
    
    The SELinux SCTP implementation is explained in:
    Documentation/security/SELinux-sctp.rst
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 2277c7cd75e39783eeb7512a6c35f8b4abbe1039
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Tue Feb 13 20:56:24 2018 +0000

    sctp: Add LSM hooks
    
    Add security hooks allowing security modules to exercise access control
    over SCTP.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 2df0d6de5eff25b8fb4e858c9d77c98cae8a0bc0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 17 14:11:11 2017 +0800

    sctp: set frag_point in sctp_setsockopt_maxseg correctly
    
    commit ecca8f88da5c4260cc2bccfefd2a24976704c366 upstream.
    
    Now in sctp_setsockopt_maxseg user_frag or frag_point can be set with
    val >= 8 and val <= SCTP_MAX_CHUNK_LEN. But both checks are incorrect.
    
    val >= 8 means frag_point can even be less than SCTP_DEFAULT_MINSEGMENT.
    Then in sctp_datamsg_from_user(), when it's value is greater than cookie
    echo len and trying to bundle with cookie echo chunk, the first_len will
    overflow.
    
    The worse case is when it's value is equal as cookie echo len, first_len
    becomes 0, it will go into a dead loop for fragment later on. In Hangbin
    syzkaller testing env, oom was even triggered due to consecutive memory
    allocation in that loop.
    
    Besides, SCTP_MAX_CHUNK_LEN is the max size of the whole chunk, it should
    deduct the data header for frag_point or user_frag check.
    
    This patch does a proper check with SCTP_DEFAULT_MINSEGMENT subtracting
    the sctphdr and datahdr, SCTP_MAX_CHUNK_LEN subtracting datahdr when
    setting frag_point via sockopt. It also improves sctp_setsockopt_maxseg
    codes.
    
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2e6712234606ce4b155723f71a3c9f52128d9266
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 17 14:11:11 2017 +0800

    sctp: set frag_point in sctp_setsockopt_maxseg correctly
    
    commit ecca8f88da5c4260cc2bccfefd2a24976704c366 upstream.
    
    Now in sctp_setsockopt_maxseg user_frag or frag_point can be set with
    val >= 8 and val <= SCTP_MAX_CHUNK_LEN. But both checks are incorrect.
    
    val >= 8 means frag_point can even be less than SCTP_DEFAULT_MINSEGMENT.
    Then in sctp_datamsg_from_user(), when it's value is greater than cookie
    echo len and trying to bundle with cookie echo chunk, the first_len will
    overflow.
    
    The worse case is when it's value is equal as cookie echo len, first_len
    becomes 0, it will go into a dead loop for fragment later on. In Hangbin
    syzkaller testing env, oom was even triggered due to consecutive memory
    allocation in that loop.
    
    Besides, SCTP_MAX_CHUNK_LEN is the max size of the whole chunk, it should
    deduct the data header for frag_point or user_frag check.
    
    This patch does a proper check with SCTP_DEFAULT_MINSEGMENT subtracting
    the sctphdr and datahdr, SCTP_MAX_CHUNK_LEN subtracting datahdr when
    setting frag_point via sockopt. It also improves sctp_setsockopt_maxseg
    codes.
    
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 72e89f50084c6dbc58a00aeedf92c450dc1a8b1c
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Tue Feb 13 20:53:21 2018 +0000

    security: Add support for SCTP security hooks
    
    The SCTP security hooks are explained in:
    Documentation/security/LSM-sctp.rst
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 79c0ef3e85c015b0921a8fd5dd539d1480e9cd6c
Merge: 91ab883eb213 506b0a395f26
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Feb 19 11:58:19 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Prevent index integer overflow in ptr_ring, from Jason Wang.
    
     2) Program mvpp2 multicast filter properly, from Mikulas Patocka.
    
     3) The bridge brport attribute file is write only and doesn't have a
        ->show() method, don't blindly invoke it. From Xin Long.
    
     4) Inverted mask used in genphy_setup_forced(), from Ingo van Lil.
    
     5) Fix multiple definition issue with if_ether.h UAPI header, from
        Hauke Mehrtens.
    
     6) Fix GFP_KERNEL usage in atomic in RDS protocol code, from Sowmini
        Varadhan.
    
     7) Revert XDP redirect support from thunderx driver, it is not
        implemented properly. From Jesper Dangaard Brouer.
    
     8) Fix missing RTNL protection across some tipc operations, from Ying
        Xue.
    
     9) Return the correct IV bytes in the TLS getsockopt code, from Boris
        Pismenny.
    
    10) Take tclassid into consideration properly when doing FIB rule
        matching. From Stefano Brivio.
    
    11) cxgb4 device needs more PCI VPD quirks, from Casey Leedom.
    
    12) TUN driver doesn't align frags properly, and we can end up doing
        unaligned atomics on misaligned metadata. From Eric Dumazet.
    
    13) Fix various crashes found using DEBUG_PREEMPT in rmnet driver, from
        Subash Abhinov Kasiviswanathan.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (56 commits)
      tg3: APE heartbeat changes
      mlxsw: spectrum_router: Do not unconditionally clear route offload indication
      net: qualcomm: rmnet: Fix possible null dereference in command processing
      net: qualcomm: rmnet: Fix warning seen with 64 bit stats
      net: qualcomm: rmnet: Fix crash on real dev unregistration
      sctp: remove the left unnecessary check for chunk in sctp_renege_events
      rxrpc: Work around usercopy check
      tun: fix tun_napi_alloc_frags() frag allocator
      udplite: fix partial checksum initialization
      skbuff: Fix comment mis-spelling.
      dn_getsockoptdecnet: move nf_{get/set}sockopt outside sock lock
      PCI/cxgb4: Extend T3 PCI quirk to T4+ devices
      cxgb4: fix trailing zero in CIM LA dump
      cxgb4: free up resources of pf 0-3
      fib_semantics: Don't match route with mismatching tclassid
      NFC: llcp: Limit size of SDP URI
      tls: getsockopt return record sequence number
      tls: reset the crypto info if copy_from_user fails
      tls: retrun the correct IV in getsockopt
      docs: segmentation-offloads.txt: add SCTP info
      ...

commit a677088922831d94d292ca3891b148a8ba0b5fa1
Author: Daniel Axtens <dja@axtens.net>
Date:   Wed Feb 14 18:05:33 2018 +1100

    docs: segmentation-offloads.txt: add SCTP info
    
    Most of this is extracted from 90017accff61 ("sctp: Add GSO support"),
    with some extra text about GSO_BY_FRAGS and the need to check for it.
    
    Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Daniel Axtens <dja@axtens.net>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 213d7f94775322ba44e0bbb55ec6946e9de88cea
Author: Richard Haines <richard_c_haines@btinternet.com>
Date:   Mon Nov 13 20:54:22 2017 +0000

    netlabel: If PF_INET6, check sk_buff ip header version
    
    When resolving a fallback label, check the sk_buff version as it
    is possible (e.g. SCTP) to have family = PF_INET6 while
    receiving ip_hdr(skb)->version = 4.
    
    Signed-off-by: Richard Haines <richard_c_haines@btinternet.com>
    Acked-by: Paul Moore <paul@paul-moore.com>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit 0cf96c8faa883d0f91c468c23fd98b936b4f2631
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec upstream.
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16:
     - Adjust context
     - Add braces]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 15828f7bce82fc15a3a24146db47b034aec5a686
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Wed Jul 30 12:40:53 2014 -0600

    sctp: Fixup v4mapped behaviour to comply with Sock API
    
    commit 299ee123e19889d511092347f5fc14db0f10e3a6 upstream.
    
    The SCTP socket extensions API document describes the v4mapping option as
    follows:
    
    8.1.15.  Set/Clear IPv4 Mapped Addresses (SCTP_I_WANT_MAPPED_V4_ADDR)
    
       This socket option is a Boolean flag which turns on or off the
       mapping of IPv4 addresses.  If this option is turned on, then IPv4
       addresses will be mapped to V6 representation.  If this option is
       turned off, then no mapping will be done of V4 addresses and a user
       will receive both PF_INET6 and PF_INET type addresses on the socket.
       See [RFC3542] for more details on mapped V6 addresses.
    
    This description isn't really in line with what the code does though.
    
    Introduce addr_to_user (renamed addr_v4map), which should be called
    before any sockaddr is passed back to user space. The new function
    places the sockaddr into the correct format depending on the
    SCTP_I_WANT_MAPPED_V4_ADDR option.
    
    Audit all places that touched v4mapped and either sanely construct
    a v4 or v6 address then call addr_to_user, or drop the
    unnecessary v4mapped check entirely.
    
    Audit all places that call addr_to_user and verify they are on a sycall
    return path.
    
    Add a custom getname that formats the address properly.
    
    Several bugs are addressed:
     - SCTP_I_WANT_MAPPED_V4_ADDR=0 often returned garbage for
       addresses to user space
     - The addr_len returned from recvmsg was not correct when
       returning AF_INET on a v6 socket
     - flowlabel and scope_id were not zerod when promoting
       a v4 to v6
     - Some syscalls like bind and connect behaved differently
       depending on v4mapped
    
    Tested bind, getpeername, getsockname, connect, and recvmsg for proper
    behaviour in v4mapped = 1 and 0 cases.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 753cbba3bd5ce44baf645ab4289d99e22ef13d44
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec upstream.
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Adjust context
     - Add braces]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d15530ab5f425eb70533d337777f02d14f1db62b
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Wed Jul 30 12:40:53 2014 -0600

    sctp: Fixup v4mapped behaviour to comply with Sock API
    
    commit 299ee123e19889d511092347f5fc14db0f10e3a6 upstream.
    
    The SCTP socket extensions API document describes the v4mapping option as
    follows:
    
    8.1.15.  Set/Clear IPv4 Mapped Addresses (SCTP_I_WANT_MAPPED_V4_ADDR)
    
       This socket option is a Boolean flag which turns on or off the
       mapping of IPv4 addresses.  If this option is turned on, then IPv4
       addresses will be mapped to V6 representation.  If this option is
       turned off, then no mapping will be done of V4 addresses and a user
       will receive both PF_INET6 and PF_INET type addresses on the socket.
       See [RFC3542] for more details on mapped V6 addresses.
    
    This description isn't really in line with what the code does though.
    
    Introduce addr_to_user (renamed addr_v4map), which should be called
    before any sockaddr is passed back to user space. The new function
    places the sockaddr into the correct format depending on the
    SCTP_I_WANT_MAPPED_V4_ADDR option.
    
    Audit all places that touched v4mapped and either sanely construct
    a v4 or v6 address then call addr_to_user, or drop the
    unnecessary v4mapped check entirely.
    
    Audit all places that call addr_to_user and verify they are on a sycall
    return path.
    
    Add a custom getname that formats the address properly.
    
    Several bugs are addressed:
     - SCTP_I_WANT_MAPPED_V4_ADDR=0 often returned garbage for
       addresses to user space
     - The addr_len returned from recvmsg was not correct when
       returning AF_INET on a v6 socket
     - flowlabel and scope_id were not zerod when promoting
       a v4 to v6
     - Some syscalls like bind and connect behaved differently
       depending on v4mapped
    
    Tested bind, getpeername, getsockname, connect, and recvmsg for proper
    behaviour in v4mapped = 1 and 0 cases.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 947820b9595aa99f73de033ddcfe4c729c903c75
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Feb 12 18:29:51 2018 +0800

    sctp: add SCTP_CID_I_DATA and SCTP_CID_I_FWD_TSN conversion in sctp_cname
    
    After the support for SCTP_CID_I_DATA and SCTP_CID_I_FWD_TSN chunks,
    the corresp conversion in sctp_cname should also be added. Otherwise,
    in some places, pr_debug will print them as "unknown chunk".
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c839682c719f0e3dc851951c9e2eeb8a41cd9609
Merge: 82f0a41e1980 2fa56a494484
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Feb 9 15:34:18 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Make allocations less aggressive in x_tables, from Minchal Hocko.
    
     2) Fix netfilter flowtable Kconfig deps, from Pablo Neira Ayuso.
    
     3) Fix connection loss problems in rtlwifi, from Larry Finger.
    
     4) Correct DRAM dump length for some chips in ath10k driver, from Yu
        Wang.
    
     5) Fix ABORT handling in rxrpc, from David Howells.
    
     6) Add SPDX tags to Sun networking drivers, from Shannon Nelson.
    
     7) Some ipv6 onlink handling fixes, from David Ahern.
    
     8) Netem packet scheduler interval calcualtion fix from Md. Islam.
    
     9) Don't put crypto buffers on-stack in rxrpc, from David Howells.
    
    10) Fix handling of error non-delivery status in netlink multicast
        delivery over multiple namespaces, from Nicolas Dichtel.
    
    11) Missing xdp flush in tuntap driver, from Jason Wang.
    
    12) Synchonize RDS protocol netns/module teardown with rds object
        management, from Sowini Varadhan.
    
    13) Add nospec annotations to mpls, from Dan Williams.
    
    14) Fix SKB truesize handling in TIPC, from Hoang Le.
    
    15) Interrupt masking fixes in stammc from Niklas Cassel.
    
    16) Don't allow ptr_ring objects to be sized outside of kmalloc's
        limits, from Jason Wang.
    
    17) Don't allow SCTP chunks to be built which will have a length
        exceeding the chunk header's 16-bit length field, from Alexey
        Kodanev.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (82 commits)
      ibmvnic: Remove skb->protocol checks in ibmvnic_xmit
      bpf: fix rlimit in reuseport net selftest
      sctp: verify size of a new chunk in _sctp_make_chunk()
      s390/qeth: fix SETIP command handling
      s390/qeth: fix underestimated count of buffer elements
      ptr_ring: try vmalloc() when kmalloc() fails
      ptr_ring: fail early if queue occupies more than KMALLOC_MAX_SIZE
      net: stmmac: remove redundant enable of PMT irq
      net: stmmac: rename GMAC_INT_DEFAULT_MASK for dwmac4
      net: stmmac: discard disabled flags in interrupt status register
      ibmvnic: Reset long term map ID counter
      tools/libbpf: handle issues with bpf ELF objects containing .eh_frames
      selftests/bpf: add selftest that use test_libbpf_open
      selftests/bpf: add test program for loading BPF ELF files
      tools/libbpf: improve the pr_debug statements to contain section numbers
      bpf: Sync kernel ABI header with tooling header for bpf_common.h
      net: phy: fix phy_start to consider PHY_IGNORE_INTERRUPT
      net: thunder: change q_len's type to handle max ring size
      tipc: fix skb truesize/datasize ratio control
      net/sched: cls_u32: fix cls_u32 on filter replace
      ...

commit 07f2c7ab6f8d0a7e7c5764c4e6cc9c52951b9d9c
Author: Alexey Kodanev <alexey.kodanev@oracle.com>
Date:   Fri Feb 9 17:35:23 2018 +0300

    sctp: verify size of a new chunk in _sctp_make_chunk()
    
    When SCTP makes INIT or INIT_ACK packet the total chunk length
    can exceed SCTP_MAX_CHUNK_LEN which leads to kernel panic when
    transmitting these packets, e.g. the crash on sending INIT_ACK:
    
    [  597.804948] skbuff: skb_over_panic: text:00000000ffae06e4 len:120168
                   put:120156 head:000000007aa47635 data:00000000d991c2de
                   tail:0x1d640 end:0xfec0 dev:<NULL>
    ...
    [  597.976970] ------------[ cut here ]------------
    [  598.033408] kernel BUG at net/core/skbuff.c:104!
    [  600.314841] Call Trace:
    [  600.345829]  <IRQ>
    [  600.371639]  ? sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.436934]  skb_put+0x16c/0x200
    [  600.477295]  sctp_packet_transmit+0x2095/0x26d0 [sctp]
    [  600.540630]  ? sctp_packet_config+0x890/0x890 [sctp]
    [  600.601781]  ? __sctp_packet_append_chunk+0x3b4/0xd00 [sctp]
    [  600.671356]  ? sctp_cmp_addr_exact+0x3f/0x90 [sctp]
    [  600.731482]  sctp_outq_flush+0x663/0x30d0 [sctp]
    [  600.788565]  ? sctp_make_init+0xbf0/0xbf0 [sctp]
    [  600.845555]  ? sctp_check_transmitted+0x18f0/0x18f0 [sctp]
    [  600.912945]  ? sctp_outq_tail+0x631/0x9d0 [sctp]
    [  600.969936]  sctp_cmd_interpreter.isra.22+0x3be1/0x5cb0 [sctp]
    [  601.041593]  ? sctp_sf_do_5_1B_init+0x85f/0xc30 [sctp]
    [  601.104837]  ? sctp_generate_t1_cookie_event+0x20/0x20 [sctp]
    [  601.175436]  ? sctp_eat_data+0x1710/0x1710 [sctp]
    [  601.233575]  sctp_do_sm+0x182/0x560 [sctp]
    [  601.284328]  ? sctp_has_association+0x70/0x70 [sctp]
    [  601.345586]  ? sctp_rcv+0xef4/0x32f0 [sctp]
    [  601.397478]  ? sctp6_rcv+0xa/0x20 [sctp]
    ...
    
    Here the chunk size for INIT_ACK packet becomes too big, mostly
    because of the state cookie (INIT packet has large size with
    many address parameters), plus additional server parameters.
    
    Later this chunk causes the panic in skb_put_data():
    
      skb_packet_transmit()
          sctp_packet_pack()
              skb_put_data(nskb, chunk->skb->data, chunk->skb->len);
    
    'nskb' (head skb) was previously allocated with packet->size
    from u16 'chunk->chunk_hdr->length'.
    
    As suggested by Marcelo we should check the chunk's length in
    _sctp_make_chunk() before trying to allocate skb for it and
    discard a chunk if its size bigger than SCTP_MAX_CHUNK_LEN.
    
    Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leinter@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0dc400f41f0d589a7d4defabdc537ec7e0640039
Merge: cbd7b8a76b79 176bfb406d73
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Feb 6 19:00:42 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix error path in netdevsim, from Jakub Kicinski.
    
     2) Default values listed in tcp_wmem and tcp_rmem documentation were
        inaccurate, from Tonghao Zhang.
    
     3) Fix route leaks in SCTP, both for ipv4 and ipv6. From Alexey Kodanev
        and Tommi Rantala.
    
     4) Fix "MASK < Y" meant to be "MASK << Y" in xgbe driver, from Wolfram
        Sang.
    
     5) Use after free in u32_destroy_key(), from Paolo Abeni.
    
     6) Fix two TX issues in be2net driver, from Suredh Reddy.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (25 commits)
      be2net: Handle transmit completion errors in Lancer
      be2net: Fix HW stall issue in Lancer
      RDS: IB: Fix null pointer issue
      nfp: fix kdoc warnings on nested structures
      sample/bpf: fix erspan metadata
      net: erspan: fix erspan config overwrite
      net: erspan: fix metadata extraction
      cls_u32: fix use after free in u32_destroy_key()
      net: amd-xgbe: fix comparison to bitshift when dealing with a mask
      net: phy: Handle not having GPIO enabled in the kernel
      ibmvnic: fix empty firmware version and errors cleanup
      sctp: fix dst refcnt leak in sctp_v4_get_dst
      sctp: fix dst refcnt leak in sctp_v6_get_dst()
      dwc-xlgmac: remove Jie Deng as co-maintainer
      doc: Change the min default value of tcp_wmem/tcp_rmem.
      samples/bpf: use bpf_set_link_xdp_fd
      libbpf: add missing SPDX-License-Identifier
      libbpf: add error reporting in XDP
      libbpf: add function to setup XDP
      tools: add netlink.h and if_link.h in tools uapi
      ...

commit 617aebe6a97efa539cc4b8a52adccd89596e6be0
Merge: 0771ad44a20b e47e311843de
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Feb 3 16:25:42 2018 -0800

    Merge tag 'usercopy-v4.16-rc1' of git://git.kernel.org/pub/scm/linux/kernel/git/kees/linux
    
    Pull hardened usercopy whitelisting from Kees Cook:
     "Currently, hardened usercopy performs dynamic bounds checking on slab
      cache objects. This is good, but still leaves a lot of kernel memory
      available to be copied to/from userspace in the face of bugs.
    
      To further restrict what memory is available for copying, this creates
      a way to whitelist specific areas of a given slab cache object for
      copying to/from userspace, allowing much finer granularity of access
      control.
    
      Slab caches that are never exposed to userspace can declare no
      whitelist for their objects, thereby keeping them unavailable to
      userspace via dynamic copy operations. (Note, an implicit form of
      whitelisting is the use of constant sizes in usercopy operations and
      get_user()/put_user(); these bypass all hardened usercopy checks since
      these sizes cannot change at runtime.)
    
      This new check is WARN-by-default, so any mistakes can be found over
      the next several releases without breaking anyone's system.
    
      The series has roughly the following sections:
       - remove %p and improve reporting with offset
       - prepare infrastructure and whitelist kmalloc
       - update VFS subsystem with whitelists
       - update SCSI subsystem with whitelists
       - update network subsystem with whitelists
       - update process memory with whitelists
       - update per-architecture thread_struct with whitelists
       - update KVM with whitelists and fix ioctl bug
       - mark all other allocations as not whitelisted
       - update lkdtm for more sensible test overage"
    
    * tag 'usercopy-v4.16-rc1' of git://git.kernel.org/pub/scm/linux/kernel/git/kees/linux: (38 commits)
      lkdtm: Update usercopy tests for whitelisting
      usercopy: Restrict non-usercopy caches to size 0
      kvm: x86: fix KVM_XEN_HVM_CONFIG ioctl
      kvm: whitelist struct kvm_vcpu_arch
      arm: Implement thread_struct whitelist for hardened usercopy
      arm64: Implement thread_struct whitelist for hardened usercopy
      x86: Implement thread_struct whitelist for hardened usercopy
      fork: Provide usercopy whitelisting for task_struct
      fork: Define usercopy region in thread_stack slab caches
      fork: Define usercopy region in mm_struct slab caches
      net: Restrict unwhitelisted proto caches to size 0
      sctp: Copy struct sctp_sock.autoclose to userspace using put_user()
      sctp: Define usercopy region in SCTP proto slab cache
      caif: Define usercopy region in caif proto slab cache
      ip: Define usercopy region in IP proto slab cache
      net: Define usercopy region in struct proto slab cache
      scsi: Define usercopy region in scsi_sense_cache slab cache
      cifs: Define usercopy region in cifs_request slab cache
      vxfs: Define usercopy region in vxfs_inode slab cache
      ufs: Define usercopy region in ufs_inode_cache slab cache
      ...

commit b2fe5fa68642860e7de76167c3111623aa0d5de1
Merge: a103950e0dd2 a54667f6728c
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jan 31 14:31:10 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
    
     1) Significantly shrink the core networking routing structures. Result
        of http://vger.kernel.org/~davem/seoul2017_netdev_keynote.pdf
    
     2) Add netdevsim driver for testing various offloads, from Jakub
        Kicinski.
    
     3) Support cross-chip FDB operations in DSA, from Vivien Didelot.
    
     4) Add a 2nd listener hash table for TCP, similar to what was done for
        UDP. From Martin KaFai Lau.
    
     5) Add eBPF based queue selection to tun, from Jason Wang.
    
     6) Lockless qdisc support, from John Fastabend.
    
     7) SCTP stream interleave support, from Xin Long.
    
     8) Smoother TCP receive autotuning, from Eric Dumazet.
    
     9) Lots of erspan tunneling enhancements, from William Tu.
    
    10) Add true function call support to BPF, from Alexei Starovoitov.
    
    11) Add explicit support for GRO HW offloading, from Michael Chan.
    
    12) Support extack generation in more netlink subsystems. From Alexander
        Aring, Quentin Monnet, and Jakub Kicinski.
    
    13) Add 1000BaseX, flow control, and EEE support to mvneta driver. From
        Russell King.
    
    14) Add flow table abstraction to netfilter, from Pablo Neira Ayuso.
    
    15) Many improvements and simplifications to the NFP driver bpf JIT,
        from Jakub Kicinski.
    
    16) Support for ipv6 non-equal cost multipath routing, from Ido
        Schimmel.
    
    17) Add resource abstration to devlink, from Arkadi Sharshevsky.
    
    18) Packet scheduler classifier shared filter block support, from Jiri
        Pirko.
    
    19) Avoid locking in act_csum, from Davide Caratti.
    
    20) devinet_ioctl() simplifications from Al viro.
    
    21) More TCP bpf improvements from Lawrence Brakmo.
    
    22) Add support for onlink ipv6 route flag, similar to ipv4, from David
        Ahern.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1925 commits)
      tls: Add support for encryption using async offload accelerator
      ip6mr: fix stale iterator
      net/sched: kconfig: Remove blank help texts
      openvswitch: meter: Use 64-bit arithmetic instead of 32-bit
      tcp_nv: fix potential integer overflow in tcpnv_acked
      r8169: fix RTL8168EP take too long to complete driver initialization.
      qmi_wwan: Add support for Quectel EP06
      rtnetlink: enable IFLA_IF_NETNSID for RTM_NEWLINK
      ipmr: Fix ptrdiff_t print formatting
      ibmvnic: Wait for device response when changing MAC
      qlcnic: fix deadlock bug
      tcp: release sk_frag.page in tcp_disconnect
      ipv4: Get the address of interface correctly.
      net_sched: gen_estimator: fix lockdep splat
      net: macb: Handle HRESP error
      net/mlx5e: IPoIB, Fix copy-paste bug in flow steering refactoring
      ipv6: addrconf: break critical section in addrconf_verify_rtnl()
      ipv6: change route cache aging logic
      i40e/i40evf: Update DESC_NEEDED value to reflect larger value
      bnxt_en: cleanup DIM work on device shutdown
      ...

commit dd7e1cbd26183e4b8c816fb8b9ecc6356b0cb19d
Author: Willem de Bruijn <willemb@google.com>
Date:   Fri Jan 19 09:29:18 2018 -0500

    gso: validate gso_type in GSO handlers
    
    
    [ Upstream commit 121d57af308d0cf943f08f4738d24d3966c38cd9 ]
    
    Validate gso_type during segmentation as SKB_GSO_DODGY sources
    may pass packets where the gso_type does not match the contents.
    
    Syzkaller was able to enter the SCTP gso handler with a packet of
    gso_type SKB_GSO_TCPV4.
    
    On entry of transport layer gso handlers, verify that the gso_type
    matches the transport protocol.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Link: http://lkml.kernel.org/r/<001a1137452496ffc305617e5fe0@google.com>
    Reported-by: syzbot+fee64147a25aecd48055@syzkaller.appspotmail.com
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Acked-by: Jason Wang <jasowang@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3110e2134c9718a1f3c091873769d1d9b621bb87
Author: Willem de Bruijn <willemb@google.com>
Date:   Fri Jan 19 09:29:18 2018 -0500

    gso: validate gso_type in GSO handlers
    
    
    [ Upstream commit 121d57af308d0cf943f08f4738d24d3966c38cd9 ]
    
    Validate gso_type during segmentation as SKB_GSO_DODGY sources
    may pass packets where the gso_type does not match the contents.
    
    Syzkaller was able to enter the SCTP gso handler with a packet of
    gso_type SKB_GSO_TCPV4.
    
    On entry of transport layer gso handlers, verify that the gso_type
    matches the transport protocol.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Link: http://lkml.kernel.org/r/<001a1137452496ffc305617e5fe0@google.com>
    Reported-by: syzbot+fee64147a25aecd48055@syzkaller.appspotmail.com
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Acked-by: Jason Wang <jasowang@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 121d57af308d0cf943f08f4738d24d3966c38cd9
Author: Willem de Bruijn <willemb@google.com>
Date:   Fri Jan 19 09:29:18 2018 -0500

    gso: validate gso_type in GSO handlers
    
    Validate gso_type during segmentation as SKB_GSO_DODGY sources
    may pass packets where the gso_type does not match the contents.
    
    Syzkaller was able to enter the SCTP gso handler with a packet of
    gso_type SKB_GSO_TCPV4.
    
    On entry of transport layer gso handlers, verify that the gso_type
    matches the transport protocol.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Link: http://lkml.kernel.org/r/<001a1137452496ffc305617e5fe0@google.com>
    Reported-by: syzbot+fee64147a25aecd48055@syzkaller.appspotmail.com
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Acked-by: Jason Wang <jasowang@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f37ddb16f1c3b362b65bf60b6ae47a61aef90bdf
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jan 20 13:01:57 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    [ Upstream commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d ]
    
    The comparison on the timeout can lead to an array overrun
    read on sctp_timer_tbl because of an off-by-one error. Fix
    this by using < instead of <= and also compare to the array
    size rather than SCTP_EVENT_TIMEOUT_MAX.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>

commit d47da4eb8a60ce99149848ca03ca6c50e1a68bc4
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 5 11:17:18 2018 -0200

    sctp: fix the handling of ICMP Frag Needed for too small MTUs
    
    
    [ Upstream commit b6c5734db07079c9410147b32407f2366d584e6c ]
    
    syzbot reported a hang involving SCTP, on which it kept flooding dmesg
    with the message:
    [  246.742374] sctp: sctp_transport_update_pmtu: Reported pmtu 508 too
    low, using default minimum of 512
    
    That happened because whenever SCTP hits an ICMP Frag Needed, it tries
    to adjust to the new MTU and triggers an immediate retransmission. But
    it didn't consider the fact that MTUs smaller than the SCTP minimum MTU
    allowed (512) would not cause the PMTU to change, and issued the
    retransmission anyway (thus leading to another ICMP Frag Needed, and so
    on).
    
    As IPv4 (ip_rt_min_pmtu=556) and IPv6 (IPV6_MIN_MTU=1280) minimum MTU
    are higher than that, sctp_transport_update_pmtu() is changed to
    re-fetch the PMTU that got set after our request, and with that, detect
    if there was an actual change or not.
    
    The fix, thus, skips the immediate retransmission if the received ICMP
    resulted in no change, in the hope that SCTP will select another path.
    
    Note: The value being used for the minimum MTU (512,
    SCTP_DEFAULT_MINSEGMENT) is not right and instead it should be (576,
    SCTP_MIN_PMTU), but such change belongs to another patch.
    
    Changes from v1:
    - do not disable PMTU discovery, in the light of commit
    06ad391919b2 ("[SCTP] Don't disable PMTU discovery when mtu is small")
    and as suggested by Xin Long.
    - changed the way to break the rtx loop by detecting if the icmp
      resulted in a change or not
    Changes from v2:
    none
    
    See-also: https://lkml.org/lkml/2017/12/22/811
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ab9ee8e38b292f9a6698a4fedbb6ff8d08ce2012
Author: David Windsor <dave@nullcore.net>
Date:   Thu Aug 24 16:57:57 2017 -0700

    sctp: Define usercopy region in SCTP proto slab cache
    
    The SCTP socket event notification subscription information need to be
    copied to/from userspace. In support of usercopy hardening, this patch
    defines a region in the struct proto slab cache in which userspace copy
    operations are allowed. Additionally moves the usercopy fields to be
    adjacent for the region to cover both.
    
    example usage trace:
    
        net/sctp/socket.c:
            sctp_getsockopt_events(...):
                ...
                copy_to_user(..., &sctp_sk(sk)->subscribe, len)
    
            sctp_setsockopt_events(...):
                ...
                copy_from_user(&sctp_sk(sk)->subscribe, ..., optlen)
    
            sctp_getsockopt_initmsg(...):
                ...
                copy_to_user(..., &sctp_sk(sk)->initmsg, len)
    
    This region is known as the slab cache's usercopy region. Slab caches
    can now check that each dynamically sized copy operation involving
    cache-managed memory falls entirely within the slab's usercopy region.
    
    This patch is modified from Brad Spengler/PaX Team's PAX_USERCOPY
    whitelisting code in the last public patch of grsecurity/PaX based on my
    understanding of the code. Changes or omissions from the original code are
    mine and don't reflect the original grsecurity/PaX code.
    
    Signed-off-by: David Windsor <dave@nullcore.net>
    [kees: split from network patch, move struct members adjacent]
    [kees: add SCTPv6 struct whitelist, provide usage trace]
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: "David S. Miller" <davem@davemloft.net>
    Cc: linux-sctp@vger.kernel.org
    Cc: netdev@vger.kernel.org
    Signed-off-by: Kees Cook <keescook@chromium.org>

commit 64fce444f126b9d26574221330d9599fe998944e
Merge: 5f615b97cdea ccc12b11c533
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jan 10 17:53:18 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) BPF speculation prevention and BPF_JIT_ALWAYS_ON, from Alexei
        Starovoitov.
    
     2) Revert dev_get_random_name() changes as adjust the error code
        returns seen by userspace definitely breaks stuff.
    
     3) Fix TX DMA map/unmap on older iwlwifi devices, from Emmanuel
        Grumbach.
    
     4) From wrong AF family when requesting sock diag modules, from Andrii
        Vladyka.
    
     5) Don't add new ipv6 routes attached to the null_entry, from Wei Wang.
    
     6) Some SCTP sockopt length fixes from Marcelo Ricardo Leitner.
    
     7) Don't leak when removing VLAN ID 0, from Cong Wang.
    
     8) Hey there's a potential leak in ipv6_make_skb() too, from Eric
        Dumazet.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (27 commits)
      ipv6: sr: fix TLVs not being copied using setsockopt
      ipv6: fix possible mem leaks in ipv6_make_skb()
      mlxsw: spectrum_qdisc: Don't use variable array in mlxsw_sp_tclass_congestion_enable
      mlxsw: pci: Wait after reset before accessing HW
      nfp: always unmask aux interrupts at init
      8021q: fix a memory leak for VLAN 0 device
      of_mdio: avoid MDIO bus removal when a PHY is missing
      caif_usb: use strlcpy() instead of strncpy()
      doc: clarification about setting SO_ZEROCOPY
      net: gianfar_ptp: move set_fipers() to spinlock protecting area
      sctp: make use of pre-calculated len
      sctp: add a ceiling to optlen in some sockopts
      sctp: GFP_ATOMIC is not needed in sctp_setsockopt_events
      bpf: introduce BPF_JIT_ALWAYS_ON config
      bpf: avoid false sharing of map refcount with max_entries
      ipv6: remove null_entry before adding default route
      SolutionEngine771x: add Ether TSU resource
      SolutionEngine771x: fix Ether platform data
      docs-rst: networking: wire up msg_zerocopy
      net: ipv4: emulate READ_ONCE() on ->hdrincl bit-field in raw_sendmsg()
      ...

commit e5143f863c92f9f37b0977e482d6c78e74500f3b
Merge: 661e4e33a984 c76f97c99ae6
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jan 10 14:53:23 2018 -0500

    Merge branch 'sctp-Some-sockopt-optlen-fixes'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    sctp: Some sockopt optlen fixes
    
    Hangbin Liu reported that some SCTP sockopt are allowing the user to get
    the kernel to allocate really large buffers by not having a ceiling on
    optlen.
    
    This patchset address this issue (in patch 2), replace an GFP_ATOMIC
    that isn't needed and avoid calculating the option size multiple times
    in some setsockopt.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ef7f8cec80a0ba7bd00ece46844c8994117dc910
Merge: 44596f86826d 50f3d740d376
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Jan 8 20:21:39 2018 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Frag and UDP handling fixes in i40e driver, from Amritha Nambiar and
        Alexander Duyck.
    
     2) Undo unintentional UAPI change in netfilter conntrack, from Florian
        Westphal.
    
     3) Revert a change to how error codes are returned from
        dev_get_valid_name(), it broke some apps.
    
     4) Cannot cache routes for ipv6 tunnels in the tunnel is ipv4/ipv6
        dual-stack. From Eli Cooper.
    
     5) Fix missed PMTU updates in geneve, from Xin Long.
    
     6) Cure double free in macvlan, from Gao Feng.
    
     7) Fix heap out-of-bounds write in rds_message_alloc_sgs(), from
        Mohamed Ghannam.
    
     8) FEC bug fixes from FUgang Duan (mis-accounting of dev_id, missed
        deferral of probe when the regulator is not ready yet).
    
     9) Missing DMA mapping error checks in 3c59x, from Neil Horman.
    
    10) Turn off Broadcom tags for some b53 switches, from Florian Fainelli.
    
    11) Fix OOPS when get_target_net() is passed an SKB whose NETLINK_CB()
        isn't initialized. From Andrei Vagin.
    
    12) Fix crashes in fib6_add(), from Wei Wang.
    
    13) PMTU bug fixes in SCTP from Marcelo Ricardo Leitner.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (56 commits)
      sh_eth: fix TXALCR1 offsets
      mdio-sun4i: Fix a memory leak
      phylink: mark expected switch fall-throughs in phylink_mii_ioctl
      sctp: fix the handling of ICMP Frag Needed for too small MTUs
      sctp: do not retransmit upon FragNeeded if PMTU discovery is disabled
      xen-netfront: enable device after manual module load
      bnxt_en: Fix the 'Invalid VF' id check in bnxt_vf_ndo_prep routine.
      bnxt_en: Fix population of flow_type in bnxt_hwrm_cfa_flow_alloc()
      sh_eth: fix SH7757 GEther initialization
      net: fec: free/restore resource in related probe error pathes
      uapi/if_ether.h: prevent redefinition of struct ethhdr
      ipv6: fix general protection fault in fib6_add()
      RDS: null pointer dereference in rds_atomic_free_op
      sh_eth: fix TSU resource handling
      net: stmmac: enable EEE in MII, GMII or RGMII only
      rtnetlink: give a user socket to get_target_net()
      MAINTAINERS: Update my email address.
      can: ems_usb: improve error reporting for error warning and error passive
      can: flex_can: Correct the checking for frame length in flexcan_start_xmit()
      can: gs_usb: fix return value of the "set_bittiming" callback
      ...

commit 313c86da2d1530f3ff631235ce2a0fdea8f3f1ab
Merge: b707fda2df40 b6c5734db070
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jan 8 14:19:13 2018 -0500

    Merge branch 'SCTP-PMTU-discovery-fixes'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    SCTP PMTU discovery fixes
    
    This patchset fixes 2 issues with PMTU discovery that can lead to flood
    of retransmissions.
    The first patch fixes the issue for when PMTUD is disabled by the
    application, while the second fixes it for when its enabled.
    
    Please consider these to stable.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b6c5734db07079c9410147b32407f2366d584e6c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 5 11:17:18 2018 -0200

    sctp: fix the handling of ICMP Frag Needed for too small MTUs
    
    syzbot reported a hang involving SCTP, on which it kept flooding dmesg
    with the message:
    [  246.742374] sctp: sctp_transport_update_pmtu: Reported pmtu 508 too
    low, using default minimum of 512
    
    That happened because whenever SCTP hits an ICMP Frag Needed, it tries
    to adjust to the new MTU and triggers an immediate retransmission. But
    it didn't consider the fact that MTUs smaller than the SCTP minimum MTU
    allowed (512) would not cause the PMTU to change, and issued the
    retransmission anyway (thus leading to another ICMP Frag Needed, and so
    on).
    
    As IPv4 (ip_rt_min_pmtu=556) and IPv6 (IPV6_MIN_MTU=1280) minimum MTU
    are higher than that, sctp_transport_update_pmtu() is changed to
    re-fetch the PMTU that got set after our request, and with that, detect
    if there was an actual change or not.
    
    The fix, thus, skips the immediate retransmission if the received ICMP
    resulted in no change, in the hope that SCTP will select another path.
    
    Note: The value being used for the minimum MTU (512,
    SCTP_DEFAULT_MINSEGMENT) is not right and instead it should be (576,
    SCTP_MIN_PMTU), but such change belongs to another patch.
    
    Changes from v1:
    - do not disable PMTU discovery, in the light of commit
    06ad391919b2 ("[SCTP] Don't disable PMTU discovery when mtu is small")
    and as suggested by Xin Long.
    - changed the way to break the rtx loop by detecting if the icmp
      resulted in a change or not
    Changes from v2:
    none
    
    See-also: https://lkml.org/lkml/2017/12/22/811
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fa4475f79251a0539e64c08b8b039be23d107dc9
Author: Masami Hiramatsu <mhiramat@kernel.org>
Date:   Fri Dec 29 11:47:20 2017 +0900

    net: sctp: Remove debug SCTP probe module
    
    Remove SCTP probe module since jprobe has been deprecated.
    That function is now replaced by sctp/sctp_probe and
    sctp/sctp_probe_path trace-events.
    You can use it via ftrace or perftools.
    
    Signed-off-by: Masami Hiramatsu <mhiramat@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 103d750c88fe6b42dbe7abc4d204027f343ee125
Author: Masami Hiramatsu <mhiramat@kernel.org>
Date:   Fri Dec 29 11:46:51 2017 +0900

    net: sctp: Add SCTP ACK tracking trace event
    
    Add SCTP ACK tracking trace event to trace the changes of SCTP
    association state in response to incoming packets.
    It is used for debugging SCTP congestion control algorithms,
    and will replace sctp_probe module.
    
    Note that this event a bit tricky. Since this consists of 2
    events (sctp_probe and sctp_probe_path) so you have to enable
    both events as below.
    
      # cd /sys/kernel/debug/tracing
      # echo 1 > events/sctp/sctp_probe/enable
      # echo 1 > events/sctp/sctp_probe_path/enable
    
    Or, you can enable all the events under sctp.
    
      # echo 1 > events/sctp/enable
    
    Since sctp_probe_path event is always invoked from sctp_probe
    event, you can not see any output if you only enable
    sctp_probe_path.
    
    Signed-off-by: Masami Hiramatsu <mhiramat@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5d1b6695edb773d27f100eafc8cc9a34c58cb07f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:08 2017 -0300

    sctp: silence warns on sctp_stream_init allocations
    
    
    [ Upstream commit 1ae2eaaa229bc350b6f38fbf4ab9c873532aecfb ]
    
    As SCTP supports up to 65535 streams, that can lead to very large
    allocations in sctp_stream_init(). As Xin Long noticed, systems with
    small amounts of memory are more prone to not have enough memory and
    dump warnings on dmesg initiated by user actions. Thus, silence them.
    
    Also, if the reallocation of stream->out is not necessary, skip it and
    keep the memory we already have.
    
    Reported-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ead68f216110170ec729e2c4dec0aad6d38259d7
Merge: 9035a8961b50 c50b7c473f60
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Dec 21 15:57:30 2017 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller"
     "What's a holiday weekend without some networking bug fixes? [1]
    
       1) Fix some eBPF JIT bugs wrt. SKB pointers across helper function
          calls, from Daniel Borkmann.
    
       2) Fix regression from errata limiting change to marvell PHY driver,
          from Zhao Qiang.
    
       3) Fix u16 overflow in SCTP, from Xin Long.
    
       4) Fix potential memory leak during bridge newlink, from Nikolay
          Aleksandrov.
    
       5) Fix BPF selftest build on s390, from Hendrik Brueckner.
    
       6) Don't append to cfg80211 automatically generated certs file,
          always write new ones from scratch. From Thierry Reding.
    
       7) Fix sleep in atomic in mac80211 hwsim, from Jia-Ju Bai.
    
       8) Fix hang on tg3 MTU change with certain chips, from Brian King.
    
       9) Add stall detection to arc emac driver and reset chip when this
          happens, from Alexander Kochetkov.
    
      10) Fix MTU limitng in GRE tunnel drivers, from Xin Long.
    
      11) Fix stmmac timestamping bug due to mis-shifting of field. From
          Fredrik Hallenberg.
    
      12) Fix metrics match when deleting an ipv4 route. The kernel sets
          some internal metrics bits which the user isn't going to set when
          it makes the delete request. From Phil Sutter.
    
      13) mvneta driver loop over RX queues limits on "txq_number" :-) Fix
          from Yelena Krivosheev.
    
      14) Fix double free and memory corruption in get_net_ns_by_id, from
          Eric W. Biederman.
    
      15) Flush ipv4 FIB tables in the reverse order. Some tables can share
          their actual backing data, in particular this happens for the MAIN
          and LOCAL tables. We have to kill the LOCAL table first, because
          it uses MAIN's backing memory. Fix from Ido Schimmel.
    
      16) Several eBPF verifier value tracking fixes, from Edward Cree, Jann
          Horn, and Alexei Starovoitov.
    
      17) Make changes to ipv6 autoflowlabel sysctl really propagate to
          sockets, unless the socket has set the per-socket value
          explicitly. From Shaohua Li.
    
      18) Fix leaks and double callback invocations of zerocopy SKBs, from
          Willem de Bruijn"
    
    [1] Is this a trick question? "Relaxing"? "Quiet"? "Fine"? - Linus.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (77 commits)
      skbuff: skb_copy_ubufs must release uarg even without user frags
      skbuff: orphan frags before zerocopy clone
      net: reevalulate autoflowlabel setting after sysctl setting
      openvswitch: Fix pop_vlan action for double tagged frames
      ipv6: Honor specified parameters in fibmatch lookup
      bpf: do not allow root to mangle valid pointers
      selftests/bpf: add tests for recent bugfixes
      bpf: fix integer overflows
      bpf: don't prune branches when a scalar is replaced with a pointer
      bpf: force strict alignment checks for stack pointers
      bpf: fix missing error return in check_stack_boundary()
      bpf: fix 32-bit ALU op verification
      bpf: fix incorrect tracking of register size truncation
      bpf: fix incorrect sign extension in check_alu_op()
      bpf/verifier: fix bounds calculation on BPF_RSH
      ipv4: Fix use-after-free when flushing FIB tables
      s390/qeth: fix error handling in checksum cmd callback
      tipc: remove joining group member from congested list
      selftests: net: Adding config fragment CONFIG_NUMA=y
      nfp: bpf: keep track of the offloaded program
      ...

commit b2597f78d4831f2be288b220fcce5c4a9a63abec
Merge: 9ee1942cb3a8 cbabf46364b2
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Dec 20 14:00:26 2017 -0500

    Merge branch 'replace-tcp_set_state-tracepoint-with-inet_sock_set_state'
    
    Yafang Shao says:
    
    ====================
    replace tcp_set_state tracepoint with inet_sock_set_state
    
    According to the discussion in the mail thread
    https://patchwork.kernel.org/patch/10099243/,
    tcp_set_state tracepoint is renamed to inet_sock_set_state tracepoint and is
    moved to include/trace/events/sock.h.
    
    With this new tracepoint, we can trace AF_INET/AF_INET6 sock state transitions.
    As there's only one single tracepoint for inet, so I didn't create a new trace
    file named trace/events/inet_sock.h, and just place it in
    include/trace/events/sock.h
    
    Currently TCP/DCCP/SCTP state transitions are traced with this tracepoint.
    
    - Why not more protocol ?
    If we really think that anonter protocol should be traced, I will modify the
    code to trace it.
    I just want to make the code easy and not output useless information.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cbabf46364b27d08335fef37ecd7a8b89a1c8e07
Author: Yafang Shao <laoar.shao@gmail.com>
Date:   Wed Dec 20 11:12:54 2017 +0800

    net: tracepoint: using sock_set_state tracepoint to trace SCTP state transition
    
    With changes in inet_ files, SCTP state transitions are traced with
    inet_sock_set_state tracepoint.
    As SCTP state names, i.e. SCTP_SS_CLOSED, SCTP_SS_ESTABLISHED,
    have the same value with TCP state names. So the output info still print
    the TCP state names, that makes the code easy.
    
    Signed-off-by: Yafang Shao <laoar.shao@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 563e0bb0dc74b3ca888e24f8c08f0239fe4016b0
Author: Yafang Shao <laoar.shao@gmail.com>
Date:   Wed Dec 20 11:12:51 2017 +0800

    net: tracepoint: replace tcp_set_state tracepoint with inet_sock_set_state tracepoint
    
    As sk_state is a common field for struct sock, so the state
    transition tracepoint should not be a TCP specific feature.
    Currently it traces all AF_INET state transition, so I rename this
    tracepoint to inet_sock_set_state tracepoint with some minor changes and move it
    into trace/events/sock.h.
    We dont need to create a file named trace/events/inet_sock.h for this one single
    tracepoint.
    
    Two helpers are introduced to trace sk_state transition
        - void inet_sk_state_store(struct sock *sk, int newstate);
        - void inet_sk_set_state(struct sock *sk, int state);
    As trace header should not be included in other header files,
    so they are defined in sock.c.
    
    The protocol such as SCTP maybe compiled as a ko, hence export
    inet_sk_set_state().
    
    Signed-off-by: Yafang Shao <laoar.shao@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d196975905b2bb227dc54547c03b3d9d0013805c
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon Dec 18 14:13:17 2017 +0800

    sctp: add SCTP_CID_RECONF conversion in sctp_cname
    
    Whenever a new type of chunk is added, the corresp conversion in
    sctp_cname should be added. Otherwise, in some places, pr_debug
    will print it as "unknown chunk".
    
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo R. Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b3b87077394edda8bc5a9e95b589cc8fd3b3ea03
Merge: 024778095aa3 463118c34a35
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Dec 15 13:52:23 2017 -0500

    Merge branch 'sctp-stream-interleave'
    
    Xin Long says:
    
    ====================
    sctp: Implement Stream Interleave: Interaction with Other SCTP Extensions
    
    Stream Interleave would be implemented in two Parts:
    
       1. The I-DATA Chunk Supporting User Message Interleaving
       2. Interaction with Other SCTP Extensions
    
    Overview in section 2.3 of RFC8260 for Part 2:
    
       The usage of the I-DATA chunk might interfere with other SCTP
       extensions.  Future SCTP extensions MUST describe if and how they
       interfere with the usage of I-DATA chunks.  For the SCTP extensions
       already defined when this document was published, the details are
       given in the following subsections.
    
    As the 2nd part of Stream Interleave Implementation, this patchset mostly
    adds the support for SCTP Partial Reliability Extension with I-FORWARD-TSN
    chunk. Then adjusts stream scheduler and stream reconfig to make them work
    properly with I-DATA chunks.
    
    In the last patch, all stream interleave codes will be enabled by adding
    sysctl to allow users to use this feature.
    
    v1 -> v2:
      - removed the intl_enable check from sctp_chunk_event_lookup, as Marcelo's
        suggestion.
      - fixed a typo in changelog.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit de60fe9105431f504de9f8793b1da237a7d7f7ed
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Dec 15 00:41:29 2017 +0800

    sctp: implement handle_ftsn for sctp_stream_interleave
    
    handle_ftsn is added as a member of sctp_stream_interleave, used to skip
    ssn for data or mid for idata, called for SCTP_CMD_PROCESS_FWDTSN cmd.
    
    sctp_handle_iftsn works for ifwdtsn, and sctp_handle_fwdtsn works for
    fwdtsn. Note that different from sctp_handle_fwdtsn, sctp_handle_iftsn
    could do stream abort pd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo R. Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 47b20a88566f89dd0cc80c46f59ce0a12259d404
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Dec 15 00:41:28 2017 +0800

    sctp: implement report_ftsn for sctp_stream_interleave
    
    report_ftsn is added as a member of sctp_stream_interleave, used to
    skip tsn from tsnmap, remove old events from reasm or lobby queue,
    and abort pd for data or idata, called for SCTP_CMD_REPORT_FWDTSN
    cmd and asoc reset.
    
    sctp_report_iftsn works for ifwdtsn, and sctp_report_fwdtsn works
    for fwdtsn. Note that sctp_report_iftsn doesn't do asoc abort_pd,
    as stream abort_pd will be done when handling ifwdtsn. But when
    ftsn is equal with ftsn, which means asoc reset, asoc abort_pd has
    to be done.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo R. Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b9622ed42c3e01c2a7b73ce435032698b259a957
Merge: 92ff42645028 132282386f5d
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Dec 11 11:23:06 2017 -0500

    Merge branch 'sctp-stream-interleave-part-1'
    
    Xin Long says:
    
    ====================
    sctp: Implement Stream Interleave: The I-DATA Chunk Supporting User Message Interleaving
    
    Stream Interleave would be Implemented in two Parts:
    
       1. The I-DATA Chunk Supporting User Message Interleaving
       2. Interaction with Other SCTP Extensions
    
    Overview in section 1.1 of RFC8260 for Part 1:
    
       This document describes a new chunk carrying payload data called
       I-DATA.  This chunk incorporates the properties of the current SCTP
       DATA chunk, all the flags and fields except the Stream Sequence
       Number (SSN), and also adds two new fields in its chunk header -- the
       Fragment Sequence Number (FSN) and the Message Identifier (MID).  The
       FSN is only used for reassembling all fragments that have the same
       MID and the same ordering property.  The TSN is only used for the
       reliable transfer in combination with Selective Acknowledgment (SACK)
       chunks.
    
       In addition, the MID is also used for ensuring ordered delivery
       instead of using the stream sequence number (the I-DATA chunk omits
       an SSN).
    
    As the 1st part of Stream Interleave Implementation, this patchset adds
    an ops framework named sctp_stream_interleave with a bunch of stuff that
    does lots of things needed somewhere.
    
    Then it defines sctp_stream_interleave_0 to work for normal DATA chunks
    and sctp_stream_interleave_1 for I-DATA chunks.
    
    With these functions, hundreds of if-else checks for the different process
    on I-DATA chunks would be avoided. Besides, very few codes could be shared
    in these two function sets.
    
    In this patchset, it adds some basic variables, structures and socket
    options firstly, then implement these functions one by one to add the
    procedures for ordered idata gradually, at last adjusts some codes to
    make them work for unordered idata.
    
    To make it safe to be implemented and also not break the normal data
    chunk process, this feature can't be enabled to use until all stream
    interleave codes are completely accomplished.
    
    v1 -> v2:
      - fixed a checkpatch warning that a blank line was missed.
      - avoided a kbuild warning reported from gcc-4.9.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit be4e0ce10dc64b9a8aae42ec3dbd906022f91ec5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Dec 8 21:04:07 2017 +0800

    sctp: implement start_pd for sctp_stream_interleave
    
    start_pd is added as a member of sctp_stream_interleave, used to
    do partial_delivery for data or idata when datalen >= asoc->rwnd
    in sctp_eat_data. The codes have been done in last patches, but
    they need to be extracted into start_pd, so that it could be used
    for SCTP_CMD_PART_DELIVER cmd as well.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 668c9beb9020d5834ee9e43c208190a07d2b1928
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Dec 8 21:04:02 2017 +0800

    sctp: implement assign_number for sctp_stream_interleave
    
    assign_number is added as a member of sctp_stream_interleave, used
    to assign ssn for data or mid (message id) for idata, called in
    sctp_packet_append_data. sctp_chunk_assign_ssn is left as it is,
    and sctp_chunk_assign_mid is added for sctp_stream_interleave_1.
    
    This procedure is described in section 2.2.2 of RFC8260.
    
    All sizeof(struct sctp_data_chunk) in tx path is replaced with
    sctp_datachk_len, to make it right for idata as well. And also
    adjust sctp_chunk_is_data for SCTP_CID_I_DATA.
    
    After this patch, idata can be built and sent in tx path.
    
    Note that if sp strm_interleave is set, it has to wait_connect in
    sctp_sendmsg, as asoc intl_enable need to be known after 4 shake-
    hands, to decide if it should use data or idata later. data and
    idata can't be mixed to send in one asoc.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 772a58693fc3116d05b7969223a80a6376e639eb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Dec 8 21:03:58 2017 +0800

    sctp: add stream interleave enable members and sockopt
    
    This patch adds intl_enable in asoc and netns, and strm_interleave in
    sctp_sock to indicate if stream interleave is enabled and supported.
    
    netns intl_enable would be set via procfs, but that is not added yet
    until all stream interleave codes are completely implemented; asoc
    intl_enable will be set when doing 4-shakehands.
    
    sp strm_interleave can be set by sockopt SCTP_INTERLEAVING_SUPPORTED
    which is also added in this patch. This socket option is defined in
    section 4.3.1 of RFC8260.
    
    Note that strm_interleave can only be set by sockopt when both netns
    intl_enable and sp frag_interleave are set.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 05071c058d20c4b5e0b670c5c4fd6976e0547413
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jan 20 13:01:57 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    
    [ Upstream commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d ]
    
    The comparison on the timeout can lead to an array overrun
    read on sctp_timer_tbl because of an off-by-one error. Fix
    this by using < instead of <= and also compare to the array
    size rather than SCTP_EVENT_TIMEOUT_MAX.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e5afc84f644c1eb23a58f2d8609d061bdc0fe7b8
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jan 20 13:01:57 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    
    [ Upstream commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d ]
    
    The comparison on the timeout can lead to an array overrun
    read on sctp_timer_tbl because of an off-by-one error. Fix
    this by using < instead of <= and also compare to the array
    size rather than SCTP_EVENT_TIMEOUT_MAX.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c3f696de8d19e56b8685ab70eba5e139e61696f
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jan 20 13:01:57 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    
    [ Upstream commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d ]
    
    The comparison on the timeout can lead to an array overrun
    read on sctp_timer_tbl because of an off-by-one error. Fix
    this by using < instead of <= and also compare to the array
    size rather than SCTP_EVENT_TIMEOUT_MAX.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 946a4249b83f4fbbb1d2c025faa653c33a692705
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit e33c3b35af697c34d89086580386c768ca038623
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    [ Upstream commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 ]
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit 96c22a49ac125bc4ceddc0817dfb9ff3de8aea7d
Merge: ef0010a30935 f6454f80e8a9
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Nov 29 13:10:25 2017 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) The forcedeth conversion from pci_*() DMA interfaces to dma_*() ones
        missed one spot. From Zhu Yanjun.
    
     2) Missing CRYPTO_SHA256 Kconfig dep in cfg80211, from Johannes Berg.
    
     3) Fix checksum offloading in thunderx driver, from Sunil Goutham.
    
     4) Add SPDX to vm_sockets_diag.h, from Stephen Hemminger.
    
     5) Fix use after free of packet headers in TIPC, from Jon Maloy.
    
     6) "sizeof(ptr)" vs "sizeof(*ptr)" bug in i40e, from Gustavo A R Silva.
    
     7) Tunneling fixes in mlxsw driver, from Petr Machata.
    
     8) Fix crash in fanout_demux_rollover() of AF_PACKET, from Mike
        Maloney.
    
     9) Fix race in AF_PACKET bind() vs. NETDEV_UP notifier, from Eric
        Dumazet.
    
    10) Fix regression in sch_sfq.c due to one of the timer_setup()
        conversions. From Paolo Abeni.
    
    11) SCTP does list_for_each_entry() using wrong struct member, fix from
        Xin Long.
    
    12) Don't use big endian netlink attribute read for
        IFLA_BOND_AD_ACTOR_SYSTEM, it is in cpu endianness. Also from Xin
        Long.
    
    13) Fix mis-initialization of q->link.clock in CBQ scheduler, preventing
        adding filters there. From Jiri Pirko.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (67 commits)
      ethernet: dwmac-stm32: Fix copyright
      net: via: via-rhine: use %p to format void * address instead of %x
      net: ethernet: xilinx: Mark XILINX_LL_TEMAC broken on 64-bit
      myri10ge: Update MAINTAINERS
      net: sched: cbq: create block for q->link.block
      atm: suni: remove extraneous space to fix indentation
      atm: lanai: use %p to format kernel addresses instead of %x
      VSOCK: Don't set sk_state to TCP_CLOSE before testing it
      atm: fore200e: use %pK to format kernel addresses instead of %x
      ambassador: fix incorrect indentation of assignment statement
      vxlan: use __be32 type for the param vni in __vxlan_fdb_delete
      bonding: use nla_get_u64 to extract the value for IFLA_BOND_AD_ACTOR_SYSTEM
      sctp: use right member as the param of list_for_each_entry
      sch_sfq: fix null pointer dereference at timer expiration
      cls_bpf: don't decrement net's refcount when offload fails
      net/packet: fix a race in packet_bind() and packet_notifier()
      packet: fix crash in fanout_demux_rollover()
      sctp: remove extern from stream sched
      sctp: force the params with right types for sctp csum apis
      sctp: force SCTP_ERROR_INV_STRM with __u32 when calling sctp_chunk_fail
      ...

commit af2697a0273f7665429c47d71ab26f2412af924e
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 26 20:16:07 2017 +0800

    sctp: force the params with right types for sctp csum apis
    
    Now sctp_csum_xxx doesn't really match the param types of these common
    csum apis. As sctp_csum_xxx is defined in sctp/checksum.h, many sparse
    errors occur when make C=2 not only with M=net/sctp but also with other
    modules that include this header file.
    
    This patch is to force them fit in csum apis with the right types.
    
    Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 08f46070dde2a835a7a5bfd4c70372c27bff5d88
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 26 20:16:06 2017 +0800

    sctp: force SCTP_ERROR_INV_STRM with __u32 when calling sctp_chunk_fail
    
    This patch is to force SCTP_ERROR_INV_STRM with right type to
    fit in sctp_chunk_fail to avoid the sparse error.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d570a59c5b5f8fb3b65fa7b15ddb205a1d55f8d0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Nov 25 21:05:33 2017 +0800

    sctp: only allow the out stream reset when the stream outq is empty
    
    Now the out stream reset in sctp stream reconf could be done even if
    the stream outq is not empty. It means that users can not be sure
    since which msg the new ssn will be used.
    
    To make this more synchronous, it shouldn't allow to do out stream
    reset until these chunks in unsent outq all are sent out.
    
    This patch checks the corresponding stream outqs when sending and
    processing the request . If any of them has unsent chunks in outq,
    it will return -EAGAIN instead or send SCTP_STRRESET_IN_PROGRESS
    back to the sender.
    
    Fixes: 7f9d68ac944e ("sctp: implement sender-side procedures for SSN Reset Request Parameter")
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 16585babafe54375f23f73a8fc323bd51e7955d7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 upstream.
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Add #include <linux/nsproxy.h>
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7adde0289baa8d51c2bd072d80cb82a278d24363
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 upstream.
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8d028694813201787efd5086352fb051bfa35790
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0bc71e8424356163f31458dc12d2196013a8d37c
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 22f767973fb024036d8a9c2878035bdc6c5d1e6d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    
    [ Upstream commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 ]
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 67b718fcf89745836ecbf15cdd46ded2b071c3b6
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 362d2ce0f851653d2eed87fdb8891ab4cfb0c2bf
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    
    [ Upstream commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 ]
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 51b8aea7abdeb522e5450c246912b6f4a491e1c8
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2a0e60907e54dad75e9b3568d02bec11d6e74f6b
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    
    [ Upstream commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 ]
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 39c3fff9ef51ba9f2748f37ad7d9cfef365e87fe
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    
    [ Upstream commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 ]
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b4b4a3b633cbaaba16b1a21a2e3d3c0fead187da
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    
    [ Upstream commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec ]
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 46bdabbca02ebabd292d0ea3f610aa54e53f0e25
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    
    commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 upstream.
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben.hutchings@codethink.co.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 817002475046737877915d87889a012d851650fa
Merge: 27eabfaaf4a3 461ee7f3286d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Nov 17 20:18:37 2017 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Revert regression inducing change to the IPSEC template resolver,
        from Steffen Klassert.
    
     2) Peeloffs can cause the wrong sk to be waken up in SCTP, fix from Xin
        Long.
    
     3) Min packet MTU size is wrong in cpsw driver, from Grygorii Strashko.
    
     4) Fix build failure in netfilter ctnetlink, from Arnd Bergmann.
    
     5) ISDN hisax driver checks pnp_irq() for errors incorrectly, from
        Arvind Yadav.
    
     6) Fix fealnx driver build failure on MIPS, from Huacai Chen.
    
     7) Fix into leak in SCTP, the scope_id of socket addresses is not
        always filled in. From Eric W. Biederman.
    
     8) MTU inheritance between physical function and representor fix in nfp
        driver, from Dirk van der Merwe.
    
     9) Fix memory leak in rsi driver, from Colin Ian King.
    
    10) Fix expiration and generation ID handling of cached ipv4 redirect
        routes, from Xin Long.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (40 commits)
      net: usb: hso.c: remove unneeded DRIVER_LICENSE #define
      ibmvnic: fix dma_mapping_error call
      ipvlan: NULL pointer dereference panic in ipvlan_port_destroy
      route: also update fnhe_genid when updating a route cache
      route: update fnhe_expires for redirect when the fnhe exists
      sctp: set frag_point in sctp_setsockopt_maxseg correctly
      rsi: fix memory leak on buf and usb_reg_buf
      net/netlabel: Add list_next_rcu() in rcu_dereference().
      nfp: remove false positive offloads in flower vxlan
      nfp: register flower reprs for egress dev offload
      nfp: inherit the max_mtu from the PF netdev
      nfp: fix vlan receive MAC statistics typo
      nfp: fix flower offload metadata flag usage
      virto_net: remove empty file 'virtio_net.'
      net/sctp: Always set scope_id in sctp_inet6_skb_msgname
      fealnx: Fix building error on MIPS
      isdn: hisax: Fix pnp_irq's error checking for setup_teles3
      isdn: hisax: Fix pnp_irq's error checking for setup_sedlbauer_isapnp
      isdn: hisax: Fix pnp_irq's error checking for setup_niccy
      isdn: hisax: Fix pnp_irq's error checking for setup_ix1micro
      ...

commit ecca8f88da5c4260cc2bccfefd2a24976704c366
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Nov 17 14:11:11 2017 +0800

    sctp: set frag_point in sctp_setsockopt_maxseg correctly
    
    Now in sctp_setsockopt_maxseg user_frag or frag_point can be set with
    val >= 8 and val <= SCTP_MAX_CHUNK_LEN. But both checks are incorrect.
    
    val >= 8 means frag_point can even be less than SCTP_DEFAULT_MINSEGMENT.
    Then in sctp_datamsg_from_user(), when it's value is greater than cookie
    echo len and trying to bundle with cookie echo chunk, the first_len will
    overflow.
    
    The worse case is when it's value is equal as cookie echo len, first_len
    becomes 0, it will go into a dead loop for fragment later on. In Hangbin
    syzkaller testing env, oom was even triggered due to consecutive memory
    allocation in that loop.
    
    Besides, SCTP_MAX_CHUNK_LEN is the max size of the whole chunk, it should
    deduct the data header for frag_point or user_frag check.
    
    This patch does a proper check with SCTP_DEFAULT_MINSEGMENT subtracting
    the sctphdr and datahdr, SCTP_MAX_CHUNK_LEN subtracting datahdr when
    setting frag_point via sockopt. It also improves sctp_setsockopt_maxseg
    codes.
    
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reported-by: Hangbin Liu <liuhangbin@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c8a61d9ee1df0fb4747879fa67a99614eb62fec
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Wed Nov 15 22:17:48 2017 -0600

    net/sctp: Always set scope_id in sctp_inet6_skb_msgname
    
    Alexandar Potapenko while testing the kernel with KMSAN and syzkaller
    discovered that in some configurations sctp would leak 4 bytes of
    kernel stack.
    
    Working with his reproducer I discovered that those 4 bytes that
    are leaked is the scope id of an ipv6 address returned by recvmsg.
    
    With a little code inspection and a shrewd guess I discovered that
    sctp_inet6_skb_msgname only initializes the scope_id field for link
    local ipv6 addresses to the interface index the link local address
    pertains to instead of initializing the scope_id field for all ipv6
    addresses.
    
    That is almost reasonable as scope_id's are meaniningful only for link
    local addresses.  Set the scope_id in all other cases to 0 which is
    not a valid interface index to make it clear there is nothing useful
    in the scope_id field.
    
    There should be no danger of breaking userspace as the stack leak
    guaranteed that previously meaningless random data was being returned.
    
    Fixes: 372f525b495c ("SCTP:  Resync with LKSCTP tree.")
    History-tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
    Reported-by: Alexander Potapenko <glider@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 423852f89034492cc40920c00908f6de7d2dbe4f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Nov 15 17:00:11 2017 +0800

    sctp: check stream reset info len before making reconf chunk
    
    Now when resetting stream, if both in and out flags are set, the info
    len can reach:
      sizeof(struct sctp_strreset_outreq) + SCTP_MAX_STREAM(65535) +
      sizeof(struct sctp_strreset_inreq)  + SCTP_MAX_STREAM(65535)
    even without duplicated stream no, this value is far greater than the
    chunk's max size.
    
    _sctp_make_chunk doesn't do any check for this, which would cause the
    skb it allocs is huge, syzbot even reported a crash due to this.
    
    This patch is to check stream reset info len before making reconf
    chunk and return EINVAL if the len exceeds chunk's capacity.
    
    Thanks Marcelo and Neil for making this clear.
    
    v1->v2:
      - move the check into sctp_send_reset_streams instead.
    
    Fixes: cc16f00f6529 ("sctp: add support for generating stream reconf ssn reset request chunk")
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5bbcc0f595fadb4cac0eddc4401035ec0bd95b09
Merge: 892204e06cb9 50895b9de1d3
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Nov 15 11:56:19 2017 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Highlights:
    
       1) Maintain the TCP retransmit queue using an rbtree, with 1GB
          windows at 100Gb this really has become necessary. From Eric
          Dumazet.
    
       2) Multi-program support for cgroup+bpf, from Alexei Starovoitov.
    
       3) Perform broadcast flooding in hardware in mv88e6xxx, from Andrew
          Lunn.
    
       4) Add meter action support to openvswitch, from Andy Zhou.
    
       5) Add a data meta pointer for BPF accessible packets, from Daniel
          Borkmann.
    
       6) Namespace-ify almost all TCP sysctl knobs, from Eric Dumazet.
    
       7) Turn on Broadcom Tags in b53 driver, from Florian Fainelli.
    
       8) More work to move the RTNL mutex down, from Florian Westphal.
    
       9) Add 'bpftool' utility, to help with bpf program introspection.
          From Jakub Kicinski.
    
      10) Add new 'cpumap' type for XDP_REDIRECT action, from Jesper
          Dangaard Brouer.
    
      11) Support 'blocks' of transformations in the packet scheduler which
          can span multiple network devices, from Jiri Pirko.
    
      12) TC flower offload support in cxgb4, from Kumar Sanghvi.
    
      13) Priority based stream scheduler for SCTP, from Marcelo Ricardo
          Leitner.
    
      14) Thunderbolt networking driver, from Amir Levy and Mika Westerberg.
    
      15) Add RED qdisc offloadability, and use it in mlxsw driver. From
          Nogah Frankel.
    
      16) eBPF based device controller for cgroup v2, from Roman Gushchin.
    
      17) Add some fundamental tracepoints for TCP, from Song Liu.
    
      18) Remove garbage collection from ipv6 route layer, this is a
          significant accomplishment. From Wei Wang.
    
      19) Add multicast route offload support to mlxsw, from Yotam Gigi"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (2177 commits)
      tcp: highest_sack fix
      geneve: fix fill_info when link down
      bpf: fix lockdep splat
      net: cdc_ncm: GetNtbFormat endian fix
      openvswitch: meter: fix NULL pointer dereference in ovs_meter_cmd_reply_start
      netem: remove unnecessary 64 bit modulus
      netem: use 64 bit divide by rate
      tcp: Namespace-ify sysctl_tcp_default_congestion_control
      net: Protect iterations over net::fib_notifier_ops in fib_seq_sum()
      ipv6: set all.accept_dad to 0 by default
      uapi: fix linux/tls.h userspace compilation error
      usbnet: ipheth: prevent TX queue timeouts when device not ready
      vhost_net: conditionally enable tx polling
      uapi: fix linux/rxrpc.h userspace compilation errors
      net: stmmac: fix LPI transitioning for dwmac4
      atm: horizon: Fix irq release error
      net-sysfs: trigger netlink notification on ifalias change via sysfs
      openvswitch: Using kfree_rcu() to simplify the code
      openvswitch: Make local function ovs_nsh_key_attr_size() static
      openvswitch: Fix return value check in ovs_meter_cmd_features()
      ...

commit a3dcaf17ee54f1d01d22cc2b22cab0b4f60d78cf
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Nov 7 00:29:27 2017 -0800

    net: allow per netns sysctl_rmem and sysctl_wmem for protos
    
    As we want to gradually implement per netns sysctl_rmem and sysctl_wmem
    on per protocol basis, add two new fields in struct proto,
    and two new helpers : sk_get_wmem0() and sk_get_rmem0()
    
    First user will be TCP. Then UDP and SCTP can be easily converted,
    while DECNET probably wont get this support.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 705cb86401287e89c802f3a3854ad255f9407a9c
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    [ Upstream commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 ]
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit 08bd34b7527fe6b056928ad9cb02b4ab4c0d1011
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 upstream.
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 978aa0474115f3f5848949f2efce4def0766a5cb
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Oct 28 19:43:57 2017 +0800

    sctp: fix some type cast warnings introduced since very beginning
    
    These warnings were found by running 'make C=2 M=net/sctp/'.
    They are there since very beginning.
    
    Note after this patch, there still one warning left in
    sctp_outq_flush():
      sctp_chunk_fail(chunk, SCTP_ERROR_INV_STRM)
    
    Since it has been moved to sctp_stream_outq_migrate on net-next,
    to avoid the extra job when merging net-next to net, I will post
    the fix for it after the merging is done.
    
    Reported-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dee4506f067a026b38b3e01dd59c1257b810d186
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    
    [ Upstream commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 ]
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit db27397942aa3f3c7b02a28d52878468923834bd
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    
    [ Upstream commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 ]
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit df80cd9b28b9ebaa284a41df611dbf3a2d05ca74
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Oct 17 23:26:10 2017 +0800

    sctp: do not peel off an assoc from one netns to another one
    
    Now when peeling off an association to the sock in another netns, all
    transports in this assoc are not to be rehashed and keep use the old
    key in hashtable.
    
    As a transport uses sk->net as the hash key to insert into hashtable,
    it would miss removing these transports from hashtable due to the new
    netns when closing the sock and all transports are being freeed, then
    later an use-after-free issue could be caused when looking up an asoc
    and dereferencing those transports.
    
    This is a very old issue since very beginning, ChunYu found it with
    syzkaller fuzz testing with this series:
    
      socket$inet6_sctp()
      bind$inet6()
      sendto$inet6()
      unshare(0x40000000)
      getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()
      getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()
    
    This patch is to block this call when peeling one assoc off from one
    netns to another one, so that the netns of all transport would not
    go out-sync with the key in hashtable.
    
    Note that this patch didn't fix it by rehashing transports, as it's
    difficult to handle the situation when the tuple is already in use
    in the new netns. Besides, no one would like to peel off one assoc
    to another netns, considering ipaddrs, ifaces, etc. are usually
    different.
    
    Reported-by: ChunYu Wang <chunwang@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ec725e6dc8b29353bd1faed744156f16b3322fd2
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    
    [ Upstream commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 ]
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b70bb9bb7277aa396eafab6a313ee829c7957587
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    
    [ Upstream commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673 ]
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9039f3ef446e9ffa200200c934f049add9e58426
Author: Jia-Ju Bai <baijiaju1990@163.com>
Date:   Tue Oct 3 10:25:22 2017 +0800

    crypto: shash - Fix a sleep-in-atomic bug in shash_setkey_unaligned
    
    The SCTP program may sleep under a spinlock, and the function call path is:
    sctp_generate_t3_rtx_event (acquire the spinlock)
      sctp_do_sm
        sctp_side_effects
          sctp_cmd_interpreter
            sctp_make_init_ack
              sctp_pack_cookie
                crypto_shash_setkey
                  shash_setkey_unaligned
                    kmalloc(GFP_KERNEL)
    
    For the same reason, the orinoco driver may sleep in interrupt handler,
    and the function call path is:
    orinoco_rx_isr_tasklet
      orinoco_rx
        orinoco_mic
          crypto_shash_setkey
            shash_setkey_unaligned
              kmalloc(GFP_KERNEL)
    
    To fix it, GFP_KERNEL is replaced with GFP_ATOMIC.
    This bug is found by my static analysis tool and my code review.
    
    Signed-off-by: Jia-Ju Bai <baijiaju1990@163.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

commit 26873308b21654b6e0785b9f9e2c5414d37a4c4c
Merge: af14827fa38c ac1ed8b82cd6
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Oct 3 16:27:29 2017 -0700

    Merge branch 'sctp-stream-schedulers'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    Introduce SCTP Stream Schedulers
    
    This patchset introduces the SCTP Stream Schedulers are defined by
    https://tools.ietf.org/html/draft-ietf-tsvwg-sctp-ndata-13
    
    It provides 3 schedulers at the moment: FCFS, Priority and Round Robin.
    The other 3, Round Robin per packet, Fair Capacity and Weighted Fair
    Capacity will be added later. More specifically, WFQ is required by
    WebRTC Datachannels.
    
    The draft also defines the idata chunk, allowing a usermsg to be
    interrupted by another piece of idata from another stream. This patchset
    *doesn't* include it. It will be posted later by Xin Long.  Its
    integration with this patchset is very simple and it basically only
    requires a tweak in sctp_sched_dequeue_done(), to ignore datamsg
    boundaries.
    
    The first 5 patches are a preparation for the next ones. The most
    relevant patches are the 4th and 6th ones. More details are available on
    each patch.
    
    v2: changelog update on patch 3
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ac1ed8b82cd60ba8e7d84103ac1414b8c577c485
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:17 2017 -0300

    sctp: introduce round robin stream scheduler
    
    This patch introduces RFC Draft ndata section 3.2 Priority Based
    Scheduler (SCTP_SS_RR).
    
    Works by maintaining a list of enqueued streams and tracking the last
    one used to send data. When the datamsg is done, it switches to the next
    stream.
    
    See-also: https://tools.ietf.org/html/draft-ietf-tsvwg-sctp-ndata-13
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 637784ade221a3c8a7ecd0f583eddd95d6276b9a
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:16 2017 -0300

    sctp: introduce priority based stream scheduler
    
    This patch introduces RFC Draft ndata section 3.4 Priority Based
    Scheduler (SCTP_SS_PRIO).
    
    It works by having a struct sctp_stream_priority for each priority
    configured. This struct is then enlisted on a queue ordered per priority
    if, and only if, there is a stream with data queued, so that dequeueing
    is very straightforward: either finish current datamsg or simply dequeue
    from the highest priority queued, which is the next stream pointed, and
    that's it.
    
    If there are multiple streams assigned with the same priority and with
    data queued, it will do round robin amongst them while respecting
    datamsgs boundaries (when not using idata chunks), to be reasonably
    fair.
    
    We intentionally don't maintain a list of priorities nor a list of all
    streams with the same priority to save memory. The first would mean at
    least 2 other pointers per priority (which, for 1000 priorities, that
    can mean 16kB) and the second would also mean 2 other pointers but per
    stream. As SCTP supports up to 65535 streams on a given asoc, that's
    1MB. This impacts when giving a priority to some stream, as we have to
    find out if the new priority is already being used and if we can free
    the old one, and also when tearing down.
    
    The new fields in struct sctp_stream_out_ext and sctp_stream are added
    under a union because that memory is to be shared with other schedulers.
    
    See-also: https://tools.ietf.org/html/draft-ietf-tsvwg-sctp-ndata-13
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0ccdf3c7fdeda511b10def19505178a9d2d3fccd
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:15 2017 -0300

    sctp: add sockopt to get/set stream scheduler parameters
    
    As defined per RFC Draft ndata Section 4.3.3, named as
    SCTP_STREAM_SCHEDULER_VALUE.
    
    See-also: https://tools.ietf.org/html/draft-ietf-tsvwg-sctp-ndata-13
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 13aa8770fe42d246c6f3a8eb814b85bccb428011
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:14 2017 -0300

    sctp: add sockopt to get/set stream scheduler
    
    As defined per RFC Draft ndata Section 4.3.2, named as
    SCTP_STREAM_SCHEDULER.
    
    See-also: https://tools.ietf.org/html/draft-ietf-tsvwg-sctp-ndata-13
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1ae2eaaa229bc350b6f38fbf4ab9c873532aecfb
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 3 19:20:08 2017 -0300

    sctp: silence warns on sctp_stream_init allocations
    
    As SCTP supports up to 65535 streams, that can lead to very large
    allocations in sctp_stream_init(). As Xin Long noticed, systems with
    small amounts of memory are more prone to not have enough memory and
    dump warnings on dmesg initiated by user actions. Thus, silence them.
    
    Also, if the reallocation of stream->out is not necessary, skip it and
    keep the memory we already have.
    
    Reported-by: Xin Long <lucien.xin@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3b97e138dd9e242ad208e0fd48d4e1a3a61a8031
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Sep 8 11:35:21 2017 -0300

    sctp: fix missing wake ups in some situations
    
    
    [ Upstream commit 7906b00f5cd1cd484fced7fcda892176e3202c8a ]
    
    Commit fb586f25300f ("sctp: delay calls to sk_data_ready() as much as
    possible") minimized the number of wake ups that are triggered in case
    the association receives a packet with multiple data chunks on it and/or
    when io_events are enabled and then commit 0970f5b36659 ("sctp: signal
    sk_data_ready earlier on data chunks reception") moved the wake up to as
    soon as possible. It thus relies on the state machine running later to
    clean the flag that the event was already generated.
    
    The issue is that there are 2 call paths that calls
    sctp_ulpq_tail_event() outside of the state machine, causing the flag to
    linger and possibly omitting a needed wake up in the sequence.
    
    One of the call paths is when enabling SCTP_SENDER_DRY_EVENTS via
    setsockopt(SCTP_EVENTS), as noticed by Harald Welte. The other is when
    partial reliability triggers removal of chunks from the send queue when
    the application calls sendmsg().
    
    This commit fixes it by not setting the flag in case the socket is not
    owned by the user, as it won't be cleaned later. This works for
    user-initiated calls and also for rx path processing.
    
    Fixes: fb586f25300f ("sctp: delay calls to sk_data_ready() as much as possible")
    Reported-by: Harald Welte <laforge@gnumonks.org>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 442df0425e95c1662d08389b3a96a975c300b976
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Sep 8 11:35:21 2017 -0300

    sctp: fix missing wake ups in some situations
    
    
    [ Upstream commit 7906b00f5cd1cd484fced7fcda892176e3202c8a ]
    
    Commit fb586f25300f ("sctp: delay calls to sk_data_ready() as much as
    possible") minimized the number of wake ups that are triggered in case
    the association receives a packet with multiple data chunks on it and/or
    when io_events are enabled and then commit 0970f5b36659 ("sctp: signal
    sk_data_ready earlier on data chunks reception") moved the wake up to as
    soon as possible. It thus relies on the state machine running later to
    clean the flag that the event was already generated.
    
    The issue is that there are 2 call paths that calls
    sctp_ulpq_tail_event() outside of the state machine, causing the flag to
    linger and possibly omitting a needed wake up in the sequence.
    
    One of the call paths is when enabling SCTP_SENDER_DRY_EVENTS via
    setsockopt(SCTP_EVENTS), as noticed by Harald Welte. The other is when
    partial reliability triggers removal of chunks from the send queue when
    the application calls sendmsg().
    
    This commit fixes it by not setting the flag in case the socket is not
    owned by the user, as it won't be cleaned later. This works for
    user-initiated calls and also for rx path processing.
    
    Fixes: fb586f25300f ("sctp: delay calls to sk_data_ready() as much as possible")
    Reported-by: Harald Welte <laforge@gnumonks.org>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3f60dadbe1781e292b560dd353d4a5a637ed192d
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Sep 8 11:35:21 2017 -0300

    sctp: fix missing wake ups in some situations
    
    
    [ Upstream commit 7906b00f5cd1cd484fced7fcda892176e3202c8a ]
    
    Commit fb586f25300f ("sctp: delay calls to sk_data_ready() as much as
    possible") minimized the number of wake ups that are triggered in case
    the association receives a packet with multiple data chunks on it and/or
    when io_events are enabled and then commit 0970f5b36659 ("sctp: signal
    sk_data_ready earlier on data chunks reception") moved the wake up to as
    soon as possible. It thus relies on the state machine running later to
    clean the flag that the event was already generated.
    
    The issue is that there are 2 call paths that calls
    sctp_ulpq_tail_event() outside of the state machine, causing the flag to
    linger and possibly omitting a needed wake up in the sequence.
    
    One of the call paths is when enabling SCTP_SENDER_DRY_EVENTS via
    setsockopt(SCTP_EVENTS), as noticed by Harald Welte. The other is when
    partial reliability triggers removal of chunks from the send queue when
    the application calls sendmsg().
    
    This commit fixes it by not setting the flag in case the socket is not
    owned by the user, as it won't be cleaned later. This works for
    user-initiated calls and also for rx path processing.
    
    Fixes: fb586f25300f ("sctp: delay calls to sk_data_ready() as much as possible")
    Reported-by: Harald Welte <laforge@gnumonks.org>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fa5f7b51fc3080c2b195fa87c7eca7c05e56f673
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Sep 14 02:00:54 2017 +0300

    sctp: potential read out of bounds in sctp_ulpevent_type_enabled()
    
    This code causes a static checker warning because Smatch doesn't trust
    anything that comes from skb->data.  I've reviewed this code and I do
    think skb->data can be controlled by the user here.
    
    The sctp_event_subscribe struct has 13 __u8 fields and we want to see
    if ours is non-zero.  sn_type can be any value in the 0-USHRT_MAX range.
    We're subtracting SCTP_SN_TYPE_BASE which is 1 << 15 so we could read
    either before the start of the struct or after the end.
    
    This is a very old bug and it's surprising that it would go undetected
    for so long but my theory is that it just doesn't have a big impact so
    it would be hard to notice.
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2e2dad202feb82fae3815af2ff44f79957c3aa9b
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Thu Dec 29 14:41:05 2016 +0200

    ARM: s3c2410_defconfig: Fix invalid values for NF_CT_PROTO_*
    
    [ Upstream commit 3ef01c968fbfb21c2f16281445d30a865ee4412c ]
    
    NF_CT_PROTO_DCCP/SCTP/UDPLITE were switched from tristate to boolean so
    defconfig needs to be adjusted to silence warnings:
            warning: symbol value 'm' invalid for NF_CT_PROTO_DCCP
            warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
            warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    
    Signed-off-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit 108074611015bccfaf9ef50710edfd6929e55cd3
Merge: 91aac5637fc0 90c4ae4e2c1d
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Sep 8 11:35:55 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS fixes for net
    
    The following patchset contains Netfilter/IPVS fixes for your net tree,
    they are:
    
    1) Fix SCTP connection setup when IPVS module is loaded and any scheduler
       is registered, from Xin Long.
    
    2) Don't create a SCTP connection from SCTP ABORT packets, also from
       Xin Long.
    
    3) WARN_ON() and drop packet, instead of BUG_ON() races when calling
       nf_nat_setup_info(). This is specifically a longstanding problem
       when br_netfilter with conntrack support is in place, patch from
       Florian Westphal.
    
    4) Avoid softlock splats via iptables-restore, also from Florian.
    
    5) Revert NAT hashtable conversion to rhashtable, semantics of rhlist
       are different from our simple NAT hashtable, this has been causing
       problems in the recent Linux kernel releases. From Florian.
    
    6) Add per-bucket spinlock for NAT hashtable, so at least we restore
       one of the benefits we got from the previous rhashtable conversion.
    
    7) Fix incorrect hashtable size in memory allocation in xt_hashlimit,
       from Zhizhou Tian.
    
    8) Fix build/link problems with hashlimit and 32-bit arches, to address
       recent fallout from a new hashlimit mode, from Vishwanath Pai.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7906b00f5cd1cd484fced7fcda892176e3202c8a
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Sep 8 11:35:21 2017 -0300

    sctp: fix missing wake ups in some situations
    
    Commit fb586f25300f ("sctp: delay calls to sk_data_ready() as much as
    possible") minimized the number of wake ups that are triggered in case
    the association receives a packet with multiple data chunks on it and/or
    when io_events are enabled and then commit 0970f5b36659 ("sctp: signal
    sk_data_ready earlier on data chunks reception") moved the wake up to as
    soon as possible. It thus relies on the state machine running later to
    clean the flag that the event was already generated.
    
    The issue is that there are 2 call paths that calls
    sctp_ulpq_tail_event() outside of the state machine, causing the flag to
    linger and possibly omitting a needed wake up in the sequence.
    
    One of the call paths is when enabling SCTP_SENDER_DRY_EVENTS via
    setsockopt(SCTP_EVENTS), as noticed by Harald Welte. The other is when
    partial reliability triggers removal of chunks from the send queue when
    the application calls sendmsg().
    
    This commit fixes it by not setting the flag in case the socket is not
    owned by the user, as it won't be cleaned later. This works for
    user-initiated calls and also for rx path processing.
    
    Fixes: fb586f25300f ("sctp: delay calls to sk_data_ready() as much as possible")
    Reported-by: Harald Welte <laforge@gnumonks.org>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1cc4a018669f2fb18c10010f1a7ab3f6fb688cef
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Aug 20 13:38:07 2017 +0800

    netfilter: ipvs: fix the issue that sctp_conn_schedule drops non-INIT packet
    
    Commit 5e26b1b3abce ("ipvs: support scheduling inverse and icmp SCTP
    packets") changed to check packet type early. It introduced a side
    effect: if it's not a INIT packet, ports will be set as  NULL, and
    the packet will be dropped later.
    
    It caused that sctp couldn't create connection when ipvs module is
    loaded and any scheduler is registered on server.
    
    Li Shuang reproduced it by running the cmds on sctp server:
      # ipvsadm -A -t 1.1.1.1:80 -s rr
      # ipvsadm -D -t 1.1.1.1:80
    then the server could't work any more.
    
    This patch is to return 1 when it's not an INIT packet. It means ipvs
    will accept it without creating a conn for it, just like what it does
    for tcp.
    
    Fixes: 5e26b1b3abce ("ipvs: support scheduling inverse and icmp SCTP packets")
    Reported-by: Li Shuang <shuali@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit d11dd6cdc3883f3c74f841f4d40dfe57c0b9756c
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Aug 28 11:52:07 2017 +0200

    netfilter: conntrack: remove unused code in nf_conntrack_proto_generic.c
    
    L4 protocol helpers for DCCP, SCTP and UDPlite can't be built as kernel
    modules anymore, so we can remove code enclosed in
     #ifdef CONFIG_NF_CT_PROTO_{DCCP,SCTP,UDPLITE}_MODULE
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 641f656db0b641c4f01a6284f359679dbe57a314
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Wed Aug 23 15:37:49 2017 +1000

    powerpc/configs: Drop no longer needed CONFIG_LIBCRC32C
    
    Since commit 300ae149468f ("netfilter: select LIBCRC32C together with
    SCTP conntrack") we no longer need to set CONFIG_LIBCRC32C in our
    defconfigs.
    
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>

commit b8465a6ae5cde49fe76180a35f7863eb17c32ba2
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Wed Aug 23 15:37:28 2017 +1000

    powerpc/configs: Update for CONFIG_NF_CT_PROTO_(SCTP|UDPLITE)=y
    
    In commit a85406afeb3e ("netfilter: conntrack: built-in support for
    SCTP"), NF_CT_PROTO_SCTP switched from tristate to bool and became
    default y. Similarly in commit 9b91c96c5d1f ("netfilter: conntrack:
    built-in support for UDPlite"), NF_CT_PROTO_UDPLITE switched from
    tristate to bool and became default y.
    
    We had a few configs which set them to =m, which is no longer valid.
    We don't need to change them to =y because both symbols are default y
    and are enabled automatically based on the other symbols in the
    affected defconfigs.
    
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>

commit 7be680f71d7d9338beaf00fd01806d751932c68a
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu Aug 3 22:54:48 2017 +0200

    net/mlx4_en: don't set CHECKSUM_COMPLETE on SCTP packets
    
    
    [ Upstream commit e718fe450e616227b74d27a233cdf37b4df0c82b ]
    
    if the NIC fails to validate the checksum on TCP/UDP, and validation of IP
    checksum is successful, the driver subtracts the pseudo-header checksum
    from the value obtained by the hardware and sets CHECKSUM_COMPLETE. Don't
    do that if protocol is IPPROTO_SCTP, otherwise CRC32c validation fails.
    
    V2: don't test MLX4_CQE_STATUS_IPV6 if MLX4_CQE_STATUS_IPV4 is set
    
    Reported-by: Shuang Li <shuali@redhat.com>
    Fixes: f8c6455bb04b ("net/mlx4_en: Extend checksum offloading by CHECKSUM COMPLETE")
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 35d90144e2ceb19a8c649fd1422d507eac946893
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu Aug 3 22:54:48 2017 +0200

    net/mlx4_en: don't set CHECKSUM_COMPLETE on SCTP packets
    
    
    [ Upstream commit e718fe450e616227b74d27a233cdf37b4df0c82b ]
    
    if the NIC fails to validate the checksum on TCP/UDP, and validation of IP
    checksum is successful, the driver subtracts the pseudo-header checksum
    from the value obtained by the hardware and sets CHECKSUM_COMPLETE. Don't
    do that if protocol is IPPROTO_SCTP, otherwise CRC32c validation fails.
    
    V2: don't test MLX4_CQE_STATUS_IPV6 if MLX4_CQE_STATUS_IPV4 is set
    
    Reported-by: Shuang Li <shuali@redhat.com>
    Fixes: f8c6455bb04b ("net/mlx4_en: Extend checksum offloading by CHECKSUM COMPLETE")
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0c59f879ba5ef8b7a0f36f66f14e10167c82ffe2
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 15 16:34:35 2015 +0100

    net: sctp: fix race for one-to-many sockets in sendmsg's auto associate
    
    commit 2061dcd6bff8b774b4fac8b0739b6be3f87bc9f2 upstream.
    
    I.e. one-to-many sockets in SCTP are not required to explicitly
    call into connect(2) or sctp_connectx(2) prior to data exchange.
    Instead, they can directly invoke sendmsg(2) and the SCTP stack
    will automatically trigger connection establishment through 4WHS
    via sctp_primitive_ASSOCIATE(). However, this in its current
    implementation is racy: INIT is being sent out immediately (as
    it cannot be bundled anyway) and the rest of the DATA chunks are
    queued up for later xmit when connection is established, meaning
    sendmsg(2) will return successfully. This behaviour can result
    in an undesired side-effect that the kernel made the application
    think the data has already been transmitted, although none of it
    has actually left the machine, worst case even after close(2)'ing
    the socket.
    
    Instead, when the association from client side has been shut down
    e.g. first gracefully through SCTP_EOF and then close(2), the
    client could afterwards still receive the server's INIT_ACK due
    to a connection with higher latency. This INIT_ACK is then considered
    out of the blue and hence responded with ABORT as there was no
    alive assoc found anymore. This can be easily reproduced f.e.
    with sctp_test application from lksctp. One way to fix this race
    is to wait for the handshake to actually complete.
    
    The fix defers waiting after sctp_primitive_ASSOCIATE() and
    sctp_primitive_SEND() succeeded, so that DATA chunks cooked up
    from sctp_sendmsg() have already been placed into the output
    queue through the side-effect interpreter, and therefore can then
    be bundeled together with COOKIE_ECHO control chunks.
    
    strace from example application (shortened):
    
    socket(PF_INET, SOCK_SEQPACKET, IPPROTO_SCTP) = 3
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(0)=[], msg_controllen=48, {cmsg_len=48, cmsg_level=0x84 /* SOL_??? */, cmsg_type=, ...},
               msg_flags=0}, 0) = 0 // graceful shutdown for SOCK_SEQPACKET via SCTP_EOF
    close(3) = 0
    
    tcpdump before patch (fooling the application):
    
    22:33:36.306142 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 3879023686] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3139201684]
    22:33:36.316619 IP 192.168.1.115.8888 > 192.168.1.114.41462: sctp (1) [INIT ACK] [init tag: 3345394793] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 3380109591]
    22:33:36.317600 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [ABORT]
    
    tcpdump after patch:
    
    14:28:58.884116 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 438593213] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3092969729]
    14:28:58.888414 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [INIT ACK] [init tag: 381429855] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 2141904492]
    14:28:58.888638 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [COOKIE ECHO] , (2) [DATA] (B)(E) [TSN: 3092969729] [...]
    14:28:58.893278 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [COOKIE ACK] , (2) [SACK] [cum ack 3092969729] [a_rwnd 106491] [#gap acks 0] [#dup tsns 0]
    14:28:58.893591 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969730] [...]
    14:28:59.096963 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969730] [a_rwnd 106496] [#gap acks 0] [#dup tsns 0]
    14:28:59.097086 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969731] [...] , (2) [DATA] (B)(E) [TSN: 3092969732] [...]
    14:28:59.103218 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969732] [a_rwnd 106486] [#gap acks 0] [#dup tsns 0]
    14:28:59.103330 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN]
    14:28:59.107793 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SHUTDOWN ACK]
    14:28:59.107890 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN COMPLETE]
    
    Looks like this bug is from the pre-git history museum. ;)
    
    Fixes: 08707d5482df ("lksctp-2_5_31-0_5_1.patch")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Amit Pundir <amit.pundir@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c52b446b4921efcf58d75b0f59641ec7e78662d7
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 14 22:07:33 2017 +0800

    sctp: fix an array overflow when all ext chunks are set
    
    
    [ Upstream commit 10b3bf54406bb7f4e78da9bb2a485c5c986678ad ]
    
    Marcelo noticed an array overflow caused by commit c28445c3cb07
    ("sctp: add reconf_enable in asoc ep and netns"), in which sctp
    would add SCTP_CID_RECONF into extensions when reconf_enable is
    set in sctp_make_init and sctp_make_init_ack.
    
    Then now when all ext chunks are set, 4 ext chunk ids can be put
    into extensions array while extensions array size is 3. It would
    cause a kernel panic because of this overflow.
    
    This patch is to fix it by defining extensions array size is 4 in
    both sctp_make_init and sctp_make_init_ack.
    
    Fixes: c28445c3cb07 ("sctp: add reconf_enable in asoc ep and netns")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4530cca1989b70b2c487ad5bcf82e608ab55f734
Merge: bfa738cf3dfa 8d63bee643f1
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Aug 9 10:14:04 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "The pull requests are getting smaller, that's progress I suppose :-)
    
       1) Fix infinite loop in CIPSO option parsing, from Yujuan Qi.
    
       2) Fix remote checksum handling in VXLAN and GUE tunneling drivers,
          from Koichiro Den.
    
       3) Missing u64_stats_init() calls in several drivers, from Florian
          Fainelli.
    
       4) TCP can set the congestion window to an invalid ssthresh value
          after congestion window reductions, from Yuchung Cheng.
    
       5) Fix BPF jit branch generation on s390, from Daniel Borkmann.
    
       6) Correct MIPS ebpf JIT merge, from David Daney.
    
       7) Correct byte order test in BPF test_verifier.c, from Daniel
          Borkmann.
    
       8) Fix various crashes and leaks in ASIX driver, from Dean Jenkins.
    
       9) Handle SCTP checksums properly in mlx4 driver, from Davide
          Caratti.
    
      10) We can potentially enter tcp_connect() with a cached route
          already, due to fastopen, so we have to explicitly invalidate it.
    
      11) skb_warn_bad_offload() can bark in legitimate situations, fix from
          Willem de Bruijn"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (52 commits)
      net: avoid skb_warn_bad_offload false positives on UFO
      qmi_wwan: fix NULL deref on disconnect
      ppp: fix xmit recursion detection on ppp channels
      rds: Reintroduce statistics counting
      tcp: fastopen: tcp_connect() must refresh the route
      net: sched: set xt_tgchk_param par.net properly in ipt_init_target
      net: dsa: mediatek: add adjust link support for user ports
      net/mlx4_en: don't set CHECKSUM_COMPLETE on SCTP packets
      qed: Fix a memory allocation failure test in 'qed_mcp_cmd_init()'
      hysdn: fix to a race condition in put_log_buffer
      s390/qeth: fix L3 next-hop in xmit qeth hdr
      asix: Fix small memory leak in ax88772_unbind()
      asix: Ensure asix_rx_fixup_info members are all reset
      asix: Add rx->ax_skb = NULL after usbnet_skb_return()
      bpf: fix selftest/bpf/test_pkt_md_access on s390x
      netvsc: fix race on sub channel creation
      bpf: fix byte order test in test_verifier
      xgene: Always get clk source, but ignore if it's missing for SGMII ports
      MIPS: Add missing file for eBPF JIT.
      bpf, s390: fix build for libbpf and selftest suite
      ...

commit e718fe450e616227b74d27a233cdf37b4df0c82b
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu Aug 3 22:54:48 2017 +0200

    net/mlx4_en: don't set CHECKSUM_COMPLETE on SCTP packets
    
    if the NIC fails to validate the checksum on TCP/UDP, and validation of IP
    checksum is successful, the driver subtracts the pseudo-header checksum
    from the value obtained by the hardware and sets CHECKSUM_COMPLETE. Don't
    do that if protocol is IPPROTO_SCTP, otherwise CRC32c validation fails.
    
    V2: don't test MLX4_CQE_STATUS_IPV6 if MLX4_CQE_STATUS_IPV4 is set
    
    Reported-by: Shuang Li <shuali@redhat.com>
    Fixes: f8c6455bb04b ("net/mlx4_en: Extend checksum offloading by CHECKSUM COMPLETE")
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 701ef3e6c74be771a76be39817941e68e7228644
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Aug 5 19:59:53 2017 +0800

    sctp: remove the typedef sctp_scope_policy_t
    
    This patch is to remove the typedef sctp_scope_policy_t and keep
    it's members as an anonymous enum.
    
    It is also to define SCTP_SCOPE_POLICY_MAX to replace the num 3
    in sysctl.c to make codes clear.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8c065e76fbc5e962db614d4d2d1a8eda461ca9d5
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Thu Dec 29 14:41:05 2016 +0200

    ARM: s3c2410_defconfig: Fix invalid values for NF_CT_PROTO_*
    
    
    [ Upstream commit 3ef01c968fbfb21c2f16281445d30a865ee4412c ]
    
    NF_CT_PROTO_DCCP/SCTP/UDPLITE were switched from tristate to boolean so
    defconfig needs to be adjusted to silence warnings:
            warning: symbol value 'm' invalid for NF_CT_PROTO_DCCP
            warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
            warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    
    Signed-off-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ebd4642ee412ba3719274d80658a4c785fc43678
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Thu Dec 29 14:41:05 2016 +0200

    ARM: s3c2410_defconfig: Fix invalid values for NF_CT_PROTO_*
    
    
    [ Upstream commit 3ef01c968fbfb21c2f16281445d30a865ee4412c ]
    
    NF_CT_PROTO_DCCP/SCTP/UDPLITE were switched from tristate to boolean so
    defconfig needs to be adjusted to silence warnings:
            warning: symbol value 'm' invalid for NF_CT_PROTO_DCCP
            warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
            warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    
    Signed-off-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 96080f697786e0a30006fcbcc5b53f350fcb3e9f
Merge: 63a86362130f cbf5ecb30560
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Jul 20 16:33:39 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) BPF verifier signed/unsigned value tracking fix, from Daniel
        Borkmann, Edward Cree, and Josef Bacik.
    
     2) Fix memory allocation length when setting up calls to
        ->ndo_set_mac_address, from Cong Wang.
    
     3) Add a new cxgb4 device ID, from Ganesh Goudar.
    
     4) Fix FIB refcount handling, we have to set it's initial value before
        the configure callback (which can bump it). From David Ahern.
    
     5) Fix double-free in qcom/emac driver, from Timur Tabi.
    
     6) A bunch of gcc-7 string format overflow warning fixes from Arnd
        Bergmann.
    
     7) Fix link level headroom tests in ip_do_fragment(), from Vasily
        Averin.
    
     8) Fix chunk walking in SCTP when iterating over error and parameter
        headers. From Alexander Potapenko.
    
     9) TCP BBR congestion control fixes from Neal Cardwell.
    
    10) Fix SKB fragment handling in bcmgenet driver, from Doug Berger.
    
    11) BPF_CGROUP_RUN_PROG_SOCK_OPS needs to check for null __sk, from Cong
        Wang.
    
    12) xmit_recursion in ppp driver needs to be per-device not per-cpu,
        from Gao Feng.
    
    13) Cannot release skb->dst in UDP if IP options processing needs it.
        From Paolo Abeni.
    
    14) Some netdev ioctl ifr_name[] NULL termination fixes. From Alexander
        Levin and myself.
    
    15) Revert some rtnetlink notification changes that are causing
        regressions, from David Ahern.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (83 commits)
      net: bonding: Fix transmit load balancing in balance-alb mode
      rds: Make sure updates to cp_send_gen can be observed
      net: ethernet: ti: cpsw: Push the request_irq function to the end of probe
      ipv4: initialize fib_trie prior to register_netdev_notifier call.
      rtnetlink: allocate more memory for dev_set_mac_address()
      net: dsa: b53: Add missing ARL entries for BCM53125
      bpf: more tests for mixed signed and unsigned bounds checks
      bpf: add test for mixed signed and unsigned bounds checks
      bpf: fix up test cases with mixed signed/unsigned bounds
      bpf: allow to specify log level and reduce it for test_verifier
      bpf: fix mixed signed/unsigned derived min/max value bounds
      ipv6: avoid overflow of offset in ip6_find_1stfragopt
      net: tehuti: don't process data if it has not been copied from userspace
      Revert "rtnetlink: Do not generate notifications for CHANGEADDR event"
      net: dsa: mv88e6xxx: Enable CMODE config support for 6390X
      dt-binding: ptp: Add SoC compatibility strings for dte ptp clock
      NET: dwmac: Make dwmac reset unconditional
      net: Zero terminate ifr_name in dev_ifname().
      wireless: wext: terminate ifr name coming from userspace
      netfilter: fix netfilter_net_init() return
      ...

commit 10b3bf54406bb7f4e78da9bb2a485c5c986678ad
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Jul 14 22:07:33 2017 +0800

    sctp: fix an array overflow when all ext chunks are set
    
    Marcelo noticed an array overflow caused by commit c28445c3cb07
    ("sctp: add reconf_enable in asoc ep and netns"), in which sctp
    would add SCTP_CID_RECONF into extensions when reconf_enable is
    set in sctp_make_init and sctp_make_init_ack.
    
    Then now when all ext chunks are set, 4 ext chunk ids can be put
    into extensions array while extensions array size is 3. It would
    cause a kernel panic because of this overflow.
    
    This patch is to fix it by defining extensions array size is 4 in
    both sctp_make_init and sctp_make_init_ack.
    
    Fixes: c28445c3cb07 ("sctp: add reconf_enable in asoc ep and netns")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5518b69b76680a4f2df96b1deca260059db0c2de
Merge: 8ad06e56dcbc 0e72582270c0
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jul 5 12:31:59 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Reasonably busy this cycle, but perhaps not as busy as in the 4.12
      merge window:
    
       1) Several optimizations for UDP processing under high load from
          Paolo Abeni.
    
       2) Support pacing internally in TCP when using the sch_fq packet
          scheduler for this is not practical. From Eric Dumazet.
    
       3) Support mutliple filter chains per qdisc, from Jiri Pirko.
    
       4) Move to 1ms TCP timestamp clock, from Eric Dumazet.
    
       5) Add batch dequeueing to vhost_net, from Jason Wang.
    
       6) Flesh out more completely SCTP checksum offload support, from
          Davide Caratti.
    
       7) More plumbing of extended netlink ACKs, from David Ahern, Pablo
          Neira Ayuso, and Matthias Schiffer.
    
       8) Add devlink support to nfp driver, from Simon Horman.
    
       9) Add RTM_F_FIB_MATCH flag to RTM_GETROUTE queries, from Roopa
          Prabhu.
    
      10) Add stack depth tracking to BPF verifier and use this information
          in the various eBPF JITs. From Alexei Starovoitov.
    
      11) Support XDP on qed device VFs, from Yuval Mintz.
    
      12) Introduce BPF PROG ID for better introspection of installed BPF
          programs. From Martin KaFai Lau.
    
      13) Add bpf_set_hash helper for TC bpf programs, from Daniel Borkmann.
    
      14) For loads, allow narrower accesses in bpf verifier checking, from
          Yonghong Song.
    
      15) Support MIPS in the BPF selftests and samples infrastructure, the
          MIPS eBPF JIT will be merged in via the MIPS GIT tree. From David
          Daney.
    
      16) Support kernel based TLS, from Dave Watson and others.
    
      17) Remove completely DST garbage collection, from Wei Wang.
    
      18) Allow installing TCP MD5 rules using prefixes, from Ivan
          Delalande.
    
      19) Add XDP support to Intel i40e driver, from Bjrn Tpel
    
      20) Add support for TC flower offload in nfp driver, from Simon
          Horman, Pieter Jansen van Vuuren, Benjamin LaHaise, Jakub
          Kicinski, and Bert van Leeuwen.
    
      21) IPSEC offloading support in mlx5, from Ilan Tayari.
    
      22) Add HW PTP support to macb driver, from Rafal Ozieblo.
    
      23) Networking refcount_t conversions, From Elena Reshetova.
    
      24) Add sock_ops support to BPF, from Lawrence Brako. This is useful
          for tuning the TCP sockopt settings of a group of applications,
          currently via CGROUPs"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1899 commits)
      net: phy: dp83867: add workaround for incorrect RX_CTRL pin strap
      dt-bindings: phy: dp83867: provide a workaround for incorrect RX_CTRL pin strap
      cxgb4: Support for get_ts_info ethtool method
      cxgb4: Add PTP Hardware Clock (PHC) support
      cxgb4: time stamping interface for PTP
      nfp: default to chained metadata prepend format
      nfp: remove legacy MAC address lookup
      nfp: improve order of interfaces in breakout mode
      net: macb: remove extraneous return when MACB_EXT_DESC is defined
      bpf: add missing break in for the TCP_BPF_SNDCWND_CLAMP case
      bpf: fix return in load_bpf_file
      mpls: fix rtm policy in mpls_getroute
      net, ax25: convert ax25_cb.refcount from atomic_t to refcount_t
      net, ax25: convert ax25_route.refcount from atomic_t to refcount_t
      net, ax25: convert ax25_uid_assoc.refcount from atomic_t to refcount_t
      net, sctp: convert sctp_ep_common.refcnt from atomic_t to refcount_t
      net, sctp: convert sctp_transport.refcnt from atomic_t to refcount_t
      net, sctp: convert sctp_chunk.refcnt from atomic_t to refcount_t
      net, sctp: convert sctp_datamsg.refcnt from atomic_t to refcount_t
      net, sctp: convert sctp_auth_bytes.refcnt from atomic_t to refcount_t
      ...

commit 2cb5c8e378d10a57aa1c9eaee36bea46c27dd2b9
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Jun 30 13:32:57 2017 -0400

    sctp: Add peeloff-flags socket option
    
    Based on a request raised on the sctp devel list, there is a need to
    augment the sctp_peeloff operation while specifying the O_CLOEXEC and
    O_NONBLOCK flags (simmilar to the socket syscall).  Since modifying the
    SCTP_SOCKOPT_PEELOFF socket option would break user space ABI for existing
    programs, this patch creates a new socket option
    SCTP_SOCKOPT_PEELOFF_FLAGS, which accepts a third flags parameter to
    allow atomic assignment of the socket descriptor flags.
    
    Tested successfully by myself and the requestor
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Andreas Steinmetz <ast@domdv.de>
    CC: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit deaa0a976b829af8a7886d8e2528a675cbe4dac8
Author: Liping Zhang <zlpnobody@gmail.com>
Date:   Sun Jun 4 19:17:34 2017 +0800

    netfilter: nf_ct_dccp/sctp: fix memory leak after netns cleanup
    
    After running the following commands for a while, kmemleak reported that
    "1879 new suspected memory leaks" happened:
      # while : ; do
      ip netns add test
      ip netns delete test
      done
    
      unreferenced object 0xffff88006342fa38 (size 1024):
      comm "ip", pid 15477, jiffies 4295982857 (age 957.836s)
      hex dump (first 32 bytes):
        b8 b0 4d a0 ff ff ff ff c0 34 c3 59 00 88 ff ff  ..M......4.Y....
        04 00 00 00 a4 01 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff8190510a>] kmemleak_alloc+0x4a/0xa0
        [<ffffffff81284130>] __kmalloc_track_caller+0x150/0x300
        [<ffffffff812302d0>] kmemdup+0x20/0x50
        [<ffffffffa04d598a>] dccp_init_net+0x8a/0x160 [nf_conntrack]
        [<ffffffffa04cf9f5>] nf_ct_l4proto_pernet_register_one+0x25/0x90
      ...
      unreferenced object 0xffff88006342da58 (size 1024):
      comm "ip", pid 15477, jiffies 4295982857 (age 957.836s)
      hex dump (first 32 bytes):
        10 b3 4d a0 ff ff ff ff 04 35 c3 59 00 88 ff ff  ..M......5.Y....
        04 00 00 00 a4 01 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff8190510a>] kmemleak_alloc+0x4a/0xa0
        [<ffffffff81284130>] __kmalloc_track_caller+0x150/0x300
        [<ffffffff812302d0>] kmemdup+0x20/0x50
        [<ffffffffa04d6a9d>] sctp_init_net+0x5d/0x130 [nf_conntrack]
        [<ffffffffa04cf9f5>] nf_ct_l4proto_pernet_register_one+0x25/0x90
      ...
    
    This is because we forgot to implement the get_net_proto for sctp and
    dccp, so we won't invoke the nf_ct_unregister_sysctl to free the
    ctl_table when do netns cleanup. Also note, we will fail to register
    the sysctl for dccp/sctp either due to the lack of get_net_proto.
    
    Fixes: c51d39010a1b ("netfilter: conntrack: built-in support for DCCP")
    Fixes: a85406afeb3e ("netfilter: conntrack: built-in support for SCTP")
    Cc: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Liping Zhang <zlpnobody@gmail.com>
    Acked-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit d3121ad14562a320bc82195fd1034dca7a089610
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Tue May 23 21:53:53 2017 -0400

    ARM: defconfigs: make NF_CT_PROTO_SCTP and NF_CT_PROTO_UDPLITE built-in
    
    [ Upstream commit 5aff1d245e8cc1ab5c4517d916edaed9e3f7f973 ]
    
    The symbols can no longer be used as loadable modules, leading to a harmless Kconfig
    warning:
    
    arch/arm/configs/imote2_defconfig:60:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/imote2_defconfig:59:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    arch/arm/configs/ezx_defconfig:68:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/ezx_defconfig:67:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    
    Let's make them built-in.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit 80f68f7daeb3bc2c41cd876d9abdf3a99e9e571b
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    [ Upstream commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df ]
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit e7b4f3d39f46530f340af6eabbc60fbad9f94f05
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    [ Upstream commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 ]
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>

commit 48b6bbef9a1789f0365c1a385879a1fea4460016
Merge: ce879b64a7be b4846fc3c855
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jun 21 12:40:20 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix refcounting wrt timers which hold onto inet6 address objects,
        from Xin Long.
    
     2) Fix an ancient bug in wireless wext ioctls, from Johannes Berg.
    
     3) Firmware handling fixes in brcm80211 driver, from Arend Van Spriel.
    
     4) Several mlx5 driver fixes (firmware readiness, timestamp cap
        reporting, devlink command validity checking, tc offloading, etc.)
        From Eli Cohen, Maor Dickman, Chris Mi, and Or Gerlitz.
    
     5) Fix dst leak in IP/IP6 tunnels, from Haishuang Yan.
    
     6) Fix dst refcount bug in decnet, from Wei Wang.
    
     7) Netdev can be double freed in register_vlan_device(). Fix from Gao
        Feng.
    
     8) Don't allow object to be destroyed while it is being dumped in SCTP,
        from Xin Long.
    
     9) Fix dpaa_eth build when modular, from Madalin Bucur.
    
    10) Fix throw route leaks, from Serhey Popovych.
    
    11) IFLA_GROUP missing from if_nlmsg_size() and ifla_policy[] table,
        also from Serhey Popovych.
    
    12) Fix premature TX SKB free in stmmac, from Niklas Cassel.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (36 commits)
      igmp: add a missing spin_lock_init()
      net: stmmac: free an skb first when there are no longer any descriptors using it
      sfc: remove duplicate up_write on VF filter_sem
      rtnetlink: add IFLA_GROUP to ifla_policy
      ipv6: Do not leak throw route references
      dt-bindings: net: sms911x: Add missing optional VDD regulators
      dpaa_eth: reuse the dma_ops provided by the FMan MAC device
      fsl/fman: propagate dma_ops
      net/core: remove explicit do_softirq() from busy_poll_stop()
      fib_rules: Resolve goto rules target on delete
      sctp: ensure ep is not destroyed before doing the dump
      net/hns:bugfix of ethtool -t phy self_test
      net: 8021q: Fix one possible panic caused by BUG_ON in free_netdev
      cxgb4: notify uP to route ctrlq compl to rdma rspq
      ip6_tunnel: Correct tos value in collect_md mode
      decnet: always not take dst->__refcnt when inserting dst into hash table
      ip6_tunnel: fix potential issue in __ip6_tnl_rcv
      ip_tunnel: fix potential issue in ip_tunnel_rcv
      brcmfmac: fix uninitialized warning in brcmf_usb_probe_phase2()
      net/mlx5e: Avoid doing a cleanup call if the profile doesn't have it
      ...

commit 8cd5c25f2db03306727d2f6b8f28956169dc1123
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Jun 20 16:01:55 2017 +0800

    sctp: uncork the old asoc before changing to the new one
    
    local_cork is used to decide if it should uncork asoc outq after processing
    some cmds, and it is set when replying or sending msgs. local_cork should
    always have the same value with current asoc q->cork in some way.
    
    The thing is when changing to a new asoc by cmd SET_ASOC, local_cork may
    not be consistent with the current asoc any more. The cmd seqs can be:
    
      SCTP_CMD_UPDATE_ASSOC (asoc)
      SCTP_CMD_REPLY (asoc)
      SCTP_CMD_SET_ASOC (new_asoc)
      SCTP_CMD_DELETE_TCB (new_asoc)
      SCTP_CMD_SET_ASOC (asoc)
      SCTP_CMD_REPLY (asoc)
    
    The 1st REPLY makes OLD asoc q->cork and local_cork both are 1, and the cmd
    DELETE_TCB clears NEW asoc q->cork and local_cork. After asoc goes back to
    OLD asoc, q->cork is still 1 while local_cork is 0. The 2nd REPLY will not
    set local_cork because q->cork is already set and it can't be uncorked and
    sent out because of this.
    
    To keep local_cork consistent with the current asoc q->cork, this patch is
    to uncork the old asoc if local_cork is set before changing to the new one.
    
    Note that the above cmd seqs will be used in the next patch when updating
    asoc and handling errors in it.
    
    Suggested-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 40f6d71c0a0900c2b76cab421ee4ccfc6f425a35
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Tue May 23 21:53:53 2017 -0400

    ARM: defconfigs: make NF_CT_PROTO_SCTP and NF_CT_PROTO_UDPLITE built-in
    
    
    [ Upstream commit 5aff1d245e8cc1ab5c4517d916edaed9e3f7f973 ]
    
    The symbols can no longer be used as loadable modules, leading to a harmless Kconfig
    warning:
    
    arch/arm/configs/imote2_defconfig:60:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/imote2_defconfig:59:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    arch/arm/configs/ezx_defconfig:68:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/ezx_defconfig:67:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    
    Let's make them built-in.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8ceaec02b17397d12719a282945abc95f8149d9f
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Feb 20 20:51:06 2014 +0100

    net: sctp: rework multihoming retransmission path selection to rfc4960
    
    commit 4c47af4d5eb2c2f78f886079a3920a7078a6f0a0 upstream.
    
    Problem statement: 1) both paths (primary path1 and alternate
    path2) are up after the association has been established i.e.,
    HB packets are normally exchanged, 2) path2 gets inactive after
    path_max_retrans * max_rto timed out (i.e. path2 is down completely),
    3) now, if a transmission times out on the only surviving/active
    path1 (any ~1sec network service impact could cause this like
    a channel bonding failover), then the retransmitted packets are
    sent over the inactive path2; this happens with partial failover
    and without it.
    
    Besides not being optimal in the above scenario, a small failure
    or timeout in the only existing path has the potential to cause
    long delays in the retransmission (depending on RTO_MAX) until
    the still active path is reselected. Further, when the T3-timeout
    occurs, we have active_patch == retrans_path, and even though the
    timeout occurred on the initial transmission of data, not a
    retransmit, we end up updating retransmit path.
    
    RFC4960, section 6.4. "Multi-Homed SCTP Endpoints" states under
    6.4.1. "Failover from an Inactive Destination Address" the
    following:
    
      Some of the transport addresses of a multi-homed SCTP endpoint
      may become inactive due to either the occurrence of certain
      error conditions (see Section 8.2) or adjustments from the
      SCTP user.
    
      When there is outbound data to send and the primary path
      becomes inactive (e.g., due to failures), or where the SCTP
      user explicitly requests to send data to an inactive
      destination transport address, before reporting an error to
      its ULP, the SCTP endpoint should try to send the data to an
      alternate __active__ destination transport address if one
      exists.
    
      When retransmitting data that timed out, if the endpoint is
      multihomed, it should consider each source-destination address
      pair in its retransmission selection policy. When retransmitting
      timed-out data, the endpoint should attempt to pick the most
      divergent source-destination pair from the original
      source-destination pair to which the packet was transmitted.
    
      Note: Rules for picking the most divergent source-destination
      pair are an implementation decision and are not specified
      within this document.
    
    So, we should first reconsider to take the current active
    retransmission transport if we cannot find an alternative
    active one. If all of that fails, we can still round robin
    through unkown, partial failover, and inactive ones in the
    hope to find something still suitable.
    
    Commit 4141ddc02a92 ("sctp: retran_path update bug fix") broke
    that behaviour by selecting the next inactive transport when
    no other active transport was found besides the current assoc's
    peer.retran_path. Before commit 4141ddc02a92, we would have
    traversed through the list until we reach our peer.retran_path
    again, and in case that is still in state SCTP_ACTIVE, we would
    take it and return. Only if that is not the case either, we
    take the next inactive transport.
    
    Besides all that, another issue is that transports in state
    SCTP_UNKNOWN could be preferred over transports in state
    SCTP_ACTIVE in case a SCTP_ACTIVE transport appears after
    SCTP_UNKNOWN in the transport list yielding a weaker transport
    state to be used in retransmission.
    
    This patch mostly reverts 4141ddc02a92, but also rewrites
    this function to introduce more clarity and strictness into
    the code. A strict priority of transport states is enforced
    in this patch, hence selection is active > unkown > partial
    failover > inactive.
    
    Fixes: 4141ddc02a92 ("sctp: retran_path update bug fix")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <yasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [wt: picked updated function from 3.12 except the debug statement]
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 90e7c3322d0cd536b29c7ea70af906283317dc42
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    
    [ Upstream commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df ]
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 703a20827411c3906b644713bc4462d4b3fb6a5f
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    
    [ Upstream commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 ]
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1de51502a02598a8deaced6ab7575089108ec823
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    
    [ Upstream commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df ]
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5e7d9f0b3f729a64b99e58047f7bb0ff36acb759
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    
    [ Upstream commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 ]
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97f54575ff57da3f93f95006802a7892450c1898
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    
    [ Upstream commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df ]
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ffa551def59c9b0e1747955af6a742443ae152fc
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    
    [ Upstream commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 ]
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 698f506e94657710daf773a65c22d0e54124c72d
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    
    [ Upstream commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df ]
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 56fd34c68676131cce13b0031990e49e80d3ee99
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    
    [ Upstream commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 ]
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 60e7579f4b71e2e8b252d2f1b3ef5ffb3b971a4e
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 upstream.
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit cc1fa7814bdb7ebee2ee79bbce181c0783de9ad5
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8 upstream.
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 468b0df61a5146e79f63380ad6c36228fd30619c
Merge: c21fbe29f858 fefa92679dbe
Author: David S. Miller <davem@davemloft.net>
Date:   Mon May 29 23:16:54 2017 -0400

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    The following patchset contains Netfilter fixes for your net tree,
    they are:
    
    1) Conntrack SCTP CRC32c checksum mangling may operate on non-linear
       skbuff, patch from Davide Caratti.
    
    2) nf_tables rb-tree set backend does not handle element re-addition
       after deletion in the same transaction, leading to infinite loop.
    
    3) Atomically unclear the IPS_SRC_NAT_DONE_BIT on nat module removal,
       from Liping Zhang.
    
    4) Conntrack hashtable resizing while ctnetlink dump is progress leads
       to a dead reference to released objects in the lists, also from
       Liping.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6741d51699ac9ef21f1fac14c63ecd31d3a7c278
Merge: cdbe0206783b 3fb07daff8e9
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri May 26 13:51:01 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix state pruning in bpf verifier wrt. alignment, from Daniel
        Borkmann.
    
     2) Handle non-linear SKBs properly in SCTP ICMP parsing, from Davide
        Caratti.
    
     3) Fix bit field definitions for rss_hash_type of descriptors in mlx5
        driver, from Jesper Brouer.
    
     4) Defer slave->link updates until bonding is ready to do a full commit
        to the new settings, from Nithin Sujir.
    
     5) Properly reference count ipv4 FIB metrics to avoid use after free
        situations, from Eric Dumazet and several others including Cong Wang
        and Julian Anastasov.
    
     6) Fix races in llc_ui_bind(), from Lin Zhang.
    
     7) Fix regression of ESP UDP encapsulation for TCP packets, from
        Steffen Klassert.
    
     8) Fix mdio-octeon driver Kconfig deps, from Randy Dunlap.
    
     9) Fix regression in setting DSCP on ipv6/GRE encapsulation, from Peter
        Dawson.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (43 commits)
      ipv4: add reference counting to metrics
      net: ethernet: ax88796: don't call free_irq without request_irq first
      ip6_tunnel, ip6_gre: fix setting of DSCP on encapsulated packets
      sctp: fix ICMP processing if skb is non-linear
      net: llc: add lock_sock in llc_ui_bind to avoid a race condition
      bonding: Don't update slave->link until ready to commit
      test_bpf: Add a couple of tests for BPF_JSGE.
      bpf: add various verifier test cases
      bpf: fix wrong exposure of map_flags into fdinfo for lpm
      bpf: add bpf_clone_redirect to bpf_helper_changes_pkt_data
      bpf: properly reset caller saved regs after helper call and ld_abs/ind
      bpf: fix incorrect pruning decision when alignment must be tracked
      arp: fixed -Wuninitialized compiler warning
      tcp: avoid fastopen API to be used on AF_UNSPEC
      net: move somaxconn init from sysctl code
      net: fix potential null pointer dereference
      geneve: fix fill_info when using collect_metadata
      virtio-net: enable TSO/checksum offloads for Q-in-Q vlans
      be2net: Fix offload features for Q-in-Q packets
      vlan: Fix tcp checksum offloads in Q-in-Q vlans
      ...

commit 804ec7ebe8ea003999ca8d1bfc499edc6a9e07df
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 25 19:14:56 2017 +0200

    sctp: fix ICMP processing if skb is non-linear
    
    sometimes ICMP replies to INIT chunks are ignored by the client, even if
    the encapsulated SCTP headers match an open socket. This happens when the
    ICMP packet is carried by a paged skb: use skb_header_pointer() to read
    packet contents beyond the SCTP header, so that chunk header and initiate
    tag are validated correctly.
    
    v2:
    - don't use skb_header_pointer() to read the transport header, since
      icmp_socket_deliver() already puts these 8 bytes in the linear area.
    - change commit message to make specific reference to INIT chunks.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f3c0eb05e258c6a48c2d1ef2fa71ffb6ff63cd18
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 18:01:43 2017 +0200

    netfilter: conntrack: fix false CRC32c mismatch using paged skb
    
    sctp_compute_cksum() implementation assumes that at least the SCTP header
    is in the linear part of skb: modify conntrack error callback to avoid
    false CRC32c mismatch, if the transport header is partially/entirely paged.
    
    Fixes: cf6e007eef83 ("netfilter: conntrack: validate SCTP crc32c in PREROUTING")
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 5d65a16a689a2973a014f2f5aa04d0e2f7b66403
Merge: 6f5b24eed027 b4759dcdcd84
Author: David S. Miller <davem@davemloft.net>
Date:   Fri May 19 19:21:32 2017 -0400

    Merge branch 'net-fix-CRC32c-in-the-forwarding-path'
    
    Davide Caratti says:
    
    ====================
    net: fix CRC32c in the forwarding path
    
    Current kernel allows offloading CRC32c computation when SCTP packets
    are generated, setting skb->ip_summed to CHECKSUM_PARTIAL, if the
    underlying device features have NETIF_F_SCTP_CRC set. However, after these
    packets are forwarded, they may land on a device where CRC32c offloading is
    not available: as a consequence, transmission is done with wrong CRC32c.
    It's not possible to use sctp_compte_cksum() in the forwarding path
    and in most drivers, because it needs symbols exported by libcrc32c module.
    
    Patch 1 and 2 of this series try to solve this problem, introducing a new
    helper function, namely skb_crc32c_csum_help(), that can be used to resolve
    CHECKSUM_PARTIAL when crc32c is needed instead of Internet Checksum.
    
    Currently, we need to parse the packet headers to understand what algorithm
    is needed to resolve CHECKSUM_PARTIAL. We can speedup things by storing
    this information in the skb metadata, and use it to call an appropriate
    helper (skb_checksum_help or skb_crc32c_csum_help), or leave the packet
    unmodified when the NIC is able to offload the checksum computation.
    
    Patch 3 deprecates skb->csum_bad to free one bit in skb metadata; patch 4
    introduces skb->csum_not_inet, providing skb with an indication on the
    algorithm needed to resolve CHECKSUM_PARTIAL.
    Patch 5 and 6 fix the kernel forwarding path and openvswitch datapath,
    where skb_checksum_help was unconditionally called to resolve CHECKSUM_PARTIAL,
    thus generating wrong CRC32c in forwarded SCTP packets.
    Finally, patch 7 updates documentation to provide a better description of
    possible values of skb->ip_summed.
    
    Some further work is still possible:
    * drivers that parse the packet header to correctly resolve CHECKSUM_PARTIAL
    (e.g. ixgbe_tx_csum()) can benefit from testing skb->csum_not_inet to avoid
    calling ip_hdr(skb)->protocol or ixgbe_ipv6_csum_is_sctp(skb).
    
    * drivers that call skb_checksum_help() to resolve CHECKSUM_PARTIAL can
    call skb_csum_hwoffload_help to avoid corrupting SCTP packets.
    
    Changes v2->v3:
    - patch 1/7: more standard declaration of stub variables
    
    Changes v1->v2:
    - none
    
    Changes RFCv4->v1:
    - patch 2/7: use WARN_ON_ONCE() instead of BUG_ON(), and avoid computing
    CRC32c on the error path.
    - patch 3/7: don't invert tests on the values of same_flow and
    NAPI_GRO_CB(skb)->flush in dev_gro_receive(), it's useless and it breaks
    GRO functionality as reported by kernel test robot.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b4759dcdcd8466e70f01ff07f33e17cd93131d34
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:43 2017 +0200

    sk_buff.h: improve description of CHECKSUM_{COMPLETE, UNNECESSARY}
    
    Add FCoE to the list of protocols that can set CHECKSUM_UNNECESSARY; add a
    note to CHECKSUM_COMPLETE section to specify that it does not apply to SCTP
    and FCoE protocols.
    
    Suggested-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7529390d08f07fbf9b0174c5a87600b5caa1a8e8
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:42 2017 +0200

    openvswitch: more accurate checksumming in queue_userspace_packet()
    
    if skb carries an SCTP packet and ip_summed is CHECKSUM_PARTIAL, it needs
    CRC32c in place of Internet Checksum: use skb_csum_hwoffload_help to avoid
    corrupting such packets while queueing them towards userspace.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 43c26a1a45938624fb9301e8bf7dfabbed293619
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:41 2017 +0200

    net: more accurate checksumming in validate_xmit_skb()
    
    skb_csum_hwoffload_help() uses netdev features and skb->csum_not_inet to
    determine if skb needs software computation of Internet Checksum or crc32c
    (or nothing, if this computation can be done by the hardware). Use it in
    place of skb_checksum_help() in validate_xmit_skb() to avoid corruption
    of non-GSO SCTP packets having skb->ip_summed equal to CHECKSUM_PARTIAL.
    
    While at it, remove references to skb_csum_off_chk* functions, since they
    are not present anymore in Linux  _ see commit cf53b1da73bd ("Revert
     "net: Add driver helper functions to determine checksum offloadability"").
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dba003067a43a9699bef0c4bdbe320ece5a109b8
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:40 2017 +0200

    net: use skb->csum_not_inet to identify packets needing crc32c
    
    skb->csum_not_inet carries the indication on which algorithm is needed to
    compute checksum on skb in the transmit path, when skb->ip_summed is equal
    to CHECKSUM_PARTIAL. If skb carries a SCTP packet and crc32c hasn't been
    yet written in L4 header, skb->csum_not_inet is assigned to 1; otherwise,
    assume Internet Checksum is needed and thus set skb->csum_not_inet to 0.
    
    Suggested-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Acked-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b72b5bf6a8fc9065f270ae135bbd47abb9d96790
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:38 2017 +0200

    net: introduce skb_crc32c_csum_help
    
    skb_crc32c_csum_help is like skb_checksum_help, but it is designed for
    checksumming SCTP packets using crc32c (see RFC3309), provided that
    libcrc32c.ko has been loaded before. In case libcrc32c is not loaded,
    invoking skb_crc32c_csum_help on a skb results in one the following
    printouts:
    
    warn_crc32c_csum_update: attempt to compute crc32c without libcrc32c.ko
    warn_crc32c_csum_combine: attempt to compute crc32c without libcrc32c.ko
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9617813dba5b6c112922c60cd2bc57c6e11ae907
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu May 18 15:44:37 2017 +0200

    skbuff: add stub to help computing crc32c on SCTP packets
    
    sctp_compute_checksum requires crc32c symbol (provided by libcrc32c), so
    it can't be used in net core. Like it has been done previously with other
    symbols (e.g. ipv6_dst_lookup), introduce a stub struct skb_checksum_ops
    to allow computation of crc32c checksum in net core after sctp.ko (and thus
    libcrc32c) has been loaded.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 667f867c93d0117dec83bc5be9018d1a3a94044d
Merge: a58a260fd96b c0e01eac7ada
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu May 18 11:40:21 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Don't allow negative TCP reordering values, from Soheil Hassas
        Yeganeh.
    
     2) Don't overflow while parsing ipv6 header options, from Craig Gallek.
    
     3) Handle more cleanly the case where an individual route entry during
        a dump will not fit into the allocated netlink SKB, from David
        Ahern.
    
     4) Add missing CONFIG_INET dependency for mlx5e, from Arnd Bergmann.
    
     5) Allow neighbour updates to converge more quickly via gratuitous
        ARPs, from Ihar Hrachyshka.
    
     6) Fix compile error from CONFIG_INET is disabled, from Eric Dumazet.
    
     7) Fix use after free in x25 protocol init, from Lin Zhang.
    
     8) Valid VLAN pvid ranges passed into br_validate(), from Tobias
        Jungel.
    
     9) NULL out address lists in child sockets in SCTP, this is similar to
        the fix we made for inet connection sockets last week. From Eric
        Dumazet.
    
    10) Fix NULL deref in mlxsw driver, from Ido Schimmel.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (27 commits)
      mlxsw: spectrum: Avoid possible NULL pointer dereference
      sh_eth: Do not print an error message for probe deferral
      sh_eth: Use platform device for printing before register_netdev()
      mlxsw: spectrum_router: Fix rif counter freeing routine
      mlxsw: spectrum_dpipe: Fix incorrect entry index
      cxgb4: update latest firmware version supported
      qmi_wwan: add another Lenovo EM74xx device ID
      sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
      udp: make *udp*_queue_rcv_skb() functions static
      bridge: netlink: check vlan_default_pvid range
      net: ethernet: faraday: To support device tree usage.
      net: x25: fix one potential use-after-free issue
      bpf: adjust verifier heuristics
      ipv6: Check ip6_find_1stfragopt() return value properly.
      selftests/bpf: fix broken build due to types.h
      bnxt_en: Check status of firmware DCBX agent before setting DCB_CAP_DCBX_HOST.
      bnxt_en: Call bnxt_dcb_init() after getting firmware DCBX configuration.
      net: fix compile error in skb_orphan_partial()
      ipv6: Prevent overrun when parsing v6 header options
      neighbour: update neigh timestamps iff update is effective
      ...

commit fdcee2cbb8438702ea1b328fb6e0ac5e9a40c7f8
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed May 17 07:16:40 2017 -0700

    sctp: do not inherit ipv6_{mc|ac|fl}_list from parent
    
    SCTP needs fixes similar to 83eaddab4378 ("ipv6/dccp: do not inherit
    ipv6_mc_list from parent"), otherwise bad things can happen.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a01aa920b8e39069bb7ab352ce45f127238f1d26
Merge: edd7f4efa811 8eeef2350453
Author: David S. Miller <davem@davemloft.net>
Date:   Mon May 1 10:46:50 2017 -0400

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS updates for net-next
    
    The following patchset contains Netfilter updates for your net-next
    tree. A large bunch of code cleanups, simplify the conntrack extension
    codebase, get rid of the fake conntrack object, speed up netns by
    selective synchronize_net() calls. More specifically, they are:
    
    1) Check for ct->status bit instead of using nfct_nat() from IPVS and
       Netfilter codebase, patch from Florian Westphal.
    
    2) Use kcalloc() wherever possible in the IPVS code, from Varsha Rao.
    
    3) Simplify FTP IPVS helper module registration path, from Arushi Singhal.
    
    4) Introduce nft_is_base_chain() helper function.
    
    5) Enforce expectation limit from userspace conntrack helper,
       from Gao Feng.
    
    6) Add nf_ct_remove_expect() helper function, from Gao Feng.
    
    7) NAT mangle helper function return boolean, from Gao Feng.
    
    8) ctnetlink_alloc_expect() should only work for conntrack with
       helpers, from Gao Feng.
    
    9) Add nfnl_msg_type() helper function to nfnetlink to build the
       netlink message type.
    
    10) Get rid of unnecessary cast on void, from simran singhal.
    
    11) Use seq_puts()/seq_putc() instead of seq_printf() where possible,
        also from simran singhal.
    
    12) Use list_prev_entry() from nf_tables, from simran signhal.
    
    13) Remove unnecessary & on pointer function in the Netfilter and IPVS
        code.
    
    14) Remove obsolete comment on set of rules per CPU in ip6_tables,
        no longer true. From Arushi Singhal.
    
    15) Remove duplicated nf_conntrack_l4proto_udplite4, from Gao Feng.
    
    16) Remove unnecessary nested rcu_read_lock() in
        __nf_nat_decode_session(). Code running from hooks are already
        guaranteed to run under RCU read side.
    
    17) Remove deadcode in nf_tables_getobj(), from Aaron Conole.
    
    18) Remove double assignment in nf_ct_l4proto_pernet_unregister_one(),
        also from Aaron.
    
    19) Get rid of unsed __ip_set_get_netlink(), from Aaron Conole.
    
    20) Don't propagate NF_DROP error to userspace via ctnetlink in
        __nf_nat_alloc_null_binding() function, from Gao Feng.
    
    21) Revisit nf_ct_deliver_cached_events() to remove unnecessary checks,
        from Gao Feng.
    
    22) Kill the fake untracked conntrack objects, use ctinfo instead to
        annotate a conntrack object is untracked, from Florian Westphal.
    
    23) Remove nf_ct_is_untracked(), now obsolete since we have no
        conntrack template anymore, from Florian.
    
    24) Add event mask support to nft_ct, also from Florian.
    
    25) Move nf_conn_help structure to
        include/net/netfilter/nf_conntrack_helper.h.
    
    26) Add a fixed 32 bytes scratchpad area for conntrack helpers.
        Thus, we don't deal with variable conntrack extensions anymore.
        Make sure userspace conntrack helper doesn't go over that size.
        Remove variable size ct extension infrastructure now this code
        got no more clients. From Florian Westphal.
    
    27) Restore offset and length of nf_ct_ext structure to 8 bytes now
        that wraparound is not possible any longer, also from Florian.
    
    28) Allow to get rid of unassured flows under stress in conntrack,
        this applies to DCCP, SCTP and TCP protocols, from Florian.
    
    29) Shrink size of nf_conntrack_ecache structure, from Florian.
    
    30) Use TCP_MAX_WSCALE instead of hardcoded 14 in TCP tracker,
        from Gao Feng.
    
    31) Register SYNPROXY hooks on demand, from Florian Westphal.
    
    32) Use pernet hook whenever possible, instead of global hook
        registration, from Florian Westphal.
    
    33) Pass hook structure to ebt_register_table() to consolidate some
        infrastructure code, from Florian Westphal.
    
    34) Use consume_skb() and return NF_STOLEN, instead of NF_DROP in the
        SYNPROXY code, to make sure device stats are not fooled, patch
        from Gao Feng.
    
    35) Remove NF_CT_EXT_F_PREALLOC this kills quite some code that we
        don't need anymore if we just select a fixed size instead of
        expensive runtime time calculation of this. From Florian.
    
    36) Constify nf_ct_extend_register() and nf_ct_extend_unregister(),
        from Florian.
    
    37) Simplify nf_ct_ext_add(), this kills nf_ct_ext_create(), from
        Florian.
    
    38) Attach NAT extension on-demand from masquerade and pptp helper
        path, from Florian.
    
    39) Get rid of useless ip_vs_set_state_timeout(), from Aaron Conole.
    
    40) Speed up netns by selective calls of synchronize_net(), from
        Florian Westphal.
    
    41) Silence stack size warning gcc in 32-bit arch in snmp helper,
        from Florian.
    
    42) Inconditionally call nf_ct_ext_destroy(), even if we have no
        extensions, to deal with the NF_NAT_MANIP_SRC case. Patch from
        Liping Zhang.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ffdfbf56e46b2968e85cc389664ee9224f3ff049
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    [ Upstream commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 ]
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d229d48d183fbc1391908decc7d2bcf09ca2f38f
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Apr 1 17:07:46 2017 +0800

    sctp: add SCTP_PR_STREAM_STATUS sockopt for prsctp
    
    Before when implementing sctp prsctp, SCTP_PR_STREAM_STATUS wasn't
    added, as it needs to save abandoned_(un)sent for every stream.
    
    After sctp stream reconf is added in sctp, assoc has structure
    sctp_stream_out to save per stream info.
    
    This patch is to add SCTP_PR_STREAM_STATUS by putting the prsctp
    per stream statistics into sctp_stream_out.
    
    v1->v2:
      fix an indent issue.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ba82427d4a0fdd92b01cb2a1c4c24990f37406a9
Merge: 6a18c3123207 584a88709bf4
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Mar 24 13:45:07 2017 -0700

    Merge branch '40GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    40GbE Intel Wired LAN Driver Updates 2017-03-23
    
    This series contains updates to i40e and i40e.txt documentation.
    
    Jake provides all the changes in the series which are centered around
    ntuple filter fixes and additional support.  Fixed the current
    implementation of .set_rxnfc, where we were not reading the mask field
    for filter entries which was resulting in filters not behaving as
    expected and not working correctly.  When cleaning up after disabling
    flow director support, ensure that the default input set is correctly
    reprogrammed.  Since the hardware only supports a single input set for
    all flows of that type, the driver shall only allow the input set to
    change if there are no other configured filters for that flow type, so
    add support to detect when we can update the input set for each flow
    type.  Align the driver to other drivers to partition the ring_cookie
    value into 8bits of VF index, along with 32bits of queue number instead
    of using the user-def field.  Added support to parse the user-def field
    into a data structure format to allow future extensions of the user-def
    filed by keeping all the code that read/writes the field into a single
    location.  Added support for flexible payloads passed via ethtool
    user-def field.  We support a single flexible word (2byte) value per
    protocol type, and we handle the FLX_PIT register using a list of
    flexible entries so that each flow type may be configured separately.
    Enabled flow director filters for SCTPv4 packets using the ethtool
    ntuple interface to enable filters.  Updated the documentation on the
    i40e driver to include the newly added support to ntuple filters.
    Reduced complexity of a if-continue-else-break section of code by
    taking advantage of using hlist_for_each_entry_continue() instead.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f223c8752a0b756b82ad8f077172054548a6d644
Author: Jacob Keller <jacob.e.keller@intel.com>
Date:   Mon Feb 6 14:38:51 2017 -0800

    i40e: add support for SCTPv4 FDir filters
    
    Enable FDir filters for SCTPv4 packets using the ethtool ntuple
    interface to enable filters. The ethtool API does not allow masking on
    the verification tag.
    
    Change-Id: I093e88a8143994c7e6f4b7b17a0bd5cf861d18e4
    Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 3bcee1e653c1c1d78485cc7a298b392675a1a56d
Author: Jacob Keller <jacob.e.keller@intel.com>
Date:   Mon Feb 6 14:38:46 2017 -0800

    i40e: restore default input set for each flow type
    
    Ensure that the default input set is correctly reprogrammed when
    cleaning up after disabling flow director support. This ensures that the
    programmed value will be in a clean state.
    
    Although we do not yet have support for SCTPv4 filters, a future patch
    will add support for this protocol, so we will correctly restore the
    SCTPv4 input set here as well. Note that strictly speaking the default
    hardware value for SCTP includes matching the verification tag. However,
    the ethtool API does not have support for specifying this value, so
    there is no reason to keep the verification field enabled.
    
    This patch is the next step on the way to enabling partial tuple filters
    which will be implemented in a following patch.
    
    Change-Id: Ic22e1c267ae37518bb036aca4a5694681449f283
    Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit f341d9f08ae01d90d8d0c135ae2edf4423e724c9
Merge: 093b995e3b55 68c386590375
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Mar 23 11:29:49 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Several netfilter fixes from Pablo and the crew:
          - Handle fragmented packets properly in netfilter conntrack, from
            Florian Westphal.
          - Fix SCTP ICMP packet handling, from Ying Xue.
          - Fix big-endian bug in nftables, from Liping Zhang.
          - Fix alignment of fake conntrack entry, from Steven Rostedt.
    
     2) Fix feature flags setting in fjes driver, from Taku Izumi.
    
     3) Openvswitch ipv6 tunnel source address not set properly, from Or
        Gerlitz.
    
     4) Fix jumbo MTU handling in amd-xgbe driver, from Thomas Lendacky.
    
     5) sk->sk_frag.page not released properly in some cases, from Eric
        Dumazet.
    
     6) Fix RTNL deadlocks in nl80211, from Johannes Berg.
    
     7) Fix erroneous RTNL lockdep splat in crypto, from Herbert Xu.
    
     8) Cure improper inflight handling during AF_UNIX GC, from Andrey
        Ulanov.
    
     9) sch_dsmark doesn't write to packet headers properly, from Eric
        Dumazet.
    
    10) Fix SCM_TIMESTAMPING_OPT_STATS handling in TCP, from Soheil Hassas
        Yeganeh.
    
    11) Add some IDs for Motorola qmi_wwan chips, from Tony Lindgren.
    
    12) Fix nametbl deadlock in tipc, from Ying Xue.
    
    13) GRO and LRO packets not counted correctly in mlx5 driver, from Gal
        Pressman.
    
    14) Fix reset of internal PHYs in bcmgenet, from Doug Berger.
    
    15) Fix hashmap allocation handling, from Alexei Starovoitov.
    
    16) nl_fib_input() needs stronger netlink message length checking, from
        Eric Dumazet.
    
    17) Fix double-free of sk->sk_filter during sock clone, from Daniel
        Borkmann.
    
    18) Fix RX checksum offloading in aquantia driver, from Pavel Belous.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (85 commits)
      net:ethernet:aquantia: Fix for RX checksum offload.
      amd-xgbe: Fix the ECC-related bit position definitions
      sfc: cleanup a condition in efx_udp_tunnel_del()
      Bluetooth: btqcomsmd: fix compile-test dependency
      inet: frag: release spinlock before calling icmp_send()
      tcp: initialize icsk_ack.lrcvtime at session start time
      genetlink: fix counting regression on ctrl_dumpfamily()
      socket, bpf: fix sk_filter use after free in sk_clone_lock
      ipv4: provide stronger user input validation in nl_fib_input()
      bpf: fix hashmap extra_elems logic
      enic: update enic maintainers
      net: bcmgenet: remove bcmgenet_internal_phy_setup()
      ipv6: make sure to initialize sockc.tsflags before first use
      fjes: Do not load fjes driver if extended socket device is not power on.
      fjes: Do not load fjes driver if system does not have extended socket device.
      net/mlx5e: Count LRO packets correctly
      net/mlx5e: Count GSO packets correctly
      net/mlx5: Increase number of max QPs in default profile
      net/mlx5e: Avoid supporting udp tunnel port ndo for VF reps
      net/mlx5e: Use the proper UAPI values when offloading TC vlan actions
      ...

commit 88997e4208aea117627898e5f6f9801cf3cd42d2
Author: Andrey Vagin <avagin@openvz.org>
Date:   Wed Mar 15 17:41:14 2017 -0700

    net/8021q: create device with all possible features in wanted_features
    
    wanted_features is a set of features which have to be enabled if a
    hardware allows that.
    
    Currently when a vlan device is created, its wanted_features is set to
    current features of its base device.
    
    The problem is that the base device can get new features and they are
    not propagated to vlan-s of this device.
    
    If we look at bonding devices, they doesn't have this problem and this
    patch suggests to fix this issue by the same way how it works for bonding
    devices.
    
    We meet this problem, when we try to create a vlan device over a bonding
    device. When a system are booting, real devices require time to be
    initialized, so bonding devices created without slaves, then vlan
    devices are created and only then ethernet devices are added to the
    bonding device. As a result we have vlan devices with disabled
    scatter-gather.
    
    * create a bonding device
      $ ip link add bond0 type bond
      $ ethtool -k bond0 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off [requested on]
            tx-scatter-gather-fraglist: off [requested on]
    
    * create a vlan device
      $ ip link add link bond0 name bond0.10 type vlan id 10
      $ ethtool -k bond0.10 | grep scatter
      scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    * Add a slave device to bond0
      $ ip link set dev eth0 master bond0
    
    And now we can see that the bond0 device has got the scatter-gather
    feature, but the bond0.10 hasn't got it.
    [root@laptop linux-task-diag]# ethtool -k bond0 | grep scatter
    scatter-gather: on
            tx-scatter-gather: on
            tx-scatter-gather-fraglist: on
    [root@laptop linux-task-diag]# ethtool -k bond0.10 | grep scatter
    scatter-gather: off
            tx-scatter-gather: off
            tx-scatter-gather-fraglist: off
    
    With this patch the vlan device will get all new features from the
    bonding device.
    
    Here is a call trace how features which are set in this patch reach
    dev->wanted_features.
    
    register_netdevice
       vlan_dev_init
            ...
            dev->hw_features = NETIF_F_HW_CSUM | NETIF_F_SG |
                           NETIF_F_FRAGLIST | NETIF_F_GSO_SOFTWARE |
                           NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
                           NETIF_F_ALL_FCOE;
    
            dev->features |= dev->hw_features;
            ...
        dev->wanted_features = dev->features & dev->hw_features;
        __netdev_update_features(dev);
            vlan_dev_fix_features
               ...
    
    Cc: Alexey Kuznetsov <kuznet@virtuozzo.com>
    Cc: Patrick McHardy <kaber@trash.net>
    Cc: "David S. Miller" <davem@davemloft.net>
    Signed-off-by: Andrei Vagin <avagin@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 400dd3d593f2e802e3adb1b0d79e4b002d2aa07a
Author: Soheil Hassas Yeganeh <soheil@google.com>
Date:   Fri Nov 4 15:36:49 2016 -0400

    sock: fix sendmmsg for partial sendmsg
    
    [ Upstream commit 3023898b7d4aac65987bd2f485cc22390aae6f78 ]
    
    Do not send the next message in sendmmsg for partial sendmsg
    invocations.
    
    sendmmsg assumes that it can continue sending the next message
    when the return value of the individual sendmsg invocations
    is positive. It results in corrupting the data for TCP,
    SCTP, and UNIX streams.
    
    For example, sendmmsg([["abcd"], ["efgh"]]) can result in a stream
    of "aefgh" if the first sendmsg invocation sends only the first
    byte while the second sendmsg goes through.
    
    Datagram sockets either send the entire datagram or fail, so
    this patch affects only sockets of type SOCK_STREAM and
    SOCK_SEQPACKET.
    
    Fixes: 228e548e6020 ("net: Add sendmmsg socket system call")
    Signed-off-by: Soheil Hassas Yeganeh <soheil@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Neal Cardwell <ncardwell@google.com>
    Acked-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16: we don't have the iov_iter API, so make
     ___sys_sendmsg() calculate and write back the remaining length]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 058627c4b45f3d3b34925cf1217c7e519967fad6
Author: Soheil Hassas Yeganeh <soheil@google.com>
Date:   Fri Nov 4 15:36:49 2016 -0400

    sock: fix sendmmsg for partial sendmsg
    
    [ Upstream commit 3023898b7d4aac65987bd2f485cc22390aae6f78 ]
    
    Do not send the next message in sendmmsg for partial sendmsg
    invocations.
    
    sendmmsg assumes that it can continue sending the next message
    when the return value of the individual sendmsg invocations
    is positive. It results in corrupting the data for TCP,
    SCTP, and UNIX streams.
    
    For example, sendmmsg([["abcd"], ["efgh"]]) can result in a stream
    of "aefgh" if the first sendmsg invocation sends only the first
    byte while the second sendmsg goes through.
    
    Datagram sockets either send the entire datagram or fail, so
    this patch affects only sockets of type SOCK_STREAM and
    SOCK_SEQPACKET.
    
    Fixes: 228e548e6020 ("net: Add sendmmsg socket system call")
    Signed-off-by: Soheil Hassas Yeganeh <soheil@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Neal Cardwell <ncardwell@google.com>
    Acked-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: we don't have the iov_iter API, so make
     ___sys_sendmsg() calculate and write back the remaining length]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit e11607aad5edf4c41617a27291731c660f7d519d
Merge: 3d20f1f7bd57 4494dbc6dec3
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 15 15:13:13 2017 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter fixes for net
    
    The following patchset contains Netfilter fixes for your net tree, a
    rather large batch of fixes targeted to nf_tables, conntrack and bridge
    netfilter. More specifically, they are:
    
    1) Don't track fragmented packets if the socket option IP_NODEFRAG is set.
       From Florian Westphal.
    
    2) SCTP protocol tracker assumes that ICMP error messages contain the
       checksum field, what results in packet drops. From Ying Xue.
    
    3) Fix inconsistent handling of AH traffic from nf_tables.
    
    4) Fix new bitmap set representation with big endian. Fix mismatches in
       nf_tables due to incorrect big endian handling too. Both patches
       from Liping Zhang.
    
    5) Bridge netfilter doesn't honor maximum fragment size field, cap to
       largest fragment seen. From Florian Westphal.
    
    6) Fake conntrack entry needs to be aligned to 8 bytes since the 3 LSB
       bits are now used to store the ctinfo. From Steven Rostedt.
    
    7) Fix element comments with the bitmap set type. Revert the flush
       field in the nft_set_iter structure, not required anymore after
       fixing up element comments.
    
    8) Missing error on invalid conntrack direction from nft_ct, also from
       Liping Zhang.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c0d8bab6ae518cedfb5246e99ece43fe51d79b56
Author: Xin Long <lucien.xin@gmail.com>
Date:   Fri Mar 10 12:11:12 2017 +0800

    sctp: add get and set sockopt for reconf_enable
    
    This patchset is to add SCTP_RECONFIG_SUPPORTED sockopt, it would
    set and get asoc reconf_enable value when asoc_id is set, or it
    would set and get ep reconf_enalbe value if asoc_id is 0.
    
    It is also to add sysctl interface for users to set the default
    value for reconf_enable.
    
    After this patch, stream reconf will work.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8e05ba7f848475bdc3aa546cf88418f7e51a6671
Author: Ying Xue <ying.xue@windriver.com>
Date:   Sat Mar 4 18:00:02 2017 +0800

    netfilter: nf_nat_sctp: fix ICMP packet to be dropped accidently
    
    Regarding RFC 792, the first 64 bits of the original SCTP datagram's
    data could be contained in ICMP packet, such as:
    
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Type      |     Code      |          Checksum             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                             unused                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |      Internet Header + 64 bits of Original Data Datagram      |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
    However, according to RFC 4960, SCTP datagram header is as below:
    
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Source Port Number        |     Destination Port Number   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                      Verification Tag                         |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |                           Checksum                            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
    It means only the first three fields of SCTP header can be carried in
    ICMP packet except for Checksum field.
    
    At present in sctp_manip_pkt(), no matter whether the packet is ICMP or
    not, it always calculates SCTP packet checksum. However, not only the
    calculation of checksum is unnecessary for ICMP, but also it causes
    another fatal issue that ICMP packet is dropped. The header size of
    SCTP is used to identify whether the writeable length of skb is bigger
    than skb->len through skb_make_writable() in sctp_manip_pkt(). But
    when it deals with ICMP packet, skb_make_writable() directly returns
    false as the writeable length of skb is bigger than skb->len.
    Subsequently ICMP is dropped.
    
    Now we correct this misbahavior. When sctp_manip_pkt() handles ICMP
    packet, 8 bytes rather than the whole SCTP header size is used to check
    if writeable length of skb is overflowed. Meanwhile, as it's meaningless
    to calculate checksum when packet is ICMP, the computation of checksum
    is ignored as well.
    
    Signed-off-by: Ying Xue <ying.xue@windriver.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit d2c2bdcdd8c5ce3d2a68aa3353ed1f340c3e500e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Feb 20 20:51:06 2014 +0100

    net: sctp: rework multihoming retransmission path selection to rfc4960
    
    commit 4c47af4d5eb2c2f78f886079a3920a7078a6f0a0 upstream.
    
    Problem statement: 1) both paths (primary path1 and alternate
    path2) are up after the association has been established i.e.,
    HB packets are normally exchanged, 2) path2 gets inactive after
    path_max_retrans * max_rto timed out (i.e. path2 is down completely),
    3) now, if a transmission times out on the only surviving/active
    path1 (any ~1sec network service impact could cause this like
    a channel bonding failover), then the retransmitted packets are
    sent over the inactive path2; this happens with partial failover
    and without it.
    
    Besides not being optimal in the above scenario, a small failure
    or timeout in the only existing path has the potential to cause
    long delays in the retransmission (depending on RTO_MAX) until
    the still active path is reselected. Further, when the T3-timeout
    occurs, we have active_patch == retrans_path, and even though the
    timeout occurred on the initial transmission of data, not a
    retransmit, we end up updating retransmit path.
    
    RFC4960, section 6.4. "Multi-Homed SCTP Endpoints" states under
    6.4.1. "Failover from an Inactive Destination Address" the
    following:
    
      Some of the transport addresses of a multi-homed SCTP endpoint
      may become inactive due to either the occurrence of certain
      error conditions (see Section 8.2) or adjustments from the
      SCTP user.
    
      When there is outbound data to send and the primary path
      becomes inactive (e.g., due to failures), or where the SCTP
      user explicitly requests to send data to an inactive
      destination transport address, before reporting an error to
      its ULP, the SCTP endpoint should try to send the data to an
      alternate __active__ destination transport address if one
      exists.
    
      When retransmitting data that timed out, if the endpoint is
      multihomed, it should consider each source-destination address
      pair in its retransmission selection policy. When retransmitting
      timed-out data, the endpoint should attempt to pick the most
      divergent source-destination pair from the original
      source-destination pair to which the packet was transmitted.
    
      Note: Rules for picking the most divergent source-destination
      pair are an implementation decision and are not specified
      within this document.
    
    So, we should first reconsider to take the current active
    retransmission transport if we cannot find an alternative
    active one. If all of that fails, we can still round robin
    through unkown, partial failover, and inactive ones in the
    hope to find something still suitable.
    
    Commit 4141ddc02a92 ("sctp: retran_path update bug fix") broke
    that behaviour by selecting the next inactive transport when
    no other active transport was found besides the current assoc's
    peer.retran_path. Before commit 4141ddc02a92, we would have
    traversed through the list until we reach our peer.retran_path
    again, and in case that is still in state SCTP_ACTIVE, we would
    take it and return. Only if that is not the case either, we
    take the next inactive transport.
    
    Besides all that, another issue is that transports in state
    SCTP_UNKNOWN could be preferred over transports in state
    SCTP_ACTIVE in case a SCTP_ACTIVE transport appears after
    SCTP_UNKNOWN in the transport list yielding a weaker transport
    state to be used in retransmission.
    
    This patch mostly reverts 4141ddc02a92, but also rewrites
    this function to introduce more clarity and strictness into
    the code. A strict priority of transport states is enforced
    in this patch, hence selection is active > unkown > partial
    failover > inactive.
    
    Fixes: 4141ddc02a92 ("sctp: retran_path update bug fix")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <yasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 1685cd22d7ebda79ea519457499f9cc4ced1e966
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 upstream.
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.16: moved code is slightly different]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ba43cdd87d0aaed69ef1bb14a91c3e767a4c210f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 upstream.
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: moved code is slightly different]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 0d4c19ee68c91f46905cbd393939d89237e6189c
Author: Pablo Neira <pablo@netfilter.org>
Date:   Thu Jan 26 22:56:21 2017 +0100

    tcp: don't annotate mark on control socket from tcp_v6_send_response()
    
    commit 92e55f412cffd016cc245a74278cb4d7b89bb3bc upstream.
    
    Unlike ipv4, this control socket is shared by all cpus so we cannot use
    it as scratchpad area to annotate the mark that we pass to ip6_xmit().
    
    Add a new parameter to ip6_xmit() to indicate the mark. The SCTP socket
    family caches the flowi6 structure in the sctp_transport structure, so
    we cannot use to carry the mark unless we later on reset it back, which
    I discarded since it looks ugly to me.
    
    Fixes: bf99b4ded5f8 ("tcp: fix mark propagation with fwmark_reflect enabled")
    Suggested-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0058a4c1b6209f86a29c4ecbca7e3ed55544d3b0
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 upstream.
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 242bd2d519d7194633e309286ba7ba29a1ad63e8
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Feb 9 01:18:20 2017 +0800

    sctp: implement sender-side procedures for Add Incoming/Outgoing Streams Request Parameter
    
    This patch is to implement Sender-Side Procedures for the Add
    Outgoing and Incoming Streams Request Parameter described in
    rfc6525 section 5.1.5-5.1.6.
    
    It is also to add sockopt SCTP_ADD_STREAMS in rfc6525 section
    6.3.4 for users.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a92ce1a42dde1caaee4afae67531e3e7acecf6e4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Feb 9 01:18:18 2017 +0800

    sctp: implement sender-side procedures for SSN/TSN Reset Request Parameter
    
    This patch is to implement Sender-Side Procedures for the SSN/TSN
    Reset Request Parameter descibed in rfc6525 section 5.1.4.
    
    It is also to add sockopt SCTP_RESET_ASSOC in rfc6525 section 6.3.3
    for users.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9faf1c0fd5a943e498dbc0c86ff42e965b347d08
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Feb 9 01:18:15 2017 +0800

    sctp: drop unnecessary __packed from some stream reconf structures
    
    commit 85c727b59483 ("sctp: drop __packed from almost all SCTP structures")
    has removed __packed from almost all SCTP structures. But there still are
    three structures where it should be dropped.
    
    This patch is to remove it from some stream reconf structures.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 472ff5be61f9593ee2d3ebbd716768e14de4659d
Merge: d3498fbaf386 5aff1d245e8c
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Feb 8 10:01:39 2017 -0800

    Merge tag 'fixes-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC fixes from Arnd Bergmann:
    
     - A relatively large patch restores booting on i.MX platforms that
       failed to boot after a cleanup was merged for v4.10.
    
     - A quirk for USB needs to be enabled on the STi platform
    
     - On the Meson platform, we saw memory corruption with part of the
       memory used by the secure monitor, so we have to stay out of that
       area.
    
     - The same platform also has a problem with ethernet under load, which
       is fixed by disabling EEE negotiation.
    
     - imx6dl has an incorrect pin configuration, which prevents SPI from
       working.
    
     - Two maintainers have lost their access to their email addresses, so
       we should update the MAINTAINERS file before the release
    
     - Renaming one of the orion5x linkstation models to help simplify the
       debian install.
    
     - A couple of fixes for build warnings that were introduced during
       v4.10-rc.
    
    * tag 'fixes-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc:
      ARM: defconfigs: make NF_CT_PROTO_SCTP and NF_CT_PROTO_UDPLITE built-in
      MAINTAINERS: socfpga: update email for Dinh Nguyen
      ARM: orion5x: fix Makefile for linkstation-lschl.dtb
      ARM: dts: orion5x-lschl: More consistent naming on linkstation series
      ARM: dts: orion5x-lschl: Fix model name
      MAINTAINERS: change email address from atmel to microchip
      MAINTAINERS: at91: change email address
      ARM64: dts: meson-gx: Add firmware reserved memory zones
      ARM64: dts: meson-gxbb-odroidc2: fix GbE tx link breakage
      ARM: dts: STiH407-family: set snps,dis_u3_susphy_quirk
      ARM: dts: imx: Pass 'chosen' and 'memory' nodes
      ARM: dts: imx6dl: fix GPIO4 range
      ARM: imx: hide unused variable in #ifdef

commit 85c727b5948344c8d559e2fda8925e9ddd41c29a
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Feb 7 11:37:56 2017 -0200

    sctp: drop __packed from almost all SCTP structures
    
    __packed is considered harmful as it potentially generates code that
    doesn't perform well and its usage should be avoided as much as
    possible.
    
    This patch drops __packed from all SCTP structures except one, which is
    sctp_signed_cookie. In there it's required, as per changelog on
    commit 9834a2bb4970 ("[SCTP]: Fix sctp_cookie alignment in the packet.").
    
    After this patch, no alignment changes neither in x86 or x86_64 and
    no exceptions were noticed during testing on both archs.
    
    Code size for SCTP module also didn't change with this patch.
    
    Cc: David Miller <davem@davemloft.net>
    Cc: David Laight <David.Laight@ACULAB.COM>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 29ba6e7400a317725bdfb86a725d1824447dbcd7
Merge: b08d46b01e99 51ce8bd4d17a
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Feb 7 13:07:56 2017 -0500

    Merge branch 'replace-dst_confirm'
    
    Julian Anastasov says:
    
    ====================
    net: dst_confirm replacement
    
            This patchset addresses the problem of neighbour
    confirmation where received replies from one nexthop
    can cause confirmation of different nexthop when using
    the same dst. Thanks to YueHaibing <yuehaibing@huawei.com>
    for tracking the dst->pending_confirm problem.
    
            Sockets can obtain cached output route. Such
    routes can be to known nexthop (rt_gateway=IP) or to be
    used simultaneously for different nexthop IPs by different
    subnet prefixes (nh->nh_scope = RT_SCOPE_HOST, rt_gateway=0).
    
            At first look, there are more problems:
    
    - dst_confirm() sets flag on dst and not on dst->path,
    as result, indication is lost when XFRM is used
    
    - DNAT can change the nexthop, so the really used nexthop is
    not confirmed
    
            So, the following solution is to avoid using
    dst->pending_confirm.
    
            The current dst_confirm() usage is as follows:
    
    Protocols confirming dst on received packets:
    - TCP (1 dst per socket)
    - SCTP (1 dst per transport)
    - CXGB*
    
    Protocols supporting sendmsg with MSG_CONFIRM [ | MSG_PROBE ] to
    confirm neighbour:
    - UDP IPv4/IPv6
    - ICMPv4 PING
    - RAW IPv4/IPv6
    - L2TP/IPv6
    
    MSG_CONFIRM for other purposes (fix not needed):
    - CAN
    
    Sending without locking the socket:
    - UDP (when no cork)
    - RAW (when hdrincl=1)
    
    Redirects from old to new GW:
    - rt6_do_redirect
    
            The patchset includes the following changes:
    
    1. sock: add sk_dst_pending_confirm flag
    
    - used only by TCP with patch 4 to remember the received
    indication in sk->sk_dst_pending_confirm
    
    2. net: add dst_pending_confirm flag to skbuff
    
    - skb->dst_pending_confirm will be used by all protocols
    in following patches, via skb_{set,get}_dst_pending_confirm
    
    3. sctp: add dst_pending_confirm flag
    
    - SCTP uses per-transport dsts and can not use
    sk->sk_dst_pending_confirm like TCP
    
    4. tcp: replace dst_confirm with sk_dst_confirm
    
    5. net: add confirm_neigh method to dst_ops
    
    - IPv4 and IPv6 provision for slow neigh lookups for MSG_PROBE users.
    I decided to use neigh lookup only for this case because on
    MSG_PROBE the skb may pass MTU checks but it does not reach
    the neigh confirmation code. This patch will be used from patch 6.
    
    - xfrm_confirm_neigh: we use the last tunnel address, if present.
    When there are only transports, the original dest address is used.
    
    6. net: use dst_confirm_neigh for UDP, RAW, ICMP, L2TP
    
    - dst_confirm conversion for UDP, RAW, ICMP and L2TP/IPv6
    
    - these protocols use MSG_CONFIRM propagated by ip*_append_data
    to skb->dst_pending_confirm. sk->sk_dst_pending_confirm is not
    used because some sending paths do not lock the socket. For
    MSG_PROBE we use the slow lookup (dst_confirm_neigh).
    
    - there are also 2 cases that need the slow lookup:
    __ip6_rt_update_pmtu and rt6_do_redirect. I hope
    &ipv6_hdr(skb)->saddr is the correct nexthop address to use here.
    
    7. net: pending_confirm is not used anymore
    
    - I failed to understand the CXGB* code, I see dst_confirm()
    calls but I'm not sure dst_neigh_output() was called. For now
    I just removed the dst->pending_confirm flag and left all
    dst_confirm() calls there. Any better idea?
    
    - Now may be old function neigh_output() should be restored
    instead of dst_neigh_output?
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5aff1d245e8cc1ab5c4517d916edaed9e3f7f973
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Fri Feb 3 09:58:24 2017 +0100

    ARM: defconfigs: make NF_CT_PROTO_SCTP and NF_CT_PROTO_UDPLITE built-in
    
    The symbols can no longer be used as loadable modules, leading to a harmless Kconfig
    warning:
    
    arch/arm/configs/imote2_defconfig:60:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/imote2_defconfig:59:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    arch/arm/configs/ezx_defconfig:68:warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    arch/arm/configs/ezx_defconfig:67:warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
    
    Let's make them built-in.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>

commit 52e01b84a244473074fc0612c169e2e043d58b01
Merge: e60df62492ef 2851940ffee3
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Feb 3 16:58:20 2017 -0500

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter updates for net-next
    
    The following patchset contains Netfilter updates for your net-next
    tree, they are:
    
    1) Stash ctinfo 3-bit field into pointer to nf_conntrack object from
       sk_buff so we only access one single cacheline in the conntrack
       hotpath. Patchset from Florian Westphal.
    
    2) Don't leak pointer to internal structures when exporting x_tables
       ruleset back to userspace, from Willem DeBruijn. This includes new
       helper functions to copy data to userspace such as xt_data_to_user()
       as well as conversions of our ip_tables, ip6_tables and arp_tables
       clients to use it. Not surprinsingly, ebtables requires an ad-hoc
       update. There is also a new field in x_tables extensions to indicate
       the amount of bytes that we copy to userspace.
    
    3) Add nf_log_all_netns sysctl: This new knob allows you to enable
       logging via nf_log infrastructure for all existing netnamespaces.
       Given the effort to provide pernet syslog has been discontinued,
       let's provide a way to restore logging using netfilter kernel logging
       facilities in trusted environments. Patch from Michal Kubecek.
    
    4) Validate SCTP checksum from conntrack helper, from Davide Caratti.
    
    5) Merge UDPlite conntrack and NAT helpers into UDP, this was mostly
       a copy&paste from the original helper, from Florian Westphal.
    
    6) Reset netfilter state when duplicating packets, also from Florian.
    
    7) Remove unnecessary check for broadcast in IPv6 in pkttype match and
       nft_meta, from Liping Zhang.
    
    8) Add missing code to deal with loopback packets from nft_meta when
       used by the netdev family, also from Liping.
    
    9) Several cleanups on nf_tables, one to remove unnecessary check from
       the netlink control plane path to add table, set and stateful objects
       and code consolidation when unregister chain hooks, from Gao Feng.
    
    10) Fix harmless reference counter underflow in IPVS that, however,
        results in problems with the introduction of the new refcount_t
        type, from David Windsor.
    
    11) Enable LIBCRC32C from nf_ct_sctp instead of nf_nat_sctp,
        from Davide Caratti.
    
    12) Missing documentation on nf_tables uapi header, from Liping Zhang.
    
    13) Use rb_entry() helper in xt_connlimit, from Geliang Tang.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 92e55f412cffd016cc245a74278cb4d7b89bb3bc
Author: Pablo Neira <pablo@netfilter.org>
Date:   Thu Jan 26 22:56:21 2017 +0100

    tcp: don't annotate mark on control socket from tcp_v6_send_response()
    
    Unlike ipv4, this control socket is shared by all cpus so we cannot use
    it as scratchpad area to annotate the mark that we pass to ip6_xmit().
    
    Add a new parameter to ip6_xmit() to indicate the mark. The SCTP socket
    family caches the flowi6 structure in the sctp_transport structure, so
    we cannot use to carry the mark unless we later on reset it back, which
    I discarded since it looks ugly to me.
    
    Fixes: bf99b4ded5f8 ("tcp: fix mark propagation with fwmark_reflect enabled")
    Suggested-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 146408693945a68f227175c1cea3772fc0f98f20
Author: Colin Ian King <colin.king@canonical.com>
Date:   Tue Jan 24 09:25:54 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    Table sctp_timer_tbl is missing a TIMEOUT_RECONF string so
    add this in. Also compare timeout with the size of the array
    sctp_timer_tbl rather than SCTP_EVENT_TIMEOUT_MAX.  Also add
    a build time check that SCTP_EVENT_TIMEOUT_MAX is correct
    so we don't ever get this kind of mismatch between the table
    and SCTP_EVENT_TIMEOUT_MAX in the future.
    
    Kudos to Marcelo Ricardo Leitner for spotting the missing string
    and suggesting the build time sanity check.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Fixes: 7b9438de0cd4 ("sctp: add stream reconf timer")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0e73fc9a56f22f2eec4d2b2910c649f7af67b74d
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Jan 20 13:01:57 2017 +0000

    net: sctp: fix array overrun read on sctp_timer_tbl
    
    The comparison on the timeout can lead to an array overrun
    read on sctp_timer_tbl because of an off-by-one error. Fix
    this by using < instead of <= and also compare to the array
    size rather than SCTP_EVENT_TIMEOUT_MAX.
    
    Fixes CoverityScan CID#1397639 ("Out-of-bounds read")
    
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7f9d68ac944e24ee5f9ac8d059ca00b1c1d34137
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Jan 18 00:44:47 2017 +0800

    sctp: implement sender-side procedures for SSN Reset Request Parameter
    
    This patch is to implement sender-side procedures for the Outgoing
    and Incoming SSN Reset Request Parameter described in rfc6525 section
    5.1.2 and 5.1.3.
    
    It is also add sockopt SCTP_RESET_STREAMS in rfc6525 section 6.3.2
    for users.
    
    Note that the new asoc member strreset_outstanding is to make sure
    only one reconf request chunk on the fly as rfc6525 section 5.1.1
    demands.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9fb657aec0e20b4ed4401c44a4140f8d7b7a9ca0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Jan 18 00:44:46 2017 +0800

    sctp: add sockopt SCTP_ENABLE_STREAM_RESET
    
    This patch is to add sockopt SCTP_ENABLE_STREAM_RESET to get/set
    strreset_enable to indicate which reconf request type it supports,
    which is described in rfc6525 section 6.3.1.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7a090b04522b46a219c271d4cd2abbf572623e03
Author: Xin Long <lucien.xin@gmail.com>
Date:   Wed Jan 18 00:44:44 2017 +0800

    sctp: add stream reconf primitive
    
    This patch is to add a primitive based on sctp primitive frame for
    sending stream reconf request. It works as the other primitives,
    and create a SCTP_CMD_REPLY command to send the request chunk out.
    
    sctp_primitive_RECONF would be the api to send a reconf request
    chunk.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 512656008a458a750bf4a55ec99e2621f47a9b06
Merge: 07e0e0467eb0 c008b33f3ef0
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jan 9 14:36:58 2017 -0500

    Merge branch 'act_csum-sctp'
    
    Davide Caratti says:
    
    ====================
    net/sched: act_csum: add support for SCTP checksum
    
    This series extends current act_csum functionality to allow computation of
    SCTP checksums. Patch 1 ensures LIBCRC32C will be selected if NET_ACT_CSUM
    is selected. Patch 2 extends act_csum to handle IPPROTO_SCTP protocol in
    IPv4/IPv6 header, and eventually compute the CRC32c value.
    
    v2:
    - style fix in tc_csum.h
    - avoid nested if statement in act_csum.c
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c008b33f3ef0915dfb57432dba1fa0ce34fdcc29
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Jan 9 11:24:21 2017 +0100

    net/sched: act_csum: compute crc32c on SCTP packets
    
    modify act_csum to compute crc32c on IPv4/IPv6 packets having SCTP in
    their payload, and extend UAPI definitions accordingly.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ab9d226e3e2a8aeca426701b735194bc35179c2d
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Jan 9 11:24:20 2017 +0100

    net/sched: Kconfig: select LIBCRC32C if NET_ACT_CSUM is selected
    
    LIBCRC32C is needed to compute crc32c on SCTP packets.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit da69a5306ab92e07224da54aafee8b1dccf024f6
Author: Stephen Smalley <sds@tycho.nsa.gov>
Date:   Mon Jan 9 10:07:30 2017 -0500

    selinux: support distinctions among all network address families
    
    Extend SELinux to support distinctions among all network address families
    implemented by the kernel by defining new socket security classes
    and mapping to them. Otherwise, many sockets are mapped to the generic
    socket class and are indistinguishable in policy.  This has come up
    previously with regard to selectively allowing access to bluetooth sockets,
    and more recently with regard to selectively allowing access to AF_ALG
    sockets.  Guido Trentalancia submitted a patch that took a similar approach
    to add only support for distinguishing AF_ALG sockets, but this generalizes
    his approach to handle all address families implemented by the kernel.
    Socket security classes are also added for ICMP and SCTP sockets.
    Socket security classes were not defined for AF_* values that are reserved
    but unimplemented in the kernel, e.g. AF_NETBEUI, AF_SECURITY, AF_ASH,
    AF_ECONET, AF_SNA, AF_WANPIPE.
    
    Backward compatibility is provided by only enabling the finer-grained
    socket classes if a new policy capability is set in the policy; older
    policies will behave as before.  The legacy redhat1 policy capability
    that was only ever used in testing within Fedora for ptrace_child
    is reclaimed for this purpose; as far as I can tell, this policy
    capability is not enabled in any supported distro policy.
    
    Add a pair of conditional compilation guards to detect when new AF_* values
    are added so that we can update SELinux accordingly rather than having to
    belatedly update it long after new address families are introduced.
    
    Signed-off-by: Stephen Smalley <sds@tycho.nsa.gov>
    Signed-off-by: Paul Moore <paul@paul-moore.com>

commit cf6e007eef83476c5d541453d84e08b07befe124
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Jan 2 13:29:41 2017 +0100

    netfilter: conntrack: validate SCTP crc32c in PREROUTING
    
    implement sctp_error to let nf_conntrack_in validate crc32c on the packet
    transport header. Assign skb->ip_summed to CHECKSUM_UNNECESSARY and return
    NF_ACCEPT in case of successful validation; otherwise, return -NF_ACCEPT to
    let netfilter skip connection tracking, like other protocols do.
    
    Besides preventing corrupted packets from matching conntrack entries, this
    fixes functionality of REJECT target: it was not generating any ICMP upon
    reception of SCTP packets, because it was computing RFC 1624 checksum on
    the packet and systematically mismatching crc32c in the SCTP header.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 300ae149468f440a2629fa8b33d0ce1e860d479f
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Jan 2 13:29:40 2017 +0100

    netfilter: select LIBCRC32C together with SCTP conntrack
    
    nf_conntrack needs to compute crc32c when dealing with SCTP packets.
    Moreover, NF_NAT_PROTO_SCTP (currently selecting LIBCRC32C) can be enabled
    only if conntrack support for SCTP is enabled. Therefore, move enabling of
    kernel support for crc32c so that it is selected when NF_CT_PROTO_SCTP=y.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 3ef01c968fbfb21c2f16281445d30a865ee4412c
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Thu Dec 29 14:41:05 2016 +0200

    ARM: s3c2410_defconfig: Fix invalid values for NF_CT_PROTO_*
    
    NF_CT_PROTO_DCCP/SCTP/UDPLITE were switched from tristate to boolean so
    defconfig needs to be adjusted to silence warnings:
            warning: symbol value 'm' invalid for NF_CT_PROTO_DCCP
            warning: symbol value 'm' invalid for NF_CT_PROTO_SCTP
            warning: symbol value 'm' invalid for NF_CT_PROTO_UDPLITE
    
    Signed-off-by: Krzysztof Kozlowski <krzk@kernel.org>

commit c4907c6ebb184f5038e6227d9a3e23076ee5db63
Merge: 8f18e4d03ed8 509e7a311f04
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Dec 28 14:06:32 2016 -0500

    Merge branch 'sctp-cleanups'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    SCTP cleanups
    
    Some cleanups/simplifications I've been collecting.
    Resending now with net-next open.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1636098c46ac52c7fec384fe629144e8e03487b1
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 23 14:29:37 2016 -0200

    sctp: fix recovering from 0 win with small data chunks
    
    Currently if SCTP closes the receive window with window pressure, mostly
    caused by excessive skb overhead on payload/overheads ratio, SCTP will
    close the window abruptly while saving the delta on rwnd_press. It will
    start recovering rwnd as the chunks are consumed by the application and
    the rwnd_press will be only recovered after rwnd reach the same value as
    of rwnd_press, mostly to prevent silly window syndrome.
    
    Thing is, this is very inefficient with small data chunks, as with those
    it will never reach back that value, and thus it will never recover from
    such pressure. This means that we will not issue window updates when
    recovering from 0 window and will rely on a sender retransmit to notice
    it.
    
    The fix here is to remove such threshold, as no value is good enough: it
    depends on the (avg) chunk sizes being used.
    
    Test with netperf -t SCTP_STREAM -- -m 1, and trigger 0 window by
    sending SIGSTOP to netserver, sleep 1.2, and SIGCONT.
    Rate limited to 845kbps, for visibility. Capture done at netserver side.
    
    Previously:
    01.500751 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632372996] [a_rwnd 99153] [
    01.500752 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632372997] [SID: 0] [SS
    01.517471 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373010] [SID: 0] [SS
    01.517483 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373009] [a_rwnd 0] [#gap
    01.517485 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373083] [SID: 0] [SS
    01.517488 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373009] [a_rwnd 0] [#gap
    01.534168 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373096] [SID: 0] [SS
    01.534180 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373009] [a_rwnd 0] [#gap
    01.534181 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373169] [SID: 0] [SS
    01.534185 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373009] [a_rwnd 0] [#gap
    02.525978 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373010] [SID: 0] [SS
    02.526021 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373009] [a_rwnd 0] [#gap
      (window update missed)
    04.573807 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373010] [SID: 0] [SS
    04.779370 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373082] [a_rwnd 859] [#g
    04.789162 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373083] [SID: 0] [SS
    04.789323 IP A.36925 > B.48277: sctp (1) [DATA] (B)(E) [TSN: 632373156] [SID: 0] [SS
    04.789372 IP B.48277 > A.36925: sctp (1) [SACK] [cum ack 632373228] [a_rwnd 786] [#g
    
    After:
    02.568957 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098728] [a_rwnd 99153]
    02.568961 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098729] [SID: 0] [S
    02.585631 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098742] [SID: 0] [S
    02.585666 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 0] [#ga
    02.585671 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098815] [SID: 0] [S
    02.585683 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 0] [#ga
    02.602330 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098828] [SID: 0] [S
    02.602359 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 0] [#ga
    02.602363 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098901] [SID: 0] [S
    02.602372 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 0] [#ga
    03.600788 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098742] [SID: 0] [S
    03.600830 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 0] [#ga
    03.619455 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 13508]
    03.619479 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 27017]
    03.619497 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 40526]
    03.619516 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 54035]
    03.619533 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 67544]
    03.619552 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 81053]
    03.619570 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098741] [a_rwnd 94562]
      (following data transmission triggered by window updates above)
    03.633504 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098742] [SID: 0] [S
    03.836445 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098814] [a_rwnd 100000]
    03.843125 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098815] [SID: 0] [S
    03.843285 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098888] [SID: 0] [S
    03.843345 IP B.50536 > A.55173: sctp (1) [SACK] [cum ack 2490098960] [a_rwnd 99894]
    03.856546 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490098961] [SID: 0] [S
    03.866450 IP A.55173 > B.50536: sctp (1) [DATA] (B)(E) [TSN: 2490099011] [SID: 0] [S
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 58b94d88deb9ac913740e7778f2005f3ce6d0443
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 23 14:29:02 2016 -0200

    sctp: do not loose window information if in rwnd_over
    
    It's possible that we receive a packet that is larger than current
    window. If it's the first packet in this way, it will cause it to
    increase rwnd_over. Then, if we receive another data chunk (specially as
    SCTP allows you to have one data chunk in flight even during 0 window),
    rwnd_over will be overwritten instead of added to.
    
    In the long run, this could cause the window to grow bigger than its
    initial size, as rwnd_over would be charged only for the last received
    data chunk while the code will try open the window for all packets that
    were received and had its value in rwnd_over overwritten. This, then,
    can lead to the worsening of payload/buffer ratio and cause rwnd_press
    to kick in more often.
    
    The fix is to sum it too, same as is done for rwnd_press, so that if we
    receive 3 chunks after closing the window, we still have to release that
    same amount before re-opening it.
    
    Log snippet from sctp_test exhibiting the issue:
    [  146.209232] sctp: sctp_assoc_rwnd_decrease: asoc:ffff88013928e000
    rwnd decreased by 1 to (0, 1, 114221)
    [  146.209232] sctp: sctp_assoc_rwnd_decrease:
    association:ffff88013928e000 has asoc->rwnd:0, asoc->rwnd_over:1!
    [  146.209232] sctp: sctp_assoc_rwnd_decrease: asoc:ffff88013928e000
    rwnd decreased by 1 to (0, 1, 114221)
    [  146.209232] sctp: sctp_assoc_rwnd_decrease:
    association:ffff88013928e000 has asoc->rwnd:0, asoc->rwnd_over:1!
    [  146.209232] sctp: sctp_assoc_rwnd_decrease: asoc:ffff88013928e000
    rwnd decreased by 1 to (0, 1, 114221)
    [  146.209232] sctp: sctp_assoc_rwnd_decrease:
    association:ffff88013928e000 has asoc->rwnd:0, asoc->rwnd_over:1!
    [  146.209232] sctp: sctp_assoc_rwnd_decrease: asoc:ffff88013928e000
    rwnd decreased by 1 to (0, 1, 114221)
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ba6d973f78eb62ffebb32f6ef3334fc9a3b33d22
Merge: 3eb86259eca6 a763f78cea84
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Dec 20 15:48:34 2016 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes and cleanups from David Miller:
    
     1) Use rb_entry() instead of hardcoded container_of(), from Geliang
        Tang.
    
     2) Use correct memory barriers in stammac driver, from Pavel Machek.
    
     3) Fix assoc bind address handling in SCTP, from Xin Long.
    
     4) Make the length check for UFO handling consistent between
        __ip_append_data() and ip_finish_output(), from Zheng Li.
    
     5) HSI driver compatible strings were busted fro hix5hd2, from Dongpo
        Li.
    
     6) Handle devm_ioremap() errors properly in cavium driver, from Arvind
        Yadav.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (22 commits)
      RDS: use rb_entry()
      net_sched: sch_netem: use rb_entry()
      net_sched: sch_fq: use rb_entry()
      net/mlx5: use rb_entry()
      ethernet: sfc: Add Kconfig entry for vendor Solarflare
      sctp: not copying duplicate addrs to the assoc's bind address list
      sctp: reduce indent level in sctp_copy_local_addr_list
      ARM: dts: hix5hd2: don't change the existing compatible string
      net: hix5hd2_gmac: fix compatible strings name
      openvswitch: Add a missing break statement.
      net: netcp: ethss: fix 10gbe host port tx pri map configuration
      net: netcp: ethss: fix errors in ethtool ops
      fsl/fman: enable compilation on ARM64
      fsl/fman: A007273 only applies to PPC SoCs
      powerpc: fsl/fman: remove fsl,fman from of_device_ids[]
      fsl/fman: fix 1G support for QSGMII interfaces
      dt: bindings: net: use boolean dt properties for eee broken modes
      net: phy: use boolean dt properties for eee broken modes
      net: phy: fix sign type error in genphy_config_eee_advert
      ipv4: Should use consistent conditional judgement for ip fragment in __ip_append_data and ip_finish_output
      ...

commit 5fccd64aa44829f87997e3342698ef98862adffd
Merge: 63c36c40b9b0 73c25fb13933
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Dec 7 19:16:46 2016 -0500

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter/IPVS updates for net-next
    
    The following patchset contains a large Netfilter update for net-next,
    to summarise:
    
    1) Add support for stateful objects. This series provides a nf_tables
       native alternative to the extended accounting infrastructure for
       nf_tables. Two initial stateful objects are supported: counters and
       quotas. Objects are identified by a user-defined name, you can fetch
       and reset them anytime. You can also use a maps to allow fast lookups
       using any arbitrary key combination. More info at:
    
       http://marc.info/?l=netfilter-devel&m=148029128323837&w=2
    
    2) On-demand registration of nf_conntrack and defrag hooks per netns.
       Register nf_conntrack hooks if we have a stateful ruleset, ie.
       state-based filtering or NAT. The new nf_conntrack_default_on sysctl
       enables this from newly created netnamespaces. Default behaviour is not
       modified. Patches from Florian Westphal.
    
    3) Allocate 4k chunks and then use these for x_tables counter allocation
       requests, this improves ruleset load time and also datapath ruleset
       evaluation, patches from Florian Westphal.
    
    4) Add support for ebpf to the existing x_tables bpf extension.
       From Willem de Bruijn.
    
    5) Update layer 4 checksum if any of the pseudoheader fields is updated.
       This provides a limited form of 1:1 stateless NAT that make sense in
       specific scenario, eg. load balancing.
    
    6) Add support to flush sets in nf_tables. This series comes with a new
       set->ops->deactivate_one() indirection given that we have to walk
       over the list of set elements, then deactivate them one by one.
       The existing set->ops->deactivate() performs an element lookup that
       we don't need.
    
    7) Two patches to avoid cloning packets, thus speed up packet forwarding
       via nft_fwd from ingress. From Florian Westphal.
    
    8) Two IPVS patches via Simon Horman: Decrement ttl in all modes to
       prevent infinite loops, patch from Dwip Banerjee. And one minor
       refactoring from Gao feng.
    
    9) Revisit recent log support for nf_tables netdev families: One patch
       to ensure that we correctly handle non-ethernet packets. Another
       patch to add missing logger definition for netdev. Patches from
       Liping Zhang.
    
    10) Three patches for nft_fib, one to address insufficient register
        initialization and another to solve incorrect (although harmless)
        byteswap operation. Moreover update xt_rpfilter and nft_fib to match
        lbcast packets with zeronet as source, eg. DHCP Discover packets
        (0.0.0.0 -> 255.255.255.255). Also from Liping Zhang.
    
    11) Built-in DCCP, SCTP and UDPlite conntrack and NAT support, from
        Davide Caratti. While DCCP is rather hopeless lately, and UDPlite has
        been broken in many-cast mode for some little time, let's give them a
        chance by placing them at the same level as other existing protocols.
        Thus, users don't explicitly have to modprobe support for this and
        NAT rules work for them. Some people point to the lack of support in
        SOHO Linux-based routers that make deployment of new protocols harder.
        I guess other middleboxes outthere on the Internet are also to blame.
        Anyway, let's see if this has any impact in the midrun.
    
    12) Skip software SCTP software checksum calculation if the NIC comes
        with SCTP checksum offload support. From Davide Caratti.
    
    13) Initial core factoring to prepare conversion to hook array. Three
        patches from Aaron Conole.
    
    14) Gao Feng made a wrong conversion to switch in the xt_multiport
        extension in a patch coming in the previous batch. Fix it in this
        batch.
    
    15) Get vmalloc call in sync with kmalloc flags to avoid a warning
        and likely OOM killer intervention from x_tables. From Marcelo
        Ricardo Leitner.
    
    16) Update Arturo Borrero's email address in all source code headers.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3189a290f98d3d3b76536ab61e9ff95751ed8124
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Dec 5 15:33:57 2016 +0100

    netfilter: nat: skip checksum on offload SCTP packets
    
    SCTP GSO and hardware can do CRC32c computation after netfilter processing,
    so we can avoid calling sctp_compute_checksum() on skb if skb->ip_summed
    is equal to CHECKSUM_PARTIAL. Moreover, set skb->ip_summed to CHECKSUM_NONE
    when the NAT code computes the CRC, to prevent offloaders from computing
    it again (on ixgbe this resulted in a transmission with wrong L4 checksum).
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 862b3d2090ae3d8b10bb4ee9275fd932bc4d0d44
Author: Salil <salil.mehta@huawei.com>
Date:   Tue Dec 6 11:09:46 2016 +0000

    net: hns: Fix to conditionally convey RX checksum flag to stack
    
    This patch introduces the RX checksum function to check the
    status of the hardware calculated checksum and its error and
    appropriately convey status to the upper stack in skb->ip_summed
    field.
    
    In hardware, we only support checksum for the following
    protocols:
    1) IPv4,
    2) TCP(over IPv4 or IPv6),
    3) UDP(over IPv4 or IPv6),
    4) SCTP(over IPv4 or IPv6)
    but we support many L3(IPv4, IPv6, MPLS, PPPoE etc) and
    L4(TCP, UDP, GRE, SCTP, IGMP, ICMP etc.) protocols.
    
    Hardware limitation:
    Our present hardware RX Descriptor lacks L3/L4 checksum
    "Status & Error" bit (which usually can be used to indicate whether
    checksum was calculated by the hardware and if there was any error
    encountered during checksum calculation).
    
    Software workaround:
    We do get info within the RX descriptor about the kind of
    L3/L4 protocol coming in the packet and the error status. These
    errors might not just be checksum errors but could be related to
    version, length of IPv4, UDP, TCP etc.
    Because there is no-way of knowing if it is a L3/L4 error due
    to bad checksum or any other L3/L4 error, we will not (cannot)
    convey hardware checksum status(CHECKSUM_UNNECESSARY) for such
    cases to upper stack and will not maintain the RX L3/L4 checksum
    counters as well.
    
    Signed-off-by: Salil Mehta <salil.mehta@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a85406afeb3e045b001b2aac5b4f89f4266fede3
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Tue Nov 15 15:08:26 2016 +0100

    netfilter: conntrack: built-in support for SCTP
    
    CONFIG_NF_CT_PROTO_SCTP is no more a tristate. When set to y, connection
    tracking support for SCTP protocol is built-in into nf_conntrack.ko.
    
    footprint test:
    $ ls -l net/netfilter/nf_conntrack{_proto_sctp,}.ko \
            net/ipv4/netfilter/nf_conntrack_ipv4.ko \
            net/ipv6/netfilter/nf_conntrack_ipv6.ko
    
    (builtin)||  sctp  |  ipv4  |  ipv6  | nf_conntrack
    ---------++--------+--------+--------+--------------
    none     || 498243 | 828755 | 828676 | 6141434
    SCTP     ||   -    | 829254 | 829175 | 6547872
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 7a2dd28c703408ef27d6fe6a4fcd7c58968ce3bf
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Thu Oct 20 18:33:02 2016 +0200

    netfilter: built-in NAT support for SCTP
    
    CONFIG_NF_NAT_PROTO_SCTP is no more a tristate. When set to y, NAT
    support for SCTP protocol is built-in into nf_nat.ko.
    
    footprint test:
    
    (nf_nat_proto_)           | sctp   || nf_nat
    --------------------------+--------++--------
    no builtin                | 428344 || 2241312
    SCTP builtin              |   -    || 2597032
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit fb77271c550e1414597dfac77202d85bd866f0a9
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    [ Upstream commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 ]
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 150b491b1b88d467ee6e2982b7baa074e53b60a0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 13 21:44:37 2016 +0800

    sctp: change sk state only when it has assocs in sctp_shutdown
    
    [ Upstream commit 5bf35ddfee052d44f39ebaa395d87101c8918405 ]
    
    Now when users shutdown a sock with SEND_SHUTDOWN in sctp, even if
    this sock has no connection (assoc), sk state would be changed to
    SCTP_SS_CLOSING, which is not as we expect.
    
    Besides, after that if users try to listen on this sock, kernel
    could even panic when it dereference sctp_sk(sk)->bind_hash in
    sctp_inet_listen, as bind_hash is null when sock has no assoc.
    
    This patch is to move sk state change after checking sk assocs
    is not empty, and also merge these two if() conditions and reduce
    indent level.
    
    Fixes: d46e416c11c8 ("sctp: sctp should change socket state when shutdown is received")
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9885f474d92b7ce09a6176133f9670525fe22e9b
Author: Soheil Hassas Yeganeh <soheil@google.com>
Date:   Fri Nov 4 15:36:49 2016 -0400

    sock: fix sendmmsg for partial sendmsg
    
    [ Upstream commit 3023898b7d4aac65987bd2f485cc22390aae6f78 ]
    
    Do not send the next message in sendmmsg for partial sendmsg
    invocations.
    
    sendmmsg assumes that it can continue sending the next message
    when the return value of the individual sendmsg invocations
    is positive. It results in corrupting the data for TCP,
    SCTP, and UNIX streams.
    
    For example, sendmmsg([["abcd"], ["efgh"]]) can result in a stream
    of "aefgh" if the first sendmsg invocation sends only the first
    byte while the second sendmsg goes through.
    
    Datagram sockets either send the entire datagram or fail, so
    this patch affects only sockets of type SOCK_STREAM and
    SOCK_SEQPACKET.
    
    Fixes: 228e548e6020 ("net: Add sendmmsg socket system call")
    Signed-off-by: Soheil Hassas Yeganeh <soheil@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Neal Cardwell <ncardwell@google.com>
    Acked-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b67ed647d135d0c0fbb3165d3c7b8c4bd68fe7be
Author: Soheil Hassas Yeganeh <soheil@google.com>
Date:   Fri Nov 4 15:36:49 2016 -0400

    sock: fix sendmmsg for partial sendmsg
    
    [ Upstream commit 3023898b7d4aac65987bd2f485cc22390aae6f78 ]
    
    Do not send the next message in sendmmsg for partial sendmsg
    invocations.
    
    sendmmsg assumes that it can continue sending the next message
    when the return value of the individual sendmsg invocations
    is positive. It results in corrupting the data for TCP,
    SCTP, and UNIX streams.
    
    For example, sendmmsg([["abcd"], ["efgh"]]) can result in a stream
    of "aefgh" if the first sendmsg invocation sends only the first
    byte while the second sendmsg goes through.
    
    Datagram sockets either send the entire datagram or fail, so
    this patch affects only sockets of type SOCK_STREAM and
    SOCK_SEQPACKET.
    
    Fixes: 228e548e6020 ("net: Add sendmmsg socket system call")
    Signed-off-by: Soheil Hassas Yeganeh <soheil@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Neal Cardwell <ncardwell@google.com>
    Acked-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c9e086b9009a1cf189dd96abad95285bc9627624
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    [ Upstream commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 ]
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bd891f40f04f8b96d9148ff8a5d538b60171409c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    [ Upstream commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6 ]
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e76d21c40bd6c67fd4e2c1540d77e113df962b4d
Merge: d4b9532367c7 ac571de999e1
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Nov 14 14:15:53 2016 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix off by one wrt. indexing when dumping /proc/net/route entries,
        from Alexander Duyck.
    
     2) Fix lockdep splats in iwlwifi, from Johannes Berg.
    
     3) Cure panic when inserting certain netfilter rules when NFT_SET_HASH
        is disabled, from Liping Zhang.
    
     4) Memory leak when nft_expr_clone() fails, also from Liping Zhang.
    
     5) Disable UFO when path will apply IPSEC tranformations, from Jakub
        Sitnicki.
    
     6) Don't bogusly double cwnd in dctcp module, from Florian Westphal.
    
     7) skb_checksum_help() should never actually use the value "0" for the
        resulting checksum, that has a special meaning, use CSUM_MANGLED_0
        instead. From Eric Dumazet.
    
     8) Per-tx/rx queue statistic strings are wrong in qed driver, fix from
        Yuval MIntz.
    
     9) Fix SCTP reference counting of associations and transports in
        sctp_diag. From Xin Long.
    
    10) When we hit ip6tunnel_xmit() we could have come from an ipv4 path in
        a previous layer or similar, so explicitly clear the ipv6 control
        block in the skb. From Eli Cooper.
    
    11) Fix bogus sleeping inside of inet_wait_for_connect(), from WANG
        Cong.
    
    12) Correct deivce ID of T6 adapter in cxgb4 driver, from Hariprasad
        Shenai.
    
    13) Fix potential access past the end of the skb page frag array in
        tcp_sendmsg(). From Eric Dumazet.
    
    14) 'skb' can legitimately be NULL in inet{,6}_exact_dif_match(). Fix
        from David Ahern.
    
    15) Don't return an error in tcp_sendmsg() if we wronte any bytes
        successfully, from Eric Dumazet.
    
    16) Extraneous unlocks in netlink_diag_dump(), we removed the locking
        but forgot to purge these unlock calls. From Eric Dumazet.
    
    17) Fix memory leak in error path of __genl_register_family(). We leak
        the attrbuf, from WANG Cong.
    
    18) cgroupstats netlink policy table is mis-sized, from WANG Cong.
    
    19) Several XDP bug fixes in mlx5, from Saeed Mahameed.
    
    20) Fix several device refcount leaks in network drivers, from Johan
        Hovold.
    
    21) icmp6_send() should use skb dst device not skb->dev to determine L3
        routing domain. From David Ahern.
    
    22) ip_vs_genl_family sets maxattr incorrectly, from WANG Cong.
    
    23) We leak new macvlan port in some cases of maclan_common_netlink()
        errors. Fix from Gao Feng.
    
    24) Similar to the icmp6_send() fix, icmp_route_lookup() should
        determine L3 routing domain using skb_dst(skb)->dev not skb->dev.
        Also from David Ahern.
    
    25) Several fixes for route offloading and FIB notification handling in
        mlxsw driver, from Jiri Pirko.
    
    26) Properly cap __skb_flow_dissect()'s return value, from Eric Dumazet.
    
    27) Fix long standing regression in ipv4 redirect handling, wrt.
        validating the new neighbour's reachability. From Stephen Suryaputra
        Lin.
    
    28) If sk_filter() trims the packet excessively, handle it reasonably in
        tcp input instead of exploding. From Eric Dumazet.
    
    29) Fix handling of napi hash state when copying channels in sfc driver,
        from Bert Kenward.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (121 commits)
      mlxsw: spectrum_router: Flush FIB tables during fini
      net: stmmac: Fix lack of link transition for fixed PHYs
      sctp: change sk state only when it has assocs in sctp_shutdown
      bnx2: Wait for in-flight DMA to complete at probe stage
      Revert "bnx2: Reset device during driver initialization"
      ps3_gelic: fix spelling mistake in debug message
      net: ethernet: ixp4xx_eth: fix spelling mistake in debug message
      ibmvnic: Fix size of debugfs name buffer
      ibmvnic: Unmap ibmvnic_statistics structure
      sfc: clear napi_hash state when copying channels
      mlxsw: spectrum_router: Correctly dump neighbour activity
      mlxsw: spectrum: Fix refcount bug on span entries
      bnxt_en: Fix VF virtual link state.
      bnxt_en: Fix ring arithmetic in bnxt_setup_tc().
      Revert "include/uapi/linux/atm_zatm.h: include linux/time.h"
      tcp: take care of truncations done by sk_filter()
      ipv4: use new_gw for redirect neigh lookup
      r8152: Fix error path in open function
      net: bpqether.h: remove if_ether.h guard
      net: __skb_flow_dissect() must cap its return value
      ...

commit 5bf35ddfee052d44f39ebaa395d87101c8918405
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sun Nov 13 21:44:37 2016 +0800

    sctp: change sk state only when it has assocs in sctp_shutdown
    
    Now when users shutdown a sock with SEND_SHUTDOWN in sctp, even if
    this sock has no connection (assoc), sk state would be changed to
    SCTP_SS_CLOSING, which is not as we expect.
    
    Besides, after that if users try to listen on this sock, kernel
    could even panic when it dereference sctp_sk(sk)->bind_hash in
    sctp_inet_listen, as bind_hash is null when sock has no assoc.
    
    This patch is to move sk state change after checking sk assocs
    is not empty, and also merge these two if() conditions and reduce
    indent level.
    
    Fixes: d46e416c11c8 ("sctp: sctp should change socket state when shutdown is received")
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0e54d2179f650bac80d89a9def429dbdbed58c11
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Mon Nov 7 18:31:17 2016 +0100

    netfilter: conntrack: simplify init/uninit of L4 protocol trackers
    
    modify registration and deregistration of layer-4 protocol trackers to
    facilitate inclusion of new elements into the current list of builtin
    protocols. Both builtin (TCP, UDP, ICMP) and non-builtin (DCCP, GRE, SCTP,
    UDPlite) layer-4 protocol trackers usually register/deregister themselves
    using consecutive calls to nf_ct_l4proto_{,pernet}_{,un}register(...).
    This sequence is interrupted and rolled back in case of error; in order to
    simplify addition of builtin protocols, the input of the above functions
    has been modified to allow registering/unregistering multiple protocols.
    
    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 3023898b7d4aac65987bd2f485cc22390aae6f78
Author: Soheil Hassas Yeganeh <soheil@google.com>
Date:   Fri Nov 4 15:36:49 2016 -0400

    sock: fix sendmmsg for partial sendmsg
    
    Do not send the next message in sendmmsg for partial sendmsg
    invocations.
    
    sendmmsg assumes that it can continue sending the next message
    when the return value of the individual sendmsg invocations
    is positive. It results in corrupting the data for TCP,
    SCTP, and UNIX streams.
    
    For example, sendmmsg([["abcd"], ["efgh"]]) can result in a stream
    of "aefgh" if the first sendmsg invocation sends only the first
    byte while the second sendmsg goes through.
    
    Datagram sockets either send the entire datagram or fail, so
    this patch affects only sockets of type SOCK_STREAM and
    SOCK_SEQPACKET.
    
    Fixes: 228e548e6020 ("net: Add sendmmsg socket system call")
    Signed-off-by: Soheil Hassas Yeganeh <soheil@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Willem de Bruijn <willemb@google.com>
    Signed-off-by: Neal Cardwell <ncardwell@google.com>
    Acked-by: Maciej enczykowski <maze@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5976c5f45c40588b90dda173ded9010917f8f45e
Author: Simon Horman <simon.horman@netronome.com>
Date:   Thu Nov 3 13:24:21 2016 +0100

    net/sched: cls_flower: Support matching on SCTP ports
    
    Support matching on SCTP ports in the same way that matching
    on TCP and UDP ports is already supported.
    
    Example usage:
    
    tc qdisc add dev eth0 ingress
    
    tc filter add dev eth0 protocol ip parent ffff: \
            flower indev eth0 ip_proto sctp dst_port 80 \
            action drop
    
    Signed-off-by: Simon Horman <simon.horman@netronome.com>
    Acked-by: Jiri Pirko <jiri@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2a26d99b251b8625d27aed14e97fc10707a3a81f
Merge: a909d3e63699 fceb9c3e3825
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Oct 29 20:33:20 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Lots of fixes, mostly drivers as is usually the case.
    
       1) Don't treat zero DMA address as invalid in vmxnet3, from Alexey
          Khoroshilov.
    
       2) Fix element timeouts in netfilter's nft_dynset, from Anders K.
          Pedersen.
    
       3) Don't put aead_req crypto struct on the stack in mac80211, from
          Ard Biesheuvel.
    
       4) Several uninitialized variable warning fixes from Arnd Bergmann.
    
       5) Fix memory leak in cxgb4, from Colin Ian King.
    
       6) Fix bpf handling of VLAN header push/pop, from Daniel Borkmann.
    
       7) Several VRF semantic fixes from David Ahern.
    
       8) Set skb->protocol properly in ip6_tnl_xmit(), from Eli Cooper.
    
       9) Socket needs to be locked in udp_disconnect(), from Eric Dumazet.
    
      10) Div-by-zero on 32-bit fix in mlx4 driver, from Eugenia Emantayev.
    
      11) Fix stale link state during failover in NCSCI driver, from Gavin
          Shan.
    
      12) Fix netdev lower adjacency list traversal, from Ido Schimmel.
    
      13) Propvide proper handle when emitting notifications of filter
          deletes, from Jamal Hadi Salim.
    
      14) Memory leaks and big-endian issues in rtl8xxxu, from Jes Sorensen.
    
      15) Fix DESYNC_FACTOR handling in ipv6, from Jiri Bohac.
    
      16) Several routing offload fixes in mlxsw driver, from Jiri Pirko.
    
      17) Fix broadcast sync problem in TIPC, from Jon Paul Maloy.
    
      18) Validate chunk len before using it in SCTP, from Marcelo Ricardo
          Leitner.
    
      19) Revert a netns locking change that causes regressions, from Paul
          Moore.
    
      20) Add recursion limit to GRO handling, from Sabrina Dubroca.
    
      21) GFP_KERNEL in irq context fix in ibmvnic, from Thomas Falcon.
    
      22) Avoid accessing stale vxlan/geneve socket in data path, from
          Pravin Shelar"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (189 commits)
      geneve: avoid using stale geneve socket.
      vxlan: avoid using stale vxlan socket.
      qede: Fix out-of-bound fastpath memory access
      net: phy: dp83848: add dp83822 PHY support
      enic: fix rq disable
      tipc: fix broadcast link synchronization problem
      ibmvnic: Fix missing brackets in init_sub_crq_irqs
      ibmvnic: Fix releasing of sub-CRQ IRQs in interrupt context
      Revert "ibmvnic: Fix releasing of sub-CRQ IRQs in interrupt context"
      arch/powerpc: Update parameters for csum_tcpudp_magic & csum_tcpudp_nofold
      net/mlx4_en: Save slave ethtool stats command
      net/mlx4_en: Fix potential deadlock in port statistics flow
      net/mlx4: Fix firmware command timeout during interrupt test
      net/mlx4_core: Do not access comm channel if it has not yet been initialized
      net/mlx4_en: Fix panic during reboot
      net/mlx4_en: Process all completions in RX rings after port goes up
      net/mlx4_en: Resolve dividing by zero in 32-bit system
      net/mlx4_core: Change the default value of enable_qos
      net/mlx4_core: Avoid setting ports to auto when only one port type is supported
      net/mlx4_core: Fix the resource-type enum in res tracker to conform to FW spec
      ...

commit 6ce40fc5413cf01056416c24fc340c0409981221
Merge: ebb676daa1a3 5d4ca23e58f2
Author: David S. Miller <davem@davemloft.net>
Date:   Sat Oct 29 16:19:41 2016 -0400

    Merge branch '40GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    40GbE Intel Wired LAN Driver Updates 2016-10-28
    
    This series contains updates to i40e and i40evf only.
    
    Carolyn provides a couple of fixes, first resolving a problem in the
    client interface that was causing random stack traces in the RDMA driver
    which was due to a timing related NULL pointer dereference.  Fixed a
    problem where it could take a very long time to print the link down
    notification, by changing how often we update link info from firmware.
    
    Alex provides a number of changes, first is a re-write of the bust wait
    loop in the Flow Director transmit function to reduce code size.  Cleans
    up unused code in favor of the same functionality which can be inlined.
    Dropped the functionality for SCTP since we cannot currently support it.
    Cleans up redundant code in the receive clean-up path.  Finally cleaned
    up the convoluted configuration for how the driver handled the debug
    flags contained in msg_level.
    
    Filip fixes an incorrect bit mask which was being used for testing the
    "get link status".  Cleaned up a workaround that is no longer needed
    for production NICs and was causing frames to pass while disregarding
    the VLAN tagging.
    
    Mitch brings another fix for the client interface supporting the VF RDMA
    driver to allow clients to recover from reset by re-opening existing
    clients.
    
    Alan fixes a bug in which a "perfect storm" can occur and cause interrupts
    to fail to be correctly affinitized.
    
    Lihong fixes a confusing dmesg reported when users were using ethtool -L
    option.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bf911e985d6bbaa328c20c3e05f4eb03de11fdd6
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Oct 25 14:27:39 2016 -0200

    sctp: validate chunk len before actually using it
    
    Andrey Konovalov reported that KASAN detected that SCTP was using a slab
    beyond the boundaries. It was caused because when handling out of the
    blue packets in function sctp_sf_ootb() it was checking the chunk len
    only after already processing the first chunk, validating only for the
    2nd and subsequent ones.
    
    The fix is to just move the check upwards so it's also validated for the
    1st chunk.
    
    Reported-by: Andrey Konovalov <andreyknvl@google.com>
    Tested-by: Andrey Konovalov <andreyknvl@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Reviewed-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e1da71ca88170d1a6232951294b44dc0c824e464
Author: Alexander Duyck <alexander.h.duyck@intel.com>
Date:   Wed Sep 14 16:24:35 2016 -0700

    i40e: Drop code for unsupported flow types
    
    We cannot currently support SCTP in the hardware, and IPV4_FLOW is not used
    anywhere by the software so we can go through and drop the functionality
    related to these two flow types.
    
    In addition we cannot support masking based on the protocol value so if the
    user is expecting a value other than TCP or UDP we should simply return an
    error rather then trying to allocate a filter for a rule that will only
    partially match what the user requested.
    
    Change-ID: I10d52bb97d8104d76255fe244551814ff9531a63
    Signed-off-by: Alexander Duyck <alexander.h.duyck@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit cc6395759b5ca1321bd4a01fb98c1ee1ae7a8627
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Net namespaces are not used
     - Keep using sctp_bh_{,un}lock_sock()
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit 6f67790b827dd495e7bf1bd874b8ad5ac6b3c0c4
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 upstream.
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit f887c21e214757e6b1b9dd65e396ee3e7cbb6b18
Merge: 7d1e04231461 7e32b44361ab
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Sep 22 08:49:25 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Mostly small bits scattered all over the place, which is usually how
      things go this late in the -rc series.
    
       1) Proper driver init device resets in bnx2, from Baoquan He.
    
       2) Fix accounting overflow in __tcp_retransmit_skb(),
          sk_forward_alloc, and ip_idents_reserve, from Eric Dumazet.
    
       3) Fix crash in bna driver ethtool stats handling, from Ivan Vecera.
    
       4) Missing check of skb_linearize() return value in mac80211, from
          Johannes Berg.
    
       5) Endianness fix in nf_table_trace dumps, from Liping Zhang.
    
       6) SSN comparison fix in SCTP, from Marcelo Ricardo Leitner.
    
       7) Update DSA and b44 MAINTAINERS entries.
    
       8) Make input path of vti6 driver work again, from Nicolas Dichtel.
    
       9) Off-by-one in mlx4, from Sebastian Ott.
    
      10) Fix fallback route lookup handling in ipv6, from Vincent Bernat.
    
      11) Fix stack corruption on probe in qed driver, from Yuval Mintz.
    
      12) PHY init fixes in r8152 from Hayes Wang.
    
      13) Missing SKB free in irda_accept error path, from Phil Turnbull"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (61 commits)
      tcp: properly account Fast Open SYN-ACK retrans
      tcp: fix under-accounting retransmit SNMP counters
      MAINTAINERS: Update b44 maintainer.
      net: get rid of an signed integer overflow in ip_idents_reserve()
      net/mlx4_core: Fix to clean devlink resources
      net: can: ifi: Configure transmitter delay
      vti6: fix input path
      ipmr, ip6mr: return lastuse relative to now
      r8152: disable ALDPS and EEE before setting PHY
      r8152: remove r8153_enable_eee
      r8152: move PHY settings to hw_phy_cfg
      r8152: move enabling PHY
      r8152: move some functions
      cxgb4/cxgb4vf: Allocate more queues for 25G and 100G adapter
      qed: Fix stack corruption on probe
      MAINTAINERS: Add an entry for the core network DSA code
      net: ipv6: fallback to full lookup if table lookup is unsuitable
      net/mlx5: E-Switch, Handle mode change failures
      net/mlx5: E-Switch, Fix error flow in the SRIOV e-switch init code
      net/mlx5: Fix flow counter bulk command out mailbox allocation
      ...

commit 9ba62f95965e6ba83ea90f919449ce5f6b01911b
Merge: b80b8d7a974e 4a225ce39508
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Sep 22 03:13:39 2016 -0400

    Merge branch 'sctp-align'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    Rename WORD_TRUNC/ROUND macros and use them
    
    This patchset aims to rename these macros to a non-confusing name, as
    reported by David Laight and David Miller, and to update all remaining
    places to make use of it, which was 1 last remaining spot.
    
    v3:
    - Name it SCTP_PAD4 instead of SCTP_ALIGN4, as suggested by David Laight
    v2:
    - fixed 2nd patch summary
    
    Details on the specific changelogs.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4a225ce3950879a5426c56f306f5d1c9d6330292
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Wed Sep 21 08:45:56 2016 -0300

    sctp: make use of SCTP_TRUNC4 macro
    
    And avoid the usage of '&~3'. This is the last place still not using
    the macro.
    Also break the line to make it easier to read.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e2f036a97271cf5811ee754bf321a29a814577f9
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Wed Sep 21 08:45:55 2016 -0300

    sctp: rename WORD_TRUNC/ROUND macros
    
    To something more meaningful these days, specially because this is
    working on packet headers or lengths and which are not tied to any CPU
    arch but to the protocol itself.
    
    So, WORD_TRUNC becomes SCTP_TRUNC4 and WORD_ROUND becomes SCTP_PAD4.
    
    Reported-by: David Laight <David.Laight@ACULAB.COM>
    Reported-by: David Miller <davem@davemloft.net>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit da499f8f5385c181e29978fdaab15a58de185302
Merge: 9395452b4aab 373df3131aa8
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Sep 12 07:56:06 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Mostly small sets of driver fixes scattered all over the place.
    
       1) Mediatek driver fixes from Sean Wang.  Forward port not written
          correctly during TX map, missed handling of EPROBE_DEFER, and
          mistaken use of put_page() instead of skb_free_frag().
    
       2) Fix socket double-free in KCM code, from WANG Cong.
    
       3) QED driver fixes from Sudarsana Reddy Kalluru, including a fix for
          using the dcbx buffers before initializing them.
    
       4) Mellanox Switch driver fixes from Jiri Pirko, including a fix for
          double fib removals and an error handling fix in
          mlxsw_sp_module_init().
    
       5) Fix kernel panic when enabling LLDP in i40e driver, from Dave
          Ertman.
    
       6) Fix padding of TSO packets in thunderx driver, from Sunil Goutham.
    
       7) TCP's rcv_wup not initialized properly when using fastopen, from
          Neal Cardwell.
    
       8) Don't use uninitialized flow keys in flow dissector, from Gao
          Feng.
    
       9) Use after free in l2tp module unload, from Sabrina Dubroca.
    
      10) Fix interrupt registry ordering issues in smsc911x driver, from
          Jeremy Linton.
    
      11) Fix crashes in bonding having to do with enslaving and rx_handler,
          from Mahesh Bandewar.
    
      12) AF_UNIX deadlock fixes from Linus.
    
      13) In mlx5 driver, don't read skb->xmit_mode after it might have been
          freed from the TX reclaim path.  From Tariq Toukan.
    
      14) Fix a bug from 2015 in TCP Yeah where the congestion window does
          not increase, from Artem Germanov.
    
      15) Don't pad frames on receive in NFP driver, from Jakub Kicinski.
    
      16) Fix chunk fragmenting in SCTP wrt. GSO, from Marcelo Ricardo
          Leitner.
    
      17) Fix deletion of VRF routes, from Mark Tomlinson.
    
      18) Fix device refcount leak when DAD fails in ipv6, from Wei Yongjun"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (101 commits)
      net/mlx4_en: Fix panic on xmit while port is down
      net/mlx4_en: Fixes for DCBX
      net/mlx4_en: Fix the return value of mlx4_en_dcbnl_set_state()
      net/mlx4_en: Fix the return value of mlx4_en_dcbnl_set_all()
      net: ethernet: renesas: sh_eth: add POST registers for rz
      drivers: net: phy: mdio-xgene: Add hardware dependency
      dwc_eth_qos: do not register semi-initialized device
      sctp: identify chunks that need to be fragmented at IP level
      mlxsw: spectrum: Set port type before setting its address
      mlxsw: spectrum_router: Fix error path in mlxsw_sp_router_init
      nfp: don't pad frames on receive
      nfp: drop support for old firmware ABIs
      nfp: remove linux/version.h includes
      tcp: cwnd does not increase in TCP YeAH
      net/mlx5e: Fix parsing of vlan packets when updating lro header
      net/mlx5e: Fix global PFC counters replication
      net/mlx5e: Prevent casting overflow
      net/mlx5e: Move an_disable_cap bit to a new position
      net/mlx5e: Fix xmit_more counter race issue
      tcp: fastopen: avoid negative sk_forward_alloc
      ...

commit 1cf7c76efb3c0f5439d2c9461502f33817469371
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [wt: adjusted, 3.10 uses sctp_bh_unlock_sock() instead of bh_lock_sock()]
    
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit c80fafbbb59ef9924962f83aac85531039395b18
Author: Xin Long <lucien.xin@gmail.com>
Date:   Thu Aug 25 13:21:49 2016 +0800

    veth: sctp: add NETIF_F_SCTP_CRC to device features
    
    Commit b17c706987fa ("loopback: sctp: add NETIF_F_SCTP_CSUM to device
    features") added NETIF_F_SCTP_CRC to device features for lo device to
    improve the performance of sctp over lo.
    
    This patch is to add NETIF_F_SCTP_CRC to device features for veth to
    improve the performance of sctp over veth.
    
    Before this patch:
      ip netns exec cs_client netperf -H 10.167.12.2 -t SCTP_STREAM -- -m 10K
      Recv   Send    Send
      Socket Socket  Message  Elapsed
      Size   Size    Size     Time     Throughput
      bytes  bytes   bytes    secs.    10^6bits/sec
    
      212992 212992  10240    10.00    1117.16
    
    After this patch:
      ip netns exec cs_client netperf -H 10.167.12.2 -t SCTP_STREAM -- -m 10K
      Recv   Send    Send
      Socket Socket  Message  Elapsed
      Size   Size    Size     Time     Throughput
      bytes  bytes   bytes    secs.    10^6bits/sec
    
      212992 212992  10240    10.20    1415.22
    
    Tested-by: Li Shuang <tjlishuang@yeah.net>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4c2f2454964477c66ef57745daab203b71783f66
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Aug 18 14:58:35 2016 -0300

    sctp: linearize early if it's not GSO
    
    Because otherwise when crc computation is still needed it's way more
    expensive than on a linear buffer to the point that it affects
    performance.
    
    It's so expensive that netperf test gives a perf output as below:
    
    Overhead  Command         Shared Object       Symbol
      18,62%  netserver       [kernel.vmlinux]    [k] crc32_generic_shift
       2,57%  netserver       [kernel.vmlinux]    [k] __pskb_pull_tail
       1,94%  netserver       [kernel.vmlinux]    [k] fib_table_lookup
       1,90%  netserver       [kernel.vmlinux]    [k] copy_user_enhanced_fast_string
       1,66%  swapper         [kernel.vmlinux]    [k] intel_idle
       1,63%  netserver       [kernel.vmlinux]    [k] _raw_spin_lock
       1,59%  netserver       [sctp]              [k] sctp_packet_transmit
       1,55%  netserver       [kernel.vmlinux]    [k] memcpy_erms
       1,42%  netserver       [sctp]              [k] sctp_rcv
    
    # netperf -H 192.168.10.1 -l 10 -t SCTP_STREAM -cC -- -m 12000
    SCTP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.10.1 () port 0 AF_INET
    Recv   Send    Send                          Utilization       Service Demand
    Socket Socket  Message  Elapsed              Send     Recv     Send    Recv
    Size   Size    Size     Time     Throughput  local    remote   local   remote
    bytes  bytes   bytes    secs.    10^6bits/s  % S      % S      us/KB   us/KB
    
    212992 212992  12000    10.00      3016.42   2.88     3.78     1.874   2.462
    
    After patch:
    Overhead  Command         Shared Object      Symbol
       2,75%  netserver       [kernel.vmlinux]   [k] memcpy_erms
       2,63%  netserver       [kernel.vmlinux]   [k] copy_user_enhanced_fast_string
       2,39%  netserver       [kernel.vmlinux]   [k] fib_table_lookup
       2,04%  netserver       [kernel.vmlinux]   [k] __pskb_pull_tail
       1,91%  netserver       [kernel.vmlinux]   [k] _raw_spin_lock
       1,91%  netserver       [sctp]             [k] sctp_packet_transmit
       1,72%  netserver       [mlx4_en]          [k] mlx4_en_process_rx_cq
       1,68%  netserver       [sctp]             [k] sctp_rcv
    
    # netperf -H 192.168.10.1 -l 10 -t SCTP_STREAM -cC -- -m 12000
    SCTP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.10.1 () port 0 AF_INET
    Recv   Send    Send                          Utilization       Service Demand
    Socket Socket  Message  Elapsed              Send     Recv     Send    Recv
    Size   Size    Size     Time     Throughput  local    remote   local   remote
    bytes  bytes   bytes    secs.    10^6bits/s  % S      % S      us/KB   us/KB
    
    212992 212992  12000    10.00      3681.77   3.83     3.46     2.045   1.849
    
    Fixes: 3acb50c18d8d ("sctp: delay as much as possible skb_linearize")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a4377c6e467b0b8420ee2d4384ae582ed506ee86
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    (cherry picked from commit 013dd9e038723bbd2aa67be51847384b75be8253)
    Signed-off-by: Chas Williams <3chas3@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit aa0c2c68abd1e2915656cc81afdb195bc8595dec
Author: Liping Zhang <liping.zhang@spreadtrum.com>
Date:   Mon Aug 8 22:10:26 2016 +0800

    netfilter: ctnetlink: reject new conntrack request with different l4proto
    
    Currently, user can add a conntrack with different l4proto via nfnetlink.
    For example, original tuple is TCP while reply tuple is SCTP. This is
    invalid combination, we should report EINVAL to userspace.
    
    Signed-off-by: Liping Zhang <liping.zhang@spreadtrum.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit df7e88f6cad8cc4e02c9275018a572fab59562c0
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 30 20:00:45 2016 +0800

    sctp: change to use TCP_CLOSE_WAIT as SCTP_SS_CLOSING
    
    Prior to this patch, sctp defined TCP_CLOSING as SCTP_SS_CLOSING.
    TCP_CLOSING is such a special sk state in TCP that inet common codes
    even exclude it.
    
    For instance, inet_accept thinks the accept sk's state never be
    TCP_CLOSING, or it will give a WARN_ON. TCP works well with that
    while SCTP may trigger the call trace, as CLOSING state in SCTP
    has different meaning from TCP.
    
    This fix is to change to use TCP_CLOSE_WAIT as SCTP_SS_CLOSING,
    instead of TCP_CLOSING. Some side-effects could be expected,
    regardless of not being used before. inet_accept will accept it
    now.
    
    I did all the func_tests in lksctp-tools and ran sctp codnomicon
    fuzzer tests against this patch, no regression or failure found.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a0fc6843f948345fa85c218fec662f571804d2f9
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 30 14:09:09 2016 +0800

    sctp: allow delivering notifications after receiving SHUTDOWN
    
    Prior to this patch, once sctp received SHUTDOWN or shutdown with RD,
    sk->sk_shutdown would be set with RCV_SHUTDOWN, and all events would
    be dropped in sctp_ulpq_tail_event(). It would cause:
    
    1. some notifications couldn't be received by users. like
       SCTP_SHUTDOWN_COMP generated by sctp_sf_do_4_C().
    
    2. sctp would also never trigger sk_data_ready when the association
       was closed, making it harder to identify the end of the association
       by calling recvmsg() and getting an EOF. It was not convenient for
       kernel users.
    
    The check here should be stopping delivering DATA chunks after receiving
    SHUTDOWN, and stopping delivering ANY chunks after sctp_close().
    
    So this patch is to allow notifications to enqueue into receive queue
    even if sk->sk_shutdown is set to RCV_SHUTDOWN in sctp_ulpq_tail_event,
    but if sk->sk_shutdown == RCV_SHUTDOWN | SEND_SHUTDOWN, it drops all
    events.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 468fc7ed5537615efe671d94248446ac24679773
Merge: 08fd8c17686c 36232012344b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jul 27 12:03:20 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
    
     1) Unified UDP encapsulation offload methods for drivers, from
        Alexander Duyck.
    
     2) Make DSA binding more sane, from Andrew Lunn.
    
     3) Support QCA9888 chips in ath10k, from Anilkumar Kolli.
    
     4) Several workqueue usage cleanups, from Bhaktipriya Shridhar.
    
     5) Add XDP (eXpress Data Path), essentially running BPF programs on RX
        packets as soon as the device sees them, with the option to mirror
        the packet on TX via the same interface.  From Brenden Blanco and
        others.
    
     6) Allow qdisc/class stats dumps to run lockless, from Eric Dumazet.
    
     7) Add VLAN support to b53 and bcm_sf2, from Florian Fainelli.
    
     8) Simplify netlink conntrack entry layout, from Florian Westphal.
    
     9) Add ipv4 forwarding support to mlxsw spectrum driver, from Ido
        Schimmel, Yotam Gigi, and Jiri Pirko.
    
    10) Add SKB array infrastructure and convert tun and macvtap over to it.
        From Michael S Tsirkin and Jason Wang.
    
    11) Support qdisc packet injection in pktgen, from John Fastabend.
    
    12) Add neighbour monitoring framework to TIPC, from Jon Paul Maloy.
    
    13) Add NV congestion control support to TCP, from Lawrence Brakmo.
    
    14) Add GSO support to SCTP, from Marcelo Ricardo Leitner.
    
    15) Allow GRO and RPS to function on macsec devices, from Paolo Abeni.
    
    16) Support MPLS over IPV4, from Simon Horman.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1622 commits)
      xgene: Fix build warning with ACPI disabled.
      be2net: perform temperature query in adapter regardless of its interface state
      l2tp: Correctly return -EBADF from pppol2tp_getname.
      net/mlx5_core/health: Remove deprecated create_singlethread_workqueue
      net: ipmr/ip6mr: update lastuse on entry change
      macsec: ensure rx_sa is set when validation is disabled
      tipc: dump monitor attributes
      tipc: add a function to get the bearer name
      tipc: get monitor threshold for the cluster
      tipc: make cluster size threshold for monitoring configurable
      tipc: introduce constants for tipc address validation
      net: neigh: disallow transition to NUD_STALE if lladdr is unchanged in neigh_update()
      MAINTAINERS: xgene: Add driver and documentation path
      Documentation: dtb: xgene: Add MDIO node
      dtb: xgene: Add MDIO node
      drivers: net: xgene: ethtool: Use phy_ethtool_gset and sset
      drivers: net: xgene: Use exported functions
      drivers: net: xgene: Enable MDIO driver
      drivers: net: xgene: Add backward compatibility
      drivers: net: phy: xgene: Add MDIO driver
      ...

commit 52253db924d1480bf2543afbb9551de31381aab9
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Sat Jul 23 00:33:44 2016 -0300

    sctp: also point GSO head_skb to the sk when it's available
    
    The head skb for GSO packets won't travel through the inner depths of
    SCTP stack as it doesn't contain any chunks on it. That means skb->sk
    doesn't get set and then when sctp_recvmsg() calls
    sctp_inet6_skb_msgname() on the head_skb it panics, as this last needs
    to check flags at the socket (sp->v4mapped).
    
    The fix is to initialize skb->sk for th head skb once we are able to do
    it. That is, when the first chunk is processed.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c5c4e45c4b79acb23f07e43dac1348e67b4ddf91
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jul 15 16:40:02 2016 -0300

    sctp: fix GSO for IPv6
    
    commit 90017accff61 ("sctp: Add GSO support") didn't register SCTP GSO
    offloading for IPv6 and yet didn't put any restrictions on generating
    GSO packets while in IPv6, which causes all IPv6 GSO'ed packets to be
    silently dropped.
    
    The fix is to properly register the offload this time.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 858296c8784bf98450765cbc6b1bc2e44175cc01
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Tue Jun 14 15:45:42 2016 -0700

    i40e/i40evf: Fix i40e_rx_checksum
    
    There are a couple of issues I found in i40e_rx_checksum while doing some
    recent testing.  As a result I have found the Rx checksum logic is pretty
    much broken and returning that the checksum is valid for tunnels in cases
    where it is not.
    
    First the inner types are not the correct values to use to test for if a
    tunnel is present or not.  In addition the inner protocol types are not a
    bitmask as such performing an OR of the values doesn't make sense.  I have
    instead changed the code so that the inner protocol types are used to
    determine if we report CHECKSUM_UNNECESSARY or not.  For anything that does
    not end in UDP, TCP, or SCTP it doesn't make much sense to report a
    checksum offload since it won't contain a checksum anyway.
    
    This leaves us with the need to set the csum_level based on some value.
    For that purpose I am using the tunnel_type field.  If the tunnel type is
    GRENAT or greater then this means we have a GRE or UDP tunnel with an inner
    header.  In the case of GRE or UDP we will have a possible checksum present
    so for this reason it should be safe to set the csum_level to 1 to indicate
    that we are reporting the state of the inner header.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 1f45f78f8e511203f03138f2ccde3d2cf90d2cbf
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Wed Jul 13 15:08:57 2016 -0300

    sctp: allow GSO frags to access the chunk too
    
    SCTP will try to access original IP headers on sctp_recvmsg in order to
    copy the addresses used. There are also other places that do similar access
    to IP or even SCTP headers. But after 90017accff61 ("sctp: Add GSO
    support") they aren't always there because they are only present in the
    header skb.
    
    SCTP handles the queueing of incoming data by cloning the incoming skb
    and limiting to only the relevant payload. This clone has its cb updated
    to something different and it's then queued on socket rx queue. Thus we
    need to fix this in two moments.
    
    For rx path, not related to socket queue yet, this patch uses a
    partially copied sctp_input_cb to such GSO frags. This restores the
    ability to access the headers for this part of the code.
    
    Regarding the socket rx queue, it removes iif member from sctp_event and
    also add a chunk pointer on it.
    
    With these changes we're always able to reach the headers again.
    
    The biggest change here is that now the sctp_chunk struct and the
    original skb are only freed after the application consumed the buffer.
    Note however that the original payload was already like this due to the
    skb cloning.
    
    For iif, SCTP's IPv4 code doesn't use it, so no change is necessary.
    IPv6 now can fetch it directly from original's IPv6 CB as the original
    skb is still accessible.
    
    In the future we probably can simplify sctp_v*_skb_iif() stuff, as
    sctp_v4_skb_iif() was called but it's return value not used, and now
    it's not even called, but such cleanup is out of scope for this change.
    
    Fixes: 90017accff61 ("sctp: Add GSO support")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4154cb40e71a7255bae0c67734fe85950c9254e5
Merge: bac65c4b39ca 8dbdf1f5b09c
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jul 11 13:25:39 2016 -0700

    Merge branch 'sctp-rfc7496-support'
    
    Xin Long says:
    
    ====================
    sctp: implement rfc7496 in sctp
    
    This patchset implements "Additional Policies for the Partially Reliable
    Stream Control Transmission Protocol Extension" described on RFC7496.
    
    The Partially Reliable SCTP (PR-SCTP) extension defined in [RFC3758]
    provides a generic method for senders to abandon user messages. The
    decision to abandon a user message is sender side only, and the exact
    condition is called a "PR-SCTP policy". This patchset implements 3
    policies:
    
     1. Timed Reliability:  This allows the sender to specify a timeout for
        a user message after which the SCTP stack abandons the user message.
    
     2. Limited Retransmission Policy:  Allows limitation of the number of
        retransmissions.
    
     3. Priority Policy:  Allows removal of lower-priority messages if space
        for higher-priority messages is needed in the send buffer.
    
    Patch 1-3 add some sockopts in sctp to set/get pr_sctp policy status.
    Patch 4-6 implement these 3 policies one by one.
    ====================
    
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 826d253d57b11f69add81c8086d2e7f1dce5ec77
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 9 19:47:42 2016 +0800

    sctp: add SCTP_PR_ASSOC_STATUS on sctp sockopt
    
    This patch adds SCTP_PR_ASSOC_STATUS to sctp sockopt, which is used
    to dump the prsctp statistics info from the asoc. The prsctp statistics
    includes abandoned_sent/unsent from the asoc. abandoned_sent is the
    count of the packets we drop packets from retransmit/transmited queue,
    and abandoned_unsent is the count of the packets we drop from out_queue
    according to the policy.
    
    Note: another option for prsctp statistics dump described in rfc is
    SCTP_PR_STREAM_STATUS, which is used to dump the prsctp statistics
    info from each stream. But by now, linux doesn't yet have per stream
    statistics info, it needs rfc6525 to be implemented. As the prsctp
    statistics for each stream has to be based on per stream statistics,
    we will delay it until rfc6525 is done in linux.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f959fb442c35f4b61fea341401b8463dd0a1b959
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 9 19:47:41 2016 +0800

    sctp: add SCTP_DEFAULT_PRINFO into sctp sockopt
    
    This patch adds SCTP_DEFAULT_PRINFO to sctp sockopt. It is used
    to set/get sctp Partially Reliable Policies' default params,
    which includes 3 policies (ttl, rtx, prio) and their values.
    
    Still, if we set policy params in sndinfo, we will use the params
    of sndinfo against chunks, instead of the default params.
    
    In this patch, we will use 5-8bit of sp/asoc->default_flags
    to store prsctp policies, and reuse asoc->default_timetolive
    to store their values. It means if we enable and set prsctp
    policy, prior ttl timeout in sctp will not work any more.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 28aa4c26fce2202db8d42ae76b639ca1d9a23d25
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat Jul 9 19:47:40 2016 +0800

    sctp: add SCTP_PR_SUPPORTED on sctp sockopt
    
    According to section 4.5 of rfc7496, prsctp_enable should be per asoc.
    We will add prsctp_enable to both asoc and ep, and replace the places
    where it used net.sctp->prsctp_enable with asoc->prsctp_enable.
    
    ep->prsctp_enable will be initialized with net.sctp->prsctp_enable, and
    asoc->prsctp_enable will be initialized with ep->prsctp_enable. We can
    also modify it's value through sockopt SCTP_PR_SUPPORTED.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit db54275dffb28b0b19596a6418419930f58332a0
Merge: f2edc4e1b078 942b3235bf77
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Jun 3 19:37:26 2016 -0400

    Merge branch 'sctp-gso'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    sctp: Add GSO support
    
    This patchset adds sctp GSO support.
    
    Performance tests indicates that increases throughput by 10% if using
    bigger chunk sizes, specially if bigger than MTU. For small chunks, it
    doesn't help much if not using heavy firewall rules.
    
    For small chunks it will probably be of more use once we get something
    like MSG_MORE as David Laight had suggested.
    
    overall changes:
    v1->v2:
    Added support for receiving GSO frames on SCTP stack, as requested by
    Dave Miller.
    
    v2->v3:
    Consider sctphdr size in skb_gso_transport_seglen()
    rebased due to 5c7cdf339af5 ("gso: Remove arbitrary checks for
    unsupported GSO")
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 90017accff61ae89283ad9a51f9ac46ca01633fb
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Jun 2 15:05:43 2016 -0300

    sctp: Add GSO support
    
    SCTP has this pecualiarity that its packets cannot be just segmented to
    (P)MTU. Its chunks must be contained in IP segments, padding respected.
    So we can't just generate a big skb, set gso_size to the fragmentation
    point and deliver it to IP layer.
    
    This patch takes a different approach. SCTP will now build a skb as it
    would be if it was received using GRO. That is, there will be a cover
    skb with protocol headers and children ones containing the actual
    segments, already segmented to a way that respects SCTP RFCs.
    
    With that, we can tell skb_segment() to just split based on frag_list,
    trusting its sizes are already in accordance.
    
    This way SCTP can benefit from GSO and instead of passing several
    packets through the stack, it can pass a single large packet.
    
    v2:
    - Added support for receiving GSO frames, as requested by Dave Miller.
    - Clear skb->cb if packet is GSO (otherwise it's not used by SCTP)
    - Added heuristics similar to what we have in TCP for not generating
      single GSO packets that fills cwnd.
    v3:
    - consider sctphdr size in skb_gso_transport_seglen()
    - rebased due to 5c7cdf339af5 ("gso: Remove arbitrary checks for
      unsupported GSO")
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f6c382fc553b49bc2dfaf705e34fde32171b5db4
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Jun 2 15:05:38 2016 -0300

    loopback: make use of NETIF_F_GSO_SOFTWARE
    
    NETIF_F_GSO_SOFTWARE was defined to list all GSO software types, so lets
    make use of it in loopback code. Note that veth/vxlan/others already
    uses it.
    
    Within this patch series, this patch causes lo to pick up SCTP GSO feature
    automatically (as it's added to NETIF_F_GSO_SOFTWARE) and thus avoiding
    segmentation if possible.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Tested-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6b15d6650c5301ce023d8df0cc3a60b1a76d377e
Merge: 58c1f9950ffc faf8dcc12c27
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue May 31 22:28:28 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix negative error code usage in ATM layer, from Stefan Hajnoczi.
    
     2) If CONFIG_SYSCTL is disabled, the default TTL is not initialized
        properly.  From Ezequiel Garcia.
    
     3) Missing spinlock init in mvneta driver, from Gregory CLEMENT.
    
     4) Missing unlocks in hwmb error paths, also from Gregory CLEMENT.
    
     5) Fix deadlock on team->lock when propagating features, from Ivan
        Vecera.
    
     6) Work around buffer offset hw bug in alx chips, from Feng Tang.
    
     7) Fix double listing of SCTP entries in sctp_diag dumps, from Xin
        Long.
    
     8) Various statistics bug fixes in mlx4 from Eric Dumazet.
    
     9) Fix some randconfig build errors wrt fou ipv6 from Arnd Bergmann.
    
    10) All of l2tp was namespace aware, but the ipv6 support code was not
        doing so.  From Shmulik Ladkani.
    
    11) Handle on-stack hrtimers properly in pktgen, from Guenter Roeck.
    
    12) Propagate MAC changes properly through VLAN devices, from Mike
        Manning.
    
    13) Fix memory leak in bnx2x_init_one(), from Vitaly Kuznetsov.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (62 commits)
      sfc: Track RPS flow IDs per channel instead of per function
      usbnet: smsc95xx: fix link detection for disabled autonegotiation
      virtio_net: fix virtnet_open and virtnet_probe competing for try_fill_recv
      bnx2x: avoid leaking memory on bnx2x_init_one() failures
      fou: fix IPv6 Kconfig options
      openvswitch: update checksum in {push,pop}_mpls
      sctp: sctp_diag should dump sctp socket type
      net: fec: update dirty_tx even if no skb
      vlan: Propagate MAC address to VLANs
      atm: iphase: off by one in rx_pkt()
      atm: firestream: add more reserved strings
      vxlan: Accept user specified MTU value when create new vxlan link
      net: pktgen: Call destroy_hrtimer_on_stack()
      timer: Export destroy_hrtimer_on_stack()
      net: l2tp: Make l2tp_ip6 namespace aware
      Documentation: ip-sysctl.txt: clarify secure_redirects
      sfc: use flow dissector helpers for aRFS
      ieee802154: fix logic error in ieee802154_llsec_parse_dev_addr
      net: nps_enet: Disable interrupts before napi reschedule
      net/lapb: tuse %*ph to dump buffers
      ...

commit a7fd20d1c476af4563e66865213474a2f9f473a4
Merge: b80fed959551 917fa5353da0
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue May 17 16:26:30 2016 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Highlights:
    
       1) Support SPI based w5100 devices, from Akinobu Mita.
    
       2) Partial Segmentation Offload, from Alexander Duyck.
    
       3) Add GMAC4 support to stmmac driver, from Alexandre TORGUE.
    
       4) Allow cls_flower stats offload, from Amir Vadai.
    
       5) Implement bpf blinding, from Daniel Borkmann.
    
       6) Optimize _ASYNC_ bit twiddling on sockets, unless the socket is
          actually using FASYNC these atomics are superfluous.  From Eric
          Dumazet.
    
       7) Run TCP more preemptibly, also from Eric Dumazet.
    
       8) Support LED blinking, EEPROM dumps, and rxvlan offloading in mlx5e
          driver, from Gal Pressman.
    
       9) Allow creating ppp devices via rtnetlink, from Guillaume Nault.
    
      10) Improve BPF usage documentation, from Jesper Dangaard Brouer.
    
      11) Support tunneling offloads in qed, from Manish Chopra.
    
      12) aRFS offloading in mlx5e, from Maor Gottlieb.
    
      13) Add RFS and RPS support to SCTP protocol, from Marcelo Ricardo
          Leitner.
    
      14) Add MSG_EOR support to TCP, this allows controlling packet
          coalescing on application record boundaries for more accurate
          socket timestamp sampling.  From Martin KaFai Lau.
    
      15) Fix alignment of 64-bit netlink attributes across the board, from
          Nicolas Dichtel.
    
      16) Per-vlan stats in bridging, from Nikolay Aleksandrov.
    
      17) Several conversions of drivers to ethtool ksettings, from Philippe
          Reynes.
    
      18) Checksum neutral ILA in ipv6, from Tom Herbert.
    
      19) Factorize all of the various marvell dsa drivers into one, from
          Vivien Didelot
    
      20) Add VF support to qed driver, from Yuval Mintz"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1649 commits)
      Revert "phy dp83867: Fix compilation with CONFIG_OF_MDIO=m"
      Revert "phy dp83867: Make rgmii parameters optional"
      r8169: default to 64-bit DMA on recent PCIe chips
      phy dp83867: Make rgmii parameters optional
      phy dp83867: Fix compilation with CONFIG_OF_MDIO=m
      bpf: arm64: remove callee-save registers use for tmp registers
      asix: Fix offset calculation in asix_rx_fixup() causing slow transmissions
      switchdev: pass pointer to fib_info instead of copy
      net_sched: close another race condition in tcf_mirred_release()
      tipc: fix nametable publication field in nl compat
      drivers: net: Don't print unpopulated net_device name
      qed: add support for dcbx.
      ravb: Add missing free_irq() calls to ravb_close()
      qed: Remove a stray tab
      net: ethernet: fec-mpc52xx: use phy_ethtool_{get|set}_link_ksettings
      net: ethernet: fec-mpc52xx: use phydev from struct net_device
      bpf, doc: fix typo on bpf_asm descriptions
      stmmac: hardware TX COE doesn't work when force_thresh_dma_mode is set
      net: ethernet: fs-enet: use phy_ethtool_{get|set}_link_ksettings
      net: ethernet: fs-enet: use phydev from struct net_device
      ...

commit d4b3fa4b0881b600ddeee9dd47b27dea9709f322
Author: Nicholas Bellinger <nab@linux-iscsi.org>
Date:   Sat May 14 21:44:01 2016 -0700

    iscsi-target: Make iscsi_tpg_np driver show/store use generic code
    
    Go ahead and fold the duplicate iscsi_tpg_np driver attribute
    show/store functions into generic callers, invoked by current
    driver specific functions.
    
    This allows for future v4.8+ changes to have iscsi_target_mod
    use tpg_np driver attributes at runtime, instead of having
    the defaults hardcoded in iscsi_target_configfs.c.
    
    Also, drop the unused/legacy 'sctp' attribute for non standard
    RFC-3720 operation with IPPROTO_SCTP.
    
    Cc: Varun Prakash <varun@chelsio.com>
    Cc: Hariprasad Shenai <hariprasad@chelsio.com>
    Cc: Christoph Hellwig <hch@lst.de>
    Cc: Sagi Grimberg <sagi@grimberg.me>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>

commit 860fbbc343bf05a71b31555579ff4878194be01b
Author: Eric Dumazet <edumazet@google.com>
Date:   Fri Apr 29 14:16:51 2016 -0700

    sctp: prepare for socket backlog behavior change
    
    sctp_inq_push() will soon be called without BH being blocked
    when generic socket code flushes the socket backlog.
    
    It is very possible SCTP can be converted to not rely on BH,
    but this needs to be done by SCTP experts.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 20d1dcfc4dc4b61b369d0aaa6d412b5a08d7917d
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7b7483409f09c15f30ac43242ead1ab3061e1f59
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Apr 25 15:13:17 2016 -0300

    net: fix net_gso_ok for new GSO types.
    
    Fix casting in net_gso_ok. Otherwise the shift on
    gso_type << NETIF_F_GSO_SHIFT may hit the 32th bit and make it look like
    a INT_MIN, which is then promoted from signed to uint64 which is
    0xffffffff80000000, resulting in wrong behavior when it is and'ed with
    the feature itself, as in:
    
    This test app:
    #include <stdio.h>
    #include <stdint.h>
    
    int main(int argc, char **argv)
    {
            uint64_t feature1;
            uint64_t feature2;
            int gso_type = 1 << 15;
    
            feature1 = gso_type << 16;
            feature2 = (uint64_t)gso_type << 16;
            printf("%lx %lx\n", feature1, feature2);
    
            return 0;
    }
    
    Gives:
    ffffffff80000000 80000000
    
    So that this:
       return (features & feature) == feature;
    Actually works on more bits than expected and invalid ones.
    
    Fix is to promote it earlier.
    
    Issue noted while rebasing SCTP GSO patch but posting separetely as
    someone else may experience this meanwhile.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 08e3baef65e2e9481637a1e8fb06089ca70be707
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Apr 27 16:44:34 2016 -0700

    net: sctp: rename SCTP_INC_STATS_BH()
    
    Rename SCTP_INC_STATS_BH() to __SCTP_INC_STATS()
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6aef70a851ac77967992340faaff33f44598f60a
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Apr 27 16:44:27 2016 -0700

    net: snmp: kill various STATS_USER() helpers
    
    In the old days (before linux-3.0), SNMP counters were duplicated,
    one for user context, and one for BH context.
    
    After commit 8f0ea0fe3a03 ("snmp: reduce percpu needs by 50%")
    we have a single copy, and what really matters is preemption being
    enabled or disabled, since we use this_cpu_inc() or __this_cpu_inc()
    respectively.
    
    We therefore kill SNMP_INC_STATS_USER(), SNMP_ADD_STATS_USER(),
    NET_INC_STATS_USER(), NET_ADD_STATS_USER(), SCTP_INC_STATS_USER(),
    SNMP_INC_STATS64_USER(), SNMP_ADD_STATS64_USER(), TCP_ADD_STATS_USER(),
    UDP_INC_STATS_USER(), UDP6_INC_STATS_USER(), and XFRM_INC_STATS_USER()
    
    Following patches will rename __BH helpers to make clear their
    usage is not tied to BH being disabled.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b0fe3306432796c8f7adbede8ccd479bb7b53d0a
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Sat Apr 2 00:05:14 2016 -0700

    i40e/i40evf: Clean up feature flags
    
    The feature flags list for i40e and i40evf is beginning to become pretty
    massive.  I plan to add another 4 or so features to these drivers and
    duplicating the flags for each and every flags list is becoming a bit
    repetitive.
    
    The primary change here is that we now build our features list around
    hw_encap_features.  After that we assign that to vlan_features,
    hw_features, and finally map that onto features.  In addition we end up
    throwing features onto hw_encap_features that end up having no effect such
    as the Rx offloads and SCTP_CRC.  However that should have no impact and
    makes things a bit easier for us as hw_encap_features is one of the less
    updated features maps available.
    
    For i40evf I went through and sanity checked a few features as well.
    Specifically RXCSUM was being set as a read-only feature which didn't make
    much sense.  I have updated things so we can clear the NETIF_F_RXCSUM flag
    since that is really a software feature and not a hardware one anyway so
    disabling it is just a matter of ignoring the result from the hardware.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 311b21774f1389f9c34eac4da90c43c95fc2b62b
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Wed Apr 13 19:12:29 2016 -0300

    sctp: simplify sk_receive_queue locking
    
    SCTP already serializes access to rcvbuf through its sock lock:
    sctp_recvmsg takes it right in the start and release at the end, while
    rx path will also take the lock before doing any socket processing. On
    sctp_rcv() it will check if there is an user using the socket and, if
    there is, it will queue incoming packets to the backlog. The backlog
    processing will do the same. Even timers will do such check and
    re-schedule if an user is using the socket.
    
    Simplifying this will allow us to remove sctp_skb_list_tail and get ride
    of some expensive lockings.  The lists that it is used on are also
    mangled with functions like __skb_queue_tail and __skb_unlink in the
    same context, like on sctp_ulpq_tail_event() and sctp_clear_pd().
    sctp_close() will also purge those while using only the sock lock.
    
    Therefore the lockings performed by sctp_skb_list_tail() are not
    necessary. This patch removes this function and replaces its calls with
    just skb_queue_splice_tail_init() instead.
    
    The biggest gain is at sctp_ulpq_tail_event(), because the events always
    contain a list, even if it's queueing a single skb and this was
    triggering expensive calls to spin_lock_irqsave/_irqrestore for every
    data chunk received.
    
    As SCTP will deliver each data chunk on a corresponding recvmsg, the
    more effective the change will be.
    Before this patch, with chunks with 30 bytes:
    netperf -t SCTP_STREAM -H 192.168.1.2 -cC -l 60 -- -m 30 -S 400000
    400000 -s 400000 400000
    on a 10Gbit link with 1500 MTU:
    
    SCTP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.1 () port 0 AF_INET
    Recv   Send    Send                          Utilization       Service Demand
    Socket Socket  Message  Elapsed              Send     Recv     Send    Recv
    Size   Size    Size     Time     Throughput  local    remote   local   remote
    bytes  bytes   bytes    secs.    10^6bits/s  % S      % S      us/KB   us/KB
    
    425984 425984     30    60.00       137.45   7.34     7.36     52.504  52.608
    
    With it:
    
    SCTP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.1.1 () port 0 AF_INET
    Recv   Send    Send                          Utilization       Service Demand
    Socket Socket  Message  Elapsed              Send     Recv     Send    Recv
    Size   Size    Size     Time     Throughput  local    remote   local   remote
    bytes  bytes   bytes    secs.    10^6bits/s  % S      % S      us/KB   us/KB
    
    425984 425984     30    60.00       179.10   7.97     6.70     43.740  36.788
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 486bdee0134cf21c3714ded809d5933d2b8dfb81
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Apr 12 18:11:31 2016 -0300

    sctp: add support for RPS and RFS
    
    This patch adds what's missing to properly support RPS and RFS on SCTP,
    as some of it is already implemented in common calls.
    
    Having support for RPS and RFS allows better scaling specially because
    not all NICs support hashing SCTP headers.
    
    Save the hash right when we dequeue a skb from inqueue so we do it only
    once per skb instead of per chunk. New sockets will then inherit the
    hash through sctp_copy_sock().
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fb586f25300f4587c7ebd097a604bf269b25bfa7
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Apr 8 16:41:28 2016 -0300

    sctp: delay calls to sk_data_ready() as much as possible
    
    Currently processing of multiple chunks in a single SCTP packet leads to
    multiple calls to sk_data_ready, causing multiple wake up signals which
    are costy and doesn't make it wake up any faster.
    
    With this patch it will note that the wake up is pending and will do it
    before leaving the state machine interpreter, latest place possible to
    do it realiably and cleanly.
    
    Note that sk_data_ready events are not dependent on asocs, unlike waking
    up writers.
    
    v2: series re-checked
    v3: use local vars to cleanup the code, suggested by Jakub Sitnicki
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ba6f5e33bdbb9ed2014b778fbbaecf20060ca989
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Wed Apr 6 15:15:19 2016 -0300

    sctp: avoid refreshing heartbeat timer too often
    
    Currently on high rate SCTP streams the heartbeat timer refresh can
    consume quite a lot of resources as timer updates are costly and it
    contains a random factor, which a) is also costly and b) invalidates
    mod_timer() optimization for not editing a timer to the same value.
    It may even cause the timer to be slightly advanced, for no good reason.
    
    As suggested by David Laight this patch now removes this timer update
    from hot path by leaving the timer on and re-evaluating upon its
    expiration if the heartbeat is still needed or not, similarly to what is
    done for TCP. If it's not needed anymore the timer is re-scheduled to
    the new timeout, considering the time already elapsed.
    
    For this, we now record the last tx timestamp per transport, updated in
    the same spots as hb timer was restarted on tx. Also split up
    sctp_transport_reset_timers into sctp_transport_reset_t3_rtx and
    sctp_transport_reset_hb_timer, so we can re-arm T3 without re-arming the
    heartbeat one.
    
    On loopback with MTU of 65535 and data chunks with 1636, so that we
    have a considerable amount of chunks without stressing system calls,
    netperf -t SCTP_STREAM -l 30, perf looked like this before:
    
    Samples: 103K of event 'cpu-clock', Event count (approx.): 25833000000
      Overhead  Command  Shared Object      Symbol
    +    6,15%  netperf  [kernel.vmlinux]   [k] copy_user_enhanced_fast_string
    -    5,43%  netperf  [kernel.vmlinux]   [k] _raw_write_unlock_irqrestore
       - _raw_write_unlock_irqrestore
          - 96,54% _raw_spin_unlock_irqrestore
             - 36,14% mod_timer
                + 97,24% sctp_transport_reset_timers
                + 2,76% sctp_do_sm
             + 33,65% __wake_up_sync_key
             + 28,77% sctp_ulpq_tail_event
             + 1,40% del_timer
          - 1,84% mod_timer
             + 99,03% sctp_transport_reset_timers
             + 0,97% sctp_do_sm
          + 1,50% sctp_ulpq_tail_event
    
    And after this patch, now with netperf -l 60:
    
    Samples: 230K of event 'cpu-clock', Event count (approx.): 57707250000
      Overhead  Command  Shared Object      Symbol
    +    5,65%  netperf  [kernel.vmlinux]   [k] memcpy_erms
    +    5,59%  netperf  [kernel.vmlinux]   [k] copy_user_enhanced_fast_string
    -    5,05%  netperf  [kernel.vmlinux]   [k] _raw_spin_unlock_irqrestore
       - _raw_spin_unlock_irqrestore
          + 49,89% __wake_up_sync_key
          + 45,68% sctp_ulpq_tail_event
          - 2,85% mod_timer
             + 76,51% sctp_transport_reset_t3_rtx
             + 23,49% sctp_do_sm
          + 1,55% del_timer
    +    2,50%  netperf  [sctp]             [k] sctp_datamsg_from_user
    +    2,26%  netperf  [sctp]             [k] sctp_sendmsg
    
    Throughput-wise, from 6800mbps without the patch to 7050mbps with it,
    ~3.7%.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 43e2dfb23eb8f3698718ec1e3936c76912de1c30
Merge: 6e3380488a47 0c5a616650a0
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Apr 4 22:01:44 2016 -0400

    Merge branch '10GbE' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    10GbE Intel Wired LAN Driver Updates 2016-04-04
    
    This series contains updates to ixgbe and ixgbevf.
    
    Pavel Tikhomirov fixes a typo where we were incrementing transmit stats
    instead of receive stats on the receive side.
    
    Emil updates the ixgbevf driver to use bit operations for setting and
    checking the adapter state.
    
    Chas Williams adds the new NDO trust feature check so that the VF guest
    has the ability to set the unicast address of the interface, if it is a
    trusted VF.
    
    Alex cleans up the driver to that the only time we add a PF entry to the
    VLVF is either for VLAN 0 or if the PF has requested a VLAN that a VF
    is already using.  Also adds support for generic transmit checksums,
    giving the added advantage is that we can support inner checksum offloads
    for tunnels and MPLS while still being able to transparently insert
    VLAN tags.  Lastly, changed ixgbe so that we can use the ethtool
    rx-vlan-filter flag to toggle receive VLAN filtering on and off.
    
    Mark cleans up the ixgbe driver by making all op structures that do not
    change constants.  Also fixed flow control for Xeon D KR backplanes, since
    we cannot use auto-negotiation to determine the mode, we have to use
    whatever the user configured.
    
    Sowmini Varadhan updates ixgbe to use eth_platform_get_mac_address()
    instead of the arch specific solution that was added by a previous
    commit.
    
    Don fixed an issue where it was possible that a system reset could occur
    when we were holding the SWFW semaphore lock, which the next time the
    driver loaded would see it incorrectly as locked.
    
    v2: updated patch 8 of the series to include a minor flags issue where
        we had lost NETIF_F_HW_TC and we were setting NETIF_F_SCTP_CRC in
        two different areas, when we only needed/wanted it in one spot.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cb2b3edbece804d9836647c1ca51282ad384d425
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Wed Jan 13 07:31:17 2016 -0800

    ixgbevf: Add support for generic Tx checksums
    
    This patch adds support for generic Tx checksums to the ixgbevf driver.  It
    turns out this is actually pretty easy after going over the datasheet as we
    were doing a number of steps we didn't need to.
    
    In order to perform a Tx checksum for an L4 header we need to fill in the
    following fields in the Tx descriptor:
      MACLEN (maximum of 127), retrieved from:
                    skb_network_offset()
      IPLEN  (maximum of 511), retrieved from:
                    skb_checksum_start_offset() - skb_network_offset()
      TUCMD.L4T indicates offset and if checksum or crc32c, based on:
                    skb->csum_offset
    
    The added advantage to doing this is that we can support inner checksum
    offloads for tunnels and MPLS while still being able to transparently
    insert VLAN tags.
    
    I also took the opportunity to clean-up many of the feature flag
    configuration bits to make them a bit more consistent between drivers.  In
    the case of the VF drivers this meant adding support for SCTP CRCs, and
    inner checksum offloads for MPLS and various tunnel types.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 96c0e0a908ecfa61118d49db85c03e162b7f6e20
Author: Andy Lutomirski <luto@kernel.org>
Date:   Tue Mar 22 14:25:07 2016 -0700

    net/sctp: use in_compat_syscall for sctp_getsockopt_connectx3
    
    SCTP unfortunately has a different ABI for SCTP_SOCKOPT_CONNECTX3 for
    32-bit and 64-bit callers.  Use in_compat_syscall to correctly
    distinguish them on all architectures.
    
    Signed-off-by: Andy Lutomirski <luto@kernel.org>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: David Miller <davem@davemloft.net>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

commit 1f2a65a223b690c8b71f22d0c9bc6851324e6073
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Aug 27 04:52:20 2015 +0800

    sctp: donot reset the overall_error_count in SHUTDOWN_RECEIVE state
    
    commit f648f807f61e64d247d26611e34cc97e4ed03401 upstream.
    
    Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    fixed a problem with excessive retransmissions in the SHUTDOWN_PENDING by not
    resetting the association overall_error_count.  This allowed the association
    to better enforce assoc.max_retrans limit.
    
    However, the same issue still exists when the association is in SHUTDOWN_RECEIVED
    state.  In this state, HB-ACKs will continue to reset the overall_error_count
    for the association would extend the lifetime of association unnecessarily.
    
    This patch solves this by resetting the overall_error_count whenever the current
    state is small then SCTP_STATE_SHUTDOWN_PENDING.  As a small side-effect, we
    end up also handling SCTP_STATE_SHUTDOWN_ACK_SENT and SCTP_STATE_SHUTDOWN_SENT
    states, but they are not really impacted because we disable Heartbeats in those
    states.
    
    Fixes: Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit 3822a5ff4bc32043fa9c7b6d6f125bcdca6da39c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Sat Mar 19 12:17:20 2016 -0300

    sctp: align MTU to a word
    
    SCTP is a protocol that is aligned to a word (4 bytes). Thus using bare
    MTU can sometimes return values that are not aligned, like for loopback,
    which is 65536 but ipv4_mtu() limits that to 65535. This mis-alignment
    will cause the last non-aligned bytes to never be used and can cause
    issues with congestion control.
    
    So it's better to just consider a lower MTU and keep congestion control
    calcs saner as they are based on PMTU.
    
    Same applies to icmp frag needed messages, which is also fixed by this
    patch.
    
    One other effect of this is the inability to send MTU-sized packet
    without queueing or fragmentation and without hitting Nagle. As the
    check performed at sctp_packet_can_append_data():
    
    if (chunk->skb->len + q->out_qlen >= transport->pathmtu - packet->overhead)
            /* Enough data queued to fill a packet */
            return SCTP_XMIT_OK;
    
    with the above example of MTU, if there are no other messages queued,
    one cannot send a packet that just fits one packet (65532 bytes) and
    without causing DATA chunk fragmentation or a delay.
    
    v2:
     - Added WORD_TRUNC macro
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 491026eeac53c3a4337c3ba06787b2d7ea7b93f8
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 2.6.32:
     - Net namespaces are not used
     - Keep using sctp_bh_{,un}lock_sock()
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 9531ab65f4ec066a6e6617a08a293c60397a161b
Merge: 26e9093110fb 10016594f4c6
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 9 16:36:16 2016 -0500

    Merge branch 'kcm'
    
    Tom Herbert says:
    
    ====================
    kcm: Kernel Connection Multiplexor (KCM)
    
    Kernel Connection Multiplexor (KCM) is a facility that provides a
    message based interface over TCP for generic application protocols.
    The motivation for this is based on the observation that although
    TCP is byte stream transport protocol with no concept of message
    boundaries, a common use case is to implement a framed application
    layer protocol running over TCP. To date, most TCP stacks offer
    byte stream API for applications, which places the burden of message
    delineation, message I/O operation atomicity, and load balancing
    in the application. With KCM an application can efficiently send
    and receive application protocol messages over TCP using a
    datagram interface.
    
    In order to delineate message in a TCP stream for receive in KCM, the
    kernel implements a message parser. For this we chose to employ BPF
    which is applied to the TCP stream. BPF code parses application layer
    messages and returns a message length. Nearly all binary application
    protocols are parsable in this manner, so KCM should be applicable
    across a wide range of applications. Other than message length
    determination in receive, KCM does not require any other application
    specific awareness. KCM does not implement any other application
    protocol semantics-- these are are provided in userspace or could be
    implemented in a kernel module layered above KCM.
    
    KCM implements an NxM multiplexor in the kernel as diagrammed below:
    
    +------------+   +------------+   +------------+   +------------+
    | KCM socket |   | KCM socket |   | KCM socket |   | KCM socket |
    +------------+   +------------+   +------------+   +------------+
          |                 |               |                |
          +-----------+     |               |     +----------+
                      |     |               |     |
                   +----------------------------------+
                   |           Multiplexor            |
                   +----------------------------------+
                     |   |           |           |  |
           +---------+   |           |           |  ------------+
           |             |           |           |              |
    +----------+  +----------+  +----------+  +----------+ +----------+
    |  Psock   |  |  Psock   |  |  Psock   |  |  Psock   | |  Psock   |
    +----------+  +----------+  +----------+  +----------+ +----------+
          |              |           |            |             |
    +----------+  +----------+  +----------+  +----------+ +----------+
    | TCP sock |  | TCP sock |  | TCP sock |  | TCP sock | | TCP sock |
    +----------+  +----------+  +----------+  +----------+ +----------+
    
    The KCM sockets provide the datagram interface to applications,
    Psocks are the state for each attached TCP connection (i.e. where
    message delineation is performed on receive).
    
    A description of the APIs and design can be found in the included
    Documentation/networking/kcm.txt.
    
    In this patch set:
    
      - Add MSG_BATCH flag. This is used in sendmsg msg_hdr flags to
        indicate that more messages will be sent on the socket. The stack
        may batch messages up if it is beneficial for transmission.
      - In sendmmsg, set MSG_BATCH in all sub messages except for the last
        one.
      - In order to allow sendmmsg to contain multiple messages with
        SOCK_SEQPAKET we allow each msg_hdr in the sendmmsg to set MSG_EOR.
      - Add KCM module
        - This supports SOCK_DGRAM and SOCK_SEQPACKET.
      - KCM documentation
    
    v2:
      - Added splice and page operations.
      - Assemble receive messages in place on TCP socket (don't have a
        separate assembly queue.
      - Based on above, enforce maxmimum receive message to be the size
        of the recceive socket buffer.
      - Support message assembly timeout. Use the timeout value in
        sk_rcvtimeo on the TCP socket.
      - Tested some with a couple of other production applications,
        see ~5% improvement in application latency.
    
    Testing:
    
    Dave Watson has integrated KCM into Thrift and we intend to put these
    changes into open source. Example of this is in:
    
    https://github.com/djwatson/fbthrift/commit/
    dd7e0f9cf4e80912fdb90f6cd394db24e61a14cc
    
    Some initial KCM Thrift benchmark numbers (comment from Dave)
    
    Thrift by default ties a single connection to a single thread.  KCM is
    instead able to load balance multiple connections across multiple epoll
    loops easily.
    
    A test sending ~5k bytes of data to a kcm thrift server, dropping the
    bytes on recv:
    
    QPS     Latency / std dev Latency
      without KCM
        70336     209/123
      with KCM
        70353     191/124
    
    A test sending a small request, then doing work in the epoll thread,
    before serving more requests:
    
    QPS     Latency / std dev Latency
    without KCM
        14282     559/602
    with KCM
        23192     344/234
    
    At the high end, there's definitely some additional kernel overhead:
    
    Cranking the pipelining way up, with lots of small requests
    
    QPS     Latency / std dev Latency
    without KCM
       1863429     127/119
    with KCM
       1337713     192/241
    
    ---
    
    So for a "realistic" workload, KCM performs pretty well (second case).
    Under extreme conditions of highest tps we still have some work to do.
    In its nature a multiplexor will spread work between CPUs which is
    logically good for load balancing but coan conflict with the goal
    promoting affinity. Batching messages on both send and receive are
    the means to recoup performance.
    
    Future support:
    
     - Integration with TLS (TLS-in-kernel is a separate initiative).
     - Page operations/splice support
     - Unconnected KCM sockets. Will be able to attach sockets to different
       destinations, AF_KCM addresses with be used in sendmsg and recvmsg
       to indicate destination
     - Explore more utility in performing BPF inline with a TCP data stream
       (setting SO_MARK, rxhash for messages being sent received on
       KCM sockets).
     - Performance work
       - Diagnose performance issues under high message load
    
    FAQ (Questions posted on LWN)
    
    Q: Why do this in the kernel?
    
    A: Because the kernel is good at scheduling threads and steering packets
       to threads. KCM fits well into this model since it allows the unit
       of work for scheduling and steering to be the application layer
       messages themselves. KCM should be thought of as generic application
       protocol acceleration. It to the philosophy that the kernel provides
       generic and extensible interfaces.
    
    Q: How can adding code in the path yield better performance?
    
    A: It is true that for just sending receiving a single message there
       would be some performance loss since the code path is longer (for
       instance comparing netperf to KCM). But for real production
       applications performance takes on many dynamics. Parallelism, context
       switching, affinity, granularity of locking, and load balancing are
       all relevant. The theory of KCM is that by an application-centric
       interface, the kernel can provide better support for these
       performance characteristics.
    
    Q: Why not use an existing message-oriented protocol such as RUDP,
       DCCP, SCTP, RDS, and others?
    
    A: Because that would entail using a completely new transport protocol.
       Deploying a new protocol at scale is either a huge undertaking or
       fundamentally infeasible. This is true in either the Internet and in
       the data center due in a large part to protocol ossification.
       Besides, KCM we want KCM to work existing, well deployed application
       protocols that we couldn't change even if we wanted to (e.g. http/2).
    
       KCM simply defines a new interface method, it does not redefine any
       aspect of the transport protocol nor application protocol, nor set
       any new requirements on these. Neither does KCM attempt to implement
       any application protocol logic other than message deliniation in the
       stream. These are fundamental requirement of KCM.
    
    Q: How does this affect TCP?
    
    A: It doesn't, not in the slightest. The use of KCM can be one-sided,
       KCM has no effect on the wire.
    
    Q: Why force TCP into doing something it's not designed for?
    
    A: TCP is defined as transport protocol and there is no standard that
       says the API into TCP must be stream based sockets, or for that
       matter sockets at all (or even that TCP needs to be implemented in a
       kernel). KCM is not inconsistent with the design of TCP just because
       to makes an message based interface over TCP, if it were then every
       application protocol sending messages over TCP would also be! :-)
    
    Q: What about the problem of a connections with very slow rate of
       incoming data? As a result your application can get storms of very
       short reads. And it actually happens a lot with connection from
       mobile devices and it is a problem for servers handling a lot of
       connections.
    
    A: The storm of short reads will occur regardless of whether KCM is used
       or not. KCM does have one advantage in this scenario though, it will
       only wake up the application when a full message has been received,
       not for each packet that makes up part of a bigger messages. If a
       bunch of small messages are received, the application can receive
       messages in batches using recvmmsg.
    
    Q: Why not just use DPDK, or at least provide KCM like functionality in
       DPDK?
    
    A: DPDK, or more generally OS bypass presumably with a TCP stack in
       userland, presents a different model of load balancing than that of
       KCM (and the kernel). KCM implements load balancing of messages
       across the threads of an application, whereas DPDK load balances
       based on queues which are more static and coarse-grained since
       multiple connections are bound to queues. DPDK works best when
       processing of packets is silo'ed in a thread on the CPU processing
       a queue, and packet processing (for both the stack and application)
       is fairly uniform. KCM works well for applications where the amount
       of work to process messages varies an application work is commonly
       delegated to worker threads often on different CPUs.
    
       The message based interface over TCP is something that could be
       provide by a DPDK or OS bypass library.
    
    Q: I'm not quite seeing this for HTTP. Maybe for HTTP/2, I guess, or web
       sockets?
    
    A: Yes. KCM is most appropriate for message based protocols over TCP
       where is easy to deduce the message length (e.g. a length field)
       and the protocol implements its own message ordering semantics.
       Fortunately this encompasses many modern protocols.
    
    Q: How is memory limited and controlled?
    
    A: In v2 all data for messages is now kept in socket buffers, either
       those for TCP or KCM, so socket buffer limits are applicable.
       This includes receive messages assembly which is now done ont teh
       TCP socket buffer instead of a separate queue-- this has the
       consequence that the TCP socket buffer limit provides an
       enforceable maxmimum message size.
    
       Additionally, a timeout may be set for messages assembly. The
       value used for this is taken from sk_rcvtimeo of the TCP socket.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6e13e7b0183e0b9945ff350bd5fad573c2ece83c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    [ Upstream commit 27f7ed2b11d42ab6d796e96533c2076ec220affc ]
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 293c41f89596fb17bd3963f9f240000e8ab462ac
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    [ Upstream commit 27f7ed2b11d42ab6d796e96533c2076ec220affc ]
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 63593b05a47bd00a5dd843f836762829791bbc92
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    [ Upstream commit 27f7ed2b11d42ab6d796e96533c2076ec220affc ]
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 6497c7e6400105424a7d1dddc3f3aadcc8e3588a
Author: Deepa Dinamani <deepa.kernel@gmail.com>
Date:   Sat Feb 27 00:32:17 2016 -0800

    net: sctp: Convert log timestamps to be y2038 safe
    
    SCTP probe log timestamps use struct timespec which is
    not y2038 safe.
    Use struct timespec64 which is 2038 safe instead.
    
    Use monotonic time instead of real time as only time
    differences are logged.
    
    Signed-off-by: Deepa Dinamani <deepa.kernel@gmail.com>
    Reviewed-by: Arnd Bergmann <arnd@arndb.de>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: "David S. Miller" <davem@davemloft.net>
    Cc: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b3efe4725b6d87ef5f1a3e4ba08bbfa20d069e2c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    commit 27f7ed2b11d42ab6d796e96533c2076ec220affc upstream.
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: drop the second hunk as we don't have SCTP_SNDINFO
     cmsg support]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9e4e69cbeebc2a1259094c645510e2fccc7e1ac8
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    commit 27f7ed2b11d42ab6d796e96533c2076ec220affc upstream.
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [ luis: backported to 3.16:
      - dropped changes to SCTP_SNDINFO case ]
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit ea6ce6024f9397ff2667fe16447447e622bc4c31
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Wed Jan 13 07:31:30 2016 -0800

    igbvf: Add support for generic Tx checksums
    
    This patch adds support for generic Tx checksums to the igbvf driver.  It
    turns out this is actually pretty easy after going over the datasheet as we
    were doing a number of steps we didn't need to.
    
    In order to perform a Tx checksum for an L4 header we need to fill in the
    following fields in the Tx descriptor:
      MACLEN (maximum of 127), retrieved from:
                    skb_network_offset()
      IPLEN  (maximum of 511), retrieved from:
                    skb_checksum_start_offset() - skb_network_offset()
      TUCMD.L4T indicates offset and if checksum or crc32c, based on:
                    skb->csum_offset
    
    The added advantage to doing this is that we can support inner checksum
    offloads for tunnels and MPLS while still being able to transparently
    insert VLAN tags.
    
    I also took the opportunity to clean-up many of the feature flag
    configuration bits to make them a bit more consistent between drivers.  In
    the case of the VF drivers this meant adding support for SCTP CRCs, and
    inner checksum offloads for MPLS and various tunnel types.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Tested-by: Aaron Brown <aaron.f.brown@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit dea08e604408d0303e2332896c5fdd8c1f7d79a2
Merge: 5c102d0eca3c d856626d3b05
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Feb 22 12:18:07 2016 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Looks like a lot, but mostly driver fixes scattered all over as usual.
    
      Of note:
    
       1) Add conditional sched in nf conntrack in cleanup to avoid NMI
          watchdogs.  From Florian Westphal.
    
       2) Fix deadlock in nfnetlink cttimeout, also from Floarian.
    
       3) Fix handling of slaves in bonding ARP monitor validation, from Jay
          Vosburgh.
    
       4) Callers of ip_cmsg_send() are responsible for freeing IP options,
          some were not doing so.  Fix from Eric Dumazet.
    
       5) Fix per-cpu bugs in mvneta driver, from Gregory CLEMENT.
    
       6) Fix vlan handling in mv88e6xxx DSA driver, from Vivien Didelot.
    
       7) bcm7xxx PHY driver bug fixes from Florian Fainelli.
    
       8) Avoid unaligned accesses to protocol headers wrt.  GRE, from
          Alexander Duyck.
    
       9) SKB leaks and other problems in arc_emac driver, from Alexander
          Kochetkov.
    
      10) tcp_v4_inbound_md5_hash() releases listener socket instead of
          request socket on error path, oops.  Fix from Eric Dumazet.
    
      11) Missing socket release in pppoe_rcv_core() that seems to have
          existed basically forever.  From Guillaume Nault.
    
      12) Missing slave_dev unregister in dsa_slave_create() error path,
          from Florian Fainelli.
    
      13) crypto_alloc_hash() never returns NULL, fix return value check in
          __tcp_alloc_md5sig_pool.  From Insu Yun.
    
      14) Properly expire exception route entries in ipv4, from Xin Long.
    
      15) Fix races in tcp/dccp listener socket dismantle, from Eric
          Dumazet.
    
      16) Don't set IFF_TX_SKB_SHARING in vxlan, geneve, or GRE, it's not
          legal.  These drivers modify the SKB on transmit.  From Jiri Benc.
    
      17) Fix regression in the initialziation of netdev->tx_queue_len.
          From Phil Sutter.
    
      18) Missing unlock in tipc_nl_add_bc_link() error path, from Insu Yun.
    
      19) SCTP port hash sizing does not properly ensure that table is a
          power of two in size.  From Neil Horman.
    
      20) Fix initializing of software copy of MAC address in fmvj18x_cs
          driver, from Ken Kawasaki"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (129 commits)
      bnx2x: Fix 84833 phy command handler
      bnx2x: Fix led setting for 84858 phy.
      bnx2x: Correct 84858 PHY fw version
      bnx2x: Fix 84833 RX CRC
      bnx2x: Fix link-forcing for KR2
      net: ethernet: davicom: fix devicetree irq resource
      fmvj18x_cs: fix incorrect indexing of dev->dev_addr[] when copying the MAC address
      Driver: Vmxnet3: Update Rx ring 2 max size
      net: netcp: rework the code for get/set sw_data in dma desc
      soc: ti: knav_dma: rename pad in struct knav_dma_desc to sw_data
      net: ti: netcp: restore get/set_pad_info() functionality
      MAINTAINERS: Drop myself as xen netback maintainer
      sctp: Fix port hash table size computation
      can: ems_usb: Fix possible tx overflow
      Bluetooth: hci_core: Avoid mixing up req_complete and req_complete_skb
      net: bcmgenet: Fix internal PHY link state
      af_unix: Don't use continue to re-execute unix_stream_read_generic loop
      unix_diag: fix incorrect sign extension in unix_lookup_by_ino
      bnxt_en: Failure to update PHY is not fatal condition.
      bnxt_en: Remove unnecessary call to update PHY settings.
      ...

commit f608e6a60fc85e4f261daab5e7aac6225e2120d6
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Sun Jan 24 21:17:57 2016 -0800

    i40evf: Update feature flags to reflect newly enabled features
    
    Recent changes should have enabled support for IPv6 based tunnels and
    support for TSO with outer UDP checksums.  As such we can update the
    feature flags to reflect that.
    
    In addition we can clean-up the flags that aren't needed such as SCTP and
    RXCSUM since having the bits there doesn't add any value.
    
    I also found one spot where we were setting the same flag twice.  It looks
    like it was probably a git merge error that resulted in the line being
    duplicated.  As such I have dropped it in this patch.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Acked-by: Anjali Singhai Jain <anjali.singhai@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit bc5d252b363cca63b7ddc1e20dd8b8b242631006
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Sun Jan 24 21:17:50 2016 -0800

    i40e: Update feature flags to reflect newly enabled features
    
    Recent changes should have enabled support for IPv6 based tunnels and
    support for TSO with outer UDP checksums.  As such we can update the
    feature flags to reflect that.
    
    In addition we can clean-up the flags that aren't needed such as SCTP and
    RXCSUM since having the bits there doesn't add any value.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit b079e7be7daad50d4b8b30776d368b709a4b7aae
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit a655ba1a8c185ef3d8ecc2709df568c1a7840b74
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Net namespaces are not used
     - Keep using sctp_bh_{,un}lock_sock()
     - Adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 5de6ac75d928358063f37c874a91ca1ef28ac308
Merge: 721675fcf277 a1b14d27ed09
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Feb 11 11:00:34 2016 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix BPF handling of branch offset adjustmnets on backjumps, from
        Daniel Borkmann.
    
     2) Make sure selinux knows about SOCK_DESTROY netlink messages, from
        Lorenzo Colitti.
    
     3) Fix openvswitch tunnel mtu regression, from David Wragg.
    
     4) Fix ICMP handling of TCP sockets in syn_recv state, from Eric
        Dumazet.
    
     5) Fix SCTP user hmacid byte ordering bug, from Xin Long.
    
     6) Fix recursive locking in ipv6 addrconf, from Subash Abhinov
        Kasiviswanathan.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      bpf: fix branch offset adjustment on backjumps after patching ctx expansion
      vxlan, gre, geneve: Set a large MTU on ovs-created tunnel devices
      geneve: Relax MTU constraints
      vxlan: Relax MTU constraints
      flow_dissector: Fix unaligned access in __skb_flow_dissector when used by eth_get_headlen
      of: of_mdio: Add marvell, 88e1145 to whitelist of PHY compatibilities.
      selinux: nlmsgtab: add SOCK_DESTROY to the netlink mapping tables
      sctp: translate network order to host order when users get a hmacid
      enic: increment devcmd2 result ring in case of timeout
      tg3: Fix for tg3 transmit queue 0 timed out when too many gso_segs
      net:Add sysctl_max_skb_frags
      tcp: do not drop syn_recv on all icmp reports
      ipv6: fix a lockdep splat
      unix: correctly track in-flight fds in sending process user_struct
      update be2net maintainers' email addresses
      dwc_eth_qos: Reset hardware before PHY start
      ipv6: addrconf: Fix recursive spin lock call

commit e7e9956d8fc3c92e797e7334f2aee31dd9c623f3
Merge: a060679c6b3d f245d079c1d1
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Feb 11 08:55:42 2016 -0500

    Merge branch 'gso-checksums'
    
    Alexander Duyck says:
    
    ====================
    Add GSO support for outer checksum w/ inner checksum offloads
    
    This patch series updates the existing segmentation offload code for
    tunnels to make better use of existing and updated GSO checksum
    computation.  This is done primarily through two mechanisms.  First we
    maintain a separate checksum in the GSO context block of the sk_buff.  This
    allows us to maintain two checksum values, one offloaded with values stored
    in csum_start and csum_offset, and one computed and tracked in
    SKB_GSO_CB(skb)->csum.  By maintaining these two values we are able to take
    advantage of the same sort of math used in local checksum offload so that
    we can provide both inner and outer checksums with minimal overhead.
    
    Below is the performance for a netperf session between an ixgbe PF and VF
    on the same host but in different namespaces.  As can be seen a significant
    gain in performance can be had from allowing the use of Tx checksum offload
    on the inner headers while performing a software offload on the outer
    header computation:
    
     Recv   Send   Send                       Utilization  Service Demand
     Socket Socket Message Elapsed            Send  Recv   Send  Recv
     Size   Size   Size    Time    Throughput local remote local remote
     bytes  bytes  bytes   secs.   10^6bits/s % S   % U    us/KB us/KB
    
    Before:
     87380  16384  16384   10.00   12844.38   9.30  -1.00  0.712 -1.00
    After:
     87380  16384  16384   10.00   13216.63   6.78  -1.00  0.504 -1.000
    
    Changes from v1:
    * Dropped use of CHECKSUM_UNNECESSARY for remote checksum offload
    * Left encap_hdr_csum as it will likely be needed in future for SCTP GSO
    * Broke the changes out over many more patches
    * Updated GRE segmentation to more closely match UDP tunnel segmentation
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f245d079c1d11dc6927e56f5a89dd566fef2a415
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Fri Feb 5 15:28:26 2016 -0800

    net: Allow tunnels to use inner checksum offloads with outer checksums needed
    
    This patch enables us to use inner checksum offloads if provided by
    hardware with outer checksums computed by software.
    
    It basically reduces encap_hdr_csum to an advisory flag for now, but based
    on the fact that SCTP may be getting segmentation support before long I
    thought we may want to keep it as it is possible we may need to support
    CRC32c and 1's compliment checksum in the same packet at some point in the
    future.
    
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Acked-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5afdaaa0555257f3c42b141908567d40aca0e1d1
Author: Jesse Brandeburg <jesse.brandeburg@intel.com>
Date:   Thu Dec 10 11:38:50 2015 -0800

    i40e: update features with right offload
    
    Synchronize code bases and add SCTP offload support.
    
    Change-ID: I9f99071f7176225479026930c387bf681a47494e
    Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
    Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit bc09ed7acb3848685326783da943cbbd65bf04e1
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 534e9016cd88ccd577b226b7172e5cd079f5fb02
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    [ Upstream commit 635682a14427d241bab7bbdeebb48a7d7b91638e ]
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c000d76ec0d8bbadb7972b374bcf7ffe34deb592
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7e0e67b0bbd024c074cd9ac61c2a8f8ebb9be619
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: SK_FLAGS_TIMESTAMP is newly defined]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    (cherry picked from commit d85242d91610acbe4f905624a5758a01ae7bb32c)
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 0ee4375197988ba13f7b055cee71d5bdbe5ee658
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 upstream.
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    (cherry picked from commit 98d37e7fed9568f37d4a4a150a3773cfafef91ed)
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 141dd0e9a9b2ab7a76ca9b4ee519897a5d6172c4
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4a3411cc43643e671f885fb505a48b43564bc6d5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 26e0e9c2b06c3d9cc62ac25c1e410642205234f1
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit a3a3b65719fba1a9eca2224feb4a93fda3b2913a
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    commit 068d8bd338e855286aea54e70d1c101569284b21 upstream.
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 7bb8b4ae0a88f9bbaa492fdc9dd5b52045a19692
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    [ Upstream commit 068d8bd338e855286aea54e70d1c101569284b21 ]
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 6b1a4c8425acde6b3725e9ca5dc7af544c656fda
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    commit 635682a14427d241bab7bbdeebb48a7d7b91638e upstream.
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 27f7ed2b11d42ab6d796e96533c2076ec220affc
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 22 18:29:49 2016 -0200

    sctp: allow setting SCTP_SACK_IMMEDIATELY by the application
    
    This patch extends commit b93d6471748d ("sctp: implement the sender side
    for SACK-IMMEDIATELY extension") as it didn't white list
    SCTP_SACK_IMMEDIATELY on sctp_msghdr_parse(), causing it to be
    understood as an invalid flag and returning -EINVAL to the application.
    
    Note that the actual handling of the flag is already there in
    sctp_datamsg_from_user().
    
    https://tools.ietf.org/html/rfc7053#section-7
    
    Fixes: b93d6471748d ("sctp: implement the sender side for SACK-IMMEDIATELY extension")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 93007b5bb119f825dfd59700a005ea21905838d4
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 83eb235f81c20dc413e08ebfba19d246cddea03c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4409b3342438059de28e8179b6e16747b9e9518c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    [ Upstream commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 ]
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 683f40ec958e669b0d376a0d83c0213783ee7f99
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2e2b937a300e338bbe6c131181a97af17a9eb15e
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 497d78eab755c11adf31fbb3fdbaf27c16f758aa
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    [ Upstream commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 ]
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 85229251bb79bc6e867b78b7673d035f651015d0
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 548041a38c62684077b4dc85adec814faac193e7
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f580d5c5de89593d6d3785340979df61c972769d
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    [ Upstream commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 ]
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a8fa15f0be8c6d2c03afce5f09d5e96c0aec4eb8
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a286e9c08a0700f114b40dffe5d21992f8fda45d
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 62c8fcbdf619bf5c1c7f666cefefb88401904203
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 33fbe78ae82b7750da133439043847d0f79cb5ae
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 622af8c8e93802e9ae2cdde93563c69a68feeccb
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3fb28c97238bc1ddd66229bb6d2bc07b2452c6ab
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d6d2547876dd3c44d1359c522d2943f05b2d44bf
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 34c664a49b82ce45cb5299ab683ee2c523ab0d57
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 348058993dbe9778123657fb0b790ae43966688c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    [ Upstream commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 ]
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 649621e3d54439ae232d726d7beef295d3887a68
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Jan 8 11:00:54 2016 -0200

    sctp: fix use-after-free in pr_debug statement
    
    Dmitry Vyukov reported a use-after-free in the code expanded by the
    macro debug_post_sfx, which is caused by the use of the asoc pointer
    after it was freed within sctp_side_effect() scope.
    
    This patch fixes it by allowing sctp_side_effect to clear that asoc
    pointer when the TCB is freed.
    
    As Vlad explained, we also have to cover the SCTP_DISPOSITION_ABORT case
    because it will trigger DELETE_TCB too on that same loop.
    
    Also, there were places issuing SCTP_CMD_INIT_FAILED and ASSOC_FAILED
    but returning SCTP_DISPOSITION_CONSUME, which would fool the scheme
    above. Fix it by returning SCTP_DISPOSITION_ABORT instead.
    
    The macro is already prepared to handle such NULL pointer.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 332c94ea5738e2599dcd0cd3adf1b5278a0c5615
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit b090e587cf43ea57d21ab91535e1ff070aaa1cea
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit b79759978ed04ed1c4887826b43a653da35f32b8
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    [ Upstream commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 ]
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit d7ca7e9c04e8f46c161b0edb9219ed364a233338
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 228b4355ab34de202f0a12e8daab1507da3d3024
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 09a007f991a7ea621b3ab5682d005225b6da5236
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    commit 9470e24f35ab81574da54e69df90c1eb4a96b43f upstream.
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 954f566280f49b7b6b2b6a3d44fbb9b7cbf61a0c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    commit 01ce63c90170283a9855d1db4fe81934dddce648 upstream.
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit fae4fd50bb11452adde869403fa7bbbdebe2624e
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872 upstream.
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 068d8bd338e855286aea54e70d1c101569284b21
Author: Xin Long <lucien.xin@gmail.com>
Date:   Tue Dec 29 17:49:25 2015 +0800

    sctp: sctp should release assoc when sctp_make_abort_user return NULL in sctp_close
    
    In sctp_close, sctp_make_abort_user may return NULL because of memory
    allocation failure. If this happens, it will bypass any state change
    and never free the assoc. The assoc has no chance to be freed and it
    will be kept in memory with the state it had even after the socket is
    closed by sctp_close().
    
    So if sctp_make_abort_user fails to allocate memory, we should abort
    the asoc via sctp_primitive_ABORT as well. Just like the annotation in
    sctp_sf_cookie_wait_prm_abort and sctp_sf_do_9_1_prm_abort said,
    "Even if we can't send the ABORT due to low memory delete the TCB.
    This is a departure from our typical NOMEM handling".
    
    But then the chunk is NULL (low memory) and the SCTP_CMD_REPLY cmd would
    dereference the chunk pointer, and system crash. So we should add
    SCTP_CMD_REPLY cmd only when the chunk is not NULL, just like other
    places where it adds SCTP_CMD_REPLY cmd.
    
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5c85649e8da22945f8e4616717543991a81bfba2
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    [ Upstream commit 9470e24f35ab81574da54e69df90c1eb4a96b43f ]
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d85242d91610acbe4f905624a5758a01ae7bb32c
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    [ Upstream commit 01ce63c90170283a9855d1db4fe81934dddce648 ]
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: SK_FLAGS_TIMESTAMP is newly defined]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit dfc263fdf39a48ac2190c166af9377acba086531
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 98d37e7fed9568f37d4a4a150a3773cfafef91ed
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 upstream.
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit dc18247098f770f5a959c46587f79c4da3912a4c
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 upstream.
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 73796d8bf27372e26c2b79881947304c14c2d353
Merge: ce42af94aadc ac5cc977991d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Dec 17 14:05:22 2015 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix uninitialized variable warnings in nfnetlink_queue, a lot of
        people reported this...  From Arnd Bergmann.
    
     2) Don't init mutex twice in i40e driver, from Jesse Brandeburg.
    
     3) Fix spurious EBUSY in rhashtable, from Herbert Xu.
    
     4) Missing DMA unmaps in mvpp2 driver, from Marcin Wojtas.
    
     5) Fix race with work structure access in pppoe driver causing
        corruptions, from Guillaume Nault.
    
     6) Fix OOPS due to sh_eth_rx() not checking whether netdev_alloc_skb()
        actually succeeded or not, from Sergei Shtylyov.
    
     7) Don't lose flags when settifn IFA_F_OPTIMISTIC in ipv6 code, from
        Bjrn Mork.
    
     8) VXLAN_HD_RCO defined incorrectly, fix from Jiri Benc.
    
     9) Fix clock source used for cookies in SCTP, from Marcelo Ricardo
        Leitner.
    
    10) aurora driver needs HAS_DMA dependency, from Geert Uytterhoeven.
    
    11) ndo_fill_metadata_dst op of vxlan has to handle ipv6 tunneling
        properly as well, from Jiri Benc.
    
    12) Handle request sockets properly in xfrm layer, from Eric Dumazet.
    
    13) Double stats update in ipv6 geneve transmit path, fix from Pravin B
        Shelar.
    
    14) sk->sk_policy[] needs RCU protection, and as a result
        xfrm_policy_destroy() needs to free policies using an RCU grace
        period, from Eric Dumazet.
    
    15) SCTP needs to clone ipv6 tx options in order to avoid use after
        free, from Eric Dumazet.
    
    16) Missing kbuild export if ila.h, from Stephen Hemminger.
    
    17) Missing mdiobus_alloc() return value checking in mdio-mux.c, from
        Tobias Klauser.
    
    18) Validate protocol value range in ->create() methods, from Hannes
        Frederic Sowa.
    
    19) Fix early socket demux races that result in illegal dst reuse, from
        Eric Dumazet.
    
    20) Validate socket address length in pptp code, from WANG Cong.
    
    21) skb_reorder_vlan_header() uses incorrect offset and can corrupt
        packets, from Vlad Yasevich.
    
    22) Fix memory leaks in nl80211 registry code, from Ola Olsson.
    
    23) Timeout loop count handing fixes in mISDN, xgbe, qlge, sfc, and
        qlcnic.  From Dan Carpenter.
    
    24) msg.msg_iocb needs to be cleared in recvfrom() otherwise, for
        example, AF_ALG will interpret it as an async call.  From Tadeusz
        Struk.
    
    25) inetpeer_set_addr_v4 forgets to initialize the 'vif' field, from
        Eric Dumazet.
    
    26) rhashtable enforces the minimum table size not early enough,
        breaking how we calculate the per-cpu lock allocations.  From
        Herbert Xu.
    
    27) Fix FCC port lockup in 82xx driver, from Martin Roth.
    
    28) FOU sockets need to be freed using RCU, from Hannes Frederic Sowa.
    
    29) Fix out-of-bounds access in __skb_complete_tx_timestamp() and
        sock_setsockopt() wrt.  timestamp handling.  From WANG Cong.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (117 commits)
      net: check both type and procotol for tcp sockets
      drivers: net: xgene: fix Tx flow control
      tcp: restore fastopen with no data in SYN packet
      af_unix: Revert 'lock_interruptible' in stream receive code
      fou: clean up socket with kfree_rcu
      82xx: FCC: Fixing a bug causing to FCC port lock-up
      gianfar: Don't enable RX Filer if not supported
      net: fix warnings in 'make htmldocs' by moving macro definition out of field declaration
      rhashtable: Fix walker list corruption
      rhashtable: Enforce minimum size on initial hash table
      inet: tcp: fix inetpeer_set_addr_v4()
      ipv6: automatically enable stable privacy mode if stable_secret set
      net: fix uninitialized variable issue
      bluetooth: Validate socket address length in sco_sock_bind().
      net_sched: make qdisc_tree_decrease_qlen() work for non mq
      ser_gigaset: remove unnecessary kfree() calls from release method
      ser_gigaset: fix deallocation of platform device structure
      ser_gigaset: turn nonsense checks into WARN_ON
      ser_gigaset: fix up NULL checks
      qlcnic: fix a timeout loop
      ...

commit 6857a02af5386e9f5d11734363741dbe6b0a6959
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 15 15:33:39 2015 -0800

    sctp: use GFP_KERNEL in sctp_init()
    
    modules init functions being called from process context, we better
    use GFP_KERNEL allocations to increase our chances to get these
    high-order pages we want for SCTP hash tables.
    
    This mostly matters if SCTP module is loaded once memory got fragmented.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 93d085d222de7b8e7c7794dbd800c6a39df2eae2
Merge: b4bc88a868ed 7a6ae71b2490
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Dec 15 16:50:28 2015 -0500

    Merge branch 'end-of-ip-csum'
    
    Tom Herbert says:
    
    ====================
    net: The beginning of the end for NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM
    
    Background:
    
    This patch set starts to address one front in the battle against
    protocol ossification. Protocol ossification describes the state
    that we have arrived at in the evolution of the Internet where we are
    materially limited to only using a very narrow range of protocols
    and protocol features. For instance, only TCP and UDP is sufficiently
    supported on the Internet so that deploying alternative protocols,
    such as SCTP and DCCP, are non-starters. Similarly, IP options and IPv6
    extension headers are typically not considered feasible for wide
    deployment, so we have loss the extensibility of IP protocols.
    
    Protocol ossification is not only a problem on the Internet, but in
    the data center as well. A root cause of this seems to be narrow,
    protocol specific optimizations implemented in switches (for doing
    EMCP) and in NICs (NIC offloads). These tend to be performance
    optimization around TCP and UDP packets, and these have become
    requirements to implement performant network solutions at scale.
    
    Attempts to deal with protocol ossification in data center have yielded
    ad hoc, sub-optimal solutions. A main driver of foo-over-UDP (e.g.
    GRE/UDP, MPLS/UDP) is to leverage the existing EMCP and RSS support for
    UDP by setting the source port as an entropy value. This has seen some
    success, but the cost of additional overhead and layering limits its
    usefulness.  An even more extreme solution is STT where non-TCP packets
    are spoofed as TCP to leverage NIC offloads.
    
    This patch set endeavours to address protocol ossification caused by
    techniques used in transmit checksum offload for NICs. Future work
    will address protocol ossification in the other primary NIC offloads--
    namely receive checksum offload, LSO, LRO, and RSS.
    
    NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM:
    
    NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM exemplify the problem of protocol
    ossification. These features are relics from a simpler time in the
    Internet, before encapsulation, before GRE and  IPIP. Many hardware
    vendors only saw the need to provide checksum offload for simple UDP and
    TCP packets over IPv4 (IPv6 support is an afterthought also). In today's
    Internet and data centers, checksum offload is well established as a
    valuable feature, but we can no longer afford to be contsrained to
    use a handful of protocols and features that are supported at the
    discretion of NIC vendors. Generic and protocol agnostic methods are
    needed.
    
    The actual interface that the stack uses with drivers for checksum
    offload is CHECKSUM_PARTIAL. This is a generic and protocol agnostic
    interface. A driver for a device that supports this generic
    interface advertises NETIF_F_HW_CSUM.
    
    Goals of this patch set:
    
    We propose that drivers advertise NETIF_F_HW_CSUM instead of protocol
    specific values of NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM.  If the
    driver's device is constrained (for instance it can only offlaod simple
    IPv4 and IPv6 packets) then these constraints can be checked in the
    transmit path and skb_checksum_help would be called for packets that the
    driver is unable to offload. In order to facilitate this, we add some
    helper functions that takes a specification argument indicating the
    type of packets a device is able to offload. If a packet does not match
    the specification, the helper function calls skb_checksum_help.
    
    Benefits of this approach are:
      - Simplify the stack and clarify the interface for checksum offload
      - Encourage NIC vendors to implement the generic. protocol agnostic
        checksum offload methods in hardware
      - Encourage feature parity in NIC offloads for IPv4 and IPv6
    
    Many drivers advertise NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM and it
    probably isn't feasible to convert them all in a given time frame
    (although if we could this would be a great simplification to the
    stack). A reasonable direction may be to declare that new drivers must
    use NETIF_F_HW_CSUM as NETIF_F_IP_CSUM and NETIF_F_IPV6_CSUM are
    considered deprecated.
    
    There is a class of drivers that should now be converted to advertise
    NETIF_F_HW_CSUM, namely those that support offload of ecapsulated
    checksums. These drivers have to date been using skb->encapsulation
    to infer that checksum offload is being performed for an encapsulated
    checksum. This is strictly not correct. skb->encapsulation
    indicates that the inner headers are valid in the skbuff, whereas
    the stack indicates checksum offload arguments exclusively in csum_start
    and csum_offset. At some point we may want to set the inner headers for
    an skbuff but offload the outer transport checksum, so this needs to be
    fixed.
    
    In this patch set:
    
      - Rename some of constants involved in checksum offload to be more
        reflective of their function
      - Eliminate NETIF_F_GEN_CSUM and NETIF_F_V[46]_CSUM entirely as
        unnecessary convolutions
      - Fix conditions in tcp_sendpage and tcp_sendmsg to take IP protocol
        into account when determining if checksum offload can be done
      - Add driver helper functions for determining if a checksum can
        be offloaded to a device. If not, the helper function can call
        skb_checksum_help
      - Document the checksum offload interface between the stack and
        drivers with detail and specifics
    
    Testing:
    
    Have been testing ixgbe and mlx4. No noticeable regressions seen yet.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 53692b1de419c1b59106909c7f6b4dd3dbc768ac
Author: Tom Herbert <tom@herbertland.com>
Date:   Mon Dec 14 11:19:41 2015 -0800

    sctp: Rename NETIF_F_SCTP_CSUM to NETIF_F_SCTP_CRC
    
    The SCTP checksum is really a CRC and is very different from the
    standards 1's complement checksum that serves as the checksum
    for IP protocols. This offload interface is also very different.
    Rename NETIF_F_SCTP_CSUM to NETIF_F_SCTP_CRC to highlight these
    differences. The term CSUM should be reserved in the stack to refer
    to the standard 1's complement IP checksum.
    
    Signed-off-by: Tom Herbert <tom@herbertland.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7a439c4a677039b91804b6779de18ddab6d6ebf9
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 176cec782335b95d7830bce4a7e6a1fe0b644594
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bec0d96a307590329727d970a3e5d5ebdfb81cf0
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 48bc16884afdaa63f9514c3f5d4dd92240d6f4ff
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cbff65fb298f5b9d147eb39fd4fc540d57748f69
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 32c3ff4e847888df0b54f8ccfb864d01108be38c
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1ced23539f9809cbdb86eed9b9626495720530aa
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    [ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 84564ff43407756dfc7018177d78a0de8d1bd4b2
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    [ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 99c41c611f9edc4266b55102e521c802c59ca24d
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 upstream.
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 9470e24f35ab81574da54e69df90c1eb4a96b43f
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Dec 9 07:25:06 2015 -0800

    ipv6: sctp: clone options to avoid use after free
    
    SCTP is lacking proper np->opt cloning at accept() time.
    
    TCP and DCCP use ipv6_dup_options() helper, do the same
    in SCTP.
    
    We might later factorize this code in a common helper to avoid
    future mistakes.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 01ce63c90170283a9855d1db4fe81934dddce648
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:04 2015 -0200

    sctp: update the netstamp_needed counter when copying sockets
    
    Dmitry Vyukov reported that SCTP was triggering a WARN on socket destroy
    related to disabling sock timestamp.
    
    When SCTP accepts an association or peel one off, it copies sock flags
    but forgot to call net_enable_timestamp() if a packet timestamping flag
    was copied, leading to extra calls to net_disable_timestamp() whenever
    such clones were closed.
    
    The fix is to call net_enable_timestamp() whenever we copy a sock with
    that flag on, like tcp does.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cb5e173ed7c03a0d4630ce68a95a186cce3cc872
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Fri Dec 4 15:14:03 2015 -0200

    sctp: use the same clock as if sock source timestamps were on
    
    SCTP echoes a cookie o INIT ACK chunks that contains a timestamp, for
    detecting stale cookies. This cookie is echoed back to the server by the
    client and then that timestamp is checked.
    
    Thing is, if the listening socket is using packet timestamping, the
    cookie is encoded with ktime_get() value and checked against
    ktime_get_real(), as done by __net_timestamp().
    
    The fix is to sctp also use ktime_get_real(), so we can compare bananas
    with bananas later no matter if packet timestamping was enabled or not.
    
    Fixes: 52db882f3fc2 ("net: sctp: migrate cookie life from timeval to ktime")
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 071f5d105a0ae93aeb02197c4ee3557e8cc57a21
Merge: 2873d32ff493 e3c9b1ef78eb
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Dec 3 16:02:46 2015 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "A lot of Thanksgiving turkey leftovers accumulated, here goes:
    
       1) Fix bluetooth l2cap_chan object leak, from Johan Hedberg.
    
       2) IDs for some new iwlwifi chips, from Oren Givon.
    
       3) Fix rtlwifi lockups on boot, from Larry Finger.
    
       4) Fix memory leak in fm10k, from Stephen Hemminger.
    
       5) We have a route leak in the ipv6 tunnel infrastructure, fix from
          Paolo Abeni.
    
       6) Fix buffer pointer handling in arm64 bpf JIT,f rom Zi Shen Lim.
    
       7) Wrong lockdep annotations in tcp md5 support, fix from Eric
          Dumazet.
    
       8) Work around some middle boxes which prevent proper handling of TCP
          Fast Open, from Yuchung Cheng.
    
       9) TCP repair can do huge kmalloc() requests, build paged SKBs
          instead.  From Eric Dumazet.
    
      10) Fix msg_controllen overflow in scm_detach_fds, from Daniel
          Borkmann.
    
      11) Fix device leaks on ipmr table destruction in ipv4 and ipv6, from
          Nikolay Aleksandrov.
    
      12) Fix use after free in epoll with AF_UNIX sockets, from Rainer
          Weikusat.
    
      13) Fix double free in VRF code, from Nikolay Aleksandrov.
    
      14) Fix skb leaks on socket receive queue in tipc, from Ying Xue.
    
      15) Fix ifup/ifdown crach in xgene driver, from Iyappan Subramanian.
    
      16) Fix clearing of persistent array maps in bpf, from Daniel
          Borkmann.
    
      17) In TCP, for the cross-SYN case, we don't initialize tp->copied_seq
          early enough.  From Eric Dumazet.
    
      18) Fix out of bounds accesses in bpf array implementation when
          updating elements, from Daniel Borkmann.
    
      19) Fill gaps in RCU protection of np->opt in ipv6 stack, from Eric
          Dumazet.
    
      20) When dumping proxy neigh entries, we have to accomodate NULL
          device pointers properly, from Konstantin Khlebnikov.
    
      21) SCTP doesn't release all ipv6 socket resources properly, fix from
          Eric Dumazet.
    
      22) Prevent underflows of sch->q.qlen for multiqueue packet
          schedulers, also from Eric Dumazet.
    
      23) Fix MAC and unicast list handling in bnxt_en driver, from Jeffrey
          Huang and Michael Chan.
    
      24) Don't actively scan radar channels, from Antonio Quartulli"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (110 commits)
      net: phy: reset only targeted phy
      bnxt_en: Setup uc_list mac filters after resetting the chip.
      bnxt_en: enforce proper storing of MAC address
      bnxt_en: Fixed incorrect implementation of ndo_set_mac_address
      net: lpc_eth: remove irq > NR_IRQS check from probe()
      net_sched: fix qdisc_tree_decrease_qlen() races
      openvswitch: fix hangup on vxlan/gre/geneve device deletion
      ipv4: igmp: Allow removing groups from a removed interface
      ipv6: sctp: implement sctp_v6_destroy_sock()
      arm64: bpf: add 'store immediate' instruction
      ipv6: kill sk_dst_lock
      ipv6: sctp: add rcu protection around np->opt
      net/neighbour: fix crash at dumping device-agnostic proxy entries
      sctp: use GFP_USER for user-controlled kmalloc
      sctp: convert sack_needed and sack_generation to bits
      ipv6: add complete rcu protection around np->opt
      bpf: fix allocation warnings in bpf maps and integer overflow
      mvebu: dts: enable IP checksum with jumbo frames for Armada 38x on Port0
      net: mvneta: enable setting custom TX IP checksum limit
      net: mvneta: fix error path for building skb
      ...

commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087
Author: Eric Dumazet <edumazet@google.com>
Date:   Tue Dec 1 07:20:07 2015 -0800

    ipv6: sctp: implement sctp_v6_destroy_sock()
    
    Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
    
    We need to call inet6_destroy_sock() to properly release
    inet6 specific fields.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cacc06215271104b40773c99547c506095db6ad4
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Mon Nov 30 14:32:54 2015 -0200

    sctp: use GFP_USER for user-controlled kmalloc
    
    Dmitry Vyukov reported that the user could trigger a kernel warning by
    using a large len value for getsockopt SCTP_GET_LOCAL_ADDRS, as that
    value directly affects the value used as a kmalloc() parameter.
    
    This patch thus switches the allocation flags from all user-controllable
    kmalloc size to GFP_USER to put some more restrictions on it and also
    disables the warn, as they are not necessary.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Nov 12 13:07:07 2015 +0800

    sctp: translate host order to network order when setting a hmacid
    
    now sctp auth cannot work well when setting a hmacid manually, which
    is caused by that we didn't use the network order for hmacid, so fix
    it by adding the transformation in sctp_auth_ep_set_hmacs.
    
    even we set hmacid with the network order in userspace, it still
    can't work, because of this condition in sctp_auth_ep_set_hmacs():
    
                    if (id > SCTP_AUTH_HMAC_ID_MAX)
                            return -EOPNOTSUPP;
    
    so this wasn't working before and thus it won't break compatibility.
    
    Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4e501862e7ea2694bfaf0b270c6adc4911c4057b
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Aug 27 04:52:20 2015 +0800

    sctp: donot reset the overall_error_count in SHUTDOWN_RECEIVE state
    
    commit f648f807f61e64d247d26611e34cc97e4ed03401 upstream.
    
    Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    fixed a problem with excessive retransmissions in the SHUTDOWN_PENDING by not
    resetting the association overall_error_count.  This allowed the association
    to better enforce assoc.max_retrans limit.
    
    However, the same issue still exists when the association is in SHUTDOWN_RECEIVED
    state.  In this state, HB-ACKs will continue to reset the overall_error_count
    for the association would extend the lifetime of association unnecessarily.
    
    This patch solves this by resetting the overall_error_count whenever the current
    state is small then SCTP_STATE_SHUTDOWN_PENDING.  As a small side-effect, we
    end up also handling SCTP_STATE_SHUTDOWN_ACK_SENT and SCTP_STATE_SHUTDOWN_SENT
    states, but they are not really impacted because we disable Heartbeats in those
    states.
    
    Fixes: Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 779c19e0ac88b95710ceae2495caebfd442dd2c1
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit 9f9ccecbabfa9c4307fcae2942f54fd750b6d865
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Aug 27 04:52:20 2015 +0800

    sctp: donot reset the overall_error_count in SHUTDOWN_RECEIVE state
    
    commit f648f807f61e64d247d26611e34cc97e4ed03401 upstream.
    
    Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    fixed a problem with excessive retransmissions in the SHUTDOWN_PENDING by not
    resetting the association overall_error_count.  This allowed the association
    to better enforce assoc.max_retrans limit.
    
    However, the same issue still exists when the association is in SHUTDOWN_RECEIVED
    state.  In this state, HB-ACKs will continue to reset the overall_error_count
    for the association would extend the lifetime of association unnecessarily.
    
    This patch solves this by resetting the overall_error_count whenever the current
    state is small then SCTP_STATE_SHUTDOWN_PENDING.  As a small side-effect, we
    end up also handling SCTP_STATE_SHUTDOWN_ACK_SENT and SCTP_STATE_SHUTDOWN_SENT
    states, but they are not really impacted because we disable Heartbeats in those
    states.
    
    Fixes: Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9a04c65c6bcd5fea9e892d338f3d3da8df46c9a1
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5cadd6bac523e5e78ae18284e5f2b286ebff070b
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3deaa4f531506a12ac4860ccd83cb6cbcb15a7eb
Merge: ccf70ddcbe99 b84f78782052
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Oct 1 21:55:35 2015 -0400

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
    1) Fix regression in SKB partial checksum handling, from Pravin B
       Shalar.
    
    2) Fix VLAN inside of VXLAN handling in i40e driver, from Jesse
       Brandeburg.
    
    3) Cure softlockups during accept() in SCTP, from Karl Heiss.
    
    4) MSG_PEEK should return multiple SKBs worth of data in AF_UNIX, from
       Aaron Conole.
    
    5) IPV6 erroneously ignores output interface specifier in lookup key for
       route lookups, fix from David Ahern.
    
    6) In Marvell DSA driver, forward unknown frames to CPU port, from
       Andrew Lunn.
    
    7) Mission flow flag initializations in some code paths, from David
       Ahern.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      net: Initialize flow flags in input path
      net: dsa: fix preparation of a port STP update
      testptp: Silence compiler warnings on ppc64
      net/mlx4: Handle return codes in mlx4_qp_attach_common
      dsa: mv88e6xxx: Enable forwarding for unknown to the CPU port
      skbuff: Fix skb checksum partial check.
      net: ipv6: Add RT6_LOOKUP_F_IFACE flag if oif is set
      net sysfs: Print link speed as signed integer
      bna: fix error handling
      af_unix: return data from multiple SKBs on recv() with MSG_PEEK flag
      af_unix: Convert the unix_sk macro to an inline function for type safety
      net: sctp: Don't use 64 kilobyte lookup table for four elements
      l2tp: protect tunnel->del_work by ref_count
      net/ibm/emac: bump version numbers for correct work with ethtool
      sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
      sctp: Whitespace fix
      i40e/i40evf: check for stopped admin queue
      i40e: fix VLAN inside VXLAN
      r8169: fix handling rtl_readphy result
      net: hisilicon: fix handling platform_get_irq result

commit e7bb902b26f1e8f7c1a4f0cc7b3abfd9b3fbb108
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 62f575aaba7ae93a4e02029d30f9dcf69b84470f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit eb084bd187c25f0b63556a4f6c440e3ac96ecaf5
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 upstream.
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 540a0bd97d4e790b9526e266c22f4c12cf732a1f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    [ Upstream commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4 ]
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 2103d6b818fcdae15ffa04cf385f770e6c3892c3
Author: Denys Vlasenko <dvlasenk@redhat.com>
Date:   Mon Sep 28 14:34:04 2015 +0200

    net: sctp: Don't use 64 kilobyte lookup table for four elements
    
    Seemingly innocuous sctp_trans_state_to_prio_map[] array
    is way bigger than it looks, since
    "[SCTP_UNKNOWN] = 2" expands into "[0xffff] = 2" !
    
    This patch replaces it with switch() statement.
    
    Signed-off-by: Denys Vlasenko <dvlasenk@redhat.com>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    CC: linux-sctp@vger.kernel.org
    CC: netdev@vger.kernel.org
    CC: linux-kernel@vger.kernel.org
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 51359bfc5b7111cada4d10e71b4dcdd1085e1a8f
Merge: 43ae93a93e8c 635682a14427
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Sep 28 21:03:40 2015 -0700

    Merge branch 'sctp-accept-deadlock'
    
    Karl Heiss says:
    
    ====================
    sctp: Fix SCTP deadlock
    
    These patches fix a deadlock during accept() of an SCTP connection.
    
    The first patch fixes whitespace issues.
    
    The second patch actually fixes the deadlock race.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 635682a14427d241bab7bbdeebb48a7d7b91638e
Author: Karl Heiss <kheiss@gmail.com>
Date:   Thu Sep 24 12:15:07 2015 -0400

    sctp: Prevent soft lockup when sctp_accept() is called during a timeout event
    
    A case can occur when sctp_accept() is called by the user during
    a heartbeat timeout event after the 4-way handshake.  Since
    sctp_assoc_migrate() changes both assoc->base.sk and assoc->ep, the
    bh_sock_lock in sctp_generate_heartbeat_event() will be taken with
    the listening socket but released with the new association socket.
    The result is a deadlock on any future attempts to take the listening
    socket lock.
    
    Note that this race can occur with other SCTP timeouts that take
    the bh_lock_sock() in the event sctp_accept() is called.
    
     BUG: soft lockup - CPU#9 stuck for 67s! [swapper:0]
     ...
     RIP: 0010:[<ffffffff8152d48e>]  [<ffffffff8152d48e>] _spin_lock+0x1e/0x30
     RSP: 0018:ffff880028323b20  EFLAGS: 00000206
     RAX: 0000000000000002 RBX: ffff880028323b20 RCX: 0000000000000000
     RDX: 0000000000000000 RSI: ffff880028323be0 RDI: ffff8804632c4b48
     RBP: ffffffff8100bb93 R08: 0000000000000000 R09: 0000000000000000
     R10: ffff880610662280 R11: 0000000000000100 R12: ffff880028323aa0
     R13: ffff8804383c3880 R14: ffff880028323a90 R15: ffffffff81534225
     FS:  0000000000000000(0000) GS:ffff880028320000(0000) knlGS:0000000000000000
     CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
     CR2: 00000000006df528 CR3: 0000000001a85000 CR4: 00000000000006e0
     DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
     DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
     Process swapper (pid: 0, threadinfo ffff880616b70000, task ffff880616b6cab0)
     Stack:
     ffff880028323c40 ffffffffa01c2582 ffff880614cfb020 0000000000000000
     <d> 0100000000000000 00000014383a6c44 ffff8804383c3880 ffff880614e93c00
     <d> ffff880614e93c00 0000000000000000 ffff8804632c4b00 ffff8804383c38b8
     Call Trace:
     <IRQ>
     [<ffffffffa01c2582>] ? sctp_rcv+0x492/0xa10 [sctp]
     [<ffffffff8148c559>] ? nf_iterate+0x69/0xb0
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148c716>] ? nf_hook_slow+0x76/0x120
     [<ffffffff814974a0>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8149757d>] ? ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497808>] ? ip_local_deliver+0x98/0xa0
     [<ffffffff81496ccd>] ? ip_rcv_finish+0x12d/0x440
     [<ffffffff81497255>] ? ip_rcv+0x275/0x350
     [<ffffffff8145cfeb>] ? __netif_receive_skb+0x4ab/0x750
     ...
    
    With lockdep debugging:
    
     =====================================
     [ BUG: bad unlock balance detected! ]
     -------------------------------------
     CslRx/12087 is trying to release lock (slock-AF_INET) at:
     [<ffffffffa01bcae0>] sctp_generate_timeout_event+0x40/0xe0 [sctp]
     but there are no more locks to release!
    
     other info that might help us debug this:
     2 locks held by CslRx/12087:
     #0:  (&asoc->timers[i]){+.-...}, at: [<ffffffff8108ce1f>] run_timer_softirq+0x16f/0x3e0
     #1:  (slock-AF_INET){+.-...}, at: [<ffffffffa01bcac3>] sctp_generate_timeout_event+0x23/0xe0 [sctp]
    
    Ensure the socket taken is also the same one that is released by
    saving a copy of the socket before entering the timeout event
    critical section.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6015a6c137e5bb5c0484ebe546540f88d690cfd5
Merge: 16cfbae160c4 25b1029789f9
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Sep 23 14:52:02 2015 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/jkirsher/next-queue
    
    Jeff Kirsher says:
    
    ====================
    Intel Wired LAN Driver Updates 2015-09-22
    
    This series contains updates to e1000, e1000e, igbvf, ixgbe, ixgbevf and
    fm10k.
    
    Jacob provides several updates for fm10k, which cleans up comments and
    most notably a fix for a corner case issue with the PF/VF mailbox code.
    The issue being fm10k_mbx_reset_work clears various states about the
    mailbox, but does not clear the Tx FIFO head/tail pointers.  We also
    are not able to simply clear these pointers, as we would drop
    untransmitted messages without error.  Also adds support for extra debug
    statistics, which provides the ability to see what the PF thinks the
    VF mailboxes look like.
    
    Don adds support for SFP+ in X550 and support for SCTP flow director
    filters SCTP mask.
    
    Francois Romieu dusts off the e1000 driver and removes some dead calls
    to e1000_init_eeprom_params().
    
    Toshiaki Makita provides three patches to enable TSO for stacked VLAN's
    on e1000e, igbvf and ixgbevf.
    
    Mark provides the first of several ixgbe updates.  First updates the
    driver to accept SFP not present error for all devices, since an SFP
    can still be inserted.  Adds support for SFP insertion interrupt on
    X550EM devices with SPFs.  Adds I2C combined operations on X550EM
    (not X550) devices.  Moved the setting of lan_id to before any I2C
    eeprom access.  Lastly, set the bit bang mode in the hardware when
    performing bit banding I2C operations on X550.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5532408b48834bd762ed53c22aabed5dae0748d6
Author: Don Skidmore <donald.c.skidmore@intel.com>
Date:   Wed Jun 24 17:03:30 2015 -0400

    ixgbe: Add fdir support for SCTP on X550
    
    X550 has HW support for SCTP flow director filters SCTP mask. This
    patch adds it like we do for UDP and TCP.
    
    Signed-off-by: Donald C Skidmore <donald.c.skidmore@intel.com>
    Tested-by: Krishneil Singh <Krishneil.k.singh@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 8e2d61e0aed2b7c4ecb35844fe07e0b2b762dee4
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Thu Sep 10 17:31:15 2015 -0300

    sctp: fix race on protocol/netns initialization
    
    Consider sctp module is unloaded and is being requested because an user
    is creating a sctp socket.
    
    During initialization, sctp will add the new protocol type and then
    initialize pernet subsys:
    
            status = sctp_v4_protosw_init();
            if (status)
                    goto err_protosw_init;
    
            status = sctp_v6_protosw_init();
            if (status)
                    goto err_v6_protosw_init;
    
            status = register_pernet_subsys(&sctp_net_ops);
    
    The problem is that after those calls to sctp_v{4,6}_protosw_init(), it
    is possible for userspace to create SCTP sockets like if the module is
    already fully loaded. If that happens, one of the possible effects is
    that we will have readers for net->sctp.local_addr_list list earlier
    than expected and sctp_net_init() does not take precautions while
    dealing with that list, leading to a potential panic but not limited to
    that, as sctp_sock_init() will copy a bunch of blank/partially
    initialized values from net->sctp.
    
    The race happens like this:
    
         CPU 0                           |  CPU 1
      socket()                           |
       __sock_create                     | socket()
        inet_create                      |  __sock_create
         list_for_each_entry_rcu(        |
            answer, &inetsw[sock->type], |
            list) {                      |   inet_create
          /* no hits */                  |
         if (unlikely(err)) {            |
          ...                            |
          request_module()               |
          /* socket creation is blocked  |
           * the module is fully loaded  |
           */                            |
           sctp_init                     |
            sctp_v4_protosw_init         |
             inet_register_protosw       |
              list_add_rcu(&p->list,     |
                           last_perm);   |
                                         |  list_for_each_entry_rcu(
                                         |     answer, &inetsw[sock->type],
            sctp_v6_protosw_init         |     list) {
                                         |     /* hit, so assumes protocol
                                         |      * is already loaded
                                         |      */
                                         |  /* socket creation continues
                                         |   * before netns is initialized
                                         |   */
            register_pernet_subsys       |
    
    Simply inverting the initialization order between
    register_pernet_subsys() and sctp_v4_protosw_init() is not possible
    because register_pernet_subsys() will create a control sctp socket, so
    the protocol must be already visible by then. Deferring the socket
    creation to a work-queue is not good specially because we loose the
    ability to handle its errors.
    
    So, as suggested by Vlad, the fix is to split netns initialization in
    two moments: defaults and control socket, so that the defaults are
    already loaded by when we register the protocol, while control socket
    initialization is kept at the same moment it is today.
    
    Fixes: 4db67e808640 ("sctp: Make the address lists per network namespace")
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 65c61bc5dbbcfa1ff38e58aa834cb9a88e84a886
Merge: b8889c4fc6ba 30927520dbae
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Sep 10 13:53:15 2015 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix out-of-bounds array access in netfilter ipset, from Jozsef
        Kadlecsik.
    
     2) Use correct free operation on netfilter conntrack templates, from
        Daniel Borkmann.
    
     3) Fix route leak in SCTP, from Marcelo Ricardo Leitner.
    
     4) Fix sizeof(pointer) in mac80211, from Thierry Reding.
    
     5) Fix cache pointer comparison in ip6mr leading to missed unlock of
        mrt_lock.  From Richard Laing.
    
     6) rds_conn_lookup() needs to consider network namespace in key
        comparison, from Sowmini Varadhan.
    
     7) Fix deadlock in TIPC code wrt broadcast link wakeups, from Kolmakov
        Dmitriy.
    
     8) Fix fd leaks in bpf syscall, from Daniel Borkmann.
    
     9) Fix error recovery when installing ipv6 multipath routes, we would
        delete the old route before we would know if we could fully commit
        to the new set of nexthops.  Fix from Roopa Prabhu.
    
    10) Fix run-time suspend problems in r8152, from Hayes Wang.
    
    11) In fec, don't program the MAC address into the chip when the clocks
        are gated off.  From Fugang Duan.
    
    12) Fix poll behavior for netlink sockets when using rx ring mmap, from
        Daniel Borkmann.
    
    13) Don't allocate memory with GFP_KERNEL from get_stats64 in r8169
        driver, from Corinna Vinschen.
    
    14) In TCP Cubic congestion control, handle idle periods better where we
        are application limited, in order to keep cwnd from growing out of
        control.  From Eric Dumzet.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (65 commits)
      tcp_cubic: better follow cubic curve after idle period
      tcp: generate CA_EVENT_TX_START on data frames
      xen-netfront: respect user provided max_queues
      xen-netback: respect user provided max_queues
      r8169: Fix sleeping function called during get_stats64, v2
      ether: add IEEE 1722 ethertype - TSN
      netlink, mmap: fix edge-case leakages in nf queue zero-copy
      netlink, mmap: don't walk rx ring on poll if receive queue non-empty
      cxgb4: changes for new firmware 1.14.4.0
      net: fec: add netif status check before set mac address
      r8152: fix the runtime suspend issues
      r8152: split DRIVER_VERSION
      ipv6: fix ifnullfree.cocci warnings
      add microchip LAN88xx phy driver
      stmmac: fix check for phydev being open
      net: qlcnic: delete redundant memsets
      net: mv643xx_eth: use kzalloc
      net: jme: use kzalloc() instead of kmalloc+memset
      net: cavium: liquidio: use kzalloc in setup_glist()
      net: ipv6: use common fib_default_rule_pref
      ...

commit 9cbf22b37ae0592dea809cb8d424990774c21786
Merge: ea814ab9aab2 b3a5bbfd780d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Sep 3 12:57:48 2015 -0700

    Merge tag 'dlm-4.3' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm
    
    Pull dlm updates from David Teigland:
     "This set mainly includes a change to the way the dlm uses the SCTP API
      in the kernel, removing the direct dependency on the sctp module.
      Other odd SCTP-related fixes are also included.
    
      The other notable fix is for a long standing regression in the
      behavior of lock value blocks for user space locks"
    
    * tag 'dlm-4.3' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm:
      dlm: print error from kernel_sendpage
      dlm: fix lvb copy for user locks
      dlm: sctp_accept_from_sock() can be static
      dlm: fix reconnecting but not sending data
      dlm: replace BUG_ON with a less severe handling
      dlm: use sctp 1-to-1 API
      dlm: fix not reconnecting on connecting error handling
      dlm: fix race while closing connections
      dlm: fix connection stealing if using SCTP

commit 5e26b1b3abce05c177feb589260031519a1bc7b1
Author: Alex Gartrell <agartrell@fb.com>
Date:   Wed Aug 26 09:40:41 2015 -0700

    ipvs: support scheduling inverse and icmp SCTP packets
    
    In the event of an icmp packet, take only the ports instead of trying to
    grab the full header.
    
    In the event of an inverse packet, use the source address and port.
    
    Signed-off-by: Alex Gartrell <agartrell@fb.com>
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit e001d7084a687c7a25b02bee47548a1df10d6e0b
Merge: 5c98bcce6497 f648f807f61e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Aug 27 17:52:38 2015 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Some straggler bug fixes here:
    
       1) Netlink_sendmsg() doesn't check iterator type properly in mmap
          case, from Ken-ichirou MATSUZAWA.
    
       2) Don't sleep in atomic context in bcmgenet driver, from Florian
          Fainelli.
    
       3) The pfkey_broadcast() code patch can't actually ever use anything
          other than GFP_ATOMIC.  And the cases that right now pass
          GFP_KERNEL or similar will currently trigger an RCU splat.  Just
          use GFP_ATOMIC unconditionally.  From David Ahern.
    
       4) Fix FD bit timings handling in pcan_usb driver, from Marc
          Kleine-Budde.
    
       5) Cache dst leaked in ip6_gre tunnel removal, fix from Huaibin Wang.
    
       6) Traversal into drivers/net/ethernet/renesas should be triggered by
          CONFIG_NET_VENDOR_RENESAS, not a particular driver's config
          option.  From Kazuya Mizuguchi.
    
       7) Fix regression in handling of igmp_join errors in vxlan, from
          Marcelo Ricardo Leitner.
    
       8) Make phy_{read,write}_mmd_indirect() properly take the mdio_lock
          mutex when programming the registers.  From Russell King.
    
       9) Fix non-forced handling in u32_destroy(), from WANG Cong.
    
      10) Test the EVENT_NO_RUNTIME_PM flag before it is cleared in
          usbnet_stop(), from Eugene Shatokhin.
    
      11) In sfc driver, don't fetch statistics firmware isn't capable of,
          from Bert Kenward.
    
      12) Verify ASCONF address parameter location in SCTP, from Xin Long"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      sctp: donot reset the overall_error_count in SHUTDOWN_RECEIVE state
      sctp: asconf's process should verify address parameter is in the beginning
      sfc: only use vadaptor stats if firmware is capable
      net: phy: fixed: propagate fixed link values to struct
      usbnet: Get EVENT_NO_RUNTIME_PM bit before it is cleared
      drivers: net: xgene: fix: Oops in linkwatch_fire_event
      cls_u32: complete the check for non-forced case in u32_destroy()
      net: fec: use reinit_completion() in mdio accessor functions
      net: phy: add locking to phy_read_mmd_indirect()/phy_write_mmd_indirect()
      vxlan: re-ignore EADDRINUSE from igmp_join
      net: compile renesas directory if NET_VENDOR_RENESAS is configured
      ip6_gre: release cached dst on tunnel removal
      phylib: Make PHYs children of their MDIO bus, not the bus' parent.
      can: pcan_usb: don't provide CAN FD bittimings by non-FD adapters
      net: Fix RCU splat in af_key
      net: bcmgenet: fix uncleaned dma flags
      net: bcmgenet: Avoid sleeping in bcmgenet_timeout
      netlink: mmap: fix tx type check

commit f648f807f61e64d247d26611e34cc97e4ed03401
Author: lucien <lucien.xin@gmail.com>
Date:   Thu Aug 27 04:52:20 2015 +0800

    sctp: donot reset the overall_error_count in SHUTDOWN_RECEIVE state
    
    Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    fixed a problem with excessive retransmissions in the SHUTDOWN_PENDING by not
    resetting the association overall_error_count.  This allowed the association
    to better enforce assoc.max_retrans limit.
    
    However, the same issue still exists when the association is in SHUTDOWN_RECEIVED
    state.  In this state, HB-ACKs will continue to reset the overall_error_count
    for the association would extend the lifetime of association unnecessarily.
    
    This patch solves this by resetting the overall_error_count whenever the current
    state is small then SCTP_STATE_SHUTDOWN_PENDING.  As a small side-effect, we
    end up also handling SCTP_STATE_SHUTDOWN_ACK_SENT and SCTP_STATE_SHUTDOWN_SENT
    states, but they are not really impacted because we disable Heartbeats in those
    states.
    
    Fixes: Commit f8d960524328 ("sctp: Enforce retransmission limit during shutdown")
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit acee4e527d5f069351f835602b23602d01de5e1f
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Aug 11 19:22:24 2015 -0300

    dlm: replace BUG_ON with a less severe handling
    
    BUG_ON() is a severe action for this case, specially now that DLM with
    SCTP will use 1 socket per association. Instead, we can just close the
    socket on this error condition and return from the function.
    
    Also move the check to an earlier stage as it won't change and thus we
    can abort as soon as possible.
    
    Although this issue was reported when still using SCTP with 1-to-many
    API, this cleanup wouldn't be that simple back then because we couldn't
    close the socket and making sure such event would cease would be hard.
    And actually, previous code was closing the association, yet SCTP layer
    is still raising the new data event. Probably a bug to be fixed in SCTP.
    
    Reported-by: <tan.hu@zte.com.cn>
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit ee44b4bc054afc586c92558a225055ef9fd25d17
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Aug 11 19:22:23 2015 -0300

    dlm: use sctp 1-to-1 API
    
    DLM is using 1-to-many API but in a 1-to-1 fashion. That is, it's not
    needed but this causes it to use sctp_do_peeloff() to mimic an
    kernel_accept() and this causes a symbol dependency on sctp module.
    
    By switching it to 1-to-1 API we can avoid this dependency and also
    reduce quite a lot of SCTP-specific code in lowcomms.c.
    
    The caveat is that now DLM won't always use the same src port. It will
    choose a random one, just like TCP code. This allows the peers to
    attempt simultaneous connections, which now are handled just like for
    TCP.
    
    Even more sharing between TCP and SCTP code on DLM is possible, but it
    is intentionally left for a later commit.
    
    Note that for using nodes with this commit, you have to have at least
    the early fixes on this patchset otherwise it will trigger some issues
    on old nodes.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 28926a0965a943f7c1586342f9482a6e41b4f0c9
Author: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Date:   Tue Aug 11 19:22:20 2015 -0300

    dlm: fix connection stealing if using SCTP
    
    When using SCTP and accepting a new connection, DLM currently validates
    if the peer trying to connect to it is one of the cluster nodes, but it
    doesn't check if it already has a connection to it or not.
    
    If it already had a connection, it will be overwritten, and the new one
    will be used for writes, possibly causing the node to leave the cluster
    due to communication breakage.
    
    Still, one could DoS the node by attempting N connections and keeping
    them open.
    
    As said, but being explicit, both situations are only triggerable from
    other cluster nodes, but are doable with only user-level perms.
    
    Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 9dc20a649609c95ce7c5ac4282656ba627b67d49
Merge: d1b22e4d8e57 a6cd379b4d68
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Aug 4 23:57:45 2015 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    Netfilter updates for net-next
    
    The following patchset contains Netfilter updates for net-next, they are:
    
    1) A couple of cleanups for the netfilter core hook from Eric Biederman.
    
    2) Net namespace hook registration, also from Eric. This adds a dependency with
       the rtnl_lock. This should be fine by now but we have to keep an eye on this
       because if we ever get the per-subsys nfnl_lock before rtnl we have may
       problems in the future. But we have room to remove this in the future by
       propagating the complexity to the clients, by registering hooks for the init
       netns functions.
    
    3) Update nf_tables to use the new net namespace hook infrastructure, also from
       Eric.
    
    4) Three patches to refine and to address problems from the new net namespace
       hook infrastructure.
    
    5) Switch to alternate jumpstack in xtables iff the packet is reentering. This
       only applies to a very special case, the TEE target, but Eric Dumazet
       reports that this is slowing down things for everyone else. So let's only
       switch to the alternate jumpstack if the tee target is in used through a
       static key. This batch also comes with offline precalculation of the
       jumpstack based on the callchain depth. From Florian Westphal.
    
    6) Minimal SCTP multihoming support for our conntrack helper, from Michal
       Kubecek.
    
    7) Reduce nf_bridge_info per skbuff scratchpad area to 32 bytes, from Florian
       Westphal.
    
    8) Fix several checkpatch errors in bridge netfilter, from Bernhard Thaler.
    
    9) Get rid of useless debug message in ip6t_REJECT, from Subash Abhinov.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c764cec3703583247c4ab837c652975a3d41f4b
Merge: acea568fa9ea ea111545843e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Jul 31 17:10:56 2015 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Must teardown SR-IOV before unregistering netdev in igb driver, from
        Alex Williamson.
    
     2) Fix ipv6 route unreachable crash in IPVS, from Alex Gartrell.
    
     3) Default route selection in ipv4 should take the prefix length, table
        ID, and TOS into account, from Julian Anastasov.
    
     4) sch_plug must have a reset method in order to purge all buffered
        packets when the qdisc is reset, likewise for sch_choke, from WANG
        Cong.
    
     5) Fix deadlock and races in slave_changelink/br_setport in bridging.
        From Nikolay Aleksandrov.
    
     6) mlx4 bug fixes (wrong index in port even propagation to VFs,
        overzealous BUG_ON assertion, etc.) from Ido Shamay, Jack
        Morgenstein, and Or Gerlitz.
    
     7) Turn off klog message about SCTP userspace interface compat that
        makes no sense at all, from Daniel Borkmann.
    
     8) Fix unbounded restarts of inet frag eviction process, causing NMI
        watchdog soft lockup messages, from Florian Westphal.
    
     9) Suspend/resume fixes for r8152 from Hayes Wang.
    
    10) Fix busy loop when MSG_WAITALL|MSG_PEEK is used in TCP recv, from
        Sabrina Dubroca.
    
    11) Fix performance regression when removing a lot of routes from the
        ipv4 routing tables, from Alexander Duyck.
    
    12) Fix device leak in AF_PACKET, from Lars Westerhoff.
    
    13) AF_PACKET also has a header length comparison bug due to signedness,
        from Alexander Drozdov.
    
    14) Fix bug in EBPF tail call generation on x86, from Daniel Borkmann.
    
    15) Memory leaks, TSO stats, watchdog timeout and other fixes to
        thunderx driver from Sunil Goutham and Thanneeru Srinivasulu.
    
    16) act_bpf can leak memory when replacing programs, from Daniel
        Borkmann.
    
    17) WOL packet fixes in gianfar driver, from Claudiu Manoil.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (79 commits)
      stmmac: fix missing MODULE_LICENSE in stmmac_platform
      gianfar: Enable device wakeup when appropriate
      gianfar: Fix suspend/resume for wol magic packet
      gianfar: Fix warning when CONFIG_PM off
      act_pedit: check binding before calling tcf_hash_release()
      net: sk_clone_lock() should only do get_net() if the parent is not a kernel socket
      net: sched: fix refcount imbalance in actions
      r8152: reset device when tx timeout
      r8152: add pre_reset and post_reset
      qlcnic: Fix corruption while copying
      act_bpf: fix memory leaks when replacing bpf programs
      net: thunderx: Fix for crash while BGX teardown
      net: thunderx: Add PCI driver shutdown routine
      net: thunderx: Fix crash when changing rss with mutliple traffic flows
      net: thunderx: Set watchdog timeout value
      net: thunderx: Wakeup TXQ only if CQE_TX are processed
      net: thunderx: Suppress alloc_pages() failure warnings
      net: thunderx: Fix TSO packet statistic
      net: thunderx: Fix memory leak when changing queue count
      net: thunderx: Fix RQ_DROP miscalculation
      ...

commit d7ee3519042798be6224e97f259ed47a63da4620
Author: Michal Kubeek <mkubecek@suse.cz>
Date:   Fri Jul 17 16:17:56 2015 +0200

    netfilter: nf_ct_sctp: minimal multihoming support
    
    Currently nf_conntrack_proto_sctp module handles only packets between
    primary addresses used to establish the connection. Any packets between
    secondary addresses are classified as invalid so that usual firewall
    configurations drop them. Allowing HEARTBEAT and HEARTBEAT-ACK chunks to
    establish a new conntrack would allow traffic between secondary
    addresses to pass through. A more sophisticated solution based on the
    addresses advertised in the initial handshake (and possibly also later
    dynamic address addition and removal) would be much harder to implement.
    Moreover, in general we cannot assume to always see the initial
    handshake as it can be routed through a different path.
    
    The patch adds two new conntrack states:
    
      SCTP_CONNTRACK_HEARTBEAT_SENT  - a HEARTBEAT chunk seen but not acked
      SCTP_CONNTRACK_HEARTBEAT_ACKED - a HEARTBEAT acked by HEARTBEAT-ACK
    
    State transition rules:
    
    - HEARTBEAT_SENT responds to usual chunks the same way as NONE (so that
      the behaviour changes as little as possible)
    - HEARTBEAT_ACKED responds to usual chunks the same way as ESTABLISHED
      does, except the resulting state is HEARTBEAT_ACKED rather than
      ESTABLISHED
    - previously existing states except NONE are preserved when HEARTBEAT or
      HEARTBEAT-ACK is seen
    - NONE (in the initial direction) changes to HEARTBEAT_SENT on HEARTBEAT
      and to CLOSED on HEARTBEAT-ACK
    - HEARTBEAT_SENT changes to HEARTBEAT_ACKED on HEARTBEAT-ACK in the
      reply direction
    - HEARTBEAT_SENT and HEARTBEAT_ACKED are preserved on HEARTBEAT and
      HEARTBEAT-ACK otherwise
    
    Normally, vtag is set from the INIT chunk for the reply direction and
    from the INIT-ACK chunk for the originating direction (i.e. each of
    these defines vtag value for the opposite direction). For secondary
    conntracks, we can't rely on seeing INIT/INIT-ACK and even if we have
    seen them, we would need to connect two different conntracks. Therefore
    simplified logic is applied: vtag of first packet in each direction
    (HEARTBEAT in the originating and HEARTBEAT-ACK in reply direction) is
    saved and all following packets in that direction are compared with this
    saved value. While INIT and INIT-ACK define vtag for the opposite
    direction, vtags extracted from HEARTBEAT and HEARTBEAT-ACK are always
    for their direction.
    
    Default timeout values for new states are
    
      HEARTBEAT_SENT: 30 seconds (default hb_interval)
      HEARTBEAT_ACKED: 210 seconds (hb_interval * path_max_retry + max_rto)
    
    (We cannot expect to see the shutdown sequence so that, unlike
    ESTABLISHED, the HEARTBEAT_ACKED timeout shouldn't be too long.)
    
    Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 81296fc67319d96ea6f7f43a07494394e1236a19
Author: Daniel Borkmann <daniel@iogearbox.net>
Date:   Wed Jul 22 16:31:49 2015 +0200

    net: sctp: stop spamming klog with rfc6458, 5.3.2. deprecation warnings
    
    Back then when we added support for SCTP_SNDINFO/SCTP_RCVINFO from
    RFC6458 5.3.4/5.3.5, we decided to add a deprecation warning for the
    (as per RFC deprecated) SCTP_SNDRCV via commit bbbea41d5e53 ("net:
    sctp: deprecate rfc6458, 5.3.2. SCTP_SNDRCV support"), see [1].
    
    Imho, it was not a good idea, and we should just revert that message
    for a couple of reasons:
    
      1) It's uapi and therefore set in stone forever.
    
      2) To be able to run on older and newer kernels, an SCTP application
         would need to probe for both, SCTP_SNDRCV, but also SCTP_SNDINFO/
         SCTP_RCVINFO support, so that on older kernels, it can make use
         of SCTP_SNDRCV, and on newer kernels SCTP_SNDINFO/SCTP_RCVINFO.
         In my (limited) experience, a lot of SCTP appliances are migrating
         to newer kernels only ve(ee)ry slowly.
    
      3) Some people don't have the chance to change their applications,
         f.e. due to proprietary legacy stuff. So, they'll hit this warning
         in fast path and are stuck with older kernels.
    
    But i.e. due to point 1) I really fail to see the benefit of a warning.
    So just revert that for now, the issue was reported up Jamal.
    
      [1] http://thread.gmane.org/gmane.linux.network/321960/
    
    Reported-by: Jamal Hadi Salim <jhs@mojatatu.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Cc: Michael Tuexen <tuexen@fh-muenster.de>
    Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 57816cbcb827895d10925c6a52b63833087ce0c1
Merge: 7177a3b037c7 0ca50d12fe46
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jul 21 00:20:18 2015 -0700

    Merge branch 'sctp-src-addr'
    
    Marcelo Ricardo Leitner says:
    
    ====================
    sctp: fix src address selection if using secondary address
    
    This series improves the way SCTP chooses its src address so that the
    choosen one will always belong to the interface being used for output.
    
    v1->v2:
     - split out the refactoring from the fix itself
     - Doing a full reverse routing as in v1 is not necessary. Only looking
       for the interface that has the address and comparing its number is
       enough.
    ====================
    
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 47ebed96ff4ff0d9c39d0fea74ade65dbf9cc41c
Merge: 44b061f77f70 b922622ec6ef
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jul 1 14:58:07 2015 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) mlx4 driver bug fixes (TX queue wakeups, csum complete indications)
        from Ido Shamay, Eran Ben Elisha, and Or Gerlitz.
    
     2) Missing unlock in error path of PTP support in renesas driver, from
        Dan Carpenter.
    
     3) Add Vitesse 8641 phy IDs to vitesse PHY driver, from Shaohui Xie.
    
     4) Bnx2x driver bug fixes (linearization of encap packets, scratchpad
        parity error notifications, flow-control and speed settings) from
        Yuval Mintz, Manish Chopra, Shahed Shaikh, and Ariel Elior.
    
     5) ipv6 extension header parsing in the igb chip has a HW errata,
        disable it.  Frm Todd Fujinaka.
    
     6) Fix PCI link state locking issue in e1000e driver, from Yanir
        Lubetkin.
    
     7) Cure panics during MTU change in i40e, from Mitch Williams.
    
     8) Don't leak promisc refs in DSA slave driver, from Gilad Ben-Yossef.
    
     9) Add missing HAS_DMA dep to VIA Rhine driver, from Geery
        Uytterhoeven.
    
    10) Make sure DMA map/unmap calls are symmetric in bnx2x driver, from
        Michal Schmidt.
    
    11) Workaround for MDIO access problems in bcm7xxx devices, from FLorian
        Fainelli.
    
    12) Fix races in SCTP protocol between OTTB responses and route
        removals, from Alexander Sverdlin.
    
    13) Fix jumbo frame checksum issue with some mvneta devices, from Simon
        Guinot.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (58 commits)
      sock_diag: don't broadcast kernel sockets
      net: mvneta: disable IP checksum with jumbo frames for Armada 370
      ARM: mvebu: update Ethernet compatible string for Armada XP
      net: mvneta: introduce compatible string "marvell, armada-xp-neta"
      api: fix compatibility of linux/in.h with netinet/in.h
      net: icplus: fix typo in constant name
      sis900: Trivial: Fix typos in enums
      stmmac: Trivial: fix typo in constant name
      sctp: Fix race between OOTB responce and route removal
      net-Liquidio: Delete unnecessary checks before the function call "vfree"
      vmxnet3: Bump up driver version number
      amd-xgbe: Add the __GFP_NOWARN flag to Rx buffer allocation
      net: phy: mdio-bcm-unimac: workaround initial read failures for integrated PHYs
      net: bcmgenet: workaround initial read failures for integrated PHYs
      net: phy: bcm7xxx: workaround MDIO management controller initial read
      bnx2x: fix DMA API usage
      net: via: VIA_RHINE and VIA_VELOCITY should depend on HAS_DMA
      net/phy: tune get_phy_c45_ids to support more c45 phy
      bnx2x: fix lockdep splat
      net: fec: don't access RACC register when not available
      ...

commit f1e07e7e77ba9060cb74397b2257c3cd5bc2c343
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Tue May 26 17:30:17 2015 -0600

    sctp: Fix mangled IPv4 addresses on a IPv6 listening socket
    
    [ Upstream commit 9302d7bb0c5cd46be5706859301f18c137b2439f ]
    
    sctp_v4_map_v6 was subtly writing and reading from members
    of a union in a way the clobbered data it needed to read before
    it read it.
    
    Zeroing the v6 flowinfo overwrites the v4 sin_addr with 0, meaning
    that every place that calls sctp_v4_map_v6 gets ::ffff:0.0.0.0 as the
    result.
    
    Reorder things to guarantee correct behaviour no matter what the
    union layout is.
    
    This impacts user space clients that open an IPv6 SCTP socket and
    receive IPv4 connections. Prior to 299ee user space would see a
    sockaddr with AF_INET and a correct address, after 299ee the sockaddr
    is AF_INET6, but the address is wrong.
    
    Fixes: 299ee123e198 (sctp: Fixup v4mapped behaviour to comply with Sock API)
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a36102b2bb069c858a4be3457ba288208b4662b0
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Tue May 26 17:30:17 2015 -0600

    sctp: Fix mangled IPv4 addresses on a IPv6 listening socket
    
    [ Upstream commit 9302d7bb0c5cd46be5706859301f18c137b2439f ]
    
    sctp_v4_map_v6 was subtly writing and reading from members
    of a union in a way the clobbered data it needed to read before
    it read it.
    
    Zeroing the v6 flowinfo overwrites the v4 sin_addr with 0, meaning
    that every place that calls sctp_v4_map_v6 gets ::ffff:0.0.0.0 as the
    result.
    
    Reorder things to guarantee correct behaviour no matter what the
    union layout is.
    
    This impacts user space clients that open an IPv6 SCTP socket and
    receive IPv4 connections. Prior to 299ee user space would see a
    sockaddr with AF_INET and a correct address, after 299ee the sockaddr
    is AF_INET6, but the address is wrong.
    
    Fixes: 299ee123e198 (sctp: Fixup v4mapped behaviour to comply with Sock API)
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>

commit c8d17b451aa18b07b60e771addf17a5fdd4138c7
Merge: b85dfd30cb37 b07d496177cd
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Jun 12 20:54:16 2015 -1000

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix uninitialized struct station_info in cfg80211_wireless_stats(),
        from Johannes Berg.
    
     2) Revert commit attempt to fix ipv6 protocol resubmission, it adds
        regressions.
    
     3) Endless loops can be created in bridge port lists, fix from Nikolay
        Aleksandrov.
    
     4) Don't WARN_ON() if sk->sk_forward_alloc is non-zero in
        sk_clear_memalloc, it is a legal situation during swap deactivation.
        Fix from Mel Gorman.
    
     5) Fix order of disabling interrupts and unlocking NAPI in enic driver
        to avoid a race.  From Govindarajulu Varadarajan.
    
     6) High and low register writes are swapped when programming the start
        of periodic output in igb driver.  From Richard Cochran.
    
     7) Fix device rename handling in mpls stack, from Robert Shearman.
    
     8) Do not trigger compaction synchronously when optimistically trying
        to allocate an order 3 page in alloc_skb_with_frags() and
        skb_page_frag_refill().  From Shaohua Li.
    
     9) Authentication with COOKIE_ECHO is not handled properly in SCTP, fix
        from Marcelo Ricardo Leitner.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      Doc: networking: Fix URL for wiki.wireshark.org in udplite.txt
      sctp: allow authenticating DATA chunks that are bundled with COOKIE_ECHO
      net: don't wait for order-3 page allocation
      mpls: handle device renames for per-device sysctls
      net: igb: fix the start time for periodic output signals
      enic: fix memory leak in rq_clean
      enic: check return value for stat dump
      enic: unlock napi busy poll before unmasking intr
      net, swap: Remove a warning and clarify why sk_mem_reclaim is required when deactivating swap
      bridge: fix multicast router rlist endless loop
      tipc: disconnect socket directly after probe failure
      Revert "ipv6: Fix protocol resubmission"
      cfg80211: wext: clear sinfo struct before calling driver

commit 9302d7bb0c5cd46be5706859301f18c137b2439f
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Tue May 26 17:30:17 2015 -0600

    sctp: Fix mangled IPv4 addresses on a IPv6 listening socket
    
    sctp_v4_map_v6 was subtly writing and reading from members
    of a union in a way the clobbered data it needed to read before
    it read it.
    
    Zeroing the v6 flowinfo overwrites the v4 sin_addr with 0, meaning
    that every place that calls sctp_v4_map_v6 gets ::ffff:0.0.0.0 as the
    result.
    
    Reorder things to guarantee correct behaviour no matter what the
    union layout is.
    
    This impacts user space clients that open an IPv6 SCTP socket and
    receive IPv4 connections. Prior to 299ee user space would see a
    sockaddr with AF_INET and a correct address, after 299ee the sockaddr
    is AF_INET6, but the address is wrong.
    
    Fixes: 299ee123e198 (sctp: Fixup v4mapped behaviour to comply with Sock API)
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Acked-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1b9143bddfef9047efcfc4627014a20a7c8c743f
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    commit 600ddd6825543962fb807884169e57b580dba208 upstream
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit f014e54c21bf0ee03bac265d84feffbb7e233e89
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    commit 4184b2a79a7612a9272ce20d639934584a1f3786 upstream.
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    (cherry picked from commit 3af10169145c8eed7b3591c0644da4298405efbc)
    
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 8e4213323511e95e81c743e50c00974a407c0fe5
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    [bwh: Backported to 2.6.32: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 752b388c92ed22e527ddb22fe137fa21095fb554
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream.
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Fixes CVE-2014-8160.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Zhiqiang Zhang <zhangzhiqiang.zhang@huawei.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit efbf300ed821a533c3af71b1b122227febc28142
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream.
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Fixes CVE-2014-8160.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Zhiqiang Zhang <zhangzhiqiang.zhang@huawei.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2fb11da9d9016f6c0a4fcb99b8ebd63495c79005
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream.
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Fixes CVE-2014-8160.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Zhiqiang Zhang <zhangzhiqiang.zhang@huawei.com>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 6b4a9a084334717868e054002ad7863a3b4cceef
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    commit cfbf654efc6d78dc9812e030673b86f235bf677d upstream.
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit 999a6c8f6f5188b1b58404dfb41cd4248e13d32c
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    commit e40607cbe270a9e8360907cb1e62ddf0736e4864 upstream.
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit b0f741c5d11b1b2bafd8392f0cb4d8ac25be9164
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [lizf: Backported to 3.4: adjust context]
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit d3fdf67442c2c1c97390176ce3451a6ae48450fe
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit 0565f4368ff26e2574c979e911763d6387db45cc
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    commit 600ddd6825543962fb807884169e57b580dba208 upstream.
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Zefan Li <lizefan@huawei.com>

commit f093464e854a6d3515b7d3fee968e4cf64c14fd1
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    commit cfbf654efc6d78dc9812e030673b86f235bf677d upstream.
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 11fd056bd8701f98635ac0ee48736db84c03e860
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 15 16:34:35 2015 +0100

    net: sctp: fix race for one-to-many sockets in sendmsg's auto associate
    
    commit 2061dcd6bff8b774b4fac8b0739b6be3f87bc9f2 upstream.
    
    I.e. one-to-many sockets in SCTP are not required to explicitly
    call into connect(2) or sctp_connectx(2) prior to data exchange.
    Instead, they can directly invoke sendmsg(2) and the SCTP stack
    will automatically trigger connection establishment through 4WHS
    via sctp_primitive_ASSOCIATE(). However, this in its current
    implementation is racy: INIT is being sent out immediately (as
    it cannot be bundled anyway) and the rest of the DATA chunks are
    queued up for later xmit when connection is established, meaning
    sendmsg(2) will return successfully. This behaviour can result
    in an undesired side-effect that the kernel made the application
    think the data has already been transmitted, although none of it
    has actually left the machine, worst case even after close(2)'ing
    the socket.
    
    Instead, when the association from client side has been shut down
    e.g. first gracefully through SCTP_EOF and then close(2), the
    client could afterwards still receive the server's INIT_ACK due
    to a connection with higher latency. This INIT_ACK is then considered
    out of the blue and hence responded with ABORT as there was no
    alive assoc found anymore. This can be easily reproduced f.e.
    with sctp_test application from lksctp. One way to fix this race
    is to wait for the handshake to actually complete.
    
    The fix defers waiting after sctp_primitive_ASSOCIATE() and
    sctp_primitive_SEND() succeeded, so that DATA chunks cooked up
    from sctp_sendmsg() have already been placed into the output
    queue through the side-effect interpreter, and therefore can then
    be bundeled together with COOKIE_ECHO control chunks.
    
    strace from example application (shortened):
    
    socket(PF_INET, SOCK_SEQPACKET, IPPROTO_SCTP) = 3
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(0)=[], msg_controllen=48, {cmsg_len=48, cmsg_level=0x84 /* SOL_??? */, cmsg_type=, ...},
               msg_flags=0}, 0) = 0 // graceful shutdown for SOCK_SEQPACKET via SCTP_EOF
    close(3) = 0
    
    tcpdump before patch (fooling the application):
    
    22:33:36.306142 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 3879023686] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3139201684]
    22:33:36.316619 IP 192.168.1.115.8888 > 192.168.1.114.41462: sctp (1) [INIT ACK] [init tag: 3345394793] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 3380109591]
    22:33:36.317600 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [ABORT]
    
    tcpdump after patch:
    
    14:28:58.884116 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 438593213] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3092969729]
    14:28:58.888414 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [INIT ACK] [init tag: 381429855] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 2141904492]
    14:28:58.888638 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [COOKIE ECHO] , (2) [DATA] (B)(E) [TSN: 3092969729] [...]
    14:28:58.893278 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [COOKIE ACK] , (2) [SACK] [cum ack 3092969729] [a_rwnd 106491] [#gap acks 0] [#dup tsns 0]
    14:28:58.893591 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969730] [...]
    14:28:59.096963 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969730] [a_rwnd 106496] [#gap acks 0] [#dup tsns 0]
    14:28:59.097086 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969731] [...] , (2) [DATA] (B)(E) [TSN: 3092969732] [...]
    14:28:59.103218 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969732] [a_rwnd 106486] [#gap acks 0] [#dup tsns 0]
    14:28:59.103330 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN]
    14:28:59.107793 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SHUTDOWN ACK]
    14:28:59.107890 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN COMPLETE]
    
    Looks like this bug is from the pre-git history museum. ;)
    
    Fixes: 08707d5482df ("lksctp-2_5_31-0_5_1.patch")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [ luis: backported to 3.16: adjusted context ]
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 294489e733d4447947052f746217d9715aa54dfa
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    [ Upstream commit cfbf654efc6d78dc9812e030673b86f235bf677d ]
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit faf1368dedf9cc98ef35c9ec6d2677ff5e98b090
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    [ Upstream commit 600ddd6825543962fb807884169e57b580dba208 ]
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6743ca71e113f4a2b5ee58b060807974d4d33f8b
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    [ Upstream commit cfbf654efc6d78dc9812e030673b86f235bf677d ]
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c75e4b05b591b6c134b7e66c1ea39757f452f1e8
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    [ Upstream commit 600ddd6825543962fb807884169e57b580dba208 ]
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 572d332c02bb349d6fe428bf17e3068631064976
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    [ Upstream commit cfbf654efc6d78dc9812e030673b86f235bf677d ]
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 727ab4c06af65c1b2313c95dfcd8827318d5a438
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    [ Upstream commit 600ddd6825543962fb807884169e57b580dba208 ]
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d752c364571743d696c2a54a449ce77550c35ac5
Author: Marcelo Ricardo Leitner <mleitner@redhat.com>
Date:   Mon Feb 23 15:02:34 2015 -0300

    ipvs: allow rescheduling of new connections when port reuse is detected
    
    Currently, when TCP/SCTP port reusing happens, IPVS will find the old
    entry and use it for the new one, behaving like a forced persistence.
    But if you consider a cluster with a heavy load of small connections,
    such reuse will happen often and may lead to a not optimal load
    balancing and might prevent a new node from getting a fair load.
    
    This patch introduces a new sysctl, conn_reuse_mode, that allows
    controlling how to proceed when port reuse is detected. The default
    value will allow rescheduling of new connections only if the old entry
    was in TIME_WAIT state for TCP or CLOSED for SCTP.
    
    Signed-off-by: Marcelo Ricardo Leitner <mleitner@redhat.com>
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit d7cde286daad20dd171247ea47fc5ff4868591f0
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream.
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8662a896ae1ff85dca6797a0e9977a4794b67847
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    commit 600ddd6825543962fb807884169e57b580dba208 upstream.
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 560473dd201c4486136c102796f17b49f8c60f29
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 15 16:34:35 2015 +0100

    net: sctp: fix race for one-to-many sockets in sendmsg's auto associate
    
    commit 2061dcd6bff8b774b4fac8b0739b6be3f87bc9f2 upstream.
    
    I.e. one-to-many sockets in SCTP are not required to explicitly
    call into connect(2) or sctp_connectx(2) prior to data exchange.
    Instead, they can directly invoke sendmsg(2) and the SCTP stack
    will automatically trigger connection establishment through 4WHS
    via sctp_primitive_ASSOCIATE(). However, this in its current
    implementation is racy: INIT is being sent out immediately (as
    it cannot be bundled anyway) and the rest of the DATA chunks are
    queued up for later xmit when connection is established, meaning
    sendmsg(2) will return successfully. This behaviour can result
    in an undesired side-effect that the kernel made the application
    think the data has already been transmitted, although none of it
    has actually left the machine, worst case even after close(2)'ing
    the socket.
    
    Instead, when the association from client side has been shut down
    e.g. first gracefully through SCTP_EOF and then close(2), the
    client could afterwards still receive the server's INIT_ACK due
    to a connection with higher latency. This INIT_ACK is then considered
    out of the blue and hence responded with ABORT as there was no
    alive assoc found anymore. This can be easily reproduced f.e.
    with sctp_test application from lksctp. One way to fix this race
    is to wait for the handshake to actually complete.
    
    The fix defers waiting after sctp_primitive_ASSOCIATE() and
    sctp_primitive_SEND() succeeded, so that DATA chunks cooked up
    from sctp_sendmsg() have already been placed into the output
    queue through the side-effect interpreter, and therefore can then
    be bundeled together with COOKIE_ECHO control chunks.
    
    strace from example application (shortened):
    
    socket(PF_INET, SOCK_SEQPACKET, IPPROTO_SCTP) = 3
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(0)=[], msg_controllen=48, {cmsg_len=48, cmsg_level=0x84 /* SOL_??? */, cmsg_type=, ...},
               msg_flags=0}, 0) = 0 // graceful shutdown for SOCK_SEQPACKET via SCTP_EOF
    close(3) = 0
    
    tcpdump before patch (fooling the application):
    
    22:33:36.306142 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 3879023686] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3139201684]
    22:33:36.316619 IP 192.168.1.115.8888 > 192.168.1.114.41462: sctp (1) [INIT ACK] [init tag: 3345394793] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 3380109591]
    22:33:36.317600 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [ABORT]
    
    tcpdump after patch:
    
    14:28:58.884116 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 438593213] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3092969729]
    14:28:58.888414 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [INIT ACK] [init tag: 381429855] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 2141904492]
    14:28:58.888638 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [COOKIE ECHO] , (2) [DATA] (B)(E) [TSN: 3092969729] [...]
    14:28:58.893278 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [COOKIE ACK] , (2) [SACK] [cum ack 3092969729] [a_rwnd 106491] [#gap acks 0] [#dup tsns 0]
    14:28:58.893591 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969730] [...]
    14:28:59.096963 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969730] [a_rwnd 106496] [#gap acks 0] [#dup tsns 0]
    14:28:59.097086 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969731] [...] , (2) [DATA] (B)(E) [TSN: 3092969732] [...]
    14:28:59.103218 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969732] [a_rwnd 106486] [#gap acks 0] [#dup tsns 0]
    14:28:59.103330 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN]
    14:28:59.107793 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SHUTDOWN ACK]
    14:28:59.107890 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN COMPLETE]
    
    Looks like this bug is from the pre-git history museum. ;)
    
    Fixes: 08707d5482df ("lksctp-2_5_31-0_5_1.patch")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit cbdbd5781585f1af8cb6ac6d44355624dc79d0b6
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    commit cfbf654efc6d78dc9812e030673b86f235bf677d upstream.
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 7b7685e37bc001fc53b96f7aaf5894eddf914ca4
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    [ Upstream commit cfbf654efc6d78dc9812e030673b86f235bf677d ]
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 43e39c2f63240f67a67b4060882f67dac1a6f339
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    [ Upstream commit 600ddd6825543962fb807884169e57b580dba208 ]
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 9d82f5eb3376cbae96ad36a063a9390de1694546
Merge: 14365ea2b868 a409caecb2e1
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Feb 5 11:23:45 2015 -0800

    MMerge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Stretch ACKs can kill performance with Reno and CUBIC congestion
        control, largely due to LRO and GRO.  Fix from Neal Cardwell.
    
     2) Fix userland breakage because we accidently emit zero length netlink
        messages from the bridging code.  From Roopa Prabhu.
    
     3) Carry handling in generic csum_tcpudp_nofold is broken, fix from
        Karl Beldan.
    
     4) Remove bogus dev_set_net() calls from CAIF driver, from Nicolas
        Dichtel.
    
     5) Make sure PPP deflation never returns a length greater then the
        output buffer, otherwise we overflow and trigger skb_over_panic().
        Fix from Florian Westphal.
    
     6) COSA driver needs VIRT_TO_BUS Kconfig dependencies, from Arnd
        Bergmann.
    
     7) Don't increase route cached MTU on datagram too big ICMPs.  From Li
        Wei.
    
     8) Fix error path leaks in nf_tables, from Pablo Neira Ayuso.
    
     9) Fix bitmask handling regression in netlink that broke things like
        acpi userland tools.  From Pablo Neira Ayuso.
    
    10) Wrong header pointer passed to param_type2af() in SCTP code, from
        Saran Maruti Ramanara.
    
    11) Stacked vlans not handled correctly by vlan_get_protocol(), from
        Toshiaki Makita.
    
    12) Add missing DMA memory barrier to xgene driver, from Iyappan
        Subramanian.
    
    13) Fix crash in rate estimators, from Eric Dumazet.
    
    14) We've been adding various workarounds, one after another, for the
        change which added the per-net tcp_sock.  It was meant to reduce
        socket contention but added lots of problems.
    
        Reduce this instead to a proper per-cpu socket and that rids us of
        all the daemons.
    
        From Eric Dumazet.
    
    15) Fix memory corruption and OOPS in mlx4 driver, from Jack
        Morgenstein.
    
    16) When we disabled UFO in the virtio_net device, it introduces some
        serious performance regressions.  The orignal problem was IPV6
        fragment ID generation, so fix that properly instead.  From Vlad
        Yasevich.
    
    17) sr9700 driver build breaks on xtensa because it defines macros with
        the same name as those used by the arch code.  Use more unique
        names.  From Chen Gang.
    
    18) Fix endianness in new virio 1.0 mode of the vhost net driver, from
        Michael S Tsirkin.
    
    19) Several sysctls were setting the maxlen attribute incorrectly, from
        Sasha Levin.
    
    20) Don't accept an FQ scheduler quantum of zero, that leads to crashes.
        From Kenneth Klette Jonassen.
    
    21) Fix dumping of non-existing actions in the packet scheduler
        classifier.  From Ignacy Gawdzki.
    
    22) Return the write work_done value when doing TX work in the qlcnic
        driver.
    
    23) ip6gre_err accesses the info field with the wrong endianness, from
        Sabrina Dubroca.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (54 commits)
      sit: fix some __be16/u16 mismatches
      ipv6: fix sparse errors in ip6_make_flowlabel()
      net: remove some sparse warnings
      flow_keys: n_proto type should be __be16
      ip6_gre: fix endianness errors in ip6gre_err
      qlcnic: Fix NAPI poll routine for Tx completion
      amd-xgbe: Set RSS enablement based on hardware features
      amd-xgbe: Adjust for zero-based traffic class count
      cls_api.c: Fix dumping of non-existing actions' stats.
      pkt_sched: fq: avoid hang when quantum 0
      net: rds: use correct size for max unacked packets and bytes
      vhost/net: fix up num_buffers endian-ness
      gianfar: correct the bad expression while writing bit-pattern
      net: usb: sr9700: Use 'SR_' prefix for the common register macros
      Revert "drivers/net: Disable UFO through virtio"
      Revert "drivers/net, ipv6: Select IPv6 fragment idents for virtio UFO packets"
      ipv6: Select fragment id during UFO segmentation if not set.
      xen-netback: stop the guest rx thread after a fatal error
      net/mlx4_core: Fix kernel Oops (mem corruption) when working with more than 80 VFs
      isdn: off by one in connect_res()
      ...

commit 72d7e0fe4d22352f69c87bd3c058b05a68101706
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    commit 600ddd6825543962fb807884169e57b580dba208 upstream.
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Moritz Muehlenhoff <jmm@debian.org>
    Cc: Ben Hutchings <ben@decadent.org.uk>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit cfbf654efc6d78dc9812e030673b86f235bf677d
Author: Saran Maruti Ramanara <saran.neti@telus.com>
Date:   Thu Jan 29 11:05:58 2015 +0100

    net: sctp: fix passing wrong parameter header to param_type2af in sctp_process_param
    
    When making use of RFC5061, section 4.2.4. for setting the primary IP
    address, we're passing a wrong parameter header to param_type2af(),
    resulting always in NULL being returned.
    
    At this point, param.p points to a sctp_addip_param struct, containing
    a sctp_paramhdr (type = 0xc004, length = var), and crr_id as a correlation
    id. Followed by that, as also presented in RFC5061 section 4.2.4., comes
    the actual sctp_addr_param, which also contains a sctp_paramhdr, but
    this time with the correct type SCTP_PARAM_IPV{4,6}_ADDRESS that
    param_type2af() can make use of. Since we already hold a pointer to
    addr_param from previous line, just reuse it for param_type2af().
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Saran Maruti Ramanara <saran.neti@telus.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 59343cd7c4809cf7598789e1cd14563780ae4239
Merge: 7da323bb456d 06539d307106
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jan 27 13:55:36 2015 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Don't OOPS on socket AIO, from Christoph Hellwig.
    
     2) Scheduled scans should be aborted upon RFKILL, from Emmanuel
        Grumbach.
    
     3) Fix sleep in atomic context in kvaser_usb, from Ahmed S Darwish.
    
     4) Fix RCU locking across copy_to_user() in bpf code, from Alexei
        Starovoitov.
    
     5) Lots of crash, memory leak, short TX packet et al bug fixes in
        sh_eth from Ben Hutchings.
    
     6) Fix memory corruption in SCTP wrt.  INIT collitions, from Daniel
        Borkmann.
    
     7) Fix return value logic for poll handlers in netxen, enic, and bnx2x.
        From Eric Dumazet and Govindarajulu Varadarajan.
    
     8) Header length calculation fix in mac80211 from Fred Chou.
    
     9) mv643xx_eth doesn't handle highmem correctly in non-TSO code paths.
        From Ezequiel Garcia.
    
    10) udp_diag has bogus logic in it's hash chain skipping, copy same fix
        tcp diag used.  From Herbert Xu.
    
    11) amd-xgbe programs wrong rx flow control register, from Thomas
        Lendacky.
    
    12) Fix race leading to use after free in ping receive path, from Subash
        Abhinov Kasiviswanathan.
    
    13) Cache redirect routes otherwise we can get a heavy backlog of rcu
        jobs liberating DST_NOCACHE entries.  From Hannes Frederic Sowa.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (48 commits)
      net: don't OOPS on socket aio
      stmmac: prevent probe drivers to crash kernel
      bnx2x: fix napi poll return value for repoll
      ipv6: replacing a rt6_info needs to purge possible propagated rt6_infos too
      sh_eth: Fix DMA-API usage for RX buffers
      sh_eth: Check for DMA mapping errors on transmit
      sh_eth: Ensure DMA engines are stopped before freeing buffers
      sh_eth: Remove RX overflow log messages
      ping: Fix race in free in receive path
      udp_diag: Fix socket skipping within chain
      can: kvaser_usb: Fix state handling upon BUS_ERROR events
      can: kvaser_usb: Retry the first bulk transfer on -ETIMEDOUT
      can: kvaser_usb: Send correct context to URB completion
      can: kvaser_usb: Do not sleep in atomic context
      ipv4: try to cache dst_entries which would cause a redirect
      samples: bpf: relax test_maps check
      bpf: rcu lock must not be held when calling copy_to_user()
      net: sctp: fix slab corruption from use after free on INIT collisions
      net: mv643xx_eth: Fix highmem support in non-TSO egress path
      sh_eth: Fix serialisation of interrupt disable with interrupt & NAPI handlers
      ...

commit 600ddd6825543962fb807884169e57b580dba208
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 22 18:26:54 2015 +0100

    net: sctp: fix slab corruption from use after free on INIT collisions
    
    When hitting an INIT collision case during the 4WHS with AUTH enabled, as
    already described in detail in commit 1be9a950c646 ("net: sctp: inherit
    auth_capable on INIT collisions"), it can happen that we occasionally
    still remotely trigger the following panic on server side which seems to
    have been uncovered after the fix from commit 1be9a950c646 ...
    
    [  533.876389] BUG: unable to handle kernel paging request at 00000000ffffffff
    [  533.913657] IP: [<ffffffff811ac385>] __kmalloc+0x95/0x230
    [  533.940559] PGD 5030f2067 PUD 0
    [  533.957104] Oops: 0000 [#1] SMP
    [  533.974283] Modules linked in: sctp mlx4_en [...]
    [  534.939704] Call Trace:
    [  534.951833]  [<ffffffff81294e30>] ? crypto_init_shash_ops+0x60/0xf0
    [  534.984213]  [<ffffffff81294e30>] crypto_init_shash_ops+0x60/0xf0
    [  535.015025]  [<ffffffff8128c8ed>] __crypto_alloc_tfm+0x6d/0x170
    [  535.045661]  [<ffffffff8128d12c>] crypto_alloc_base+0x4c/0xb0
    [  535.074593]  [<ffffffff8160bd42>] ? _raw_spin_lock_bh+0x12/0x50
    [  535.105239]  [<ffffffffa0418c11>] sctp_inet_listen+0x161/0x1e0 [sctp]
    [  535.138606]  [<ffffffff814e43bd>] SyS_listen+0x9d/0xb0
    [  535.166848]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    ... or depending on the the application, for example this one:
    
    [ 1370.026490] BUG: unable to handle kernel paging request at 00000000ffffffff
    [ 1370.026506] IP: [<ffffffff811ab455>] kmem_cache_alloc+0x75/0x1d0
    [ 1370.054568] PGD 633c94067 PUD 0
    [ 1370.070446] Oops: 0000 [#1] SMP
    [ 1370.085010] Modules linked in: sctp kvm_amd kvm [...]
    [ 1370.963431] Call Trace:
    [ 1370.974632]  [<ffffffff8120f7cf>] ? SyS_epoll_ctl+0x53f/0x960
    [ 1371.000863]  [<ffffffff8120f7cf>] SyS_epoll_ctl+0x53f/0x960
    [ 1371.027154]  [<ffffffff812100d3>] ? anon_inode_getfile+0xd3/0x170
    [ 1371.054679]  [<ffffffff811e3d67>] ? __alloc_fd+0xa7/0x130
    [ 1371.080183]  [<ffffffff816149a9>] system_call_fastpath+0x16/0x1b
    
    With slab debugging enabled, we can see that the poison has been overwritten:
    
    [  669.826368] BUG kmalloc-128 (Tainted: G        W     ): Poison overwritten
    [  669.826385] INFO: 0xffff880228b32e50-0xffff880228b32e50. First byte 0x6a instead of 0x6b
    [  669.826414] INFO: Allocated in sctp_auth_create_key+0x23/0x50 [sctp] age=3 cpu=0 pid=18494
    [  669.826424]  __slab_alloc+0x4bf/0x566
    [  669.826433]  __kmalloc+0x280/0x310
    [  669.826453]  sctp_auth_create_key+0x23/0x50 [sctp]
    [  669.826471]  sctp_auth_asoc_create_secret+0xcb/0x1e0 [sctp]
    [  669.826488]  sctp_auth_asoc_init_active_key+0x68/0xa0 [sctp]
    [  669.826505]  sctp_do_sm+0x29d/0x17c0 [sctp] [...]
    [  669.826629] INFO: Freed in kzfree+0x31/0x40 age=1 cpu=0 pid=18494
    [  669.826635]  __slab_free+0x39/0x2a8
    [  669.826643]  kfree+0x1d6/0x230
    [  669.826650]  kzfree+0x31/0x40
    [  669.826666]  sctp_auth_key_put+0x19/0x20 [sctp]
    [  669.826681]  sctp_assoc_update+0x1ee/0x2d0 [sctp]
    [  669.826695]  sctp_do_sm+0x674/0x17c0 [sctp]
    
    Since this only triggers in some collision-cases with AUTH, the problem at
    heart is that sctp_auth_key_put() on asoc->asoc_shared_key is called twice
    when having refcnt 1, once directly in sctp_assoc_update() and yet again
    from within sctp_auth_asoc_init_active_key() via sctp_assoc_update() on
    the already kzfree'd memory, which is also consistent with the observation
    of the poison decrease from 0x6b to 0x6a (note: the overwrite is detected
    at a later point in time when poison is checked on new allocation).
    
    Reference counting of auth keys revisited:
    
    Shared keys for AUTH chunks are being stored in endpoints and associations
    in endpoint_shared_keys list. On endpoint creation, a null key is being
    added; on association creation, all endpoint shared keys are being cached
    and thus cloned over to the association. struct sctp_shared_key only holds
    a pointer to the actual key bytes, that is, struct sctp_auth_bytes which
    keeps track of users internally through refcounting. Naturally, on assoc
    or enpoint destruction, sctp_shared_key are being destroyed directly and
    the reference on sctp_auth_bytes dropped.
    
    User space can add keys to either list via setsockopt(2) through struct
    sctp_authkey and by passing that to sctp_auth_set_key() which replaces or
    adds a new auth key. There, sctp_auth_create_key() creates a new sctp_auth_bytes
    with refcount 1 and in case of replacement drops the reference on the old
    sctp_auth_bytes. A key can be set active from user space through setsockopt()
    on the id via sctp_auth_set_active_key(), which iterates through either
    endpoint_shared_keys and in case of an assoc, invokes (one of various places)
    sctp_auth_asoc_init_active_key().
    
    sctp_auth_asoc_init_active_key() computes the actual secret from local's
    and peer's random, hmac and shared key parameters and returns a new key
    directly as sctp_auth_bytes, that is asoc->asoc_shared_key, plus drops
    the reference if there was a previous one. The secret, which where we
    eventually double drop the ref comes from sctp_auth_asoc_set_secret() with
    intitial refcount of 1, which also stays unchanged eventually in
    sctp_assoc_update(). This key is later being used for crypto layer to
    set the key for the hash in crypto_hash_setkey() from sctp_auth_calculate_hmac().
    
    To close the loop: asoc->asoc_shared_key is freshly allocated secret
    material and independant of the sctp_shared_key management keeping track
    of only shared keys in endpoints and assocs. Hence, also commit 4184b2a79a76
    ("net: sctp: fix memory leak in auth key management") is independant of
    this bug here since it concerns a different layer (though same structures
    being used eventually). asoc->asoc_shared_key is reference dropped correctly
    on assoc destruction in sctp_association_free() and when active keys are
    being replaced in sctp_auth_asoc_init_active_key(), it always has a refcount
    of 1. Hence, it's freed prematurely in sctp_assoc_update(). Simple fix is
    to remove that sctp_auth_key_put() from there which fixes these panics.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 85c981d1b144ddea85cf8827e7afafda024cf684
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    commit db29a9508a9246e77087c5531e45b2c88ec6988b upstream.
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit eef8f4c2acac6fae84f2d959a145fa3cad4d00c9
Merge: 2262889091c1 a8c1d28ac392
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jan 20 18:19:31 2015 +1200

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Socket addresses returned in the error queue need to be fully
        initialized before being passed on to userspace, fix from Willem de
        Bruijn.
    
     2) Interrupt handling fixes to davinci_emac driver from Tony Lindgren.
    
     3) Fix races between receive packet steering and cpu hotplug, from Eric
        Dumazet.
    
     4) Allowing netlink sockets to subscribe to unknown multicast groups
        leads to crashes, don't allow it.  From Johannes Berg.
    
     5) One to many socket races in SCTP fixed by Daniel Borkmann.
    
     6) Put in a guard against the mis-use of ipv6 atomic fragments, from
        Hagen Paul Pfeifer.
    
     7) Fix promisc mode and ethtool crashes in sh_eth driver, from Ben
        Hutchings.
    
     8) NULL deref and double kfree fix in sxgbe driver from Girish K.S and
        Byungho An.
    
     9) cfg80211 deadlock fix from Arik Nemtsov.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (36 commits)
      s2io: use snprintf() as a safety feature
      r8152: remove sram_read
      r8152: remove generic_ocp_read before writing
      bgmac: activate irqs only if there is nothing to poll
      bgmac: register napi before the device
      sh_eth: Fix ethtool operation crash when net device is down
      sh_eth: Fix promiscuous mode on chips without TSU
      ipv6: stop sending PTB packets for MTU < 1280
      net: sctp: fix race for one-to-many sockets in sendmsg's auto associate
      genetlink: synchronize socket closing and family removal
      genetlink: disallow subscribing to unknown mcast groups
      genetlink: document parallel_ops
      net: rps: fix cpu unplug
      net: davinci_emac: Add support for emac on dm816x
      net: davinci_emac: Fix ioremap for devices with MDIO within the EMAC address space
      net: davinci_emac: Fix incomplete code for getting the phy from device tree
      net: davinci_emac: Free clock after checking the frequency
      net: davinci_emac: Fix runtime pm calls for davinci_emac
      net: davinci_emac: Fix hangs with interrupts
      ip: zero sockaddr returned on error queue
      ...

commit 2061dcd6bff8b774b4fac8b0739b6be3f87bc9f2
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Jan 15 16:34:35 2015 +0100

    net: sctp: fix race for one-to-many sockets in sendmsg's auto associate
    
    I.e. one-to-many sockets in SCTP are not required to explicitly
    call into connect(2) or sctp_connectx(2) prior to data exchange.
    Instead, they can directly invoke sendmsg(2) and the SCTP stack
    will automatically trigger connection establishment through 4WHS
    via sctp_primitive_ASSOCIATE(). However, this in its current
    implementation is racy: INIT is being sent out immediately (as
    it cannot be bundled anyway) and the rest of the DATA chunks are
    queued up for later xmit when connection is established, meaning
    sendmsg(2) will return successfully. This behaviour can result
    in an undesired side-effect that the kernel made the application
    think the data has already been transmitted, although none of it
    has actually left the machine, worst case even after close(2)'ing
    the socket.
    
    Instead, when the association from client side has been shut down
    e.g. first gracefully through SCTP_EOF and then close(2), the
    client could afterwards still receive the server's INIT_ACK due
    to a connection with higher latency. This INIT_ACK is then considered
    out of the blue and hence responded with ABORT as there was no
    alive assoc found anymore. This can be easily reproduced f.e.
    with sctp_test application from lksctp. One way to fix this race
    is to wait for the handshake to actually complete.
    
    The fix defers waiting after sctp_primitive_ASSOCIATE() and
    sctp_primitive_SEND() succeeded, so that DATA chunks cooked up
    from sctp_sendmsg() have already been placed into the output
    queue through the side-effect interpreter, and therefore can then
    be bundeled together with COOKIE_ECHO control chunks.
    
    strace from example application (shortened):
    
    socket(PF_INET, SOCK_SEQPACKET, IPPROTO_SCTP) = 3
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(1)=[{"hello", 5}], msg_controllen=0, msg_flags=0}, 0) = 5
    sendmsg(3, {msg_name(28)={sa_family=AF_INET, sin_port=htons(8888), sin_addr=inet_addr("192.168.1.115")},
               msg_iov(0)=[], msg_controllen=48, {cmsg_len=48, cmsg_level=0x84 /* SOL_??? */, cmsg_type=, ...},
               msg_flags=0}, 0) = 0 // graceful shutdown for SOCK_SEQPACKET via SCTP_EOF
    close(3) = 0
    
    tcpdump before patch (fooling the application):
    
    22:33:36.306142 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 3879023686] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3139201684]
    22:33:36.316619 IP 192.168.1.115.8888 > 192.168.1.114.41462: sctp (1) [INIT ACK] [init tag: 3345394793] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 3380109591]
    22:33:36.317600 IP 192.168.1.114.41462 > 192.168.1.115.8888: sctp (1) [ABORT]
    
    tcpdump after patch:
    
    14:28:58.884116 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [INIT] [init tag: 438593213] [rwnd: 106496] [OS: 10] [MIS: 65535] [init TSN: 3092969729]
    14:28:58.888414 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [INIT ACK] [init tag: 381429855] [rwnd: 106496] [OS: 10] [MIS: 10] [init TSN: 2141904492]
    14:28:58.888638 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [COOKIE ECHO] , (2) [DATA] (B)(E) [TSN: 3092969729] [...]
    14:28:58.893278 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [COOKIE ACK] , (2) [SACK] [cum ack 3092969729] [a_rwnd 106491] [#gap acks 0] [#dup tsns 0]
    14:28:58.893591 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969730] [...]
    14:28:59.096963 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969730] [a_rwnd 106496] [#gap acks 0] [#dup tsns 0]
    14:28:59.097086 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [DATA] (B)(E) [TSN: 3092969731] [...] , (2) [DATA] (B)(E) [TSN: 3092969732] [...]
    14:28:59.103218 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SACK] [cum ack 3092969732] [a_rwnd 106486] [#gap acks 0] [#dup tsns 0]
    14:28:59.103330 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN]
    14:28:59.107793 IP 192.168.1.115.8888 > 192.168.1.114.35846: sctp (1) [SHUTDOWN ACK]
    14:28:59.107890 IP 192.168.1.114.35846 > 192.168.1.115.8888: sctp (1) [SHUTDOWN COMPLETE]
    
    Looks like this bug is from the pre-git history museum. ;)
    
    Fixes: 08707d5482df ("lksctp-2_5_31-0_5_1.patch")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 72237d47c78ab849c55c6cc0211315db1f1f324b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    [ Upstream commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 ]
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 85c3fe917f5459427c4ba5797332f9910400afeb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 upstream.
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 3af10169145c8eed7b3591c0644da4298405efbc
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    commit 4184b2a79a7612a9272ce20d639934584a1f3786 upstream.
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 590461b16c5464b9d4377898abc057239a6afc3a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    commit e40607cbe270a9e8360907cb1e62ddf0736e4864 upstream.
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ab12ec41d8d8fe5bb286daee450f64cf845c4a09
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    [ Upstream commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 ]
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4c60f294000b7c7e617c7f08ad04fd104cc6fbaf
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    [ Upstream commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 ]
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 729ae1da461bbaf1ab1a1a7be7ce60f969a47b54
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    [ Upstream commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 ]
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 751e5624915f39d16f935a06002cba2a4712df42
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    [ Upstream commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 ]
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0dc93e01087dfa52a4b7056e4dec98b582012324
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5 upstream.
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 4e5bfd776f9f8f9add60e9eb1a9d7042a48ae2b5
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 24 12:16:01 2014 +0000

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    commit a6e1af6f5e9e75095ae1b004f6f00082e5fc4d2d upstream
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit e40607cbe270a9e8360907cb1e62ddf0736e4864)
    CVE-2014-7841
    BugLink: http://bugs.launchpad.net/bugs/1392820
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Andy Whitcroft <apw@canonical.com>
    Acked-by: Stefan Bader <stefan.bader@canonical.com>
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit b77b8578b6924ffbc77279b7856ee1a77232ef5a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Nov 11 17:49:30 2014 +0000

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit b2d33ef40de7161c23032106284959ae75bdf3cd upstream
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit 26b87c7881006311828bb0ab271a551a62dcceb4)
    CVE-2014-3688
    BugLink: http://bugs.launchpad.net/bugs/1386393
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit eec4c8182fd04911e474d43593581fcc95a03833
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Nov 11 17:49:24 2014 +0000

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit 12b18fdbbda747ad22a7684413a6559b681e503c upstream
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit b69040d8e39f20d5215a03502a8e8b4c6ab78395)
    CVE-2014-3687
    BugLink: http://bugs.launchpad.net/bugs/1386392
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>
    Acked-by: Andy Whitcroft <andy.whitcroft@canonical.com>
    Signed-off-by: Brad Figg <brad.figg@canonical.com>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 9772b54c55266ce80c639a80aa68eeb908f8ecf5
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Dec 3 12:13:58 2014 +0100

    net: sctp: use MAX_HEADER for headroom reserve in output path
    
    To accomodate for enough headroom for tunnels, use MAX_HEADER instead
    of LL_MAX_HEADER. Robert reported that he has hit after roughly 40hrs
    of trinity an skb_under_panic() via SCTP output path (see reference).
    I couldn't reproduce it from here, but not using MAX_HEADER as elsewhere
    in other protocols might be one possible cause for this.
    
    In any case, it looks like accounting on chunks themself seems to look
    good as the skb already passed the SCTP output path and did not hit
    any skb_over_panic(). Given tunneling was enabled in his .config, the
    headroom would have been expanded by MAX_HEADER in this case.
    
    Reported-by: Robert wicki <robert@swiecki.net>
    Reference: https://lkml.org/lkml/2014/12/1/507
    Fixes: 594ccc14dfe4d ("[SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6bd693b534e77532f621021597bcc3a6f924ff00
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    commit 4184b2a79a7612a9272ce20d639934584a1f3786 upstream.
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 1cfecc6bca7a8a81ded208b5b2e0a56a6b52ad9a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    commit e40607cbe270a9e8360907cb1e62ddf0736e4864 upstream.
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 5abff9a5a12f45b27139b0fbd87570be3169926b
Author: Zhu Yanjun <zyjzyj2000@gmail.com>
Date:   Thu Nov 20 14:04:40 2014 +0800

    sctp: not send SCTP_PEER_ADDR_CHANGE notifications with failed probe
    
    2.6.x kernels require a similar logic change as commit 2c0d6ac894a
    [sctp: not send SCTP_PEER_ADDR_CHANGE notifications with failed probe]
    introduces for newer kernels.
    
    Since the transport has always been in state SCTP_UNCONFIRMED, it
    therefore wasn't active before and hasn't been used before, and it
    always has been, so it is unnecessary to bug the user with a
    notification.
    
    Reported-by: Deepak Khandelwal <khandelwal.deepak.1987@gmail.com>
    Suggested-by: Vlad Yasevich <vyasevich@gmail.com>
    Suggested-by: Michael Tuexen <tuexen@fh-muenster.de>
    Suggested-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Zhu Yanjun <Yanjun.Zhu@windriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 237d7b2521815c41c245ca22219f4cca2ec75058
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    (cherry picked from commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74)
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit ebec0c65d3945312fd56d894f0fa910c5f4c0199
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit ef94866eb091d2d92bf99633daf2d819825abe89
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit f869c912869edc2754355af9e10e5aaff8ff5a40
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Nov 20 01:54:48 2014 +0100

    net: sctp: keep owned chunk in destructor_arg instead of skb->cb
    
    It's just silly to hold the skb destructor argument around inside
    skb->cb[] as we currently do in SCTP.
    
    Nowadays, we're sort of cheating on data accounting in the sense
    that due to commit 4c3a5bdae293 ("sctp: Don't charge for data in
    sndbuf again when transmitting packet"), we orphan the skb already
    in the SCTP output path, i.e. giving back charged data memory, and
    use a different destructor only to make sure the sk doesn't vanish
    on skb destruction time. Thus, cb[] is still valid here as we
    operate within the SCTP layer. (It's generally actually a big
    candidate for future rework, imho.)
    
    However, storing the destructor in the cb[] can easily cause issues
    should an non sctp_packet_set_owner_w()'ed skb ever escape the SCTP
    layer, since cb[] may get overwritten by lower layers and thus can
    corrupt the chunk pointer. There are no such issues at present,
    but lets keep the chunk in destructor_arg, as this is the actual
    purpose for it.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 35e95fae72ddb67ef94395d99abc48589ce17875
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dd8aaf1f380e008044857d7d2293e8e2824772b8
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5a282822a9e472a41a7e2db71903a1c6654c634a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9f92bef53b0f3306abe272be293435d445a4c3b6
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    [ Upstream commit 4184b2a79a7612a9272ce20d639934584a1f3786 ]
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c9d8f492baeca8b76866840cb831c77e0dcba67d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    [ Upstream commit e40607cbe270a9e8360907cb1e62ddf0736e4864 ]
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e36b6ac9e011205eb7ad3af329dbd27a21bacd50
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 59ea8663e3a7fc3a0c2841e310b83f7aaec1c017
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 75680aa393f12465fc10642d2d55be49a333d828
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f58ee885658bd83f6580751a2b8a8e3ad6cd6665
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    [ Upstream commit 4184b2a79a7612a9272ce20d639934584a1f3786 ]
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 358905266ed83d4a9e693ae7ff86c1595220ec60
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    [ Upstream commit e40607cbe270a9e8360907cb1e62ddf0736e4864 ]
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cda702df4736ab981f81ea4b529d14a2858fdc36
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3329125539de90e5fa6ab83009f5f82ef73a3259
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bf53932bce5c58cf006ca2e1f81bd1d66d14ba45
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e79c2487e4e01ccad077252c398627fd99f55924
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    [ Upstream commit 4184b2a79a7612a9272ce20d639934584a1f3786 ]
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7031dcb018db2a7776c1c31ef156cf8ac8da8a99
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    [ Upstream commit e40607cbe270a9e8360907cb1e62ddf0736e4864 ]
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bbd951a21e0fd555cd9ede44c7196af09d04d171
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit a723db0be941b8aebaa1a98b33d17a91b16603e4
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit e476841415c1b7b54e4118d8a219f5db71878675
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Cc: Josh Boyer <jwboyer@fedoraproject.org>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 7e9acaf571479dce19aad5a2ab45a64db1d69c4a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    [ Upstream commit 4184b2a79a7612a9272ce20d639934584a1f3786 ]
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 4008f1dbe6fea8114e7f79ed2d238e369dc9138f
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    [ Upstream commit e40607cbe270a9e8360907cb1e62ddf0736e4864 ]
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 5cf52037042d3ad7432df1aec004a935e83939a6
Merge: 971ad4e4d683 19ca9fc1445b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Nov 13 17:54:08 2014 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) sunhme driver lacks DMA mapping error checks, based upon a report by
        Meelis Roos.
    
     2) Fix memory leak in mvpp2 driver, from Sudip Mukherjee.
    
     3) DMA memory allocation sizes are wrong in systemport ethernet driver,
        fix from Florian Fainelli.
    
     4) Fix use after free in mac80211 defragmentation code, from Johannes
        Berg.
    
     5) Some networking uapi headers missing from Kbuild file, from Stephen
        Hemminger.
    
     6) TUN driver gets csum_start offset wrong when VLAN accel is enabled,
        and macvtap has a similar bug, from Herbert Xu.
    
     7) Adjust several tunneling drivers to set dev->iflink after registry,
        because registry sets that to -1 overwriting whatever we did.  From
        Steffen Klassert.
    
     8) Geneve forgets to set inner tunneling type, causing GSO segmentation
        to fail on some NICs.  From Jesse Gross.
    
     9) Fix several locking bugs in stmmac driver, from Fabrice Gasnier and
        Giuseppe CAVALLARO.
    
    10) Fix spurious timeouts with NewReno on low traffic connections, from
        Marcelo Leitner.
    
    11) Fix descriptor updates in enic driver, from Govindarajulu
        Varadarajan.
    
    12) PPP calls bpf_prog_create() with locks held, which isn't kosher.
        Fix from Takashi Iwai.
    
    13) Fix NULL deref in SCTP with malformed INIT packets, from Daniel
        Borkmann.
    
    14) psock_fanout selftest accesses past the end of the mmap ring, fix
        from Shuah Khan.
    
    15) Fix PTP timestamping for VLAN packets, from Richard Cochran.
    
    16) netlink_unbind() calls in netlink pass wrong initial argument, from
        Hiroaki SHIMODA.
    
    17) vxlan socket reuse accidently reuses a socket when the address
        family is different, so we have to explicitly check this, from
        Marcelo Lietner.
    
    18) Fix missing include in nft_reject_bridge.c breaking the build on ppc
        and other architectures, from Guenter Roeck.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (75 commits)
      vxlan: Do not reuse sockets for a different address family
      smsc911x: power-up phydev before doing a software reset.
      lib: rhashtable - Remove weird non-ASCII characters from comments
      net/smsc911x: Fix delays in the PHY enable/disable routines
      net/smsc911x: Fix rare soft reset timeout issue due to PHY power-down mode
      netlink: Properly unbind in error conditions.
      net: ptp: fix time stamp matching logic for VLAN packets.
      cxgb4 : dcb open-lldp interop fixes
      selftests/net: psock_fanout seg faults in sock_fanout_read_ring()
      net: bcmgenet: apply MII configuration in bcmgenet_open()
      net: bcmgenet: connect and disconnect from the PHY state machine
      net: qualcomm: Fix dependency
      ixgbe: phy: fix uninitialized status in ixgbe_setup_phy_link_tnx
      net: phy: Correctly handle MII ioctl which changes autonegotiation.
      ipv6: fix IPV6_PKTINFO with v4 mapped
      net: sctp: fix memory leak in auth key management
      net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
      net: ppp: Don't call bpf_prog_create() in ppp_lock
      net/mlx4_en: Advertize encapsulation offloads features only when VXLAN tunnel is set
      cxgb4 : Fix bug in DCB app deletion
      ...

commit 565d3c2b451cb7078128ee834ddabb02d02af3e5
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 790395f95e3b8d81bf681a2a535443c70a111f66
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 240432f953757528abd23c5f76abfb092f05fc86
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Luis Henriques <luis.henriques@canonical.com>

commit 4184b2a79a7612a9272ce20d639934584a1f3786
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 18:00:09 2014 +0100

    net: sctp: fix memory leak in auth key management
    
    A very minimal and simple user space application allocating an SCTP
    socket, setting SCTP_AUTH_KEY setsockopt(2) on it and then closing
    the socket again will leak the memory containing the authentication
    key from user space:
    
    unreferenced object 0xffff8800837047c0 (size 16):
      comm "a.out", pid 2789, jiffies 4296954322 (age 192.258s)
      hex dump (first 16 bytes):
        01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff816d7e8e>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff811c88d8>] __kmalloc+0xe8/0x270
        [<ffffffffa0870c23>] sctp_auth_create_key+0x23/0x50 [sctp]
        [<ffffffffa08718b1>] sctp_auth_set_key+0xa1/0x140 [sctp]
        [<ffffffffa086b383>] sctp_setsockopt+0xd03/0x1180 [sctp]
        [<ffffffff815bfd94>] sock_common_setsockopt+0x14/0x20
        [<ffffffff815beb61>] SyS_setsockopt+0x71/0xd0
        [<ffffffff816e58a9>] system_call_fastpath+0x12/0x17
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    This is bad because of two things, we can bring down a machine from
    user space when auth_enable=1, but also we would leave security sensitive
    keying material in memory without clearing it after use. The issue is
    that sctp_auth_create_key() already sets the refcount to 1, but after
    allocation sctp_auth_set_key() does an additional refcount on it, and
    thus leaving it around when we free the socket.
    
    Fixes: 65b07e5d0d0 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e40607cbe270a9e8360907cb1e62ddf0736e4864
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Nov 10 17:54:26 2014 +0100

    net: sctp: fix NULL pointer dereference in af->from_addr_param on malformed packet
    
    An SCTP server doing ASCONF will panic on malformed INIT ping-of-death
    in the form of:
    
      ------------ INIT[PARAM: SET_PRIMARY_IP] ------------>
    
    While the INIT chunk parameter verification dissects through many things
    in order to detect malformed input, it misses to actually check parameters
    inside of parameters. E.g. RFC5061, section 4.2.4 proposes a 'set primary
    IP address' parameter in ASCONF, which has as a subparameter an address
    parameter.
    
    So an attacker may send a parameter type other than SCTP_PARAM_IPV4_ADDRESS
    or SCTP_PARAM_IPV6_ADDRESS, param_type2af() will subsequently return 0
    and thus sctp_get_af_specific() returns NULL, too, which we then happily
    dereference unconditionally through af->from_addr_param().
    
    The trace for the log:
    
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000078
    IP: [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    PGD 0
    Oops: 0000 [#1] SMP
    [...]
    Pid: 0, comm: swapper Not tainted 2.6.32-504.el6.x86_64 #1 Bochs Bochs
    RIP: 0010:[<ffffffffa01e9c62>]  [<ffffffffa01e9c62>] sctp_process_init+0x492/0x990 [sctp]
    [...]
    Call Trace:
     <IRQ>
     [<ffffffffa01f2add>] ? sctp_bind_addr_copy+0x5d/0xe0 [sctp]
     [<ffffffffa01e1fcb>] sctp_sf_do_5_1B_init+0x21b/0x340 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffffa01e5c09>] ? sctp_endpoint_lookup_assoc+0xc9/0xf0 [sctp]
     [<ffffffffa01e61f6>] sctp_endpoint_bh_rcv+0x116/0x230 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
    [...]
    
    A minimal way to address this is to check for NULL as we do on all
    other such occasions where we know sctp_get_af_specific() could
    possibly return with NULL.
    
    Fixes: d6de3097592b ("[SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3a8c709ba4cf6fe86f5069c71325029d412bcf1e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    commit 26b87c7881006311828bb0ab271a551a62dcceb4 upstream.
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9a3c6f2e051b608181aff9345481e586b2d54fc9
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    commit b69040d8e39f20d5215a03502a8e8b4c6ab78395 upstream.
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit aa001b043dde50e2856fe9460bc819d2a70dc309
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74 upstream.
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2:
     - Adjust context
     - sctp_sf_violation_paramlen() doesn't take a struct net * parameter]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b27fa9939d50b0302888849c62ecae7b9cb85dc5
Merge: b838b4aced99 26b87c788100
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Oct 14 12:46:29 2014 -0400

    Merge branch 'sctp'
    
    Daniel Borkmann says:
    
    ====================
    Here are some SCTP fixes.
    
    [ Note, immediate workaround would be to disable ASCONF (it
      is sysctl disabled by default). It is actually only used
      together with chunk authentication. ]
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 26b87c7881006311828bb0ab271a551a62dcceb4
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:33 2014 +0200

    net: sctp: fix remote memory pressure from excessive queueing
    
    This scenario is not limited to ASCONF, just taken as one
    example triggering the issue. When receiving ASCONF probes
    in the form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---- ASCONF_a; [ASCONF_b; ...; ASCONF_n;] JUNK ------>
      [...]
      ---- ASCONF_m; [ASCONF_o; ...; ASCONF_z;] JUNK ------>
    
    ... where ASCONF_a, ASCONF_b, ..., ASCONF_z are good-formed
    ASCONFs and have increasing serial numbers, we process such
    ASCONF chunk(s) marked with !end_of_packet and !singleton,
    since we have not yet reached the SCTP packet end. SCTP does
    only do verification on a chunk by chunk basis, as an SCTP
    packet is nothing more than just a container of a stream of
    chunks which it eats up one by one.
    
    We could run into the case that we receive a packet with a
    malformed tail, above marked as trailing JUNK. All previous
    chunks are here goodformed, so the stack will eat up all
    previous chunks up to this point. In case JUNK does not fit
    into a chunk header and there are no more other chunks in
    the input queue, or in case JUNK contains a garbage chunk
    header, but the encoded chunk length would exceed the skb
    tail, or we came here from an entirely different scenario
    and the chunk has pdiscard=1 mark (without having had a flush
    point), it will happen, that we will excessively queue up
    the association's output queue (a correct final chunk may
    then turn it into a response flood when flushing the
    queue ;)): I ran a simple script with incremental ASCONF
    serial numbers and could see the server side consuming
    excessive amount of RAM [before/after: up to 2GB and more].
    
    The issue at heart is that the chunk train basically ends
    with !end_of_packet and !singleton markers and since commit
    2e3216cd54b1 ("sctp: Follow security requirement of responding
    with 1 packet") therefore preventing an output queue flush
    point in sctp_do_sm() -> sctp_cmd_interpreter() on the input
    chunk (chunk = event_arg) even though local_cork is set,
    but its precedence has changed since then. In the normal
    case, the last chunk with end_of_packet=1 would trigger the
    queue flush to accommodate possible outgoing bundling.
    
    In the input queue, sctp_inq_pop() seems to do the right thing
    in terms of discarding invalid chunks. So, above JUNK will
    not enter the state machine and instead be released and exit
    the sctp_assoc_bh_rcv() chunk processing loop. It's simply
    the flush point being missing at loop exit. Adding a try-flush
    approach on the output queue might not work as the underlying
    infrastructure might be long gone at this point due to the
    side-effect interpreter run.
    
    One possibility, albeit a bit of a kludge, would be to defer
    invalid chunk freeing into the state machine in order to
    possibly trigger packet discards and thus indirectly a queue
    flush on error. It would surely be better to discard chunks
    as in the current, perhaps better controlled environment, but
    going back and forth, it's simply architecturally not possible.
    I tried various trailing JUNK attack cases and it seems to
    look good now.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b69040d8e39f20d5215a03502a8e8b4c6ab78395
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:32 2014 +0200

    net: sctp: fix panic on duplicate ASCONF chunks
    
    When receiving a e.g. semi-good formed connection scan in the
    form of ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ---------------- ASCONF_a; ASCONF_b ----------------->
    
    ... where ASCONF_a equals ASCONF_b chunk (at least both serials
    need to be equal), we panic an SCTP server!
    
    The problem is that good-formed ASCONF chunks that we reply with
    ASCONF_ACK chunks are cached per serial. Thus, when we receive a
    same ASCONF chunk twice (e.g. through a lost ASCONF_ACK), we do
    not need to process them again on the server side (that was the
    idea, also proposed in the RFC). Instead, we know it was cached
    and we just resend the cached chunk instead. So far, so good.
    
    Where things get nasty is in SCTP's side effect interpreter, that
    is, sctp_cmd_interpreter():
    
    While incoming ASCONF_a (chunk = event_arg) is being marked
    !end_of_packet and !singleton, and we have an association context,
    we do not flush the outqueue the first time after processing the
    ASCONF_ACK singleton chunk via SCTP_CMD_REPLY. Instead, we keep it
    queued up, although we set local_cork to 1. Commit 2e3216cd54b1
    changed the precedence, so that as long as we get bundled, incoming
    chunks we try possible bundling on outgoing queue as well. Before
    this commit, we would just flush the output queue.
    
    Now, while ASCONF_a's ASCONF_ACK sits in the corked outq, we
    continue to process the same ASCONF_b chunk from the packet. As
    we have cached the previous ASCONF_ACK, we find it, grab it and
    do another SCTP_CMD_REPLY command on it. So, effectively, we rip
    the chunk->list pointers and requeue the same ASCONF_ACK chunk
    another time. Since we process ASCONF_b, it's correctly marked
    with end_of_packet and we enforce an uncork, and thus flush, thus
    crashing the kernel.
    
    Fix it by testing if the ASCONF_ACK is currently pending and if
    that is the case, do not requeue it. When flushing the output
    queue we may relink the chunk for preparing an outgoing packet,
    but eventually unlink it when it's copied into the skb right
    before transmission.
    
    Joint work with Vlad Yasevich.
    
    Fixes: 2e3216cd54b1 ("sctp: Follow security requirement of responding with 1 packet")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9de7922bc709eee2f609cd01d98aaedc4cf5ea74
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Oct 9 22:55:31 2014 +0200

    net: sctp: fix skb_over_panic when receiving malformed ASCONF chunks
    
    Commit 6f4c618ddb0 ("SCTP : Add paramters validity check for
    ASCONF chunk") added basic verification of ASCONF chunks, however,
    it is still possible to remotely crash a server by sending a
    special crafted ASCONF chunk, even up to pre 2.6.12 kernels:
    
    skb_over_panic: text:ffffffffa01ea1c3 len:31056 put:30768
     head:ffff88011bd81800 data:ffff88011bd81800 tail:0x7950
     end:0x440 dev:<NULL>
     ------------[ cut here ]------------
    kernel BUG at net/core/skbuff.c:129!
    [...]
    Call Trace:
     <IRQ>
     [<ffffffff8144fb1c>] skb_put+0x5c/0x70
     [<ffffffffa01ea1c3>] sctp_addto_chunk+0x63/0xd0 [sctp]
     [<ffffffffa01eadaf>] sctp_process_asconf+0x1af/0x540 [sctp]
     [<ffffffff8152d025>] ? _read_unlock_bh+0x15/0x20
     [<ffffffffa01e0038>] sctp_sf_do_asconf+0x168/0x240 [sctp]
     [<ffffffffa01e3751>] sctp_do_sm+0x71/0x1210 [sctp]
     [<ffffffff8147645d>] ? fib_rules_lookup+0xad/0xf0
     [<ffffffffa01e6b22>] ? sctp_cmp_addr_exact+0x32/0x40 [sctp]
     [<ffffffffa01e8393>] sctp_assoc_bh_rcv+0xd3/0x180 [sctp]
     [<ffffffffa01ee986>] sctp_inq_push+0x56/0x80 [sctp]
     [<ffffffffa01fcc42>] sctp_rcv+0x982/0xa10 [sctp]
     [<ffffffffa01d5123>] ? ipt_local_in_hook+0x23/0x28 [iptable_filter]
     [<ffffffff8148bdc9>] ? nf_iterate+0x69/0xb0
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff8148bf86>] ? nf_hook_slow+0x76/0x120
     [<ffffffff81496d10>] ? ip_local_deliver_finish+0x0/0x2d0
     [<ffffffff81496ded>] ip_local_deliver_finish+0xdd/0x2d0
     [<ffffffff81497078>] ip_local_deliver+0x98/0xa0
     [<ffffffff8149653d>] ip_rcv_finish+0x12d/0x440
     [<ffffffff81496ac5>] ip_rcv+0x275/0x350
     [<ffffffff8145c88b>] __netif_receive_skb+0x4ab/0x750
     [<ffffffff81460588>] netif_receive_skb+0x58/0x60
    
    This can be triggered e.g., through a simple scripted nmap
    connection scan injecting the chunk after the handshake, for
    example, ...
    
      -------------- INIT[ASCONF; ASCONF_ACK] ------------->
      <----------- INIT-ACK[ASCONF; ASCONF_ACK] ------------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
      ------------------ ASCONF; UNKNOWN ------------------>
    
    ... where ASCONF chunk of length 280 contains 2 parameters ...
    
      1) Add IP address parameter (param length: 16)
      2) Add/del IP address parameter (param length: 255)
    
    ... followed by an UNKNOWN chunk of e.g. 4 bytes. Here, the
    Address Parameter in the ASCONF chunk is even missing, too.
    This is just an example and similarly-crafted ASCONF chunks
    could be used just as well.
    
    The ASCONF chunk passes through sctp_verify_asconf() as all
    parameters passed sanity checks, and after walking, we ended
    up successfully at the chunk end boundary, and thus may invoke
    sctp_process_asconf(). Parameter walking is done with
    WORD_ROUND() to take padding into account.
    
    In sctp_process_asconf()'s TLV processing, we may fail in
    sctp_process_asconf_param() e.g., due to removal of the IP
    address that is also the source address of the packet containing
    the ASCONF chunk, and thus we need to add all TLVs after the
    failure to our ASCONF response to remote via helper function
    sctp_add_asconf_response(), which basically invokes a
    sctp_addto_chunk() adding the error parameters to the given
    skb.
    
    When walking to the next parameter this time, we proceed
    with ...
    
      length = ntohs(asconf_param->param_hdr.length);
      asconf_param = (void *)asconf_param + length;
    
    ... instead of the WORD_ROUND()'ed length, thus resulting here
    in an off-by-one that leads to reading the follow-up garbage
    parameter length of 12336, and thus throwing an skb_over_panic
    for the reply when trying to sctp_addto_chunk() next time,
    which implicitly calls the skb_put() with that length.
    
    Fix it by using sctp_walk_params() [ which is also used in
    INIT parameter processing ] macro in the verification *and*
    in ASCONF processing: it will make sure we don't spill over,
    that we walk parameters WORD_ROUND()'ed. Moreover, we're being
    more defensive and guard against unknown parameter types and
    missized addresses.
    
    Joint work with Vlad Yasevich.
    
    Fixes: b896b82be4ae ("[SCTP] ADDIP: Support for processing incoming ASCONF_ACK chunks.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 852248449c73b5ffe109a33d65485c71d3d398a7
Merge: 735d383117e1 db29a9508a92
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Sep 29 14:46:53 2014 -0400

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    pull request: netfilter/ipvs updates for net-next
    
    The following patchset contains Netfilter/IPVS updates for net-next,
    most relevantly they are:
    
    1) Four patches to make the new nf_tables masquerading support
       independent of the x_tables infrastructure. This also resolves a
       compilation breakage if the masquerade target is disabled but the
       nf_tables masq expression is enabled.
    
    2) ipset updates via Jozsef Kadlecsik. This includes the addition of the
       skbinfo extension that allows you to store packet metainformation in the
       elements. This can be used to fetch and restore this to the packets through
       the iptables SET target, patches from Anton Danilov.
    
    3) Add the hash:mac set type to ipset, from Jozsef Kadlecsick.
    
    4) Add simple weighted fail-over scheduler via Simon Horman. This provides
       a fail-over IPVS scheduler (unlike existing load balancing schedulers).
       Connections are directed to the appropriate server based solely on
       highest weight value and server availability, patch from Kenny Mathis.
    
    5) Support IPv6 real servers in IPv4 virtual-services and vice versa.
       Simon Horman informs that the motivation for this is to allow more
       flexibility in the choice of IP version offered by both virtual-servers
       and real-servers as they no longer need to match: An IPv4 connection
       from an end-user may be forwarded to a real-server using IPv6 and
       vice versa. No ip_vs_sync support yet though. Patches from Alex Gartrell
       and Julian Anastasov.
    
    6) Add global generation ID to the nf_tables ruleset. When dumping from
       several different object lists, we need a way to identify that an update
       has ocurred so userspace knows that it needs to refresh its lists. This
       also includes a new command to obtain the 32-bits generation ID. The
       less significant 16-bits of this ID is also exposed through res_id field
       in the nfnetlink header to quickly detect the interference and retry when
       there is no risk of ID wraparound.
    
    7) Move br_netfilter out of the bridge core. The br_netfilter code is
       built in the bridge core by default. This causes problems of different
       kind to people that don't want this: Jesper reported performance drop due
       to the inconditional hook registration and I remember to have read complains
       on netdev from people regarding the unexpected behaviour of our bridging
       stack when br_netfilter is enabled (fragmentation handling, layer 3 and
       upper inspection). People that still need this should easily undo the
       damage by modprobing the new br_netfilter module.
    
    8) Dump the set policy nf_tables that allows set parameterization. So
       userspace can keep user-defined preferences when saving the ruleset.
       From Arturo Borrero.
    
    9) Use __seq_open_private() helper function to reduce boiler plate code
       in x_tables, From Rob Jones.
    
    10) Safer default behaviour in case that you forget to load the protocol
       tracker. Daniel Borkmann and Florian Westphal detected that if your
       ruleset is stateful, you allow traffic to at least one single SCTP port
       and the SCTP protocol tracker is not loaded, then any SCTP traffic may
       be pass through unfiltered. After this patch, the connection tracking
       classifies SCTP/DCCP/UDPlite/GRE packets as invalid if your kernel has
       been compiled with support for these modules.
    ====================
    
    Trivially resolved conflict in include/linux/skbuff.h, Eric moved some
    netfilter skbuff members around, and the netfilter tree adjusted the
    ifdef guards for the bridging info pointer.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit db29a9508a9246e77087c5531e45b2c88ec6988b
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Sep 26 11:35:42 2014 +0200

    netfilter: conntrack: disable generic tracking for known protocols
    
    Given following iptables ruleset:
    
    -P FORWARD DROP
    -A FORWARD -m sctp --dport 9 -j ACCEPT
    -A FORWARD -p tcp --dport 80 -j ACCEPT
    -A FORWARD -p tcp -m conntrack -m state ESTABLISHED,RELATED -j ACCEPT
    
    One would assume that this allows SCTP on port 9 and TCP on port 80.
    Unfortunately, if the SCTP conntrack module is not loaded, this allows
    *all* SCTP communication, to pass though, i.e. -p sctp -j ACCEPT,
    which we think is a security issue.
    
    This is because on the first SCTP packet on port 9, we create a dummy
    "generic l4" conntrack entry without any port information (since
    conntrack doesn't know how to extract this information).
    
    All subsequent packets that are unknown will then be in established
    state since they will fallback to proto_generic and will match the
    'generic' entry.
    
    Our originally proposed version [1] completely disabled generic protocol
    tracking, but Jozsef suggests to not track protocols for which a more
    suitable helper is available, hence we now mitigate the issue for in
    tree known ct protocol helpers only, so that at least NAT and direction
    information will still be preserved for others.
    
     [1] http://www.spinics.net/lists/netfilter-devel/msg33430.html
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 38710dd12b99b31bd21b0eac5f457915eaf5e04b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 030824e039d6702ee309bf7441c446038d6a43f7
Merge: 96d49225a495 71d7a2772510
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Aug 29 20:41:17 2014 -0700

    Merge branch 'csums-next'
    
    Tom Herbert says:
    
    ====================
    net: Checksum offload changes - Part VI
    
    I am working on overhauling RX checksum offload. Goals of this effort
    are:
    
    - Specify what exactly it means when driver returns CHECKSUM_UNNECESSARY
    - Preserve CHECKSUM_COMPLETE through encapsulation layers
    - Don't do skb_checksum more than once per packet
    - Unify GRO and non-GRO csum verification as much as possible
    - Unify the checksum functions (checksum_init)
    - Simplify code
    
    What is in this sixth patch set:
    
    - Clarify the specific requirements of devices returning
      CHECKSUM_UNNECESSARY (comments in skbuff.h).
    - Add csum_level field to skbuff. This is used to express how
      many checksums are covered by CHECKSUM_UNNECESSARY (stores n - 1).
    - Change __skb_checksum_validate_needed to "consume" each checksum
      as indicated by csum_level as layers of the the packet are parsed.
    - Remove skb_pop_rcv_encapsulation, no longer needed in the new
      csum_level model.
    - Allow GRO path to "consume" checksums provided in CHECKSUM_UNNECESSARY
      and to report new verfied checksums for use in normal path fallback.
    - Add proper support to SCTP to accept CHECKSUM_UNNECESSARY to validate
      header CRC.
    - Modify drivers to set skb->csum_level instead of setting
      skb->encapsulation to indicate validation of an encapsulated
      checksum on receive.
    
    v2:
    
    Allocate a new 16 bits for flags in skbuff.
    
    Please review carefully and test if possible, mucking with basic
    checksum functions is always a little precarious :-)
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 202863fe4c7a5b0b9a3d3a00d207691635b31930
Author: Tom Herbert <therbert@google.com>
Date:   Wed Aug 27 21:27:06 2014 -0700

    sctp: Change sctp to implement csum_levels
    
    CHECKSUM_UNNECESSARY may be applied to the SCTP CRC so we need to
    appropriate account for this by decrementing csum_level. This is
    done by calling __skb_dec_checksum_unnecessary.
    
    Signed-off-by: Tom Herbert <therbert@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 38ab1fa981d543e1b00f4ffbce4ddb480cd2effe
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Aug 28 15:28:26 2014 +0200

    net: sctp: fix ABI mismatch through sctp_assoc_to_state helper
    
    Since SCTP day 1, that is, 19b55a2af145 ("Initial commit") from lksctp
    tree, the official <netinet/sctp.h> header carries a copy of enum
    sctp_sstat_state that looks like (compared to the current in-kernel
    enumeration):
    
      User definition:                     Kernel definition:
    
      enum sctp_sstat_state {              typedef enum {
        SCTP_EMPTY             = 0,          <removed>
        SCTP_CLOSED            = 1,          SCTP_STATE_CLOSED            = 0,
        SCTP_COOKIE_WAIT       = 2,          SCTP_STATE_COOKIE_WAIT       = 1,
        SCTP_COOKIE_ECHOED     = 3,          SCTP_STATE_COOKIE_ECHOED     = 2,
        SCTP_ESTABLISHED       = 4,          SCTP_STATE_ESTABLISHED       = 3,
        SCTP_SHUTDOWN_PENDING  = 5,          SCTP_STATE_SHUTDOWN_PENDING  = 4,
        SCTP_SHUTDOWN_SENT     = 6,          SCTP_STATE_SHUTDOWN_SENT     = 5,
        SCTP_SHUTDOWN_RECEIVED = 7,          SCTP_STATE_SHUTDOWN_RECEIVED = 6,
        SCTP_SHUTDOWN_ACK_SENT = 8,          SCTP_STATE_SHUTDOWN_ACK_SENT = 7,
      };                                   } sctp_state_t;
    
    This header was later on also placed into the uapi, so that user space
    programs can compile without having <netinet/sctp.h>, but the shipped
    with <linux/sctp.h> instead.
    
    While RFC6458 under 8.2.1.Association Status (SCTP_STATUS) says that
    sstat_state can range from SCTP_CLOSED to SCTP_SHUTDOWN_ACK_SENT, we
    nevertheless have a what it appears to be dummy SCTP_EMPTY state from
    the very early days.
    
    While it seems to do just nothing, commit 0b8f9e25b0aa ("sctp: remove
    completely unsed EMPTY state") did the right thing and removed this dead
    code. That however, causes an off-by-one when the user asks the SCTP
    stack via SCTP_STATUS API and checks for the current socket state thus
    yielding possibly undefined behaviour in applications as they expect
    the kernel to tell the right thing.
    
    The enumeration had to be changed however as based on the current socket
    state, we access a function pointer lookup-table through this. Therefore,
    I think the best way to deal with this is just to add a helper function
    sctp_assoc_to_state() to encapsulate the off-by-one quirk.
    
    Reported-by: Tristan Su <sooqing@gmail.com>
    Fixes: 0b8f9e25b0aa ("sctp: remove completely unsed EMPTY state")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 433ab34d26e29d0f036c3f514a09ae96f973d8c5
Merge: 26d189b82f40 faaa55241f3a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Aug 22 14:33:18 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Here are some bug fixes that have piled up during ksummit/linuxcon.
    
       1) Fix endian problems in ibmveth, from Anton Blanchard.
    
       2) IPV6 routing code does GFP_KERNEL allocation in atomic, fix from
          Benjamin Block.
    
       3) SCTP association fixes from Daniel Borkmann.
    
       4) When multiple VLAN headers are present we have to make sure the
          second and subsequent ones are pullable in the SKB otherwise we
          blindly dereference garbage.  From Jiri Benc.
    
       5) The argument adjustment of the signature of hlist_add_after*()
          introduced a regression in the batman-adv code, fix from Sven
          Eckelmann.
    
       6) Fix TX hang handling to avoid a panic in i40e, from Anjali Singhai
          Jain.
    
       7) PTP flag test is inverted in i40e driver, from Jesse Brandeburg.
    
       8) ATM LEC driver needs to hold RTNL mutex over MTU changes, from
          Chas Williams.
    
       9) Truncate packets larger then the TPACKET_V3 format configured
          buffers, otherwise we overwrite past the end of said buffers.
          From Eric Dumazet.
    
      10) Fix endianness bugs in qlcnic firmware handling, from Rajesh
          Borundia and Shahed Shaikh.
    
      11) CXGB4 sometimes doesn't get all of the TX completion events it
          should resulting in SKBs getting stuck in the TX queue, from
          Hariprasad Shenai.
    
      12) When the FEC chip's PTP clock is disabled, you can't access the
          register.  Add necessary checks to avoid the resulting hang, from
          Fugang Duan"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (37 commits)
      drivers: isdn: eicon: xdi_msg.h: Fix typo in #ifndef
      net: sctp: fix suboptimal edge-case on non-active active/retrans path selection
      net: sctp: spare unnecessary comparison in sctp_trans_elect_best
      net: ethernet: broadcom: bnx2x: Remove redundant #ifdef
      ibmveth: Fix endian issues with rx_no_buffer statistic
      net: xgene: fix possible NULL dereference in xgene_enet_free_desc_rings()
      openvswitch: fix panic with multiple vlan headers
      net: ipv6: fib: don't sleep inside atomic lock
      net: fec: ptp: avoid register access when ipg clock is disabled
      cxgb4: Free completed tx skbs promptly
      cxgb4: Fix race condition in cleanup
      sctp: not send SCTP_PEER_ADDR_CHANGE notifications with failed probe
      bnx2x: Revert UNDI flushing mechanism
      qlcnic: Fix endianess issue in firmware load from file operation
      qlcnic: Fix endianess issue in FW dump template header
      qlcnic: Fix flash access interface to application
      MAINTAINERS: Add section for MRF24J40 IEEE 802.15.4 radio driver
      macvlan: Allow setting multicast filter on all macvlan types
      packet: handle too big packets for PACKET_V3
      MAINTAINERS: add entry for ec_bhf driver
      ...

commit aa4a83ee8bbc08342c4acfd59ef234cac51a1eef
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Aug 22 13:03:30 2014 +0200

    net: sctp: fix suboptimal edge-case on non-active active/retrans path selection
    
    In SCTP, selection of active (T.ACT) and retransmission (T.RET)
    transports is being done whenever transport control operations
    (UP, DOWN, PF, ...) are engaged through sctp_assoc_control_transport().
    
    Commits 4c47af4d5eb2 ("net: sctp: rework multihoming retransmission
    path selection to rfc4960") and a7288c4dd509 ("net: sctp: improve
    sctp_select_active_and_retran_path selection") have both improved
    it towards a more fine-grained and optimal path selection.
    
    Currently, the selection algorithm for T.ACT and T.RET is as follows:
    
    1) Elect the two most recently used ACTIVE transports T1, T2 for
       T.ACT, T.RET, where T.ACT<-T1 and T1 is most recently used
    2) In case primary path T.PRI not in {T1, T2} but ACTIVE, set
       T.ACT<-T.PRI and T.RET<-T1
    3) If only T1 is ACTIVE from the set, set T.ACT<-T1 and T.RET<-T1
    4) If none is ACTIVE, set T.ACT<-best(T.PRI, T.RET, T3) where
       T3 is the most recently used (if avail) in PF, set T.RET<-T.PRI
    
    Prior to above commits, 4) was simply a camp on T.ACT<-T.PRI and
    T.RET<-T.PRI, ignoring possible paths in PF. Camping on T.PRI is
    still slightly suboptimal as it can lead to the following scenario:
    
    Setup:
            <A>                                <B>
        T1: p1p1 (10.0.10.10) <==>  .'`)  <==> p1p1 (10.0.10.12)  <= T.PRI
        T2: p1p2 (10.0.10.20) <==> (_ . ) <==> p1p2 (10.0.10.22)
    
        net.sctp.rto_min = 1000
        net.sctp.path_max_retrans = 2
        net.sctp.pf_retrans = 0
        net.sctp.hb_interval = 1000
    
    T.PRI is permanently down, T2 is put briefly into PF state (e.g. due to
    link flapping). Here, the first time transmission is sent over PF path
    T2 as it's the only non-INACTIVE path, but the retransmitted data-chunks
    are sent over the INACTIVE path T1 (T.PRI), which is not good.
    
    After the patch, it's choosing better transports in both cases by
    modifying step 4):
    
    4) If none is ACTIVE, set T.ACT_new<-best(T.ACT_old, T3) where T3 is
       the most recently used (if avail) in PF, set T.RET<-T.ACT_new
    
    This will still select a best possible path in PF if available (which
    can also include T.PRI/T.RET), and set both T.ACT/T.RET to it.
    
    In case sctp_assoc_control_transport() *just* put T.ACT_old into INACTIVE
    as it transitioned from ACTIVE->PF->INACTIVE and stays in INACTIVE just
    for a very short while before going back ACTIVE, it will guarantee that
    this path will be reselected for T.ACT/T.RET since T3 (PF) is not
    available.
    
    Previously, this was not possible, as we would only select between T.PRI
    and T.RET, and a possible T3 would be NULL due to the fact that we have
    just transitioned T3 in sctp_assoc_control_transport() from PF->INACTIVE
    and would select a suboptimal path when T.PRI/T.RET have worse properties.
    
    In the case that T.ACT_old permanently went to INACTIVE during this
    transition and there's no PF path available, plus T.PRI and T.RET are
    INACTIVE as well, we would now camp on T.ACT_old, but if everything is
    being INACTIVE there's really not much we can do except hoping for a
    successful HB to bring one of the transports back up again and, thus
    cause a new selection through sctp_assoc_control_transport().
    
    Now both tests work fine:
    
    Case 1:
    
     1. T1 S(ACTIVE) T.ACT
        T2 S(ACTIVE) T.RET
    
     2. T1 S(ACTIVE) T.ACT, T.RET
        T2 S(PF)
    
     3. T1 S(ACTIVE) T.ACT, T.RET
        T2 S(INACTIVE)
    
     5. T1 S(PF) T.ACT, T.RET
        T2 S(INACTIVE)
    
    [ 5.1 T1 S(INACTIVE) T.ACT, T.RET
          T2 S(INACTIVE) ]
    
     6. T1 S(ACTIVE) T.ACT, T.RET
        T2 S(INACTIVE)
    
     7. T1 S(ACTIVE) T.ACT
        T2 S(ACTIVE) T.RET
    
    Case 2:
    
     1. T1 S(ACTIVE) T.ACT
        T2 S(ACTIVE) T.RET
    
     2. T1 S(PF)
        T2 S(ACTIVE) T.ACT, T.RET
    
     3. T1 S(INACTIVE)
        T2 S(ACTIVE) T.ACT, T.RET
    
     5. T1 S(INACTIVE)
        T2 S(PF) T.ACT, T.RET
    
    [ 5.1 T1 S(INACTIVE)
          T2 S(INACTIVE) T.ACT, T.RET ]
    
     6. T1 S(INACTIVE)
        T2 S(ACTIVE) T.ACT, T.RET
    
     7. T1 S(ACTIVE) T.ACT
        T2 S(ACTIVE) T.RET
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 061079ac0b9be7a578dcd09f7865c2c0d6ac894a
Author: zhuyj <zyjzyj2000@gmail.com>
Date:   Wed Aug 20 17:31:43 2014 +0800

    sctp: not send SCTP_PEER_ADDR_CHANGE notifications with failed probe
    
    Since the transport has always been in state SCTP_UNCONFIRMED, it
    therefore wasn't active before and hasn't been used before, and it
    always has been, so it is unnecessary to bug the user with a
    notification.
    
    Reported-by: Deepak Khandelwal <khandelwal.deepak.1987@gmail.com>
    Suggested-by: Vlad Yasevich <vyasevich@gmail.com>
    Suggested-by: Michael Tuexen <tuexen@fh-muenster.de>
    Suggested-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Zhu Yanjun <Yanjun.Zhu@windriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4a07c786e3d9fbe989d8b5bf9920a1e34afd8b91
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 478ac554b1e252e08fee07ecad6d1cf51636f695
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 672fcd4d4631dc45c650cad3576f880c0907e2e3
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 495d049f3e499227d28c89800bca27cc726b3bb2
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0fd6471aacff6a6eb9c19b8686813cb3ff503466
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    [ Upstream commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa ]
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2a3fda712f923d7f35054dc024bea4e349812755
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ae045e2455429c418a418a3376301a9e5753a0a8
Merge: f4f142ed4ef8 d247b6ab3ce6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Aug 6 09:38:14 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "Highlights:
    
       1) Steady transitioning of the BPF instructure to a generic spot so
          all kernel subsystems can make use of it, from Alexei Starovoitov.
    
       2) SFC driver supports busy polling, from Alexandre Rames.
    
       3) Take advantage of hash table in UDP multicast delivery, from David
          Held.
    
       4) Lighten locking, in particular by getting rid of the LRU lists, in
          inet frag handling.  From Florian Westphal.
    
       5) Add support for various RFC6458 control messages in SCTP, from
          Geir Ola Vaagland.
    
       6) Allow to filter bridge forwarding database dumps by device, from
          Jamal Hadi Salim.
    
       7) virtio-net also now supports busy polling, from Jason Wang.
    
       8) Some low level optimization tweaks in pktgen from Jesper Dangaard
          Brouer.
    
       9) Add support for ipv6 address generation modes, so that userland
          can have some input into the process.  From Jiri Pirko.
    
      10) Consolidate common TCP connection request code in ipv4 and ipv6,
          from Octavian Purdila.
    
      11) New ARP packet logger in netfilter, from Pablo Neira Ayuso.
    
      12) Generic resizable RCU hash table, with intial users in netlink and
          nftables.  From Thomas Graf.
    
      13) Maintain a name assignment type so that userspace can see where a
          network device name came from (enumerated by kernel, assigned
          explicitly by userspace, etc.) From Tom Gundersen.
    
      14) Automatic flow label generation on transmit in ipv6, from Tom
          Herbert.
    
      15) New packet timestamping facilities from Willem de Bruijn, meant to
          assist in measuring latencies going into/out-of the packet
          scheduler, latency from TCP data transmission to ACK, etc"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1536 commits)
      cxgb4 : Disable recursive mailbox commands when enabling vi
      net: reduce USB network driver config options.
      tg3: Modify tg3_tso_bug() to handle multiple TX rings
      amd-xgbe: Perform phy connect/disconnect at dev open/stop
      amd-xgbe: Use dma_set_mask_and_coherent to set DMA mask
      net: sun4i-emac: fix memory leak on bad packet
      sctp: fix possible seqlock seadlock in sctp_packet_transmit()
      Revert "net: phy: Set the driver when registering an MDIO bus device"
      cxgb4vf: Turn off SGE RX/TX Callback Timers and interrupts in PCI shutdown routine
      team: Simplify return path of team_newlink
      bridge: Update outdated comment on promiscuous mode
      net-timestamp: ACK timestamp for bytestreams
      net-timestamp: TCP timestamping
      net-timestamp: SCHED timestamp on entering packet scheduler
      net-timestamp: add key to disambiguate concurrent datagrams
      net-timestamp: move timestamp flags out of sk_flags
      net-timestamp: extend SCM_TIMESTAMPING ancillary data struct
      cxgb4i : Move stray CPL definitions to cxgb4 driver
      tcp: reduce spurious retransmits due to transient SACK reneging
      qlcnic: Initialize dcbnl_ops before register_netdev
      ...

commit 299ee123e19889d511092347f5fc14db0f10e3a6
Author: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
Date:   Wed Jul 30 12:40:53 2014 -0600

    sctp: Fixup v4mapped behaviour to comply with Sock API
    
    The SCTP socket extensions API document describes the v4mapping option as
    follows:
    
    8.1.15.  Set/Clear IPv4 Mapped Addresses (SCTP_I_WANT_MAPPED_V4_ADDR)
    
       This socket option is a Boolean flag which turns on or off the
       mapping of IPv4 addresses.  If this option is turned on, then IPv4
       addresses will be mapped to V6 representation.  If this option is
       turned off, then no mapping will be done of V4 addresses and a user
       will receive both PF_INET6 and PF_INET type addresses on the socket.
       See [RFC3542] for more details on mapped V6 addresses.
    
    This description isn't really in line with what the code does though.
    
    Introduce addr_to_user (renamed addr_v4map), which should be called
    before any sockaddr is passed back to user space. The new function
    places the sockaddr into the correct format depending on the
    SCTP_I_WANT_MAPPED_V4_ADDR option.
    
    Audit all places that touched v4mapped and either sanely construct
    a v4 or v6 address then call addr_to_user, or drop the
    unnecessary v4mapped check entirely.
    
    Audit all places that call addr_to_user and verify they are on a sycall
    return path.
    
    Add a custom getname that formats the address properly.
    
    Several bugs are addressed:
     - SCTP_I_WANT_MAPPED_V4_ADDR=0 often returned garbage for
       addresses to user space
     - The addr_len returned from recvmsg was not correct when
       returning AF_INET on a v6 socket
     - flowlabel and scope_id were not zerod when promoting
       a v4 to v6
     - Some syscalls like bind and connect behaved differently
       depending on v4mapped
    
    Tested bind, getpeername, getsockname, connect, and recvmsg for proper
    behaviour in v4mapped = 1 and 0 cases.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a96dcc0001508dfde488209a574e9fc25e40e89a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 97df8a2322a5e2f50d88e39b5507b862eb9d1395
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 87c6cfe711b95a31f9e840e6911b4905e317cb09
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b3b3ba5714ee9f77748223a0dbcf40b90e8e0773
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9de2be635e77b3591e698d6a08abad98fb21693d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    [ Upstream commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea ]
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1be9a950c646c9092fb3618197f7b6bfb50e82aa
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 22 15:22:45 2014 +0200

    net: sctp: inherit auth_capable on INIT collisions
    
    Jason reported an oops caused by SCTP on his ARM machine with
    SCTP authentication enabled:
    
    Internal error: Oops: 17 [#1] ARM
    CPU: 0 PID: 104 Comm: sctp-test Not tainted 3.13.0-68744-g3632f30c9b20-dirty #1
    task: c6eefa40 ti: c6f52000 task.ti: c6f52000
    PC is at sctp_auth_calculate_hmac+0xc4/0x10c
    LR is at sg_init_table+0x20/0x38
    pc : [<c024bb80>]    lr : [<c00f32dc>]    psr: 40000013
    sp : c6f538e8  ip : 00000000  fp : c6f53924
    r10: c6f50d80  r9 : 00000000  r8 : 00010000
    r7 : 00000000  r6 : c7be4000  r5 : 00000000  r4 : c6f56254
    r3 : c00c8170  r2 : 00000001  r1 : 00000008  r0 : c6f1e660
    Flags: nZcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user
    Control: 0005397f  Table: 06f28000  DAC: 00000015
    Process sctp-test (pid: 104, stack limit = 0xc6f521c0)
    Stack: (0xc6f538e8 to 0xc6f54000)
    [...]
    Backtrace:
    [<c024babc>] (sctp_auth_calculate_hmac+0x0/0x10c) from [<c0249af8>] (sctp_packet_transmit+0x33c/0x5c8)
    [<c02497bc>] (sctp_packet_transmit+0x0/0x5c8) from [<c023e96c>] (sctp_outq_flush+0x7fc/0x844)
    [<c023e170>] (sctp_outq_flush+0x0/0x844) from [<c023ef78>] (sctp_outq_uncork+0x24/0x28)
    [<c023ef54>] (sctp_outq_uncork+0x0/0x28) from [<c0234364>] (sctp_side_effects+0x1134/0x1220)
    [<c0233230>] (sctp_side_effects+0x0/0x1220) from [<c02330b0>] (sctp_do_sm+0xac/0xd4)
    [<c0233004>] (sctp_do_sm+0x0/0xd4) from [<c023675c>] (sctp_assoc_bh_rcv+0x118/0x160)
    [<c0236644>] (sctp_assoc_bh_rcv+0x0/0x160) from [<c023d5bc>] (sctp_inq_push+0x6c/0x74)
    [<c023d550>] (sctp_inq_push+0x0/0x74) from [<c024a6b0>] (sctp_rcv+0x7d8/0x888)
    
    While we already had various kind of bugs in that area
    ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to verify if
    we/peer is AUTH capable") and b14878ccb7fa ("net: sctp: cache
    auth_enable per endpoint"), this one is a bit of a different
    kind.
    
    Giving a bit more background on why SCTP authentication is
    needed can be found in RFC4895:
    
      SCTP uses 32-bit verification tags to protect itself against
      blind attackers. These values are not changed during the
      lifetime of an SCTP association.
    
      Looking at new SCTP extensions, there is the need to have a
      method of proving that an SCTP chunk(s) was really sent by
      the original peer that started the association and not by a
      malicious attacker.
    
    To cause this bug, we're triggering an INIT collision between
    peers; normal SCTP handshake where both sides intent to
    authenticate packets contains RANDOM; CHUNKS; HMAC-ALGO
    parameters that are being negotiated among peers:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895 says that each endpoint therefore knows its own random
    number and the peer's random number *after* the association
    has been established. The local and peer's random number along
    with the shared key are then part of the secret used for
    calculating the HMAC in the AUTH chunk.
    
    Now, in our scenario, we have 2 threads with 1 non-blocking
    SEQ_PACKET socket each, setting up common shared SCTP_AUTH_KEY
    and SCTP_AUTH_ACTIVE_KEY properly, and each of them calling
    sctp_bindx(3), listen(2) and connect(2) against each other,
    thus the handshake looks similar to this, e.g.:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      <--------- INIT[RANDOM; CHUNKS; HMAC-ALGO] -----------
      -------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] -------->
      ...
    
    Since such collisions can also happen with verification tags,
    the RFC4895 for AUTH rather vaguely says under section 6.1:
    
      In case of INIT collision, the rules governing the handling
      of this Random Number follow the same pattern as those for
      the Verification Tag, as explained in Section 5.2.4 of
      RFC 2960 [5]. Therefore, each endpoint knows its own Random
      Number and the peer's Random Number after the association
      has been established.
    
    In RFC2960, section 5.2.4, we're eventually hitting Action B:
    
      B) In this case, both sides may be attempting to start an
         association at about the same time but the peer endpoint
         started its INIT after responding to the local endpoint's
         INIT. Thus it may have picked a new Verification Tag not
         being aware of the previous Tag it had sent this endpoint.
         The endpoint should stay in or enter the ESTABLISHED
         state but it MUST update its peer's Verification Tag from
         the State Cookie, stop any init or cookie timers that may
         running and send a COOKIE ACK.
    
    In other words, the handling of the Random parameter is the
    same as behavior for the Verification Tag as described in
    Action B of section 5.2.4.
    
    Looking at the code, we exactly hit the sctp_sf_do_dupcook_b()
    case which triggers an SCTP_CMD_UPDATE_ASSOC command to the
    side effect interpreter, and in fact it properly copies over
    peer_{random, hmacs, chunks} parameters from the newly created
    association to update the existing one.
    
    Also, the old asoc_shared_key is being released and based on
    the new params, sctp_auth_asoc_init_active_key() updated.
    However, the issue observed in this case is that the previous
    asoc->peer.auth_capable was 0, and has *not* been updated, so
    that instead of creating a new secret, we're doing an early
    return from the function sctp_auth_asoc_init_active_key()
    leaving asoc->asoc_shared_key as NULL. However, we now have to
    authenticate chunks from the updated chunk list (e.g. COOKIE-ACK).
    
    That in fact causes the server side when responding with ...
    
      <------------------ AUTH; COOKIE-ACK -----------------
    
    ... to trigger a NULL pointer dereference, since in
    sctp_packet_transmit(), it discovers that an AUTH chunk is
    being queued for xmit, and thus it calls sctp_auth_calculate_hmac().
    
    Since the asoc->active_key_id is still inherited from the
    endpoint, and the same as encoded into the chunk, it uses
    asoc->asoc_shared_key, which is still NULL, as an asoc_key
    and dereferences it in ...
    
      crypto_hash_setkey(desc.tfm, &asoc_key->data[0], asoc_key->len)
    
    ... causing an oops. All this happens because sctp_make_cookie_ack()
    called with the *new* association has the peer.auth_capable=1
    and therefore marks the chunk with auth=1 after checking
    sctp_auth_send_cid(), but it is *actually* sent later on over
    the then *updated* association's transport that didn't initialize
    its shared key due to peer.auth_capable=0. Since control chunks
    in that case are not sent by the temporary association which
    are scheduled for deletion, they are issued for xmit via
    SCTP_CMD_REPLY in the interpreter with the context of the
    *updated* association. peer.auth_capable was 0 in the updated
    association (which went from COOKIE_WAIT into ESTABLISHED state),
    since all previous processing that performed sctp_process_init()
    was being done on temporary associations, that we eventually
    throw away each time.
    
    The correct fix is to update to the new peer.auth_capable
    value as well in the collision case via sctp_assoc_update(),
    so that in case the collision migrated from 0 -> 1,
    sctp_auth_asoc_init_active_key() can properly recalculate
    the secret. This therefore fixes the observed server panic.
    
    Fixes: 730fc3d05cd4 ("[SCTP]: Implete SCTP-AUTH parameter processing")
    Reported-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Jason Gunthorpe <jgunthorpe@obsidianresearch.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 526cbef778ad8e763b95608d7e5c988b96bf4af5
Author: David Laight <David.Laight@ACULAB.COM>
Date:   Tue Jul 22 08:59:14 2014 +0000

    net: sctp: Rename SCTP_XMIT_NAGLE_DELAY to SCTP_XMIT_DELAY
    
    MSG_MORE and 'corking' a socket would require that the transmit of
    a data chunk be delayed.
    Rename the return value to be less specific.
    
    Signed-off-by: David Laight <david.laight@aculab.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 723189faca78f2b70fcf9088f056a2440986cc45
Author: David Laight <David.Laight@ACULAB.COM>
Date:   Tue Jul 22 08:59:08 2014 +0000

    net: sctp: Open out the check for Nagle
    
    The check for Nagle contains 6 separate checks all of which must be true
    before a data packet is delayed.
    Separate out each into its own 'if (test) return SCTP_XMIT_OK' so that
    the reasons can be individually described.
    
    Also return directly with SCTP_XMIT_RWND_FULL.
    Delete the now-unused 'retval' variable and 'finish' label from
    sctp_packet_can_append_data().
    
    Signed-off-by: David Laight <david.laight@aculab.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ed410ecf71a5924676ceb561f53a03119f27d925
Merge: 1a98c69af1ec bbbea41d5e53
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jul 16 14:41:10 2014 -0700

    Merge branch 'sctp-next'
    
    Daniel Borkmann says:
    
    ====================
    SCTP updates
    
    This set improves the SCTP socket API to be more in line with RFC6458,
    Geir and myself have finalized it eventually. While at it, the first
    patch also fixes two possible information leaks that should go to net
    tree as well (therefore the change is already here in net-next via a
    merge of the 'net' tree -DaveM). For more details, I refer you to the
    patches themselves.
    
    Thanks a lot.
    
    v1 -> v2:
     - Added 6th patch to deprecate SCTP_SNDRCV, rest unchanged
    ====================
    
    CC: Jay Vosburgh <j.vosburgh@gmail.com>
    CC: Andy Gospodarek <andy@greyhouse.net>
    Signed-off-by: Veaceslav Falico <vfalico@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bbbea41d5e53335fd81e89c728f71b14386f336e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:40 2014 +0200

    net: sctp: deprecate rfc6458, 5.3.2. SCTP_SNDRCV support
    
    With support of SCTP_SNDINFO/SCTP_RCVINFO as described in RFC6458,
    5.3.4/5.3.5, we can now deprecate SCTP_SNDRCV. The RFC already
    declares it as deprecated:
    
      This structure mixes the send and receive path. SCTP_SNDINFO
      (described in Section 5.3.4) and SCTP_RCVINFO (described in
      Section 5.3.5) split this information. These structures should
      be used, when possible, since SCTP_SNDRCV is deprecated.
    
    So whenever a user tries to subscribe to sctp_data_io_event via
    setsockopt(2) which triggers inclusion of SCTP_SNDRCV cmsg_type,
    issue a warning in the log.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6b3fd5f3a2bbc8464a8e0bf134a183b8fa026439
Author: Geir Ola Vaagland <geirola@gmail.com>
Date:   Sat Jul 12 20:30:39 2014 +0200

    net: sctp: implement rfc6458, 8.1.31. SCTP_DEFAULT_SNDINFO support
    
    This patch implements section 8.1.31. of RFC6458, which adds support
    for setting/retrieving SCTP_DEFAULT_SNDINFO:
    
      Applications that wish to use the sendto() system call may wish
      to specify a default set of parameters that would normally be
      supplied through the inclusion of ancillary data. This socket
      option allows such an application to set the default sctp_sndinfo
      structure. The application that wishes to use this socket option
      simply passes the sctp_sndinfo structure (defined in Section 5.3.4)
      to this call. The input parameters accepted by this call include
      snd_sid, snd_flags, snd_ppid, and snd_context. The snd_flags
      parameter is composed of a bitwise OR of SCTP_UNORDERED, SCTP_EOF,
      and SCTP_SENDALL. The snd_assoc_id field specifies the association
      to which to apply the parameters. For a one-to-many style socket,
      any of the predefined constants are also allowed in this field.
      The field is ignored for one-to-one style sockets.
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Geir Ola Vaagland <geirola@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2347c80ff127b94ddaa675e2b78ab4cef46dc905
Author: Geir Ola Vaagland <geirola@gmail.com>
Date:   Sat Jul 12 20:30:38 2014 +0200

    net: sctp: implement rfc6458, 5.3.6. SCTP_NXTINFO cmsg support
    
    This patch implements section 5.3.6. of RFC6458, that is, support
    for 'SCTP Next Receive Information Structure' (SCTP_NXTINFO) which
    is placed into ancillary data cmsghdr structure for each recvmsg()
    call, if this information is already available when delivering the
    current message.
    
    This option can be enabled/disabled via setsockopt(2) on SOL_SCTP
    level by setting an int value with 1/0 for SCTP_RECVNXTINFO in
    user space applications as per RFC6458, section 8.1.30.
    
    The sctp_nxtinfo structure is defined as per RFC as below ...
    
      struct sctp_nxtinfo {
        uint16_t nxt_sid;
        uint16_t nxt_flags;
        uint32_t nxt_ppid;
        uint32_t nxt_length;
        sctp_assoc_t nxt_assoc_id;
      };
    
    ... and provided under cmsg_level IPPROTO_SCTP, cmsg_type
    SCTP_NXTINFO, while cmsg_data[] contains struct sctp_nxtinfo.
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Geir Ola Vaagland <geirola@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0d3a421d284812d07970b4ccee74d4fa38737e4d
Author: Geir Ola Vaagland <geirola@gmail.com>
Date:   Sat Jul 12 20:30:37 2014 +0200

    net: sctp: implement rfc6458, 5.3.5. SCTP_RCVINFO cmsg support
    
    This patch implements section 5.3.5. of RFC6458, that is, support
    for 'SCTP Receive Information Structure' (SCTP_RCVINFO) which is
    placed into ancillary data cmsghdr structure for each recvmsg()
    call.
    
    This option can be enabled/disabled via setsockopt(2) on SOL_SCTP
    level by setting an int value with 1/0 for SCTP_RECVRCVINFO in user
    space applications as per RFC6458, section 8.1.29.
    
    The sctp_rcvinfo structure is defined as per RFC as below ...
    
      struct sctp_rcvinfo {
        uint16_t rcv_sid;
        uint16_t rcv_ssn;
        uint16_t rcv_flags;
        <-- 2 bytes hole  -->
        uint32_t rcv_ppid;
        uint32_t rcv_tsn;
        uint32_t rcv_cumtsn;
        uint32_t rcv_context;
        sctp_assoc_t rcv_assoc_id;
      };
    
    ... and provided under cmsg_level IPPROTO_SCTP, cmsg_type
    SCTP_RCVINFO, while cmsg_data[] contains struct sctp_rcvinfo.
    An sctp_rcvinfo item always corresponds to the data in msg_iov.
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Geir Ola Vaagland <geirola@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 63b949382c5f263746b1c177f6ff84de2201ae9d
Author: Geir Ola Vaagland <geirola@gmail.com>
Date:   Sat Jul 12 20:30:36 2014 +0200

    net: sctp: implement rfc6458, 5.3.4. SCTP_SNDINFO cmsg support
    
    This patch implements section 5.3.4. of RFC6458, that is, support
    for 'SCTP Send Information Structure' (SCTP_SNDINFO) which can be
    placed into ancillary data cmsghdr structure for sendmsg() calls.
    
    The sctp_sndinfo structure is defined as per RFC as below ...
    
      struct sctp_sndinfo {
        uint16_t snd_sid;
        uint16_t snd_flags;
        uint32_t snd_ppid;
        uint32_t snd_context;
        sctp_assoc_t snd_assoc_id;
      };
    
    ... and supplied under cmsg_level IPPROTO_SCTP, cmsg_type
    SCTP_SNDINFO, while cmsg_data[] contains struct sctp_sndinfo.
    An sctp_sndinfo item always corresponds to the data in msg_iov.
    
    Joint work with Daniel Borkmann.
    
    Signed-off-by: Geir Ola Vaagland <geirola@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5615f9f822c12482d33c8561df0b01a0aaf39437
Merge: 1b81e8818944 8f9818af4eae
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jul 15 08:42:52 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Bluetooth pairing fixes from Johan Hedberg.
    
     2) ieee80211_send_auth() doesn't allocate enough tail room for the SKB,
        from Max Stepanov.
    
     3) New iwlwifi chip IDs, from Oren Givon.
    
     4) bnx2x driver reads wrong PCI config space MSI register, from Yijing
        Wang.
    
     5) IPV6 MLD Query validation isn't strong enough, from Hangbin Liu.
    
     6) Fix double SKB free in openvswitch, from Andy Zhou.
    
     7) Fix sk_dst_set() being racey with UDP sockets, leading to strange
        crashes, from Eric Dumazet.
    
     8) Interpret the NAPI budget correctly in the new systemport driver,
        from Florian Fainelli.
    
     9) VLAN code frees percpu stats in the wrong place, leading to crashes
        in the get stats handler.  From Eric Dumazet.
    
    10) TCP sockets doing a repair can crash with a divide by zero, because
        we invoke tcp_push() with an MSS value of zero.  Just skip that part
        of the sendmsg paths in repair mode.  From Christoph Paasch.
    
    11) IRQ affinity bug fixes in mlx4 driver from Amir Vadai.
    
    12) Don't ignore path MTU icmp messages with a zero mtu, machines out
        there still spit them out, and all of our per-protocol handlers for
        PMTU can cope with it just fine.  From Edward Allcutt.
    
    13) Some NETDEV_CHANGE notifier invocations were not passing in the
        correct kind of cookie as the argument, from Loic Prylli.
    
    14) Fix crashes in long multicast/broadcast reassembly, from Jon Paul
        Maloy.
    
    15) ip_tunnel_lookup() doesn't interpret wildcard keys correctly, fix
        from Dmitry Popov.
    
    16) Fix skb->sk assigned without taking a reference to 'sk' in
        appletalk, from Andrey Utkin.
    
    17) Fix some info leaks in ULP event signalling to userspace in SCTP,
        from Daniel Borkmann.
    
    18) Fix deadlocks in HSO driver, from Olivier Sobrie.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (93 commits)
      hso: fix deadlock when receiving bursts of data
      hso: remove unused workqueue
      net: ppp: don't call sk_chk_filter twice
      mlx4: mark napi id for gro_skb
      bonding: fix ad_select module param check
      net: pppoe: use correct channel MTU when using Multilink PPP
      neigh: sysctl - simplify address calculation of gc_* variables
      net: sctp: fix information leaks in ulpevent layer
      MAINTAINERS: update r8169 maintainer
      net: bcmgenet: fix RGMII_MODE_EN bit
      tipc: clear 'next'-pointer of message fragments before reassembly
      r8152: fix r8152_csum_workaround function
      be2net: set EQ DB clear-intr bit in be_open()
      GRE: enable offloads for GRE
      farsync: fix invalid memory accesses in fst_add_one() and fst_init_card()
      igb: do a reset on SR-IOV re-init if device is down
      igb: Workaround for i210 Errata 25: Slow System Clock
      usbnet: smsc95xx: add reset_resume function with reset operation
      dp83640: Always decode received status frames
      r8169: disable L23
      ...

commit 8f2e5ae40ec193bc0a0ed99e95315c3eebca84ea
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Jul 12 20:30:35 2014 +0200

    net: sctp: fix information leaks in ulpevent layer
    
    While working on some other SCTP code, I noticed that some
    structures shared with user space are leaking uninitialized
    stack or heap buffer. In particular, struct sctp_sndrcvinfo
    has a 2 bytes hole between .sinfo_flags and .sinfo_ppid that
    remains unfilled by us in sctp_ulpevent_read_sndrcvinfo() when
    putting this into cmsg. But also struct sctp_remote_error
    contains a 2 bytes hole that we don't fill but place into a skb
    through skb_copy_expand() via sctp_ulpevent_make_remote_error().
    
    Both structures are defined by the IETF in RFC6458:
    
    * Section 5.3.2. SCTP Header Information Structure:
    
      The sctp_sndrcvinfo structure is defined below:
    
      struct sctp_sndrcvinfo {
        uint16_t sinfo_stream;
        uint16_t sinfo_ssn;
        uint16_t sinfo_flags;
        <-- 2 bytes hole  -->
        uint32_t sinfo_ppid;
        uint32_t sinfo_context;
        uint32_t sinfo_timetolive;
        uint32_t sinfo_tsn;
        uint32_t sinfo_cumtsn;
        sctp_assoc_t sinfo_assoc_id;
      };
    
    * 6.1.3. SCTP_REMOTE_ERROR:
    
      A remote peer may send an Operation Error message to its peer.
      This message indicates a variety of error conditions on an
      association. The entire ERROR chunk as it appears on the wire
      is included in an SCTP_REMOTE_ERROR event. Please refer to the
      SCTP specification [RFC4960] and any extensions for a list of
      possible error formats. An SCTP error notification has the
      following format:
    
      struct sctp_remote_error {
        uint16_t sre_type;
        uint16_t sre_flags;
        uint32_t sre_length;
        uint16_t sre_error;
        <-- 2 bytes hole  -->
        sctp_assoc_t sre_assoc_id;
        uint8_t  sre_data[];
      };
    
    Fix this by setting both to 0 before filling them out. We also
    have other structures shared between user and kernel space in
    SCTP that contains holes (e.g. struct sctp_paddrthlds), but we
    copy that buffer over from user space first and thus don't need
    to care about it in that cases.
    
    While at it, we can also remove lengthy comments copied from
    the draft, instead, we update the comment with the correct RFC
    number where one can look it up.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 239960d66425785affb92d745e3b29e3e9b51745
Merge: eb1ac820c61d eaea2da7286e
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jul 2 18:44:14 2014 -0700

    Merge branch 'sctp'
    
    Daniel Borkmann says:
    
    ====================
    Misc SCTP updates
    
    Daniel Borkmann (2):
      net: sctp: improve timer slack calculation for transport HBs
      net: sctp: only warn in proc_sctp_do_alpha_beta if write
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>

commit cb8eb77663dda1502ec419962980053cd0092d48
Merge: 5433ba365f6d d8f1c4778e95
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jun 25 16:04:09 2014 -0700

    Merge branch 'crc32'
    
    Daniel Borkmann says:
    
    ====================
    crc32 combine improvements
    
    So almost a month passed, and I don't want this to get lost
    somewhere. I have applied the feedback given at that time to
    this set, rebased plus tested it against latest net-next. I
    decided to route this via netdev as it improves performance
    upon library code that provides library bits for SCTP, i.e.
    for non-linear skb csum handling in IPVS. Thus, resending
    this for George before it gets lost.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6d514b4e7737ad75a7e7e0a3f7dde45d46341691
Author: George Spelvin <linux@horizon.com>
Date:   Mon Jun 23 15:11:54 2014 +0200

    lib: crc32: Greatly shrink CRC combining code
    
    There's no need for a full 32x32 matrix, when rows before the last are
    just shifted copies of the rows after them.
    
    There's still room for improvement (especially on X86 processors with
    CRC32 and PCLMUL instructions), but this is a large step in the
    right direction [which is in particular useful for its current user,
    namely SCTP checksumming over multiple skb frags[] entries, i.e. in
    IPVS balancing when other CRC32 offloads are not available].
    
    The internal primitive is now called crc32_generic_shift and takes one
    less argument; the XOR with crc2 is done in inline wrappers.
    
    Signed-off-by: George Spelvin <linux@horizon.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a9be22425e767d936105679fdc9f568b97bd47cf
Merge: dd1845af24a4 b58537a1f562
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sun Jun 15 16:37:03 2014 -1000

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix checksumming regressions, from Tom Herbert.
    
     2) Undo unintentional permissions changes for SCTP rto_alpha and
        rto_beta sysfs knobs, from Denial Borkmann.
    
     3) VXLAN, like other IP tunnels, should advertize it's encapsulation
        size using dev->needed_headroom instead of dev->hard_header_len.
        From Cong Wang.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      net: sctp: fix permissions for rto_alpha and rto_beta knobs
      vxlan: Checksum fixes
      net: add skb_pop_rcv_encapsulation
      udp: call __skb_checksum_complete when doing full checksum
      net: Fix save software checksum complete
      net: Fix GSO constants to match NETIF flags
      udp: ipv4: do not waste time in __udp4_lib_mcast_demux_lookup
      vxlan: use dev->needed_headroom instead of dev->hard_header_len
      MAINTAINERS: update cxgb4 maintainer

commit b58537a1f5629bdc98a8b9dc2051ce0e952f6b4b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sun Jun 15 00:59:14 2014 +0200

    net: sctp: fix permissions for rto_alpha and rto_beta knobs
    
    Commit 3fd091e73b81 ("[SCTP]: Remove multiple levels of msecs
    to jiffies conversions.") has silently changed permissions for
    rto_alpha and rto_beta knobs from 0644 to 0444. The purpose of
    this was to discourage users from tweaking rto_alpha and
    rto_beta knobs in production environments since they are key
    to correctly compute rtt/srtt.
    
    RFC4960 under section 6.3.1. RTO Calculation says regarding
    rto_alpha and rto_beta under rule C3 and C4:
    
      [...]
      C3)  When a new RTT measurement R' is made, set
    
           RTTVAR <- (1 - RTO.Beta) * RTTVAR + RTO.Beta * |SRTT - R'|
    
           and
    
           SRTT <- (1 - RTO.Alpha) * SRTT + RTO.Alpha * R'
    
           Note: The value of SRTT used in the update to RTTVAR
           is its value before updating SRTT itself using the
           second assignment. After the computation, update
           RTO <- SRTT + 4 * RTTVAR.
    
      C4)  When data is in flight and when allowed by rule C5
           below, a new RTT measurement MUST be made each round
           trip. Furthermore, new RTT measurements SHOULD be
           made no more than once per round trip for a given
           destination transport address. There are two reasons
           for this recommendation: First, it appears that
           measuring more frequently often does not in practice
           yield any significant benefit [ALLMAN99]; second,
           if measurements are made more often, then the values
           of RTO.Alpha and RTO.Beta in rule C3 above should be
           adjusted so that SRTT and RTTVAR still adjust to
           changes at roughly the same rate (in terms of how many
           round trips it takes them to reflect new values) as
           they would if making only one measurement per
           round-trip and using RTO.Alpha and RTO.Beta as given
           in rule C3. However, the exact nature of these
           adjustments remains a research issue.
      [...]
    
    While it is discouraged to adjust rto_alpha and rto_beta
    and not further specified how to adjust them, the RFC also
    doesn't explicitly forbid it, but rather gives a RECOMMENDED
    default value (rto_alpha=3, rto_beta=2). We have a couple
    of users relying on the old permissions before they got
    changed. That said, if someone really has the urge to adjust
    them, we could allow it with a warning in the log.
    
    Fixes: 3fd091e73b81 ("[SCTP]: Remove multiple levels of msecs to jiffies conversions.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4bdeb312083e65fccbb0a4b4043568f60520c67a
Merge: aa569fa0ea32 883854c5457a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Jun 13 07:41:57 2014 -0700

    Merge tag 'dlm-3.16' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm
    
    Pull dlm fix from David Teigland:
     "This contains one small fix related to resending SCTP messages"
    
    * tag 'dlm-3.16' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm:
      dlm: keep listening connection alive with sctp mode

commit f9da455b93f6ba076935b4ef4589f61e529ae046
Merge: 0e04c641b199 e5eca6d41f53
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Jun 12 14:27:40 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
    
     1) Seccomp BPF filters can now be JIT'd, from Alexei Starovoitov.
    
     2) Multiqueue support in xen-netback and xen-netfront, from Andrew J
        Benniston.
    
     3) Allow tweaking of aggregation settings in cdc_ncm driver, from Bjrn
        Mork.
    
     4) BPF now has a "random" opcode, from Chema Gonzalez.
    
     5) Add more BPF documentation and improve test framework, from Daniel
        Borkmann.
    
     6) Support TCP fastopen over ipv6, from Daniel Lee.
    
     7) Add software TSO helper functions and use them to support software
        TSO in mvneta and mv643xx_eth drivers.  From Ezequiel Garcia.
    
     8) Support software TSO in fec driver too, from Nimrod Andy.
    
     9) Add Broadcom SYSTEMPORT driver, from Florian Fainelli.
    
    10) Handle broadcasts more gracefully over macvlan when there are large
        numbers of interfaces configured, from Herbert Xu.
    
    11) Allow more control over fwmark used for non-socket based responses,
        from Lorenzo Colitti.
    
    12) Do TCP congestion window limiting based upon measurements, from Neal
        Cardwell.
    
    13) Support busy polling in SCTP, from Neal Horman.
    
    14) Allow RSS key to be configured via ethtool, from Venkata Duvvuru.
    
    15) Bridge promisc mode handling improvements from Vlad Yasevich.
    
    16) Don't use inetpeer entries to implement ID generation any more, it
        performs poorly, from Eric Dumazet.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1522 commits)
      rtnetlink: fix userspace API breakage for iproute2 < v3.9.0
      tcp: fixing TLP's FIN recovery
      net: fec: Add software TSO support
      net: fec: Add Scatter/gather support
      net: fec: Increase buffer descriptor entry number
      net: fec: Factorize feature setting
      net: fec: Enable IP header hardware checksum
      net: fec: Factorize the .xmit transmit function
      bridge: fix compile error when compiling without IPv6 support
      bridge: fix smatch warning / potential null pointer dereference
      via-rhine: fix full-duplex with autoneg disable
      bnx2x: Enlarge the dorq threshold for VFs
      bnx2x: Check for UNDI in uncommon branch
      bnx2x: Fix 1G-baseT link
      bnx2x: Fix link for KR with swapped polarity lane
      sctp: Fix sk_ack_backlog wrap-around problem
      net/core: Add VF link state control policy
      net/fsl: xgmac_mdio is dependent on OF_MDIO
      net/fsl: Make xgmac_mdio read error message useful
      net_sched: drr: warn when qdisc is not work conserving
      ...

commit 813ebbbf8e6c3d03b2a340ed10b88b551a531452
Merge: 9181a6bd1800 9b87d4651069
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Jun 11 12:23:30 2014 -0700

    Merge branch 'sctp-next'
    
    Daniel Borkmann says:
    
    ====================
    SCTP update
    
    This set contains transport path selection improvements in
    SCTP. Please see individual patches for details.
    ====================
    
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 67cb9366ff5f99868100198efba5ca88aaa6ad25
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Jun 11 18:19:28 2014 +0200

    ktime: add ktime_after and ktime_before helper
    
    Add two minimal helper functions analogous to time_before() and
    time_after() that will later on both be needed by SCTP code.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0fc175dff42444b3fe24dff93d25aa5c7c427724
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 8 17:26:13 2014 +0200

    net: sctp: wake up all assocs if sndbuf policy is per socket
    
    [ Upstream commit 52c35befb69b005c3fc5afdaae3a5717ad013411 ]
    
    SCTP charges chunks for wmem accounting via skb->truesize in
    sctp_set_owner_w(), and sctp_wfree() respectively as the
    reverse operation. If a sender runs out of wmem, it needs to
    wait via sctp_wait_for_sndbuf(), and gets woken up by a call
    to __sctp_write_space() mostly via sctp_wfree().
    
    __sctp_write_space() is being called per association. Although
    we assign sk->sk_write_space() to sctp_write_space(), which
    is then being done per socket, it is only used if send space
    is increased per socket option (SO_SNDBUF), as SOCK_USE_WRITE_QUEUE
    is set and therefore not invoked in sock_wfree().
    
    Commit 4c3a5bdae293 ("sctp: Don't charge for data in sndbuf
    again when transmitting packet") fixed an issue where in case
    sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again
    unless it is interrupted by a signal. However, a still
    remaining issue is that if net.sctp.sndbuf_policy=0, that is
    accounting per socket, and one-to-many sockets are in use,
    the reclaimed write space from sctp_wfree() is 'unfairly'
    handed back on the server to the association that is the lucky
    one to be woken up again via __sctp_write_space(), while
    the remaining associations are never be woken up again
    (unless by a signal).
    
    The effect disappears with net.sctp.sndbuf_policy=1, that
    is wmem accounting per association, as it guarantees a fair
    share of wmem among associations.
    
    Therefore, if we have reclaimed memory in case of per socket
    accounting, wake all related associations to a socket in a
    fair manner, that is, traverse the socket association list
    starting from the current neighbour of the association and
    issue a __sctp_write_space() to everyone until we end up
    waking ourselves. This guarantees that no association is
    preferred over another and even if more associations are
    taken into the one-to-many session, all receivers will get
    messages from the server and are not stalled forever on
    high load. This setting still leaves the advantage of per
    socket accounting in touch as an association can still use
    up global limits if unused by others.
    
    Fixes: 4eb701dfc618 ("[SCTP] Fix SCTP sendbuffer accouting.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Thomas Graf <tgraf@suug.ch>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1e2c611723420789e6098534fc0c57f12ee041b7
Author: Bjrn Mork <bjorn@mork.no>
Date:   Fri May 30 09:31:03 2014 +0200

    net: cdc_ncm: reduce skb truesize in rx path
    
    Cloning the big skbs we use for USB buffering chokes up TCP and
    SCTP because the socket memory limits are hitting earlier than
    they should. It is better to unconditionally copy the unwrapped
    packets to freshly allocated skbs.
    
    Reported-by: Jim Baxter <jim_baxter@mentor.com>
    Acked-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Bjrn Mork <bjorn@mork.no>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 987c76c0af87c57566bd9cb99e7a9f04fcd949be
Author: Karl Heiss <kheiss@gmail.com>
Date:   Fri Apr 25 14:26:30 2014 -0400

    net: sctp: Don't transition to PF state when transport has exhausted 'Path.Max.Retrans'.
    
    [ Upstream commit 8c2eab9097dba50bcd73ed4632baccc3f34857f9 ]
    
    Don't transition to the PF state on every strike after 'Path.Max.Retrans'.
    Per draft-ietf-tsvwg-sctp-failover-03 Section 5.1.6:
    
       Additional (PMR - PFMR) consecutive timeouts on a PF destination
       confirm the path failure, upon which the destination transitions to the
       Inactive state.  As described in [RFC4960], the sender (i) SHOULD notify
       ULP about this state transition, and (ii) transmit heartbeats to the
       Inactive destination at a lower frequency as described in Section 8.3 of
       [RFC4960].
    
    This also prevents sending SCTP_ADDR_UNREACHABLE to the user as the state
    bounces between SCTP_INACTIVE and SCTP_PF for each subsequent strike.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3938b0336a93fa5faa242dc9e5823ac69df9e066
Author: Vlad Yasevich <vyasevic@redhat.com>
Date:   Thu Apr 17 17:26:50 2014 +0200

    net: sctp: cache auth_enable per endpoint
    
    [ Upstream commit b14878ccb7fac0242db82720b784ab62c467c0dc ]
    
    Currently, it is possible to create an SCTP socket, then switch
    auth_enable via sysctl setting to 1 and crash the system on connect:
    
    Oops[#1]:
    CPU: 0 PID: 0 Comm: swapper Not tainted 3.14.1-mipsgit-20140415 #1
    task: ffffffff8056ce80 ti: ffffffff8055c000 task.ti: ffffffff8055c000
    [...]
    Call Trace:
    [<ffffffff8043c4e8>] sctp_auth_asoc_set_default_hmac+0x68/0x80
    [<ffffffff8042b300>] sctp_process_init+0x5e0/0x8a4
    [<ffffffff8042188c>] sctp_sf_do_5_1B_init+0x234/0x34c
    [<ffffffff804228c8>] sctp_do_sm+0xb4/0x1e8
    [<ffffffff80425a08>] sctp_endpoint_bh_rcv+0x1c4/0x214
    [<ffffffff8043af68>] sctp_rcv+0x588/0x630
    [<ffffffff8043e8e8>] sctp6_rcv+0x10/0x24
    [<ffffffff803acb50>] ip6_input+0x2c0/0x440
    [<ffffffff8030fc00>] __netif_receive_skb_core+0x4a8/0x564
    [<ffffffff80310650>] process_backlog+0xb4/0x18c
    [<ffffffff80313cbc>] net_rx_action+0x12c/0x210
    [<ffffffff80034254>] __do_softirq+0x17c/0x2ac
    [<ffffffff800345e0>] irq_exit+0x54/0xb0
    [<ffffffff800075a4>] ret_from_irq+0x0/0x4
    [<ffffffff800090ec>] rm7k_wait_irqoff+0x24/0x48
    [<ffffffff8005e388>] cpu_startup_entry+0xc0/0x148
    [<ffffffff805a88b0>] start_kernel+0x37c/0x398
    Code: dd0900b8  000330f8  0126302d <dcc60000> 50c0fff1  0047182a  a48306a0
    03e00008  00000000
    ---[ end trace b530b0551467f2fd ]---
    Kernel panic - not syncing: Fatal exception in interrupt
    
    What happens while auth_enable=0 in that case is, that
    ep->auth_hmacs is initialized to NULL in sctp_auth_init_hmacs()
    when endpoint is being created.
    
    After that point, if an admin switches over to auth_enable=1,
    the machine can crash due to NULL pointer dereference during
    reception of an INIT chunk. When we enter sctp_process_init()
    via sctp_sf_do_5_1B_init() in order to respond to an INIT chunk,
    the INIT verification succeeds and while we walk and process
    all INIT params via sctp_process_param() we find that
    net->sctp.auth_enable is set, therefore do not fall through,
    but invoke sctp_auth_asoc_set_default_hmac() instead, and thus,
    dereference what we have set to NULL during endpoint
    initialization phase.
    
    The fix is to make auth_enable immutable by caching its value
    during endpoint initialization, so that its original value is
    being carried along until destruction. The bug seems to originate
    from the very first days.
    
    Fix in joint work with Daniel Borkmann.
    
    Reported-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: Vlad Yasevich <vyasevic@redhat.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bde6d78b4a05212e6611c7c2fe104fa72512b6eb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Apr 14 21:45:17 2014 +0200

    Revert "net: sctp: Fix a_rwnd/rwnd management to reflect real state of the receiver's buffer"
    
    [ Upstream commit 362d52040c71f6e8d8158be48c812d7729cb8df1 ]
    
    This reverts commit ef2820a735f7 ("net: sctp: Fix a_rwnd/rwnd management
    to reflect real state of the receiver's buffer") as it introduced a
    serious performance regression on SCTP over IPv4 and IPv6, though a not
    as dramatic on the latter. Measurements are on 10Gbit/s with ixgbe NICs.
    
    Current state:
    
    [root@Lab200slot2 ~]# iperf3 --sctp -4 -c 192.168.241.3 -V -l 1452 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0 #1 SMP Thu Apr 3 23:18:29 EDT 2014 x86_64
    Time: Fri, 11 Apr 2014 17:56:21 GMT
    Connecting to host 192.168.241.3, port 5201
          Cookie: Lab200slot2.1397238981.812898.548918
    [  4] local 192.168.241.2 port 38616 connected to 192.168.241.3 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1452 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.09   sec  20.8 MBytes   161 Mbits/sec
    [  4]   1.09-2.13   sec  10.8 MBytes  86.8 Mbits/sec
    [  4]   2.13-3.15   sec  3.57 MBytes  29.5 Mbits/sec
    [  4]   3.15-4.16   sec  4.33 MBytes  35.7 Mbits/sec
    [  4]   4.16-6.21   sec  10.4 MBytes  42.7 Mbits/sec
    [  4]   6.21-6.21   sec  0.00 Bytes    0.00 bits/sec
    [  4]   6.21-7.35   sec  34.6 MBytes   253 Mbits/sec
    [  4]   7.35-11.45  sec  22.0 MBytes  45.0 Mbits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-12.51  sec  16.0 MBytes   126 Mbits/sec
    [  4]  12.51-13.59  sec  20.3 MBytes   158 Mbits/sec
    [  4]  13.59-14.65  sec  13.4 MBytes   107 Mbits/sec
    [  4]  14.65-16.79  sec  33.3 MBytes   130 Mbits/sec
    [  4]  16.79-16.79  sec  0.00 Bytes    0.00 bits/sec
    [  4]  16.79-17.82  sec  5.94 MBytes  48.7 Mbits/sec
    (etc)
    
    [root@Lab200slot2 ~]#  iperf3 --sctp -6 -c 2001:db8:0:f101::1 -V -l 1400 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0 #1 SMP Thu Apr 3 23:18:29 EDT 2014 x86_64
    Time: Fri, 11 Apr 2014 19:08:41 GMT
    Connecting to host 2001:db8:0:f101::1, port 5201
          Cookie: Lab200slot2.1397243321.714295.2b3f7c
    [  4] local 2001:db8:0:f101::2 port 55804 connected to 2001:db8:0:f101::1 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1400 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.00   sec   169 MBytes  1.42 Gbits/sec
    [  4]   1.00-2.00   sec   201 MBytes  1.69 Gbits/sec
    [  4]   2.00-3.00   sec   188 MBytes  1.58 Gbits/sec
    [  4]   3.00-4.00   sec   174 MBytes  1.46 Gbits/sec
    [  4]   4.00-5.00   sec   165 MBytes  1.39 Gbits/sec
    [  4]   5.00-6.00   sec   199 MBytes  1.67 Gbits/sec
    [  4]   6.00-7.00   sec   163 MBytes  1.36 Gbits/sec
    [  4]   7.00-8.00   sec   174 MBytes  1.46 Gbits/sec
    [  4]   8.00-9.00   sec   193 MBytes  1.62 Gbits/sec
    [  4]   9.00-10.00  sec   196 MBytes  1.65 Gbits/sec
    [  4]  10.00-11.00  sec   157 MBytes  1.31 Gbits/sec
    [  4]  11.00-12.00  sec   175 MBytes  1.47 Gbits/sec
    [  4]  12.00-13.00  sec   192 MBytes  1.61 Gbits/sec
    [  4]  13.00-14.00  sec   199 MBytes  1.67 Gbits/sec
    (etc)
    
    After patch:
    
    [root@Lab200slot2 ~]#  iperf3 --sctp -4 -c 192.168.240.3 -V -l 1452 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0+ #1 SMP Mon Apr 14 12:06:40 EDT 2014 x86_64
    Time: Mon, 14 Apr 2014 16:40:48 GMT
    Connecting to host 192.168.240.3, port 5201
          Cookie: Lab200slot2.1397493648.413274.65e131
    [  4] local 192.168.240.2 port 50548 connected to 192.168.240.3 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1452 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.00   sec   240 MBytes  2.02 Gbits/sec
    [  4]   1.00-2.00   sec   239 MBytes  2.01 Gbits/sec
    [  4]   2.00-3.00   sec   240 MBytes  2.01 Gbits/sec
    [  4]   3.00-4.00   sec   239 MBytes  2.00 Gbits/sec
    [  4]   4.00-5.00   sec   245 MBytes  2.05 Gbits/sec
    [  4]   5.00-6.00   sec   240 MBytes  2.01 Gbits/sec
    [  4]   6.00-7.00   sec   240 MBytes  2.02 Gbits/sec
    [  4]   7.00-8.00   sec   239 MBytes  2.01 Gbits/sec
    
    With the reverted patch applied, the SCTP/IPv4 performance is back
    to normal on latest upstream for IPv4 and IPv6 and has same throughput
    as 3.4.2 test kernel, steady and interval reports are smooth again.
    
    Fixes: ef2820a735f7 ("net: sctp: Fix a_rwnd/rwnd management to reflect real state of the receiver's buffer")
    Reported-by: Peter Butler <pbutler@sonusnet.com>
    Reported-by: Dongsheng Song <dongsheng.song@gmail.com>
    Reported-by: Fengguang Wu <fengguang.wu@intel.com>
    Tested-by: Peter Butler <pbutler@sonusnet.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Matija Glavinic Pecotic <matija.glavinic-pecotic.ext@nsn.com>
    Cc: Alexander Sverdlin <alexander.sverdlin@nsn.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a4800639980844fbcfe6ec8c89dca0934dce513d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 8 17:26:13 2014 +0200

    net: sctp: wake up all assocs if sndbuf policy is per socket
    
    [ Upstream commit 52c35befb69b005c3fc5afdaae3a5717ad013411 ]
    
    SCTP charges chunks for wmem accounting via skb->truesize in
    sctp_set_owner_w(), and sctp_wfree() respectively as the
    reverse operation. If a sender runs out of wmem, it needs to
    wait via sctp_wait_for_sndbuf(), and gets woken up by a call
    to __sctp_write_space() mostly via sctp_wfree().
    
    __sctp_write_space() is being called per association. Although
    we assign sk->sk_write_space() to sctp_write_space(), which
    is then being done per socket, it is only used if send space
    is increased per socket option (SO_SNDBUF), as SOCK_USE_WRITE_QUEUE
    is set and therefore not invoked in sock_wfree().
    
    Commit 4c3a5bdae293 ("sctp: Don't charge for data in sndbuf
    again when transmitting packet") fixed an issue where in case
    sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again
    unless it is interrupted by a signal. However, a still
    remaining issue is that if net.sctp.sndbuf_policy=0, that is
    accounting per socket, and one-to-many sockets are in use,
    the reclaimed write space from sctp_wfree() is 'unfairly'
    handed back on the server to the association that is the lucky
    one to be woken up again via __sctp_write_space(), while
    the remaining associations are never be woken up again
    (unless by a signal).
    
    The effect disappears with net.sctp.sndbuf_policy=1, that
    is wmem accounting per association, as it guarantees a fair
    share of wmem among associations.
    
    Therefore, if we have reclaimed memory in case of per socket
    accounting, wake all related associations to a socket in a
    fair manner, that is, traverse the socket association list
    starting from the current neighbour of the association and
    issue a __sctp_write_space() to everyone until we end up
    waking ourselves. This guarantees that no association is
    preferred over another and even if more associations are
    taken into the one-to-many session, all receivers will get
    messages from the server and are not stalled forever on
    high load. This setting still leaves the advantage of per
    socket accounting in touch as an association can still use
    up global limits if unused by others.
    
    Fixes: 4eb701dfc618 ("[SCTP] Fix SCTP sendbuffer accouting.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Thomas Graf <tgraf@suug.ch>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e5eae4a0511241959498b180fa0df0d4f1b11b9c
Author: Vlad Yasevich <vyasevic@redhat.com>
Date:   Thu Apr 17 17:26:50 2014 +0200

    net: sctp: cache auth_enable per endpoint
    
    [ Upstream commit b14878ccb7fac0242db82720b784ab62c467c0dc ]
    
    Currently, it is possible to create an SCTP socket, then switch
    auth_enable via sysctl setting to 1 and crash the system on connect:
    
    Oops[#1]:
    CPU: 0 PID: 0 Comm: swapper Not tainted 3.14.1-mipsgit-20140415 #1
    task: ffffffff8056ce80 ti: ffffffff8055c000 task.ti: ffffffff8055c000
    [...]
    Call Trace:
    [<ffffffff8043c4e8>] sctp_auth_asoc_set_default_hmac+0x68/0x80
    [<ffffffff8042b300>] sctp_process_init+0x5e0/0x8a4
    [<ffffffff8042188c>] sctp_sf_do_5_1B_init+0x234/0x34c
    [<ffffffff804228c8>] sctp_do_sm+0xb4/0x1e8
    [<ffffffff80425a08>] sctp_endpoint_bh_rcv+0x1c4/0x214
    [<ffffffff8043af68>] sctp_rcv+0x588/0x630
    [<ffffffff8043e8e8>] sctp6_rcv+0x10/0x24
    [<ffffffff803acb50>] ip6_input+0x2c0/0x440
    [<ffffffff8030fc00>] __netif_receive_skb_core+0x4a8/0x564
    [<ffffffff80310650>] process_backlog+0xb4/0x18c
    [<ffffffff80313cbc>] net_rx_action+0x12c/0x210
    [<ffffffff80034254>] __do_softirq+0x17c/0x2ac
    [<ffffffff800345e0>] irq_exit+0x54/0xb0
    [<ffffffff800075a4>] ret_from_irq+0x0/0x4
    [<ffffffff800090ec>] rm7k_wait_irqoff+0x24/0x48
    [<ffffffff8005e388>] cpu_startup_entry+0xc0/0x148
    [<ffffffff805a88b0>] start_kernel+0x37c/0x398
    Code: dd0900b8  000330f8  0126302d <dcc60000> 50c0fff1  0047182a  a48306a0
    03e00008  00000000
    ---[ end trace b530b0551467f2fd ]---
    Kernel panic - not syncing: Fatal exception in interrupt
    
    What happens while auth_enable=0 in that case is, that
    ep->auth_hmacs is initialized to NULL in sctp_auth_init_hmacs()
    when endpoint is being created.
    
    After that point, if an admin switches over to auth_enable=1,
    the machine can crash due to NULL pointer dereference during
    reception of an INIT chunk. When we enter sctp_process_init()
    via sctp_sf_do_5_1B_init() in order to respond to an INIT chunk,
    the INIT verification succeeds and while we walk and process
    all INIT params via sctp_process_param() we find that
    net->sctp.auth_enable is set, therefore do not fall through,
    but invoke sctp_auth_asoc_set_default_hmac() instead, and thus,
    dereference what we have set to NULL during endpoint
    initialization phase.
    
    The fix is to make auth_enable immutable by caching its value
    during endpoint initialization, so that its original value is
    being carried along until destruction. The bug seems to originate
    from the very first days.
    
    Fix in joint work with Daniel Borkmann.
    
    Reported-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: Vlad Yasevich <vyasevic@redhat.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 83bd973b675208476e2a29b159b68c6ef796b66d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 8 17:26:13 2014 +0200

    net: sctp: wake up all assocs if sndbuf policy is per socket
    
    [ Upstream commit 52c35befb69b005c3fc5afdaae3a5717ad013411 ]
    
    SCTP charges chunks for wmem accounting via skb->truesize in
    sctp_set_owner_w(), and sctp_wfree() respectively as the
    reverse operation. If a sender runs out of wmem, it needs to
    wait via sctp_wait_for_sndbuf(), and gets woken up by a call
    to __sctp_write_space() mostly via sctp_wfree().
    
    __sctp_write_space() is being called per association. Although
    we assign sk->sk_write_space() to sctp_write_space(), which
    is then being done per socket, it is only used if send space
    is increased per socket option (SO_SNDBUF), as SOCK_USE_WRITE_QUEUE
    is set and therefore not invoked in sock_wfree().
    
    Commit 4c3a5bdae293 ("sctp: Don't charge for data in sndbuf
    again when transmitting packet") fixed an issue where in case
    sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again
    unless it is interrupted by a signal. However, a still
    remaining issue is that if net.sctp.sndbuf_policy=0, that is
    accounting per socket, and one-to-many sockets are in use,
    the reclaimed write space from sctp_wfree() is 'unfairly'
    handed back on the server to the association that is the lucky
    one to be woken up again via __sctp_write_space(), while
    the remaining associations are never be woken up again
    (unless by a signal).
    
    The effect disappears with net.sctp.sndbuf_policy=1, that
    is wmem accounting per association, as it guarantees a fair
    share of wmem among associations.
    
    Therefore, if we have reclaimed memory in case of per socket
    accounting, wake all related associations to a socket in a
    fair manner, that is, traverse the socket association list
    starting from the current neighbour of the association and
    issue a __sctp_write_space() to everyone until we end up
    waking ourselves. This guarantees that no association is
    preferred over another and even if more associations are
    taken into the one-to-many session, all receivers will get
    messages from the server and are not stalled forever on
    high load. This setting still leaves the advantage of per
    socket accounting in touch as an association can still use
    up global limits if unused by others.
    
    Fixes: 4eb701dfc618 ("[SCTP] Fix SCTP sendbuffer accouting.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Thomas Graf <tgraf@suug.ch>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 88830f227a1f96e44d82ddfcb0cc81d517ec6dd8
Author: Vlad Yasevich <vyasevic@redhat.com>
Date:   Thu Apr 17 17:26:50 2014 +0200

    net: sctp: cache auth_enable per endpoint
    
    [ Upstream commit b14878ccb7fac0242db82720b784ab62c467c0dc ]
    
    Currently, it is possible to create an SCTP socket, then switch
    auth_enable via sysctl setting to 1 and crash the system on connect:
    
    Oops[#1]:
    CPU: 0 PID: 0 Comm: swapper Not tainted 3.14.1-mipsgit-20140415 #1
    task: ffffffff8056ce80 ti: ffffffff8055c000 task.ti: ffffffff8055c000
    [...]
    Call Trace:
    [<ffffffff8043c4e8>] sctp_auth_asoc_set_default_hmac+0x68/0x80
    [<ffffffff8042b300>] sctp_process_init+0x5e0/0x8a4
    [<ffffffff8042188c>] sctp_sf_do_5_1B_init+0x234/0x34c
    [<ffffffff804228c8>] sctp_do_sm+0xb4/0x1e8
    [<ffffffff80425a08>] sctp_endpoint_bh_rcv+0x1c4/0x214
    [<ffffffff8043af68>] sctp_rcv+0x588/0x630
    [<ffffffff8043e8e8>] sctp6_rcv+0x10/0x24
    [<ffffffff803acb50>] ip6_input+0x2c0/0x440
    [<ffffffff8030fc00>] __netif_receive_skb_core+0x4a8/0x564
    [<ffffffff80310650>] process_backlog+0xb4/0x18c
    [<ffffffff80313cbc>] net_rx_action+0x12c/0x210
    [<ffffffff80034254>] __do_softirq+0x17c/0x2ac
    [<ffffffff800345e0>] irq_exit+0x54/0xb0
    [<ffffffff800075a4>] ret_from_irq+0x0/0x4
    [<ffffffff800090ec>] rm7k_wait_irqoff+0x24/0x48
    [<ffffffff8005e388>] cpu_startup_entry+0xc0/0x148
    [<ffffffff805a88b0>] start_kernel+0x37c/0x398
    Code: dd0900b8  000330f8  0126302d <dcc60000> 50c0fff1  0047182a  a48306a0
    03e00008  00000000
    ---[ end trace b530b0551467f2fd ]---
    Kernel panic - not syncing: Fatal exception in interrupt
    
    What happens while auth_enable=0 in that case is, that
    ep->auth_hmacs is initialized to NULL in sctp_auth_init_hmacs()
    when endpoint is being created.
    
    After that point, if an admin switches over to auth_enable=1,
    the machine can crash due to NULL pointer dereference during
    reception of an INIT chunk. When we enter sctp_process_init()
    via sctp_sf_do_5_1B_init() in order to respond to an INIT chunk,
    the INIT verification succeeds and while we walk and process
    all INIT params via sctp_process_param() we find that
    net->sctp.auth_enable is set, therefore do not fall through,
    but invoke sctp_auth_asoc_set_default_hmac() instead, and thus,
    dereference what we have set to NULL during endpoint
    initialization phase.
    
    The fix is to make auth_enable immutable by caching its value
    during endpoint initialization, so that its original value is
    being carried along until destruction. The bug seems to originate
    from the very first days.
    
    Fix in joint work with Daniel Borkmann.
    
    Reported-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: Vlad Yasevich <vyasevic@redhat.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 13d6a70cadb22ae71f62ad56752451fa848fc346
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 8 17:26:13 2014 +0200

    net: sctp: wake up all assocs if sndbuf policy is per socket
    
    [ Upstream commit 52c35befb69b005c3fc5afdaae3a5717ad013411 ]
    
    SCTP charges chunks for wmem accounting via skb->truesize in
    sctp_set_owner_w(), and sctp_wfree() respectively as the
    reverse operation. If a sender runs out of wmem, it needs to
    wait via sctp_wait_for_sndbuf(), and gets woken up by a call
    to __sctp_write_space() mostly via sctp_wfree().
    
    __sctp_write_space() is being called per association. Although
    we assign sk->sk_write_space() to sctp_write_space(), which
    is then being done per socket, it is only used if send space
    is increased per socket option (SO_SNDBUF), as SOCK_USE_WRITE_QUEUE
    is set and therefore not invoked in sock_wfree().
    
    Commit 4c3a5bdae293 ("sctp: Don't charge for data in sndbuf
    again when transmitting packet") fixed an issue where in case
    sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again
    unless it is interrupted by a signal. However, a still
    remaining issue is that if net.sctp.sndbuf_policy=0, that is
    accounting per socket, and one-to-many sockets are in use,
    the reclaimed write space from sctp_wfree() is 'unfairly'
    handed back on the server to the association that is the lucky
    one to be woken up again via __sctp_write_space(), while
    the remaining associations are never be woken up again
    (unless by a signal).
    
    The effect disappears with net.sctp.sndbuf_policy=1, that
    is wmem accounting per association, as it guarantees a fair
    share of wmem among associations.
    
    Therefore, if we have reclaimed memory in case of per socket
    accounting, wake all related associations to a socket in a
    fair manner, that is, traverse the socket association list
    starting from the current neighbour of the association and
    issue a __sctp_write_space() to everyone until we end up
    waking ourselves. This guarantees that no association is
    preferred over another and even if more associations are
    taken into the one-to-many session, all receivers will get
    messages from the server and are not stalled forever on
    high load. This setting still leaves the advantage of per
    socket accounting in touch as an association can still use
    up global limits if unused by others.
    
    Fixes: 4eb701dfc618 ("[SCTP] Fix SCTP sendbuffer accouting.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Thomas Graf <tgraf@suug.ch>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 8663707a797e6a473c32cf08eb7597543bbdae79
Author: Nicolas Dichtel <nicolas.dichtel@6wind.com>
Date:   Fri Nov 8 11:13:55 2013 +0100

    sctp: unbalanced rcu lock in ip_queue_xmit()
    
    The bug was introduced in 2.6.32.61 by commit b8710128e201 ("inet: add RCU
    protection to inet->opt") (it's a backport of upstream commit f6d8bd051c39).
    
    In SCTP case, packet is already routed, hence we jump to the label
    'packet_routed', but without rcu_read_lock(). After this label,
    rcu_read_unlock() is called unconditionally.
    
    Spotted-by: Guo Fengtian <fengtian.guo@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 3c3e5e546a2a8fe6b2d5d5e5e3385430999ce585
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 57b7a1c227f4d069878e9d4199a11e53e99c3240
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit dc66dd92bd8f9ebfea5e3f72a270c06f23670f92
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 618664aefb3819cf77720b17b894df55e4ca4d93
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    [ Upstream commit d2dbbba77e95dff4b4f901fee236fef6d9552072 ]
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 5f6eddcbb90c3e98738e50759fe20776ac24fd33
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Mar 12 15:53:23 2013 +0000

    sctp: Use correct sideffect command in duplicate cookie handling
    
    commit f2815633504b442ca0b0605c16bf3d88a3a0fcea upstream
    
    When SCTP is done processing a duplicate cookie chunk, it tries
    to delete a newly created association.  For that, it has to set
    the right association for the side-effect processing to work.
    However, when it uses the SCTP_CMD_NEW_ASOC command, that performs
    more work then really needed (like hashing the associationa and
    assigning it an id) and there is no point to do that only to
    delete the association as a next step.  In fact, it also creates
    an impossible condition where an association may be found by
    the getsockopt() call, and that association is empty.  This
    causes a crash in some sctp getsockopts.
    
    The solution is rather simple.  We simply use SCTP_CMD_SET_ASOC
    command that doesn't have all the overhead and does exactly
    what we need.
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Tested-by: Karl Heiss <kheiss@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 88a5a5fa2a0f5ab9995d54f605f42a295202d042
Author: Max Matveev <makc@redhat.com>
Date:   Mon Aug 29 21:02:24 2011 +0000

    sctp: deal with multiple COOKIE_ECHO chunks
    
    commit d5ccd496601b8776a516d167a6485754575dc38f upstream
    
    Attempt to reduce the number of IP packets emitted in response to single
    SCTP packet (2e3216cd) introduced a complication - if a packet contains
    two COOKIE_ECHO chunks and nothing else then SCTP state machine corks the
    socket while processing first COOKIE_ECHO and then loses the association
    and forgets to uncork the socket. To deal with the issue add new SCTP
    command which can be used to set association explictly. Use this new
    command when processing second COOKIE_ECHO chunk to restore the context
    for SCTP state machine.
    
    Signed-off-by: Max Matveev <makc@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [dannf: backported to Debian's 2.6.32]
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit d92ab13558599cf73bbc269ce257fe16575d327a
Author: Jarno Rajahalme <jrajahalme@nicira.com>
Date:   Thu Mar 27 12:47:11 2014 -0700

    openvswitch: Fix output of SCTP mask.
    
    The 'output' argument of the ovs_nla_put_flow() is the one from which
    the bits are written to the netlink attributes.  For SCTP we
    accidentally used the bits from the 'swkey' instead.  This caused the
    mask attributes to include the bits from the actual flow key instead
    of the mask.
    
    Signed-off-by: Jarno Rajahalme <jrajahalme@nicira.com>
    Acked-by: Pravin B Shelar <pshelar@nicira.com>
    Signed-off-by: Jesse Gross <jesse@nicira.com>

commit 2080cee435088a2390195c2424e494c50e37d6a1
Merge: 783e9e8ede80 c8ea5a22bd3b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon May 5 15:59:46 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) e1000e computes header length incorrectly wrt vlans, fix from Vlad
        Yasevich.
    
     2) ns_capable() check in sock_diag netlink code, from Andrew
        Lutomirski.
    
     3) Fix invalid queue pairs handling in virtio_net, from Amos Kong.
    
     4) Checksum offloading busted in sxgbe driver due to incorrect
        descriptor layout, fix from Byungho An.
    
     5) Fix build failure with SMC_DEBUG set to 2 or larger, from Zi Shen
        Lim.
    
     6) Fix uninitialized A and X registers in BPF interpreter, from Alexei
        Starovoitov.
    
     7) Fix arch dependencies of candence driver.
    
     8) Fix netlink capabilities checking tree-wide, from Eric W Biederman.
    
     9) Don't dump IFLA_VF_PORTS if netlink request didn't ask for it in
        IFLA_EXT_MASK, from David Gibson.
    
    10) IPV6 FIB dump restart doesn't handle table changes that happen
        meanwhile, causing the code to loop forever or emit dups, fix from
        Kumar Sandararajan.
    
    11) Memory leak on VF removal in bnx2x, from Yuval Mintz.
    
    12) Bug fixes for new Altera TSE driver from Vince Bridgers.
    
    13) Fix route lookup key in SCTP, from Xugeng Zhang.
    
    14) Use BH blocking spinlocks in SLIP, as per a similar fix to CAN/SLCAN
        driver.  From Oliver Hartkopp.
    
    15) TCP doesn't bump retransmit counters in some code paths, fix from
        Eric Dumazet.
    
    16) Clamp delayed_ack in tcp_cubic to prevent theoretical divides by
        zero.  Fix from Liu Yu.
    
    17) Fix locking imbalance in error paths of HHF packet scheduler, from
        John Fastabend.
    
    18) Properly reference the transport module when vsock_core_init() runs,
        from Andy King.
    
    19) Fix buffer overflow in cdc_ncm driver, from Bjrn Mork.
    
    20) IP_ECN_decapsulate() doesn't see a correct SKB network header in
        ip_tunnel_rcv(), fix from Ying Cai.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (132 commits)
      net: macb: Fix race between HW and driver
      net: macb: Remove 'unlikely' optimization
      net: macb: Re-enable RX interrupt only when RX is done
      net: macb: Clear interrupt flags
      net: macb: Pass same size to DMA_UNMAP as used for DMA_MAP
      ip_tunnel: Set network header properly for IP_ECN_decapsulate()
      e1000e: Restrict MDIO Slow Mode workaround to relevant parts
      e1000e: Fix issue with link flap on 82579
      e1000e: Expand workaround for 10Mb HD throughput bug
      e1000e: Workaround for dropped packets in Gig/100 speeds on 82579
      net/mlx4_core: Don't issue PCIe speed/width checks for VFs
      net/mlx4_core: Load the Eth driver first
      net/mlx4_core: Fix slave id computation for single port VF
      net/mlx4_core: Adjust port number in qp_attach wrapper when detaching
      net: cdc_ncm: fix buffer overflow
      Altera TSE: ALTERA_TSE should depend on HAS_DMA
      vsock: Make transport the proto owner
      net: sched: lock imbalance in hhf qdisc
      net: mvmdio: Check for a valid interrupt instead of an error
      net phy: Check for aneg completion before setting state to PHY_RUNNING
      ...

commit 46e9c408e8537254f89a5b6b930fdda85eaba143
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8c2eab9097dba50bcd73ed4632baccc3f34857f9
Author: Karl Heiss <kheiss@gmail.com>
Date:   Fri Apr 25 14:26:30 2014 -0400

    net: sctp: Don't transition to PF state when transport has exhausted 'Path.Max.Retrans'.
    
    Don't transition to the PF state on every strike after 'Path.Max.Retrans'.
    Per draft-ietf-tsvwg-sctp-failover-03 Section 5.1.6:
    
       Additional (PMR - PFMR) consecutive timeouts on a PF destination
       confirm the path failure, upon which the destination transitions to the
       Inactive state.  As described in [RFC4960], the sender (i) SHOULD notify
       ULP about this state transition, and (ii) transmit heartbeats to the
       Inactive destination at a lower frequency as described in Section 8.3 of
       [RFC4960].
    
    This also prevents sending SCTP_ADDR_UNREACHABLE to the user as the state
    bounces between SCTP_INACTIVE and SCTP_PF for each subsequent strike.
    
    Signed-off-by: Karl Heiss <kheiss@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 978a9b75b98d918e757eac01d0008fd30252e3bf
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ebfc45ee7004088d610cd399d2dee6d95f87199b
Merge: 6e66d5dab5d5 b14878ccb7fa
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 18 17:53:46 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull more networking fixes from David Miller:
    
     1) Fix mlx4_en_netpoll implementation, it needs to schedule a NAPI
        context, not synchronize it.  From Chris Mason.
    
     2) Ipv4 flow input interface should never be zero, it should be
        LOOPBACK_IFINDEX instead.  From Cong Wang and Julian Anastasov.
    
     3) Properly configure MAC to PHY connection in mvneta devices, from
        Thomas Petazzoni.
    
     4) sys_recv should use SYSCALL_DEFINE.  From Jan Glauber.
    
     5) Tunnel driver ioctls do not use the correct namespace, fix from
        Nicolas Dichtel.
    
     6) Fix memory leak on seccomp filter attach, from Kees Cook.
    
     7) Fix lockdep warning for nested vlans, from Ding Tianhong.
    
     8) Crashes can happen in SCTP due to how the auth_enable value is
        managed, fix from Vlad Yasevich.
    
     9) Wireless fixes from John W Linville and co.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (45 commits)
      net: sctp: cache auth_enable per endpoint
      tg3: update rx_jumbo_pending ring param only when jumbo frames are enabled
      vlan: Fix lockdep warning when vlan dev handle notification
      seccomp: fix memory leak on filter attach
      isdn: icn: buffer overflow in icn_command()
      ip6_tunnel: use the right netns in ioctl handler
      sit: use the right netns in ioctl handler
      ip_tunnel: use the right netns in ioctl handler
      net: use SYSCALL_DEFINEx for sys_recv
      net: mdio-gpio: Add support for separate MDI and MDO gpio pins
      net: mdio-gpio: Add support for active low gpio pins
      net: mdio-gpio: Use devm_ functions where possible
      ipv4, route: pass 0 instead of LOOPBACK_IFINDEX to fib_validate_source()
      ipv4, fib: pass LOOPBACK_IFINDEX instead of 0 to flowi4_iif
      mlx4_en: don't use napi_synchronize inside mlx4_en_netpoll
      net: mvneta: properly configure the MAC <-> PHY connection in all situations
      net: phy: add minimal support for QSGMII PHY
      sfc:On MCDI timeout, issue an FLR (and mark MCDI to fail-fast)
      mwifiex: fix hung task on command timeout
      mwifiex: process event before command response
      ...

commit b14878ccb7fac0242db82720b784ab62c467c0dc
Author: Vlad Yasevich <vyasevic@redhat.com>
Date:   Thu Apr 17 17:26:50 2014 +0200

    net: sctp: cache auth_enable per endpoint
    
    Currently, it is possible to create an SCTP socket, then switch
    auth_enable via sysctl setting to 1 and crash the system on connect:
    
    Oops[#1]:
    CPU: 0 PID: 0 Comm: swapper Not tainted 3.14.1-mipsgit-20140415 #1
    task: ffffffff8056ce80 ti: ffffffff8055c000 task.ti: ffffffff8055c000
    [...]
    Call Trace:
    [<ffffffff8043c4e8>] sctp_auth_asoc_set_default_hmac+0x68/0x80
    [<ffffffff8042b300>] sctp_process_init+0x5e0/0x8a4
    [<ffffffff8042188c>] sctp_sf_do_5_1B_init+0x234/0x34c
    [<ffffffff804228c8>] sctp_do_sm+0xb4/0x1e8
    [<ffffffff80425a08>] sctp_endpoint_bh_rcv+0x1c4/0x214
    [<ffffffff8043af68>] sctp_rcv+0x588/0x630
    [<ffffffff8043e8e8>] sctp6_rcv+0x10/0x24
    [<ffffffff803acb50>] ip6_input+0x2c0/0x440
    [<ffffffff8030fc00>] __netif_receive_skb_core+0x4a8/0x564
    [<ffffffff80310650>] process_backlog+0xb4/0x18c
    [<ffffffff80313cbc>] net_rx_action+0x12c/0x210
    [<ffffffff80034254>] __do_softirq+0x17c/0x2ac
    [<ffffffff800345e0>] irq_exit+0x54/0xb0
    [<ffffffff800075a4>] ret_from_irq+0x0/0x4
    [<ffffffff800090ec>] rm7k_wait_irqoff+0x24/0x48
    [<ffffffff8005e388>] cpu_startup_entry+0xc0/0x148
    [<ffffffff805a88b0>] start_kernel+0x37c/0x398
    Code: dd0900b8  000330f8  0126302d <dcc60000> 50c0fff1  0047182a  a48306a0
    03e00008  00000000
    ---[ end trace b530b0551467f2fd ]---
    Kernel panic - not syncing: Fatal exception in interrupt
    
    What happens while auth_enable=0 in that case is, that
    ep->auth_hmacs is initialized to NULL in sctp_auth_init_hmacs()
    when endpoint is being created.
    
    After that point, if an admin switches over to auth_enable=1,
    the machine can crash due to NULL pointer dereference during
    reception of an INIT chunk. When we enter sctp_process_init()
    via sctp_sf_do_5_1B_init() in order to respond to an INIT chunk,
    the INIT verification succeeds and while we walk and process
    all INIT params via sctp_process_param() we find that
    net->sctp.auth_enable is set, therefore do not fall through,
    but invoke sctp_auth_asoc_set_default_hmac() instead, and thus,
    dereference what we have set to NULL during endpoint
    initialization phase.
    
    The fix is to make auth_enable immutable by caching its value
    during endpoint initialization, so that its original value is
    being carried along until destruction. The bug seems to originate
    from the very first days.
    
    Fix in joint work with Daniel Borkmann.
    
    Reported-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: Vlad Yasevich <vyasevic@redhat.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Joshua Kinard <kumba@gentoo.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 607e4255f134e7f461d9799d30053499b0392a3a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 362d52040c71f6e8d8158be48c812d7729cb8df1
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Apr 14 21:45:17 2014 +0200

    Revert "net: sctp: Fix a_rwnd/rwnd management to reflect real state of the receiver's buffer"
    
    This reverts commit ef2820a735f7 ("net: sctp: Fix a_rwnd/rwnd management
    to reflect real state of the receiver's buffer") as it introduced a
    serious performance regression on SCTP over IPv4 and IPv6, though a not
    as dramatic on the latter. Measurements are on 10Gbit/s with ixgbe NICs.
    
    Current state:
    
    [root@Lab200slot2 ~]# iperf3 --sctp -4 -c 192.168.241.3 -V -l 1452 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0 #1 SMP Thu Apr 3 23:18:29 EDT 2014 x86_64
    Time: Fri, 11 Apr 2014 17:56:21 GMT
    Connecting to host 192.168.241.3, port 5201
          Cookie: Lab200slot2.1397238981.812898.548918
    [  4] local 192.168.241.2 port 38616 connected to 192.168.241.3 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1452 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.09   sec  20.8 MBytes   161 Mbits/sec
    [  4]   1.09-2.13   sec  10.8 MBytes  86.8 Mbits/sec
    [  4]   2.13-3.15   sec  3.57 MBytes  29.5 Mbits/sec
    [  4]   3.15-4.16   sec  4.33 MBytes  35.7 Mbits/sec
    [  4]   4.16-6.21   sec  10.4 MBytes  42.7 Mbits/sec
    [  4]   6.21-6.21   sec  0.00 Bytes    0.00 bits/sec
    [  4]   6.21-7.35   sec  34.6 MBytes   253 Mbits/sec
    [  4]   7.35-11.45  sec  22.0 MBytes  45.0 Mbits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-11.45  sec  0.00 Bytes    0.00 bits/sec
    [  4]  11.45-12.51  sec  16.0 MBytes   126 Mbits/sec
    [  4]  12.51-13.59  sec  20.3 MBytes   158 Mbits/sec
    [  4]  13.59-14.65  sec  13.4 MBytes   107 Mbits/sec
    [  4]  14.65-16.79  sec  33.3 MBytes   130 Mbits/sec
    [  4]  16.79-16.79  sec  0.00 Bytes    0.00 bits/sec
    [  4]  16.79-17.82  sec  5.94 MBytes  48.7 Mbits/sec
    (etc)
    
    [root@Lab200slot2 ~]#  iperf3 --sctp -6 -c 2001:db8:0:f101::1 -V -l 1400 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0 #1 SMP Thu Apr 3 23:18:29 EDT 2014 x86_64
    Time: Fri, 11 Apr 2014 19:08:41 GMT
    Connecting to host 2001:db8:0:f101::1, port 5201
          Cookie: Lab200slot2.1397243321.714295.2b3f7c
    [  4] local 2001:db8:0:f101::2 port 55804 connected to 2001:db8:0:f101::1 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1400 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.00   sec   169 MBytes  1.42 Gbits/sec
    [  4]   1.00-2.00   sec   201 MBytes  1.69 Gbits/sec
    [  4]   2.00-3.00   sec   188 MBytes  1.58 Gbits/sec
    [  4]   3.00-4.00   sec   174 MBytes  1.46 Gbits/sec
    [  4]   4.00-5.00   sec   165 MBytes  1.39 Gbits/sec
    [  4]   5.00-6.00   sec   199 MBytes  1.67 Gbits/sec
    [  4]   6.00-7.00   sec   163 MBytes  1.36 Gbits/sec
    [  4]   7.00-8.00   sec   174 MBytes  1.46 Gbits/sec
    [  4]   8.00-9.00   sec   193 MBytes  1.62 Gbits/sec
    [  4]   9.00-10.00  sec   196 MBytes  1.65 Gbits/sec
    [  4]  10.00-11.00  sec   157 MBytes  1.31 Gbits/sec
    [  4]  11.00-12.00  sec   175 MBytes  1.47 Gbits/sec
    [  4]  12.00-13.00  sec   192 MBytes  1.61 Gbits/sec
    [  4]  13.00-14.00  sec   199 MBytes  1.67 Gbits/sec
    (etc)
    
    After patch:
    
    [root@Lab200slot2 ~]#  iperf3 --sctp -4 -c 192.168.240.3 -V -l 1452 -t 60
    iperf version 3.0.1 (10 January 2014)
    Linux Lab200slot2 3.14.0+ #1 SMP Mon Apr 14 12:06:40 EDT 2014 x86_64
    Time: Mon, 14 Apr 2014 16:40:48 GMT
    Connecting to host 192.168.240.3, port 5201
          Cookie: Lab200slot2.1397493648.413274.65e131
    [  4] local 192.168.240.2 port 50548 connected to 192.168.240.3 port 5201
    Starting Test: protocol: SCTP, 1 streams, 1452 byte blocks, omitting 0 seconds, 60 second test
    [ ID] Interval           Transfer     Bandwidth
    [  4]   0.00-1.00   sec   240 MBytes  2.02 Gbits/sec
    [  4]   1.00-2.00   sec   239 MBytes  2.01 Gbits/sec
    [  4]   2.00-3.00   sec   240 MBytes  2.01 Gbits/sec
    [  4]   3.00-4.00   sec   239 MBytes  2.00 Gbits/sec
    [  4]   4.00-5.00   sec   245 MBytes  2.05 Gbits/sec
    [  4]   5.00-6.00   sec   240 MBytes  2.01 Gbits/sec
    [  4]   6.00-7.00   sec   240 MBytes  2.02 Gbits/sec
    [  4]   7.00-8.00   sec   239 MBytes  2.01 Gbits/sec
    
    With the reverted patch applied, the SCTP/IPv4 performance is back
    to normal on latest upstream for IPv4 and IPv6 and has same throughput
    as 3.4.2 test kernel, steady and interval reports are smooth again.
    
    Fixes: ef2820a735f7 ("net: sctp: Fix a_rwnd/rwnd management to reflect real state of the receiver's buffer")
    Reported-by: Peter Butler <pbutler@sonusnet.com>
    Reported-by: Dongsheng Song <dongsheng.song@gmail.com>
    Reported-by: Fengguang Wu <fengguang.wu@intel.com>
    Tested-by: Peter Butler <pbutler@sonusnet.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Matija Glavinic Pecotic <matija.glavinic-pecotic.ext@nsn.com>
    Cc: Alexander Sverdlin <alexander.sverdlin@nsn.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 37612b6148d8932256188aeb98a412a82e27d078
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ec494e10043dc71f30b9f32a9db15a6c2a9ae051
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    [ Upstream commit c485658bae87faccd7aed540fd2ca3ab37992310 ]
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 52c35befb69b005c3fc5afdaae3a5717ad013411
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 8 17:26:13 2014 +0200

    net: sctp: wake up all assocs if sndbuf policy is per socket
    
    SCTP charges chunks for wmem accounting via skb->truesize in
    sctp_set_owner_w(), and sctp_wfree() respectively as the
    reverse operation. If a sender runs out of wmem, it needs to
    wait via sctp_wait_for_sndbuf(), and gets woken up by a call
    to __sctp_write_space() mostly via sctp_wfree().
    
    __sctp_write_space() is being called per association. Although
    we assign sk->sk_write_space() to sctp_write_space(), which
    is then being done per socket, it is only used if send space
    is increased per socket option (SO_SNDBUF), as SOCK_USE_WRITE_QUEUE
    is set and therefore not invoked in sock_wfree().
    
    Commit 4c3a5bdae293 ("sctp: Don't charge for data in sndbuf
    again when transmitting packet") fixed an issue where in case
    sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again
    unless it is interrupted by a signal. However, a still
    remaining issue is that if net.sctp.sndbuf_policy=0, that is
    accounting per socket, and one-to-many sockets are in use,
    the reclaimed write space from sctp_wfree() is 'unfairly'
    handed back on the server to the association that is the lucky
    one to be woken up again via __sctp_write_space(), while
    the remaining associations are never be woken up again
    (unless by a signal).
    
    The effect disappears with net.sctp.sndbuf_policy=1, that
    is wmem accounting per association, as it guarantees a fair
    share of wmem among associations.
    
    Therefore, if we have reclaimed memory in case of per socket
    accounting, wake all related associations to a socket in a
    fair manner, that is, traverse the socket association list
    starting from the current neighbour of the association and
    issue a __sctp_write_space() to everyone until we end up
    waking ourselves. This guarantees that no association is
    preferred over another and even if more associations are
    taken into the one-to-many session, all receivers will get
    messages from the server and are not stalled forever on
    high load. This setting still leaves the advantage of per
    socket accounting in touch as an association can still use
    up global limits if unused by others.
    
    Fixes: 4eb701dfc618 ("[SCTP] Fix SCTP sendbuffer accouting.")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Thomas Graf <tgraf@suug.ch>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Vlad Yasevich <vyasevic@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c7160985f53fe845eb5e882a492196a844962650
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ffbd2b62c349e1541513883b25bcecc2fa238e60
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 265a589f4b621022b591977c4a16c8173be7a11b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 892b46a6a68fa1ae1f85f3c2ba475382b7b6acc5
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 18684dfb8483c9bbd3cc4ecefc1d9784d8158608
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 53611c0ce9f6e2fa2e31f9ab4ad8c08c512085ba
Merge: ac9dc67b730f ecab67015ef6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Mar 13 20:38:36 2014 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "I know this is a bit more than you want to see, and I've told the
      wireless folks under no uncertain terms that they must severely scale
      back the extent of the fixes they are submitting this late in the
      game.
    
      Anyways:
    
       1) vmxnet3's netpoll doesn't perform the equivalent of an ISR, which
          is the correct implementation, like it should.  Instead it does
          something like a NAPI poll operation.  This leads to crashes.
    
          From Neil Horman and Arnd Bergmann.
    
       2) Segmentation of SKBs requires proper socket orphaning of the
          fragments, otherwise we might access stale state released by the
          release callbacks.
    
          This is a 5 patch fix, but the initial patches are giving
          variables and such significantly clearer names such that the
          actual fix itself at the end looks trivial.
    
          From Michael S.  Tsirkin.
    
       3) TCP control block release can deadlock if invoked from a timer on
          an already "owned" socket.  Fix from Eric Dumazet.
    
       4) In the bridge multicast code, we must validate that the
          destination address of general queries is the link local all-nodes
          multicast address.  From Linus Lssing.
    
       5) The x86 BPF JIT support for negative offsets puts the parameter
          for the helper function call in the wrong register.  Fix from
          Alexei Starovoitov.
    
       6) The descriptor type used for RTL_GIGA_MAC_VER_17 chips in the
          r8169 driver is incorrect.  Fix from Hayes Wang.
    
       7) The xen-netback driver tests skb_shinfo(skb)->gso_type bits to see
          if a packet is a GSO frame, but that's not the correct test.  It
          should use skb_is_gso(skb) instead.  Fix from Wei Liu.
    
       8) Negative msg->msg_namelen values should generate an error, from
          Matthew Leach.
    
       9) at86rf230 can deadlock because it takes the same lock from it's
          ISR and it's hard_start_xmit method, without disabling interrupts
          in the latter.  Fix from Alexander Aring.
    
      10) The FEC driver's restart doesn't perform operations in the correct
          order, so promiscuous settings can get lost.  Fix from Stefan
          Wahren.
    
      11) Fix SKB leak in SCTP cookie handling, from Daniel Borkmann.
    
      12) Reference count and memory leak fixes in TIPC from Ying Xue and
          Erik Hugne.
    
      13) Forced eviction in inet_frag_evictor() must strictly make sure all
          frags are deleted, otherwise module unload (f.e.  6lowpan) can
          crash.  Fix from Florian Westphal.
    
      14) Remove assumptions in AF_UNIX's use of csum_partial() (which it
          uses as a hash function), which breaks on PowerPC.  From Anton
          Blanchard.
    
          The main gist of the issue is that csum_partial() is defined only
          as a value that, once folded (f.e.  via csum_fold()) produces a
          correct 16-bit checksum.  It is legitimate, therefore, for
          csum_partial() to produce two different 32-bit values over the
          same data if their respective alignments are different.
    
      15) Fix endiannes bug in MAC address handling of ibmveth driver, also
          from Anton Blanchard.
    
      16) Error checks for ipv6 exthdrs offload registration are reversed,
          from Anton Nayshtut.
    
      17) Externally triggered ipv6 addrconf routes should count against the
          garbage collection threshold.  Fix from Sabrina Dubroca.
    
      18) The PCI shutdown handler added to the bnx2 driver can wedge the
          chip if it was not brought up earlier already, which in particular
          causes the firmware to shut down the PHY.  Fix from Michael Chan.
    
      19) Adjust the sanity WARN_ON_ONCE() in qdisc_list_add() because as
          currently coded it can and does trigger in legitimate situations.
          From Eric Dumazet.
    
      20) BNA driver fails to build on ARM because of a too large udelay()
          call, fix from Ben Hutchings.
    
      21) Fair-Queue qdisc holds locks during GFP_KERNEL allocations, fix
          from Eric Dumazet.
    
      22) The vlan passthrough ops added in the previous release causes a
          regression in source MAC address setting of outgoing headers in
          some circumstances.  Fix from Peter Bostrm"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (70 commits)
      ipv6: Avoid unnecessary temporary addresses being generated
      eth: fec: Fix lost promiscuous mode after reconnecting cable
      bonding: set correct vlan id for alb xmit path
      at86rf230: fix lockdep splats
      net/mlx4_en: Deregister multicast vxlan steering rules when going down
      vmxnet3: fix building without CONFIG_PCI_MSI
      MAINTAINERS: add networking selftests to NETWORKING
      net: socket: error on a negative msg_namelen
      MAINTAINERS: Add tools/net to NETWORKING [GENERAL]
      packet: doc: Spelling s/than/that/
      net/mlx4_core: Load the IB driver when the device supports IBoE
      net/mlx4_en: Handle vxlan steering rules for mac address changes
      net/mlx4_core: Fix wrong dump of the vxlan offloads device capability
      xen-netback: use skb_is_gso in xenvif_start_xmit
      r8169: fix the incorrect tx descriptor version
      tools/net/Makefile: Define PACKAGE to fix build problems
      x86: bpf_jit: support negative offsets
      bridge: multicast: enable snooping on general queries only
      bridge: multicast: add sanity check for general query destination
      tcp: tcp_release_cb() should release socket ownership
      ...

commit 00c53b02cb01976b35d37670a4b5c5d7a6ad3c62
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    [ Upstream commit ec0223ec48a90cb605244b45f7c62de856403729 ]
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit 433131ba03c511a84e1fda5669c70cf8b44702e1
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Mar 13 14:45:26 2014 +0100

    net: sctp: remove NULL check in sctp_assoc_update_retran_path
    
    This is basically just to let Coverity et al shut up. Remove an
    unneeded NULL check in sctp_assoc_update_retran_path().
    
    It is safe to remove it, because in sctp_assoc_update_retran_path()
    we iterate over the list of transports, our own transport which is
    asoc->peer.retran_path included. In the iteration, we skip the
    list head element and transports in state SCTP_UNCONFIRMED.
    
    Such transports came from peer addresses received in INIT/INIT-ACK
    address parameters. They are not yet confirmed by a heartbeat and
    not available for data transfers.
    
    We know however that in the list of transports, even if it contains
    such elements, it at least contains our asoc->peer.retran_path as
    well, so even if next to that element, we only encounter
    SCTP_UNCONFIRMED transports, we are always going to fall back to
    asoc->peer.retran_path through sctp_trans_elect_best(), as that is
    for sure not SCTP_UNCONFIRMED as per fbdf501c9374 ("sctp: Do no
    select unconfirmed transports for retransmissions").
    
    Whenever we call sctp_trans_elect_best() it will give us a non-NULL
    element back, and therefore when we break out of the loop, we are
    guaranteed to have a non-NULL transport pointer, and can remove
    the NULL check.
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Reported-by: Dave Jones <davej@redhat.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 19e48381ab5da05c5fb398336a90a52a2b623cdc
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 270204513fd9ada5a269e7403c9863591e4209ee
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b306713b6374b184026f3a8a176ac11ee855510a
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c485658bae87faccd7aed540fd2ca3ab37992310
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Mar 4 16:35:51 2014 +0100

    net: sctp: fix skb leakage in COOKIE ECHO path of chunk->auth_chunk
    
    While working on ec0223ec48a9 ("net: sctp: fix sctp_sf_do_5_1D_ce to
    verify if we/peer is AUTH capable"), we noticed that there's a skb
    memory leakage in the error path.
    
    Running the same reproducer as in ec0223ec48a9 and by unconditionally
    jumping to the error label (to simulate an error condition) in
    sctp_sf_do_5_1D_ce() receive path lets kmemleak detector bark about
    the unfreed chunk->auth_chunk skb clone:
    
    Unreferenced object 0xffff8800b8f3a000 (size 256):
      comm "softirq", pid 0, jiffies 4294769856 (age 110.757s)
      hex dump (first 32 bytes):
        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
        89 ab 75 5e d4 01 58 13 00 00 00 00 00 00 00 00  ..u^..X.........
      backtrace:
        [<ffffffff816660be>] kmemleak_alloc+0x4e/0xb0
        [<ffffffff8119f328>] kmem_cache_alloc+0xc8/0x210
        [<ffffffff81566929>] skb_clone+0x49/0xb0
        [<ffffffffa0467459>] sctp_endpoint_bh_rcv+0x1d9/0x230 [sctp]
        [<ffffffffa046fdbc>] sctp_inq_push+0x4c/0x70 [sctp]
        [<ffffffffa047e8de>] sctp_rcv+0x82e/0x9a0 [sctp]
        [<ffffffff815abd38>] ip_local_deliver_finish+0xa8/0x210
        [<ffffffff815a64af>] nf_reinject+0xbf/0x180
        [<ffffffffa04b4762>] nfqnl_recv_verdict+0x1d2/0x2b0 [nfnetlink_queue]
        [<ffffffffa04aa40b>] nfnetlink_rcv_msg+0x14b/0x250 [nfnetlink]
        [<ffffffff815a3269>] netlink_rcv_skb+0xa9/0xc0
        [<ffffffffa04aa7cf>] nfnetlink_rcv+0x23f/0x408 [nfnetlink]
        [<ffffffff815a2bd8>] netlink_unicast+0x168/0x250
        [<ffffffff815a2fa1>] netlink_sendmsg+0x2e1/0x3f0
        [<ffffffff8155cc6b>] sock_sendmsg+0x8b/0xc0
        [<ffffffff8155d449>] ___sys_sendmsg+0x369/0x380
    
    What happens is that commit bbd0d59809f9 clones the skb containing
    the AUTH chunk in sctp_endpoint_bh_rcv() when having the edge case
    that an endpoint requires COOKIE-ECHO chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    When we enter sctp_sf_do_5_1D_ce() and before we actually get to
    the point where we process (and subsequently free) a non-NULL
    chunk->auth_chunk, we could hit the "goto nomem_init" path from
    an error condition and thus leave the cloned skb around w/o
    freeing it.
    
    The fix is to centrally free such clones in sctp_chunk_destroy()
    handler that is invoked from sctp_chunk_free() after all refs have
    dropped; and also move both kfree_skb(chunk->auth_chunk) there,
    so that chunk->auth_chunk is either NULL (since sctp_chunkify()
    allocs new chunks through kmem_cache_zalloc()) or non-NULL with
    a valid skb pointer. chunk->skb and chunk->auth_chunk are the
    only skbs in the sctp_chunk structure that need to be handeled.
    
    While at it, we should use consume_skb() for both. It is the same
    as dev_kfree_skb() but more appropriately named as we are not
    a device but a protocol. Also, this effectively replaces the
    kfree_skb() from both invocations into consume_skb(). Functions
    are the same only that kfree_skb() assumes that the frame was
    being dropped after a failure (e.g. for tools like drop monitor),
    usage of consume_skb() seems more appropriate in function
    sctp_chunk_destroy() though.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ec0223ec48a90cb605244b45f7c62de856403729
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Mar 3 17:23:04 2014 +0100

    net: sctp: fix sctp_sf_do_5_1D_ce to verify if we/peer is AUTH capable
    
    RFC4895 introduced AUTH chunks for SCTP; during the SCTP
    handshake RANDOM; CHUNKS; HMAC-ALGO are negotiated (CHUNKS
    being optional though):
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      -------------------- COOKIE-ECHO -------------------->
      <-------------------- COOKIE-ACK ---------------------
    
    A special case is when an endpoint requires COOKIE-ECHO
    chunks to be authenticated:
    
      ---------- INIT[RANDOM; CHUNKS; HMAC-ALGO] ---------->
      <------- INIT-ACK[RANDOM; CHUNKS; HMAC-ALGO] ---------
      ------------------ AUTH; COOKIE-ECHO ---------------->
      <-------------------- COOKIE-ACK ---------------------
    
    RFC4895, section 6.3. Receiving Authenticated Chunks says:
    
      The receiver MUST use the HMAC algorithm indicated in
      the HMAC Identifier field. If this algorithm was not
      specified by the receiver in the HMAC-ALGO parameter in
      the INIT or INIT-ACK chunk during association setup, the
      AUTH chunk and all the chunks after it MUST be discarded
      and an ERROR chunk SHOULD be sent with the error cause
      defined in Section 4.1. [...] If no endpoint pair shared
      key has been configured for that Shared Key Identifier,
      all authenticated chunks MUST be silently discarded. [...]
    
      When an endpoint requires COOKIE-ECHO chunks to be
      authenticated, some special procedures have to be followed
      because the reception of a COOKIE-ECHO chunk might result
      in the creation of an SCTP association. If a packet arrives
      containing an AUTH chunk as a first chunk, a COOKIE-ECHO
      chunk as the second chunk, and possibly more chunks after
      them, and the receiver does not have an STCB for that
      packet, then authentication is based on the contents of
      the COOKIE-ECHO chunk. In this situation, the receiver MUST
      authenticate the chunks in the packet by using the RANDOM
      parameters, CHUNKS parameters and HMAC_ALGO parameters
      obtained from the COOKIE-ECHO chunk, and possibly a local
      shared secret as inputs to the authentication procedure
      specified in Section 6.3. If authentication fails, then
      the packet is discarded. If the authentication is successful,
      the COOKIE-ECHO and all the chunks after the COOKIE-ECHO
      MUST be processed. If the receiver has an STCB, it MUST
      process the AUTH chunk as described above using the STCB
      from the existing association to authenticate the
      COOKIE-ECHO chunk and all the chunks after it. [...]
    
    Commit bbd0d59809f9 introduced the possibility to receive
    and verification of AUTH chunk, including the edge case for
    authenticated COOKIE-ECHO. On reception of COOKIE-ECHO,
    the function sctp_sf_do_5_1D_ce() handles processing,
    unpacks and creates a new association if it passed sanity
    checks and also tests for authentication chunks being
    present. After a new association has been processed, it
    invokes sctp_process_init() on the new association and
    walks through the parameter list it received from the INIT
    chunk. It checks SCTP_PARAM_RANDOM, SCTP_PARAM_HMAC_ALGO
    and SCTP_PARAM_CHUNKS, and copies them into asoc->peer
    meta data (peer_random, peer_hmacs, peer_chunks) in case
    sysctl -w net.sctp.auth_enable=1 is set. If in INIT's
    SCTP_PARAM_SUPPORTED_EXT parameter SCTP_CID_AUTH is set,
    peer_random != NULL and peer_hmacs != NULL the peer is to be
    assumed asoc->peer.auth_capable=1, in any other case
    asoc->peer.auth_capable=0.
    
    Now, if in sctp_sf_do_5_1D_ce() chunk->auth_chunk is
    available, we set up a fake auth chunk and pass that on to
    sctp_sf_authenticate(), which at latest in
    sctp_auth_calculate_hmac() reliably dereferences a NULL pointer
    at position 0..0008 when setting up the crypto key in
    crypto_hash_setkey() by using asoc->asoc_shared_key that is
    NULL as condition key_id == asoc->active_key_id is true if
    the AUTH chunk was injected correctly from remote. This
    happens no matter what net.sctp.auth_enable sysctl says.
    
    The fix is to check for net->sctp.auth_enable and for
    asoc->peer.auth_capable before doing any operations like
    sctp_sf_authenticate() as no key is activated in
    sctp_auth_asoc_init_active_key() for each case.
    
    Now as RFC4895 section 6.3 states that if the used HMAC-ALGO
    passed from the INIT chunk was not used in the AUTH chunk, we
    SHOULD send an error; however in this case it would be better
    to just silently discard such a maliciously prepared handshake
    as we didn't even receive a parameter at all. Also, as our
    endpoint has no shared key configured, section 6.3 says that
    MUST silently discard, which we are doing from now onwards.
    
    Before calling sctp_sf_pdiscard(), we need not only to free
    the association, but also the chunk->auth_chunk skb, as
    commit bbd0d59809f9 created a skb clone in that case.
    
    I have tested this locally by using netfilter's nfqueue and
    re-injecting packets into the local stack after maliciously
    modifying the INIT chunk (removing RANDOM; HMAC-ALGO param)
    and the SCTP packet containing the COOKIE_ECHO (injecting
    AUTH chunk before COOKIE_ECHO). Fixed with this patch applied.
    
    Fixes: bbd0d59809f9 ("[SCTP]: Implement the receive and verification of AUTH chunk")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Vlad Yasevich <yasevich@gmail.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 515266decdb0d4b868b0dec7a70d37af48918b25
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    [ Upstream commit ffd5939381c609056b33b7585fb05a77b4c695f3 ]
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>

commit b17c706987fa6f28bdc1771c8266e7a69e22adcb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Feb 22 14:01:53 2014 +0100

    loopback: sctp: add NETIF_F_SCTP_CSUM to device features
    
    Drivers are allowed to set NETIF_F_SCTP_CSUM if they have
    hardware crc32c checksumming support for the SCTP protocol.
    Currently, NETIF_F_SCTP_CSUM flag is available in igb,
    ixgbe, i40e/i40evf drivers and for vlan devices.
    
    If we don't have NETIF_F_SCTP_CSUM then crc32c is done
    through CPU instructions, invoked from crypto layer, or
    if not available as slow-path fallback in software.
    
    Currently, loopback device propagates checksum offloading
    feature flags in dev->features, but is missing SCTP checksum
    offloading. Therefore, account for NETIF_F_SCTP_CSUM as
    well.
    
    Before patch:
    
    ./netperf_sctp -H 192.168.0.100 -t SCTP_STREAM_MANY
    SCTP 1-TO-MANY STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.100 () port 0 AF_INET
    Recv   Send    Send
    Socket Socket  Message  Elapsed
    Size   Size    Size     Time     Throughput
    bytes  bytes   bytes    secs.    10^6bits/sec
    
    4194304 4194304   4096    10.00    4683.50
    
    After patch:
    
    ./netperf_sctp -H 192.168.0.100 -t SCTP_STREAM_MANY
    SCTP 1-TO-MANY STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.100 () port 0 AF_INET
    Recv   Send    Send
    Socket Socket  Message  Elapsed
    Size   Size    Size     Time     Throughput
    bytes  bytes   bytes    secs.    10^6bits/sec
    
    4194304 4194304   4096    10.00    15348.26
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4c47af4d5eb2c2f78f886079a3920a7078a6f0a0
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Feb 20 20:51:06 2014 +0100

    net: sctp: rework multihoming retransmission path selection to rfc4960
    
    Problem statement: 1) both paths (primary path1 and alternate
    path2) are up after the association has been established i.e.,
    HB packets are normally exchanged, 2) path2 gets inactive after
    path_max_retrans * max_rto timed out (i.e. path2 is down completely),
    3) now, if a transmission times out on the only surviving/active
    path1 (any ~1sec network service impact could cause this like
    a channel bonding failover), then the retransmitted packets are
    sent over the inactive path2; this happens with partial failover
    and without it.
    
    Besides not being optimal in the above scenario, a small failure
    or timeout in the only existing path has the potential to cause
    long delays in the retransmission (depending on RTO_MAX) until
    the still active path is reselected. Further, when the T3-timeout
    occurs, we have active_patch == retrans_path, and even though the
    timeout occurred on the initial transmission of data, not a
    retransmit, we end up updating retransmit path.
    
    RFC4960, section 6.4. "Multi-Homed SCTP Endpoints" states under
    6.4.1. "Failover from an Inactive Destination Address" the
    following:
    
      Some of the transport addresses of a multi-homed SCTP endpoint
      may become inactive due to either the occurrence of certain
      error conditions (see Section 8.2) or adjustments from the
      SCTP user.
    
      When there is outbound data to send and the primary path
      becomes inactive (e.g., due to failures), or where the SCTP
      user explicitly requests to send data to an inactive
      destination transport address, before reporting an error to
      its ULP, the SCTP endpoint should try to send the data to an
      alternate __active__ destination transport address if one
      exists.
    
      When retransmitting data that timed out, if the endpoint is
      multihomed, it should consider each source-destination address
      pair in its retransmission selection policy. When retransmitting
      timed-out data, the endpoint should attempt to pick the most
      divergent source-destination pair from the original
      source-destination pair to which the packet was transmitted.
    
      Note: Rules for picking the most divergent source-destination
      pair are an implementation decision and are not specified
      within this document.
    
    So, we should first reconsider to take the current active
    retransmission transport if we cannot find an alternative
    active one. If all of that fails, we can still round robin
    through unkown, partial failover, and inactive ones in the
    hope to find something still suitable.
    
    Commit 4141ddc02a92 ("sctp: retran_path update bug fix") broke
    that behaviour by selecting the next inactive transport when
    no other active transport was found besides the current assoc's
    peer.retran_path. Before commit 4141ddc02a92, we would have
    traversed through the list until we reach our peer.retran_path
    again, and in case that is still in state SCTP_ACTIVE, we would
    take it and return. Only if that is not the case either, we
    take the next inactive transport.
    
    Besides all that, another issue is that transports in state
    SCTP_UNKNOWN could be preferred over transports in state
    SCTP_ACTIVE in case a SCTP_ACTIVE transport appears after
    SCTP_UNKNOWN in the transport list yielding a weaker transport
    state to be used in retransmission.
    
    This patch mostly reverts 4141ddc02a92, but also rewrites
    this function to introduce more clarity and strictness into
    the code. A strict priority of transport states is enforced
    in this patch, hence selection is active > unkown > partial
    failover > inactive.
    
    Fixes: 4141ddc02a92 ("sctp: retran_path update bug fix")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <yasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ffd5939381c609056b33b7585fb05a77b4c695f3
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Feb 17 12:11:11 2014 +0100

    net: sctp: fix sctp_connectx abi for ia32 emulation/compat mode
    
    SCTP's sctp_connectx() abi breaks for 64bit kernels compiled with 32bit
    emulation (e.g. ia32 emulation or x86_x32). Due to internal usage of
    'struct sctp_getaddrs_old' which includes a struct sockaddr pointer,
    sizeof(param) check will always fail in kernel as the structure in
    64bit kernel space is 4bytes larger than for user binaries compiled
    in 32bit mode. Thus, applications making use of sctp_connectx() won't
    be able to run under such circumstances.
    
    Introduce a compat interface in the kernel to deal with such
    situations by using a 'struct compat_sctp_getaddrs_old' structure
    where user data is copied into it, and then sucessively transformed
    into a 'struct sctp_getaddrs_old' structure with the help of
    compat_ptr(). That fixes sctp_connectx() abi without any changes
    needed in user space, and lets the SCTP test suite pass when compiled
    in 32bit and run on 64bit kernels.
    
    Fixes: f9c67811ebc0 ("sctp: Fix regression introduced by new sctp_connectx api")
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 16e5a2ed5920f511666a8714f43987bb0e2ad751
Merge: 6792dfe383dd 20e7c4e80dcd
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Feb 11 12:05:55 2014 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking updates from David Miller:
    
     1) Fix flexcan build on big endian, from Arnd Bergmann
    
     2) Correctly attach cpsw to GPIO bitbang MDIO drive, from Stefan Roese
    
     3) udp_add_offload has to use GFP_ATOMIC since it can be invoked from
        non-sleepable contexts.  From Or Gerlitz
    
     4) vxlan_gro_receive() does not iterate over all possible flows
        properly, fix also from Or Gerlitz
    
     5) CAN core doesn't use a proper SKB destructor when it hooks up
        sockets to SKBs.  Fix from Oliver Hartkopp
    
     6) ip_tunnel_xmit() can use an uninitialized route pointer, fix from
        Eric Dumazet
    
     7) Fix address family assignment in IPVS, from Michal Kubecek
    
     8) Fix ath9k build on ARM, from Sujith Manoharan
    
     9) Make sure fail_over_mac only applies for the correct bonding modes,
        from Ding Tianhong
    
    10) The udp offload code doesn't use RCU correctly, from Shlomo Pongratz
    
    11) Handle gigabit features properly in generic PHY code, from Florian
        Fainelli
    
    12) Don't blindly invoke link operations in
        rtnl_link_get_slave_info_data_size, they are optional.  Fix from
        Fernando Luis Vazquez Cao
    
    13) Add USB IDs for Netgear Aircard 340U, from Bjrn Mork
    
    14) Handle netlink packet padding properly in openvswitch, from Thomas
        Graf
    
    15) Fix oops when deleting chains in nf_tables, from Patrick McHardy
    
    16) Fix RX stalls in xen-netback driver, from Zoltan Kiss
    
    17) Fix deadlock in mac80211 stack, from Emmanuel Grumbach
    
    18) inet_nlmsg_size() forgets to consider ifa_cacheinfo, fix from Geert
        Uytterhoeven
    
    19) tg3_change_mtu() can deadlock, fix from Nithin Sujir
    
    20) Fix regression in setting SCTP local source addresses on accepted
        sockets, caused by some generic ipv6 socket changes.  Fix from
        Matija Glavinic Pecotic
    
    21) IPPROTO_* must be pure defines, otherwise module aliases don't get
        constructed properly.  Fix from Jan Moskyto
    
    22) IPV6 netconsole setup doesn't work properly unless an explicit
        source address is specified, fix from Sabrina Dubroca
    
    23) Use __GFP_NORETRY for high order skb page allocations in
        sock_alloc_send_pskb and skb_page_frag_refill.  From Eric Dumazet
    
    24) Fix a regression added in netconsole over bridging, from Cong Wang
    
    25) TCP uses an artificial offset of 1ms for SRTT, but this doesn't jive
        well with TCP pacing which needs the SRTT to be accurate.  Fix from
        Eric Dumazet
    
    26) Several cases of missing header file includes from Rashika Kheria
    
    27) Add ZTE MF667 device ID to qmi_wwan driver, from Raymond Wanyoike
    
    28) TCP Small Queues doesn't handle nonagle properly in some corner
        cases, fix from Eric Dumazet
    
    29) Remove extraneous read_unlock in bond_enslave, whoops.  From Ding
        Tianhong
    
    30) Fix 9p trans_virtio handling of vmalloc buffers, from Richard Yao
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (136 commits)
      6lowpan: fix lockdep splats
      alx: add missing stats_lock spinlock init
      9p/trans_virtio.c: Fix broken zero-copy on vmalloc() buffers
      bonding: remove unwanted bond lock for enslave processing
      USB2NET : SR9800 : One chip USB2.0 USB2NET SR9800 Device Driver Support
      tcp: tsq: fix nonagle handling
      bridge: Prevent possible race condition in br_fdb_change_mac_address
      bridge: Properly check if local fdb entry can be deleted when deleting vlan
      bridge: Properly check if local fdb entry can be deleted in br_fdb_delete_by_port
      bridge: Properly check if local fdb entry can be deleted in br_fdb_change_mac_address
      bridge: Fix the way to check if a local fdb entry can be deleted
      bridge: Change local fdb entries whenever mac address of bridge device changes
      bridge: Fix the way to find old local fdb entries in br_fdb_change_mac_address
      bridge: Fix the way to insert new local fdb entries in br_fdb_changeaddr
      bridge: Fix the way to find old local fdb entries in br_fdb_changeaddr
      tcp: correct code comment stating 3 min timeout for FIN_WAIT2, we only do 1 min
      net: vxge: Remove unused device pointer
      net: qmi_wwan: add ZTE MF667
      3c59x: Remove unused pointer in vortex_eisa_cleanup()
      net: fix 'ip rule' iif/oif device rename
      ...

commit eb8896864a982080bb25627bdabcfce8561adce4
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    commit be364c8c0f17a3dd42707b5a090b318028538eb9 upstream.
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

commit ff0bc6cc7f20cfaf9aed4055773158f3f295b28b
Merge: 2182c815f3d4 ece35848c184
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jan 21 17:42:55 2014 -0800

    Merge tag 'dlm-3.14' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm
    
    Pull dlm update from David Teigland:
     "A single change to speed up recovery times when using SCTP
      connections"
    
    * tag 'dlm-3.14' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm:
      dlm: set zero linger time on sctp socket

commit 31956660693f130ff1de1040725e0636adb9261f
Author: Jean Sacren <sakiwit@gmail.com>
Date:   Sun Jan 19 15:24:53 2014 -0700

    sctp: fix missing SCTP mailing list address update
    
    The commit 91705c61b5202 ("net: sctp: trivial: update mailing list
    address") updated almost all the SCTP mailing list address from
    
            "lksctp-developers@lists.sourceforge.net"
    to
            "linux-sctp@vger.kernel.org"
    
    except for the one in include/linux/sctp.h file. Fix this way trivial
    one so that all is updated.
    
    Signed-off-by: Jean Sacren <sakiwit@gmail.com>
    Cc: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8ed1dc44d3e9e8387a104b1ae8f92e9a3fbf1b1e
Author: Hannes Frederic Sowa <hannes@stressinduktion.org>
Date:   Thu Jan 9 10:01:17 2014 +0100

    ipv4: introduce hardened ip_no_pmtu_disc mode
    
    This new ip_no_pmtu_disc mode only allowes fragmentation-needed errors
    to be honored by protocols which do more stringent validation on the
    ICMP's packet payload. This knob is useful for people who e.g. want to
    run an unmodified DNS server in a namespace where they need to use pmtu
    for TCP connections (as they are used for zone transfers or fallback
    for requests) but don't want to use possibly spoofed UDP pmtu information.
    
    Currently the whitelisted protocols are TCP, SCTP and DCCP as they check
    if the returned packet is in the window or if the association is valid.
    
    Cc: Eric Dumazet <eric.dumazet@gmail.com>
    Cc: David Miller <davem@davemloft.net>
    Cc: John Heffner <johnwheffner@gmail.com>
    Suggested-by: Florian Weimer <fweimer@redhat.com>
    Signed-off-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 619a60ee04be33238721a15c1f9704a2a515a33e
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Thu Jan 2 14:39:44 2014 -0500

    sctp: Remove outqueue empty state
    
    The SCTP outqueue structure maintains a data chunks
    that are pending transmission, the list of chunks that
    are pending a retransmission and a length of data in
    flight.  It also tries to keep the emtpy state so that
    it can performe shutdown sequence or notify user.
    
    The problem is that the empy state is inconsistently
    tracked.  It is possible to completely drain the queue
    without sending anything when using PR-SCTP.  In this
    case, the empty state will not be correctly state as
    report by Jamal Hadi Salim <jhs@mojatatu.com>.  This
    can cause an association to be perminantly stuck in the
    SHUTDOWN_PENDING state.
    
    Additionally, SCTP is incredibly inefficient when setting
    the empty state.  Even though all the data is availaible
    in the outqueue structure, we ignore it and walk a list
    of trasnports.
    
    In the end, we can completely remove the extra empty
    state and figure out if the queue is empty by looking
    at 3 things:  length of pending data, length of in-flight
    data, and exisiting of retransmit data.  All of these
    are already in the strucutre.
    
    Reported-by: Jamal Hadi Salim <jhs@mojatatu.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Tested-by: Jamal Hadi Salim <jhs@mojatatu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 89ba52bd933898e8da78d4a3469dc23cb8acbecd
Merge: c76f2a2c4c34 94f65193abbc
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Dec 31 13:59:21 2013 -0500

    Merge branch 'sctp_logspam'
    
    Neil Horman says:
    
    ====================
    sctp: Consolidate and ratelimit deprecation warnings
    
    The SCTP protocol has several deprecation warnings in its setsockopt path that
    can be triggered by unprivlidged users.  Since these are not ratelimited, we can
    spam the logs quite easily here.  Since these are all deprecation warnings, and
    that type of warning isn't uncommon in the rest of the kernel, lets make a
    common pr_warn_deprecated macro to produce somewhat generalized ratelimited
    deprecation warnings easily
    ====================
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 94f65193abbc07e4a4f3dbe3729ceb95c1493ea2
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Dec 23 08:29:43 2013 -0500

    SCTP: Reduce log spamming for sctp setsockopt
    
    During a recent discussion regarding some sctp socket options, it was noted that
    we have several points at which we issue log warnings that can be flooded at an
    unbounded rate by any user.  Fix this by converting all the pr_warns in the
    sctp_setsockopt path to be pr_warn_ratelimited.
    
    Note there are several debug level messages as well.  I'm leaving those alone,
    as, if you turn on pr_debug, you likely want lots of verbosity.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: David Miller <davem@davemloft.net>
    CC: netdev@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8d082949fefde5d6b7acedab5936d938ae5e374b
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    [ Upstream commit d2dbbba77e95dff4b4f901fee236fef6d9552072 ]
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d30a58ba2ef5092f10985d357d22acab232b6dcc
Author: Chang Xiangzhong <changxiangzhong@gmail.com>
Date:   Thu Nov 14 00:58:26 2013 +0100

    net: sctp: bug-fixing: retran_path not set properly after transports recovering (v3)
    
    When a transport recovers due to the new coming sack, SCTP should
    iterate all of its transport_list to locate the __two__ most recently used
    transport and set to active_path and retran_path respectively. The exising
    code does not find the two properly - In case of the following list:
    
    [most-recent] -> [2nd-most-recent] -> ...
    
    Both active_path and retran_path would be set to the 1st element.
    
    The bug happens when:
    1) multi-homing
    2) failure/partial_failure transport recovers
    Both active_path and retran_path would be set to the same most-recent one, in
    other words, retran_path would not take its role - an end user might not even
    notice this issue.
    
    Signed-off-by: Chang Xiangzhong <changxiangzhong@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 42a2d923cc349583ebf6fdd52a7d35e1c2f7e6bd
Merge: 5cbb3d216e20 75ecab1df14d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Nov 13 17:40:34 2013 +0900

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
    
     1) The addition of nftables.  No longer will we need protocol aware
        firewall filtering modules, it can all live in userspace.
    
        At the core of nftables is a, for lack of a better term, virtual
        machine that executes byte codes to inspect packet or metadata
        (arriving interface index, etc.) and make verdict decisions.
    
        Besides support for loading packet contents and comparing them, the
        interpreter supports lookups in various datastructures as
        fundamental operations.  For example sets are supports, and
        therefore one could create a set of whitelist IP address entries
        which have ACCEPT verdicts attached to them, and use the appropriate
        byte codes to do such lookups.
    
        Since the interpreted code is composed in userspace, userspace can
        do things like optimize things before giving it to the kernel.
    
        Another major improvement is the capability of atomically updating
        portions of the ruleset.  In the existing netfilter implementation,
        one has to update the entire rule set in order to make a change and
        this is very expensive.
    
        Userspace tools exist to create nftables rules using existing
        netfilter rule sets, but both kernel implementations will need to
        co-exist for quite some time as we transition from the old to the
        new stuff.
    
        Kudos to Patrick McHardy, Pablo Neira Ayuso, and others who have
        worked so hard on this.
    
     2) Daniel Borkmann and Hannes Frederic Sowa made several improvements
        to our pseudo-random number generator, mostly used for things like
        UDP port randomization and netfitler, amongst other things.
    
        In particular the taus88 generater is updated to taus113, and test
        cases are added.
    
     3) Support 64-bit rates in HTB and TBF schedulers, from Eric Dumazet
        and Yang Yingliang.
    
     4) Add support for new 577xx tigon3 chips to tg3 driver, from Nithin
        Sujir.
    
     5) Fix two fatal flaws in TCP dynamic right sizing, from Eric Dumazet,
        Neal Cardwell, and Yuchung Cheng.
    
     6) Allow IP_TOS and IP_TTL to be specified in sendmsg() ancillary
        control message data, much like other socket option attributes.
        From Francesco Fusco.
    
     7) Allow applications to specify a cap on the rate computed
        automatically by the kernel for pacing flows, via a new
        SO_MAX_PACING_RATE socket option.  From Eric Dumazet.
    
     8) Make the initial autotuned send buffer sizing in TCP more closely
        reflect actual needs, from Eric Dumazet.
    
     9) Currently early socket demux only happens for TCP sockets, but we
        can do it for connected UDP sockets too.  Implementation from Shawn
        Bohrer.
    
    10) Refactor inet socket demux with the goal of improving hash demux
        performance for listening sockets.  With the main goals being able
        to use RCU lookups on even request sockets, and eliminating the
        listening lock contention.  From Eric Dumazet.
    
    11) The bonding layer has many demuxes in it's fast path, and an RCU
        conversion was started back in 3.11, several changes here extend the
        RCU usage to even more locations.  From Ding Tianhong and Wang
        Yufen, based upon suggestions by Nikolay Aleksandrov and Veaceslav
        Falico.
    
    12) Allow stackability of segmentation offloads to, in particular, allow
        segmentation offloading over tunnels.  From Eric Dumazet.
    
    13) Significantly improve the handling of secret keys we input into the
        various hash functions in the inet hashtables, TCP fast open, as
        well as syncookies.  From Hannes Frederic Sowa.  The key fundamental
        operation is "net_get_random_once()" which uses static keys.
    
        Hannes even extended this to ipv4/ipv6 fragmentation handling and
        our generic flow dissector.
    
    14) The generic driver layer takes care now to set the driver data to
        NULL on device removal, so it's no longer necessary for drivers to
        explicitly set it to NULL any more.  Many drivers have been cleaned
        up in this way, from Jingoo Han.
    
    15) Add a BPF based packet scheduler classifier, from Daniel Borkmann.
    
    16) Improve CRC32 interfaces and generic SKB checksum iterators so that
        SCTP's checksumming can more cleanly be handled.  Also from Daniel
        Borkmann.
    
    17) Add a new PMTU discovery mode, IP_PMTUDISC_INTERFACE, which forces
        using the interface MTU value.  This helps avoid PMTU attacks,
        particularly on DNS servers.  From Hannes Frederic Sowa.
    
    18) Use generic XPS for transmit queue steering rather than internal
        (re-)implementation in virtio-net.  From Jason Wang.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1622 commits)
      random32: add test cases for taus113 implementation
      random32: upgrade taus88 generator to taus113 from errata paper
      random32: move rnd_state to linux/random.h
      random32: add prandom_reseed_late() and call when nonblocking pool becomes initialized
      random32: add periodic reseeding
      random32: fix off-by-one in seeding requirement
      PHY: Add RTL8201CP phy_driver to realtek
      xtsonic: add missing platform_set_drvdata() in xtsonic_probe()
      macmace: add missing platform_set_drvdata() in mace_probe()
      ethernet/arc/arc_emac: add missing platform_set_drvdata() in arc_emac_probe()
      ipv6: protect for_each_sk_fl_rcu in mem_check with rcu_read_lock_bh
      vlan: Implement vlan_dev_get_egress_qos_mask as an inline.
      ixgbe: add warning when max_vfs is out of range.
      igb: Update link modes display in ethtool
      netfilter: push reasm skb through instead of original frag skbs
      ip6_output: fragment outgoing reassembled skb properly
      MAINTAINERS: mv643xx_eth: take over maintainership from Lennart
      net_sched: tbf: support of 64bit rates
      ixgbe: deleting dfwd stations out of order can cause null ptr deref
      ixgbe: fix build err, num_rx_queues is only available with CONFIG_RPS
      ...

commit 72c39a0ade6229a938736fe1aa1d5e471fc7face
Merge: 6fcf018ae449 4542fa4727f5
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Nov 4 19:46:58 2013 -0500

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    This is another batch containing Netfilter/IPVS updates for your net-next
    tree, they are:
    
    * Six patches to make the ipt_CLUSTERIP target support netnamespace,
      from Gao feng.
    
    * Two cleanups for the nf_conntrack_acct infrastructure, introducing
      a new structure to encapsulate conntrack counters, from Holger
      Eitzenberger.
    
    * Fix missing verdict in SCTP support for IPVS, from Daniel Borkmann.
    
    * Skip checksum recalculation in SCTP support for IPVS, also from
      Daniel Borkmann.
    
    * Fix behavioural change in xt_socket after IP early demux, from
      Florian Westphal.
    
    * Fix bogus large memory allocation in the bitmap port set type in ipset,
      from Jozsef Kadlecsik.
    
    * Fix possible compilation issues in the hash netnet set type in ipset,
      also from Jozsef Kadlecsik.
    
    * Define constants to identify netlink callback data in ipset dumps,
      again from Jozsef Kadlecsik.
    
    * Use sock_gen_put() in xt_socket to replace xt_socket_put_sk,
      from Eric Dumazet.
    
    * Improvements for the SH scheduler in IPVS, from Alexander Frolkin.
    
    * Remove extra delay due to unneeded rcu barrier in IPVS net namespace
      cleanup path, from Julian Anastasov.
    
    * Save some cycles in ip6t_REJECT by skipping checksum validation in
      packets leaving from our stack, from Stanislav Fomichev.
    
    * Fix IPVS_CMD_ATTR_MAX definition in IPVS, larger that required, from
      Julian Anastasov.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ac835dd77807529d243811066812169c56f49133
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    [ Upstream commit d2dbbba77e95dff4b4f901fee236fef6d9552072 ]
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c69ee66768490b30127bc496921a3603c9366a10
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    [ Upstream commit d2dbbba77e95dff4b4f901fee236fef6d9552072 ]
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f3ce845cfe494296db847559b521706802f6eae0
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    [ Upstream commit d2dbbba77e95dff4b4f901fee236fef6d9552072 ]
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b397f99921827e114d7f5600447e172a99c50165
Merge: 296c10639a33 e6d8b64b34aa
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Nov 3 23:05:16 2013 -0500

    Merge branch 'sctp_csum'
    
    Daniel Borkmann says:
    
    ====================
    SCTP fix/updates
    
    Please see patch 5 for the main description/motivation, the rest just
    brings in the needed functionality for that. Although this is actually
    a fix, I've based it against net-next as some additional work for
    fixing it was needed.
    ====================
    
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e6d8b64b34aa8a9fe39609bc2db8a243b0331ceb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Oct 30 11:50:52 2013 +0100

    net: sctp: fix and consolidate SCTP checksumming code
    
    This fixes an outstanding bug found through IPVS, where SCTP packets
    with skb->data_len > 0 (non-linearized) and empty frag_list, but data
    accumulated in frags[] member, are forwarded with incorrect checksum
    letting SCTP initial handshake fail on some systems. Linearizing each
    SCTP skb in IPVS to prevent that would not be a good solution as
    this leads to an additional and unnecessary performance penalty on
    the load-balancer itself for no good reason (as we actually only want
    to update the checksum, and can do that in a different/better way
    presented here).
    
    The actual problem is elsewhere, namely, that SCTP's checksumming
    in sctp_compute_cksum() does not take frags[] into account like
    skb_checksum() does. So while we are fixing this up, we better reuse
    the existing code that we have anyway in __skb_checksum() and use it
    for walking through the data doing checksumming. This will not only
    fix this issue, but also consolidates some SCTP code with core
    sk_buff code, bringing it closer together and removing respectively
    avoiding reimplementation of skb_checksum() for no good reason.
    
    As crc32c() can use hardware implementation within the crypto layer,
    we leave that intact (it wraps around / falls back to e.g. slice-by-8
    algorithm in __crc32c_le() otherwise); plus use the __crc32c_le_combine()
    combinator for crc32c blocks.
    
    Also, we remove all other SCTP checksumming code, so that we only
    have to use sctp_compute_cksum() from now on; for doing that, we need
    to transform SCTP checkumming in output path slightly, and can leave
    the rest intact.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2817a336d4d533fb8b68719723cd60ea7dd7c09e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Oct 30 11:50:51 2013 +0100

    net: skb_checksum: allow custom update/combine for walking skb
    
    Currently, skb_checksum walks over 1) linearized, 2) frags[], and
    3) frag_list data and calculats the one's complement, a 32 bit
    result suitable for feeding into itself or csum_tcpudp_magic(),
    but unsuitable for SCTP as we're calculating CRC32c there.
    
    Hence, in order to not re-implement the very same function in
    SCTP (and maybe other protocols) over and over again, use an
    update() + combine() callback internally to allow for walking
    over the skb with different algorithms.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 97203abe6bc41ee020f37c902bd1a761157f22c1
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Oct 28 10:56:20 2013 +0100

    net: ipvs: sctp: do not recalc sctp csum when ports didn't change
    
    Unlike UDP or TCP, we do not take the pseudo-header into
    account in SCTP checksums. So in case port mapping is the
    very same, we do not need to recalculate the whole SCTP
    checksum in software, which is very expensive.
    
    Also, similarly as in TCP, take into account when a private
    helper mangled the packet. In that case, we also need to
    recalculate the checksum even if ports might be same.
    
    Thanks for feedback regarding skb->ip_summed checks from
    Julian Anastasov; here's a discussion on these checks for
    snat and dnat:
    
    * For snat_handler(), we can see CHECKSUM_PARTIAL from
      virtual devices, and from LOCAL_OUT, otherwise it
      should be CHECKSUM_UNNECESSARY. In general, in snat it
      is more complex. skb contains the original route and
      ip_vs_route_me_harder() can change the route after
      snat_handler. So, for locally generated replies from
      local server we can not preserve the CHECKSUM_PARTIAL
      mode. It is an chicken or egg dilemma: snat_handler
      needs the device after rerouting (to check for
      NETIF_F_SCTP_CSUM), while ip_route_me_harder() wants
      the snat_handler() to put the new saddr for proper
      rerouting.
    
    * For dnat_handler(), we should not see CHECKSUM_COMPLETE
      for SCTP, in fact the small set of drivers that support
      SCTP offloading return CHECKSUM_UNNECESSARY on correctly
      received SCTP csum. We can see CHECKSUM_PARTIAL from
      local stack or received from virtual drivers. The idea is
      that SCTP decides to avoid csum calculation if hardware
      supports offloading. IPVS can change the device after
      rerouting to real server but we can preserve the
      CHECKSUM_PARTIAL mode if the new device supports
      offloading too. This works because skb dst is changed
      before dnat_handler and we see the new device. So, checks
      in the 'if' part will decide whether it is ok to keep
      CHECKSUM_PARTIAL for the output. If the packet was with
      CHECKSUM_NONE, hence we deal with unknown checksum. As we
      recalculate the sum for IP header in all cases, it should
      be safe to use CHECKSUM_UNNECESSARY. We can forward wrong
      checksum in this case (without cp->app). In case of
      CHECKSUM_UNNECESSARY, the csum was valid on receive.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit 177c417ca4d861640b35ecf4fcd0f7563543e01f
Author: Ben Hutchings <ben@decadent.org.uk>
Date:   Sun Oct 20 17:06:39 2013 +0100

    Revert "sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()"
    
    This reverts commit de77b7955c3985ca95f64af3cb10557eb17eacee, which was
    commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec upstream.
    
    This fix was only appropriate for Linux 3.7 onward, and introduced a
    regression when applied to earlier versions.
    
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit af7e0f4a91ca9049ee9e541f8a98e762a12e9b9b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    [ Upstream commit 95ee62083cb6453e056562d91f597552021e6ae7 ]
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 836f6cb46716e36cb8d31a402c6661af5c895135
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 20:51:21 2013 +0200

    net: sctp: fix smatch warning in sctp_send_asconf_del_ip
    
    [ Upstream commit 88362ad8f9a6cea787420b57cc27ccacef000dbe ]
    
    This was originally reported in [1] and posted by Neil Horman [2], he said:
    
      Fix up a missed null pointer check in the asconf code. If we don't find
      a local address, but we pass in an address length of more than 1, we may
      dereference a NULL laddr pointer. Currently this can't happen, as the only
      users of the function pass in the value 1 as the addrcnt parameter, but
      its not hot path, and it doesn't hurt to check for NULL should that ever
      be the case.
    
    The callpath from sctp_asconf_mgmt() looks okay. But this could be triggered
    from sctp_setsockopt_bindx() call with SCTP_BINDX_REM_ADDR and addrcnt > 1
    while passing all possible addresses from the bind list to SCTP_BINDX_REM_ADDR
    so that we do *not* find a single address in the association's bind address
    list that is not in the packed array of addresses. If this happens when we
    have an established association with ASCONF-capable peers, then we could get
    a NULL pointer dereference as we only check for laddr == NULL && addrcnt == 1
    and call later sctp_make_asconf_update_ip() with NULL laddr.
    
    BUT: this actually won't happen as sctp_bindx_rem() will catch such a case
    and return with an error earlier. As this is incredably unintuitive and error
    prone, add a check to catch at least future bugs here. As Neil says, its not
    hot path. Introduced by 8a07eb0a5 ("sctp: Add ASCONF operation on the
    single-homed host").
    
     [1] http://www.spinics.net/lists/linux-sctp/msg02132.html
     [2] http://www.spinics.net/lists/linux-sctp/msg02133.html
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-By: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit fecda03493646b53f53892fa3c38c75ba9310374
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Oct 22 18:34:56 2013 +0200

    net: sctp: fix ASCONF to allow non SCTP_ADDR_SRC addresses in ipv6
    
    Commit 8a07eb0a50 ("sctp: Add ASCONF operation on the single-homed host")
    implemented possible use of IPv4 addresses with non SCTP_ADDR_SRC state
    as source address when sending ASCONF (ADD) packets, but IPv6 part for
    that was not implemented in 8a07eb0a50. Therefore, as this is not restricted
    to IPv4-only, fix this up to allow the same for IPv6 addresses in SCTP.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-by: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit db10accfd266a93149cd21cd75026aa03c635e7e
Merge: 294d31e8227c f11a5bc148a3
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 23 07:47:42 2013 +0100

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Sorry I let so much accumulate, I was in Buffalo and wanted a few
      things to cook in my tree for a while before sending to you.  Anyways,
      it's a lot of little things as usual at this stage in the game"
    
     1) Make bonding MAINTAINERS entry reflect reality, from Andy
        Gospodarek.
    
     2) Fix accidental sock_put() on timewait mini sockets, from Eric
        Dumazet.
    
     3) Fix crashes in l2tp due to mis-handling of ipv4 mapped ipv6
        addresses, from Franois CACHEREUL.
    
     4) Fix heap overflow in __audit_sockaddr(), from the eagle eyed Dan
        Carpenter.
    
     5) tcp_shifted_skb() doesn't take handle FINs properly, from Eric
        Dumazet.
    
     6) SFC driver bug fixes from Ben Hutchings.
    
     7) Fix TX packet scheduling wedge after channel change in ath9k driver,
        from Felix Fietkau.
    
     8) Fix user after free in BPF JIT code, from Alexei Starovoitov.
    
     9) Source address selection test is reversed in
        __ip_route_output_key(), fix from Jiri Benc.
    
    10) VLAN and CAN layer mis-size netlink attributes, from Marc
        Kleine-Budde.
    
    11) Fix permission checks in sysctls to use current_euid() instead of
        current_uid().  From Eric W Biederman.
    
    12) IPSEC policies can go away while a timer is still pending for them,
        add appropriate ref-counting to fix, from Steffen Klassert.
    
    13) Fix mis-programming of FDR and RMCR registers on R8A7740 sh_eth
        chips, from Nguyen Hong Ky and Simon Horman.
    
    14) MLX4 forgets to DMA unmap pages on RX, fix from Amir Vadai.
    
    15) IPV6 GRE tunnel MTU upper limit is miscalculated, from Oussama
        Ghorbel.
    
    16) Fix typo in fq_change(), we were assigning "initial quantum" to
        "quantum".  From Eric Dumazet.
    
    17) Set a more appropriate sk_pacing_rate for non-TCP sockets, otherwise
        FQ packet scheduler does not pace those flows properly.  Also from
        Eric Dumazet.
    
    18) rtlwifi miscalculates packet pointers, from Mark Cave-Ayland.
    
    19) l2tp_xmit_skb() can be called from process context, not just softirq
        context, so we must always make sure to BH disable around it.  From
        Eric Dumazet.
    
    20) On qdisc reset, we forget to purge the RB tree of SKBs in netem
        packet scheduler.  From Stephen Hemminger.
    
    21) Fix info leak in farsync WAN driver ioctl() handler, from Dan
        Carpenter and Salva Peir.
    
    22) Fix PHY reset and other issues in dm9000 driver, from Nikita
        Kiryanov and Michael Abbott.
    
    23) When hardware can do SCTP crc32 checksums, we accidently don't
        disable the csum offload when IPSEC transformations have been
        applied.  From Fan Du and Vlad Yasevich.
    
    24) Tail loss probing in TCP leaves the socket in the wrong congestion
        avoidance state.  From Yuchung Cheng.
    
    25) In CPSW driver, enable NAPI before interrupts are turned on, from
        Markus Pargmann.
    
    26) Integer underflow and dual-assignment in YAM hamradio driver, from
        Dan Carpenter.
    
    27) If we are going to mangle a packet in tcp_set_skb_tso_segs() we must
        unclone it.  This fixes various hard to track down crashes in
        drivers where the SKBs ->gso_segs was changing right from underneath
        the driver during TX queueing.  From Eric Dumazet.
    
    28) Fix the handling of VLAN IDs, and in particular the special IDs 0
        and 4095, in the bridging layer.  From Toshiaki Makita.
    
    29) Another info leak, this time in wanxl WAN driver, from Salva Peir.
    
    30) Fix race in socket credential passing, from Daniel Borkmann.
    
    31) WHen NETLABEL is disabled, we don't validate CIPSO packets properly,
        from Seif Mazareeb.
    
    32) Fix identification of fragmented frames in ipv4/ipv6 UDP
        Fragmentation Offload output paths, from Jiri Pirko.
    
    33) Virtual Function fixes in bnx2x driver from Yuval Mintz and Ariel
        Elior.
    
    34) When we removed the explicit neighbour pointer from ipv6 routes a
        slight regression was introduced for users such as IPVS, xt_TEE, and
        raw sockets.  We mix up the users requested destination address with
        the routes assigned nexthop/gateway.  From Julian Anastasov and
        Simon Horman.
    
    35) Fix stack overruns in rt6_probe(), the issue is that can end up
        doing two full packet xmit paths at the same time when emitting
        neighbour discovery messages.  From Hannes Frederic Sowa.
    
    36) davinci_emac driver doesn't handle IFF_ALLMULTI correctly, from
        Mariusz Ceier.
    
    37) Make sure to set TCP sk_pacing_rate after the first legitimate RTT
        sample, from Neal Cardwell.
    
    38) Wrong netlink attribute passed to xfrm_replay_verify_len(), from
        Steffen Klassert.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (152 commits)
      ax88179_178a: Add VID:DID for Samsung USB Ethernet Adapter
      ax88179_178a: Correct the RX error definition in RX header
      Revert "bridge: only expire the mdb entry when query is received"
      tcp: initialize passive-side sk_pacing_rate after 3WHS
      davinci_emac.c: Fix IFF_ALLMULTI setup
      mac802154: correct a typo in ieee802154_alloc_device() prototype
      ipv6: probe routes asynchronous in rt6_probe
      netfilter: nf_conntrack: fix rt6i_gateway checks for H.323 helper
      ipv6: fill rt6i_gateway with nexthop address
      ipv6: always prefer rt6i_gateway if present
      bnx2x: Set NETIF_F_HIGHDMA unconditionally
      bnx2x: Don't pretend during register dump
      bnx2x: Lock DMAE when used by statistic flow
      bnx2x: Prevent null pointer dereference on error flow
      bnx2x: Fix config when SR-IOV and iSCSI are enabled
      bnx2x: Fix Coalescing configuration
      bnx2x: Unlock VF-PF channel on MAC/VLAN config error
      bnx2x: Prevent an illegal pointer dereference during panic
      bnx2x: Fix Maximum CoS estimation for VFs
      drivers: net: cpsw: fix kernel warn during iperf test with interrupt pacing
      ...

commit 725907827a7f46dfb5df6e4f3d8f9bcbc9903877
Merge: 6f93ac740ac2 d2dbbba77e95
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Oct 17 15:25:13 2013 -0400

    Merge branch 'sctp_csum'
    
    Vlad Yasevich says:
    
    ====================
    sctp: Use software checksum under certain circumstances.
    
    There are some cards that support SCTP checksum offloading.  When using
    these cards with IPSec or forcing IP fragmentation of SCTP traffic,
    the checksum is computed incorrectly due to the fact that xfrm and IP/IPv6
    fragmentation code do not know that this is SCTP traffic and do not
    know that checksum has to be computed differently.
    
    To fix this, we let SCTP detect these conditions and perform software
    checksum calculation.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d2dbbba77e95dff4b4f901fee236fef6d9552072
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Oct 15 22:01:31 2013 -0400

    sctp: Perform software checksum if packet has to be fragmented.
    
    IP/IPv6 fragmentation knows how to compute only TCP/UDP checksum.
    This causes problems if SCTP packets has to be fragmented and
    ipsummed has been set to PARTIAL due to checksum offload support.
    This condition can happen when retransmitting after MTU discover,
    or when INIT or other control chunks are larger then MTU.
    Check for the rare fragmentation condition in SCTP and use software
    checksum calculation in this case.
    
    CC: Fan Du <fan.du@windriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6f4a38bf6dfeda68612299aaf7cb8f0e5f7e1245
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Sep 16 12:36:02 2013 +0200

    net: sctp: rfc4443: do not report ICMP redirects to user space
    
    [ Upstream commit 3f96a532113131d5a65ac9e00fc83cfa31b0295f ]
    
    Adapt the same behaviour for SCTP as present in TCP for ICMP redirect
    messages. For IPv6, RFC4443, section 2.4. says:
    
      ...
      (e) An ICMPv6 error message MUST NOT be originated as a result of
          receiving the following:
      ...
           (e.2) An ICMPv6 redirect message [IPv6-DISC].
      ...
    
    Therefore, do not report an error to user space, just invoke dst's redirect
    callback and leave, same for IPv4 as done in TCP as well. The implication
    w/o having this patch could be that the reception of such packets would
    generate a poll notification and in worst case it could even tear down the
    whole connection. Therefore, stop updating sk_err on redirects.
    
    Reported-by: Duan Jiong <duanj.fnst@cn.fujitsu.com>
    Reported-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Suggested-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dca97a6264d985986ee3a38ed01df8cfa6b40288
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    [ Upstream commit 95ee62083cb6453e056562d91f597552021e6ae7 ]
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6d88c9f48083a2c76347ca4390362f0bfb8c2bd2
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 20:51:21 2013 +0200

    net: sctp: fix smatch warning in sctp_send_asconf_del_ip
    
    [ Upstream commit 88362ad8f9a6cea787420b57cc27ccacef000dbe ]
    
    This was originally reported in [1] and posted by Neil Horman [2], he said:
    
      Fix up a missed null pointer check in the asconf code. If we don't find
      a local address, but we pass in an address length of more than 1, we may
      dereference a NULL laddr pointer. Currently this can't happen, as the only
      users of the function pass in the value 1 as the addrcnt parameter, but
      its not hot path, and it doesn't hurt to check for NULL should that ever
      be the case.
    
    The callpath from sctp_asconf_mgmt() looks okay. But this could be triggered
    from sctp_setsockopt_bindx() call with SCTP_BINDX_REM_ADDR and addrcnt > 1
    while passing all possible addresses from the bind list to SCTP_BINDX_REM_ADDR
    so that we do *not* find a single address in the association's bind address
    list that is not in the packed array of addresses. If this happens when we
    have an established association with ASCONF-capable peers, then we could get
    a NULL pointer dereference as we only check for laddr == NULL && addrcnt == 1
    and call later sctp_make_asconf_update_ip() with NULL laddr.
    
    BUT: this actually won't happen as sctp_bindx_rem() will catch such a case
    and return with an error earlier. As this is incredably unintuitive and error
    prone, add a check to catch at least future bugs here. As Neil says, its not
    hot path. Introduced by 8a07eb0a5 ("sctp: Add ASCONF operation on the
    single-homed host").
    
     [1] http://www.spinics.net/lists/linux-sctp/msg02132.html
     [2] http://www.spinics.net/lists/linux-sctp/msg02133.html
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-By: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7ee57d2c33149913e581a9408946cc0b53cf5a9d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 16:44:59 2013 +0200

    net: sctp: fix bug in sctp_poll for SOCK_SELECT_ERR_QUEUE
    
    [ Upstream commit a0fb05d1aef0f5df936f80b726d1b3bfd4275f95 ]
    
    If we do not add braces around ...
    
      mask |= POLLERR |
              sock_flag(sk, SOCK_SELECT_ERR_QUEUE) ? POLLPRI : 0;
    
    ... then this condition always evaluates to true as POLLERR is
    defined as 8 and binary or'd with whatever result comes out of
    sock_flag(). Hence instead of (X | Y) ? A : B, transform it into
    X | (Y ? A : B). Unfortunatelty, commit 8facd5fb73 ("net: fix
    smatch warnings inside datagram_poll") forgot about SCTP. :-(
    
    Introduced by 7d4c04fc170 ("net: add option to enable error queue
    packets waking select").
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Jacob Keller <jacob.e.keller@intel.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Jacob Keller <jacob.e.keller@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e4e7ba12fab4eba6eb6fe2863a6e0e91cd77c7cc
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Sep 16 12:36:02 2013 +0200

    net: sctp: rfc4443: do not report ICMP redirects to user space
    
    [ Upstream commit 3f96a532113131d5a65ac9e00fc83cfa31b0295f ]
    
    Adapt the same behaviour for SCTP as present in TCP for ICMP redirect
    messages. For IPv6, RFC4443, section 2.4. says:
    
      ...
      (e) An ICMPv6 error message MUST NOT be originated as a result of
          receiving the following:
      ...
           (e.2) An ICMPv6 redirect message [IPv6-DISC].
      ...
    
    Therefore, do not report an error to user space, just invoke dst's redirect
    callback and leave, same for IPv4 as done in TCP as well. The implication
    w/o having this patch could be that the reception of such packets would
    generate a poll notification and in worst case it could even tear down the
    whole connection. Therefore, stop updating sk_err on redirects.
    
    Reported-by: Duan Jiong <duanj.fnst@cn.fujitsu.com>
    Reported-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Suggested-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 872b11be53a4594c39262433c4176176fcb12bd2
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    [ Upstream commit 95ee62083cb6453e056562d91f597552021e6ae7 ]
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8ee62e8c9495a6d0f8d227bbe0f02e1b288bac30
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 20:51:21 2013 +0200

    net: sctp: fix smatch warning in sctp_send_asconf_del_ip
    
    [ Upstream commit 88362ad8f9a6cea787420b57cc27ccacef000dbe ]
    
    This was originally reported in [1] and posted by Neil Horman [2], he said:
    
      Fix up a missed null pointer check in the asconf code. If we don't find
      a local address, but we pass in an address length of more than 1, we may
      dereference a NULL laddr pointer. Currently this can't happen, as the only
      users of the function pass in the value 1 as the addrcnt parameter, but
      its not hot path, and it doesn't hurt to check for NULL should that ever
      be the case.
    
    The callpath from sctp_asconf_mgmt() looks okay. But this could be triggered
    from sctp_setsockopt_bindx() call with SCTP_BINDX_REM_ADDR and addrcnt > 1
    while passing all possible addresses from the bind list to SCTP_BINDX_REM_ADDR
    so that we do *not* find a single address in the association's bind address
    list that is not in the packed array of addresses. If this happens when we
    have an established association with ASCONF-capable peers, then we could get
    a NULL pointer dereference as we only check for laddr == NULL && addrcnt == 1
    and call later sctp_make_asconf_update_ip() with NULL laddr.
    
    BUT: this actually won't happen as sctp_bindx_rem() will catch such a case
    and return with an error earlier. As this is incredably unintuitive and error
    prone, add a check to catch at least future bugs here. As Neil says, its not
    hot path. Introduced by 8a07eb0a5 ("sctp: Add ASCONF operation on the
    single-homed host").
    
     [1] http://www.spinics.net/lists/linux-sctp/msg02132.html
     [2] http://www.spinics.net/lists/linux-sctp/msg02133.html
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-By: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8b1ada497191ab2be429c74817a8de63f9aa2bf6
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 16:44:59 2013 +0200

    net: sctp: fix bug in sctp_poll for SOCK_SELECT_ERR_QUEUE
    
    [ Upstream commit a0fb05d1aef0f5df936f80b726d1b3bfd4275f95 ]
    
    If we do not add braces around ...
    
      mask |= POLLERR |
              sock_flag(sk, SOCK_SELECT_ERR_QUEUE) ? POLLPRI : 0;
    
    ... then this condition always evaluates to true as POLLERR is
    defined as 8 and binary or'd with whatever result comes out of
    sock_flag(). Hence instead of (X | Y) ? A : B, transform it into
    X | (Y ? A : B). Unfortunatelty, commit 8facd5fb73 ("net: fix
    smatch warnings inside datagram_poll") forgot about SCTP. :-(
    
    Introduced by 7d4c04fc170 ("net: add option to enable error queue
    packets waking select").
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Jacob Keller <jacob.e.keller@intel.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Jacob Keller <jacob.e.keller@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9dea496eb4b44b347fcf3667e98c70784b07fceb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    [ Upstream commit 95ee62083cb6453e056562d91f597552021e6ae7 ]
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 835e0aace5b4d85b79e82b80da8da3ea14c4c419
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 20:51:21 2013 +0200

    net: sctp: fix smatch warning in sctp_send_asconf_del_ip
    
    [ Upstream commit 88362ad8f9a6cea787420b57cc27ccacef000dbe ]
    
    This was originally reported in [1] and posted by Neil Horman [2], he said:
    
      Fix up a missed null pointer check in the asconf code. If we don't find
      a local address, but we pass in an address length of more than 1, we may
      dereference a NULL laddr pointer. Currently this can't happen, as the only
      users of the function pass in the value 1 as the addrcnt parameter, but
      its not hot path, and it doesn't hurt to check for NULL should that ever
      be the case.
    
    The callpath from sctp_asconf_mgmt() looks okay. But this could be triggered
    from sctp_setsockopt_bindx() call with SCTP_BINDX_REM_ADDR and addrcnt > 1
    while passing all possible addresses from the bind list to SCTP_BINDX_REM_ADDR
    so that we do *not* find a single address in the association's bind address
    list that is not in the packed array of addresses. If this happens when we
    have an established association with ASCONF-capable peers, then we could get
    a NULL pointer dereference as we only check for laddr == NULL && addrcnt == 1
    and call later sctp_make_asconf_update_ip() with NULL laddr.
    
    BUT: this actually won't happen as sctp_bindx_rem() will catch such a case
    and return with an error earlier. As this is incredably unintuitive and error
    prone, add a check to catch at least future bugs here. As Neil says, its not
    hot path. Introduced by 8a07eb0a5 ("sctp: Add ASCONF operation on the
    single-homed host").
    
     [1] http://www.spinics.net/lists/linux-sctp/msg02132.html
     [2] http://www.spinics.net/lists/linux-sctp/msg02133.html
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-By: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 956c741a9eef6a4e7a6755062d4afc1e686a1c5d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    [ Upstream commit 95ee62083cb6453e056562d91f597552021e6ae7 ]
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1c1c7a7342cb6ef5976823616de9114554796592
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Sep 27 08:34:49 2013 -0700

    Revert "sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()"
    
    This reverts commit c2f5b7507ac5d808f29287d77ee6148358d7fbfe which is
    commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec.
    
    Michal writes:
            Mainline commit f6e80abe was introduced in v3.7-rc2 as a
            follow-up fix to commit
    
              edfee033  sctp: check src addr when processing SACK to update transport state
    
            (from v3.7-rc1) which changed the interpretation of third
            argument to sctp_cmd_process_sack() and sctp_outq_sack(). But as
            commit edfee033 has never been backported to stable branches,
            backport of commit f6e80abe actually breaks the code rather than
            fixing it.
    
    Reported-by: Michal Kubecek <mkubecek@suse.cz>
    Cc: Zijie Pan <zijie.pan@6wind.com>
    Cc: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 88d1fdb41513e68a6a11d1ee8c2d23ef9fdf63a5
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Sep 27 08:34:49 2013 -0700

    Revert "sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()"
    
    This reverts commit b23270416da409bd4e637a5acbe31a1126235fb6 which is
    commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec.
    
    Michal writes:
            Mainline commit f6e80abe was introduced in v3.7-rc2 as a
            follow-up fix to commit
    
              edfee033  sctp: check src addr when processing SACK to update transport state
    
            (from v3.7-rc1) which changed the interpretation of third
            argument to sctp_cmd_process_sack() and sctp_outq_sack(). But as
            commit edfee033 has never been backported to stable branches,
            backport of commit f6e80abe actually breaks the code rather than
            fixing it.
    
    Reported-by: Michal Kubecek <mkubecek@suse.cz>
    Cc: Zijie Pan <zijie.pan@6wind.com>
    Cc: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b75ff5e84bb6c2d43a8ec39b240c80f0543821f0
Merge: f05f8198e415 c71380ff0b19
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Sep 19 13:57:28 2013 -0500

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) If the local_df boolean is set on an SKB we have to allocate a
        unique ID even if IP_DF is set in the ipv4 headers, from Ansis
        Atteka.
    
     2) Some fixups for the new chipset support that went into the sfc
        driver, from Ben Hutchings.
    
     3) Because SCTP bypasses a good chunk of, and actually duplicates, the
        logic of the ipv6 output path, some IPSEC things don't get done
        properly.  Integrate SCTP better into the ipv6 output path so that
        these problems are fixed and such issues don't get missed in the
        future either.  From Daniel Borkmann.
    
     4) Fix skge regressions added by the DMA mapping error return checking
        added in v3.10, from Mikulas Patocka.
    
     5) Kill some more IRQF_DISABLED references, from Michael Opdenacker.
    
     6) Fix races and deadlocks in the bridging code, from Hong Zhiguo.
    
     7) Fix error handling in tun_set_iff(), in particular don't leak
        resources.  From Jason Wang.
    
     8) Prevent format-string injection into xen-netback driver, from Kees
        Cook.
    
     9) Fix regression added to netpoll ARP packet handling, in particular
        check for the right ETH_P_ARP protocol code.  From Sonic Zhang.
    
    10) Try to deal with AMD IOMMU errors when using r8169 chips, from
        Francois Romieu.
    
    11) Cure freezes due to recent changes in the rt2x00 wireless driver,
        from Stanislaw Gruszka.
    
    12) Don't do SPI transfers (which can sleep) in interrupt context in
        cw1200 driver, from Solomon Peachy.
    
    13) Fix LEDs handling bug in 5720 tg3 chips already handled for 5719.
        From Nithin Sujir.
    
    14) Make xen_netbk_count_skb_slots() count the actual number of slots
        that will be used, taking into consideration packing and other
        issues that the transmit path will run into.  From David Vrabel.
    
    15) Use the correct maximum age when calculating the bridge
        message_age_timer, from Chris Healy.
    
    16) Get rid of memory leaks in mcs7780 IRDA driver, from Alexey
        Khoroshilov.
    
    17) Netfilter conntrack extensions were converted to RCU but are not
        always freed properly using kfree_rcu().  Fix from Michal Kubecek.
    
    18) VF reset recovery not being done correctly in qlcnic driver, from
        Manish Chopra.
    
    19) Fix inverted test in ATM nicstar driver, from Andy Shevchenko.
    
    20) Missing workqueue destroy in cxgb4 error handling, from Wei Yang.
    
    21) Internal switch not initialized properly in bgmac driver, from Rafa
        Miecki.
    
    22) Netlink messages report wrong local and remote addresses in IPv6
        tunneling, from Ding Zhi.
    
    23) ICMP redirects should not generate socket errors in DCCP and SCTP.
        We're still working out how this should be handled for RAW and UDP
        sockets.  From Daniel Borkmann and Duan Jiong.
    
    24) We've had several bugs wherein the network namespace's loopback
        device gets accessed after it is free'd, NULL it out so that we can
        catch these problems more readily.  From Eric W Biederman.
    
    25) Fix regression in TCP RTO calculations, from Neal Cardwell.
    
    26) Fix too early free of xen-netback network device when VIFs still
        exist.  From Paul Durrant.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (87 commits)
      netconsole: fix a deadlock with rtnl and netconsole's mutex
      netpoll: fix NULL pointer dereference in netpoll_cleanup
      skge: fix broken driver
      ip: generate unique IP identificator if local fragmentation is allowed
      ip: use ip_hdr() in __ip_make_skb() to retrieve IP header
      xen-netback: Don't destroy the netdev until the vif is shut down
      net:dccp: do not report ICMP redirects to user space
      cnic: Fix crash in cnic_bnx2x_service_kcq()
      bnx2x, cnic, bnx2i, bnx2fc: Fix bnx2i and bnx2fc regressions.
      vxlan: Avoid creating fdb entry with NULL destination
      tcp: fix RTO calculated from cached RTT
      drivers: net: phy: cicada.c: clears warning Use #include <linux/io.h> instead of <asm/io.h>
      net loopback: Set loopback_dev to NULL when freed
      batman-adv: set the TAG flag for the vid passed to BLA
      netfilter: nfnetlink_queue: use network skb for sequence adjustment
      net: sctp: rfc4443: do not report ICMP redirects to user space
      net: usb: cdc_ether: use usb.h macros whenever possible
      net: usb: cdc_ether: fix checkpatch errors and warnings
      net: usb: cdc_ether: Use wwan interface for Telit modules
      ip6_tunnels: raddr and laddr are inverted in nl msg
      ...

commit 3f96a532113131d5a65ac9e00fc83cfa31b0295f
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Sep 16 12:36:02 2013 +0200

    net: sctp: rfc4443: do not report ICMP redirects to user space
    
    Adapt the same behaviour for SCTP as present in TCP for ICMP redirect
    messages. For IPv6, RFC4443, section 2.4. says:
    
      ...
      (e) An ICMPv6 error message MUST NOT be originated as a result of
          receiving the following:
      ...
           (e.2) An ICMPv6 redirect message [IPv6-DISC].
      ...
    
    Therefore, do not report an error to user space, just invoke dst's redirect
    callback and leave, same for IPv4 as done in TCP as well. The implication
    w/o having this patch could be that the reception of such packets would
    generate a poll notification and in worst case it could even tear down the
    whole connection. Therefore, stop updating sk_err on redirects.
    
    Reported-by: Duan Jiong <duanj.fnst@cn.fujitsu.com>
    Reported-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Suggested-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 95ee62083cb6453e056562d91f597552021e6ae7
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Sep 11 16:58:36 2013 +0200

    net: sctp: fix ipv6 ipsec encryption bug in sctp_v6_xmit
    
    Alan Chester reported an issue with IPv6 on SCTP that IPsec traffic is not
    being encrypted, whereas on IPv4 it is. Setting up an AH + ESP transport
    does not seem to have the desired effect:
    
    SCTP + IPv4:
    
      22:14:20.809645 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 116)
        192.168.0.2 > 192.168.0.5: AH(spi=0x00000042,sumlen=16,seq=0x1): ESP(spi=0x00000044,seq=0x1), length 72
      22:14:20.813270 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto AH (51), length 340)
        192.168.0.5 > 192.168.0.2: AH(spi=0x00000043,sumlen=16,seq=0x1):
    
    SCTP + IPv6:
    
      22:31:19.215029 IP6 (class 0x02, hlim 64, next-header SCTP (132) payload length: 364)
        fe80::222:15ff:fe87:7fc.3333 > fe80::92e6:baff:fe0d:5a54.36767: sctp
        1) [INIT ACK] [init tag: 747759530] [rwnd: 62464] [OS: 10] [MIS: 10]
    
    Moreover, Alan says:
    
      This problem was seen with both Racoon and Racoon2. Other people have seen
      this with OpenSwan. When IPsec is configured to encrypt all upper layer
      protocols the SCTP connection does not initialize. After using Wireshark to
      follow packets, this is because the SCTP packet leaves Box A unencrypted and
      Box B believes all upper layer protocols are to be encrypted so it drops
      this packet, causing the SCTP connection to fail to initialize. When IPsec
      is configured to encrypt just SCTP, the SCTP packets are observed unencrypted.
    
    In fact, using `socat sctp6-listen:3333 -` on one end and transferring "plaintext"
    string on the other end, results in cleartext on the wire where SCTP eventually
    does not report any errors, thus in the latter case that Alan reports, the
    non-paranoid user might think he's communicating over an encrypted transport on
    SCTP although he's not (tcpdump ... -X):
    
      ...
      0x0030: 5d70 8e1a 0003 001a 177d eb6c 0000 0000  ]p.......}.l....
      0x0040: 0000 0000 706c 6169 6e74 6578 740a 0000  ....plaintext...
    
    Only in /proc/net/xfrm_stat we can see XfrmInTmplMismatch increasing on the
    receiver side. Initial follow-up analysis from Alan's bug report was done by
    Alexey Dobriyan. Also thanks to Vlad Yasevich for feedback on this.
    
    SCTP has its own implementation of sctp_v6_xmit() not calling inet6_csk_xmit().
    This has the implication that it probably never really got updated along with
    changes in inet6_csk_xmit() and therefore does not seem to invoke xfrm handlers.
    
    SCTP's IPv4 xmit however, properly calls ip_queue_xmit() to do the work. Since
    a call to inet6_csk_xmit() would solve this problem, but result in unecessary
    route lookups, let us just use the cached flowi6 instead that we got through
    sctp_v6_get_dst(). Since all SCTP packets are being sent through sctp_packet_transmit(),
    we do the route lookup / flow caching in sctp_transport_route(), hold it in
    tp->dst and skb_dst_set() right after that. If we would alter fl6->daddr in
    sctp_v6_xmit() to np->opt->srcrt, we possibly could run into the same effect
    of not having xfrm layer pick it up, hence, use fl6_update_dst() in sctp_v6_get_dst()
    instead to get the correct source routed dst entry, which we assign to the skb.
    
    Also source address routing example from 625034113 ("sctp: fix sctp to work with
    ipv6 source address routing") still works with this patch! Nevertheless, in RFC5095
    it is actually 'recommended' to not use that anyway due to traffic amplification [1].
    So it seems we're not supposed to do that anyway in sctp_v6_xmit(). Moreover, if
    we overwrite the flow destination here, the lower IPv6 layer will be unable to
    put the correct destination address into IP header, as routing header is added in
    ipv6_push_nfrag_opts() but then probably with wrong final destination. Things aside,
    result of this patch is that we do not have any XfrmInTmplMismatch increase plus on
    the wire with this patch it now looks like:
    
    SCTP + IPv6:
    
      08:17:47.074080 IP6 2620:52:0:102f:7a2b:cbff:fe27:1b0a > 2620:52:0:102f:213:72ff:fe32:7eba:
        AH(spi=0x00005fb4,seq=0x1): ESP(spi=0x00005fb5,seq=0x1), length 72
      08:17:47.074264 IP6 2620:52:0:102f:213:72ff:fe32:7eba > 2620:52:0:102f:7a2b:cbff:fe27:1b0a:
        AH(spi=0x00003d54,seq=0x1): ESP(spi=0x00003d55,seq=0x1), length 296
    
    This fixes Kernel Bugzilla 24412. This security issue seems to be present since
    2.6.18 kernels. Lets just hope some big passive adversary in the wild didn't have
    its fun with that. lksctp-tools IPv6 regression test suite passes as well with
    this patch.
    
     [1] http://www.secdev.org/conf/IPv6_RH_security-csw07.pdf
    
    Reported-by: Alan Chester <alan.chester@tekelec.com>
    Reported-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bbda1baeeb2f4aff3addac3d086a1e56c3f2503e
Merge: 2b76db6a0f64 f3ad857e3da1
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Sep 11 14:33:16 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Brown paper bag fix in HTB scheduler, class options set incorrectly
        due to a typoe.  Fix from Vimalkumar.
    
     2) It's possible for the ipv6 FIB garbage collector to run before all
        the necessary datastructure are setup during init, defer the
        notifier registry to avoid this problem.  Fix from Michal Kubecek.
    
     3) New i40e ethernet driver from the Intel folks.
    
     4) Add new qmi wwan device IDs, from Bjrn Mork.
    
     5) Doorbell lock in bnx2x driver is not initialized properly in some
        configurations, fix from Ariel Elior.
    
     6) Revert an ipv6 packet option padding change that broke standardized
        ipv6 implementation test suites.  From Jiri Pirko.
    
     7) Fix synchronization of ARP information in bonding layer, from
        Nikolay Aleksandrov.
    
     8) Fix missing error return resulting in illegal memory accesses in
        openvswitch, from Daniel Borkmann.
    
     9) SCTP doesn't signal poll events properly due to mistaken operator
        precedence, fix also from Daniel Borkmann.
    
    10) __netdev_pick_tx() passes wrong index to sk_tx_queue_set() which
        essentially disables caching of TX queue in sockets :-/ Fix from
        Eric Dumazet.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (29 commits)
      net_sched: htb: fix a typo in htb_change_class()
      net: qmi_wwan: add new Qualcomm devices
      ipv6: don't call fib6_run_gc() until routing is ready
      net: tilegx driver: avoid compiler warning
      fib6_rules: fix indentation
      irda: vlsi_ir: Remove casting the return value which is a void pointer
      irda: donauboe: Remove casting the return value which is a void pointer
      net: fix multiqueue selection
      net: sctp: fix smatch warning in sctp_send_asconf_del_ip
      net: sctp: fix bug in sctp_poll for SOCK_SELECT_ERR_QUEUE
      net: fib: fib6_add: fix potential NULL pointer dereference
      net: ovs: flow: fix potential illegal memory access in __parse_flow_nlattrs
      bcm63xx_enet: remove deprecated IRQF_DISABLED
      net: korina: remove deprecated IRQF_DISABLED
      macvlan: Move skb_clone check closer to call
      qlcnic: Fix warning reported by kbuild test robot.
      bonding: fix bond_arp_rcv setting and arp validate desync state
      bonding: fix store_arp_validate race with mode change
      ipv6/exthdrs: accept tlv which includes only padding
      bnx2x: avoid atomic allocations during initialization
      ...

commit 88362ad8f9a6cea787420b57cc27ccacef000dbe
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 20:51:21 2013 +0200

    net: sctp: fix smatch warning in sctp_send_asconf_del_ip
    
    This was originally reported in [1] and posted by Neil Horman [2], he said:
    
      Fix up a missed null pointer check in the asconf code. If we don't find
      a local address, but we pass in an address length of more than 1, we may
      dereference a NULL laddr pointer. Currently this can't happen, as the only
      users of the function pass in the value 1 as the addrcnt parameter, but
      its not hot path, and it doesn't hurt to check for NULL should that ever
      be the case.
    
    The callpath from sctp_asconf_mgmt() looks okay. But this could be triggered
    from sctp_setsockopt_bindx() call with SCTP_BINDX_REM_ADDR and addrcnt > 1
    while passing all possible addresses from the bind list to SCTP_BINDX_REM_ADDR
    so that we do *not* find a single address in the association's bind address
    list that is not in the packed array of addresses. If this happens when we
    have an established association with ASCONF-capable peers, then we could get
    a NULL pointer dereference as we only check for laddr == NULL && addrcnt == 1
    and call later sctp_make_asconf_update_ip() with NULL laddr.
    
    BUT: this actually won't happen as sctp_bindx_rem() will catch such a case
    and return with an error earlier. As this is incredably unintuitive and error
    prone, add a check to catch at least future bugs here. As Neil says, its not
    hot path. Introduced by 8a07eb0a5 ("sctp: Add ASCONF operation on the
    single-homed host").
    
     [1] http://www.spinics.net/lists/linux-sctp/msg02132.html
     [2] http://www.spinics.net/lists/linux-sctp/msg02133.html
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Michio Honda <micchie@sfc.wide.ad.jp>
    Acked-By: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a0fb05d1aef0f5df936f80b726d1b3bfd4275f95
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Sep 7 16:44:59 2013 +0200

    net: sctp: fix bug in sctp_poll for SOCK_SELECT_ERR_QUEUE
    
    If we do not add braces around ...
    
      mask |= POLLERR |
              sock_flag(sk, SOCK_SELECT_ERR_QUEUE) ? POLLPRI : 0;
    
    ... then this condition always evaluates to true as POLLERR is
    defined as 8 and binary or'd with whatever result comes out of
    sock_flag(). Hence instead of (X | Y) ? A : B, transform it into
    X | (Y ? A : B). Unfortunatelty, commit 8facd5fb73 ("net: fix
    smatch warnings inside datagram_poll") forgot about SCTP. :-(
    
    Introduced by 7d4c04fc170 ("net: add option to enable error queue
    packets waking select").
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Jacob Keller <jacob.e.keller@intel.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Jacob Keller <jacob.e.keller@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cc998ff8811530be521f6b316f37ab7676a07938
Merge: 57d730924d5c 0d40f75bdab2
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Sep 5 14:54:29 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking changes from David Miller:
     "Noteworthy changes this time around:
    
       1) Multicast rejoin support for team driver, from Jiri Pirko.
    
       2) Centralize and simplify TCP RTT measurement handling in order to
          reduce the impact of bad RTO seeding from SYN/ACKs.  Also, when
          both timestamps and local RTT measurements are available prefer
          the later because there are broken middleware devices which
          scramble the timestamp.
    
          From Yuchung Cheng.
    
       3) Add TCP_NOTSENT_LOWAT socket option to limit the amount of kernel
          memory consumed to queue up unsend user data.  From Eric Dumazet.
    
       4) Add a "physical port ID" abstraction for network devices, from
          Jiri Pirko.
    
       5) Add a "suppress" operation to influence fib_rules lookups, from
          Stefan Tomanek.
    
       6) Add a networking development FAQ, from Paul Gortmaker.
    
       7) Extend the information provided by tcp_probe and add ipv6 support,
          from Daniel Borkmann.
    
       8) Use RCU locking more extensively in openvswitch data paths, from
          Pravin B Shelar.
    
       9) Add SCTP support to openvswitch, from Joe Stringer.
    
      10) Add EF10 chip support to SFC driver, from Ben Hutchings.
    
      11) Add new SYNPROXY netfilter target, from Patrick McHardy.
    
      12) Compute a rate approximation for sending in TCP sockets, and use
          this to more intelligently coalesce TSO frames.  Furthermore, add
          a new packet scheduler which takes advantage of this estimate when
          available.  From Eric Dumazet.
    
      13) Allow AF_PACKET fanouts with random selection, from Daniel
          Borkmann.
    
      14) Add ipv6 support to vxlan driver, from Cong Wang"
    
    Resolved conflicts as per discussion.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1218 commits)
      openvswitch: Fix alignment of struct sw_flow_key.
      netfilter: Fix build errors with xt_socket.c
      tcp: Add missing braces to do_tcp_setsockopt
      caif: Add missing braces to multiline if in cfctrl_linkup_request
      bnx2x: Add missing braces in bnx2x:bnx2x_link_initialize
      vxlan: Fix kernel panic on device delete.
      net: mvneta: implement ->ndo_do_ioctl() to support PHY ioctls
      net: mvneta: properly disable HW PHY polling and ensure adjust_link() works
      icplus: Use netif_running to determine device state
      ethernet/arc/arc_emac: Fix huge delays in large file copies
      tuntap: orphan frags before trying to set tx timestamp
      tuntap: purge socket error queue on detach
      qlcnic: use standard NAPI weights
      ipv6:introduce function to find route for redirect
      bnx2x: VF RSS support - VF side
      bnx2x: VF RSS support - PF side
      vxlan: Notify drivers for listening UDP port changes
      net: usbnet: update addr_assign_type if appropriate
      driver/net: enic: update enic maintainers and driver
      driver/net: enic: Exposing symbols for Cisco's low latency driver
      ...

commit c08751c851b78514f6ec5f77f7cbebaac63d15c0
Author: Alexander Sverdlin <alexander.sverdlin@nsn.com>
Date:   Mon Sep 2 15:58:25 2013 +0200

    net: sctp: Fix data chunk fragmentation for MTU values which are not multiple of 4
    
    net: sctp: Fix data chunk fragmentation for MTU values which are not multiple of 4
    
    Initially the problem was observed with ipsec, but later it became clear that
    SCTP data chunk fragmentation algorithm has problems with MTU values which are
    not multiple of 4. Test program was used which just transmits 2000 bytes long
    packets to other host. tcpdump was used to observe re-fragmentation in IP layer
    after SCTP already fragmented data chunks.
    
    With MTU 1500:
    12:54:34.082904 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto SCTP (132), length 1500)
        10.151.38.153.39303 > 10.151.24.91.54321: sctp (1) [DATA] (B) [TSN: 2366088589] [SID: 0] [SSEQ 1] [PPID 0x0]
    12:54:34.082933 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto SCTP (132), length 596)
        10.151.38.153.39303 > 10.151.24.91.54321: sctp (1) [DATA] (E) [TSN: 2366088590] [SID: 0] [SSEQ 1] [PPID 0x0]
    12:54:34.090576 IP (tos 0x2,ECT(0), ttl 63, id 0, offset 0, flags [DF], proto SCTP (132), length 48)
        10.151.24.91.54321 > 10.151.38.153.39303: sctp (1) [SACK] [cum ack 2366088590] [a_rwnd 79920] [#gap acks 0] [#dup tsns 0]
    
    With MTU 1499:
    13:02:49.955220 IP (tos 0x2,ECT(0), ttl 64, id 48215, offset 0, flags [+], proto SCTP (132), length 1492)
        10.151.38.153.39084 > 10.151.24.91.54321: sctp[|sctp]
    13:02:49.955249 IP (tos 0x2,ECT(0), ttl 64, id 48215, offset 1472, flags [none], proto SCTP (132), length 28)
        10.151.38.153 > 10.151.24.91: ip-proto-132
    13:02:49.955262 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto SCTP (132), length 600)
        10.151.38.153.39084 > 10.151.24.91.54321: sctp (1) [DATA] (E) [TSN: 404355346] [SID: 0] [SSEQ 1] [PPID 0x0]
    13:02:49.956770 IP (tos 0x2,ECT(0), ttl 63, id 0, offset 0, flags [DF], proto SCTP (132), length 48)
        10.151.24.91.54321 > 10.151.38.153.39084: sctp (1) [SACK] [cum ack 404355346] [a_rwnd 79920] [#gap acks 0] [#dup tsns 0]
    
    Here problem in data portion limit calculation leads to re-fragmentation in IP,
    which is sub-optimal. The problem is max_data initial value, which doesn't take
    into account the fact, that data chunk must be padded to 4-bytes boundary.
    It's enough to correct max_data, because all later adjustments are correctly
    aligned to 4-bytes boundary.
    
    After the fix is applied, everything is fragmented correctly for uneven MTUs:
    15:16:27.083881 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto SCTP (132), length 1496)
        10.151.38.153.53417 > 10.151.24.91.54321: sctp (1) [DATA] (B) [TSN: 3077098183] [SID: 0] [SSEQ 1] [PPID 0x0]
    15:16:27.083907 IP (tos 0x2,ECT(0), ttl 64, id 0, offset 0, flags [DF], proto SCTP (132), length 600)
        10.151.38.153.53417 > 10.151.24.91.54321: sctp (1) [DATA] (E) [TSN: 3077098184] [SID: 0] [SSEQ 1] [PPID 0x0]
    15:16:27.085640 IP (tos 0x2,ECT(0), ttl 63, id 0, offset 0, flags [DF], proto SCTP (132), length 48)
        10.151.24.91.54321 > 10.151.38.153.53417: sctp (1) [SACK] [cum ack 3077098184] [a_rwnd 79920] [#gap acks 0] [#dup tsns 0]
    
    The bug was there for years already, but
     - is a performance issue, the packets are still transmitted
     - doesn't show up with default MTU 1500, but possibly with ipsec (MTU 1438)
    
    Signed-off-by: Alexander Sverdlin <alexander.sverdlin@nsn.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b1b72076b90d631637497b35e36bc64254df199d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Thu Aug 29 18:54:49 2013 +0200

    net: sctp: probe: allow more advanced ingress filtering by mark
    
    This is a follow-up commit for commit b1dcdc68b1f4 ("net: tcp_probe:
    allow more advanced ingress filtering by mark") that allows for
    advanced SCTP probe module filtering based on skb mark (for a more
    detailed description and advantages using mark, refer to b1dcdc68b1f4).
    The current option to filter by a given port is still being preserved.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5b2941b18dc5f60a5c14a5c15693f9c58b0dd922
Merge: b6750b405672 5828cd9a6887
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Aug 27 22:11:18 2013 -0400

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/jesse/openvswitch
    
    Jesse Gross says:
    
    ====================
    A number of significant new features and optimizations for net-next/3.12.
    Highlights are:
     * "Megaflows", an optimization that allows userspace to specify which
       flow fields were used to compute the results of the flow lookup.
       This allows for a major reduction in flow setups (the major
       performance bottleneck in Open vSwitch) without reducing flexibility.
     * Converting netlink dump operations to use RCU, allowing for
       additional parallelism in userspace.
     * Matching and modifying SCTP protocol fields.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a175a723301a8a4a9fedf9ce5b8ca586e7a97b40
Author: Joe Stringer <joe@wand.net.nz>
Date:   Thu Aug 22 12:30:48 2013 -0700

    openvswitch: Add SCTP support
    
    This patch adds support for rewriting SCTP src,dst ports similar to the
    functionality already available for TCP/UDP.
    
    Rewriting SCTP ports is expensive due to double-recalculation of the
    SCTP checksums; this is performed to ensure that packets traversing OVS
    with invalid checksums will continue to the destination with any
    checksum corruption intact.
    
    Reviewed-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Joe Stringer <joe@wand.net.nz>
    Signed-off-by: Ben Pfaff <blp@nicira.com>
    Signed-off-by: Jesse Gross <jesse@nicira.com>

commit 280c571e1a0f553d4f2384f1a8b643b5de26e0ec
Author: Joe Stringer <joe@wand.net.nz>
Date:   Tue Jul 23 13:37:45 2013 +0900

    net: Add NEXTHDR_SCTP to ipv6.h
    
    Signed-off-by: Joe Stringer <joe@wand.net.nz>
    Signed-off-by: Jesse Gross <jesse@nicira.com>

commit d8cdeda6ddbcb33debbb87590a7d42ff7f5b5cfd
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Wed Aug 21 19:47:59 2013 +0200

    net: tcp_probe: kprobes: adapt jtcp_rcv_established signature
    
    This patches fixes a rather unproblematic function signature mismatch
    as the const specifier was missing for the th variable; and next to
    that it adds a build-time assertion so that future function signature
    mismatches for kprobes will not end badly, similarly as commit 22222997
    ("net: sctp: add build check for sctp_sf_eat_sack_6_2/jsctp_sf_eat_sack")
    did it for SCTP.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ddea368c78ff9acf45261a7c82635b98e9c1fcd6
Merge: 2b047252d087 0a324f3189ed
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Aug 16 09:35:29 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix SKB leak in 8139cp, from Dave Jones.
    
     2) Fix use of *_PAGES interfaces with mlx5 firmware, from Moshe Lazar.
    
     3) RCU conversion of macvtap introduced two races, fixes by Eric
        Dumazet
    
     4) Synchronize statistic flows in bnx2x driver to prevent corruption,
        from Dmitry Kravkov
    
     5) Undo optimization in IP tunneling, we were using the inner IP header
        in some cases to inherit the IP ID, but that isn't correct in some
        circumstances.  From Pravin B Shelar
    
     6) Use correct struct size when parsing netlink attributes in
        rtnl_bridge_getlink().  From Asbjoern Sloth Toennesen
    
     7) Length verifications in tun_get_user() are bogus, from Weiping Pan
        and Dan Carpenter
    
     8) Fix bad merge resolution during 3.11 networking development in
        openvswitch, albeit a harmless one which added some unreachable
        code.  From Jesse Gross
    
     9) Wrong size used in flexible array allocation in openvswitch, from
        Pravin B Shelar
    
    10) Clear out firmware capability flags the be2net driver isn't ready to
        handle yet, from Sarveshwar Bandi
    
    11) Revert DMA mapping error checking addition to cxgb3 driver, it's
        buggy.  From Alexey Kardashevskiy
    
    12) Fix regression in packet scheduler rate limiting when working with a
        link layer of ATM.  From Jesper Dangaard Brouer
    
    13) Fix several errors in TCP Cubic congestion control, in particular
        overflow errors in timestamp calculations.  From Eric Dumazet and
        Van Jacobson
    
    14) In ipv6 routing lookups, we need to backtrack if subtree traversal
        don't result in a match.  From Hannes Frederic Sowa
    
    15) ipgre_header() returns incorrect packet offset.  Fix from Timo Ters
    
    16) Get "low latency" out of the new MIB counter names.  From Eliezer
        Tamir
    
    17) State check in ndo_dflt_fdb_del() is inverted, from Sridhar
        Samudrala
    
    18) Handle TCP Fast Open properly in netfilter conntrack, from Yuchung
        Cheng
    
    19) Wrong memcpy length in pcan_usb driver, from Stephane Grosjean
    
    20) Fix dealock in TIPC, from Wang Weidong and Ding Tianhong
    
    21) call_rcu() call to destroy SCTP transport is done too early and
        might result in an oops.  From Daniel Borkmann
    
    22) Fix races in genetlink family dumps, from Johannes Berg
    
    23) Flags passed into macvlan by the user need to be validated properly,
        from Michael S Tsirkin
    
    24) Fix skge build on 32-bit, from Stephen Hemminger
    
    25) Handle malformed TCP headers properly in xt_TCPMSS, from Pablo Neira
        Ayuso
    
    26) Fix handling of stacked vlans in vlan_dev_real_dev(), from Nikolay
        Aleksandrov
    
    27) Eliminate MTU calculation overflows in esp{4,6}, from Daniel
        Borkmann
    
    28) neigh_parms need to be setup before calling the ->ndo_neigh_setup()
        method.  From Veaceslav Falico
    
    29) Kill out-of-bounds prefetch in fib_trie, from Eric Dumazet
    
    30) Don't dereference MLD query message if the length isn't value in the
        bridge multicast code, from Linus Lssing
    
    31) Fix VXLAN IGMP join regression due to an inverted check, from Cong
        Wang
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (70 commits)
      net/mlx5_core: Support MANAGE_PAGES and QUERY_PAGES firmware command changes
      tun: signedness bug in tun_get_user()
      qlcnic: Fix diagnostic interrupt test for 83xx adapters
      qlcnic: Fix beacon state return status handling
      qlcnic: Fix set driver version command
      net: tg3: fix NULL pointer dereference in tg3_io_error_detected and tg3_io_slot_reset
      net_sched: restore "linklayer atm" handling
      drivers/net/ethernet/via/via-velocity.c: update napi implementation
      Revert "cxgb3: Check and handle the dma mapping errors"
      be2net: Clear any capability flags that driver is not interested in.
      openvswitch: Reset tunnel key between input and output.
      openvswitch: Use correct type while allocating flex array.
      openvswitch: Fix bad merge resolution.
      tun: compare with 0 instead of total_len
      rtnetlink: rtnl_bridge_getlink: Call nlmsg_find_attr() with ifinfomsg header
      ethernet/arc/arc_emac - fix NAPI "work > weight" warning
      ip_tunnel: Do not use inner ip-header-id for tunnel ip-header-id.
      bnx2x: prevent crash in shutdown flow with CNIC
      bnx2x: fix PTE write access error
      bnx2x: fix memory leak in VF
      ...

commit 072017b41e49e2a8e8a4e0258837a614bb5daa8d
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Fri Aug 9 22:05:36 2013 -0400

    net: sctp: Add rudimentary infrastructure to account for control chunks
    
    This patch adds a base infrastructure that allows SCTP to do
    memory accounting for control chunks.  Real accounting code will
    follow.
    
    This patch alos fixes the following triggered bug ...
    
    [  553.109742] kernel BUG at include/linux/skbuff.h:1813!
    [  553.109766] invalid opcode: 0000 [#1] SMP
    [  553.109789] Modules linked in: sctp libcrc32c rfcomm [...]
    [  553.110259]  uinput i915 i2c_algo_bit drm_kms_helper e1000e drm ptp
    pps_core i2c_core wmi video sunrpc
    [  553.110320] CPU: 0 PID: 1636 Comm: lt-test_1_to_1_ Not tainted
    3.11.0-rc3+ #2
    [  553.110350] Hardware name: LENOVO 74597D6/74597D6, BIOS 6DET60WW
    (3.10 ) 09/17/2009
    [  553.110381] task: ffff88020a01dd40 ti: ffff880204ed0000 task.ti:
    ffff880204ed0000
    [  553.110411] RIP: 0010:[<ffffffffa0698017>]  [<ffffffffa0698017>]
    skb_orphan.part.9+0x4/0x6 [sctp]
    [  553.110459] RSP: 0018:ffff880204ed1bb8  EFLAGS: 00010286
    [  553.110483] RAX: ffff8802086f5a40 RBX: ffff880204303300 RCX:
    0000000000000000
    [  553.110487] RDX: ffff880204303c28 RSI: ffff8802086f5a40 RDI:
    ffff880202158000
    [  553.110487] RBP: ffff880204ed1bb8 R08: 0000000000000000 R09:
    0000000000000000
    [  553.110487] R10: ffff88022f2d9a04 R11: ffff880233001600 R12:
    0000000000000000
    [  553.110487] R13: ffff880204303c00 R14: ffff8802293d0000 R15:
    ffff880202158000
    [  553.110487] FS:  00007f31b31fe740(0000) GS:ffff88023bc00000(0000)
    knlGS:0000000000000000
    [  553.110487] CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
    [  553.110487] CR2: 000000379980e3e0 CR3: 000000020d225000 CR4:
    00000000000407f0
    [  553.110487] Stack:
    [  553.110487]  ffff880204ed1ca8 ffffffffa068d7fc 0000000000000000
    0000000000000000
    [  553.110487]  0000000000000000 ffff8802293d0000 ffff880202158000
    ffffffff81cb7900
    [  553.110487]  0000000000000000 0000400000001c68 ffff8802086f5a40
    000000000000000f
    [  553.110487] Call Trace:
    [  553.110487]  [<ffffffffa068d7fc>] sctp_sendmsg+0x6bc/0xc80 [sctp]
    [  553.110487]  [<ffffffff8128f185>] ? sock_has_perm+0x75/0x90
    [  553.110487]  [<ffffffff815a3593>] inet_sendmsg+0x63/0xb0
    [  553.110487]  [<ffffffff8128f2b3>] ? selinux_socket_sendmsg+0x23/0x30
    [  553.110487]  [<ffffffff8151c5d6>] sock_sendmsg+0xa6/0xd0
    [  553.110487]  [<ffffffff81637b05>] ? _raw_spin_unlock_bh+0x15/0x20
    [  553.110487]  [<ffffffff8151cd38>] SYSC_sendto+0x128/0x180
    [  553.110487]  [<ffffffff8151ce6b>] ? SYSC_connect+0xdb/0x100
    [  553.110487]  [<ffffffffa0690031>] ? sctp_inet_listen+0x71/0x1f0
    [sctp]
    [  553.110487]  [<ffffffff8151d35e>] SyS_sendto+0xe/0x10
    [  553.110487]  [<ffffffff81640202>] system_call_fastpath+0x16/0x1b
    [  553.110487] Code: e0 48 c7 c7 00 22 6a a0 e8 67 a3 f0 e0 48 c7 [...]
    [  553.110487] RIP  [<ffffffffa0698017>] skb_orphan.part.9+0x4/0x6
    [sctp]
    [  553.110487]  RSP <ffff880204ed1bb8>
    [  553.121578] ---[ end trace 46c20c5903ef5be2 ]---
    
    The approach taken here is to split data and control chunks
    creation a  bit.  Data chunks already have memory accounting
    so noting needs to happen.  For control chunks, add stubs handlers.
    
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ac4f9599362475662efb6efbb334cbcec98d4778
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Aug 9 15:09:08 2013 +0200

    net: sctp: sctp_assoc_control_transport: fix MTU size in SCTP_PF state
    
    The SCTP Quick failover draft [1] section 5.1, point 5 says that the cwnd
    should be 1 MTU. So, instead of 1, set it to 1 MTU.
    
      [1] https://tools.ietf.org/html/draft-nishida-tsvwg-sctp-failover-05
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 477143e3fece3dc12629bb1ebd7b47e8e6e72b2b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Aug 6 21:18:13 2013 +0200

    net: sctp: trivial: update bug report in header comment
    
    With the restructuring of the lksctp.org site, we only allow bug
    reports through the SCTP mailing list linux-sctp@vger.kernel.org,
    not via SF, as SF is only used for web hosting and nothing more.
    While at it, also remove the obvious statement that bugs will be
    fixed and incooperated into the kernel.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cda5f98e36576596b9230483ec52bff3cc97eb21
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Aug 6 21:18:12 2013 +0200

    net: sctp: convert sctp_checksum_disable module param into sctp sysctl
    
    Get rid of the last module parameter for SCTP and make this
    configurable via sysctl for SCTP like all the rest of SCTP's
    configuration knobs.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 024ec3deac33ddbd81f3c887506f132b24ea21a7
Author: Joe Stringer <joe@wand.net.nz>
Date:   Thu Jul 25 10:52:05 2013 +0900

    net/sctp: Refactor SCTP skb checksum computation
    
    This patch consolidates the SCTP checksum calculation code from various
    places to a single new function, sctp_compute_cksum(skb, offset).
    
    Signed-off-by: Joe Stringer <joe@wand.net.nz>
    Reviewed-by: Julian Anastasov <ja@ssi.bg>
    Acked-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 91705c61b52029ab5da67a15a23eef08667bf40e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 23 14:51:47 2013 +0200

    net: sctp: trivial: update mailing list address
    
    The SCTP mailing list address to send patches or questions
    to is linux-sctp@vger.kernel.org and not
    lksctp-developers@lists.sourceforge.net anymore. Therefore,
    update all occurences.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 496322bc91e35007ed754184dcd447a02b6dd685
Merge: 2e17c5a97e23 56e0ef527b18
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jul 9 18:24:39 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking updates from David Miller:
     "This is a re-do of the net-next pull request for the current merge
      window.  The only difference from the one I made the other day is that
      this has Eliezer's interface renames and the timeout handling changes
      made based upon your feedback, as well as a few bug fixes that have
      trickeled in.
    
      Highlights:
    
       1) Low latency device polling, eliminating the cost of interrupt
          handling and context switches.  Allows direct polling of a network
          device from socket operations, such as recvmsg() and poll().
    
          Currently ixgbe, mlx4, and bnx2x support this feature.
    
          Full high level description, performance numbers, and design in
          commit 0a4db187a999 ("Merge branch 'll_poll'")
    
          From Eliezer Tamir.
    
       2) With the routing cache removed, ip_check_mc_rcu() gets exercised
          more than ever before in the case where we have lots of multicast
          addresses.  Use a hash table instead of a simple linked list, from
          Eric Dumazet.
    
       3) Add driver for Atheros CQA98xx 802.11ac wireless devices, from
          Bartosz Markowski, Janusz Dziedzic, Kalle Valo, Marek Kwaczynski,
          Marek Puzyniak, Michal Kazior, and Sujith Manoharan.
    
       4) Support reporting the TUN device persist flag to userspace, from
          Pavel Emelyanov.
    
       5) Allow controlling network device VF link state using netlink, from
          Rony Efraim.
    
       6) Support GRE tunneling in openvswitch, from Pravin B Shelar.
    
       7) Adjust SOCK_MIN_RCVBUF and SOCK_MIN_SNDBUF for modern times, from
          Daniel Borkmann and Eric Dumazet.
    
       8) Allow controlling of TCP quickack behavior on a per-route basis,
          from Cong Wang.
    
       9) Several bug fixes and improvements to vxlan from Stephen
          Hemminger, Pravin B Shelar, and Mike Rapoport.  In particular,
          support receiving on multiple UDP ports.
    
      10) Major cleanups, particular in the area of debugging and cookie
          lifetime handline, to the SCTP protocol code.  From Daniel
          Borkmann.
    
      11) Allow packets to cross network namespaces when traversing tunnel
          devices.  From Nicolas Dichtel.
    
      12) Allow monitoring netlink traffic via AF_PACKET sockets, in a
          manner akin to how we monitor real network traffic via ptype_all.
          From Daniel Borkmann.
    
      13) Several bug fixes and improvements for the new alx device driver,
          from Johannes Berg.
    
      14) Fix scalability issues in the netem packet scheduler's time queue,
          by using an rbtree.  From Eric Dumazet.
    
      15) Several bug fixes in TCP loss recovery handling, from Yuchung
          Cheng.
    
      16) Add support for GSO segmentation of MPLS packets, from Simon
          Horman.
    
      17) Make network notifiers have a real data type for the opaque
          pointer that's passed into them.  Use this to properly handle
          network device flag changes in arp_netdev_event().  From Jiri
          Pirko and Timo Ters.
    
      18) Convert several drivers over to module_pci_driver(), from Peter
          Huewe.
    
      19) tcp_fixup_rcvbuf() can loop 500 times over loopback, just use a
          O(1) calculation instead.  From Eric Dumazet.
    
      20) Support setting of explicit tunnel peer addresses in ipv6, just
          like ipv4.  From Nicolas Dichtel.
    
      21) Protect x86 BPF JIT against spraying attacks, from Eric Dumazet.
    
      22) Prevent a single high rate flow from overruning an individual cpu
          during RX packet processing via selective flow shedding.  From
          Willem de Bruijn.
    
      23) Don't use spinlocks in TCP md5 signing fast paths, from Eric
          Dumazet.
    
      24) Don't just drop GSO packets which are above the TBF scheduler's
          burst limit, chop them up so they are in-bounds instead.  Also
          from Eric Dumazet.
    
      25) VLAN offloads are missed when configured on top of a bridge, fix
          from Vlad Yasevich.
    
      26) Support IPV6 in ping sockets.  From Lorenzo Colitti.
    
      27) Receive flow steering targets should be updated at poll() time
          too, from David Majnemer.
    
      28) Fix several corner case regressions in PMTU/redirect handling due
          to the routing cache removal, from Timo Ters.
    
      29) We have to be mindful of ipv4 mapped ipv6 sockets in
          upd_v6_push_pending_frames().  From Hannes Frederic Sowa.
    
      30) Fix L2TP sequence number handling bugs, from James Chapman."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1214 commits)
      drivers/net: caif: fix wrong rtnl_is_locked() usage
      drivers/net: enic: release rtnl_lock on error-path
      vhost-net: fix use-after-free in vhost_net_flush
      net: mv643xx_eth: do not use port number as platform device id
      net: sctp: confirm route during forward progress
      virtio_net: fix race in RX VQ processing
      virtio: support unlocked queue poll
      net/cadence/macb: fix bug/typo in extracting gem_irq_read_clear bit
      Documentation: Fix references to defunct linux-net@vger.kernel.org
      net/fs: change busy poll time accounting
      net: rename low latency sockets functions to busy poll
      bridge: fix some kernel warning in multicast timer
      sfc: Fix memory leak when discarding scattered packets
      sit: fix tunnel update via netlink
      dt:net:stmmac: Add dt specific phy reset callback support.
      dt:net:stmmac: Add support to dwmac version 3.610 and 3.710
      dt:net:stmmac: Allocate platform data only if its NULL.
      net:stmmac: fix memleak in the open method
      ipv6: rt6_check_neigh should successfully verify neigh if no NUD information are available
      net: ipv6: fix wrong ping_v6_sendmsg return value
      ...

commit 8c2f414ad1b3aa3af05791cd7312eb8ff9d80e0d
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jul 9 16:17:04 2013 +0200

    net: sctp: confirm route during forward progress
    
    This fix has been proposed originally by Vlad Yasevich. He says:
    
      When SCTP makes forward progress (receives a SACK that acks new chunks,
      renegs, or answeres 0-window probes) or when HB-ACK arrives, mark
      the route as confirmed so we don't unnecessarily send NUD probes.
    
    Having a simple SCTP client/server that exchange data chunks every 1sec,
    without this patch ARP requests are sent periodically every 40-60sec.
    With this fix applied, an ARP request is only done once right at the
    "session" beginning. Also, when clearing the related ARP cache entry
    manually during the session, a new request is correctly done. I have
    only "backported" this to net-next and tested that it works, so full
    credit goes to Vlad.
    
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 56bd6ad3d86567697c4e3937583b117dcdf096bb
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Tue Jun 25 19:15:17 2013 +0800

    crypto: algboss - Hold ref count on larval
    
    commit 939e17799619e31331d2433041196529515a86a6 upstream.
    
    On Thu, Jun 20, 2013 at 10:00:21AM +0200, Daniel Borkmann wrote:
    > After having fixed a NULL pointer dereference in SCTP 1abd165e ("net:
    > sctp: fix NULL pointer dereference in socket destruction"), I ran into
    > the following NULL pointer dereference in the crypto subsystem with
    > the same reproducer, easily hit each time:
    >
    > BUG: unable to handle kernel NULL pointer dereference at (null)
    > IP: [<ffffffff81070321>] __wake_up_common+0x31/0x90
    > PGD 0
    > Oops: 0000 [#1] SMP
    > Modules linked in: padlock_sha(F-) sha256_generic(F) sctp(F) libcrc32c(F) [..]
    > CPU: 6 PID: 3326 Comm: cryptomgr_probe Tainted: GF            3.10.0-rc5+ #1
    > Hardware name: Dell Inc. PowerEdge T410/0H19HD, BIOS 1.6.3 02/01/2011
    > task: ffff88007b6cf4e0 ti: ffff88007b7cc000 task.ti: ffff88007b7cc000
    > RIP: 0010:[<ffffffff81070321>]  [<ffffffff81070321>] __wake_up_common+0x31/0x90
    > RSP: 0018:ffff88007b7cde08  EFLAGS: 00010082
    > RAX: ffffffffffffffe8 RBX: ffff88003756c130 RCX: 0000000000000000
    > RDX: 0000000000000000 RSI: 0000000000000003 RDI: ffff88003756c130
    > RBP: ffff88007b7cde48 R08: 0000000000000000 R09: ffff88012b173200
    > R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000282
    > R13: ffff88003756c138 R14: 0000000000000000 R15: 0000000000000000
    > FS:  0000000000000000(0000) GS:ffff88012fc60000(0000) knlGS:0000000000000000
    > CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
    > CR2: 0000000000000000 CR3: 0000000001a0b000 CR4: 00000000000007e0
    > DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    > DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
    > Stack:
    >  ffff88007b7cde28 0000000300000000 ffff88007b7cde28 ffff88003756c130
    >  0000000000000282 ffff88003756c128 ffffffff81227670 0000000000000000
    >  ffff88007b7cde78 ffffffff810722b7 ffff88007cdcf000 ffffffff81a90540
    > Call Trace:
    >  [<ffffffff81227670>] ? crypto_alloc_pcomp+0x20/0x20
    >  [<ffffffff810722b7>] complete_all+0x47/0x60
    >  [<ffffffff81227708>] cryptomgr_probe+0x98/0xc0
    >  [<ffffffff81227670>] ? crypto_alloc_pcomp+0x20/0x20
    >  [<ffffffff8106760e>] kthread+0xce/0xe0
    >  [<ffffffff81067540>] ? kthread_freezable_should_stop+0x70/0x70
    >  [<ffffffff815450dc>] ret_from_fork+0x7c/0xb0
    >  [<ffffffff81067540>] ? kthread_freezable_should_stop+0x70/0x70
    > Code: 41 56 41 55 41 54 53 48 83 ec 18 66 66 66 66 90 89 75 cc 89 55 c8
    >       4c 8d 6f 08 48 8b 57 08 41 89 cf 4d 89 c6 48 8d 42 e
    > RIP  [<ffffffff81070321>] __wake_up_common+0x31/0x90
    >  RSP <ffff88007b7cde08>
    > CR2: 0000000000000000
    > ---[ end trace b495b19270a4d37e ]---
    >
    > My assumption is that the following is happening: the minimal SCTP
    > tool runs under ``echo 1 > /proc/sys/net/sctp/auth_enable'', hence
    > it's making use of crypto_alloc_hash() via sctp_auth_init_hmacs().
    > It forks itself, heavily allocates, binds, listens and waits in
    > accept on sctp sockets, and then randomly kills some of them (no
    > need for an actual client in this case to hit this). Then, again,
    > allocating, binding, etc, and then killing child processes.
    >
    > The problem that might be happening here is that cryptomgr requests
    > the module to probe/load through cryptomgr_schedule_probe(), but
    > before the thread handler cryptomgr_probe() returns, we return from
    > the wait_for_completion_interruptible() function and probably already
    > have cleared up larval, thus we run into a NULL pointer dereference
    > when in cryptomgr_probe() complete_all() is being called.
    >
    > If we wait with wait_for_completion() instead, this panic will not
    > occur anymore. This is valid, because in case a signal is pending,
    > cryptomgr_probe() returns from probing anyway with properly calling
    > complete_all().
    
    The use of wait_for_completion_interruptible is intentional so that
    we don't lock up the thread if a bug causes us to never wake up.
    
    This bug is caused by the helper thread using the larval without
    holding a reference count on it.  If the helper thread completes
    after the original thread requesting for help has gone away and
    destroyed the larval, then we get the crash above.
    
    So the fix is to hold a reference count on the larval.
    
    Reported-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6072a93b98e660211c4b46a8381833425bdcf7b7
Merge: 3f490f7f9905 cfa805f6f196
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jul 2 09:52:07 2013 -0700

    Merge tag 'dlm-3.11' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm
    
    Pull dlm updates from David Teigland:
     "This set includes a number of SCTP related fixes in the dlm, and a few
      other minor fixes and changes."
    
    * tag 'dlm-3.11' of git://git.kernel.org/pub/scm/linux/kernel/git/teigland/linux-dlm:
      dlm: Avoid LVB truncation
      dlm: log an error for unmanaged lockspaces
      dlm: config: using strlcpy instead of strncpy
      dlm: remove duplicated include from lowcomms.c
      dlm: disable nagle for SCTP
      dlm: retry failed SCTP sends
      dlm: try other IPs when sctp init assoc fails
      dlm: clear correct bit during sctp init failure handling
      dlm: set sctp assoc id during setup
      dlm: clear correct init bit during sctp setup

commit e02010adeeb21ef56d6b9b68c785ed1ecc832aee
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Jul 1 11:31:36 2013 +0200

    net: sctp: get rid of SCTP_DBG_TSNS entirely
    
    After having reworked the debugging framework, Neil and Vlad agreed to
    get rid of the leftover SCTP_DBG_TSNS code for a couple of reasons:
    
    We can use systemtap scripts to investigate these things, we now have
    pr_debug() helpers that make life easier, and if we really need anything
    else besides those tools, we will be forced to come up with something
    better than we have there. Therefore, get rid of this ifdef debugging
    code entirely for now.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bb33381d0c97cdee25f2cdab540b6e2bd16fa03b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Jun 28 19:49:40 2013 +0200

    net: sctp: rework debugging framework to use pr_debug and friends
    
    We should get rid of all own SCTP debug printk macros and use the ones
    that the kernel offers anyway instead. This makes the code more readable
    and conform to the kernel code, and offers all the features of dynamic
    debbuging that pr_debug() et al has, such as only turning on/off portions
    of debug messages at runtime through debugfs. The runtime cost of having
    CONFIG_DYNAMIC_DEBUG enabled, but none of the debug statements printing,
    is negligible [1]. If kernel debugging is completly turned off, then these
    statements will also compile into "empty" functions.
    
    While we're at it, we also need to change the Kconfig option as it /now/
    only refers to the ifdef'ed code portions in outqueue.c that enable further
    debugging/tracing of SCTP transaction fields. Also, since SCTP_ASSERT code
    was enabled with this Kconfig option and has now been removed, we
    transform those code parts into WARNs resp. where appropriate BUG_ONs so
    that those bugs can be more easily detected as probably not many people
    have SCTP debugging permanently turned on.
    
    To turn on all SCTP debugging, the following steps are needed:
    
     # mount -t debugfs none /sys/kernel/debug
     # echo -n 'module sctp +p' > /sys/kernel/debug/dynamic_debug/control
    
    This can be done more fine-grained on a per file, per line basis and others
    as described in [2].
    
     [1] https://www.kernel.org/doc/ols/2009/ols2009-pages-39-46.pdf
     [2] Documentation/dynamic-debug-howto.txt
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1067964305df131ede2c08c2f3c9b3892640f1c6
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Jun 28 19:49:39 2013 +0200

    lib: vsprintf: add IPv4/v6 generic %p[Ii]S[pfs] format specifier
    
    In order to avoid making code that deals with printing both, IPv4 and
    IPv6 addresses, unnecessary complicated as for example ...
    
      if (sa.sa_family == AF_INET6)
        printk("... %pI6 ...", ..sin6_addr);
      else
        printk("... %pI4 ...", ..sin_addr.s_addr);
    
    ... it would be better to introduce a format specifier that can deal
    with those kind of situations internally; just as we have a "struct
    sockaddr" for generic mapping into "struct sockaddr_in" or "struct
    sockaddr_in6" as e.g. done in "union sctp_addr". Then, we could
    reduce the above statement into something like:
    
      printk("... %pIS ..", &sockaddr);
    
    In case our pointer is NULL, pointer() then deals with that already at
    an earlier point in time internally. While we're at it, support for both
    %piS/%pIS, where 'S' stands for sockaddr, comes (almost) for free.
    
    Additionally to that, postfix specifiers 'p', 'f' and 's' are supported
    as suggested and initially implemented in 2009 by Joe Perches [1].
    Handling of those additional specifiers orientate on the initial RFC that
    was proposed. Also we support IPv6 compressed format specified by 'c' and
    various other IPv4 extensions as stated in the documentation part.
    
    Likely, there are many other areas than just SCTP in the kernel to make
    use of this extension as well.
    
     [1] http://patchwork.ozlabs.org/patch/31480/
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    CC: Joe Perches <joe@perches.com>
    CC: linux-kernel@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4e144d3a807d6d2aa03d2cb234d88ef1a140e8c3
Merge: 008aebde9be3 496e4ae7dc94
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Jun 30 17:35:13 2013 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    The following batch contains Netfilter/IPVS updates for net-next,
    they are:
    
    * Enforce policy to several nfnetlink subsystem, from Daniel
      Borkmann.
    
    * Use xt_socket to match the third packet (to perform simplistic
      socket-based stateful filtering), from Eric Dumazet.
    
    * Avoid large timeout for picked up from the middle TCP flows,
      from Florian Westphal.
    
    * Exclude IPVS from struct net if IPVS is disabled and removal
      of unnecessary included header file, from JunweiZhang.
    
    * Release SCTP connection immediately under load, to mimic current
      TCP behaviour, from Julian Anastasov.
    
    * Replace and enhance SCTP state machine, from Julian Anastasov.
    
    * Add tweak to reduce sync traffic in the presence of persistence,
      also from Julian Anastasov.
    
    * Add tweak for the IPVS SH scheduler not to reject connections
      directed to a server, choose a new one instead, from Alexander
      Frolkin.
    
    * Add support for sloppy TCP and SCTP modes, that creates state
      information on any packet, not only initial handshake packets,
      from Alexander Frolkin.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 133841cab7817f110c35fd97032a6a9d66a3e9e2
Merge: 65544319372b 939e17799619
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Jun 29 11:34:18 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6
    
    Pull crypto fix from Herbert Xu:
     "This fixes a crash in the crypto layer exposed by an SCTP test tool"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6:
      crypto: algboss - Hold ref count on larval

commit eba3b5a78799d21dea05118b294524958f0ab592
Author: Alexander Frolkin <avf@eldamar.org.uk>
Date:   Wed Jun 19 10:54:25 2013 +0100

    ipvs: SH fallback and L4 hashing
    
    By default the SH scheduler rejects connections that are hashed onto a
    realserver of weight 0.  This patch adds a flag to make SH choose a
    different realserver in this case, instead of rejecting the connection.
    
    The patch also adds a flag to make SH include the source port (TCP, UDP,
    SCTP) in the hash as well as the source address.  This basically allows
    for deterministic round-robin load balancing (i.e., where any director
    in a cluster of directors with identical config will send the same
    packet the same way).
    
    The flags are service flags (IP_VS_SVC_F_SCHED*) so that these options
    can be set per service.  They are set using a new option to ipvsadm.
    
    Signed-off-by: Alexander Frolkin <avf@eldamar.org.uk>
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit acaac5d8bbedf6bd96f53960780942e1ad90d70e
Author: Julian Anastasov <ja@ssi.bg>
Date:   Tue Jun 18 10:08:08 2013 +0300

    ipvs: drop SCTP connections depending on state
    
    Drop SCTP connections under load (dropentry context) depending
    on the protocol state, just like for TCP: INIT conns are
    dropped immediately, established are dropped randomly while
    connections in progress or shutdown are skipped.
    
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit 61e7c420b4b2a797ac209106ba743ab6ebe984d8
Author: Julian Anastasov <ja@ssi.bg>
Date:   Tue Jun 18 10:08:07 2013 +0300

    ipvs: replace the SCTP state machine
    
    Convert the SCTP state table, so that it is more readable.
    Change the states to be according to the diagram in RFC 2960
    and add more states suitable for middle box. Still, such
    change in states adds incompatibility if systems in sync
    setup include this change and others do not include it.
    
    With this change we also have proper transitions in INPUT-ONLY
    mode (DR/TUN) where we see packets only from client. Now
    we should not switch to 10-second CLOSED state at a time
    when we should stay in ESTABLISHED state.
    
    The short names for states are because we have 16-char space
    in ipvsadm and 11-char limit for the connection list format.
    It is a sequence of the TCP implementation where the longest
    state name is ESTABLISHED.
    
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit c6c96c188336b2b95d5f14facd101f1e4165a9d3
Author: Alexander Frolkin <avf@eldamar.org.uk>
Date:   Thu Jun 13 08:56:15 2013 +0100

    ipvs: sloppy TCP and SCTP
    
    This adds support for sloppy TCP and SCTP modes to IPVS.
    
    When enabled (sysctls net.ipv4.vs.sloppy_tcp and
    net.ipv4.vs.sloppy_sctp), allows IPVS to create connection state on any
    packet, not just a TCP SYN (or SCTP INIT).
    
    This allows connections to fail over from one IPVS director to another
    mid-flight.
    
    Signed-off-by: Alexander Frolkin <avf@eldamar.org.uk>
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit 52db882f3fc2903014e638ee91e690085fe37fdb
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Jun 25 18:17:27 2013 +0200

    net: sctp: migrate cookie life from timeval to ktime
    
    Currently, SCTP code defines its own timeval functions (since timeval
    is rarely used inside the kernel by others), namely tv_lt() and
    TIMEVAL_ADD() macros, that operate on SCTP cookie expiration.
    
    We might as well remove all those, and operate directly on ktime
    structures for a couple of reasons: ktime is available on all archs;
    complexity of ktime calculations depending on the arch is less than
    (reduces to a simple arithmetic operations on archs with
    BITS_PER_LONG == 64 or CONFIG_KTIME_SCALAR) or equal to timeval
    functions (other archs); code becomes more readable; macros can be
    thrown out.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 939e17799619e31331d2433041196529515a86a6
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Tue Jun 25 19:15:17 2013 +0800

    crypto: algboss - Hold ref count on larval
    
    On Thu, Jun 20, 2013 at 10:00:21AM +0200, Daniel Borkmann wrote:
    > After having fixed a NULL pointer dereference in SCTP 1abd165e ("net:
    > sctp: fix NULL pointer dereference in socket destruction"), I ran into
    > the following NULL pointer dereference in the crypto subsystem with
    > the same reproducer, easily hit each time:
    >
    > BUG: unable to handle kernel NULL pointer dereference at (null)
    > IP: [<ffffffff81070321>] __wake_up_common+0x31/0x90
    > PGD 0
    > Oops: 0000 [#1] SMP
    > Modules linked in: padlock_sha(F-) sha256_generic(F) sctp(F) libcrc32c(F) [..]
    > CPU: 6 PID: 3326 Comm: cryptomgr_probe Tainted: GF            3.10.0-rc5+ #1
    > Hardware name: Dell Inc. PowerEdge T410/0H19HD, BIOS 1.6.3 02/01/2011
    > task: ffff88007b6cf4e0 ti: ffff88007b7cc000 task.ti: ffff88007b7cc000
    > RIP: 0010:[<ffffffff81070321>]  [<ffffffff81070321>] __wake_up_common+0x31/0x90
    > RSP: 0018:ffff88007b7cde08  EFLAGS: 00010082
    > RAX: ffffffffffffffe8 RBX: ffff88003756c130 RCX: 0000000000000000
    > RDX: 0000000000000000 RSI: 0000000000000003 RDI: ffff88003756c130
    > RBP: ffff88007b7cde48 R08: 0000000000000000 R09: ffff88012b173200
    > R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000282
    > R13: ffff88003756c138 R14: 0000000000000000 R15: 0000000000000000
    > FS:  0000000000000000(0000) GS:ffff88012fc60000(0000) knlGS:0000000000000000
    > CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
    > CR2: 0000000000000000 CR3: 0000000001a0b000 CR4: 00000000000007e0
    > DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    > DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
    > Stack:
    >  ffff88007b7cde28 0000000300000000 ffff88007b7cde28 ffff88003756c130
    >  0000000000000282 ffff88003756c128 ffffffff81227670 0000000000000000
    >  ffff88007b7cde78 ffffffff810722b7 ffff88007cdcf000 ffffffff81a90540
    > Call Trace:
    >  [<ffffffff81227670>] ? crypto_alloc_pcomp+0x20/0x20
    >  [<ffffffff810722b7>] complete_all+0x47/0x60
    >  [<ffffffff81227708>] cryptomgr_probe+0x98/0xc0
    >  [<ffffffff81227670>] ? crypto_alloc_pcomp+0x20/0x20
    >  [<ffffffff8106760e>] kthread+0xce/0xe0
    >  [<ffffffff81067540>] ? kthread_freezable_should_stop+0x70/0x70
    >  [<ffffffff815450dc>] ret_from_fork+0x7c/0xb0
    >  [<ffffffff81067540>] ? kthread_freezable_should_stop+0x70/0x70
    > Code: 41 56 41 55 41 54 53 48 83 ec 18 66 66 66 66 90 89 75 cc 89 55 c8
    >       4c 8d 6f 08 48 8b 57 08 41 89 cf 4d 89 c6 48 8d 42 e
    > RIP  [<ffffffff81070321>] __wake_up_common+0x31/0x90
    >  RSP <ffff88007b7cde08>
    > CR2: 0000000000000000
    > ---[ end trace b495b19270a4d37e ]---
    >
    > My assumption is that the following is happening: the minimal SCTP
    > tool runs under ``echo 1 > /proc/sys/net/sctp/auth_enable'', hence
    > it's making use of crypto_alloc_hash() via sctp_auth_init_hmacs().
    > It forks itself, heavily allocates, binds, listens and waits in
    > accept on sctp sockets, and then randomly kills some of them (no
    > need for an actual client in this case to hit this). Then, again,
    > allocating, binding, etc, and then killing child processes.
    >
    > The problem that might be happening here is that cryptomgr requests
    > the module to probe/load through cryptomgr_schedule_probe(), but
    > before the thread handler cryptomgr_probe() returns, we return from
    > the wait_for_completion_interruptible() function and probably already
    > have cleared up larval, thus we run into a NULL pointer dereference
    > when in cryptomgr_probe() complete_all() is being called.
    >
    > If we wait with wait_for_completion() instead, this panic will not
    > occur anymore. This is valid, because in case a signal is pending,
    > cryptomgr_probe() returns from probing anyway with properly calling
    > complete_all().
    
    The use of wait_for_completion_interruptible is intentional so that
    we don't lock up the thread if a bug causes us to never wake up.
    
    This bug is caused by the helper thread using the larval without
    holding a reference count on it.  If the helper thread completes
    after the original thread requesting for help has gone away and
    destroyed the larval, then we get the crash above.
    
    So the fix is to hold a reference count on the larval.
    
    Cc: <stable@vger.kernel.org> # 3.6+
    Reported-by: Daniel Borkmann <dborkman@redhat.com>
    Tested-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

commit a3d9dd89b781bdcb14201847608b658442de812b
Merge: f57da7a65b38 c8fc51cfa758
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jun 24 12:45:24 2013 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    The following patchset contains five fixes for Netfilter/IPVS, they are:
    
    * A skb leak fix in fragmentation handling in case that helpers are in place,
      it occurs since the IPV6 NAT infrastructure, from Phil Oester.
    
    * Fix SCTP port mangling in ICMP packets for IPVS, from Julian Anastasov.
    
    * Fix event delivery in ctnetlink regarding the new connlabel infrastructure,
      from Florian Westphal.
    
    * Fix mangling in the SIP NAT helper, from Balazs Peter Odor.
    
    * Fix crash in ipt_ULOG introduced while adding netnamespace support,
      from Gao Feng.
    
    I'll take care of passing several of these patches to -stable once they hit
    Linus' tree.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 06f3d7f973ec04290d86b7dd91b48d38d90433dc
Author: Julian Anastasov <ja@ssi.bg>
Date:   Tue Jun 18 10:08:06 2013 +0300

    ipvs: SCTP ports should be writable in ICMP packets
    
    Make sure that SCTP ports are writable when embedded in ICMP
    from client, so that ip_vs_nat_icmp can translate them safely.
    
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit dda9192851dcf904b4d1095480834f2a4f814ae3
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Mon Jun 17 11:40:05 2013 +0200

    net: sctp: remove SCTP_STATIC macro
    
    SCTP_STATIC is just another define for the static keyword. It's use
    is inconsistent in the SCTP code anyway and it was introduced in the
    initial implementation of SCTP in 2.5. We have a regression suite in
    lksctp-tools, but this is for user space only, so noone makes use of
    this macro anymore. The kernel test suite for 2.5 is incompatible with
    the current SCTP code anyway.
    
    So simply Remove it, to be more consistent with the rest of the kernel
    code.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 596fa9e6efddd5297fe577b345e0710404608e06
Merge: 5938930e71af c5c7774d7eb4
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Jun 15 11:47:56 2013 -1000

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix RTNL locking in batman-adv, from Matthias Schiffer.
    
     2) Don't allow non-passthrough macvlan devices to set NOPROMISC via
        netlink, otherwise we can end up with corrupted promisc counter
        values on the device.  From Michael S Tsirkin.
    
     3) Fix stmmac driver build with debugging defines enabled, from Dinh
        Nguyen.
    
     4) Make sure name string we give in socket address in AF_PACKET is NULL
        terminated, from Daniel Borkmann.
    
     5) Fix leaking of two uninitialized bytes of memory to userspace in
        l2tp, from Guillaume Nault.
    
     6) Clear IPCB(skb) before tunneling otherwise we touch dangling IP
        options state and crash.  From Saurabh Mohan.
    
     7) Fix suspend/resume for davinci_mdio by using suspend_late and
        resume_early.  From Mugunthan V N.
    
     8) Don't tag ip_tunnel_init_net and ip_tunnel_delete_net with
        __net_{init,exit}, they can be called outside of those contexts.
        From Eric Dumazet.
    
     9) Fix RX length error in sh_eth driver, from Yoshihiro Shimoda.
    
    10) Fix missing sctp_outq initialization in some code paths of SCTP
        stack, from Neil Horman.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (21 commits)
      sctp: fully initialize sctp_outq in sctp_outq_init
      netiucv: Hold rtnl between name allocation and device registration.
      tulip: Properly check dma mapping result
      net: sh_eth: fix incorrect RX length error if R8A7740
      ip_tunnel: remove __net_init/exit from exported functions
      drivers: net: davinci_mdio: restore mdio clk divider in mdio resume
      drivers: net: davinci_mdio: moving mdio resume earlier than cpsw ethernet driver
      net/ipv4: ip_vti clear skb cb before tunneling.
      tg3: Wait for boot code to finish after power on
      l2tp: Fix sendmsg() return value
      l2tp: Fix PPP header erasure and memory leak
      bonding: fix igmp_retrans type and two related races
      bonding: reset master mac on first enslave failure
      packet: packet_getname_spkt: make sure string is always 0-terminated
      net: ethernet: stmicro: stmmac: Fix compile error when STMMAC_XMIT_DEBUG used
      be2net: Fix 32-bit DMA Mask handling
      xen-netback: don't de-reference vif pointer after having called xenvif_put()
      macvlan: don't touch promisc without passthrough
      batman-adv: Don't handle address updates when bla is disabled
      batman-adv: forward late OGMs from best next hop
      ...

commit 405426f6ca8ac2d8d5b1f8eb9285452d44222781
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Jun 14 18:24:05 2013 +0200

    net: sctp: sctp_sf_do_prm_asoc: do SCTP_CMD_INIT_CHOOSE_TRANSPORT first
    
    While this currently cannot trigger any NULL pointer dereference in
    sctp_seq_dump_local_addrs(), better change the order of commands to
    prevent a future bug to happen. Although we first add SCTP_CMD_NEW_ASOC
    and then set the SCTP_CMD_INIT_CHOOSE_TRANSPORT, it is okay for now,
    since this primitive is only called by sctp_connect() or sctp_sendmsg()
    with sctp_assoc_add_peer() set first. However, lets do this precaution
    and first set the transport and then add it to the association hashlist
    to prevent in future something to possibly triggering this.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f9e42b853523cda0732022c2e0473c183f7aec65
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Jun 14 18:24:04 2013 +0200

    net: sctp: sideeffect: throw BUG if primary_path is NULL
    
    This clearly states a BUG somewhere in the SCTP code as e.g. fixed once
    in f28156335 ("sctp: Use correct sideffect command in duplicate cookie
    handling"). If this ever happens, throw a trace in the sideeffect engine
    where assocs clearly must have a primary_path assigned.
    
    When in sctp_seq_dump_local_addrs() also throw a WARN and bail out since
    we do not need to panic for printing this one asterisk. Also, it will
    avoid the not so obvious case when primary != NULL test passes and at a
    later point in time triggering a NULL ptr dereference caused by primary.
    While at it, also fix up the white space.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 86e92ad299fb0be359efdd61812944497d4d8d52
Author: Mike Christie <michaelc@cs.wisc.edu>
Date:   Fri Jun 14 04:56:14 2013 -0500

    dlm: disable nagle for SCTP
    
    For TCP we disable Nagle and I cannot think of why it would be needed
    for SCTP. When disabled it seems to improve dlm_lock operations like it
    does for TCP.
    
    Signed-off-by: Mike Christie <michaelc@cs.wisc.edu>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 5d6898714fe2ce485e95ac74479ed40ebd8d5748
Author: Mike Christie <michaelc@cs.wisc.edu>
Date:   Fri Jun 14 04:56:13 2013 -0500

    dlm: retry failed SCTP sends
    
    Currently if a SCTP send fails, we lose the data we were trying
    to send because the writequeue_entry is released when we do the send.
    When this happens other nodes will then hang waiting for a reply.
    
    This adds support for SCTP to retry the send operation.
    
    I also removed the retry limit for SCTP use, because we want
    to make sure we try every path during init time and for longer
    failures we want to continually retry in case paths come back up
    while trying other paths. We will do this until userspace tells us
    to stop.
    
    Signed-off-by: Mike Christie <michaelc@cs.wisc.edu>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 98e1b60ecc441625c91013e88f14cbd1b3c1fa08
Author: Mike Christie <michaelc@cs.wisc.edu>
Date:   Fri Jun 14 04:56:12 2013 -0500

    dlm: try other IPs when sctp init assoc fails
    
    Currently, if we cannot create a association to the first IP addr
    that is added to DLM, the SCTP init assoc code will just retry
    the same IP. This patch adds a simple failover schemes where we
    will try one of the addresses that was passed into DLM.
    
    Signed-off-by: Mike Christie <michaelc@cs.wisc.edu>
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 5e4b9c85cc21931ed6543cd8b527fd34ceb40717
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    [ Upstream commit be364c8c0f17a3dd42707b5a090b318028538eb9 ]
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit dc7b3eb900aab02e5cafbca3948d005be13fb4a5
Author: Grzegorz Lyczba <grzegorz.lyczba@gmail.com>
Date:   Mon May 13 23:56:24 2013 +0200

    ipvs: Fix reuse connection if real server is dead
    
    Expire cached connection for new TCP/SCTP connection if real
    server is down. Otherwise, IPVS uses the dead server for the
    reused connection, instead of a new working one.
    
    Signed-off-by: Grzegorz Lyczba <grzegorz.lyczba@gmail.com>
    Acked-by: Hans Schillstrom <hans@schillstrom.com>
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 14d3692f04a050a0d1e4637b56f997a168c591f6
Merge: 674853b22216 eee1d5a14780
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Apr 29 14:29:06 2013 -0400

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    The following patchset contains relevant updates for the Netfilter
    tree, they are:
    
    * Enhancements for ipset: Add the counter extension for sets, this
      information can be used from the iptables set match, to change
      the matching behaviour. Jozsef required to add the extension
      infrastructure and moved the existing timeout support upon it.
      This also includes a change in net/sched/em_ipset to adapt it to
      the new extension structure.
    
    * Enhancements for performance boosting in nfnetlink_queue: Add new
      configuration flags that allows user-space to receive big packets (GRO)
      and to disable checksumming calculation. This were proposed by Eric
      Dumazet during the Netfilter Workshop 2013 in Copenhagen. Florian
      Westphal was kind enough to find the time to materialize the proposal.
    
    * A sparse fix from Simon, he noticed it in the SCTP NAT helper, the fix
      required a change in the interface of sctp_end_cksum.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d3734b0496f5a310a85bb53310c047b8e42bc440
Merge: 204cd4f4957e e7e6f6300faa
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Apr 25 00:53:40 2013 -0400

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/pablo/nf-next
    
    Pablo Neira Ayuso says:
    
    ====================
    The following patchset contains fixes for recently applied
    Netfilter/IPVS updates to the net-next tree, most relevantly
    they are:
    
    * Fix sparse warnings introduced in the RCU conversion, from
      Julian Anastasov.
    
    * Fix wrong endianness in the size field of IPVS sync messages,
      from Simon Horman.
    
    * Fix missing if checking in nf_xfrm_me_harder, from Dan Carpenter.
    
    * Fix off by one access in the IPVS SCTP tracking code, again from
      Dan Carpenter.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f406c8b9693f2f71ef2caeb0b68521a7d22d00f0
Author: Dilip Daya <dilip.daya@hp.com>
Date:   Tue Apr 16 01:39:07 2013 +0000

    sctp: Add buffer utilization fields to /proc/net/sctp/assocs
    
    sctp: Add buffer utilization fields to /proc/net/sctp/assocs
    
    This patch adds the following fields to /proc/net/sctp/assocs output:
    
            - sk->sk_wmem_alloc as "wmema"  (transmit queue bytes committed)
            - sk->sk_wmem_queued as "wmemq" (persistent queue size)
            - sk->sk_sndbuf as "sndbuf"     (size of send buffer in bytes)
            - sk->sk_rcvbuf as "rcvbuf"     (size of receive buffer in bytes)
    
    When small DATA chunks containing 136 bytes data are sent the TX_QUEUE
    (assoc->sndbuf_used) reaches a maximum of 40.9% of sk_sndbuf value when
    peer.rwnd = 0. This was diagnosed from sk_wmem_alloc value reaching maximum
    value of sk_sndbuf.
    
    TX_QUEUE (assoc->sndbuf_used), sk_wmem_alloc and sk_wmem_queued values are
    incremented in sctp_set_owner_w() for outgoing data chunks. Having access to
    the above values in /proc/net/sctp/assocs will provide a better understanding
    of SCTP buffer management.
    
    With patch applied, example output when peer.rwnd = 0
    
    where:
        ASSOC ffff880132298000 is sender
              ffff880125343000 is receiver
    
     ASSOC           SOCK            STY SST ST  HBKT ASSOC-ID TX_QUEUE RX_QUEUE \
    ffff880132298000 ffff880124a0a0c0 2   1   3  29325    1      214656        0 \
    ffff880125343000 ffff8801237d7700 2   1   3  36210    2           0   524520 \
    
    UID   INODE LPORT  RPORT LADDRS <-> RADDRS       HBINT   INS  OUTS \
      0   25108 3455   3456  *10.4.8.3 <-> *10.5.8.3  7500     2     2 \
      0   27819 3456   3455  *10.5.8.3 <-> *10.4.8.3  7500     2     2 \
    
    MAXRT T1X T2X RTXC   wmema   wmemq  sndbuf  rcvbuf
        4   0   0   72  525633  440320  524288  524288
        4   0   0    0       1       0  524288  524288
    
    Signed-off-by: Dilip Daya <dilip.daya@hp.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1b8664341100716202c29d67f24d67094a82971e
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Apr 9 05:54:01 2013 +0000

    net: sctp: introduce uapi header for sctp
    
    This patch introduces an UAPI header for the SCTP protocol,
    so that we can facilitate the maintenance and development of
    user land applications or libraries, in particular in terms
    of header synchronization.
    
    To not break compatibility, some fragments from lksctp-tools'
    netinet/sctp.h have been carefully included, while taking care
    that neither kernel nor user land breaks, so both compile fine
    with this change (for lksctp-tools I tested with the old
    netinet/sctp.h header and with a newly adapted one that includes
    the uapi sctp header). lksctp-tools smoke test run through
    successfully as well in both cases.
    
    Suggested-by: Neil Horman <nhorman@tuxdriver.com>
    Cc: Neil Horman <nhorman@tuxdriver.com>
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 259c9a1f9e0fa6610c5d7c15ba658dd4fd007bf5
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Tue Apr 2 12:35:31 2013 +0000

    sctp: remove 'sridhar' from maintainers list
    
    Update SCTP maintainers list.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 37cd2294d40ef81320715b9e1606ac1f43d99c3a
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Mar 12 15:53:23 2013 +0000

    sctp: Use correct sideffect command in duplicate cookie handling
    
    [ Upstream commit f2815633504b442ca0b0605c16bf3d88a3a0fcea ]
    
    When SCTP is done processing a duplicate cookie chunk, it tries
    to delete a newly created association.  For that, it has to set
    the right association for the side-effect processing to work.
    However, when it uses the SCTP_CMD_NEW_ASOC command, that performs
    more work then really needed (like hashing the associationa and
    assigning it an id) and there is no point to do that only to
    delete the association as a next step.  In fact, it also creates
    an impossible condition where an association may be found by
    the getsockopt() call, and that association is empty.  This
    causes a crash in some sctp getsockopts.
    
    The solution is rather simple.  We simply use SCTP_CMD_SET_ASOC
    command that doesn't have all the overhead and does exactly
    what we need.
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Tested-by: Karl Heiss <kheiss@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0aa8bf90399754022f547b69e1812abe8bba4c0b
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Mar 12 15:53:23 2013 +0000

    sctp: Use correct sideffect command in duplicate cookie handling
    
    [ Upstream commit f2815633504b442ca0b0605c16bf3d88a3a0fcea ]
    
    When SCTP is done processing a duplicate cookie chunk, it tries
    to delete a newly created association.  For that, it has to set
    the right association for the side-effect processing to work.
    However, when it uses the SCTP_CMD_NEW_ASOC command, that performs
    more work then really needed (like hashing the associationa and
    assigning it an id) and there is no point to do that only to
    delete the association as a next step.  In fact, it also creates
    an impossible condition where an association may be found by
    the getsockopt() call, and that association is empty.  This
    causes a crash in some sctp getsockopts.
    
    The solution is rather simple.  We simply use SCTP_CMD_SET_ASOC
    command that doesn't have all the overhead and does exactly
    what we need.
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Tested-by: Karl Heiss <kheiss@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c6cab972c07cb7229769498fa664a893837dfba7
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Mar 12 15:53:23 2013 +0000

    sctp: Use correct sideffect command in duplicate  cookie handling
    
    [ Upstream commit f2815633504b442ca0b0605c16bf3d88a3a0fcea ]
    
    When SCTP is done processing a duplicate cookie chunk, it tries
    to delete a newly created association.  For that, it has to set
    the right association for the side-effect processing to work.
    However, when it uses the SCTP_CMD_NEW_ASOC command, that performs
    more work then really needed (like hashing the associationa and
    assigning it an id) and there is no point to do that only to
    delete the association as a next step.  In fact, it also creates
    an impossible condition where an association may be found by
    the getsockopt() call, and that association is empty.  This
    causes a crash in some sctp getsockopts.
    
    The solution is rather simple.  We simply use SCTP_CMD_SET_ASOC
    command that doesn't have all the overhead and does exactly
    what we need.
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Tested-by: Karl Heiss <kheiss@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 10ad3eeffe25354f9ef7d7e530c60216f2f2e641
Author: Guenter Roeck <linux@roeck-us.net>
Date:   Wed Feb 27 10:57:31 2013 +0000

    net/sctp: Validate parameter size for SCTP_GET_ASSOC_STATS
    
    commit 726bc6b092da4c093eb74d13c07184b18c1af0f1 upstream.
    
    Building sctp may fail with:
    
    In function copy_from_user,
        inlined from sctp_getsockopt_assoc_stats at
        net/sctp/socket.c:5656:20:
    arch/x86/include/asm/uaccess_32.h:211:26: error: call to
        copy_from_user_overflow declared with attribute error: copy_from_user()
        buffer size is not provably correct
    
    if built with W=1 due to a missing parameter size validation
    before the call to copy_from_user.
    
    Signed-off-by: Guenter Roeck <linux@roeck-us.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 90b2621fd465949e1714127e829a79160de14b38
Merge: 10b38669d64c 3dd6664fac7e
Author: David S. Miller <davem@davemloft.net>
Date:   Wed Mar 20 10:23:52 2013 -0400

    Merge branch 'master' of git://1984.lsi.us.es/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    The following patchset contains 7 Netfilter/IPVS fixes for 3.9-rc, they are:
    
    * Restrict IPv6 stateless NPT targets to the mangle table. Many users are
      complaining that this target does not work in the nat table, which is the
      wrong table for it, from Florian Westphal.
    
    * Fix possible use before initialization in the netns init path of several
      conntrack protocol trackers (introduced recently while improving conntrack
      netns support), from Gao Feng.
    
    * Fix incorrect initialization of copy_range in nfnetlink_queue, spotted
      by Eric Dumazet during the NFWS2013, patch from myself.
    
    * Fix wrong calculation of next SCTP chunk in IPVS, from Julian Anastasov.
    
    * Remove rcu_read_lock section in IPVS while calling ipv4_update_pmtu
      not required anymore after change introduced in 3.7, again from Julian.
    
    * Fix SYN looping in IPVS state sync if the backup is used a real server
      in DR/TUN modes, this required a new /proc entry to disable the director
      function when acting as backup, also from Julian.
    
    * Remove leftover IP_NF_QUEUE Kconfig after ip_queue removal, noted by
      Paul Bolle.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7b1b3fd74e3a8a63858fc5382af90d2a19f4afb8
Merge: 112ccff716ae 5a3da1fe9561
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Mar 19 13:20:51 2013 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix ARM BPF JIT handling of negative 'k' values, from Chen Gang.
    
     2) Insufficient space reserved for bridge netlink values, fix from
        Stephen Hemminger.
    
     3) Some dst_neigh_lookup*() callers don't interpret error pointer
        correctly, fix from Zhouyi Zhou.
    
     4) Fix transport match in SCTP active_path loops, from Xugeng Zhang.
    
     5) Fix qeth driver handling of multi-order SKB frags, from Frank
        Blaschka.
    
     6) fec driver is missing napi_disable() call, resulting in crashes on
        unload, from Georg Hofmann.
    
     7) Don't try to handle PMTU events on a listening socket, fix from Eric
        Dumazet.
    
     8) Fix timestamp location calculations in IP option processing, from
        David Ward.
    
     9) FIB_TABLE_HASHSZ setting is not controlled by the correct kconfig
        tests, from Denis V Lunev.
    
    10) Fix TX descriptor push handling in SFC driver, from Ben Hutchings.
    
    11) Fix isdn/hisax and tulip/de4x5 kconfig dependencies, from Arnd
        Bergmann.
    
    12) bnx2x statistics don't handle 4GB rollover correctly, fix from
        Maciej enczykowski.
    
    13) Openvswitch bug fixes for vport del/new error reporting, missing
        genlmsg_end() call in netlink processing, and mis-parsing of
        LLC/SNAP ethernet types.  From Rich Lane.
    
    14) SKB pfmemalloc state should only be propagated from the head page of
        a compound page, fix from Pavel Emelyanov.
    
    15) Fix link handling in tg3 driver for 5715 chips when autonegotation
        is disabled.  From Nithin Sujir.
    
    16) Fix inverted test of cpdma_check_free_tx_desc return value in
        davinci_emac driver, from Mugunthan V N.
    
    17) vlan_depth is incorrectly calculated in skb_network_protocol(), from
        Li RongQing.
    
    18) Fix probing of Gobi 1K devices in qmi_wwan driver, and fix NCM
        device mode backwards compat in cdc_ncm driver.  From Bjrn Mork.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (52 commits)
      inet: limit length of fragment queue hash table bucket lists
      qeth: Fix scatter-gather regression
      qeth: Fix invalid router settings handling
      qeth: delay feature trace
      tcp: dont handle MTU reduction on LISTEN socket
      bnx2x: fix occasional statistics off-by-4GB error
      vhost/net: fix heads usage of ubuf_info
      bridge: Add support for setting BR_ROOT_BLOCK flag.
      bnx2x: add missing napi deletion in error path
      drivers: net: ethernet: ti: davinci_emac: fix usage of cpdma_check_free_tx_desc()
      ethernet/tulip: DE4x5 needs VIRT_TO_BUS
      isdn: hisax: netjet requires VIRT_TO_BUS
      net: cdc_ncm, cdc_mbim: allow user to prefer NCM for backwards compatibility
      rtnetlink: Mask the rta_type when range checking
      Revert "ip_gre: make ipgre_tunnel_xmit() not parse network header as IP unconditionally"
      Fix dst_neigh_lookup/dst_neigh_lookup_skb return value handling bug
      smsc75xx: configuration help incorrectly mentions smsc95xx
      net: fec: fix missing napi_disable call
      net: fec: restart the FEC when PHY speed changes
      skb: Propagate pfmemalloc on skb from head page only
      ...

commit f2815633504b442ca0b0605c16bf3d88a3a0fcea
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Tue Mar 12 15:53:23 2013 +0000

    sctp: Use correct sideffect command in duplicate cookie handling
    
    When SCTP is done processing a duplicate cookie chunk, it tries
    to delete a newly created association.  For that, it has to set
    the right association for the side-effect processing to work.
    However, when it uses the SCTP_CMD_NEW_ASOC command, that performs
    more work then really needed (like hashing the associationa and
    assigning it an id) and there is no point to do that only to
    delete the association as a next step.  In fact, it also creates
    an impossible condition where an association may be found by
    the getsockopt() call, and that association is empty.  This
    causes a crash in some sctp getsockopts.
    
    The solution is rather simple.  We simply use SCTP_CMD_SET_ASOC
    command that doesn't have all the overhead and does exactly
    what we need.
    
    Reported-by: Karl Heiss <kheiss@gmail.com>
    Tested-by: Karl Heiss <kheiss@gmail.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9da060d0ed571bbff434c4a1ef3e48db99a37ee0
Merge: e3b59518c10e aab2b4bf224e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Mar 5 18:42:29 2013 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "A moderately sized pile of fixes, some specifically for merge window
      introduced regressions although others are for longer standing items
      and have been queued up for -stable.
    
      I'm kind of tired of all the RDS protocol bugs over the years, to be
      honest, it's way out of proportion to the number of people who
      actually use it.
    
       1) Fix missing range initialization in netfilter IPSET, from Jozsef
          Kadlecsik.
    
       2) ieee80211_local->tim_lock needs to use BH disabling, from Johannes
          Berg.
    
       3) Fix DMA syncing in SFC driver, from Ben Hutchings.
    
       4) Fix regression in BOND device MAC address setting, from Jiri
          Pirko.
    
       5) Missing usb_free_urb in ISDN Hisax driver, from Marina Makienko.
    
       6) Fix UDP checksumming in bnx2x driver for 57710 and 57711 chips,
          fix from Dmitry Kravkov.
    
       7) Missing cfgspace_lock initialization in BCMA driver.
    
       8) Validate parameter size for SCTP assoc stats getsockopt(), from
          Guenter Roeck.
    
       9) Fix SCTP association hangs, from Lee A Roberts.
    
      10) Fix jumbo frame handling in r8169, from Francois Romieu.
    
      11) Fix phy_device memory leak, from Petr Malat.
    
      12) Omit trailing FCS from frames received in BGMAC driver, from Hauke
          Mehrtens.
    
      13) Missing socket refcount release in L2TP, from Guillaume Nault.
    
      14) sctp_endpoint_init should respect passed in gfp_t, rather than use
          GFP_KERNEL unconditionally.  From Dan Carpenter.
    
      15) Add AISX AX88179 USB driver, from Freddy Xin.
    
      16) Remove MAINTAINERS entries for drivers deleted during the merge
          window, from Cesar Eduardo Barros.
    
      17) RDS protocol can try to allocate huge amounts of memory, check
          that the user's request length makes sense, from Cong Wang.
    
      18) SCTP should use the provided KMALLOC_MAX_SIZE instead of it's own,
          bogus, definition.  From Cong Wang.
    
      19) Fix deadlocks in FEC driver by moving TX reclaim into NAPI poll,
          from Frank Li.  Also, fix a build error introduced in the merge
          window.
    
      20) Fix bogus purging of default routes in ipv6, from Lorenzo Colitti.
    
      21) Don't double count RTT measurements when we leave the TCP receive
          fast path, from Neal Cardwell."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (61 commits)
      tcp: fix double-counted receiver RTT when leaving receiver fast path
      CAIF: fix sparse warning for caif_usb
      rds: simplify a warning message
      net: fec: fix build error in no MXC platform
      net: ipv6: Don't purge default router if accept_ra=2
      net: fec: put tx to napi poll function to fix dead lock
      sctp: use KMALLOC_MAX_SIZE instead of its own MAX_KMALLOC_SIZE
      rds: limit the size allocated by rds_message_alloc()
      MAINTAINERS: remove eexpress
      MAINTAINERS: remove drivers/net/wan/cycx*
      MAINTAINERS: remove 3c505
      caif_dev: fix sparse warnings for caif_flow_cb
      ax88179_178a: ASIX AX88179_178A USB 3.0/2.0 to gigabit ethernet adapter driver
      sctp: use the passed in gfp flags instead GFP_KERNEL
      ipv[4|6]: correct dropwatch false positive in local_deliver_finish
      l2tp: Restore socket refcount when sendmsg succeeds
      net/phy: micrel: Disable asymmetric pause for KSZ9021
      bgmac: omit the fcs
      phy: Fix phy_device_free memory leak
      bnx2x: Fix KR2 work-around condition
      ...

commit d8c6f4b9b7848bca8babfc0ae43a50c8ab22fbb9
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Mar 1 07:44:08 2013 +0000

    ipv[4|6]: correct dropwatch false positive in local_deliver_finish
    
    I had a report recently of a user trying to use dropwatch to localise some frame
    loss, and they were getting false positives.  Turned out they were using a user
    space SCTP stack that used raw sockets to grab frames.  When we don't have a
    registered protocol for a given packet, we record it as a drop, even if a raw
    socket receieves the frame.  We should only record the drop in the event a raw
    socket doesnt exist to receive the frames
    
    Tested by the reported successfully
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: William Reich <reich@ulticom.com>
    Tested-by: William Reich <reich@ulticom.com>
    CC: "David S. Miller" <davem@davemloft.net>
    CC: William Reich <reich@ulticom.com>
    CC: eric.dumazet@gmail.com
    Acked-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8d6d840683228ebded898a865657394981c82aaa
Merge: 726bc6b092da d003b41b8011
Author: David S. Miller <davem@davemloft.net>
Date:   Thu Feb 28 15:34:36 2013 -0500

    Merge branch 'sctp'
    
    Lee A. Roberts says:
    
    ====================
    This series of patches resolves several SCTP association hangs observed during
    SCTP stress testing.  Observable symptoms include communications hangs with
    data being held in the association reassembly and/or lobby (ordering) queues.
    Close examination of reassembly/ordering queues may show either duplicated
    or missing packets.
    
    In version #2, corrected build failure in initial version of patch series
    due to wrong calling sequence for sctp_ulpq_partial_delivery() being inserted
    in sctp_ulpq_renege().
    
    In version #3, adjusted patch documentation to be less repetitive.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d003b41b801124b96337973b01eada6a83673d23
Author: Lee A. Roberts <lee.roberts@hp.com>
Date:   Thu Feb 28 04:37:30 2013 +0000

    sctp: fix association hangs due to partial delivery errors
    
    In sctp_ulpq_tail_data(), use return values 0,1 to indicate whether
    a complete event (with MSG_EOR set) was delivered.  A return value
    of -ENOMEM continues to indicate an out-of-memory condition was
    encountered.
    
    In sctp_ulpq_retrieve_partial() and sctp_ulpq_retrieve_first(),
    correct message reassembly logic for SCTP partial delivery.
    Change logic to ensure that as much data as possible is sent
    with the initial partial delivery and that following partial
    deliveries contain all available data.
    
    In sctp_ulpq_partial_delivery(), attempt partial delivery only
    if the data on the head of the reassembly queue is at or before
    the cumulative TSN ACK point.
    
    In sctp_ulpq_renege(), use the modified return values from
    sctp_ulpq_tail_data() to choose whether to attempt partial
    delivery or to attempt to drain the reassembly queue as a
    means to reduce memory pressure.  Remove call to
    sctp_tsnmap_mark(), as this is handled correctly in call to
    sctp_ulpq_tail_data().
    
    Signed-off-by: Lee A. Roberts <lee.roberts@hp.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>

commit 70fc69bc5a54d9776ace7c99d46eb533f8fb6e89
Author: Lee A. Roberts <lee.roberts@hp.com>
Date:   Thu Feb 28 04:37:27 2013 +0000

    sctp: fix association hangs due to off-by-one errors in sctp_tsnmap_grow()
    
    In sctp_tsnmap_mark(), correct off-by-one error when calculating
    size value for sctp_tsnmap_grow().
    
    In sctp_tsnmap_grow(), correct off-by-one error when copying
    and resizing the tsnmap.  If max_tsn_seen is in the LSB of the
    word, this bit can be lost, causing the corresponding packet
    to be transmitted again and to be entered as a duplicate into
    the SCTP reassembly/ordering queues.  Change parameter name
    from "gap" (zero-based index) to "size" (one-based) to enhance
    code readability.
    
    Signed-off-by: Lee A. Roberts <lee.roberts@hp.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>

commit 726bc6b092da4c093eb74d13c07184b18c1af0f1
Author: Guenter Roeck <linux@roeck-us.net>
Date:   Wed Feb 27 10:57:31 2013 +0000

    net/sctp: Validate parameter size for SCTP_GET_ASSOC_STATS
    
    Building sctp may fail with:
    
    In function copy_from_user,
        inlined from sctp_getsockopt_assoc_stats at
        net/sctp/socket.c:5656:20:
    arch/x86/include/asm/uaccess_32.h:211:26: error: call to
        copy_from_user_overflow declared with attribute error: copy_from_user()
        buffer size is not provably correct
    
    if built with W=1 due to a missing parameter size validation
    before the call to copy_from_user.
    
    Signed-off-by: Guenter Roeck <linux@roeck-us.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 323a72d83c9b2963bd1e46c8e6963e468d4658d7
Merge: 42976ad0b26b 3bdb1a443a53
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Feb 13 12:21:07 2013 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "This is primarily to get those r8169 reverts sorted, but other fixes
      have accumulated meanwhile.
    
       1) Revert two r8169 changes to fix suspend/resume for some users,
          from Francois Romieu.
    
       2) PCI dma mapping errors in atl1c are not checked for and this cause
          hard crashes for some users, from Xiong Huang.
    
       3) In 3.8.x we merged the removal of the EXPERIMENTAL dependency for
          'dlm' but the same patch for 'sctp' got lost somewhere, resulting
          in the potential for build errors since there are cross
          dependencies.  From Kees Cook.
    
       4) SCTP's ipv6 socket route validation makes boolean tests
          incorrectly, fix from Daniel Borkmann.
    
       5) mac80211 does sizeof(ptr) instead of (sizeof(ptr) * nelem), from
          Cong Ding.
    
       6) arp_rcv() can crash on shared non-linear packets, from Eric
          Dumazet.
    
       7) Avoid crashes in macvtap by setting ->gso_type consistently in
          ixgbe, qlcnic, and bnx2x drivers.  From Michael S Tsirkin and
          Alexander Duyck.
    
       8) Trinity fuzzer spots infinite loop in __skb_recv_datagram(), fix
          from Eric Dumazet.
    
       9) STP protocol frames should use high packet priority, otherwise an
          overloaded bridge can get stuck.  From Stephen Hemminger.
    
      10) The HTB packet scheduler was converted some time ago to store
          internal timestamps in nanoseconds, but we don't convert back into
          psched ticks for the user during dumps.  Fix from Jiri Pirko.
    
      11) mwl8k channel table doesn't set the .band field properly,
          resulting in NULL pointer derefs.  Fix from Jonas Gorski.
    
      12) mac80211 doesn't accumulate channels properly during a scan so we
          can downgrade heavily to a much less desirable connection speed.
          Fix from Johannes Berg.
    
      13) PHY probe failure in stmmac can result in resource leaks and
          double MDIO registery later, from Giuseppe CAVALLARO.
    
      14) Correct ipv6 checksumming in ip6t_NPT netfilter module, also fix
          address prefix mangling, from YOSHIFUJI Hideaki."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (27 commits)
      net, sctp: remove CONFIG_EXPERIMENTAL
      net: sctp: sctp_v6_get_dst: fix boolean test in dst cache
      batman-adv: Fix NULL pointer dereference in DAT hash collision avoidance
      net/macb: fix race with RX interrupt while doing NAPI
      atl1c: add error checking for pci_map_single functions
      htb: fix values in opt dump
      ixgbe: Only set gso_type to SKB_GSO_TCPV4 as RSC does not support IPv6
      net: fix infinite loop in __skb_recv_datagram()
      net: qmi_wwan: add Yota / Megafon M100-1 4g modem
      mwl8k: fix band for supported channels
      bridge: set priority of STP packets
      mac80211: fix channel selection bug
      arp: fix possible crash in arp_rcv()
      bnx2x: set gso_type
      qlcnic: set gso_type
      ixgbe: fix gso type
      stmmac: mdio register has to fail if the phy is not found
      stmmac: fix macro used for debugging the xmit
      Revert "r8169: enable internal ASPM and clock request settings".
      Revert "r8169: enable ALDPS for power saving".
      ...

commit e9c0dfbaa28b7c9f5d3482633770cdeec53e3f7b
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Feb 12 13:30:16 2013 +0000

    net: sctp: sctp_v6_get_dst: fix boolean test in dst cache
    
    We walk through the bind address list and try to get the best source
    address for a given destination. However, currently, we take the
    'continue' path of the loop when an entry is invalid (!laddr->valid)
    *and* the entry state does not equal SCTP_ADDR_SRC (laddr->state !=
    SCTP_ADDR_SRC).
    
    Thus, still, invalid entries with SCTP_ADDR_SRC might not 'continue'
    as well as valid entries with SCTP_ADDR_{NEW, SRC, DEL}, with a possible
    false baddr and matchlen as a result, causing in worst case dst route
    to be false or possibly NULL.
    
    This test should actually be a '||' instead of '&&'. But lets fix it
    and make this a bit easier to read by having the condition the same way
    as similarly done in sctp_v4_get_dst.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cfa82e020bc0be6ab9a1e3c186fe41f1e5cecf7a
Merge: 044453b3efdc edb27228db22
Author: David S. Miller <davem@davemloft.net>
Date:   Sun Feb 10 20:44:08 2013 -0500

    Merge branch 'master' of git://1984.lsi.us.es/nf
    
    Pablo Neira Ayuso says:
    
    ====================
    The following patchset contains Netfilter/IPVS fixes for 3.8-rc7, they are:
    
    * Fix oops in IPVS state-sync due to releasing a random memory area due
      to unitialized pointer, from Dan Carpenter.
    
    * Fix SCTP flow establishment due to bad checksumming mangling in IPVS,
      from Daniel Borkmann.
    
    * Three fixes for the recently added IPv6 NPT, all from YOSHIFUJI Hideaki,
      with an amendment collapsed into those patches from Ulrich Weber. They
      fiix adjustment calculation, fix prefix mangling and ensure LSB of
      prefixes are zeroes (as required by RFC).
    
    Specifically, it took me a while to validate the 1's complement arithmetics/
    checksumming approach in the IPv6 NPT code.
    ====================
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e06b84052a0721a4432e5242cf7526d47869b063
Merge: 2a1a6e7af41c a1c83b054ebe
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Feb 9 07:55:24 2013 +1100

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Revert iwlwifi reclaimed packet tracking, it causes problems for a
        bunch of folks.  From Emmanuel Grumbach.
    
     2) Work limiting code in brcmsmac wifi driver can clear tx status
        without processing the event.  From Arend van Spriel.
    
     3) rtlwifi USB driver processes wrong SKB, fix from Larry Finger.
    
     4) l2tp tunnel delete can race with close, fix from Tom Parkin.
    
     5) pktgen_add_device() failures are not checked at all, fix from Cong
        Wang.
    
     6) Fix unintentional removal of carrier off from tun_detach(),
        otherwise we confuse userspace, from Michael S.  Tsirkin.
    
     7) Don't leak socket reference counts and ubufs in vhost-net driver,
        from Jason Wang.
    
     8) vmxnet3 driver gets it's initial carrier state wrong, fix from Neil
        Horman.
    
     9) Protect against USB networking devices which spam the host with 0
        length frames, from Bjrn Mork.
    
    10) Prevent neighbour overflows in ipv6 for locally destined routes,
        from Marcelo Ricardo.  This is the best short-term fix for this, a
        longer term fix has been implemented in net-next.
    
    11) L2TP uses ipv4 datagram routines in it's ipv6 code, whoops.  This
        mistake is largely because the ipv6 functions don't even have some
        kind of prefix in their names to suggest they are ipv6 specific.
        From Tom Parkin.
    
    12) Check SYN packet drops properly in tcp_rcv_fastopen_synack(), from
        Yuchung Cheng.
    
    13) Fix races and TX skb freeing bugs in via-rhine's NAPI support, from
        Francois Romieu and your's truly.
    
    14) Fix infinite loops and divides by zero in TCP congestion window
        handling, from Eric Dumazet, Neal Cardwell, and Ilpo Jrvinen.
    
    15) AF_PACKET tx ring handling can leak kernel memory to userspace, fix
        from Phil Sutter.
    
    16) Fix error handling in ipv6 GRE tunnel transmit, from Tommi Rantala.
    
    17) Protect XEN netback driver against hostile frontend putting garbage
        into the rings, don't leak pages in TX GOP checking, and add proper
        resource releasing in error path of xen_netbk_get_requests().  From
        Ian Campbell.
    
    18) SCTP authentication keys should be cleared out and released with
        kzfree(), from Daniel Borkmann.
    
    19) L2TP is a bit too clever trying to maintain skb->truesize, and ends
        up corrupting socket memory accounting to the point where packet
        sending is halted indefinitely.  Just remove the adjustments
        entirely, they aren't really needed.  From Eric Dumazet.
    
    20) ATM Iphase driver uses a data type with the same name as the S390
        headers, rename to fix the build.  From Heiko Carstens.
    
    21) Fix a typo in copying the inner network header offset from one SKB
        to another, from Pravin B Shelar.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (56 commits)
      net: sctp: sctp_endpoint_free: zero out secret key data
      net: sctp: sctp_setsockopt_auth_key: use kzfree instead of kfree
      atm/iphase: rename fregt_t -> ffreg_t
      net: usb: fix regression from FLAG_NOARP code
      l2tp: dont play with skb->truesize
      net: sctp: sctp_auth_key_put: use kzfree instead of kfree
      netback: correct netbk_tx_err to handle wrap around.
      xen/netback: free already allocated memory on failure in xen_netbk_get_requests
      xen/netback: don't leak pages on failure in xen_netbk_tx_check_gop.
      xen/netback: shutdown the ring if it contains garbage.
      net: qmi_wwan: add more Huawei devices, including E320
      net: cdc_ncm: add another Huawei vendor specific device
      ipv6/ip6_gre: fix error case handling in ip6gre_tunnel_xmit()
      tcp: fix for zero packets_in_flight was too broad
      brcmsmac: rework of mac80211 .flush() callback operation
      ssb: unregister gpios before unloading ssb
      bcma: unregister gpios before unloading bcma
      rtlwifi: Fix scheduling while atomic bug
      net: usbnet: fix tx_dropped statistics
      tcp: ipv6: Update MIB counters for drops
      ...

commit 4b47bc9a9e69141ed3a854c57601f548e82c78ba
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Tue Feb 5 17:21:31 2013 +0100

    ipvs: sctp: fix checksumming on snat and dnat handlers
    
    In our test lab, we have a simple SCTP client connecting to a SCTP
    server via an IPVS load balancer. On some machines, load balancing
    works, but on others the initial handshake just fails, thus no
    SCTP connection whatsoever can be established!
    
    We observed that the SCTP INIT-ACK handshake reply from the IPVS
    machine to the client had a correct IP checksum, but corrupt SCTP
    checksum when forwarded, thus on the client-side the packet was
    dropped and an intial handshake retriggered until all attempts
    run into the void.
    
    To fix this issue, this patch i) adds a missing CHECKSUM_UNNECESSARY
    after the full checksum (re-)calculation (as done in IPVS TCP and UDP
    code as well), ii) calculates the checksum in little-endian format
    (as fixed with the SCTP code in commit 4458f04c: sctp: Clean up sctp
    checksumming code) and iii) refactors duplicate checksum code into a
    common function. Tested by myself.
    
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>

commit 8c98653f05534acd1cb07ea4929702a3659177d1
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Fri Feb 1 04:37:43 2013 +0000

    sctp: sctp_close: fix release of bindings for deferred call_rcu's
    
    It seems due to RCU usage, i.e. within SCTP's address binding list,
    a, say, ``behavioral change'' was introduced which does actually
    not conform to the RFC anymore. In particular consider the following
    (fictional) scenario to demonstrate this:
    
      do:
        Two SOCK_SEQPACKET-style sockets are opened (S1, S2)
        S1 is bound to 127.0.0.1, port 1024 [server]
        S2 is bound to 127.0.0.1, port 1025 [client]
        listen(2) is invoked on S1
        From S2 we call one sendmsg(2) with msg.msg_name and
           msg.msg_namelen parameters set to the server's
           address
        S1, S2 are closed
        goto do
    
    The first pass of this loop passes successful, while the second round
    fails during binding of S1 (address still in use). What is happening?
    In the first round, the initial handshake is being done, and, at the
    time close(2) is called on S1, a non-graceful shutdown is performed via
    ABORT since in S1's receive queue an unprocessed packet is present,
    thus stating an error condition. This can be considered as a correct
    behavior.
    
    During close also all bound addresses are freed, thus nothing *must*
    be active anymore. In reference to RFC2960:
    
      After checking the Verification Tag, the receiving endpoint shall
      remove the association from its record, and shall report the
      termination to its upper layer. (9.1 Abort of an Association)
    
    Also, no half-open states are supported, thus after an ungraceful
    shutdown, we leave nothing behind. However, this seems not to be
    happening though. In a real-world scenario, this is exactly where
    it breaks the lksctp-tools functional test suite, *for instance*:
    
      ./test_sockopt
      test_sockopt.c  1 PASS : getsockopt(SCTP_STATUS) on a socket with no assoc
      test_sockopt.c  2 PASS : getsockopt(SCTP_STATUS)
      test_sockopt.c  3 PASS : getsockopt(SCTP_STATUS) with invalid associd
      test_sockopt.c  4 PASS : getsockopt(SCTP_STATUS) with NULL associd
      test_sockopt.c  5 BROK : bind: Address already in use
    
    The underlying problem is that sctp_endpoint_destroy() hasn't been
    triggered yet while the next bind attempt is being done. It will be
    triggered eventually (but too late) by sctp_transport_destroy_rcu()
    after one RCU grace period:
    
      sctp_transport_destroy()
        sctp_transport_destroy_rcu() ----.
          sctp_association_put() [*]  <--+--> sctp_packet_free()
            sctp_association_destroy()          [...]
              sctp_endpoint_put()                 skb->destructor
                sctp_endpoint_destroy()             sctp_wfree()
                  sctp_bind_addr_free()               sctp_association_put() [*]
    
    Thus, we move out the condition with sctp_association_put() as well as
    the sctp_packet_free() invocation and the issue can be solved. We also
    better free the SCTP chunks first before putting the ref of the association.
    
    With this patch, the example above (which simulates a similar scenario
    as in the implementation of this test case) and therefore also the test
    suite run successfully through. Tested by myself.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 22f837981514e157f8f9737b25ac6d7d90a14006
Merge: 949db153b646 6642f91c92da
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Jan 28 11:41:37 2013 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking updates from David Miller:
     "Much more accumulated than I would have liked due to an unexpected
      bout with a nasty flu:
    
       1) AH and ESP input don't set ECN field correctly because the
          transport head of the SKB isn't set correctly, fix from Li
          RongQing.
    
       2) If netfilter conntrack zones are disabled, we can return an
          uninitialized variable instead of the proper error code.  Fix from
          Borislav Petkov.
    
       3) Fix double SKB free in ath9k driver beacon handling, from Felix
          Feitkau.
    
       4) Remove bogus assumption about netns cleanup ordering in
          nf_conntrack, from Pablo Neira Ayuso.
    
       5) Remove a bogus BUG_ON in the new TCP fastopen code, from Eric
          Dumazet.  It uses spin_is_locked() in it's test and is therefore
          unsuitable for UP.
    
       6) Fix SELINUX labelling regressions added by the tuntap multiqueue
          changes, from Paul Moore.
    
       7) Fix CRC errors with jumbo frame receive in tg3 driver, from Nithin
          Nayak Sujir.
    
       8) CXGB4 driver sets interrupt coalescing parameters only on first
          queue, rather than all of them.  Fix from Thadeu Lima de Souza
          Cascardo.
    
       9) Fix regression in the dispatch of read/write registers in dm9601
          driver, from Tushar Behera.
    
      10) ipv6_append_data miscalculates header length, from Romain KUNTZ.
    
      11) Fix PMTU handling regressions on ipv4 routes, from Steffen
          Klassert, Timo Ters, and Julian Anastasov.
    
      12) In 3c574_cs driver, add necessary parenthesis to "x << y & z"
          expression.  From Nickolai Zeldovich.
    
      13) macvlan_get_size() causes underallocation netlink message space,
          fix from Eric Dumazet.
    
      14) Avoid division by zero in xfrm_replay_advance_bmp(), from Nickolai
          Zeldovich.  Amusingly the zero check was already there, we were
          just performing it after the modulus :-)
    
      15) Some more splice bug fixes from Eric Dumazet, which fix things
          mostly eminating from how we now more aggressively use high-order
          pages in SKBs.
    
      16) Fix size calculation bug when freeing hash tables in the IPSEC
          xfrm code, from Michal Kubecek.
    
      17) Fix PMTU event propagation into socket cached routes, from Steffen
          Klassert.
    
      18) Fix off by one in TX buffer release in netxen driver, from Eric
          Dumazet.
    
      19) Fix rediculous memory allocation requirements introduced by the
          tuntap multiqueue changes, from Jason Wang.
    
      20) Remove bogus AMD platform workaround in r8169 driver that causes
          major problems in normal operation, from Timo Ters.
    
      21) virtio-net set affinity and select queue don't handle
          discontiguous cpu numbers properly, fix from Wanlong Gao.
    
      22) Fix a route refcounting issue in loopback driver, from Eric
          Dumazet.  There's a similar fix coming that we might add to the
          macvlan driver as well.
    
      23) Fix SKB leaks in batman-adv's distributed arp table code, from
          Matthias Schiffer.
    
      24) r8169 driver gives descriptor ownership back the hardware before
          we're done reading the VLAN tag out of it, fix from Francois
          Romieu.
    
      25) Checksums not calculated properly in GRE tunnel driver fix from
          Pravin B Shelar.
    
    26) Fix SCTP memory leak on namespace exit."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (101 commits)
      dm9601: support dm9620 variant
      SCTP: Free the per-net sysctl table on net exit. v2
      net: phy: icplus: fix broken INTR pin settings
      net: phy: icplus: Use the RGMII interface mode to configure clock delays
      IP_GRE: Fix kernel panic in IP_GRE with GRE csum.
      sctp: set association state to established in dupcook_a handler
      ip6mr: limit IPv6 MRT_TABLE identifiers
      r8169: fix vlan tag read ordering.
      net: cdc_ncm: use IAD provided by the USB core
      batman-adv: filter ARP packets with invalid MAC addresses in DAT
      batman-adv: check for more types of invalid IP addresses in DAT
      batman-adv: fix skb leak in batadv_dat_snoop_incoming_arp_reply()
      net: loopback: fix a dst refcounting issue
      virtio-net: reset virtqueue affinity when doing cpu hotplug
      virtio-net: split out clean affinity function
      virtio-net: fix the set affinity bug when CPU IDs are not consecutive
      can: pch_can: fix invalid error codes
      can: ti_hecc: fix invalid error codes
      can: c_can: fix invalid error codes
      r8169: remove the obsolete and incorrect AMD workaround
      ...

commit 5f19d1219a5b96c7b00ad5c3f889030093a8d1a3
Author: Vlad Yasevich <vyasevich@gmail.com>
Date:   Thu Jan 24 11:02:47 2013 -0500

    SCTP: Free the per-net sysctl table on net exit. v2
    
    Per-net sysctl table needs to be explicitly freed at
    net exit.  Otherwise we see the following with kmemleak:
    
    unreferenced object 0xffff880402d08000 (size 2048):
      comm "chrome_sandbox", pid 18437, jiffies 4310887172 (age 9097.630s)
      hex dump (first 32 bytes):
        b2 68 89 81 ff ff ff ff 20 04 04 f8 01 88 ff ff  .h...... .......
        04 00 00 00 a4 01 00 00 00 00 00 00 00 00 00 00  ................
      backtrace:
        [<ffffffff815b4aad>] kmemleak_alloc+0x21/0x3e
        [<ffffffff81110352>] slab_post_alloc_hook+0x28/0x2a
        [<ffffffff81113fad>] __kmalloc_track_caller+0xf1/0x104
        [<ffffffff810f10c2>] kmemdup+0x1b/0x30
        [<ffffffff81571e9f>] sctp_sysctl_net_register+0x1f/0x72
        [<ffffffff8155d305>] sctp_net_init+0x100/0x39f
        [<ffffffff814ad53c>] ops_init+0xc6/0xf5
        [<ffffffff814ad5b7>] setup_net+0x4c/0xd0
        [<ffffffff814ada5e>] copy_net_ns+0x6d/0xd6
        [<ffffffff810938b1>] create_new_namespaces+0xd7/0x147
        [<ffffffff810939f4>] copy_namespaces+0x63/0x99
        [<ffffffff81076733>] copy_process+0xa65/0x1233
        [<ffffffff81077030>] do_fork+0x10b/0x271
        [<ffffffff8100a0e9>] sys_clone+0x23/0x25
        [<ffffffff815dda73>] stub_clone+0x13/0x20
        [<ffffffffffffffff>] 0xffffffffffffffff
    
    I fixed the spelling of sysctl_header so the code actually
    compiles. -- EWB.
    
    Reported-by: Martin Mokrejs <mmokrejs@fold.natur.cuni.cz>
    Signed-off-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9839ff0dead906e85e4d17490aeff87a5859a157
Author: Xufeng Zhang <xufeng.zhang@windriver.com>
Date:   Wed Jan 23 16:44:34 2013 +0000

    sctp: set association state to established in dupcook_a handler
    
    While sctp handling a duplicate COOKIE-ECHO and the action is
    'Association restart', sctp_sf_do_dupcook_a() will processing
    the unexpected COOKIE-ECHO for peer restart, but it does not set
    the association state to SCTP_STATE_ESTABLISHED, so the association
    could stuck in SCTP_STATE_SHUTDOWN_PENDING state forever.
    This violates the sctp specification:
      RFC 4960 5.2.4. Handle a COOKIE ECHO when a TCB Exists
      Action
      A) In this case, the peer may have restarted. .....
         After this, the endpoint shall enter the ESTABLISHED state.
    
    To resolve this problem, adding a SCTP_CMD_NEW_STATE cmd to the
    command list before SCTP_CMD_REPLY cmd, this will set the restart
    association to SCTP_STATE_ESTABLISHED state properly and also avoid
    I-bit being set in the DATA chunk header when COOKIE_ACK is bundled
    with DATA chunks.
    
    Signed-off-by: Xufeng Zhang <xufeng.zhang@windriver.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9b970b952ca4c0294a1fa0031ffaffeef23593ab
Author: Jacek Luczak <difrost.kernel@gmail.com>
Date:   Thu May 19 09:55:13 2011 +0000

    SCTP: fix race between sctp_bind_addr_free() and sctp_bind_addr_conflict()
    
    commit c182f90bc1f22ce5039b8722e45621d5f96862c2 upstream.
    
    During the sctp_close() call, we do not use rcu primitives to
    destroy the address list attached to the endpoint.  At the same
    time, we do the removal of addresses from this list before
    attempting to remove the socket from the port hash
    
    As a result, it is possible for another process to find the socket
    in the port hash that is in the process of being closed.  It then
    proceeds to traverse the address list to find the conflict, only
    to have that address list suddenly disappear without rcu() critical
    section.
    
    Fix issue by closing address list removal inside RCU critical
    section.
    
    Race can result in a kernel crash with general protection fault or
    kernel NULL pointer dereference:
    
    kernel: general protection fault: 0000 [#1] SMP
    kernel: RIP: 0010:[<ffffffffa02f3dde>]  [<ffffffffa02f3dde>] sctp_bind_addr_conflict+0x64/0x82 [sctp]
    kernel: Call Trace:
    kernel:  [<ffffffffa02f415f>] ? sctp_get_port_local+0x17b/0x2a3 [sctp]
    kernel:  [<ffffffffa02f3d45>] ? sctp_bind_addr_match+0x33/0x68 [sctp]
    kernel:  [<ffffffffa02f4416>] ? sctp_do_bind+0xd3/0x141 [sctp]
    kernel:  [<ffffffffa02f5030>] ? sctp_bindx_add+0x4d/0x8e [sctp]
    kernel:  [<ffffffffa02f5183>] ? sctp_setsockopt_bindx+0x112/0x4a4 [sctp]
    kernel:  [<ffffffff81089e82>] ? generic_file_aio_write+0x7f/0x9b
    kernel:  [<ffffffffa02f763e>] ? sctp_setsockopt+0x14f/0xfee [sctp]
    kernel:  [<ffffffff810c11fb>] ? do_sync_write+0xab/0xeb
    kernel:  [<ffffffff810e82ab>] ? fsnotify+0x239/0x282
    kernel:  [<ffffffff810c2462>] ? alloc_file+0x18/0xb1
    kernel:  [<ffffffff8134a0b1>] ? compat_sys_setsockopt+0x1a5/0x1d9
    kernel:  [<ffffffff8134aaf1>] ? compat_sys_socketcall+0x143/0x1a4
    kernel:  [<ffffffff810467dc>] ? sysenter_dispatch+0x7/0x32
    
    Signed-off-by: Jacek Luczak <luczak.jacek@gmail.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    CC: Eric Dumazet <eric.dumazet@gmail.com>
    Reviewed-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

commit 6481bb37fc7ad1f4772014c97f7e054ae9a08981
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    commit 2eebc1e188e9e45886ee00662519849339884d6d upstream.
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

commit b5810b8da2248adc73a1bf3def752d99beb87cca
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Dec 15 10:12:43 2012 +0000

    sctp: jsctp_sf_eat_sack: fix jprobes function signature mismatch
    
    [ Upstream commit 4cb9d6eaf85ecdd266a9a5c6d825c56ca9eefc14 ]
    
    Commit 24cb81a6a (sctp: Push struct net down into all of the
    state machine functions) introduced the net structure into all
    state machine functions, but jsctp_sf_eat_sack was not updated,
    hence when SCTP association probing is enabled in the kernel,
    any simple SCTP client/server program from userspace will panic
    the kernel.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dff343c7f4dfa5650d5d3a78f58f080ec9f14a25
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 22 03:23:16 2012 +0000

    sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
    
    [ Upstream commit 6e51fe7572590d8d86e93b547fab6693d305fd0d ]
    
    Consider the following program, that sets the second argument to the
    sendto() syscall incorrectly:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    We get -ENOMEM:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 ENOMEM (Cannot allocate memory)
    
    Propagate the error code from sctp_user_addto_chunk(), so that we will
    tell user space what actually went wrong:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 EFAULT (Bad address)
    
    Noticed while running Trinity (the syscall fuzzer).
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d0804c62db373041db42aa976edf2b9e5f5ae9ed
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    [ Upstream commit be364c8c0f17a3dd42707b5a090b318028538eb9 ]
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 55fdb80050ce0f4a124d24bb5c6394f8f521260b
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 22 03:23:16 2012 +0000

    sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
    
    [ Upstream commit 6e51fe7572590d8d86e93b547fab6693d305fd0d ]
    
    Consider the following program, that sets the second argument to the
    sendto() syscall incorrectly:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    We get -ENOMEM:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 ENOMEM (Cannot allocate memory)
    
    Propagate the error code from sctp_user_addto_chunk(), so that we will
    tell user space what actually went wrong:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 EFAULT (Bad address)
    
    Noticed while running Trinity (the syscall fuzzer).
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e620776f6cfe4e60acd2f2cec9210934cdb24b17
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    [ Upstream commit be364c8c0f17a3dd42707b5a090b318028538eb9 ]
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 36a25de23359940b7713fc40cbcbb046b3797511
Author: Alex Elder <elder@inktank.com>
Date:   Mon Jan 7 10:47:46 2013 -0600

    sctp: fix Kconfig bug in default cookie hmac selection
    
    Commit 0d0863b02002 ("sctp: Change defaults on cookie hmac selection")
    added a "choice" to the sctp Kconfig file.  It introduced a bug which
    led to an infinite loop when while running "make oldconfig".
    
    The problem is that the wrong symbol was defined as the default value
    for the choice.  Using the correct value gets rid of the infinite loop.
    
    Note:  if CONFIG_SCTP_COOKIE_HMAC_SHA1=y was present in the input
    config file, both that and CONFIG_SCTP_COOKIE_HMAC_MD5=y be present
    in the generated config file.
    
    Signed-off-by: Alex Elder <elder@inktank.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

commit 1d8aa66c08211b4d889b57f42f7b2fa22a2d6291
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 22 03:23:16 2012 +0000

    sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
    
    [ Upstream commit 6e51fe7572590d8d86e93b547fab6693d305fd0d ]
    
    Consider the following program, that sets the second argument to the
    sendto() syscall incorrectly:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    We get -ENOMEM:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 ENOMEM (Cannot allocate memory)
    
    Propagate the error code from sctp_user_addto_chunk(), so that we will
    tell user space what actually went wrong:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 EFAULT (Bad address)
    
    Noticed while running Trinity (the syscall fuzzer).
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ad3c3acb6c2547ae7a16d1247fef33c86b3599d9
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    [ Upstream commit be364c8c0f17a3dd42707b5a090b318028538eb9 ]
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9eb127cc04c4005c8c0708ce92146d91da862b42
Merge: e32795503de0 152a2a8b5e1d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Dec 19 20:29:15 2012 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Really fix tuntap SKB use after free bug, from Eric Dumazet.
    
     2) Adjust SKB data pointer to point past the transport header before
        calling icmpv6_notify() so that the headers are in the state which
        that function expects.  From Duan Jiong.
    
     3) Fix ambiguities in the new tuntap multi-queue APIs.  From Jason
        Wang.
    
     4) mISDN needs to use del_timer_sync(), from Konstantin Khlebnikov.
    
     5) Don't destroy mutex after freeing up device private in mac802154,
        fix also from Konstantin Khlebnikov.
    
     6) Fix INET request socket leak in TCP and DCCP, from Christoph Paasch.
    
     7) SCTP HMAC kconfig rework, from Neil Horman.
    
     8) Fix SCTP jprobes function signature, otherwise things explode, from
        Daniel Borkmann.
    
     9) Fix typo in ipv6-offload Makefile variable reference, from Simon
        Arlott.
    
    10) Don't fail USBNET open just because remote wakeup isn't supported,
        from Oliver Neukum.
    
    11) be2net driver bug fixes from Sathya Perla.
    
    12) SOLOS PCI ATM driver bug fixes from Nathan Williams and David
        Woodhouse.
    
    13) Fix MTU changing regression in 8139cp driver, from John Greene.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (45 commits)
      solos-pci: ensure all TX packets are aligned to 4 bytes
      solos-pci: add firmware upgrade support for new models
      solos-pci: remove superfluous debug output
      solos-pci: add GPIO support for newer versions on Geos board
      8139cp: Prevent dev_close/cp_interrupt race on MTU change
      net: qmi_wwan: add ZTE MF880
      drivers/net: Use of_match_ptr() macro in smsc911x.c
      drivers/net: Use of_match_ptr() macro in smc91x.c
      ipv6: addrconf.c: remove unnecessary "if"
      bridge: Correctly encode addresses when dumping mdb entries
      bridge: Do not unregister all PF_BRIDGE rtnl operations
      use generic usbnet_manage_power()
      usbnet: generic manage_power()
      usbnet: handle PM failure gracefully
      ksz884x: fix receive polling race condition
      qlcnic: update driver version
      qlcnic: fix unused variable warnings
      net: fec: forbid FEC_PTP on SoCs that do not support
      be2net: fix wrong frag_idx reported by RX CQ
      be2net: fix be_close() to ensure all events are ack'ed
      ...

commit 8647f31166b23f82f8ba33b3bf563e9f2bbd8956
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 22 03:23:16 2012 +0000

    sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
    
    [ Upstream commit 6e51fe7572590d8d86e93b547fab6693d305fd0d ]
    
    Consider the following program, that sets the second argument to the
    sendto() syscall incorrectly:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    We get -ENOMEM:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 ENOMEM (Cannot allocate memory)
    
    Propagate the error code from sctp_user_addto_chunk(), so that we will
    tell user space what actually went wrong:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 EFAULT (Bad address)
    
    Noticed while running Trinity (the syscall fuzzer).
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 11b435b090b40a36d3cf1eb45de8eceb012af93f
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    [ Upstream commit be364c8c0f17a3dd42707b5a090b318028538eb9 ]
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4cb9d6eaf85ecdd266a9a5c6d825c56ca9eefc14
Author: Daniel Borkmann <dborkman@redhat.com>
Date:   Sat Dec 15 10:12:43 2012 +0000

    sctp: jsctp_sf_eat_sack: fix jprobes function signature mismatch
    
    Commit 24cb81a6a (sctp: Push struct net down into all of the
    state machine functions) introduced the net structure into all
    state machine functions, but jsctp_sf_eat_sack was not updated,
    hence when SCTP association probing is enabled in the kernel,
    any simple SCTP client/server program from userspace will panic
    the kernel.
    
    Cc: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: Daniel Borkmann <dborkman@redhat.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8d9ea7172edd2e52da26b9485b4c97969a0d2648
Merge: f6e858a00af7 eca2a43bb0d2
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Dec 13 13:20:02 2012 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "A pile of fixes in response to yesterday's big merge.  The SCTP HMAC
      thing hasn't been addressed yet, I'll take care of that myself if Neil
      and Vlad don't show signs of life by tomorrow.
    
       1) Use after free of SKB in tuntap code.  Fix by Eric Dumazet,
          reported by Dave Jones.
    
       2) NFC LLCP code emits annoying kernel log message, triggerable by
          the user.  From Dave Jones.
    
       3) Fix several endianness bugs noticed by sparse in the bridging
          code, from Stephen Hemminger.
    
       4) Ipv6 NDISC code doesn't take padding into account properly, fix
          from YOSHIFUJI Hideaki.
    
       5) Add missing docs to ethtool_flow_ext struct, from Yan Burman."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      bridge: fix icmpv6 endian bug and other sparse warnings
      net: ethool: Document struct ethtool_flow_ext
      ndisc: Fix padding error in link-layer address option.
      tuntap: dont use skb after netif_rx_ni(skb)
      nfc: remove noisy message from llcp_sock_sendmsg

commit 6be35c700f742e911ecedd07fcc43d4439922334
Merge: e37aa63e87bd 520dfe3a3645
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Dec 12 18:07:07 2012 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking changes from David Miller:
    
    1) Allow to dump, monitor, and change the bridge multicast database
       using netlink.  From Cong Wang.
    
    2) RFC 5961 TCP blind data injection attack mitigation, from Eric
       Dumazet.
    
    3) Networking user namespace support from Eric W. Biederman.
    
    4) tuntap/virtio-net multiqueue support by Jason Wang.
    
    5) Support for checksum offload of encapsulated packets (basically,
       tunneled traffic can still be checksummed by HW).  From Joseph
       Gasparakis.
    
    6) Allow BPF filter access to VLAN tags, from Eric Dumazet and
       Daniel Borkmann.
    
    7) Bridge port parameters over netlink and BPDU blocking support
       from Stephen Hemminger.
    
    8) Improve data access patterns during inet socket demux by rearranging
       socket layout, from Eric Dumazet.
    
    9) TIPC protocol updates and cleanups from Ying Xue, Paul Gortmaker, and
       Jon Maloy.
    
    10) Update TCP socket hash sizing to be more in line with current day
        realities.  The existing heurstics were choosen a decade ago.
        From Eric Dumazet.
    
    11) Fix races, queue bloat, and excessive wakeups in ATM and
        associated drivers, from Krzysztof Mazur and David Woodhouse.
    
    12) Support DOVE (Distributed Overlay Virtual Ethernet) extensions
        in VXLAN driver, from David Stevens.
    
    13) Add "oops_only" mode to netconsole, from Amerigo Wang.
    
    14) Support set and query of VEB/VEPA bridge mode via PF_BRIDGE, also
        allow DCB netlink to work on namespaces other than the initial
        namespace.  From John Fastabend.
    
    15) Support PTP in the Tigon3 driver, from Matt Carlson.
    
    16) tun/vhost zero copy fixes and improvements, plus turn it on
        by default, from Michael S. Tsirkin.
    
    17) Support per-association statistics in SCTP, from Michele
        Baldessari.
    
    And many, many, driver updates, cleanups, and improvements.  Too
    numerous to mention individually.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1722 commits)
      net/mlx4_en: Add support for destination MAC in steering rules
      net/mlx4_en: Use generic etherdevice.h functions.
      net: ethtool: Add destination MAC address to flow steering API
      bridge: add support of adding and deleting mdb entries
      bridge: notify mdb changes via netlink
      ndisc: Unexport ndisc_{build,send}_skb().
      uapi: add missing netconf.h to export list
      pkt_sched: avoid requeues if possible
      solos-pci: fix double-free of TX skb in DMA mode
      bnx2: Fix accidental reversions.
      bna: Driver Version Updated to 3.1.2.1
      bna: Firmware update
      bna: Add RX State
      bna: Rx Page Based Allocation
      bna: TX Intr Coalescing Fix
      bna: Tx and Rx Optimizations
      bna: Code Cleanup and Enhancements
      ath9k: check pdata variable before dereferencing it
      ath5k: RX timestamp is reported at end of frame
      ath9k_htc: RX timestamp is reported at end of frame
      ...

commit 258f8667a29d72b1c220065632b39c0faeb061ca
Author: Ying Xue <ying.xue@windriver.com>
Date:   Mon Dec 3 16:12:07 2012 +0800

    tipc: add lock nesting notation to quiet lockdep warning
    
    TIPC accept() call grabs the socket lock on a newly allocated
    socket while holding the socket lock on an old socket. But lockdep
    worries that this might be a recursive lock attempt:
    
      [ INFO: possible recursive locking detected ]
      ---------------------------------------------
      kworker/u:0/6 is trying to acquire lock:
      (sk_lock-AF_TIPC){+.+.+.}, at: [<c8c1226c>] accept+0x15c/0x310 [tipc]
    
      but task is already holding lock:
      (sk_lock-AF_TIPC){+.+.+.}, at: [<c8c12138>] accept+0x28/0x310 [tipc]
    
      other info that might help us debug this:
      Possible unsafe locking scenario:
    
              CPU0
              ----
              lock(sk_lock-AF_TIPC);
              lock(sk_lock-AF_TIPC);
    
              *** DEADLOCK ***
    
      May be due to missing lock nesting notation
      [...]
    
    Tell lockdep that this locking is safe by using lock_sock_nested().
    This is similar to what was done in commit 5131a184a3458d9 for
    SCTP code ("SCTP: lock_sock_nested in sctp_sock_migrate").
    
    Also note that this is isn't something that is seen normally,
    as it was uncovered with some experimental work-in-progress
    code not yet ready for mainline.  So no need for stable
    backports or similar of this commit.
    
    Signed-off-by: Ying Xue <ying.xue@windriver.com>
    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

commit 196d67593439b03088913227093e374235596e33
Author: Michele Baldessari <michele@acksyn.org>
Date:   Sat Dec 1 04:49:42 2012 +0000

    sctp: Add support to per-association statistics via a new SCTP_GET_ASSOC_STATS call
    
    The current SCTP stack is lacking a mechanism to have per association
    statistics. This is an implementation modeled after OpenSolaris'
    SCTP_GET_ASSOC_STATS.
    
    Userspace part will follow on lksctp if/when there is a general ACK on
    this.
    V4:
    - Move ipackets++ before q->immediate.func() for consistency reasons
    - Move sctp_max_rto() at the end of sctp_transport_update_rto() to avoid
      returning bogus RTO values
    - return asoc->rto_min when max_obs_rto value has not changed
    
    V3:
    - Increase ictrlchunks in sctp_assoc_bh_rcv() as well
    - Move ipackets++ to sctp_inq_push()
    - return 0 when no rto updates took place since the last call
    
    V2:
    - Implement partial retrieval of stat struct to cope for future expansion
    - Kill the rtxpackets counter as it cannot be precise anyway
    - Rename outseqtsns to outofseqtsns to make it clearer that these are out
      of sequence unexpected TSNs
    - Move asoc->ipackets++ under a lock to avoid potential miscounts
    - Fold asoc->opackets++ into the already existing asoc check
    - Kill unneeded (q->asoc) test when increasing rtxchunks
    - Do not count octrlchunks if sending failed (SCTP_XMIT_OK != 0)
    - Don't count SHUTDOWNs as SACKs
    - Move SCTP_GET_ASSOC_STATS to the private space API
    - Adjust the len check in sctp_getsockopt_assoc_stats() to allow for
      future struct growth
    - Move association statistics in their own struct
    - Update idupchunks when we send a SACK with dup TSNs
    - return min_rto in max_rto when RTO has not changed. Also return the
      transport when max_rto last changed.
    
    Signed-off: Michele Baldessari <michele@acksyn.org>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ee3f34e857238a4552c68d860348893d7728bcab
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 29 23:17:42 2012 +0000

    sctp: fix CONFIG_SCTP_DBG_MSG=y null pointer dereference in sctp_v6_get_dst()
    
    Trinity (the syscall fuzzer) triggered the following BUG, reproducible
    only when the kernel is configured with CONFIG_SCTP_DBG_MSG=y.
    
    When CONFIG_SCTP_DBG_MSG is not set, the null pointer is never
    dereferenced.
    
    ---[ end trace a4de0bfcb38a3642 ]---
    BUG: unable to handle kernel NULL pointer dereference at 0000000000000100
    IP: [<ffffffff8136796e>] ip6_string+0x1e/0xa0
    PGD 4eead067 PUD 4e472067 PMD 0
    Oops: 0000 [#1] PREEMPT SMP
    Modules linked in:
    CPU 3
    Pid: 21324, comm: trinity-child11 Tainted: G        W    3.7.0-rc7+ #61 ASUSTeK Computer INC. EB1012/EB1012
    RIP: 0010:[<ffffffff8136796e>]  [<ffffffff8136796e>] ip6_string+0x1e/0xa0
    RSP: 0018:ffff88004e4637a0  EFLAGS: 00010046
    RAX: ffff88004e4637da RBX: ffff88004e4637da RCX: 0000000000000000
    RDX: ffffffff8246e92a RSI: 0000000000000100 RDI: ffff88004e4637da
    RBP: ffff88004e4637a8 R08: 000000000000ffff R09: 000000000000ffff
    R10: 0000000000000000 R11: 0000000000000000 R12: ffffffff8289d600
    R13: ffffffff8289d230 R14: ffffffff8246e928 R15: ffffffff8289d600
    FS:  00007fed95153700(0000) GS:ffff88005fd80000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 0000000000000100 CR3: 000000004eeac000 CR4: 00000000000007e0
    DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
    Process trinity-child11 (pid: 21324, threadinfo ffff88004e462000, task ffff8800524b0000)
    Stack:
     ffff88004e4637da ffff88004e463828 ffffffff81368eee 000000004e4637d8
     ffffffff0000ffff ffff88000000ffff 0000000000000000 000000004e4637f8
     ffffffff826285d8 ffff88004e4637f8 0000000000000000 ffff8800524b06b0
    Call Trace:
     [<ffffffff81368eee>] ip6_addr_string.isra.11+0x3e/0xa0
     [<ffffffff81369183>] pointer.isra.12+0x233/0x2d0
     [<ffffffff810a413a>] ? vprintk_emit+0x1ba/0x450
     [<ffffffff8110953d>] ? trace_hardirqs_on_caller+0x10d/0x1a0
     [<ffffffff81369757>] vsnprintf+0x187/0x5d0
     [<ffffffff81369c62>] vscnprintf+0x12/0x30
     [<ffffffff810a4028>] vprintk_emit+0xa8/0x450
     [<ffffffff81e5cb00>] printk+0x49/0x4b
     [<ffffffff81d17221>] sctp_v6_get_dst+0x731/0x780
     [<ffffffff81d16e15>] ? sctp_v6_get_dst+0x325/0x780
     [<ffffffff81d00a96>] sctp_transport_route+0x46/0x120
     [<ffffffff81cff0f1>] sctp_assoc_add_peer+0x161/0x350
     [<ffffffff81d0fd8d>] sctp_sendmsg+0x6cd/0xcb0
     [<ffffffff81b55bf0>] ? inet_create+0x670/0x670
     [<ffffffff81b55cfb>] inet_sendmsg+0x10b/0x220
     [<ffffffff81b55bf0>] ? inet_create+0x670/0x670
     [<ffffffff81a72a64>] ? sock_update_classid+0xa4/0x2b0
     [<ffffffff81a72ab0>] ? sock_update_classid+0xf0/0x2b0
     [<ffffffff81a6ac1c>] sock_sendmsg+0xdc/0xf0
     [<ffffffff8118e9e5>] ? might_fault+0x85/0x90
     [<ffffffff8118e99c>] ? might_fault+0x3c/0x90
     [<ffffffff81a6e12a>] sys_sendto+0xfa/0x130
     [<ffffffff810a9887>] ? do_setitimer+0x197/0x380
     [<ffffffff81e960d5>] ? sysret_check+0x22/0x5d
     [<ffffffff81e960a9>] system_call_fastpath+0x16/0x1b
    Code: 01 eb 89 66 2e 0f 1f 84 00 00 00 00 00 55 48 89 f8 31 c9 48 89 e5 53 eb 12 0f 1f 40 00 48 83 c1 01 48 83 c0 04 48 83 f9 08 74 70 <0f> b6 3c 4e 89 fb 83 e7 0f c0 eb 04 41 89 d8 41 83 e0 0f 0f b6
    RIP  [<ffffffff8136796e>] ip6_string+0x1e/0xa0
     RSP <ffff88004e4637a0>
    CR2: 0000000000000100
    ---[ end trace a4de0bfcb38a3643 ]---
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e9296e89b85604862bd9ec2d54dc43edad775c0d
Merge: 4b05a1c74d1c a45085f6a780
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Nov 28 21:54:07 2012 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
     "Some more fixes trickled in over the past few days:
    
       1) PIM device names can overflow the IFNAMSIZ buffer unless we
          properly limit the allowed indexes, fix from Eric Dumazet.
    
       2) Under heavy load we can OOPS in icmp reply processing due to an
          unchecked inet_putpeer() call.  Fix from Neal Cardwell.
    
       3) SCTP round trip calculations need to use 64-bit math to avoid
          overflows, fix from Schoch Christian.
    
       4) Fix a memory leak and an error return flub in SCTP and IRDA
          triggerable by userspace.  Fix from Tommi Rantala and found by the
          syscall fuzzer (trinity).
    
       5) MLX4 driver gives bogus size to memcpy() call, fix from Amir
          Vadai.
    
       6) Fix length calculation in VHOST descriptor translation, from
          Michael S Tsirkin.
    
       7) Ambassador ATM driver loops forever while loading firmware, fix
          from Dan Carpenter.
    
       8) Over MTU packets in openvswitch warn about wrong device, fix from
          Jesse Gross.
    
       9) Netfilter IPSET's netlink code can overrun a string buffer because
          it's not properly limited to IFNAMSIZ.  Fix from Florian Westphal.
    
      10) PCAN USB driver sets wrong timestamp in SKB, from Oliver Hartkopp.
    
      11) Make sure the RX ifindex always has a valid value in the CAN BCM
          driver, even if we haven't received a frame yet.  Fix also from
          Oliver Hartkopp."
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      team: fix hw_features setup
      atm: forever loop loading ambassador firmware
      vhost: fix length for cross region descriptor
      irda: irttp: fix memory leak in irttp_open_tsap() error path
      net: qmi_wwan: add Huawei E173
      net/mlx4_en: Can set maxrate only for TC0
      sctp: Error in calculation of RTTvar
      sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
      sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
      net: ipmr: limit MRT_TABLE identifiers
      ipv4: avoid passing NULL to inet_putpeer() in icmpv4_xrlim_allow()
      can: bcm: initialize ifindex for timeouts without previous frame reception
      can: peak_usb: fix hwtstamp assignment
      netfilter: ipset: fix netiface set name overflow
      openvswitch: Store flow key len if ARP opcode is not request or reply.
      openvswitch: Print device when warning about over MTU packets.

commit 6e51fe7572590d8d86e93b547fab6693d305fd0d
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Thu Nov 22 03:23:16 2012 +0000

    sctp: fix -ENOMEM result with invalid user space pointer in sendto() syscall
    
    Consider the following program, that sets the second argument to the
    sendto() syscall incorrectly:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    We get -ENOMEM:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 ENOMEM (Cannot allocate memory)
    
    Propagate the error code from sctp_user_addto_chunk(), so that we will
    tell user space what actually went wrong:
    
     $ strace -e sendto ./demo
     sendto(3, NULL, 1, 0, {sa_family=AF_INET, sin_port=htons(11111), sin_addr=inet_addr("127.0.0.1")}, 16) = -1 EFAULT (Bad address)
    
    Noticed while running Trinity (the syscall fuzzer).
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit be364c8c0f17a3dd42707b5a090b318028538eb9
Author: Tommi Rantala <tt.rantala@gmail.com>
Date:   Tue Nov 27 04:01:46 2012 +0000

    sctp: fix memory leak in sctp_datamsg_from_user() when copy from user space fails
    
    Trinity (the syscall fuzzer) discovered a memory leak in SCTP,
    reproducible e.g. with the sendto() syscall by passing invalid
    user space pointer in the second argument:
    
     #include <string.h>
     #include <arpa/inet.h>
     #include <sys/socket.h>
    
     int main(void)
     {
             int fd;
             struct sockaddr_in sa;
    
             fd = socket(AF_INET, SOCK_STREAM, 132 /*IPPROTO_SCTP*/);
             if (fd < 0)
                     return 1;
    
             memset(&sa, 0, sizeof(sa));
             sa.sin_family = AF_INET;
             sa.sin_addr.s_addr = inet_addr("127.0.0.1");
             sa.sin_port = htons(11111);
    
             sendto(fd, NULL, 1, 0, (struct sockaddr *)&sa, sizeof(sa));
    
             return 0;
     }
    
    As far as I can tell, the leak has been around since ~2003.
    
    Signed-off-by: Tommi Rantala <tt.rantala@gmail.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f1d2d8a9f14c93996ebeb28e1da98b4eb025f88b
Author: Zijie Pan <zijie.pan@6wind.com>
Date:   Mon Oct 15 03:56:39 2012 +0000

    sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
    
    [ Upstream commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec ]
    
    Bug introduced by commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
    (sctp: check src addr when processing SACK to update transport state)
    
    Signed-off-by: Zijie Pan <zijie.pan@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c2f5b7507ac5d808f29287d77ee6148358d7fbfe
Author: Zijie Pan <zijie.pan@6wind.com>
Date:   Mon Oct 15 03:56:39 2012 +0000

    sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
    
    [ Upstream commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec ]
    
    Bug introduced by commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
    (sctp: check src addr when processing SACK to update transport state)
    
    Signed-off-by: Zijie Pan <zijie.pan@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b23270416da409bd4e637a5acbe31a1126235fb6
Author: Zijie Pan <zijie.pan@6wind.com>
Date:   Mon Oct 15 03:56:39 2012 +0000

    sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
    
    [ Upstream commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec ]
    
    Bug introduced by commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
    (sctp: check src addr when processing SACK to update transport state)
    
    Signed-off-by: Zijie Pan <zijie.pan@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit de77b7955c3985ca95f64af3cb10557eb17eacee
Author: Zijie Pan <zijie.pan@6wind.com>
Date:   Mon Oct 15 03:56:39 2012 +0000

    sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
    
    [ Upstream commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec ]
    
    Bug introduced by commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
    (sctp: check src addr when processing SACK to update transport state)
    
    Signed-off-by: Zijie Pan <zijie.pan@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b26ddd813031666293c95e84c997eb8b1f97bd38
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Oct 29 08:32:13 2012 +0000

    sctp: Clean up type-punning in sctp_cmd_t union
    
    Lots of points in the sctp_cmd_interpreter function treat the sctp_cmd_t arg as
    a void pointer, even though they are written as various other types.  Theres no
    need for this as doing so just leads to possible type-punning issues that could
    cause crashes, and if we remain type-consistent we can actually just remove the
    void * member of the union entirely.
    
    Change Notes:
    
    v2)
            * Dropped chunk that modified SCTP_NULL to create a marker pattern
             should anyone try to use a SCTP_NULL() assigned sctp_arg_t, Assigning
             to .zero provides the same effect and should be faster, per Vlad Y.
    
    v3)
            * Reverted part of V2, opting to use memset instead of .zero, so that
             the entire union is initalized thus avoiding the i164 speculative load
             problems previously encountered, per Dave M..  Also rewrote
             SCTP_[NO]FORCE so as to use common infrastructure a little more
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: "David S. Miller" <davem@davemloft.net>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 02c38d0a0b7b973911e66d38e369d0fcfce2c186
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Oct 24 09:26:51 2012 +0000

    MAINTAINERS: Add myself to list of SCTP maintainers
    
    I've been messing with the code for a bit, and I figured Vlad could use a hand
    as interest in the protocol has picked up over the last year or so.  I've asked
    him, and he doesn't seem too upset over the idea :)
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: "David S. Miller" <davem@davemloft.net>
    CC: linux-sctp@vger.kernel.org
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 18673533256a2953ccefded52df2679de8640685
Merge: ccbfddb78c7b 9f0d3c2781ba
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 17 12:41:18 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Fix regression in /proc/net/if_inet6, sometimes devices do not get
        listed.  From Eric Dumazet.
    
     2) Add IPSEC networking sub-section to MAINTAINERS.
    
     3) S390 networking fixes from Hendrik Brueckner and Stefan Raspl.
    
     4) Fix enslavement of devices that can't do VLAN properly, from Jiri
        Pirko.
    
     5) SCTP sack handling fix from Zijie Pan.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net:
      ipv6: addrconf: fix /proc/net/if_inet6
      bnx2x: fix handling mf storage modes
      qeth: fix deadlock between recovery and bonding driver
      smsgiucv: reestablish IUCV path after resume
      sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
      vlan: fix bond/team enslave of vlan challenged slave/port
      MAINTAINERS: Add explicit section for IPSEC networking.

commit f6e80abeab928b7c47cc1fbf53df13b4398a2bec
Author: Zijie Pan <zijie.pan@6wind.com>
Date:   Mon Oct 15 03:56:39 2012 +0000

    sctp: fix call to SCTP_CMD_PROCESS_SACK in sctp_cmd_interpreter()
    
    Bug introduced by commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
    (sctp: check src addr when processing SACK to update transport state)
    
    Signed-off-by: Zijie Pan <zijie.pan@6wind.com>
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5359d302651d6f3a1b9b70863e531b8b6815ba01
Author: Thomas Graf <tgraf@suug.ch>
Date:   Mon Sep 3 04:27:42 2012 +0000

    sctp: Don't charge for data in sndbuf again when transmitting packet
    
    [ Upstream commit 4c3a5bdae293f75cdf729c6c00124e8489af2276 ]
    
    SCTP charges wmem_alloc via sctp_set_owner_w() in sctp_sendmsg() and via
    skb_set_owner_w() in sctp_packet_transmit(). If a sender runs out of
    sndbuf it will sleep in sctp_wait_for_sndbuf() and expects to be waken up
    by __sctp_write_space().
    
    Buffer space charged via sctp_set_owner_w() is released in sctp_wfree()
    which calls __sctp_write_space() directly.
    
    Buffer space charged via skb_set_owner_w() is released via sock_wfree()
    which calls sk->sk_write_space() _if_ SOCK_USE_WRITE_QUEUE is not set.
    sctp_endpoint_init() sets SOCK_USE_WRITE_QUEUE on all sockets.
    
    Therefore if sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again unless it is
    interrupted by a signal.
    
    This could be fixed by clearing the SOCK_USE_WRITE_QUEUE flag but ...
    
    Charging for the data twice does not make sense in the first place, it
    leads to overcharging sndbuf by a factor 2. Therefore this patch only
    charges a single byte in wmem_alloc when transmitting an SCTP packet to
    ensure that the socket stays alive until the packet has been released.
    
    This means that control chunks are no longer accounted for in wmem_alloc
    which I believe is not a problem as skb->truesize will typically lead
    to overcharging anyway and thus compensates for any control overhead.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    CC: Vlad Yasevich <vyasevic@redhat.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: David Miller <davem@davemloft.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8d16c6268b7c3af2ce4f58de903588489e037fcf
Author: Thomas Graf <tgraf@suug.ch>
Date:   Mon Sep 3 04:27:42 2012 +0000

    sctp: Don't charge for data in sndbuf again when transmitting packet
    
    [ Upstream commit 4c3a5bdae293f75cdf729c6c00124e8489af2276 ]
    
    SCTP charges wmem_alloc via sctp_set_owner_w() in sctp_sendmsg() and via
    skb_set_owner_w() in sctp_packet_transmit(). If a sender runs out of
    sndbuf it will sleep in sctp_wait_for_sndbuf() and expects to be waken up
    by __sctp_write_space().
    
    Buffer space charged via sctp_set_owner_w() is released in sctp_wfree()
    which calls __sctp_write_space() directly.
    
    Buffer space charged via skb_set_owner_w() is released via sock_wfree()
    which calls sk->sk_write_space() _if_ SOCK_USE_WRITE_QUEUE is not set.
    sctp_endpoint_init() sets SOCK_USE_WRITE_QUEUE on all sockets.
    
    Therefore if sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again unless it is
    interrupted by a signal.
    
    This could be fixed by clearing the SOCK_USE_WRITE_QUEUE flag but ...
    
    Charging for the data twice does not make sense in the first place, it
    leads to overcharging sndbuf by a factor 2. Therefore this patch only
    charges a single byte in wmem_alloc when transmitting an SCTP packet to
    ensure that the socket stays alive until the packet has been released.
    
    This means that control chunks are no longer accounted for in wmem_alloc
    which I believe is not a problem as skb->truesize will typically lead
    to overcharging anyway and thus compensates for any control overhead.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    CC: Vlad Yasevich <vyasevic@redhat.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: David Miller <davem@davemloft.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 126268e1d7790725c2bb0e394652c70ced6ee2ea
Author: Thomas Graf <tgraf@suug.ch>
Date:   Mon Sep 3 04:27:42 2012 +0000

    sctp: Don't charge for data in sndbuf again when transmitting packet
    
    [ Upstream commit 4c3a5bdae293f75cdf729c6c00124e8489af2276 ]
    
    SCTP charges wmem_alloc via sctp_set_owner_w() in sctp_sendmsg() and via
    skb_set_owner_w() in sctp_packet_transmit(). If a sender runs out of
    sndbuf it will sleep in sctp_wait_for_sndbuf() and expects to be waken up
    by __sctp_write_space().
    
    Buffer space charged via sctp_set_owner_w() is released in sctp_wfree()
    which calls __sctp_write_space() directly.
    
    Buffer space charged via skb_set_owner_w() is released via sock_wfree()
    which calls sk->sk_write_space() _if_ SOCK_USE_WRITE_QUEUE is not set.
    sctp_endpoint_init() sets SOCK_USE_WRITE_QUEUE on all sockets.
    
    Therefore if sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again unless it is
    interrupted by a signal.
    
    This could be fixed by clearing the SOCK_USE_WRITE_QUEUE flag but ...
    
    Charging for the data twice does not make sense in the first place, it
    leads to overcharging sndbuf by a factor 2. Therefore this patch only
    charges a single byte in wmem_alloc when transmitting an SCTP packet to
    ensure that the socket stays alive until the packet has been released.
    
    This means that control chunks are no longer accounted for in wmem_alloc
    which I believe is not a problem as skb->truesize will typically lead
    to overcharging anyway and thus compensates for any control overhead.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    CC: Vlad Yasevich <vyasevic@redhat.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: David Miller <davem@davemloft.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 73eca9b3aa5b1a756c4f3ff400285e8fa4433c59
Author: Thomas Graf <tgraf@suug.ch>
Date:   Mon Sep 3 04:27:42 2012 +0000

    sctp: Don't charge for data in sndbuf again when transmitting packet
    
    [ Upstream commit 4c3a5bdae293f75cdf729c6c00124e8489af2276 ]
    
    SCTP charges wmem_alloc via sctp_set_owner_w() in sctp_sendmsg() and via
    skb_set_owner_w() in sctp_packet_transmit(). If a sender runs out of
    sndbuf it will sleep in sctp_wait_for_sndbuf() and expects to be waken up
    by __sctp_write_space().
    
    Buffer space charged via sctp_set_owner_w() is released in sctp_wfree()
    which calls __sctp_write_space() directly.
    
    Buffer space charged via skb_set_owner_w() is released via sock_wfree()
    which calls sk->sk_write_space() _if_ SOCK_USE_WRITE_QUEUE is not set.
    sctp_endpoint_init() sets SOCK_USE_WRITE_QUEUE on all sockets.
    
    Therefore if sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again unless it is
    interrupted by a signal.
    
    This could be fixed by clearing the SOCK_USE_WRITE_QUEUE flag but ...
    
    Charging for the data twice does not make sense in the first place, it
    leads to overcharging sndbuf by a factor 2. Therefore this patch only
    charges a single byte in wmem_alloc when transmitting an SCTP packet to
    ensure that the socket stays alive until the packet has been released.
    
    This means that control chunks are no longer accounted for in wmem_alloc
    which I believe is not a problem as skb->truesize will typically lead
    to overcharging anyway and thus compensates for any control overhead.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    CC: Vlad Yasevich <vyasevic@redhat.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: David Miller <davem@davemloft.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 4c356cbc966496507ecb979e38dc5dfccb7656f7
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    [ Upstream commit 2eebc1e188e9e45886ee00662519849339884d6d ]
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit edfee0339e681a784ebacec7e8c2dc97dc6d2839
Author: Nicolas Dichtel <nicolas.dichtel@6wind.com>
Date:   Wed Oct 3 05:43:22 2012 +0000

    sctp: check src addr when processing SACK to update transport state
    
    Suppose we have an SCTP connection with two paths. After connection is
    established, path1 is not available, thus this path is marked as inactive. Then
    traffic goes through path2, but for some reasons packets are delayed (after
    rto.max). Because packets are delayed, the retransmit mechanism will switch
    again to path1. At this time, we receive a delayed SACK from path2. When we
    update the state of the path in sctp_check_transmitted(), we do not take into
    account the source address of the SACK, hence we update the wrong path.
    
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit aecdc33e111b2c447b622e287c6003726daa1426
Merge: a20acf99f75e a3a6cab5ea10
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Oct 2 13:38:27 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next
    
    Pull networking changes from David Miller:
    
     1) GRE now works over ipv6, from Dmitry Kozlov.
    
     2) Make SCTP more network namespace aware, from Eric Biederman.
    
     3) TEAM driver now works with non-ethernet devices, from Jiri Pirko.
    
     4) Make openvswitch network namespace aware, from Pravin B Shelar.
    
     5) IPV6 NAT implementation, from Patrick McHardy.
    
     6) Server side support for TCP Fast Open, from Jerry Chu and others.
    
     7) Packet BPF filter supports MOD and XOR, from Eric Dumazet and Daniel
        Borkmann.
    
     8) Increate the loopback default MTU to 64K, from Eric Dumazet.
    
     9) Use a per-task rather than per-socket page fragment allocator for
        outgoing networking traffic.  This benefits processes that have very
        many mostly idle sockets, which is quite common.
    
        From Eric Dumazet.
    
    10) Use up to 32K for page fragment allocations, with fallbacks to
        smaller sizes when higher order page allocations fail.  Benefits are
        a) less segments for driver to process b) less calls to page
        allocator c) less waste of space.
    
        From Eric Dumazet.
    
    11) Allow GRO to be used on GRE tunnels, from Eric Dumazet.
    
    12) VXLAN device driver, one way to handle VLAN issues such as the
        limitation of 4096 VLAN IDs yet still have some level of isolation.
        From Stephen Hemminger.
    
    13) As usual there is a large boatload of driver changes, with the scale
        perhaps tilted towards the wireless side this time around.
    
    Fix up various fairly trivial conflicts, mostly caused by the user
    namespace changes.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next: (1012 commits)
      hyperv: Add buffer for extended info after the RNDIS response message.
      hyperv: Report actual status in receive completion packet
      hyperv: Remove extra allocated space for recv_pkt_list elements
      hyperv: Fix page buffer handling in rndis_filter_send_request()
      hyperv: Fix the missing return value in rndis_filter_set_packet_filter()
      hyperv: Fix the max_xfer_size in RNDIS initialization
      vxlan: put UDP socket in correct namespace
      vxlan: Depend on CONFIG_INET
      sfc: Fix the reported priorities of different filter types
      sfc: Remove EFX_FILTER_FLAG_RX_OVERRIDE_IP
      sfc: Fix loopback self-test with separate_tx_channels=1
      sfc: Fix MCDI structure field lookup
      sfc: Add parentheses around use of bitfield macro arguments
      sfc: Fix null function pointer in efx_sriov_channel_type
      vxlan: virtual extensible lan
      igmp: export symbol ip_mc_leave_group
      netlink: add attributes to fdb interface
      tg3: unconditionally select HWMON support when tg3 is enabled.
      Revert "net: ti cpsw ethernet: allow reading phy interface mode from DT"
      gre: fix sparse warning
      ...

commit a1362d504e26f32f853c65d0448ebc9ffb190f7d
Merge: 4bca55d3d93c 6af773e786ad
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Sep 14 15:34:07 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) Use after free and new device IDs in bluetooth from Andre Guedes,
        Yevgeniy Melnichuk, Gustavo Padovan, and Henrik Rydberg.
    
     2) Fix crashes with short packet lengths and VLAN in pktgen, from
        Nishank Trivedi.
    
     3) mISDN calls flush_work_sync() with locks held, fix from Karsten
        Keil.
    
     4) Packet scheduler gred parameters are reported to userspace
        improperly scaled, and WRED idling is not performed correctly.  All
        from David Ward.
    
     5) Fix TCP socket refcount problem in ipv6, from Julian Anastasov.
    
     6) ibmveth device has RX queue alignment requirements which are not
        being explicitly met resulting in sporadic failures, fix from
        Santiago Leon.
    
     7) Netfilter needs to take care when interpreting sockets attached to
        socket buffers, they could be time-wait minisockets.  Fix from Eric
        Dumazet.
    
     8) sock_edemux() has the same issue as netfilter did in #7 above, fix
        from Eric Dumazet.
    
     9) Avoid infinite loops in CBQ scheduler with some configurations, from
        Eric Dumazet.
    
    10) Deal with "Reflection scan: an Off-Path Attack on TCP", from Jozsef
        Kadlecsik.
    
    11) SCTP overcharges socket for TX packets, fix from Thomas Graf.
    
    12) CODEL packet scheduler should not reset it's state every time it
        builds a new flow, fix from Eric Dumazet.
    
    13) Fix memory leak in nl80211, from Wei Yongjun.
    
    14) NETROM doesn't check skb_copy_datagram_iovec() return values, from
        Alan Cox.
    
    15) l2tp ethernet was using sizeof(ETH_HLEN) instead of plain ETH_HLEN,
        oops.  From Eric Dumazet.
    
    16) Fix selection of ath9k chips on which PA linearization and AM2PM
        predistoration are used, from Felix Fietkau.
    
    17) Flow steering settings in mlx4 driver need to be validated properly,
        from Hadar Hen Zion.
    
    18) bnx2x doesn't show the correct link duplex setting, from Yaniv
        Rosner.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (75 commits)
      pktgen: fix crash with vlan and packet size less than 46
      bnx2x: Add missing afex code
      bnx2x: fix registers dumped
      bnx2x: correct advertisement of pause capabilities
      bnx2x: display the correct duplex value
      bnx2x: prevent timeouts when using PFC
      bnx2x: fix stats copying logic
      bnx2x: Avoid sending multiple statistics queries
      net: qmi_wwan: call subdriver with control intf only
      net_sched: gred: actually perform idling in WRED mode
      net_sched: gred: fix qave reporting via netlink
      net_sched: gred: eliminate redundant DP prio comparisons
      net_sched: gred: correct comment about qavg calculation in RIO mode
      mISDN: Fix wrong usage of flush_work_sync while holding locks
      netfilter: log: Fix log-level processing
      net-sched: sch_cbq: avoid infinite loop
      net: qmi_wwan: fix Gobi device probing for un2430
      net: fix net/core/sock.c build error
      ixp4xx_hss: fix build failure due to missing linux/module.h inclusion
      caif: move the dereference below the NULL test
      ...

commit 4c3a5bdae293f75cdf729c6c00124e8489af2276
Author: Thomas Graf <tgraf@suug.ch>
Date:   Mon Sep 3 04:27:42 2012 +0000

    sctp: Don't charge for data in sndbuf again when transmitting packet
    
    SCTP charges wmem_alloc via sctp_set_owner_w() in sctp_sendmsg() and via
    skb_set_owner_w() in sctp_packet_transmit(). If a sender runs out of
    sndbuf it will sleep in sctp_wait_for_sndbuf() and expects to be waken up
    by __sctp_write_space().
    
    Buffer space charged via sctp_set_owner_w() is released in sctp_wfree()
    which calls __sctp_write_space() directly.
    
    Buffer space charged via skb_set_owner_w() is released via sock_wfree()
    which calls sk->sk_write_space() _if_ SOCK_USE_WRITE_QUEUE is not set.
    sctp_endpoint_init() sets SOCK_USE_WRITE_QUEUE on all sockets.
    
    Therefore if sctp_packet_transmit() manages to queue up more than sndbuf
    bytes, sctp_wait_for_sndbuf() will never be woken up again unless it is
    interrupted by a signal.
    
    This could be fixed by clearing the SOCK_USE_WRITE_QUEUE flag but ...
    
    Charging for the data twice does not make sense in the first place, it
    leads to overcharging sndbuf by a factor 2. Therefore this patch only
    charges a single byte in wmem_alloc when transmitting an SCTP packet to
    ensure that the socket stays alive until the packet has been released.
    
    This means that control chunks are no longer accounted for in wmem_alloc
    which I believe is not a problem as skb->truesize will typically lead
    to overcharging anyway and thus compensates for any control overhead.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    CC: Vlad Yasevich <vyasevic@redhat.com>
    CC: Neil Horman <nhorman@tuxdriver.com>
    CC: David Miller <davem@davemloft.net>
    Acked-by: Vlad Yasevich <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e44b8b47d096751cb15a81b4c0f83a05fc1f49c8
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    [ Upstream commit 2eebc1e188e9e45886ee00662519849339884d6d ]
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2936d35db07cc3c9e3f2d60ed90f9a72f2031130
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    [ Upstream commit 2eebc1e188e9e45886ee00662519849339884d6d ]
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f1377fddb346729aa2fe9cdbfc54aaf2ca463bd5
Author: Al Viro <viro@ZenIV.linux.org.uk>
Date:   Sat Jul 21 08:55:18 2012 +0100

    iscsi-target: Drop bogus struct file usage for iSCSI/SCTP
    
    commit bf6932f44a7b3fa7e2246a8b18a44670e5eab6c2 upstream.
    
    From Al Viro:
    
            BTW, speaking of struct file treatment related to sockets -
            there's this piece of code in iscsi:
            /*
             * The SCTP stack needs struct socket->file.
             */
            if ((np->np_network_transport == ISCSI_SCTP_TCP) ||
                (np->np_network_transport == ISCSI_SCTP_UDP)) {
                    if (!new_sock->file) {
                            new_sock->file = kzalloc(
                                            sizeof(struct file), GFP_KERNEL);
    
    For one thing, as far as I can see it'not true - sctp does *not* depend on
    socket->file being non-NULL; it does, in one place, check socket->file->f_flags
    for O_NONBLOCK, but there it treats NULL socket->file as "flag not set".
    Which is the case here anyway - the fake struct file created in
    __iscsi_target_login_thread() (and in iscsi_target_setup_login_socket(), with
    the same excuse) do *not* get that flag set.
    
    Moreover, it's a bloody serious violation of a bunch of asserts in VFS;
    all struct file instances should come from filp_cachep, via get_empty_filp()
    (or alloc_file(), which is a wrapper for it).  FWIW, I'm very tempted to
    do this and be done with the entire mess:
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Andy Grover <agrover@redhat.com>
    Cc: Hannes Reinecke <hare@suse.de>
    Cc: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2f890d2777247beb207be1c99835a0c5e09d340c
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    [ Upstream commit 2eebc1e188e9e45886ee00662519849339884d6d ]
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d2dcab7be28c5431ac85bc88face77fcb91503d5
Author: Al Viro <viro@ZenIV.linux.org.uk>
Date:   Sat Jul 21 08:55:18 2012 +0100

    iscsi-target: Drop bogus struct file usage for iSCSI/SCTP
    
    commit bf6932f44a7b3fa7e2246a8b18a44670e5eab6c2 upstream.
    
    From Al Viro:
    
            BTW, speaking of struct file treatment related to sockets -
            there's this piece of code in iscsi:
            /*
             * The SCTP stack needs struct socket->file.
             */
            if ((np->np_network_transport == ISCSI_SCTP_TCP) ||
                (np->np_network_transport == ISCSI_SCTP_UDP)) {
                    if (!new_sock->file) {
                            new_sock->file = kzalloc(
                                            sizeof(struct file), GFP_KERNEL);
    
    For one thing, as far as I can see it'not true - sctp does *not* depend on
    socket->file being non-NULL; it does, in one place, check socket->file->f_flags
    for O_NONBLOCK, but there it treats NULL socket->file as "flag not set".
    Which is the case here anyway - the fake struct file created in
    __iscsi_target_login_thread() (and in iscsi_target_setup_login_socket(), with
    the same excuse) do *not* get that flag set.
    
    Moreover, it's a bloody serious violation of a bunch of asserts in VFS;
    all struct file instances should come from filp_cachep, via get_empty_filp()
    (or alloc_file(), which is a wrapper for it).  FWIW, I'm very tempted to
    do this and be done with the entire mess:
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Andy Grover <agrover@redhat.com>
    Cc: Hannes Reinecke <hare@suse.de>
    Cc: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e87ebd5357b62b81c70d36c79b1945b45c4c8404
Author: Al Viro <viro@ZenIV.linux.org.uk>
Date:   Sat Jul 21 08:55:18 2012 +0100

    iscsi-target: Drop bogus struct file usage for iSCSI/SCTP
    
    commit bf6932f44a7b3fa7e2246a8b18a44670e5eab6c2 upstream.
    
    From Al Viro:
    
            BTW, speaking of struct file treatment related to sockets -
            there's this piece of code in iscsi:
            /*
             * The SCTP stack needs struct socket->file.
             */
            if ((np->np_network_transport == ISCSI_SCTP_TCP) ||
                (np->np_network_transport == ISCSI_SCTP_UDP)) {
                    if (!new_sock->file) {
                            new_sock->file = kzalloc(
                                            sizeof(struct file), GFP_KERNEL);
    
    For one thing, as far as I can see it'not true - sctp does *not* depend on
    socket->file being non-NULL; it does, in one place, check socket->file->f_flags
    for O_NONBLOCK, but there it treats NULL socket->file as "flag not set".
    Which is the case here anyway - the fake struct file created in
    __iscsi_target_login_thread() (and in iscsi_target_setup_login_socket(), with
    the same excuse) do *not* get that flag set.
    
    Moreover, it's a bloody serious violation of a bunch of asserts in VFS;
    all struct file instances should come from filp_cachep, via get_empty_filp()
    (or alloc_file(), which is a wrapper for it).  FWIW, I'm very tempted to
    do this and be done with the entire mess:
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Andy Grover <agrover@redhat.com>
    Cc: Hannes Reinecke <hare@suse.de>
    Cc: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit cb47c1831fa406c964468b259f2082c16cc3f757
Merge: 4d460fd3abf9 bf6932f44a7b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sun Jul 22 13:31:57 2012 -0700

    Merge branch 'for-next' of git://git.kernel.org/pub/scm/linux/kernel/git/nab/target-pending
    
    Pull target updates from Nicholas Bellinger:
     "There have been lots of work in a number of areas this past round.
      The highlights include:
    
       - Break out target_core_cdb.c emulation into SPC/SBC ops (hch)
       - Add a parse_cdb method to target backend drivers (hch)
       - Move sync_cache + write_same + unmap into spc_ops (hch)
       - Use target_execute_cmd for WRITEs in iscsi_target + srpt (hch)
       - Offload WRITE I/O backend submission in tcm_qla2xxx + tcm_fc (hch +
         nab)
       - Refactor core_update_device_list_for_node() into enable/disable
         funcs (agrover)
       - Replace the TCM processing thread with a TMR work queue (hch)
       - Fix regression in transport_add_device_to_core_hba from TMR
         conversion (DanC)
       - Remove racy, now-redundant check of sess_tearing_down with qla2xxx
         (roland)
       - Add range checking, fix reading of data len + possible underflow in
         UNMAP (roland)
       - Allow for target_submit_cmd() returning errors + convert fabrics
         (roland + nab)
       - Drop bogus struct file usage for iSCSI/SCTP (viro)"
    
    * 'for-next' of git://git.kernel.org/pub/scm/linux/kernel/git/nab/target-pending: (54 commits)
      iscsi-target: Drop bogus struct file usage for iSCSI/SCTP
      target: NULL dereference on error path
      target: Allow for target_submit_cmd() returning errors
      target: Check number of unmap descriptors against our limit
      target: Fix possible integer underflow in UNMAP emulation
      target: Fix reading of data length fields for UNMAP commands
      target: Add range checking to UNMAP emulation
      target: Add generation of LOGICAL BLOCK ADDRESS OUT OF RANGE
      target: Make unnecessarily global se_dev_align_max_sectors() static
      target: Remove se_session.sess_wait_list
      qla2xxx: Remove racy, now-redundant check of sess_tearing_down
      target: Check sess_tearing_down in target_get_sess_cmd()
      sbp-target: Consolidate duplicated error path code in sbp_handle_command()
      target: Un-export target_get_sess_cmd()
      qla2xxx: Get rid of redundant qla_tgt_sess.tearing_down
      target: Make core_disable_device_list_for_node use pre-refactoring lock ordering
      target: refactor core_update_device_list_for_node()
      target: Eliminate else using boolean logic
      target: Misc retval cleanups
      target: Remove hba param from core_dev_add_lun
      ...

commit bf6932f44a7b3fa7e2246a8b18a44670e5eab6c2
Author: Al Viro <viro@ZenIV.linux.org.uk>
Date:   Sat Jul 21 08:55:18 2012 +0100

    iscsi-target: Drop bogus struct file usage for iSCSI/SCTP
    
    From Al Viro:
    
            BTW, speaking of struct file treatment related to sockets -
            there's this piece of code in iscsi:
            /*
             * The SCTP stack needs struct socket->file.
             */
            if ((np->np_network_transport == ISCSI_SCTP_TCP) ||
                (np->np_network_transport == ISCSI_SCTP_UDP)) {
                    if (!new_sock->file) {
                            new_sock->file = kzalloc(
                                            sizeof(struct file), GFP_KERNEL);
    
    For one thing, as far as I can see it'not true - sctp does *not* depend on
    socket->file being non-NULL; it does, in one place, check socket->file->f_flags
    for O_NONBLOCK, but there it treats NULL socket->file as "flag not set".
    Which is the case here anyway - the fake struct file created in
    __iscsi_target_login_thread() (and in iscsi_target_setup_login_socket(), with
    the same excuse) do *not* get that flag set.
    
    Moreover, it's a bloody serious violation of a bunch of asserts in VFS;
    all struct file instances should come from filp_cachep, via get_empty_filp()
    (or alloc_file(), which is a wrapper for it).  FWIW, I'm very tempted to
    do this and be done with the entire mess:
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Andy Grover <agrover@redhat.com>
    Cc: Hannes Reinecke <hare@suse.de>
    Cc: Christoph Hellwig <hch@lst.de>
    Cc: stable@vger.kernel.org
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>

commit a6ff1a2f1e91578860b37df9fd861ef7af207de4
Merge: bd2d0837abc0 4895c771c7f0
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jul 17 10:48:26 2012 -0700

    Merge branch 'nexthop_exceptions'
    
    These patches implement the final mechanism necessary to really allow
    us to go without the route cache in ipv4.
    
    We need a place to have long-term storage of PMTU/redirect information
    which is independent of the routes themselves, yet does not get us
    back into a situation where we have to write to metrics or anything
    like that.
    
    For this we use an "next-hop exception" table in the FIB nexthops.
    
    The one thing I desperately want to avoid is having to create clone
    routes in the FIB trie for this purpose, because that is very
    expensive.   However, I'm willing to entertain such an idea later
    if this current scheme proves to have downsides that the FIB trie
    variant would not have.
    
    In order to accomodate this any such scheme, we need to be able to
    produce a full flow key at PMTU/redirect time.  That required an
    adjustment of the interface call-sites used to propagate these events.
    
    For a PMTU/redirect with a fully specified socket, we pass that socket
    and use it to produce the flow key.
    
    Otherwise we use a passed in SKB to formulate the key.  There are two
    cases that need to be distinguished, ICMP message processing (in which
    case the IP header is at skb->data) and output packet processing
    (mostly tunnels, and in all such cases the IP header is at ip_hdr(skb)).
    
    We also have to make the code able to handle the case where the dst
    itself passed into the dst_ops->{update_pmtu,redirect} method is
    invalidated.  This matters for calls from sockets that have cached
    that route.  We provide a inet{,6} helper function for this purpose,
    and edit SCTP specially since it caches routes at the transport rather
    than socket level.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a018540141a931f5299a866907b27886916b4374
Merge: 635ac11964dd 602e65a3b0c4
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jul 17 08:44:51 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David Miller:
    
     1) IPVS oops'ers:
       a) Should not reset skb->nf_bridge in forwarding hook (Lin Ming)
       b) 3.4 commit can cause ip_vs_control_cleanup to be invoked after
          the ipvs_core_ops are unregistered during rmmod (Julian ANastasov)
    
     2) ixgbevf bringup failure can crash in TX descriptor cleanup
        (Alexander Duyck)
    
     3) AX25 switch missing break statement hoses ROSE sockets (Alan Cox)
    
     4) CAIF accesses freed per-net memory (Sjur Brandeland)
    
     5) Network cgroup code has out-or-bounds accesses (Eric DUmazet), and
        accesses freed memory (Gao Feng)
    
     6) Fix a crash in SCTP reported by Dave Jones caused by freeing an
        association still on a list (Neil HOrman)
    
     7) __netdev_alloc_skb() regresses on GFP_DMA using drivers because that
        GFP flag is not being retained for the allocation (Eric Dumazet).
    
     8) Missing NULL hceck in sch_sfb netlink message parsing (Alan Cox)
    
     9) bnx2 crashes because TX index iteration is not bounded correctly
        (Michael Chan)
    
    10) IPoIB generates warnings in TCP queue collapsing (via
        skb_try_coalesce) because it does not set skb->truesize correctly
        (Eric Dumazet)
    
    11) vlan_info objects leak for the implicit vlan with ID 0 (Amir
        Hanania)
    
    12) A fix for TX time stamp handling in gianfar does not transfer socket
        ownership from one packet to another correctly, resulting in a
        socket write space imbalance (Eric Dumazet)
    
    13) Julia Lawall found several cases where we do a list iteration, and
        then at the loop termination unconditionally assume we ended up with
        real list object, rather than the list head itself (CNIC, RXRPC,
        mISDN).
    
    14) The bonding driver handles procfs moving incorrectly when a device
        it manages is moved from one namespace to another (Eric Biederman)
    
    15) Missing memory barriers in stmmac descriptor accesses result in
        various crashes (Deepak Sikri)
    
    16) Fix handling of broadcast packets in batman-adv (Simon Wunderlich)
    
    17) Properly check the sanity of sendmsg() lengths in ieee802154's
        dgram_sendmsg().  Dave Jones and others have hit and reported this
        bug (Sasha Levin)
    
    18) Some drivers (b44 and b43legacy) on 64-bit machines stopped working
        because of how netdev_alloc_skb() was adjusted.  Such drivers should
        now use alloc_skb() for obtaining bounce buffers.  (Eric Dumazet)
    
    19) atl1c mis-managed it's link state in that it stops the queue by hand
        on link down.  The generic networking takes care of that and this
        double stop locks the queue down.  So simply removing the driver's
        queue stop call fixes the problem (Cloud Ren)
    
    20) Fix out-of-memory due to mis-accounting in net_em packet scheduler
        (Eric Dumazet)
    
    21) If DCB and SR-IOV are configured at the same time in IXGBE the chip
        will hang because this is not supported (Alexander Duyck)
    
    22) A commit to stop drivers using netdev->base_addr broke the CNIC
        driver (Michael Chan)
    
    23) Timeout regression in ipset caused by an attempt to fix an overflow
        bug (Jozsef Kadlecsik).
    
    24) mac80211 minstrel code allocates memory using incorrect size
        (Thomas Huehn)
    
    25) llcp_sock_getname() needs to check for a NULL device otherwise we
        OOPS (Sasha Levin)
    
    26) mwifiex leaks memory (Bing Zhao)
    
    27) Propagate iwlwifi fix to iwlegacy, even when we're not associated
        we need to monitor for stuck queues in the watchdog handler
        (Stanislaw Geuszka)
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (44 commits)
      ipvs: fix oops in ip_vs_dst_event on rmmod
      ipvs: fix oops on NAT reply in br_nf context
      ixgbevf: Fix panic when loading driver
      ax25: Fix missing break
      MAINTAINERS: reflect actual changes in IEEE 802.15.4 maintainership
      caif: Fix access to freed pernet memory
      net: cgroup: fix access the unallocated memory in netprio cgroup
      ixgbevf: Prevent RX/TX statistics getting reset to zero
      sctp: Fix list corruption resulting from freeing an association on a list
      net: respect GFP_DMA in __netdev_alloc_skb()
      e1000e: fix test for PHY being accessible on 82577/8/9 and I217
      e1000e: Correct link check logic for 82571 serdes
      sch_sfb: Fix missing NULL check
      bnx2: Fix bug in bnx2_free_tx_skbs().
      IPoIB: fix skb truesize underestimatiom
      net: Fix memory leak - vlan_info struct
      gianfar: fix potential sk_wmem_alloc imbalance
      drivers/net/ethernet/broadcom/cnic.c: remove invalid reference to list iterator variable
      net/rxrpc/ar-peer.c: remove invalid reference to list iterator variable
      drivers/isdn/mISDN/stack.c: remove invalid reference to list iterator variable
      ...

commit 2eebc1e188e9e45886ee00662519849339884d6d
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jul 16 09:13:51 2012 +0000

    sctp: Fix list corruption resulting from freeing an association on a list
    
    A few days ago Dave Jones reported this oops:
    
    [22766.294255] general protection fault: 0000 [#1] PREEMPT SMP
    [22766.295376] CPU 0
    [22766.295384] Modules linked in:
    [22766.387137]  ffffffffa169f292 6b6b6b6b6b6b6b6b ffff880147c03a90
    ffff880147c03a74
    [22766.387135] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 00000000000
    [22766.387136] Process trinity-watchdo (pid: 10896, threadinfo ffff88013e7d2000,
    [22766.387137] Stack:
    [22766.387140]  ffff880147c03a10
    [22766.387140]  ffffffffa169f2b6
    [22766.387140]  ffff88013ed95728
    [22766.387143]  0000000000000002
    [22766.387143]  0000000000000000
    [22766.387143]  ffff880003fad062
    [22766.387144]  ffff88013c120000
    [22766.387144]
    [22766.387145] Call Trace:
    [22766.387145]  <IRQ>
    [22766.387150]  [<ffffffffa169f292>] ? __sctp_lookup_association+0x62/0xd0
    [sctp]
    [22766.387154]  [<ffffffffa169f2b6>] __sctp_lookup_association+0x86/0xd0 [sctp]
    [22766.387157]  [<ffffffffa169f597>] sctp_rcv+0x207/0xbb0 [sctp]
    [22766.387161]  [<ffffffff810d4da8>] ? trace_hardirqs_off_caller+0x28/0xd0
    [22766.387163]  [<ffffffff815827e3>] ? nf_hook_slow+0x133/0x210
    [22766.387166]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387168]  [<ffffffff8159043d>] ip_local_deliver_finish+0x18d/0x4c0
    [22766.387169]  [<ffffffff815902fc>] ? ip_local_deliver_finish+0x4c/0x4c0
    [22766.387171]  [<ffffffff81590a07>] ip_local_deliver+0x47/0x80
    [22766.387172]  [<ffffffff8158fd80>] ip_rcv_finish+0x150/0x680
    [22766.387174]  [<ffffffff81590c54>] ip_rcv+0x214/0x320
    [22766.387176]  [<ffffffff81558c07>] __netif_receive_skb+0x7b7/0x910
    [22766.387178]  [<ffffffff8155856c>] ? __netif_receive_skb+0x11c/0x910
    [22766.387180]  [<ffffffff810d423e>] ? put_lock_stats.isra.25+0xe/0x40
    [22766.387182]  [<ffffffff81558f83>] netif_receive_skb+0x23/0x1f0
    [22766.387183]  [<ffffffff815596a9>] ? dev_gro_receive+0x139/0x440
    [22766.387185]  [<ffffffff81559280>] napi_skb_finish+0x70/0xa0
    [22766.387187]  [<ffffffff81559cb5>] napi_gro_receive+0xf5/0x130
    [22766.387218]  [<ffffffffa01c4679>] e1000_receive_skb+0x59/0x70 [e1000e]
    [22766.387242]  [<ffffffffa01c5aab>] e1000_clean_rx_irq+0x28b/0x460 [e1000e]
    [22766.387266]  [<ffffffffa01c9c18>] e1000e_poll+0x78/0x430 [e1000e]
    [22766.387268]  [<ffffffff81559fea>] net_rx_action+0x1aa/0x3d0
    [22766.387270]  [<ffffffff810a495f>] ? account_system_vtime+0x10f/0x130
    [22766.387273]  [<ffffffff810734d0>] __do_softirq+0xe0/0x420
    [22766.387275]  [<ffffffff8169826c>] call_softirq+0x1c/0x30
    [22766.387278]  [<ffffffff8101db15>] do_softirq+0xd5/0x110
    [22766.387279]  [<ffffffff81073bc5>] irq_exit+0xd5/0xe0
    [22766.387281]  [<ffffffff81698b03>] do_IRQ+0x63/0xd0
    [22766.387283]  [<ffffffff8168ee2f>] common_interrupt+0x6f/0x6f
    [22766.387283]  <EOI>
    [22766.387284]
    [22766.387285]  [<ffffffff8168eed9>] ? retint_swapgs+0x13/0x1b
    [22766.387285] Code: c0 90 5d c3 66 0f 1f 44 00 00 4c 89 c8 5d c3 0f 1f 00 55 48
    89 e5 48 83
    ec 20 48 89 5d e8 4c 89 65 f0 4c 89 6d f8 66 66 66 66 90 <0f> b7 87 98 00 00 00
    48 89 fb
    49 89 f5 66 c1 c0 08 66 39 46 02
    [22766.387307]
    [22766.387307] RIP
    [22766.387311]  [<ffffffffa168a2c9>] sctp_assoc_is_match+0x19/0x90 [sctp]
    [22766.387311]  RSP <ffff880147c039b0>
    [22766.387142]  ffffffffa16ab120
    [22766.599537] ---[ end trace 3f6dae82e37b17f5 ]---
    [22766.601221] Kernel panic - not syncing: Fatal exception in interrupt
    
    It appears from his analysis and some staring at the code that this is likely
    occuring because an association is getting freed while still on the
    sctp_assoc_hashtable.  As a result, we get a gpf when traversing the hashtable
    while a freed node corrupts part of the list.
    
    Nominally I would think that an mibalanced refcount was responsible for this,
    but I can't seem to find any obvious imbalance.  What I did note however was
    that the two places where we create an association using
    sctp_primitive_ASSOCIATE (__sctp_connect and sctp_sendmsg), have failure paths
    which free a newly created association after calling sctp_primitive_ASSOCIATE.
    sctp_primitive_ASSOCIATE brings us into the sctp_sf_do_prm_asoc path, which
    issues a SCTP_CMD_NEW_ASOC side effect, which in turn adds a new association to
    the aforementioned hash table.  the sctp command interpreter that process side
    effects has not way to unwind previously processed commands, so freeing the
    association from the __sctp_connect or sctp_sendmsg error path would lead to a
    freed association remaining on this hash table.
    
    I've fixed this but modifying sctp_[un]hash_established to use hlist_del_init,
    which allows us to proerly use hlist_unhashed to check if the node is on a
    hashlist safely during a delete.  That in turn alows us to safely call
    sctp_unhash_established in the __sctp_connect and sctp_sendmsg error paths
    before freeing them, regardles of what the associations state is on the hash
    list.
    
    I noted, while I was doing this, that the __sctp_unhash_endpoint was using
    hlist_unhsashed in a simmilar fashion, but never nullified any removed nodes
    pointers to make that function work properly, so I fixed that up in a simmilar
    fashion.
    
    I attempted to test this using a virtual guest running the SCTP_RR test from
    netperf in a loop while running the trinity fuzzer, both in a loop.  I wasn't
    able to recreate the problem prior to this fix, nor was I able to trigger the
    failure after (neither of which I suppose is suprising).  Given the trace above
    however, I think its likely that this is what we hit.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Reported-by: davej@redhat.com
    CC: davej@redhat.com
    CC: "David S. Miller" <davem@davemloft.net>
    CC: Vlad Yasevich <vyasevich@gmail.com>
    CC: Sridhar Samudrala <sri@us.ibm.com>
    CC: linux-sctp@vger.kernel.org
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 80d0a69fc57715dc9080c0567df1ed911b78abea
Author: David S. Miller <davem@davemloft.net>
Date:   Mon Jul 16 03:28:06 2012 -0700

    ipv4: Add helper inet_csk_update_pmtu().
    
    This abstracts away the call to dst_ops->update_pmtu() so that we can
    transparently handle the fact that, in the future, the dst itself can
    be invalidated by the PMTU update (when we have non-host routes cached
    in sockets).
    
    So we try to rebuild the socket cached route after the method
    invocation if necessary.
    
    This isn't used by SCTP because it needs to cache dsts per-transport,
    and thus will need it's own local version of this helper.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5672874889a8e9f3049eefb57e0eb41dd6fa83a7
Merge: dab058fd5ff8 2e1706f234f8
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Jul 3 18:01:54 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking update from David Miller:
    
     1) Fix RX sequence number handling in mwifiex, from Stone Piao.
    
     2) Netfilter ipset mis-compares device names, fix from Florian
        Westphal.
    
     3) Fix route leak in ipv6 IPVS, from Eric Dumazet.
    
     4) NFS fixes.  Several buffer overflows in NCI layer from Dan
        Rosenberg, and release sock OOPS'er fix from Eric Dumazet.
    
     5) Fix WEP handling ath9k, we started using a bit the chip provides to
        indicate undecrypted packets but that bit turns out to be unreliable
        in certain configurations.  Fix from Felix Fietkau.
    
     6) Fix Kconfig dependency bug in wlcore, from Randy Dunlap.
    
     7) New USB IDs for rtlwifi driver from Larry Finger.
    
     8) Fix crashes in qmi_wwan usbnet driver when disconnecting, from Bjrn
        Mork.
    
     9) Gianfar driver programs coalescing settings properly in single queue
        mode, but does not do so in multi-queue mode.  Fix from Claudiu
        Manoil.
    
    10) Missing module.h include in davinci_cpdma.c, from Daniel Mack.
    
    11) Need dummy handler for IPSET_CMD_NONE otherwise we crash in ipset if
        we get this via nfnetlink, fix from Tomasz Bursztyka.
    
    12) Missing RCU unlock in nfnetlink error path, also from Tomasz.
    
    13) Fix divide by zero in igbvf when the user tries to set an RX
        coalescing value of 0 usecs, from Mitch A Williams.
    
    14) We can process SCTP sacks for the wrong transport, oops.  Fix from
        Neil Horman.
    
    15) Remove hw IP payload checksumming from e1000e driver.  This has zery
        value in our stack, and turning it on creates a very unintuitive
        restriction for users when using jumbo MTUs.
    
        Specifically, when IP payload checksums are on you cannot use both
        receive hashing offload and jumbo MTU.  Fix from Bruce Allan.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (27 commits)
      e1000e: remove use of IP payload checksum
      sctp: be more restrictive in transport selection on bundled sacks
      igbvf: fix divide by zero
      netfilter: nfnetlink: fix missing rcu_read_unlock in nfnetlink_rcv_msg
      netfilter: ipset: fix crash if IPSET_CMD_NONE command is sent
      davinci_cpdma: include linux/module.h
      gianfar: Fix RXICr/TXICr programming for multi-queue mode
      net: Downgrade CAP_SYS_MODULE deprecated message from error to warning.
      net: qmi_wwan: fix Oops while disconnecting
      mwifiex: fix memory leak associated with IE manamgement
      ath9k: fix panic caused by returning a descriptor we have queued for reuse
      mac80211: correct behaviour on unrecognised action frames
      ath9k: enable serialize_regmode for non-PCIE AR9287
      rtlwifi: rtl8192cu: New USB IDs
      NFC: Return from rawsock_release when sk is NULL
      iwlwifi: fix activating inactive stations
      wlcore: drop INET dependency
      ath9k: fix dynamic WEP related regression
      NFC: Prevent multiple buffer overflows in NCI
      netfilter: update location of my trees
      ...

commit 8c88f87cb27ad09086940bdd3e6955e5325ec89a
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Thu Jun 7 13:31:25 2012 +0200

    netfilter: nfnetlink_queue: add NAT TCP sequence adjustment if packet mangled
    
    User-space programs that receive traffic via NFQUEUE may mangle packets.
    If NAT is enabled, this usually puzzles sequence tracking, leading to
    traffic disruptions.
    
    With this patch, nfnl_queue will make the corresponding NAT TCP sequence
    adjustment if:
    
    1) The packet has been mangled,
    2) the NFQA_CFG_F_CONNTRACK flag has been set, and
    3) NAT is detected.
    
    There are some records on the Internet complaning about this issue:
    http://stackoverflow.com/questions/260757/packet-mangling-utilities-besides-iptables
    
    By now, we only support TCP since we have no helpers for DCCP or SCTP.
    Better to add this if we ever have some helper over those layer 4 protocols.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 49d485a30f3058b2633f86f85efae04c824ceffe
Author: Gao feng <gaofeng@cn.fujitsu.com>
Date:   Mon May 28 21:04:18 2012 +0000

    netfilter: nf_ct_sctp: add namespace support
    
    This patch adds namespace support for SCTP protocol tracker.
    
    Acked-by: Eric W. Biederman <ebiederm@xmission.com>
    Signed-off-by: Gao feng <gaofeng@cn.fujitsu.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 4a873f53995cd551587ee4aad1e6f189a330ff36
Merge: 2eb429671a4b 062e55e39600
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat May 12 12:57:01 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking fixes from David S. Miller:
    
     1) Since we do RCU lookups on ipv4 FIB entries, we have to test if the
        entry is dead before returning it to our caller.
    
     2) openvswitch locking and packet validation fixes from Ansis Atteka,
        Jesse Gross, and Pravin B Shelar.
    
     3) Fix PM resume locking in IGB driver, from Benjamin Poirier.
    
     4) Fix VLAN header handling in vhost-net and macvtap, from Basil Gor.
    
     5) Revert a bogus network namespace isolation change that was causing
        regressions on S390 networking devices.
    
     6) If bonding decides to process and handle a LACPDU frame, we
        shouldn't bump the rx_dropped counter.  From Jiri Bohac.
    
     7) Fix mis-calculation of available TX space in r8169 driver when doing
        TSO, which can lead to crashes and/or hung device.  From Julien
        Ducourthial.
    
     8) SCTP does not validate cached routes properly in all cases, from
        Nicolas Dichtel.
    
     9) Link status interrupt needs to be handled in ks8851 driver, from
        Stephen Boyd.
    
    10) Use capable(), not cap_raised(), in connector/userns netlink code.
        From Eric W. Biederman via Andrew Morton.
    
    11) Fix pktgen OOPS on module unload, from Eric Dumazet.
    
    12) iwlwifi under-estimates SKB truesizes, also from Eric Dumazet.
    
    13) Cure division by zero in SFC driver, from Ben Hutchings.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (26 commits)
      ks8851: Update link status during link change interrupt
      macvtap: restore vlan header on user read
      vhost-net: fix handle_rx buffer size
      bonding: don't increase rx_dropped after processing LACPDUs
      connector/userns: replace netlink uses of cap_raised() with capable()
      sctp: check cached dst before using it
      pktgen: fix crash at module unload
      Revert "net: maintain namespace isolation between vlan and real device"
      ehea: fix losing of NEQ events when one event occurred early
      igb: fix rtnl race in PM resume path
      ipv4: Do not use dead fib_info entries.
      r8169: fix unsigned int wraparound with TSO
      sfc: Fix division by zero when using one RX channel and no SR-IOV
      openvswitch: Validation of IPv6 set port action uses IPv4 header
      net: compare_ether_addr[_64bits]() has no ordering
      cdc_ether: Ignore bogus union descriptor for RNDIS devices
      bnx2x: bug fix when loading after SAN boot
      e1000: Silence sparse warnings by correcting type
      igb, ixgbe: netdev_tx_reset_queue incorrectly called from tx init path
      openvswitch: Release rtnl_lock if ovs_vport_cmd_build_info() failed.
      ...

commit a13e640b8d17e0a5ab4b388431f877e2feef7abf
Author: Thomas Graf <tgraf@infradead.org>
Date:   Tue Apr 3 22:17:53 2012 +0000

    sctp: Allow struct sctp_event_subscribe to grow without breaking binaries
    
    [ Upstream commit acdd5985364f8dc511a0762fab2e683f29d9d692 ]
    
    getsockopt(..., SCTP_EVENTS, ...) performs a length check and returns
    an error if the user provides less bytes than the size of struct
    sctp_event_subscribe.
    
    Struct sctp_event_subscribe needs to be extended by an u8 for every
    new event or notification type that is added.
    
    This obviously makes getsockopt fail for binaries that are compiled
    against an older versions of <net/sctp/user.h> which do not contain
    all event types.
    
    This patch changes getsockopt behaviour to no longer return an error
    if not enough bytes are being provided by the user. Instead, it
    returns as much of sctp_event_subscribe as fits into the provided buffer.
    
    This leads to the new behavior that users see what they have been aware
    of at compile time.
    
    The setsockopt(..., SCTP_EVENTS, ...) API is already behaving like this.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 159ea327099b6b63eac8d95f840606fd2fc86881
Author: Thomas Graf <tgraf@infradead.org>
Date:   Tue Apr 3 22:17:53 2012 +0000

    sctp: Allow struct sctp_event_subscribe to grow without breaking binaries
    
    [ Upstream commit acdd5985364f8dc511a0762fab2e683f29d9d692 ]
    
    getsockopt(..., SCTP_EVENTS, ...) performs a length check and returns
    an error if the user provides less bytes than the size of struct
    sctp_event_subscribe.
    
    Struct sctp_event_subscribe needs to be extended by an u8 for every
    new event or notification type that is added.
    
    This obviously makes getsockopt fail for binaries that are compiled
    against an older versions of <net/sctp/user.h> which do not contain
    all event types.
    
    This patch changes getsockopt behaviour to no longer return an error
    if not enough bytes are being provided by the user. Instead, it
    returns as much of sctp_event_subscribe as fits into the provided buffer.
    
    This leads to the new behavior that users see what they have been aware
    of at compile time.
    
    The setsockopt(..., SCTP_EVENTS, ...) API is already behaving like this.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3109ea06da8538ee3ded3489b26065a3be32f360
Author: Thomas Graf <tgraf@infradead.org>
Date:   Tue Apr 3 22:17:53 2012 +0000

    sctp: Allow struct sctp_event_subscribe to grow without breaking binaries
    
    [ Upstream commit acdd5985364f8dc511a0762fab2e683f29d9d692 ]
    
    getsockopt(..., SCTP_EVENTS, ...) performs a length check and returns
    an error if the user provides less bytes than the size of struct
    sctp_event_subscribe.
    
    Struct sctp_event_subscribe needs to be extended by an u8 for every
    new event or notification type that is added.
    
    This obviously makes getsockopt fail for binaries that are compiled
    against an older versions of <net/sctp/user.h> which do not contain
    all event types.
    
    This patch changes getsockopt behaviour to no longer return an error
    if not enough bytes are being provided by the user. Instead, it
    returns as much of sctp_event_subscribe as fits into the provided buffer.
    
    This leads to the new behavior that users see what they have been aware
    of at compile time.
    
    The setsockopt(..., SCTP_EVENTS, ...) API is already behaving like this.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 23f347ef63aa36b5a001b6791f657cd0e2a04de3
Merge: 314489bd4c77 110c43304db6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 6 10:37:38 2012 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net
    
    Pull networking updates from David Miller:
    
     1) Fix inaccuracies in network driver interface documentation, from Ben
        Hutchings.
    
     2) Fix handling of negative offsets in BPF JITs, from Jan Seiffert.
    
     3) Compile warning, locking, and refcounting fixes in netfilter's
        xt_CT, from Pablo Neira Ayuso.
    
     4) phonet sendmsg needs to validate user length just like any other
        datagram protocol, fix from Sasha Levin.
    
     5) Ipv6 multicast code uses wrong loop index, from RongQing Li.
    
     6) Link handling and firmware fixes in bnx2x driver from Yaniv Rosner
        and Yuval Mintz.
    
     7) mlx4 erroneously allocates 4 pages at a time, regardless of page
        size, fix from Thadeu Lima de Souza Cascardo.
    
     8) SCTP socket option wasn't extended in a backwards compatible way,
        fix from Thomas Graf.
    
     9) Add missing address change event emissions to bonding, from Shlomo
        Pongratz.
    
    10) /proc/net/dev regressed because it uses a private offset to track
        where we are in the hash table, but this doesn't track the offset
        pullback that the seq_file code does resulting in some entries being
        missed in large dumps.
    
        Fix from Eric Dumazet.
    
    11) do_tcp_sendpage() unloads the send queue way too fast, because it
        invokes tcp_push() when it shouldn't.  Let the natural sequence
        generated by the splice paths, and the assosciated MSG_MORE
        settings, guide the tcp_push() calls.
    
        Otherwise what goes out of TCP is spaghetti and doesn't batch
        effectively into GSO/TSO clusters.
    
        From Eric Dumazet.
    
    12) Once we put a SKB into either the netlink receiver's queue or a
        socket error queue, it can be consumed and freed up, therefore we
        cannot touch it after queueing it like that.
    
        Fixes from Eric Dumazet.
    
    13) PPP has this annoying behavior in that for every transmit call it
        immediately stops the TX queue, then calls down into the next layer
        to transmit the PPP frame.
    
        But if that next layer can take it immediately, it just un-stops the
        TX queue right before returning from the transmit method.
    
        Besides being useless work, it makes several facilities unusable, in
        particular things like the equalizers.  Well behaved devices should
        only stop the TX queue when they really are full, and in PPP's case
        when it gets backlogged to the downstream device.
    
        David Woodhouse therefore fixed PPP to not stop the TX queue until
        it's downstream can't take data any more.
    
    14) IFF_UNICAST_FLT got accidently lost in some recent stmmac driver
        changes, re-add.  From Marc Kleine-Budde.
    
    15) Fix link flaps in ixgbe, from Eric W. Multanen.
    
    16) Descriptor writeback fixes in e1000e from Matthew Vick.
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net: (47 commits)
      net: fix a race in sock_queue_err_skb()
      netlink: fix races after skb queueing
      doc, net: Update ndo_start_xmit return type and values
      doc, net: Remove instruction to set net_device::trans_start
      doc, net: Update netdev operation names
      doc, net: Update documentation of synchronisation for TX multiqueue
      doc, net: Remove obsolete reference to dev->poll
      ethtool: Remove exception to the requirement of holding RTNL lock
      MAINTAINERS: update for Marvell Ethernet drivers
      bonding: properly unset current_arp_slave on slave link up
      phonet: Check input from user before allocating
      tcp: tcp_sendpages() should call tcp_push() once
      ipv6: fix array index in ip6_mc_add_src()
      mlx4: allocate just enough pages instead of always 4 pages
      stmmac: re-add IFF_UNICAST_FLT for dwmac1000
      bnx2x: Clear MDC/MDIO warning message
      bnx2x: Fix BCM57711+BCM84823 link issue
      bnx2x: Clear BCM84833 LED after fan failure
      bnx2x: Fix BCM84833 PHY FW version presentation
      bnx2x: Fix link issue for BCM8727 boards.
      ...

commit acdd5985364f8dc511a0762fab2e683f29d9d692
Author: Thomas Graf <tgraf@infradead.org>
Date:   Tue Apr 3 22:17:53 2012 +0000

    sctp: Allow struct sctp_event_subscribe to grow without breaking binaries
    
    getsockopt(..., SCTP_EVENTS, ...) performs a length check and returns
    an error if the user provides less bytes than the size of struct
    sctp_event_subscribe.
    
    Struct sctp_event_subscribe needs to be extended by an u8 for every
    new event or notification type that is added.
    
    This obviously makes getsockopt fail for binaries that are compiled
    against an older versions of <net/sctp/user.h> which do not contain
    all event types.
    
    This patch changes getsockopt behaviour to no longer return an error
    if not enough bytes are being provided by the user. Instead, it
    returns as much of sctp_event_subscribe as fits into the provided buffer.
    
    This leads to the new behavior that users see what they have been aware
    of at compile time.
    
    The setsockopt(..., SCTP_EVENTS, ...) API is already behaving like this.
    
    Signed-off-by: Thomas Graf <tgraf@suug.ch>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 97cc008aaa8c1f02699b478ca890e81810244131
Author: Benjamin Poirier <bpoirier@suse.de>
Date:   Fri Mar 23 18:06:18 2012 -0400

    GFS2: use depends instead of select in kconfig
    
    Avoids having to duplicate the dependencies of what is 'select'ed (and on
    down...)
    
    Those dependencies are currently incomplete, leading to broken builds with
    GFS2_FS_LOCKING_DLM=y and IP_SCTP=n.
    
    Signed-off-by: Benjamin Poirier <bpoirier@suse.de>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>

commit eeb4cb952386aac764a5cf4cf2490e50a24a8880
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Fri Mar 23 00:02:07 2012 +0100

    netfilter: xt_CT: fix assignation of the generic protocol tracker
    
    `iptables -p all' uses 0 to match all protocols, while the conntrack
    subsystem uses 255. We still need `-p all' to attach the custom
    timeout policies for the generic protocol tracker.
    
    Moreover, we may use `iptables -p sctp' while the SCTP tracker is
    not loaded. In that case, we have to default on the generic protocol
    tracker.
    
    Another possibility is `iptables -p ip' that should be supported
    as well. This patch makes sure we validate all possible scenarios.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit fd4199603bbc8851051b45299b7cf73b07b4daac
Author: Thomas Graf <tgraf@redhat.com>
Date:   Mon Dec 19 04:11:40 2011 +0000

    sctp: Do not account for sizeof(struct sk_buff) in estimated rwnd
    
    [ Upstream commit a76c0adf60f6ca5ff3481992e4ea0383776b24d2 ]
    
    When checking whether a DATA chunk fits into the estimated rwnd a
    full sizeof(struct sk_buff) is added to the needed chunk size. This
    quickly exhausts the available rwnd space and leads to packets being
    sent which are much below the PMTU limit. This can lead to much worse
    performance.
    
    The reason for this behaviour was to avoid putting too much memory
    pressure on the receiver. The concept is not completely irational
    because a Linux receiver does in fact clone an skb for each DATA chunk
    delivered. However, Linux also reserves half the available socket
    buffer space for data structures therefore usage of it is already
    accounted for.
    
    When proposing to change this the last time it was noted that this
    behaviour was introduced to solve a performance issue caused by rwnd
    overusage in combination with small DATA chunks.
    
    Trying to reproduce this I found that with the sk_buff overhead removed,
    the performance would improve significantly unless socket buffer limits
    are increased.
    
    The following numbers have been gathered using a patched iperf
    supporting SCTP over a live 1 Gbit ethernet network. The -l option
    was used to limit DATA chunk sizes. The numbers listed are based on
    the average of 3 test runs each. Default values have been used for
    sk_(r|w)mem.
    
    Chunk
    Size    Unpatched     No Overhead
    -------------------------------------
       4    15.2 Kbit [!]   12.2 Mbit [!]
       8    35.8 Kbit [!]   26.0 Mbit [!]
      16    95.5 Kbit [!]   54.4 Mbit [!]
      32   106.7 Mbit      102.3 Mbit
      64   189.2 Mbit      188.3 Mbit
     128   331.2 Mbit      334.8 Mbit
     256   537.7 Mbit      536.0 Mbit
     512   766.9 Mbit      766.6 Mbit
    1024   810.1 Mbit      808.6 Mbit
    
    Signed-off-by: Thomas Graf <tgraf@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 0e5fe3ed8d751c7be333fa193882e91dcc289158
Author: Thomas Graf <tgraf@redhat.com>
Date:   Mon Dec 19 04:11:40 2011 +0000

    sctp: Do not account for sizeof(struct sk_buff) in estimated rwnd
    
    [ Upstream commit a76c0adf60f6ca5ff3481992e4ea0383776b24d2 ]
    
    When checking whether a DATA chunk fits into the estimated rwnd a
    full sizeof(struct sk_buff) is added to the needed chunk size. This
    quickly exhausts the available rwnd space and leads to packets being
    sent which are much below the PMTU limit. This can lead to much worse
    performance.
    
    The reason for this behaviour was to avoid putting too much memory
    pressure on the receiver. The concept is not completely irational
    because a Linux receiver does in fact clone an skb for each DATA chunk
    delivered. However, Linux also reserves half the available socket
    buffer space for data structures therefore usage of it is already
    accounted for.
    
    When proposing to change this the last time it was noted that this
    behaviour was introduced to solve a performance issue caused by rwnd
    overusage in combination with small DATA chunks.
    
    Trying to reproduce this I found that with the sk_buff overhead removed,
    the performance would improve significantly unless socket buffer limits
    are increased.
    
    The following numbers have been gathered using a patched iperf
    supporting SCTP over a live 1 Gbit ethernet network. The -l option
    was used to limit DATA chunk sizes. The numbers listed are based on
    the average of 3 test runs each. Default values have been used for
    sk_(r|w)mem.
    
    Chunk
    Size    Unpatched     No Overhead
    -------------------------------------
       4    15.2 Kbit [!]   12.2 Mbit [!]
       8    35.8 Kbit [!]   26.0 Mbit [!]
      16    95.5 Kbit [!]   54.4 Mbit [!]
      32   106.7 Mbit      102.3 Mbit
      64   189.2 Mbit      188.3 Mbit
     128   331.2 Mbit      334.8 Mbit
     256   537.7 Mbit      536.0 Mbit
     512   766.9 Mbit      766.6 Mbit
    1024   810.1 Mbit      808.6 Mbit
    
    Signed-off-by: Thomas Graf <tgraf@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit a76c0adf60f6ca5ff3481992e4ea0383776b24d2
Author: Thomas Graf <tgraf@redhat.com>
Date:   Mon Dec 19 04:11:40 2011 +0000

    sctp: Do not account for sizeof(struct sk_buff) in estimated rwnd
    
    When checking whether a DATA chunk fits into the estimated rwnd a
    full sizeof(struct sk_buff) is added to the needed chunk size. This
    quickly exhausts the available rwnd space and leads to packets being
    sent which are much below the PMTU limit. This can lead to much worse
    performance.
    
    The reason for this behaviour was to avoid putting too much memory
    pressure on the receiver. The concept is not completely irational
    because a Linux receiver does in fact clone an skb for each DATA chunk
    delivered. However, Linux also reserves half the available socket
    buffer space for data structures therefore usage of it is already
    accounted for.
    
    When proposing to change this the last time it was noted that this
    behaviour was introduced to solve a performance issue caused by rwnd
    overusage in combination with small DATA chunks.
    
    Trying to reproduce this I found that with the sk_buff overhead removed,
    the performance would improve significantly unless socket buffer limits
    are increased.
    
    The following numbers have been gathered using a patched iperf
    supporting SCTP over a live 1 Gbit ethernet network. The -l option
    was used to limit DATA chunk sizes. The numbers listed are based on
    the average of 3 test runs each. Default values have been used for
    sk_(r|w)mem.
    
    Chunk
    Size    Unpatched     No Overhead
    -------------------------------------
       4    15.2 Kbit [!]   12.2 Mbit [!]
       8    35.8 Kbit [!]   26.0 Mbit [!]
      16    95.5 Kbit [!]   54.4 Mbit [!]
      32   106.7 Mbit      102.3 Mbit
      64   189.2 Mbit      188.3 Mbit
     128   331.2 Mbit      334.8 Mbit
     256   537.7 Mbit      536.0 Mbit
     512   766.9 Mbit      766.6 Mbit
    1024   810.1 Mbit      808.6 Mbit
    
    Signed-off-by: Thomas Graf <tgraf@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d5ccd496601b8776a516d167a6485754575dc38f
Author: Max Matveev <makc@redhat.com>
Date:   Mon Aug 29 21:02:24 2011 +0000

    sctp: deal with multiple COOKIE_ECHO chunks
    
    Attempt to reduce the number of IP packets emitted in response to single
    SCTP packet (2e3216cd) introduced a complication - if a packet contains
    two COOKIE_ECHO chunks and nothing else then SCTP state machine corks the
    socket while processing first COOKIE_ECHO and then loses the association
    and forgets to uncork the socket. To deal with the issue add new SCTP
    command which can be used to set association explictly. Use this new
    command when processing second COOKIE_ECHO chunk to restore the context
    for SCTP state machine.
    
    Signed-off-by: Max Matveev <makc@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 62f2a3a48bdc99822a24356e667e52c30df287c9
Author: Micha Mirosaw <mirq-linux@rere.qmqm.pl>
Date:   Wed Jul 13 14:10:29 2011 +0000

    net: remove NETIF_F_ALL_TX_OFFLOADS
    
    There is no software fallback implemented for SCTP or FCoE checksumming,
    and so it should not be passed on by software devices like bridge or bonding.
    
    For VLAN devices, this is different. First, the driver for underlying device
    should be prepared to get offloaded packets even when the feature is disabled
    (especially if it advertises it in vlan_features). Second, devices under
    VLANs do not get replaced without tearing down the VLAN first.
    
    This fixes a mess I accidentally introduced while converting bonding to
    ndo_fix_features.
    
    NETIF_F_SOFT_FEATURES are removed from BOND_VLAN_FEATURES because they
    are unused as of commit 712ae51afd.
    
    Signed-off-by: Micha Mirosaw <mirq-linux@rere.qmqm.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b73c43f884b1b26ef8e824a33f3924f92e493c11
Author: Micha Mirosaw <mirq-linux@rere.qmqm.pl>
Date:   Wed Jul 13 14:10:29 2011 +0000

    net: sctp: fix checksum marking for outgoing packets
    
    Packets to devices without NETIF_F_SCTP_CSUM (including NETIF_F_NO_CSUM)
    should be properly checksummed because the packets can be diverted or
    rerouted after construction. This still leaves packets diverted from
    NETIF_F_SCTP_CSUM-enabled devices with broken checksums. Fixing this
    needs implementing software offload fallback in networking core.
    
    For users of sctp_checksum_disable, skb->ip_summed should be left as
    CHECKSUM_NONE and not CHECKSUM_UNNECESSARY as per include/linux/skbuff.h.
    
    Signed-off-by: Micha Mirosaw <mirq-linux@rere.qmqm.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 85746e429f8e5dc8c5c0beadc0f099cb1feab93e
Merge: 4dd1b49c6d21 949123016a2e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Jul 7 13:16:21 2011 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (31 commits)
      sctp: fix missing send up SCTP_SENDER_DRY_EVENT when subscribe it
      net: refine {udp|tcp|sctp}_mem limits
      vmxnet3: round down # of queues to power of two
      net: sh_eth: fix the parameter for the ETHER of SH7757
      net: sh_eth: fix cannot work half-duplex mode
      net: vlan: enable soft features regardless of underlying device
      vmxnet3: fix starving rx ring whenoc_skb kb fails
      bridge: Always flood broadcast packets
      greth: greth_set_mac_add would corrupt the MAC address.
      net: bind() fix error return on wrong address family
      natsemi: silence dma-debug warnings
      net: 8139too: Initial necessary vlan_features to support vlan
      Fix call trace when interrupts are disabled while sleeping function kzalloc is called
      qlge:Version change to v1.00.00.29
      qlge: Fix printk priority so chip fatal errors are always reported.
      qlge:Fix crash caused by mailbox execution on wedged chip.
      xfrm4: Don't call icmp_send on local error
      ipv4: Don't use ufo handling on later transformed packets
      xfrm: Remove family arg from xfrm_bundle_ok
      ipv6: Don't put artificial limit on routing table size.
      ...

commit 949123016a2ef578009b6aa3e98d45d1a154ebfb
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Sat Jul 2 09:28:04 2011 +0000

    sctp: fix missing send up SCTP_SENDER_DRY_EVENT when subscribe it
    
    We forgot to send up SCTP_SENDER_DRY_EVENT notification when
    user app subscribes to this event, and there is no data to be
    sent or retransmit.
    
    This is required by the Socket API and used by the DTLS/SCTP
    implementation.
    
    Reported-by: Michael Txen <Michael.Tuexen@lurchi.franken.de>
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Tested-by: Robin Seggelmann <seggelmann@fh-muenster.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 29ad44a2c7365a4094772be7bbc81aff279295fc
Author: Jacek Luczak <difrost.kernel@gmail.com>
Date:   Thu May 19 09:55:13 2011 +0000

    SCTP: fix race between sctp_bind_addr_free() and sctp_bind_addr_conflict()
    
    [ Upstream commit c182f90bc1f22ce5039b8722e45621d5f96862c2 ]
    
    During the sctp_close() call, we do not use rcu primitives to
    destroy the address list attached to the endpoint.  At the same
    time, we do the removal of addresses from this list before
    attempting to remove the socket from the port hash
    
    As a result, it is possible for another process to find the socket
    in the port hash that is in the process of being closed.  It then
    proceeds to traverse the address list to find the conflict, only
    to have that address list suddenly disappear without rcu() critical
    section.
    
    Fix issue by closing address list removal inside RCU critical
    section.
    
    Race can result in a kernel crash with general protection fault or
    kernel NULL pointer dereference:
    
    kernel: general protection fault: 0000 [#1] SMP
    kernel: RIP: 0010:[<ffffffffa02f3dde>]  [<ffffffffa02f3dde>] sctp_bind_addr_conflict+0x64/0x82 [sctp]
    kernel: Call Trace:
    kernel:  [<ffffffffa02f415f>] ? sctp_get_port_local+0x17b/0x2a3 [sctp]
    kernel:  [<ffffffffa02f3d45>] ? sctp_bind_addr_match+0x33/0x68 [sctp]
    kernel:  [<ffffffffa02f4416>] ? sctp_do_bind+0xd3/0x141 [sctp]
    kernel:  [<ffffffffa02f5030>] ? sctp_bindx_add+0x4d/0x8e [sctp]
    kernel:  [<ffffffffa02f5183>] ? sctp_setsockopt_bindx+0x112/0x4a4 [sctp]
    kernel:  [<ffffffff81089e82>] ? generic_file_aio_write+0x7f/0x9b
    kernel:  [<ffffffffa02f763e>] ? sctp_setsockopt+0x14f/0xfee [sctp]
    kernel:  [<ffffffff810c11fb>] ? do_sync_write+0xab/0xeb
    kernel:  [<ffffffff810e82ab>] ? fsnotify+0x239/0x282
    kernel:  [<ffffffff810c2462>] ? alloc_file+0x18/0xb1
    kernel:  [<ffffffff8134a0b1>] ? compat_sys_setsockopt+0x1a5/0x1d9
    kernel:  [<ffffffff8134aaf1>] ? compat_sys_socketcall+0x143/0x1a4
    kernel:  [<ffffffff810467dc>] ? sysenter_dispatch+0x7/0x32
    
    Signed-off-by: Jacek Luczak <luczak.jacek@gmail.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    CC: Eric Dumazet <eric.dumazet@gmail.com>
    Reviewed-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit a0e3d9a50be5f6cffbc4fbc9e44105c5def26cf0
Author: Jacek Luczak <difrost.kernel@gmail.com>
Date:   Thu May 19 09:55:13 2011 +0000

    SCTP: fix race between sctp_bind_addr_free() and sctp_bind_addr_conflict()
    
    [ Upstream commit c182f90bc1f22ce5039b8722e45621d5f96862c2 ]
    
    During the sctp_close() call, we do not use rcu primitives to
    destroy the address list attached to the endpoint.  At the same
    time, we do the removal of addresses from this list before
    attempting to remove the socket from the port hash
    
    As a result, it is possible for another process to find the socket
    in the port hash that is in the process of being closed.  It then
    proceeds to traverse the address list to find the conflict, only
    to have that address list suddenly disappear without rcu() critical
    section.
    
    Fix issue by closing address list removal inside RCU critical
    section.
    
    Race can result in a kernel crash with general protection fault or
    kernel NULL pointer dereference:
    
    kernel: general protection fault: 0000 [#1] SMP
    kernel: RIP: 0010:[<ffffffffa02f3dde>]  [<ffffffffa02f3dde>] sctp_bind_addr_conflict+0x64/0x82 [sctp]
    kernel: Call Trace:
    kernel:  [<ffffffffa02f415f>] ? sctp_get_port_local+0x17b/0x2a3 [sctp]
    kernel:  [<ffffffffa02f3d45>] ? sctp_bind_addr_match+0x33/0x68 [sctp]
    kernel:  [<ffffffffa02f4416>] ? sctp_do_bind+0xd3/0x141 [sctp]
    kernel:  [<ffffffffa02f5030>] ? sctp_bindx_add+0x4d/0x8e [sctp]
    kernel:  [<ffffffffa02f5183>] ? sctp_setsockopt_bindx+0x112/0x4a4 [sctp]
    kernel:  [<ffffffff81089e82>] ? generic_file_aio_write+0x7f/0x9b
    kernel:  [<ffffffffa02f763e>] ? sctp_setsockopt+0x14f/0xfee [sctp]
    kernel:  [<ffffffff810c11fb>] ? do_sync_write+0xab/0xeb
    kernel:  [<ffffffff810e82ab>] ? fsnotify+0x239/0x282
    kernel:  [<ffffffff810c2462>] ? alloc_file+0x18/0xb1
    kernel:  [<ffffffff8134a0b1>] ? compat_sys_setsockopt+0x1a5/0x1d9
    kernel:  [<ffffffff8134aaf1>] ? compat_sys_socketcall+0x143/0x1a4
    kernel:  [<ffffffff810467dc>] ? sysenter_dispatch+0x7/0x32
    
    Signed-off-by: Jacek Luczak <luczak.jacek@gmail.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    CC: Eric Dumazet <eric.dumazet@gmail.com>
    Reviewed-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 8a07eb0a50aebc8c95478d49c28c7f8419a26cef
Author: Michio Honda <micchie@sfc.wide.ad.jp>
Date:   Tue Apr 26 20:19:36 2011 +0900

    sctp: Add ASCONF operation on the single-homed host
    
    In this case, the SCTP association transmits an ASCONF packet
    including addition of the new IP address and deletion of the old
    address.  This patch implements this functionality.
    In this case, the ASCONF chunk is added to the beginning of the
    queue, because the other chunks cannot be transmitted in this state.
    
    Signed-off-by: Michio Honda <micchie@sfc.wide.ad.jp>
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Acked-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9f7d653b67aed2d92540fbb0a8adaf32fcf352ae
Author: Michio Honda <micchie@sfc.wide.ad.jp>
Date:   Tue Apr 26 19:32:51 2011 +0900

    sctp: Add Auto-ASCONF support (core).
    
    SCTP reconfigure the IP addresses in the association by using
    ASCONF chunks as mentioned in RFC5061.  For example, we can
    start to use the newly configured IP address in the existing
    association.  This patch implements automatic ASCONF operation
    in the SCTP stack with address events in the host computer,
    which is called auto_asconf.
    
    Signed-off-by: Michio Honda <micchie@sfc.wide.ad.jp>
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Acked-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ced2dddf10f26f0aaff96f3345a3d876cea62f8
Author: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
Date:   Tue Apr 26 19:23:24 2011 +0900

    sctp: Allow regular C expression in 4th argument for SCTP_DEBUG_PRINTK_IPADDR macro.
    
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Acked-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5d414521663295ce25c90164f4d41a07ac846468
Author: David S. Miller <davem@davemloft.net>
Date:   Sat May 21 02:10:23 2011 -0400

    sctp: Fix build failure.
    
    Commit c182f90bc1f22ce5039b8722e45621d5f96862c2 ("SCTP: fix race
    between sctp_bind_addr_free() and sctp_bind_addr_conflict()") and
    commit 1231f0baa547a541a7481119323b7f964dda4788 ("net,rcu: convert
    call_rcu(sctp_local_addr_free) to kfree_rcu()"), happening in
    different trees, introduced a build failure.
    
    Simply make the SCTP race fix use kfree_rcu() too.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c182f90bc1f22ce5039b8722e45621d5f96862c2
Author: Jacek Luczak <difrost.kernel@gmail.com>
Date:   Thu May 19 09:55:13 2011 +0000

    SCTP: fix race between sctp_bind_addr_free() and sctp_bind_addr_conflict()
    
    During the sctp_close() call, we do not use rcu primitives to
    destroy the address list attached to the endpoint.  At the same
    time, we do the removal of addresses from this list before
    attempting to remove the socket from the port hash
    
    As a result, it is possible for another process to find the socket
    in the port hash that is in the process of being closed.  It then
    proceeds to traverse the address list to find the conflict, only
    to have that address list suddenly disappear without rcu() critical
    section.
    
    Fix issue by closing address list removal inside RCU critical
    section.
    
    Race can result in a kernel crash with general protection fault or
    kernel NULL pointer dereference:
    
    kernel: general protection fault: 0000 [#1] SMP
    kernel: RIP: 0010:[<ffffffffa02f3dde>]  [<ffffffffa02f3dde>] sctp_bind_addr_conflict+0x64/0x82 [sctp]
    kernel: Call Trace:
    kernel:  [<ffffffffa02f415f>] ? sctp_get_port_local+0x17b/0x2a3 [sctp]
    kernel:  [<ffffffffa02f3d45>] ? sctp_bind_addr_match+0x33/0x68 [sctp]
    kernel:  [<ffffffffa02f4416>] ? sctp_do_bind+0xd3/0x141 [sctp]
    kernel:  [<ffffffffa02f5030>] ? sctp_bindx_add+0x4d/0x8e [sctp]
    kernel:  [<ffffffffa02f5183>] ? sctp_setsockopt_bindx+0x112/0x4a4 [sctp]
    kernel:  [<ffffffff81089e82>] ? generic_file_aio_write+0x7f/0x9b
    kernel:  [<ffffffffa02f763e>] ? sctp_setsockopt+0x14f/0xfee [sctp]
    kernel:  [<ffffffff810c11fb>] ? do_sync_write+0xab/0xeb
    kernel:  [<ffffffff810e82ab>] ? fsnotify+0x239/0x282
    kernel:  [<ffffffff810c2462>] ? alloc_file+0x18/0xb1
    kernel:  [<ffffffff8134a0b1>] ? compat_sys_setsockopt+0x1a5/0x1d9
    kernel:  [<ffffffff8134aaf1>] ? compat_sys_socketcall+0x143/0x1a4
    kernel:  [<ffffffff810467dc>] ? sysenter_dispatch+0x7/0x32
    
    Signed-off-by: Jacek Luczak <luczak.jacek@gmail.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    CC: Eric Dumazet <eric.dumazet@gmail.com>
    Reviewed-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d9d8da805dcb503ef8ee49918a94d49085060f23
Author: David S. Miller <davem@davemloft.net>
Date:   Fri May 6 22:23:20 2011 -0700

    inet: Pass flowi to ->queue_xmit().
    
    This allows us to acquire the exact route keying information from the
    protocol, however that might be managed.
    
    It handles all of the possibilities, from the simplest case of storing
    the key in inet->cork.fl to the more complex setup SCTP has where
    individual transports determine the flow.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b57ae01a8a8446dbbed7365c9b05aef1fc6dea20
Author: David S. Miller <davem@davemloft.net>
Date:   Fri May 6 16:24:06 2011 -0700

    ipv4: Use cork flow in ip_queue_xmit()
    
    All invokers of ip_queue_xmit() must make certain that the
    socket is locked.  All of SCTP, TCP, DCCP, and L2TP now make
    sure this is the case.
    
    Therefore we can use the cork flow during output route lookup in
    ip_queue_xmit() when the socket route check fails.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit aadbd20969785c1d15a84d151fed0aa2a8873732
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    commit 51e97a12bef19b7e43199fc153cf9bd5f2140362 upstream.
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 9c6a02f41d10dc9fbf5dd42058e8846f38dd2d9a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Apr 26 21:52:27 2011 +0000

    sctp: make sctp over IPv6 work with IPsec
    
    SCTP never called xfrm_output after it's v6 route lookups so
    that never really worked with ipsec.  Additioanlly, we never
    passed port nubmers and protocol in the flowi, so any port
    based policies were never applied as well.  Now that we can
    fixed ipv6 routing lookup code, using ip6_dst_lookup_flow()
    and pass port numbers.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 58be7666a897bb756477da72859f515da35ab805
Author: Don Skidmore <donald.c.skidmore@intel.com>
Date:   Tue Apr 12 09:42:11 2011 +0000

    ixgbe: enable SCTP checksum offload for X540
    
    X540 supports SCTP checksum offload so enable it.  It was overlooked when X540
    support was initially added to the driver.
    
    Signed-off-by: Don Skidmore <donald.c.skidmore@intel.com>
    Tested-by: Evan Swanson <evan.swanson@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit e1cdd553d482ceb083fac5e544e8702fccefbfd6
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Sun Apr 17 17:29:03 2011 +0000

    sctp: implement event notification SCTP_SENDER_DRY_EVENT
    
    This patch implement event notification SCTP_SENDER_DRY_EVENT.
    SCTP Socket API Extensions:
    
      6.1.9. SCTP_SENDER_DRY_EVENT
    
      When the SCTP stack has no more user data to send or retransmit, this
      notification is given to the user. Also, at the time when a user app
      subscribes to this event, if there is no data to be sent or
      retransmit, the stack will immediately send up this notification.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ee916fd0fdb8f43dacaab431de3e1f7225039d72
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Sun Apr 17 17:28:01 2011 +0000

    sctp: change auth event type name to SCTP_AUTHENTICATION_EVENT
    
    This patch change the auth event type name to SCTP_AUTHENTICATION_EVENT,
    which is based on API extension compliance.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 209ba424c2c6e5ff4dd0ff79bb23659aa6048eac
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Sun Apr 17 17:27:08 2011 +0000

    sctp: implement socket option SCTP_GET_ASSOC_ID_LIST
    
    This patch Implement socket option SCTP_GET_ASSOC_ID_LIST.
    SCTP Socket API Extension:
    
      8.2.6. Get the Current Identifiers of Associations
             (SCTP_GET_ASSOC_ID_LIST)
    
      This option gets the current list of SCTP association identifiers of
      the SCTP associations handled by a one-to-many style socket.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit de6becdc0844ff92b38ffd9f0c4db1d3de02835f
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Apr 19 21:30:51 2011 +0000

    sctp: fix to check the source address of COOKIE-ECHO chunk
    
    SCTP does not check whether the source address of COOKIE-ECHO
    chunk is the original address of INIT chunk or part of the any
    address parameters saved in COOKIE in CLOSED state. So even if
    the COOKIE-ECHO chunk is from any address but with correct COOKIE,
    the COOKIE-ECHO chunk still be accepted. If the COOKIE is not from
    a valid address, the assoc should not be established.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0b8f9e25b0aaf5a5d9fd844a97e5c17746b865d4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Apr 19 21:28:26 2011 +0000

    sctp: remove completely unsed EMPTY state
    
    SCTP does not SCTP_STATE_EMPTY and we can never be in
    that state.  Remove useless code.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 66009927f1e7374afdc6f9fdd25c493ee4eadf7c
Author: Shan Wei <shanwei@cn.fujitsu.com>
Date:   Mon Apr 18 19:12:40 2011 +0000

    sctp: kill abandoned SCTP_CMD_TRANSMIT command
    
    Remove SCTP_CMD_TRANSMIT command as it never be used.
    
    Signed-off-by: Shan Wei <shanwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 799c3ec501854be3d6be56c1db5452e2e8371ef4
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    commit 51e97a12bef19b7e43199fc153cf9bd5f2140362 upstream
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>

commit 91eb7c08c6cb3b8eeba1c61f5753c56dcb77f018
Author: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
Date:   Wed Apr 13 13:51:38 2011 +0200

    netfilter: ipset: SCTP, UDPLITE support added
    
    SCTP and UDPLITE port support added to the hash:*port* set types.
    
    Signed-off-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
    Signed-off-by: Patrick McHardy <kaber@trash.net>

commit 028dba0ac3fc3c82da06110b011fce22a5ffad00
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Mar 31 23:38:54 2011 +0000

    sctp: fix auth_hmacs field's length of struct sctp_cookie
    
    auth_hmacs field of struct sctp_cookie is used for store
    Requested HMAC Algorithm Parameter, and each HMAC Identifier
    is 2 bytes, so the length should be:
      SCTP_AUTH_NUM_HMACS * sizeof(__u16) + 2
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a9ba6fef50d463c4d089c49df24678a6df1d80c9
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    commit 51e97a12bef19b7e43199fc153cf9bd5f2140362 upstream.
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Andi Kleen <ak@linux.intel.com>

commit 736561a01f11114146b1b7f82d486fa9c95828ef
Author: Simon Horman <horms@verge.net.au>
Date:   Mon Mar 21 15:18:01 2011 +0000

    IPVS: Use global mutex in ip_vs_app.c
    
    As part of the work to make IPVS network namespace aware
    __ip_vs_app_mutex was replaced by a per-namespace lock,
    ipvs->app_mutex. ipvs->app_key is also supplied for debugging purposes.
    
    Unfortunately this implementation results in ipvs->app_key residing
    in non-static storage which at the very least causes a lockdep warning.
    
    This patch takes the rather heavy-handed approach of reinstating
    __ip_vs_app_mutex which will cover access to the ipvs->list_head
    of all network namespaces.
    
    [   12.610000] IPVS: Creating netns size=2456 id=0
    [   12.630000] IPVS: Registered protocols (TCP, UDP, SCTP, AH, ESP)
    [   12.640000] BUG: key ffff880003bbf1a0 not in .data!
    [   12.640000] ------------[ cut here ]------------
    [   12.640000] WARNING: at kernel/lockdep.c:2701 lockdep_init_map+0x37b/0x570()
    [   12.640000] Hardware name: Bochs
    [   12.640000] Pid: 1, comm: swapper Tainted: G        W 2.6.38-kexec-06330-g69b7efe-dirty #122
    [   12.650000] Call Trace:
    [   12.650000]  [<ffffffff8102e685>] warn_slowpath_common+0x75/0xb0
    [   12.650000]  [<ffffffff8102e6d5>] warn_slowpath_null+0x15/0x20
    [   12.650000]  [<ffffffff8105967b>] lockdep_init_map+0x37b/0x570
    [   12.650000]  [<ffffffff8105829d>] ? trace_hardirqs_on+0xd/0x10
    [   12.650000]  [<ffffffff81055ad8>] debug_mutex_init+0x38/0x50
    [   12.650000]  [<ffffffff8104bc4c>] __mutex_init+0x5c/0x70
    [   12.650000]  [<ffffffff81685ee7>] __ip_vs_app_init+0x64/0x86
    [   12.660000]  [<ffffffff81685a3b>] ? ip_vs_init+0x0/0xff
    [   12.660000]  [<ffffffff811b1c33>] T.620+0x43/0x170
    [   12.660000]  [<ffffffff811b1e9a>] ? register_pernet_subsys+0x1a/0x40
    [   12.660000]  [<ffffffff81685a3b>] ? ip_vs_init+0x0/0xff
    [   12.660000]  [<ffffffff81685a3b>] ? ip_vs_init+0x0/0xff
    [   12.660000]  [<ffffffff811b1db7>] register_pernet_operations+0x57/0xb0
    [   12.660000]  [<ffffffff81685a3b>] ? ip_vs_init+0x0/0xff
    [   12.670000]  [<ffffffff811b1ea9>] register_pernet_subsys+0x29/0x40
    [   12.670000]  [<ffffffff81685f19>] ip_vs_app_init+0x10/0x12
    [   12.670000]  [<ffffffff81685a87>] ip_vs_init+0x4c/0xff
    [   12.670000]  [<ffffffff8166562c>] do_one_initcall+0x7a/0x12e
    [   12.670000]  [<ffffffff8166583e>] kernel_init+0x13e/0x1c2
    [   12.670000]  [<ffffffff8128c134>] kernel_thread_helper+0x4/0x10
    [   12.670000]  [<ffffffff8128ad40>] ? restore_args+0x0/0x30
    [   12.680000]  [<ffffffff81665700>] ? kernel_init+0x0/0x1c2
    [   12.680000]  [<ffffffff8128c130>] ? kernel_thread_helper+0x0/0x1global0
    
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Cc: Ingo Molnar <mingo@elte.hu>
    Cc: Eric Dumazet <eric.dumazet@gmail.com>
    Cc: Julian Anastasov <ja@ssi.bg>
    Cc: Hans Schillstrom <hans@schillstrom.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 57c247a86588c5602e26367728be7fd61d3b334a
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    commit 51e97a12bef19b7e43199fc153cf9bd5f2140362 upstream.
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 1209e7abd3be20e6a3464482c48b8bf9ecf7b997
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    commit 51e97a12bef19b7e43199fc153cf9bd5f2140362 upstream.
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 8525d6f84f576402278a552ed17d2ba3b61f8e3c
Author: Simon Horman <horms@verge.net.au>
Date:   Thu Feb 3 07:22:43 2011 +0900

    IPVS: Use correct lock in SCTP module
    
    Use sctp_app_lock instead of tcp_app_lock in the SCTP protocol module.
    
    This appears to be a typo introduced by the netns changes.
    
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Hans Schillstrom <hans.schillstrom@ericsson.com>

commit 4580ccc04ddd8c17a470573a7fdb8def2e036dfa
Author: Shan Wei <shanwei@cn.fujitsu.com>
Date:   Tue Jan 18 22:39:00 2011 +0000

    sctp: user perfect name for Delayed SACK Timer option
    
    The option name of Delayed SACK Timer should be SCTP_DELAYED_SACK,
    not SCTP_DELAYED_ACK.
    
    Left SCTP_DELAYED_ACK be concomitant with SCTP_DELAYED_SACK,
    for making compatibility with existing applications.
    
    Reference:
    8.1.19.  Get or Set Delayed SACK Timer (SCTP_DELAYED_SACK)
    http://tools.ietf.org/html/draft-ietf-tsvwg-sctpsocket-25)
    
    Signed-off-by: Shan Wei <shanwei@cn.fujitsu.com>
    Acked-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9497a0518e8183959e45da05f317f1cb36f2cd7c
Author: Jesse Gross <jesse@nicira.com>
Date:   Sun Jan 9 06:23:30 2011 +0000

    net offloading: Accept NETIF_F_HW_CSUM for all protocols.
    
    We currently only have software fallback for one type of checksum: the
    TCP/UDP one's complement.  This means that a protocol that uses hardware
    offloading for a different type of checksum (FCoE, SCTP) must directly
    check the device's features and do the right thing ahead of time.  By
    the time we get to dev_can_checksum(), we're only deciding whether to
    apply the one algorithm in software or hardware.  NETIF_F_HW_CSUM has the
    same capabilities as the software version, so we should always use it if
    present.  The primary advantage of this is multiply tagged vlans can use
    hardware checksumming.
    
    Signed-off-by: Jesse Gross <jesse@nicira.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7d743b7e952261f4d9ee091100b6403f3ce8a2af
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Dec 14 16:10:41 2010 +0000

    sctp: fix the return value of getting the sctp partial delivery point
    
    Get the sctp partial delivery point using SCTP_PARTIAL_DELIVERY_POINT
    socket option should return 0 if success, not -ENOTSUPP.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b4fe2a03422e6bd20bd8df5e428109a85c9ea961
Merge: 85cb7f1264c4 2a27a03d3a89
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Dec 14 17:33:40 2010 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (75 commits)
      pppoe.c: Fix kernel panic caused by __pppoe_xmit
      WAN: Fix a TX IRQ causing BUG() in PC300 and PCI200SYN drivers.
      bnx2x: Advance a version number to 1.60.01-0
      bnx2x: Fixed a compilation warning
      bnx2x: LSO code was broken on BE platforms
      qlge: Fix deadlock when cancelling worker.
      net: fix skb_defer_rx_timestamp()
      cxgb4vf: Ingress Queue Entry Size needs to be 64 bytes
      phy: add the IC+ IP1001 driver
      atm: correct sysfs 'device' link creation and parent relationships
      MAINTAINERS: remove me from tulip
      SCTP: Fix SCTP_SET_PEER_PRIMARY_ADDR to accpet v4mapped address
      enic: Bug Fix: Pass napi reference to the isr that services receive queue
      ipv6: fix nl group when advertising a new link
      connector: add module alias
      net: Document the kernel_recvmsg() function
      r8169: Fix runtime power management
      hso: IP checksuming doesn't work on GE0301 option cards
      xfrm: Fix xfrm_state_migrate leak
      net: Convert netpoll blocking api in bonding driver to be a counter
      ...

commit 40a010395cd66053f07bffeb3da5e44683bac30e
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Dec 7 17:11:09 2010 +0000

    SCTP: Fix SCTP_SET_PEER_PRIMARY_ADDR to accpet v4mapped address
    
    SCTP_SET_PEER_PRIMARY_ADDR does not accpet v4mapped address, using
    v4mapped address in SCTP_SET_PEER_PRIMARY_ADDR socket option will
    get -EADDRNOTAVAIL error if v4map is enabled. This patch try to
    fix it by mapping v4mapped address to v4 address if allowed.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 49b4a6546fac02f58784f0744e0f99a6562ccc03
Author: Shan Wei <shanwei@cn.fujitsu.com>
Date:   Mon Nov 29 00:14:58 2010 +0000

    sctp: kill unused macros in head file
    
    1. SCTP_CMD_NUM_VERBS,SCTP_CMD_MAX
    These two macros have never been used for several years since v2.6.12-rc2.
    
    2.sctp_port_rover,sctp_port_alloc_lock
    The commit 063930 abandoned global variables of port_rover and port_alloc_lock,
    but still keep two macros to refer to them.
    So, remove them now.
    
    commit 06393009000779b00a558fd2f280882cc7dc2008
    Author: Stephen Hemminger <shemminger@linux-foundation.org>
    Date:   Wed Oct 10 17:30:18 2007 -0700
    
        [SCTP]: port randomization
    
    Signed-off-by: Shan Wei <shanwei@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e2b4e216b7e9da09175c76887c754489681533b9
Author: Alexander Duyck <alexander.h.duyck@intel.com>
Date:   Tue Nov 16 19:27:04 2010 -0800

    ixgbe: cleanup ixgbe_set_tx_csum ethtool flags configuration
    
    This change makes it so that we always disable SCTP regardless of mac type
    since we shouldn't need to check mac type before disabling a feature that
    isn't supported on a given piece of hardware.
    
    Signed-off-by: Alexander Duyck <alexander.h.duyck@intel.com>
    Tested-by: Ross Brattain <ross.b.brattain@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>

commit 13f5bf18ba657d2d17c8fcf584e50359c718dd4b
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Oct 5 00:27:05 2010 -0700

    ipvs: Use frag walker helper in SCTP proto support.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Acked-by: Simon Horman <horms@verge.net.au>

commit 51e97a12bef19b7e43199fc153cf9bd5f2140362
Author: Dan Rosenberg <drosenberg@vsecurity.com>
Date:   Fri Oct 1 11:51:47 2010 +0000

    sctp: Fix out-of-bounds reading in sctp_asoc_get_hmac()
    
    The sctp_asoc_get_hmac() function iterates through a peer's hmac_ids
    array and attempts to ensure that only a supported hmac entry is
    returned.  The current code fails to do this properly - if the last id
    in the array is out of range (greater than SCTP_AUTH_HMAC_ID_MAX), the
    id integer remains set after exiting the loop, and the address of an
    out-of-bounds entry will be returned and subsequently used in the parent
    function, causing potentially ugly memory corruption.  This patch resets
    the id integer to 0 on encountering an invalid id so that NULL will be
    returned after finishing the loop if no valid ids are found.
    
    Signed-off-by: Dan Rosenberg <drosenberg@vsecurity.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d7e0d19aa0fdd22819d35db551bd54c1bcf9c2aa
Author: Dan Rosenberg <dan.j.rosenberg@gmail.com>
Date:   Fri Oct 1 11:16:58 2010 +0000

    sctp: prevent reading out-of-bounds memory
    
    Two user-controlled allocations in SCTP are subsequently dereferenced as
    sockaddr structs, without checking if the dereferenced struct members fall
    beyond the end of the allocated chunk.  There doesn't appear to be any
    information leakage here based on how these members are used and
    additional checking, but it's still worth fixing.
    
    [akpm@linux-foundation.org: remove unfashionable newlines, fix gmail tab->space conversion]
    Signed-off-by: Dan Rosenberg <dan.j.rosenberg@gmail.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Cc: David Miller <davem@davemloft.net>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 65040c33ee8d0199ab7686402bffdbf9e1e26cbe
Author: Diego Elio 'Flameeyes' Petten <flameeyes@gmail.com>
Date:   Fri Sep 3 03:47:03 2010 +0000

    sctp: implement SIOCINQ ioctl() (take 3)
    
    This simple patch copies the current approach for SIOCINQ ioctl() from DCCP
    into SCTP so that the userland code working with SCTP can use a similar
    interface across different protocols to know how much space to allocate for
    a buffer.
    
    Signed-off-by: Diego Elio Petten <flameeyes@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8ed2163ff3b6abc5143d46dea73e523b22a6f987
Author: Julian Anastasov <ja@ssi.bg>
Date:   Wed Sep 1 22:19:14 2010 +0000

    ipvs: use pkts for SCTP too
    
    Use correctly the in_pkts packet counter also for SCTP
    
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 43ba21b57a3e757000bfa8ccf46c81f232b4d881
Author: Nicolas Palix <npalix@diku.dk>
Date:   Tue Aug 24 17:39:04 2010 +0200

    Coccinelle: Add free/kfree.cocci
    
    Find a use after free.  Values of variables may imply that some
    execution paths are not possible, resulting in false positives.
    Another source of false positives are macros such as
    SCTP_DBG_OBJCNT_DEC that do not actually evaluate their argument
    
    Signed-off-by: Nicolas Palix <npalix@diku.dk>
    Signed-off-by: Julia Lawall <julia@diku.dk>
    Signed-off-by: Michal Marek <mmarek@suse.cz>

commit 145ce502e44b57c074c72cfdc855557e19026999
Author: Joe Perches <joe@perches.com>
Date:   Tue Aug 24 13:21:08 2010 +0000

    net/sctp: Use pr_fmt and pr_<level>
    
    Change SCTP_DEBUG_PRINTK and SCTP_DEBUG_PRINTK_IPADDR to
    use do { print } while (0) guards.
    Add SCTP_DEBUG_PRINTK_CONT to fix errors in log when
    lines were continued.
    Add #define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
    Add a missing newline in "Failed bind hash alloc"
    
    Signed-off-by: Joe Perches <joe@perches.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ca12f650743dbfc723de02e37f1ac562a1978b33
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Apr 28 10:30:59 2010 +0000

    sctp: Fix skb_over_panic resulting from multiple invalid parameter errors (CVE-2010-1173) (v4)
    
    commit 5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809 upstream.
    
    Ok, version 4
    
    Change Notes:
    1) Minor cleanups, from Vlads notes
    
    Summary:
    
    Hey-
            Recently, it was reported to me that the kernel could oops in the
    following way:
    
    <5> kernel BUG at net/core/skbuff.c:91!
    <5> invalid operand: 0000 [#1]
    <5> Modules linked in: sctp netconsole nls_utf8 autofs4 sunrpc iptable_filter
    ip_tables cpufreq_powersave parport_pc lp parport vmblock(U) vsock(U) vmci(U)
    vmxnet(U) vmmemctl(U) vmhgfs(U) acpiphp dm_mirror dm_mod button battery ac md5
    ipv6 uhci_hcd ehci_hcd snd_ens1371 snd_rawmidi snd_seq_device snd_pcm_oss
    snd_mixer_oss snd_pcm snd_timer snd_page_alloc snd_ac97_codec snd soundcore
    pcnet32 mii floppy ext3 jbd ata_piix libata mptscsih mptsas mptspi mptscsi
    mptbase sd_mod scsi_mod
    <5> CPU:    0
    <5> EIP:    0060:[<c02bff27>]    Not tainted VLI
    <5> EFLAGS: 00010216   (2.6.9-89.0.25.EL)
    <5> EIP is at skb_over_panic+0x1f/0x2d
    <5> eax: 0000002c   ebx: c033f461   ecx: c0357d96   edx: c040fd44
    <5> esi: c033f461   edi: df653280   ebp: 00000000   esp: c040fd40
    <5> ds: 007b   es: 007b   ss: 0068
    <5> Process swapper (pid: 0, threadinfo=c040f000 task=c0370be0)
    <5> Stack: c0357d96 e0c29478 00000084 00000004 c033f461 df653280 d7883180
    e0c2947d
    <5>        00000000 00000080 df653490 00000004 de4f1ac0 de4f1ac0 00000004
    df653490
    <5>        00000001 e0c2877a 08000800 de4f1ac0 df653490 00000000 e0c29d2e
    00000004
    <5> Call Trace:
    <5>  [<e0c29478>] sctp_addto_chunk+0xb0/0x128 [sctp]
    <5>  [<e0c2947d>] sctp_addto_chunk+0xb5/0x128 [sctp]
    <5>  [<e0c2877a>] sctp_init_cause+0x3f/0x47 [sctp]
    <5>  [<e0c29d2e>] sctp_process_unk_param+0xac/0xb8 [sctp]
    <5>  [<e0c29e90>] sctp_verify_init+0xcc/0x134 [sctp]
    <5>  [<e0c20322>] sctp_sf_do_5_1B_init+0x83/0x28e [sctp]
    <5>  [<e0c25333>] sctp_do_sm+0x41/0x77 [sctp]
    <5>  [<c01555a4>] cache_grow+0x140/0x233
    <5>  [<e0c26ba1>] sctp_endpoint_bh_rcv+0xc5/0x108 [sctp]
    <5>  [<e0c2b863>] sctp_inq_push+0xe/0x10 [sctp]
    <5>  [<e0c34600>] sctp_rcv+0x454/0x509 [sctp]
    <5>  [<e084e017>] ipt_hook+0x17/0x1c [iptable_filter]
    <5>  [<c02d005e>] nf_iterate+0x40/0x81
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e0c7f>] ip_local_deliver_finish+0xc6/0x151
    <5>  [<c02d0362>] nf_hook_slow+0x83/0xb5
    <5>  [<c02e0bb2>] ip_local_deliver+0x1a2/0x1a9
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e103e>] ip_rcv+0x334/0x3b4
    <5>  [<c02c66fd>] netif_receive_skb+0x320/0x35b
    <5>  [<e0a0928b>] init_stall_timer+0x67/0x6a [uhci_hcd]
    <5>  [<c02c67a4>] process_backlog+0x6c/0xd9
    <5>  [<c02c690f>] net_rx_action+0xfe/0x1f8
    <5>  [<c012a7b1>] __do_softirq+0x35/0x79
    <5>  [<c0107efb>] handle_IRQ_event+0x0/0x4f
    <5>  [<c01094de>] do_softirq+0x46/0x4d
    
    Its an skb_over_panic BUG halt that results from processing an init chunk in
    which too many of its variable length parameters are in some way malformed.
    
    The problem is in sctp_process_unk_param:
    if (NULL == *errp)
            *errp = sctp_make_op_error_space(asoc, chunk,
                                             ntohs(chunk->chunk_hdr->length));
    
            if (*errp) {
                    sctp_init_cause(*errp, SCTP_ERROR_UNKNOWN_PARAM,
                                     WORD_ROUND(ntohs(param.p->length)));
                    sctp_addto_chunk(*errp,
                            WORD_ROUND(ntohs(param.p->length)),
                                      param.v);
    
    When we allocate an error chunk, we assume that the worst case scenario requires
    that we have chunk_hdr->length data allocated, which would be correct nominally,
    given that we call sctp_addto_chunk for the violating parameter.  Unfortunately,
    we also, in sctp_init_cause insert a sctp_errhdr_t structure into the error
    chunk, so the worst case situation in which all parameters are in violation
    requires chunk_hdr->length+(sizeof(sctp_errhdr_t)*param_count) bytes of data.
    
    The result of this error is that a deliberately malformed packet sent to a
    listening host can cause a remote DOS, described in CVE-2010-1173:
    http://cve.mitre.org/cgi-bin/cvename.cgi?name=2010-1173
    
    I've tested the below fix and confirmed that it fixes the issue.  We move to a
    strategy whereby we allocate a fixed size error chunk and ignore errors we don't
    have space to report.  Tested by me successfully
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 4a1a39a88dc63f2d1373391fa4ad347e6dd94876
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Apr 28 10:30:59 2010 +0000

    sctp: Fix skb_over_panic resulting from multiple invalid parameter errors (CVE-2010-1173) (v4)
    
    commit 5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809 upstream.
    
    Ok, version 4
    
    Change Notes:
    1) Minor cleanups, from Vlads notes
    
    Summary:
    
    Hey-
            Recently, it was reported to me that the kernel could oops in the
    following way:
    
    <5> kernel BUG at net/core/skbuff.c:91!
    <5> invalid operand: 0000 [#1]
    <5> Modules linked in: sctp netconsole nls_utf8 autofs4 sunrpc iptable_filter
    ip_tables cpufreq_powersave parport_pc lp parport vmblock(U) vsock(U) vmci(U)
    vmxnet(U) vmmemctl(U) vmhgfs(U) acpiphp dm_mirror dm_mod button battery ac md5
    ipv6 uhci_hcd ehci_hcd snd_ens1371 snd_rawmidi snd_seq_device snd_pcm_oss
    snd_mixer_oss snd_pcm snd_timer snd_page_alloc snd_ac97_codec snd soundcore
    pcnet32 mii floppy ext3 jbd ata_piix libata mptscsih mptsas mptspi mptscsi
    mptbase sd_mod scsi_mod
    <5> CPU:    0
    <5> EIP:    0060:[<c02bff27>]    Not tainted VLI
    <5> EFLAGS: 00010216   (2.6.9-89.0.25.EL)
    <5> EIP is at skb_over_panic+0x1f/0x2d
    <5> eax: 0000002c   ebx: c033f461   ecx: c0357d96   edx: c040fd44
    <5> esi: c033f461   edi: df653280   ebp: 00000000   esp: c040fd40
    <5> ds: 007b   es: 007b   ss: 0068
    <5> Process swapper (pid: 0, threadinfo=c040f000 task=c0370be0)
    <5> Stack: c0357d96 e0c29478 00000084 00000004 c033f461 df653280 d7883180
    e0c2947d
    <5>        00000000 00000080 df653490 00000004 de4f1ac0 de4f1ac0 00000004
    df653490
    <5>        00000001 e0c2877a 08000800 de4f1ac0 df653490 00000000 e0c29d2e
    00000004
    <5> Call Trace:
    <5>  [<e0c29478>] sctp_addto_chunk+0xb0/0x128 [sctp]
    <5>  [<e0c2947d>] sctp_addto_chunk+0xb5/0x128 [sctp]
    <5>  [<e0c2877a>] sctp_init_cause+0x3f/0x47 [sctp]
    <5>  [<e0c29d2e>] sctp_process_unk_param+0xac/0xb8 [sctp]
    <5>  [<e0c29e90>] sctp_verify_init+0xcc/0x134 [sctp]
    <5>  [<e0c20322>] sctp_sf_do_5_1B_init+0x83/0x28e [sctp]
    <5>  [<e0c25333>] sctp_do_sm+0x41/0x77 [sctp]
    <5>  [<c01555a4>] cache_grow+0x140/0x233
    <5>  [<e0c26ba1>] sctp_endpoint_bh_rcv+0xc5/0x108 [sctp]
    <5>  [<e0c2b863>] sctp_inq_push+0xe/0x10 [sctp]
    <5>  [<e0c34600>] sctp_rcv+0x454/0x509 [sctp]
    <5>  [<e084e017>] ipt_hook+0x17/0x1c [iptable_filter]
    <5>  [<c02d005e>] nf_iterate+0x40/0x81
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e0c7f>] ip_local_deliver_finish+0xc6/0x151
    <5>  [<c02d0362>] nf_hook_slow+0x83/0xb5
    <5>  [<c02e0bb2>] ip_local_deliver+0x1a2/0x1a9
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e103e>] ip_rcv+0x334/0x3b4
    <5>  [<c02c66fd>] netif_receive_skb+0x320/0x35b
    <5>  [<e0a0928b>] init_stall_timer+0x67/0x6a [uhci_hcd]
    <5>  [<c02c67a4>] process_backlog+0x6c/0xd9
    <5>  [<c02c690f>] net_rx_action+0xfe/0x1f8
    <5>  [<c012a7b1>] __do_softirq+0x35/0x79
    <5>  [<c0107efb>] handle_IRQ_event+0x0/0x4f
    <5>  [<c01094de>] do_softirq+0x46/0x4d
    
    Its an skb_over_panic BUG halt that results from processing an init chunk in
    which too many of its variable length parameters are in some way malformed.
    
    The problem is in sctp_process_unk_param:
    if (NULL == *errp)
            *errp = sctp_make_op_error_space(asoc, chunk,
                                             ntohs(chunk->chunk_hdr->length));
    
            if (*errp) {
                    sctp_init_cause(*errp, SCTP_ERROR_UNKNOWN_PARAM,
                                     WORD_ROUND(ntohs(param.p->length)));
                    sctp_addto_chunk(*errp,
                            WORD_ROUND(ntohs(param.p->length)),
                                      param.v);
    
    When we allocate an error chunk, we assume that the worst case scenario requires
    that we have chunk_hdr->length data allocated, which would be correct nominally,
    given that we call sctp_addto_chunk for the violating parameter.  Unfortunately,
    we also, in sctp_init_cause insert a sctp_errhdr_t structure into the error
    chunk, so the worst case situation in which all parameters are in violation
    requires chunk_hdr->length+(sizeof(sctp_errhdr_t)*param_count) bytes of data.
    
    The result of this error is that a deliberately malformed packet sent to a
    listening host can cause a remote DOS, described in CVE-2010-1173:
    http://cve.mitre.org/cgi-bin/cvename.cgi?name=2010-1173
    
    I've tested the below fix and confirmed that it fixes the issue.  We move to a
    strategy whereby we allocate a fixed size error chunk and ignore errors we don't
    have space to report.  Tested by me successfully
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit b1b7bf1eede2a2d954dc0e4e7db6bb94e7650f60
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Apr 28 10:30:59 2010 +0000

    sctp: Fix skb_over_panic resulting from multiple invalid parameter errors (CVE-2010-1173) (v4)
    
    commit 5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809 upstream.
    
    Ok, version 4
    
    Change Notes:
    1) Minor cleanups, from Vlads notes
    
    Summary:
    
    Hey-
            Recently, it was reported to me that the kernel could oops in the
    following way:
    
    <5> kernel BUG at net/core/skbuff.c:91!
    <5> invalid operand: 0000 [#1]
    <5> Modules linked in: sctp netconsole nls_utf8 autofs4 sunrpc iptable_filter
    ip_tables cpufreq_powersave parport_pc lp parport vmblock(U) vsock(U) vmci(U)
    vmxnet(U) vmmemctl(U) vmhgfs(U) acpiphp dm_mirror dm_mod button battery ac md5
    ipv6 uhci_hcd ehci_hcd snd_ens1371 snd_rawmidi snd_seq_device snd_pcm_oss
    snd_mixer_oss snd_pcm snd_timer snd_page_alloc snd_ac97_codec snd soundcore
    pcnet32 mii floppy ext3 jbd ata_piix libata mptscsih mptsas mptspi mptscsi
    mptbase sd_mod scsi_mod
    <5> CPU:    0
    <5> EIP:    0060:[<c02bff27>]    Not tainted VLI
    <5> EFLAGS: 00010216   (2.6.9-89.0.25.EL)
    <5> EIP is at skb_over_panic+0x1f/0x2d
    <5> eax: 0000002c   ebx: c033f461   ecx: c0357d96   edx: c040fd44
    <5> esi: c033f461   edi: df653280   ebp: 00000000   esp: c040fd40
    <5> ds: 007b   es: 007b   ss: 0068
    <5> Process swapper (pid: 0, threadinfo=c040f000 task=c0370be0)
    <5> Stack: c0357d96 e0c29478 00000084 00000004 c033f461 df653280 d7883180
    e0c2947d
    <5>        00000000 00000080 df653490 00000004 de4f1ac0 de4f1ac0 00000004
    df653490
    <5>        00000001 e0c2877a 08000800 de4f1ac0 df653490 00000000 e0c29d2e
    00000004
    <5> Call Trace:
    <5>  [<e0c29478>] sctp_addto_chunk+0xb0/0x128 [sctp]
    <5>  [<e0c2947d>] sctp_addto_chunk+0xb5/0x128 [sctp]
    <5>  [<e0c2877a>] sctp_init_cause+0x3f/0x47 [sctp]
    <5>  [<e0c29d2e>] sctp_process_unk_param+0xac/0xb8 [sctp]
    <5>  [<e0c29e90>] sctp_verify_init+0xcc/0x134 [sctp]
    <5>  [<e0c20322>] sctp_sf_do_5_1B_init+0x83/0x28e [sctp]
    <5>  [<e0c25333>] sctp_do_sm+0x41/0x77 [sctp]
    <5>  [<c01555a4>] cache_grow+0x140/0x233
    <5>  [<e0c26ba1>] sctp_endpoint_bh_rcv+0xc5/0x108 [sctp]
    <5>  [<e0c2b863>] sctp_inq_push+0xe/0x10 [sctp]
    <5>  [<e0c34600>] sctp_rcv+0x454/0x509 [sctp]
    <5>  [<e084e017>] ipt_hook+0x17/0x1c [iptable_filter]
    <5>  [<c02d005e>] nf_iterate+0x40/0x81
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e0c7f>] ip_local_deliver_finish+0xc6/0x151
    <5>  [<c02d0362>] nf_hook_slow+0x83/0xb5
    <5>  [<c02e0bb2>] ip_local_deliver+0x1a2/0x1a9
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e103e>] ip_rcv+0x334/0x3b4
    <5>  [<c02c66fd>] netif_receive_skb+0x320/0x35b
    <5>  [<e0a0928b>] init_stall_timer+0x67/0x6a [uhci_hcd]
    <5>  [<c02c67a4>] process_backlog+0x6c/0xd9
    <5>  [<c02c690f>] net_rx_action+0xfe/0x1f8
    <5>  [<c012a7b1>] __do_softirq+0x35/0x79
    <5>  [<c0107efb>] handle_IRQ_event+0x0/0x4f
    <5>  [<c01094de>] do_softirq+0x46/0x4d
    
    Its an skb_over_panic BUG halt that results from processing an init chunk in
    which too many of its variable length parameters are in some way malformed.
    
    The problem is in sctp_process_unk_param:
    if (NULL == *errp)
            *errp = sctp_make_op_error_space(asoc, chunk,
                                             ntohs(chunk->chunk_hdr->length));
    
            if (*errp) {
                    sctp_init_cause(*errp, SCTP_ERROR_UNKNOWN_PARAM,
                                     WORD_ROUND(ntohs(param.p->length)));
                    sctp_addto_chunk(*errp,
                            WORD_ROUND(ntohs(param.p->length)),
                                      param.v);
    
    When we allocate an error chunk, we assume that the worst case scenario requires
    that we have chunk_hdr->length data allocated, which would be correct nominally,
    given that we call sctp_addto_chunk for the violating parameter.  Unfortunately,
    we also, in sctp_init_cause insert a sctp_errhdr_t structure into the error
    chunk, so the worst case situation in which all parameters are in violation
    requires chunk_hdr->length+(sizeof(sctp_errhdr_t)*param_count) bytes of data.
    
    The result of this error is that a deliberately malformed packet sent to a
    listening host can cause a remote DOS, described in CVE-2010-1173:
    http://cve.mitre.org/cgi-bin/cvename.cgi?name=2010-1173
    
    I've tested the below fix and confirmed that it fixes the issue.  We move to a
    strategy whereby we allocate a fixed size error chunk and ignore errors we don't
    have space to report.  Tested by me successfully
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit cf9b4812e18aab6f86ff998bd7425a9e823269c3
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Apr 30 22:41:10 2010 -0400

    sctp: fast recovery algorithm is per association.
    
    SCTP fast recovery algorithm really applies per association
    and impacts all transports.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 787a51a0878f7bee3a9a83040077301e1556b69a
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Fri Apr 30 22:41:09 2010 -0400

    sctp: implement sctp association probing module
    
    This patch implement sctp association probing module, the module
    will be called sctp_probe.
    
    This module allows for capturing the changes to SCTP association
    state in response to incoming packets. It is used for debugging
    SCTP congestion control algorithms.
    
    Usage:
      $ modprobe sctp_probe [full=n] [port=n] [bufsize=n]
      $ cat /proc/net/sctpprobe
    
      The output format is:
        TIME     ASSOC     LPORT RPORT MTU    RWND  UNACK <REMOTE-ADDR   STATE  CWND   SSTHRESH  INFLIGHT  PARTIAL_BYTES_ACKED MTU> ...
    
      The output will be like this:
        9.226086 c4064c48  9000  8000  1500    53352     1 *192.168.0.19  1     4380    54784     1252        0     1500
        9.287195 c4064c48  9000  8000  1500    45144     5 *192.168.0.19  1     5880    54784     6500        0     1500
        9.289130 c4064c48  9000  8000  1500    42724     5 *192.168.0.19  1     7380    54784     6500        0     1500
        9.620332 c4064c48  9000  8000  1500    48284     4 *192.168.0.19  1     8880    54784     5200        0     1500
        ......
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit bd69b981a354be40cc709f3046f0c56f00da6163
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Fri Apr 30 21:42:43 2010 -0400

    sctp: assure at least one T3-rtx timer is running if a FORWARD TSN is sent
    
    PR-SCTP extension section 3.5 Sender Side Implementation of PR-SCTP:
      C5) If a FORWARD TSN is sent, the sender MUST assure that at
          least one T3-rtx timer is running.
    
    So this patch fix to assure at least one T3-rtx timer is running
    if a FORWARD TSN is or will to sent.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Apr 28 10:30:59 2010 +0000

    sctp: Fix skb_over_panic resulting from multiple invalid parameter errors (CVE-2010-1173) (v4)
    
    Ok, version 4
    
    Change Notes:
    1) Minor cleanups, from Vlads notes
    
    Summary:
    
    Hey-
            Recently, it was reported to me that the kernel could oops in the
    following way:
    
    <5> kernel BUG at net/core/skbuff.c:91!
    <5> invalid operand: 0000 [#1]
    <5> Modules linked in: sctp netconsole nls_utf8 autofs4 sunrpc iptable_filter
    ip_tables cpufreq_powersave parport_pc lp parport vmblock(U) vsock(U) vmci(U)
    vmxnet(U) vmmemctl(U) vmhgfs(U) acpiphp dm_mirror dm_mod button battery ac md5
    ipv6 uhci_hcd ehci_hcd snd_ens1371 snd_rawmidi snd_seq_device snd_pcm_oss
    snd_mixer_oss snd_pcm snd_timer snd_page_alloc snd_ac97_codec snd soundcore
    pcnet32 mii floppy ext3 jbd ata_piix libata mptscsih mptsas mptspi mptscsi
    mptbase sd_mod scsi_mod
    <5> CPU:    0
    <5> EIP:    0060:[<c02bff27>]    Not tainted VLI
    <5> EFLAGS: 00010216   (2.6.9-89.0.25.EL)
    <5> EIP is at skb_over_panic+0x1f/0x2d
    <5> eax: 0000002c   ebx: c033f461   ecx: c0357d96   edx: c040fd44
    <5> esi: c033f461   edi: df653280   ebp: 00000000   esp: c040fd40
    <5> ds: 007b   es: 007b   ss: 0068
    <5> Process swapper (pid: 0, threadinfo=c040f000 task=c0370be0)
    <5> Stack: c0357d96 e0c29478 00000084 00000004 c033f461 df653280 d7883180
    e0c2947d
    <5>        00000000 00000080 df653490 00000004 de4f1ac0 de4f1ac0 00000004
    df653490
    <5>        00000001 e0c2877a 08000800 de4f1ac0 df653490 00000000 e0c29d2e
    00000004
    <5> Call Trace:
    <5>  [<e0c29478>] sctp_addto_chunk+0xb0/0x128 [sctp]
    <5>  [<e0c2947d>] sctp_addto_chunk+0xb5/0x128 [sctp]
    <5>  [<e0c2877a>] sctp_init_cause+0x3f/0x47 [sctp]
    <5>  [<e0c29d2e>] sctp_process_unk_param+0xac/0xb8 [sctp]
    <5>  [<e0c29e90>] sctp_verify_init+0xcc/0x134 [sctp]
    <5>  [<e0c20322>] sctp_sf_do_5_1B_init+0x83/0x28e [sctp]
    <5>  [<e0c25333>] sctp_do_sm+0x41/0x77 [sctp]
    <5>  [<c01555a4>] cache_grow+0x140/0x233
    <5>  [<e0c26ba1>] sctp_endpoint_bh_rcv+0xc5/0x108 [sctp]
    <5>  [<e0c2b863>] sctp_inq_push+0xe/0x10 [sctp]
    <5>  [<e0c34600>] sctp_rcv+0x454/0x509 [sctp]
    <5>  [<e084e017>] ipt_hook+0x17/0x1c [iptable_filter]
    <5>  [<c02d005e>] nf_iterate+0x40/0x81
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e0c7f>] ip_local_deliver_finish+0xc6/0x151
    <5>  [<c02d0362>] nf_hook_slow+0x83/0xb5
    <5>  [<c02e0bb2>] ip_local_deliver+0x1a2/0x1a9
    <5>  [<c02e0bb9>] ip_local_deliver_finish+0x0/0x151
    <5>  [<c02e103e>] ip_rcv+0x334/0x3b4
    <5>  [<c02c66fd>] netif_receive_skb+0x320/0x35b
    <5>  [<e0a0928b>] init_stall_timer+0x67/0x6a [uhci_hcd]
    <5>  [<c02c67a4>] process_backlog+0x6c/0xd9
    <5>  [<c02c690f>] net_rx_action+0xfe/0x1f8
    <5>  [<c012a7b1>] __do_softirq+0x35/0x79
    <5>  [<c0107efb>] handle_IRQ_event+0x0/0x4f
    <5>  [<c01094de>] do_softirq+0x46/0x4d
    
    Its an skb_over_panic BUG halt that results from processing an init chunk in
    which too many of its variable length parameters are in some way malformed.
    
    The problem is in sctp_process_unk_param:
    if (NULL == *errp)
            *errp = sctp_make_op_error_space(asoc, chunk,
                                             ntohs(chunk->chunk_hdr->length));
    
            if (*errp) {
                    sctp_init_cause(*errp, SCTP_ERROR_UNKNOWN_PARAM,
                                     WORD_ROUND(ntohs(param.p->length)));
                    sctp_addto_chunk(*errp,
                            WORD_ROUND(ntohs(param.p->length)),
                                      param.v);
    
    When we allocate an error chunk, we assume that the worst case scenario requires
    that we have chunk_hdr->length data allocated, which would be correct nominally,
    given that we call sctp_addto_chunk for the violating parameter.  Unfortunately,
    we also, in sctp_init_cause insert a sctp_errhdr_t structure into the error
    chunk, so the worst case situation in which all parameters are in violation
    requires chunk_hdr->length+(sizeof(sctp_errhdr_t)*param_count) bytes of data.
    
    The result of this error is that a deliberately malformed packet sent to a
    listening host can cause a remote DOS, described in CVE-2010-1173:
    http://cve.mitre.org/cgi-bin/cvename.cgi?name=2010-1173
    
    I've tested the below fix and confirmed that it fixes the issue.  We move to a
    strategy whereby we allocate a fixed size error chunk and ignore errors we don't
    have space to report.  Tested by me successfully
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 486f50ca796a2572c42c34dd4378cdc8eeb0b137
Author: Brian Haley <brian.haley@hp.com>
Date:   Sat Apr 3 15:10:21 2010 -0700

    SCTP: Change to use ipv6_addr_copy()
    
    Change SCTP IPv6 code to use ipv6_addr_copy()
    
    Signed-off-by: Brian Haley <brian.haley@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2906f66a5682e5670a5eefe991843689b8d8563f
Author: Venkata Mohan Reddy <mohanreddykv@gmail.com>
Date:   Thu Feb 18 12:31:05 2010 +0100

    ipvs: SCTP Trasport Loadbalancing Support
    
    Enhance IPVS to load balance SCTP transport protocol packets. This is done
    based on the SCTP rfc 4960. All possible control chunks have been taken
    care. The state machine used in this code looks some what lengthy. I tried
    to make the state machine easy to understand.
    
    Signed-off-by: Venkata Mohan Reddy Koppula <mohanreddykv@gmail.com>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Patrick McHardy <kaber@trash.net>

commit cf4f7e8c47b3298cf90239bad5d86fdcad0c89eb
Author: Sean Hefty <sean.hefty@intel.com>
Date:   Thu Feb 11 15:40:25 2010 -0800

    RDMA/cm: Remove unused definition of RDMA_PS_SCTP
    
    The defined SCTP number is incorrect (0x83, rather than 0x84), and
    since it is not used anywhere, simply remove the definition.
    
    Signed-off-by: Sean Hefty <sean.hefty@intel.com>
    Signed-off-by: Roland Dreier <rolandd@cisco.com>

commit d218d11133d888f9745802146a50255a4781d37a
Author: Stephen Hemminger <shemminger@vyatta.com>
Date:   Mon Jan 11 16:28:01 2010 -0800

    tcp: Generalized TTL Security Mechanism
    
    This patch adds the kernel portions needed to implement
    RFC 5082 Generalized TTL Security Mechanism (GTSM).
    It is a lightweight security measure against forged
    packets causing DoS attacks (for BGP).
    
    This is already implemented the same way in BSD kernels.
    For the necessary Quagga patch
      http://www.gossamer-threads.com/lists/quagga/dev/17389
    
    Description from Cisco
      http://www.cisco.com/en/US/docs/ios/12_3t/12_3t7/feature/guide/gt_btsh.html
    
    It does add one byte to each socket structure, but I did
    a little rearrangement to reuse a hole (on 64 bit), but it
    does grow the structure on 32 bit
    
    This should be documented on ip(4) man page and the Glibc in.h
    file also needs update.  IPV6_MINHOPLIMIT should also be added
    (although BSD doesn't support that).
    
    Only TCP is supported, but could also be added to UDP, DCCP, SCTP
    if desired.
    
    Signed-off-by: Stephen Hemminger <shemminger@vyatta.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a242b41dedfe0fd51ab1c906daa703c09b196744
Author: Amerigo Wang <amwang@redhat.com>
Date:   Mon Nov 23 15:53:58 2009 -0500

    sctp: remove deprecated SCTP_GET_*_OLD stuffs
    
    SCTP_GET_*_OLD stuffs are schedlued to be removed.
    
    Cc: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: WANG Cong <amwang@redhat.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 37051f73862d15862aecc08b887b2884137af327
Author: Andrei Pelinescu-Onciul <andrei@iptel.org>
Date:   Mon Nov 23 15:53:57 2009 -0500

    sctp: allow setting path_maxrxt independent of SPP_PMTUD_ENABLE
    
    Since draft-ietf-tsvwg-sctpsocket-15.txt, setting the
    SPP_MTUD_ENABLE flag when changing pathmaxrxt via the
    SCTP_PEER_ADDR_PARAMS setsockopt is not required any
    longer.
    
    Signed-off-by: Andrei Pelinescu-Onciul <andrei@iptel.org>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b93d6471748de2ce02cc24774b774deb306a57a8
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Nov 23 15:53:56 2009 -0500

    sctp: implement the sender side for SACK-IMMEDIATELY extension
    
    This patch implement the sender side for SACK-IMMEDIATELY
    extension.
    
      Section 4.1.  Sender Side Considerations
    
      Whenever the sender of a DATA chunk can benefit from the
      corresponding SACK chunk being sent back without delay, the sender
      MAY set the I-bit in the DATA chunk header.
    
      Reasons for setting the I-bit include
    
      o  The sender is in the SHUTDOWN-PENDING state.
    
      o  The application requests to set the I-bit of the last DATA chunk
         of a user message when providing the user message to the SCTP
         implementation.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 6dc7694f9df20f148076d82d00cb3663afb0b000
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Nov 23 15:53:53 2009 -0500

    sctp: implement the receiver side for SACK-IMMEDIATELY extension
    
    This patch implement the receiver side for SACK-IMMEDIATELY
    extension:
    
      Section 4.2.  Receiver Side Considerations
    
      On reception of an SCTP packet containing a DATA chunk with the I-bit
      set, the receiver SHOULD NOT delay the sending of the corresponding
      SACK chunk and SHOULD send it back immediately.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit a78102e74e782914039cd8a6939532649825a2e3
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Nov 11 11:54:37 2009 +0000

    sctp: Set socket source address when additing first transport
    
    Recent commits
            sctp: Get rid of an extra routing lookup when adding a transport
    and
            sctp: Set source addresses on the association before adding transports
    
    changed when routes are added to the sctp transports.  As such,
    we didn't set the socket source address correctly when adding the first
    transport.  The first transport is always the primary/active one, so
    when adding it, set the socket source address.  This was causing
    regression failures in SCTP tests.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5b043fb08e1b9e10eef7cc41512462f99811e96e
Author: Alexander Duyck <alexander.h.duyck@intel.com>
Date:   Tue Oct 27 23:52:31 2009 +0000

    igb: open up SCTP checksum offloads to all MACs 82576 and newer
    
    Going forward the plan is to have the MACs support SCTP checksum offloads
    so change the check from == to >=.
    
    Signed-off-by: Alexander Duyck <alexander.h.duyck@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 04bedd79a7037ee7af816b06c60c738144475c4a
Author: David Teigland <teigland@redhat.com>
Date:   Fri Sep 18 14:31:47 2009 -0500

    dlm: fix lowcomms_connect_node for sctp
    
    The recently added dlm_lowcomms_connect_node() from
    391fbdc5d527149578490db2f1619951d91f3561 does not work
    when using SCTP instead of TCP.  The sctp connection code
    has nothing to do without data to send.  Check for no data
    in the sctp connection code and do nothing instead of
    triggering a BUG.  Also have connect_node() do nothing
    when the protocol is sctp.
    
    Signed-off-by: David Teigland <teigland@redhat.com>

commit 723884339f90a9c420783135168cc1045750eb5d
Author: Bhaskar Dutta <bhaskie@gmail.com>
Date:   Thu Sep 3 17:25:47 2009 +0530

    sctp: Sysctl configuration for IPv4 Address Scoping
    
    This patch introduces a new sysctl option to make IPv4 Address Scoping
    configurable <draft-stewart-tsvwg-sctp-ipv4-00.txt>.
    
    In networking environments where DNAT rules in iptables prerouting
    chains convert destination IP's to link-local/private IP addresses,
    SCTP connections fail to establish as the INIT chunk is dropped by the
    kernel due to address scope match failure.
    For example to support overlapping IP addresses (same IP address with
    different vlan id) a Layer-5 application listens on link local IP's,
    and there is a DNAT rule that maps the destination IP to a link local
    IP. Such applications never get the SCTP INIT if the address-scoping
    draft is strictly followed.
    
    This sysctl configuration allows SCTP to function in such
    unconventional networking environments.
    
    Sysctl options:
    0 - Disable IPv4 address scoping draft altogether
    1 - Enable IPv4 address scoping (default, current behavior)
    2 - Enable address scoping but allow IPv4 private addresses in init/init-ack
    3 - Enable address scoping but allow IPv4 link local address in init/init-ack
    
    Signed-off-by: Bhaskar Dutta <bhaskar.dutta@globallogic.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit f68b2e05f326971cd76c65aa91a1a41771dd7485
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 4 18:21:00 2009 -0400

    sctp: Fix SCTP_MAXSEG socket option to comply to spec.
    
    We had a bug that we never stored the user-defined value for
    MAXSEG when setting the value on an association.  Thus future
    PMTU events ended up re-writing the frag point and increasing
    it past user limit.  Additionally, when setting the option on
    the socket/endpoint, we effect all current associations, which
    is against spec.
    
    Now, we store the user 'maxseg' value along with the computed
    'frag_point'.  We inherit 'maxseg' from the socket at association
    creation and use it as an upper limit for 'frag_point' when its
    set.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit cb95ea32a457871f72752164de8d94fa20f4703c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 4 18:20:59 2009 -0400

    sctp: Don't do NAGLE delay on large writes that were fragmented small
    
    SCTP will delay the last part of a large write due to NAGLE, if that
    part is smaller then MTU.  Since we are doing large writes, we might
    as well send the last portion now instead of waiting untill the next
    large write happens.  The small portion will be sent as is regardless,
    so it's better to not delay it.
    
    This is a result of much discussions with Wei Yongjun <yjwei@cn.fujitsu.com>
    and Doug Graham <dgraham@nortel.com>.  Many thanks go out to them.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b29e7907288554db9c987c36facfd0304ee8ff5a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 4 18:20:59 2009 -0400

    sctp: Nagle delay should be based on path mtu
    
    The decision to delay due to Nagle should be based on the path mtu
    and future packet size.  We currently incorrectly base it on
    'frag_point' which is the SCTP DATA segment size, and also we do
    not count DATA chunk header overhead in the computation.  This
    actuall allows situations where a user can set low 'frag_point',
    and then send small messages without delay.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 4d3c46e6833208428d366630aa708f6876e61fc1
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 4 18:20:59 2009 -0400

    sctp: drop a_rwnd to 0 when receive buffer overflows.
    
    SCTP has a problem that when small chunks are used, it is possible
    to exhaust the receiver buffer without fully closing receive window.
    This happens due to all overhead that we have account for with small
    messages.  To fix this, when receive buffer is exceeded, we'll drop
    the window to 0 and save the 'drop' portion.  When application starts
    reading data and freeing up recevie buffer space, we'll wait until
    we've reached the 'drop' window and then add back this 'drop' one
    mtu at a time.  This worked well in testing and under stress produced
    rather even recovery.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b9f8478682445c2a3e0b87718a0563ef543ad94e
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 26 09:36:25 2009 -0400

    sctp: Fix error count increments that were results of HEARTBEATS
    
    SCTP RFC 4960 states that unacknowledged HEARTBEATS count as
    errors agains a given transport or endpoint.  As such, we
    should increment the error counts for only for unacknowledged
    HB, otherwise we detect failure too soon.  This goes for both
    the overall error count and the path error count.
    
    Now, there is a difference in how the detection is done
    between the two.  The path error detection is done after
    the increment, so to detect it properly, we actually need
    to exceed the path threshold.  The overall error detection
    is done _BEFORE_ the increment.  Thus to detect the failure,
    it's enough for the error count to match the threshold.
    This is why all the state functions use '>=' to detect failure,
    while path detection uses '>'.
    
    Thanks goes to Chunbo Luo <chunbo.luo@windriver.com> who first
    proposed patches to fix this issue and made me re-read the spec
    and the code to figure out how this cruft really works.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 9c5c62be2f794c7cee533d856f9f34c3cf21ff1b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Aug 10 13:51:03 2009 -0400

    sctp: Send user messages to the lower layer as one
    
    Currenlty, sctp breaks up user messages into fragments and
    sends each fragment to the lower layer by itself.  This means
    that for each fragment we go all the way down the stack
    and back up.  This also discourages bundling of multiple
    fragments when they can fit into a sigle packet (ex: due
    to user setting a low fragmentation threashold).
    
    We introduce a new command SCTP_CMD_SND_MSG and hand the
    whole message down state machine.  The state machine and
    the side-effect parser will cork the queue, add all chunks
    from the message to the queue, and then un-cork the queue
    thus causing the chunks to get transmitted.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 3e62abf92f34d75fe22352d8d102e3cd2755804d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 4 18:20:56 2009 -0400

    sctp: Fix data segmentation with small frag_size
    
    Since an application may specify the maximum SCTP fragment size
    that all data should be fragmented to, we need to fix how
    we do segmentation.   Right now, if a user specifies a small
    fragment size, the segment size can go negative in the presence
    of AUTH or COOKIE_ECHO bundling.
    
    What we need to do is track the largest possbile DATA chunk that
    can fit into the mtu.  Then if the fragment size specified is
    bigger then this maximum length, we'll shrink it down.  Otherwise,
    we just use the smaller segment size without changing it further.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit af87b823ca2b05257192e8d48dc686db6173d7b2
Author: Doug Graham <dgraham@nortel.com>
Date:   Wed Jul 29 12:05:57 2009 -0400

    sctp: Fix piggybacked ACKs
    
    This patch corrects the conditions under which a SACK will be piggybacked
    on a DATA packet.  The previous condition was incorrect due to a
    misinterpretation of RFC 4960 and/or RFC 2960.  Specifically, the
    following paragraph from section 6.2 had not been implemented correctly:
    
       Before an endpoint transmits a DATA chunk, if any received DATA
       chunks have not been acknowledged (e.g., due to delayed ack), the
       sender should create a SACK and bundle it with the outbound DATA
       chunk, as long as the size of the final SCTP packet does not exceed
       the current MTU.  See Section 6.2.
    
    When about to send a DATA chunk, the code now checks to see if the SACK
    timer is running.  If it is, we know we have a SACK to send to the
    peer, so we append the SACK (assuming available space in the packet)
    and turn off the timer.  For a simple request-response scenario, this
    will result in the SACK being bundled with the response, meaning the
    the SACK is received quickly by the client, and also meaning that no
    separate SACK packet needs to be sent by the server to acknowledge the
    request.  Prior to this patch, a separate SACK packet would have been
    sent by the server SCTP only after its delayed-ACK timer had expired
    (usually 200ms).  This is wasteful of bandwidth, and can also have a
    major negative impact on performance due the interaction of delayed ACKs
    with the Nagle algorithm.
    
    Signed-off-by: Doug Graham <dgraham@nortel.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 549812799c8495451e71ebd9f6a862b33120a35a
Author: Rafael Laufer <rlaufer@cs.ucla.edu>
Date:   Mon Aug 10 10:08:27 2009 +0200

    netfilter: nf_conntrack: add SCTP support for SO_ORIGINAL_DST
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>

commit 59cae0092e4da753b5a2adb32933e0d1b223bcc5
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Jul 2 16:59:49 2009 +0000

    xfrm6: fix the proto and ports decode of sctp protocol
    
    The SCTP pushed the skb above the sctp chunk header, so the
    check of pskb_may_pull(skb, nh + offset + 1 - skb->data) in
    _decode_session6() will never return 0 and the ports decode
    of sctp will always fail. (nh + offset + 1 - skb->data < 0)
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c615c9f3f3cea60279b1bb38e8ef27bd575ecd0c
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Jul 2 16:57:23 2009 +0000

    xfrm4: fix the ports decode of sctp protocol
    
    The SCTP pushed the skb data above the sctp chunk header, so the check
    of pskb_may_pull(skb, xprth + 4 - skb->data) in _decode_session4() will
    never return 0 because xprth + 4 - skb->data < 0, the ports decode of
    sctp will always fail.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a987f762cafb25c0fedf88f15e328edd897210ed
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Apr 7 15:44:29 2009 +0800

    sctp: fix report unrecognized parameter in ACSONF-ACK
    
    RFC5061 Section 5.2.  Upon Reception of an ASCONF Chunk
    
    V2)  In processing the chunk, the receiver should build a
         response message with the appropriate error TLVs, as
         specified in the Parameter type bits, for any ASCONF
         Parameter it does not understand.  To indicate an
         unrecognized parameter, Cause Type 8 should be used as
         defined in the ERROR in Section 3.3.10.8, [RFC4960].  The
         endpoint may also use the response to carry rejections for
         other reasons, such as resource shortages, etc., using the
         Error Cause TLV and an appropriate error condition.
    
    So we should indicate an unrecognized parameter with error
    SCTP_ERROR_UNKNOWN_PARAM in ACSONF-ACK chunk, not
    SCTP_ERROR_INV_PARAM.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 17e6e4eac070607a35464ea7e2c5eceac32e5eca
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Tue Jun 2 20:08:46 2009 +0200

    netfilter: conntrack: simplify event caching system
    
    This patch simplifies the conntrack event caching system by removing
    several events:
    
     * IPCT_[*]_VOLATILE, IPCT_HELPINFO and IPCT_NATINFO has been deleted
       since the have no clients.
     * IPCT_COUNTER_FILLING which is a leftover of the 32-bits counter
       days.
     * IPCT_REFRESH which is not of any use since we always include the
       timeout in the messages.
    
    After this patch, the existing events are:
    
     * IPCT_NEW, IPCT_RELATED and IPCT_DESTROY, that are used to identify
     addition and deletion of entries.
     * IPCT_STATUS, that notes that the status bits have changes,
     eg. IPS_SEEN_REPLY and IPS_ASSURED.
     * IPCT_PROTOINFO, that reports that internal protocol information has
     changed, eg. the TCP, DCCP and SCTP protocol state.
     * IPCT_HELPER, that a helper has been assigned or unassigned to this
     entry.
     * IPCT_MARK and IPCT_SECMARK, that reports that the mark has changed, this
     covers the case when a mark is set to zero.
     * IPCT_NATSEQADJ, to report that there's updates in the NAT sequence
     adjustment.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

commit 45a5ead0220cc7cc70f6961879decffbd0a54cc0
Author: Jesse Brandeburg <jesse.brandeburg@intel.com>
Date:   Mon Apr 27 22:36:35 2009 +0000

    ixgbe: enable hardware offload for sctp
    
    Inspired by: Vlad Yasevich <vladislav.yasevich@hp.com>
    
    This is the code to enable ixgbe for hardware offload support
    of CRC32c on both transmit and receive of SCTP traffic.
    
    only 82599 supports this offload, not 82598.
    
    Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b9473560c6d882e0fbd3a8817e906c847b11c722
Author: Jesse Brandeburg <jesse.brandeburg@intel.com>
Date:   Mon Apr 27 22:36:13 2009 +0000

    igb: Enable SCTP checksum offloading
    
    Originally from: Vlad Yasevich <vladislav.yasevich@hp.com>
    
    This patch, both the driver portion and the sctp code was
    modified by Jesse Brandeburg and is
    
    Copyright(c) 2009 Intel Corporation.
    
    Thanks go to Vlad for starting this work.
    
    Intel 82576 chipset supports SCTP checksum offloading.  This
    patch enables this functionality in the driver.  A new NETIF
    feature is introduced for SCTP checksum offload.  If the driver
    supports CRC32c checksum, it can set this feature flag.  The
    hardware can offload both transmit and receive.
    
    Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8dc92f7e2ecfd93f5c57da78594a7a5482e2c15e
Author: Jesse Brandeburg <jesse.brandeburg@intel.com>
Date:   Mon Apr 27 22:35:52 2009 +0000

    sctp: add feature bit for SCTP offload in hardware
    
    this is the sctp code to enable hardware crc32c offload for
    adapters that support it.
    
    Originally by: Vlad Yasevich <vladislav.yasevich@hp.com>
    
    modified by Jesse Brandeburg <jesse.brandeburg@intel.com>
    
    Signed-off-by: Jesse Brandeburg <jesse.brandeburg@intel.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 76595024ffab3599bd28ea014f6c23c1a8c8dd2c
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Mar 12 09:49:19 2009 +0000

    sctp: fix to send FORWARD-TSN chunk only if peer has such capable
    
    RFC3758 Section 3.3.1.  Sending Forward-TSN-Supported param in INIT
    
       Note that if the endpoint chooses NOT to include the parameter, then
       at no time during the life of the association can it send or process
       a FORWARD TSN.
    
    If peer does not support PR-SCTP capable, don't send FORWARD-TSN chunk
    to peer.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit df0b4a5080ca668636831b641a6356500fb5c637
Merge: 39a3478c1c01 c0350024723b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Mar 9 09:15:40 2009 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (29 commits)
      p54: fix race condition in memory management
      cfg80211: test before subtraction on unsigned
      iwlwifi: fix error flow in iwl*_pci_probe
      rt2x00 : more devices to rt73usb.c
      rt2x00 : more devices to rt2500usb.c
      bonding: Fix device passed into ->ndo_neigh_setup().
      vlan: Fix vlan-in-vlan crashes.
      net: Fix missing dev->neigh_setup in register_netdevice().
      tmspci: fix request_irq race
      pkt_sched: act_police: Fix a rate estimator test.
      tg3: Fix 5906 link problems
      SCTP: change sctp_ctl_sock_init() to try IPv4 if IPv6 fails
      IPv6: add "disable" module parameter support to ipv6.ko
      sungem: another error printed one too early
      aoe: error printed 1 too early
      net pcmcia: worklimit reaches -1
      net: more timeouts that reach -1
      net: fix tokenring license
      dm9601: new vendor/product IDs
      netlink: invert error code in netlink_set_err()
      ...

commit fb13d9f9e450bceafd88ac8a98f7a98e8096a5fe
Author: Brian Haley <brian.haley@hp.com>
Date:   Wed Mar 4 03:20:26 2009 -0800

    SCTP: change sctp_ctl_sock_init() to try IPv4 if IPv6 fails
    
    Change sctp_ctl_sock_init() to try IPv4 if IPv6 socket registration
    fails.  Required if the IPv6 module is loaded with "disable=1", else
    SCTP will fail to load.
    
    Signed-off-by: Brian Haley <brian.haley@hp.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3df2678737974accf437dad11e584c1871a3ede3
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Mar 2 06:46:51 2009 +0000

    sctp: fix kernel panic with ERROR chunk containing too many error causes
    
    If ERROR chunk is received with too many error causes in ESTABLISHED
    state, the kernel get panic.
    
    This is because sctp limit the max length of cmds to 14, but while
    ERROR chunk is received, one error cause will add around 2 cmds by
    sctp_add_cmd_sf(). So many error causes will fill the limit of cmds
    and panic.
    
    This patch fixed the problem.
    
    This bug can be test by SCTP Conformance Test Suite
    <http://networktest.sourceforge.net/>.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit faee47cdbfe8d74a1573c2f81ea6dbb08d735be6
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Feb 13 08:33:43 2009 +0000

    sctp: Fix the RTO-doubling on idle-link heartbeats
    
    SCTP incorrectly doubles rto ever time a Hearbeat chunk
    is generated.   However RFC 4960 states:
    
       On an idle destination address that is allowed to heartbeat, it is
       recommended that a HEARTBEAT chunk is sent once per RTO of that
       destination address plus the protocol parameter 'HB.interval', with
       jittering of +/- 50% of the RTO value, and exponential backoff of the
       RTO if the previous HEARTBEAT is unanswered.
    
    Essentially, of if the heartbean is unacknowledged, do we double the RTO.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 06e868066e3b5828383eb40ff4d1c0029100b0b5
Author: Lucas Nussbaum <lucas.nussbaum@ens-lyon.fr>
Date:   Fri Feb 13 08:33:41 2009 +0000

    sctp: Allow to disable SCTP checksums via module parameter
    
    This is a new version of my patch, now using a module parameter instead
    of a sysctl, so that the option is harder to find. Please note that,
    once the module is loaded, it is still possible to change the value of
    the parameter in /sys/module/sctp/parameters/, which is useful if you
    want to do performance comparisons without rebooting.
    
    Computation of SCTP checksums significantly affects the performance of
    SCTP. For example, using two dual-Opteron 246 connected using a Gbe
    network, it was not possible to achieve more than ~730 Mbps, compared to
    941 Mbps after disabling SCTP checksums.
    Unfortunately, SCTP checksum offloading in NICs is not commonly
    available (yet).
    
    By default, checksums are still enabled, of course.
    
    Signed-off-by: Lucas Nussbaum <lucas.nussbaum@ens-lyon.fr>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8510b937ae1e23583abdeb828cad5c518295c61d
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Dec 25 16:59:03 2008 -0800

    sctp: Add validity check for SCTP_PARTIAL_DELIVERY_POINT socket option
    
    The latest ietf socket extensions API draft said:
    
      8.1.21.  Set or Get the SCTP Partial Delivery Point
    
        Note also that the call will fail if the user attempts to set
        this value larger than the socket receive buffer size.
    
    This patch add this validity check for SCTP_PARTIAL_DELIVERY_POINT
    socket option.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit aea3c5c05d2c409e93bfa80dcedc06af7da6c13b
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Dec 25 16:57:24 2008 -0800

    sctp: Implement socket option SCTP_GET_ASSOC_NUMBER
    
    Implement socket option SCTP_GET_ASSOC_NUMBER of the latest ietf socket
    extensions API draft.
    
      8.2.5.  Get the Current Number of Associations (SCTP_GET_ASSOC_NUMBER)
    
       This option gets the current number of associations that are attached
       to a one-to-many style socket.  The option value is an uint32_t.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e89c2095815d82eaa9fb85eff42f8b65b67a59cf
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Dec 25 16:54:58 2008 -0800

    sctp: Bring SCTP_MAXSEG socket option into ietf API extension compliance
    
    Brings maxseg socket option set/get into line with the latest ietf socket
    extensions API draft, while maintaining backwards compatibility.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 191e471d6d55a0159406112f61cdd7fc8598e3e2
Author: Steve French <sfrench@us.ibm.com>
Date:   Fri Nov 21 14:23:07 2008 +0530

    cifs: clean up server protocol handling
    
    commit 3ec332ef7a38c2327e18d087d4120a8e3bd3dc6e upstream.
    
    We're currently declaring both a sockaddr_in and sockaddr6_in on the
    stack, but we really only need storage for one of them. Declare a
    sockaddr struct and cast it to the proper type. Also, eliminate the
    protocolType field in the TCP_Server_Info struct. It's redundant since
    we have a sa_family field in the sockaddr anyway.
    
    We may need to revisit this if SCTP is ever implemented, but for now
    this will simplify the code.
    
    CIFS over IPv6 also has a number of problems currently. This fixes all
    of them that I found. Eventually, it would be nice to move more of the
    code to be protocol independent, but this is a start.
    
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    Cc: Suresh Jayaraman <sjayaraman@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 328bd8997dbb7184d5389e45c642af44ae6e9043
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Nov 24 13:44:55 2008 +0100

    netfilter: nf_conntrack_proto_sctp: avoid bogus warning
    
    net/netfilter/nf_conntrack_proto_sctp.c: In function 'sctp_packet':
    net/netfilter/nf_conntrack_proto_sctp.c:376: warning: array subscript is above array bounds
    
    gcc doesn't realize that do_basic_checks() guarantees that there is
    at least one valid chunk and thus new_state is never SCTP_CONNTRACK_MAX
    after the loop. Initialize to SCTP_CONNTRACK_NONE to avoid the warning.
    
    Based on patch by Wu Fengguang <wfg@linux.intel.com>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>

commit 9a57f7fabd383920585ed8b74eacd117c6551f2d
Author: Eric Dumazet <dada1@cosmosbay.com>
Date:   Mon Nov 17 02:41:00 2008 -0800

    net: sctp should update its inuse counter
    
    This patch is a preparation to namespace conversion of /proc/net/protocols
    
    In order to have relevant information for SCTP protocols, we should use
    sock_prot_inuse_add() to update a (percpu and pernamespace) counter of
    inuse sockets.
    
    Signed-off-by: Eric Dumazet <dada1@cosmosbay.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ec332ef7a38c2327e18d087d4120a8e3bd3dc6e
Author: Steve French <sfrench@us.ibm.com>
Date:   Fri Nov 14 03:35:10 2008 +0000

    [CIFS] clean up server protocol handling
    
    We're currently declaring both a sockaddr_in and sockaddr6_in on the
    stack, but we really only need storage for one of them. Declare a
    sockaddr struct and cast it to the proper type. Also, eliminate the
    protocolType field in the TCP_Server_Info struct. It's redundant since
    we have a sa_family field in the sockaddr anyway.
    
    We may need to revisit this if SCTP is ever implemented, but for now
    this will simplify the code.
    
    CIFS over IPv6 also has a number of problems currently. This fixes all
    of them that I found. Eventually, it would be nice to move more of the
    code to be protocol independent, but this is a start.
    
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>

commit 91bd6b1e030266cf87d3f567b49f0fa60a7318ba
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Oct 23 00:59:52 2008 -0700

    sctp: Drop ICMP packet too big message with MTU larger than current PMTU
    
    If ICMP packet too big message is received with MTU larger than current
    PMTU, SCTP will still accept this ICMP message and sync the PMTU of assoc
    with the wrong MTU.
    
    Endpoing A                 Endpoint B
    (ESTABLISHED)              (ESTABLISHED)
    ICMP         --------->
    (packet too big, MTU too larger)
                               sync PMTU
    
    This patch fixed the problem by drop that ICMP message.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a1080a8b0bc301c223c4bf0cea4c5e42f43dcf58
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Oct 9 14:33:26 2008 -0700

    sctp: update SNMP statiscts when T5 timer expired.
    
    The T5 timer is the timer for the over-all shutdown procedure.  If
    this timer expires, then shutdown procedure has not completed and we
    ABORT the association.  We should update SCTP_MIB_ABORTED and
    SCTP_MIB_CURRESTAB  when aborting.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 56eb82bb8d2cdd8d9f4838eaa109df41d7164ca5
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Oct 9 14:33:01 2008 -0700

    sctp: Fix SNMP number of SCTP_MIB_ABORTED during violation handling.
    
    If ABORT chunks require authentication and a protocol violation
    is triggered, we do not tear down the association.  Subsequently,
    we should not increment SCTP_MIB_ABORTED.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3d5a019d5761a40465337711ae7d2beb1e9b43ec
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Oct 9 14:32:24 2008 -0700

    sctp: Fix the SNMP number of SCTP_MIB_CURRESTAB
    
    RFC3873 defined SCTP_MIB_CURRESTAB:
      sctpCurrEstab OBJECT-TYPE
        SYNTAX         Gauge32
        MAX-ACCESS     read-only
        STATUS         current
        DESCRIPTION
             "The number of associations for which the current state is
             either ESTABLISHED, SHUTDOWN-RECEIVED or SHUTDOWN-PENDING."
        REFERENCE
             "Section 4 in RFC2960 covers the SCTP   Association state
             diagram."
    
    If the T4 RTO timer expires many times(timeout), the association will enter
    CLOSED state, so we should dec the number of SCTP_MIB_CURRESTAB, not inc the
    number of SCTP_MIB_CURRESTAB.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8190f89dfd09dae0c117fb0745f5a820bd19a5a4
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Sep 8 12:13:55 2008 +0800

    sctp: Fix the SNMP counter of SCTP_MIB_OUTOFBLUES
    
    RFC3873 defined SCTP_MIB_OUTOFBLUES:
    
     sctpOutOfBlues OBJECT-TYPE
       SYNTAX         Counter32
       MAX-ACCESS     read-only
       STATUS         current
       DESCRIPTION
            "The number of out of the blue packets received by the host.
            An out of the blue packet is an SCTP packet correctly formed,
            including the proper checksum, but for which the receiver was
            unable to identify an appropriate association."
       REFERENCE
            "Section 8.4 in RFC2960 deals with the Out-Of-The-Blue
             (OOTB) packet definition and procedures."
    
    But OOTB packet INIT, INIT-ACK and SHUTDOWN-ACK(COOKIE-WAIT or
    COOKIE-ECHOED state) are not counted by SCTP_MIB_OUTOFBLUES.
    
    Case 1(INIT):
    
    Endpoint A               Endpoint B
    (CLOSED)                 (CLOSED)
    
     INIT     ---------->
              <----------    ABORT
    
    Case 2(INIT-ACK):
    
    Endpoint A               Endpoint B
    (CLOSED)                 (CLOSED)
    
     INIT-ACK  ---------->
               <----------   ABORT
    
    Case 3(SHUTDOWN-ACK):
    
    Endpoint A               Endpoint B
    (CLOSED)                 (CLOSED)
    
              <----------    INIT
     SHUTDOWN-ACK  ---------->
               <----------   SHUTDOWN-COMPLETE
    
    Case 4(SHUTDOWN-ACK):
    
    Endpoint A               Endpoint B
    (CLOSED)                 (COOKIE-ECHOED)
    
     SHUTDOWN-ACK  ---------->
               <----------   SHUTDOWN-COMPLETE
    
    This patch fixed the problem.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit ff134d489673b3d678d313e8dddae24c05eb0291
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Sep 3 01:02:37 2008 -0700

    sctp: fix random memory dereference with SCTP_HMAC_IDENT option.
    
    [ Upstream commit d97240552cd98c4b07322f30f66fd9c3ba4171de ]
    
    The number of identifiers needs to be checked against the option
    length.  Also, the identifier index provided needs to be verified
    to make sure that it doesn't exceed the bounds of the array.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit e2ab3da38b46f4f1389f18c7cd4a9a71ceac0bc6
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 27 22:41:52 2008 -0700

    sctp: add verification checks to SCTP_AUTH_KEY option
    
    [ Upstream commit 30c2235cbc477d4629983d440cdc4f496fec9246 ]
    
    The structure used for SCTP_AUTH_KEY option contains a
    length that needs to be verfied to prevent buffer overflow
    conditions.  Spoted by Eugene Teo <eteo@redhat.com>.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Acked-by: Eugene Teo <eugeneteo@kernel.sg>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit be9467bd75b522a3db0369c12db739f797cfec6a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 27 22:41:00 2008 -0700

    sctp: fix potential panics in the SCTP-AUTH API.
    
    [ Upstream commit 5e739d1752aca4e8f3e794d431503bfca3162df4 ]
    
    All of the SCTP-AUTH socket options could cause a panic
    if the extension is disabled and the API is envoked.
    
    Additionally, there were some additional assumptions that
    certain pointers would always be valid which may not
    always be the case.
    
    This patch hardens the API and address all of the crash
    scenarios.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 6d204e4fe042aafb1e443b08de56b4fa5cf012ca
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Sep 3 01:02:37 2008 -0700

    sctp: fix random memory dereference with SCTP_HMAC_IDENT option.
    
    [ Upstream commit d97240552cd98c4b07322f30f66fd9c3ba4171de ]
    
    The number of identifiers needs to be checked against the option
    length.  Also, the identifier index provided needs to be verified
    to make sure that it doesn't exceed the bounds of the array.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 1c6f8e1945a2b8317e5dad8fb5cfc882bd35b2b8
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 27 22:41:52 2008 -0700

    sctp: add verification checks to SCTP_AUTH_KEY option
    
    [ Upstream commit 30c2235cbc477d4629983d440cdc4f496fec9246 ]
    
    The structure used for SCTP_AUTH_KEY option contains a
    length that needs to be verfied to prevent buffer overflow
    conditions.  Spoted by Eugene Teo <eteo@redhat.com>.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit a1d348ddecaee92e74c27ccd69c325f4ce01d95f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 27 22:41:00 2008 -0700

    sctp: fix potential panics in the SCTP-AUTH API.
    
    [ Upstream commit 5e739d1752aca4e8f3e794d431503bfca3162df4 ]
    
    All of the SCTP-AUTH socket options could cause a panic
    if the extension is disabled and the API is envoked.
    
    Additionally, there were some additional assumptions that
    certain pointers would always be valid which may not
    always be the case.
    
    This patch hardens the API and address all of the crash
    scenarios.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit b09331e530777963ed65ce2fdf074b7b077768c7
Merge: 4c246edd2550 d97240552cd9
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Aug 27 17:38:07 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (55 commits)
      sctp: fix random memory dereference with SCTP_HMAC_IDENT option.
      sctp: correct bounds check in sctp_setsockopt_auth_key
      wan: Missing capability checks in sbni_ioctl()
      e100, fix iomap read
      qeth: preallocated header account offset
      qeth: l2 write unicast list to hardware
      qeth: use -EOPNOTSUPP instead of -ENOTSUPP.
      ibm_newemac: Don't call dev_mc_add() before device is registered
      net: don't grab a mutex within a timer context in gianfar
      forcedeth: fix checksum flag
      net/usb/mcs7830: add set_mac_address
      net/usb/mcs7830: new device IDs
      [netdrvr] smc91x: fix resource removal (null ptr deref)
      ibmveth: fix bad UDP checksums
      [netdrvr] hso: dev_kfree_skb crash fix
      [netdrvr] hso: icon 322 detection fix
      atl1: disable TSO by default
      atl1e: multistatement if missing braces
      igb: remove 82576 quad adapter
      drivers/net/skfp/ess.c: fix compile warnings
      ...

commit d97240552cd98c4b07322f30f66fd9c3ba4171de
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 27 16:09:49 2008 -0700

    sctp: fix random memory dereference with SCTP_HMAC_IDENT option.
    
    The number of identifiers needs to be checked against the option
    length.  Also, the identifier index provided needs to be verified
    to make sure that it doesn't exceed the bounds of the array.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b8e6c91c74e9f0279b7c51048779b3d62da60b88
Merge: e5778ec91e82 c2d42545774c
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Aug 25 17:48:07 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      bnx2x: Version update
      bnx2x: Multi Queue
      bnx2x: NAPI and interrupts enable/disable
      bnx2x: NIC load failure cleanup
      bnx2x: Initialization structure
      bnx2x: HW lock timeout
      bnx2x: Minimize lock time
      bnx2x: Fan failure mechanism on additional design
      bnx2x: Rx work check
      ipv6: sysctl fixes
      ipv4: sysctl fixes
      sctp: add verification checks to SCTP_AUTH_KEY option

commit 30c2235cbc477d4629983d440cdc4f496fec9246
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Aug 25 15:16:19 2008 -0700

    sctp: add verification checks to SCTP_AUTH_KEY option
    
    The structure used for SCTP_AUTH_KEY option contains a
    length that needs to be verfied to prevent buffer overflow
    conditions.  Spoted by Eugene Teo <eteo@redhat.com>.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6450f65168bcf3c03b5fb44c2fe96682c0d3086b
Merge: 7a8fc9b248e7 f410a1fba7af
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Aug 23 12:14:42 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      ipv6: protocol for address routes
      icmp: icmp_sk() should not use smp_processor_id() in preemptible code
      pkt_sched: Fix qdisc list locking
      pkt_sched: Fix qdisc_watchdog() vs. dev_deactivate() race
      sctp: fix potential panics in the SCTP-AUTH API.

commit 5e739d1752aca4e8f3e794d431503bfca3162df4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Aug 21 03:34:25 2008 -0700

    sctp: fix potential panics in the SCTP-AUTH API.
    
    All of the SCTP-AUTH socket options could cause a panic
    if the extension is disabled and the API is envoked.
    
    Additionally, there were some additional assumptions that
    certain pointers would always be valid which may not
    always be the case.
    
    This patch hardens the API and address all of the crash
    scenarios.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a250ca45baa1f3f36233727132d4d7728d5a0a63
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Jul 31 20:46:47 2008 -0700

    ipv6: Fix ip6_xmit to send fragments if ipfragok is true
    
    [ Upstream commit 77e2f14f71d68d05945f1d30ca55b5194d6ab1ce ]
    
    SCTP used ip6_xmit() to send fragments after received ICMP packet too
    big message. But while send packet used ip6_xmit, the skb->local_df is
    not initialized. So when skb if enter ip6_fragment(), the following
    code will discard the skb.
    
    ip6_fragment(...)
    {
        if (!skb->local_df) {
            ...
            return -EMSGSIZE;
        }
        ...
    }
    
    SCTP do the following step:
    1. send packet ip6_xmit(skb, ipfragok=0)
    2. received ICMP packet too big message
    3. if PMTUD_ENABLE: ip6_xmit(skb, ipfragok=1)
    
    This patch fixed the problem by set local_df if ipfragok is true.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit bf408b4303a36e6f70514249b71fbec3a84678b8
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Jul 31 20:46:47 2008 -0700

    ipv6: Fix ip6_xmit to send fragments if ipfragok is true
    
    [ Upstream commit 77e2f14f71d68d05945f1d30ca55b5194d6ab1ce ]
    
    SCTP used ip6_xmit() to send fragments after received ICMP packet too
    big message. But while send packet used ip6_xmit, the skb->local_df is
    not initialized. So when skb if enter ip6_fragment(), the following
    code will discard the skb.
    
    ip6_fragment(...)
    {
        if (!skb->local_df) {
            ...
            return -EMSGSIZE;
        }
        ...
    }
    
    SCTP do the following step:
    1. send packet ip6_xmit(skb, ipfragok=0)
    2. received ICMP packet too big message
    3. if PMTUD_ENABLE: ip6_xmit(skb, ipfragok=1)
    
    This patch fixed the problem by set local_df if ipfragok is true.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit f880374c2fe37aad3fa62253a4bc125d7a933aad
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sun Aug 3 21:15:08 2008 -0700

    sctp: Drop ipfargok in sctp_xmit function
    
    The ipfragok flag controls whether the packet may be fragmented
    either on the local host on beyond.  The latter is only valid on
    IPv4.
    
    In fact, we never want to do the latter even on IPv4 when PMTU is
    enabled.  This is because even though we can't fragment packets
    within SCTP due to the prtocol's inherent faults, we can still
    fragment it at IP layer.  By setting the DF bit we will improve
    the PMTU process.
    
    RFC 2960 only says that we SHOULD clear the DF bit in this case,
    so we're compliant even if we set the DF bit.  In fact RFC 4960
    no longer has this statement.
    
    Once we make this change, we only need to control the local
    fragmentation.  There is already a bit in the skb which controls
    that, local_df.  So this patch sets that instead of using the
    ipfragok argument.
    
    The only complication is that there isn't a struct sock object
    per transport, so for IPv4 we have to resort to changing the
    pmtudisc field for every packet.  This should be safe though
    as the protocol is single-threaded.
    
    Note that after this patch we can remove ipfragok from the rest
    of the stack too.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 77e2f14f71d68d05945f1d30ca55b5194d6ab1ce
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Jul 31 20:46:47 2008 -0700

    ipv6: Fix ip6_xmit to send fragments if ipfragok is true
    
    SCTP used ip6_xmit() to send fragments after received ICMP packet too
    big message. But while send packet used ip6_xmit, the skb->local_df is
    not initialized. So when skb if enter ip6_fragment(), the following
    code will discard the skb.
    
    ip6_fragment(...)
    {
        if (!skb->local_df) {
            ...
            return -EMSGSIZE;
        }
        ...
    }
    
    SCTP do the following step:
    1. send packet ip6_xmit(skb, ipfragok=0)
    2. received ICMP packet too big message
    3. if PMTUD_ENABLE: ip6_xmit(skb, ipfragok=1)
    
    This patch fixed the problem by set local_df if ipfragok is true.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5547cd0ae8b46db9a084505239294eed9b8c8e2d
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jul 21 10:03:49 2008 -0700

    netfilter: nf_conntrack_sctp: fix sparse warnings
    
    Introduced by a258860e (netfilter: ctnetlink: add full support for SCTP to ctnetlink):
    
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: incorrect type in argument 1 (different base types)
    net/netfilter/nf_conntrack_proto_sctp.c:483:2:    expected unsigned int [unsigned] [usertype] x
    net/netfilter/nf_conntrack_proto_sctp.c:483:2:    got restricted unsigned int const <noident>
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:483:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: incorrect type in argument 1 (different base types)
    net/netfilter/nf_conntrack_proto_sctp.c:487:2:    expected unsigned int [unsigned] [usertype] x
    net/netfilter/nf_conntrack_proto_sctp.c:487:2:    got restricted unsigned int const <noident>
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:487:2: warning: cast from restricted type
    net/netfilter/nf_conntrack_proto_sctp.c:532:42: warning: incorrect type in assignment (different base types)
    net/netfilter/nf_conntrack_proto_sctp.c:532:42:    expected restricted unsigned int <noident>
    net/netfilter/nf_conntrack_proto_sctp.c:532:42:    got unsigned int
    net/netfilter/nf_conntrack_proto_sctp.c:534:39: warning: incorrect type in assignment (different base types)
    net/netfilter/nf_conntrack_proto_sctp.c:534:39:    expected restricted unsigned int <noident>
    net/netfilter/nf_conntrack_proto_sctp.c:534:39:    got unsigned int
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit db7a94d60f871ce6a52e97d82dea476cee0c4ea0
Author: David S. Miller <davem@davemloft.net>
Date:   Sat Jul 19 22:39:46 2008 -0700

    highmem: Export totalhigh_pages.
    
    Hash et al. sizing code in SCTP wants to make the
    calculation totalram_pages - totalhigh_pages, just
    like TCP.  But this requires an export for the
    CONFIG_HIGHMEM case to work.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 23b29ed80bd7184398317a111dc488605cb66c7f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jul 18 23:06:07 2008 -0700

    sctp: Do not leak memory on multiple listen() calls
    
    SCTP permits multiple listen call and on subsequent calls
    we leak he memory allocated for the crypto transforms.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6d0ccbac688207ca0616ab5094932af4db4747b3
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jul 18 23:04:39 2008 -0700

    sctp: Prevent uninitialized memory access
    
    valgrind reports uninizialized memory accesses when running
    sctp inside the network simulation cradle simulator:
    
     Conditional jump or move depends on uninitialised value(s)
        at 0x570E34A: sctp_assoc_sync_pmtu (associola.c:1324)
        by 0x57427DA: sctp_packet_transmit (output.c:403)
        by 0x5710EFF: sctp_outq_flush (outqueue.c:824)
        by 0x5710B88: sctp_outq_uncork (outqueue.c:701)
        by 0x5745262: sctp_cmd_interpreter (sm_sideeffect.c:1548)
        by 0x57444B7: sctp_side_effects (sm_sideeffect.c:976)
        by 0x5744460: sctp_do_sm (sm_sideeffect.c:945)
        by 0x572157D: sctp_primitive_ASSOCIATE (primitive.c:94)
        by 0x5725C04: __sctp_connect (socket.c:1094)
        by 0x57297DC: sctp_connect (socket.c:3297)
    
     Conditional jump or move depends on uninitialised value(s)
        at 0x575D3A5: mod_timer (timer.c:630)
        by 0x5752B78: sctp_cmd_hb_timers_start (sm_sideeffect.c:555)
        by 0x5754133: sctp_cmd_interpreter (sm_sideeffect.c:1448)
        by 0x5753607: sctp_side_effects (sm_sideeffect.c:976)
        by 0x57535B0: sctp_do_sm (sm_sideeffect.c:945)
        by 0x571E9AE: sctp_endpoint_bh_rcv (endpointola.c:474)
        by 0x573347F: sctp_inq_push (inqueue.c:104)
        by 0x572EF93: sctp_rcv (input.c:256)
        by 0x5689623: ip_local_deliver_finish (ip_input.c:230)
        by 0x5689759: ip_local_deliver (ip_input.c:268)
        by 0x5689CAC: ip_rcv_finish (dst.h:246)
    
    #1 is due to "if (t->pmtu_pending)".
    8a4794914f9cf2681235ec2311e189fe307c28c7 "[SCTP] Flag a pmtu change request"
    suggests it should be initialized to 0.
    
    #2 is the heartbeat timer 'expires' value, which is uninizialised, but
    test by mod_timer().
    T3_rtx_timer seems to be affected by the same problem, so initialize it, too.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c4e85f82edcd6027cfe67331a2e00741b009756b
Author: Florian Westphal <fw@strlen.de>
Date:   Fri Jul 18 23:03:44 2008 -0700

    sctp: Don't abort initialization when CONFIG_PROC_FS=n
    
    This puts CONFIG_PROC_FS defines around the proc init/exit functions
    and also avoids compiling proc.c if procfs is not supported.
    Also make SCTP_DBG_OBJCNT depend on procfs.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ecbed6a41900126e7b9509e12a8d0cc22176e3eb
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jul 1 20:06:22 2008 -0700

    sctp: Mark GET_PEER|LOCAL_ADDR_OLD deprecated.
    
    Socket options SCTP_GET_PEER_ADDR_OLD, SCTP_GET_PEER_ADDR_NUM_OLD,
    SCTP_GET_LOCAL_ADDR_OLD, and SCTP_GET_PEER_LOCAL_ADDR_NUM_OLD
    have been replaced by newer versions a since 2005.  It's time
    to officially deprecate them and schedule them for removal.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2e3216cd54b142ba605e87522e15f42e0c4e3996
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Jun 19 16:08:18 2008 -0700

    sctp: Follow security requirement of responding with 1 packet
    
    RFC 4960, Section 11.4. Protection of Non-SCTP-Capable Hosts
    
    When an SCTP stack receives a packet containing multiple control or
    DATA chunks and the processing of the packet requires the sending of
    multiple chunks in response, the sender of the response chunk(s) MUST
    NOT send more than one packet.  If bundling is supported, multiple
    response chunks that fit into a single packet MAY be bundled together
    into one single response packet.  If bundling is not supported, then
    the sender MUST NOT send more than one response chunk and MUST
    discard all other responses.  Note that this rule does NOT apply to a
    SACK chunk, since a SACK chunk is, in itself, a response to DATA and
    a SACK does not require a response of more DATA.
    
    We implement this by not servicing our outqueue until we reach the end
    of the packet.  This enables maximum bundling.  We also identify
    'response' chunks and make sure that we only send 1 packet when sending
    such chunks.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8ce9c6ede1504d29eead67862edc96c03dd4d0a2
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Jun 17 00:40:36 2008 -0700

    sctp: Kill SCTP_SOCK_SLEEP_{PRE,POST}, unused.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 80896a3584bbff9ff9ad4dde735517c4de68d736
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Jun 16 16:59:55 2008 -0700

    sctp: Correctly cleanup procfs entries upon failure.
    
    This patch remove the proc fs entry which has been created if fail to
    set up proc fs entry for the SCTP protocol.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a258860e01b80e8f554a4ab1a6c95e6042eb8b73
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Mon Jun 9 15:56:39 2008 -0700

    netfilter: ctnetlink: add full support for SCTP to ctnetlink
    
    This patch adds full support for SCTP to ctnetlink. This includes three
    new attributes: state, original vtag and reply vtag.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7bfe8bdb80d5988483b01177b09b9c8d1605dffb
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jun 9 15:45:05 2008 -0700

    sctp: Fix problems with the new SCTP_DELAYED_ACK code
    
    The default sack frequency should be 2.  Also fix copy/paste
    error when updating all transports.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b9031d9d87b24e24cd32ea15b5f4220a1e8da909
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Jun 4 12:40:15 2008 -0700

    sctp: Fix ECN markings for IPv6
    
    Commit e9df2e8fd8fbc95c57dbd1d33dada66c4627b44c ("[IPV6]: Use
    appropriate sock tclass setting for routing lookup.") also changed the
    way that ECN capable transports mark this capability in IPv6.  As a
    result, SCTP was not marking ECN capablity because the traffic class
    was never set.  This patch brings back the markings for IPv6 traffic.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e51171019bb0e1f9fb57c25bd2e38ce652eaea27
Author: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
Date:   Thu May 29 19:55:05 2008 +0900

    [SCTP]: Fix NULL dereference of asoc.
    
    Commit 7cbca67c073263c179f605bdbbdc565ab29d801d ("[IPV6]: Support
    Source Address Selection API (RFC5014)") introduced NULL dereference
    of asoc to sctp_v6_get_saddr in net/sctp/ipv6.c.
    Pointed out by Johann Felix Soden <johfel@users.sourceforge.net>.
    
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>

commit d364d9276b54af16fcb4db83f1315b620daec102
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Fri May 9 15:13:26 2008 -0700

    sctp: Bring SCTP_DELAYED_ACK socket option into API compliance
    
    Brings delayed_ack socket option set/get into line with the latest ietf
    socket extensions API draft, while maintaining backwards compatibility.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 28a4acb48586dc21d2d14a75a7aab7be78b7c83b
Merge: 89f92d6425b0 e46b66bc42b6
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu May 8 19:03:26 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (32 commits)
      net: Added ASSERT_RTNL() to dev_open() and dev_close().
      can: Fix can_send() handling on dev_queue_xmit() failures
      netns: Fix arbitrary net_device-s corruptions on net_ns stop.
      netfilter: Kconfig: default DCCP/SCTP conntrack support to the protocol config values
      netfilter: nf_conntrack_sip: restrict RTP expect flushing on error to last request
      macvlan: Fix memleak on device removal/crash on module removal
      net/ipv4: correct RFC 1122 section reference in comment
      tcp FRTO: SACK variant is errorneously used with NewReno
      e1000e: don't return half-read eeprom on error
      ucc_geth: Don't use RX clock as TX clock.
      cxgb3: Use CAP_SYS_RAWIO for firmware
      pcnet32: delete non NAPI code from driver.
      fs_enet: Fix a memory leak in fs_enet_mdio_probe
      [netdrvr] eexpress: IPv6 fails - multicast problems
      3c59x: use netstats in net_device structure
      3c980-TX needs EXTRA_PREAMBLE
      fix warning in drivers/net/appletalk/cops.c
      e1000e: Add support for BM PHYs on ICH9
      uli526x: fix endianness issues in the setup frame
      uli526x: initialize the hardware prior to requesting interrupts
      ...

commit f3261aff35cbc811fee0e23eaea277f1b7286eca
Author: Patrick McHardy <kaber@trash.net>
Date:   Thu May 8 01:16:04 2008 -0700

    netfilter: Kconfig: default DCCP/SCTP conntrack support to the protocol config values
    
    When conntrack and DCCP/SCTP protocols are enabled, chances are good
    that people also want DCCP/SCTP conntrack and NAT support.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 529a41e36673b518c9e091f3a8d932b6b9e3c461
Merge: c3823c479e1f 43837b1e6c5a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Apr 21 15:46:17 2008 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      rose: Socket lock was not released before returning to user space
      hci_usb: remove code obfuscation
      drivers/net/appletalk: use time_before, time_before_eq, etc
      drivers/atm: use time_before, time_before_eq, etc
      hci_usb: do not initialize static variables to 0
      tg3: 5701 DMA corruption fix
      atm nicstar: Removal of debug code containing deprecated calls to cli()/sti()
      iwlwifi: Fix unconditional access to station->tidp[].agg.
      netfilter: Fix SIP conntrack build with NAT disabled.
      netfilter: Fix SCTP nat build.

commit 4e9d8a70e4a48e146a0eaaa5a666f0a4889d873d
Author: Patrick McHardy <kaber@trash.net>
Date:   Sat Apr 19 17:52:51 2008 -0700

    netfilter: Fix SCTP nat build.
    
    We need to select LIBCRC32C.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 746b23e44e933a993777eb054ab6b44724a43d6e
Author: Chidambar 'ilLogict' Zinnoury <illogict@online.fr>
Date:   Sun Apr 6 23:42:35 2008 -0700

    SCTP: Fix local_addr deletions during list traversals.
    
    Upstream commit: 22626216c46f2ec86287e75ea86dd9ac3df54265
    
    Since the lists are circular, we need to explicitely tag
    the address to be deleted since we might end up freeing
    the list head instead.  This fixes some interesting SCTP
    crashes.
    
    Signed-off-by: Chidambar 'ilLogict' Zinnoury <illogict@online.fr>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 334d094504c2fe1c44211ecb49146ae6bca8c321
Merge: d1a4be630fb0 d1643d24c61b
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Apr 18 18:02:35 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6.26
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6.26: (1090 commits)
      [NET]: Fix and allocate less memory for ->priv'less netdevices
      [IPV6]: Fix dangling references on error in fib6_add().
      [NETLABEL]: Fix NULL deref in netlbl_unlabel_staticlist_gen() if ifindex not found
      [PKT_SCHED]: Fix datalen check in tcf_simp_init().
      [INET]: Uninline the __inet_inherit_port call.
      [INET]: Drop the inet_inherit_port() call.
      SCTP: Initialize partial_bytes_acked to 0, when all of the data is acked.
      [netdrvr] forcedeth: internal simplifications; changelog removal
      phylib: factor out get_phy_id from within get_phy_device
      PHY: add BCM5464 support to broadcom PHY driver
      cxgb3: Fix __must_check warning with dev_dbg.
      tc35815: Statistics cleanup
      natsemi: fix MMIO for PPC 44x platforms
      [TIPC]: Cleanup of TIPC reference table code
      [TIPC]: Optimized initialization of TIPC reference table
      [TIPC]: Remove inlining of reference table locking routines
      e1000: convert uint16_t style integers to u16
      ixgb: convert uint16_t style integers to u16
      sb1000.c: make const arrays static
      sb1000.c: stop inlining largish static functions
      ...

commit 8b73a07c8ffaa70683022566080f4df3328ea18d
Author: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date:   Thu Apr 17 14:22:18 2008 -0700

    SCTP: Initialize partial_bytes_acked to 0, when all of the data is acked.
    
    According to RFC4960 7.2.2,
    When all of the data transmitted by the sender has
    been acknowledged by the recerver, partial_bytes_acked is initialized to 0.
    
    This patch conforms to rfc requirement.
    Without this fix, cwnd might be error incremented.
    
    Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 533bb8a4d7388686243c37a414c4448ba3566f8a
Merge: 4f3f8e94b7b0 159d83363b62
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Apr 14 07:56:24 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (31 commits)
      [BRIDGE]: Fix crash in __ip_route_output_key with bridge netfilter
      [NETFILTER]: ipt_CLUSTERIP: fix race between clusterip_config_find_get and _entry_put
      [IPV6] ADDRCONF: Don't generate temporary address for ip6-ip6 interface.
      [IPV6] ADDRCONF: Ensure disabling multicast RS even if privacy extensions are disabled.
      [IPV6]: Use appropriate sock tclass setting for routing lookup.
      [IPV6]: IPv6 extension header structures need to be packed.
      [IPV6]: Fix ipv6 address fetching in raw6_icmp_error().
      [NET]: Return more appropriate error from eth_validate_addr().
      [ISDN]: Do not validate ISDN net device address prior to interface-up
      [NET]: Fix kernel-doc for skb_segment
      [SOCK] sk_stamp: should be initialized to ktime_set(-1L, 0)
      net: check for underlength tap writes
      net: make struct tun_struct private to tun.c
      [SCTP]: IPv4 vs IPv6 addresses mess in sctp_inet[6]addr_event.
      [SCTP]: Fix compiler warning about const qualifiers
      [SCTP]: Fix protocol violation when receiving an error lenght INIT-ACK
      [SCTP]: Add check for hmac_algo parameter in sctp_verify_param()
      [NET_SCHED] cls_u32: refcounting fix for u32_delete()
      [DCCP]: Fix skb->cb conflicts with IP
      [AX25]: Potential ax25_uid_assoc-s leaks on module unload.
      ...

commit 9d908a69a32e0171eb5eeac93f2f46ffa4190573
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Apr 14 11:15:50 2008 +0200

    [NETFILTER]: nf_nat: add SCTP protocol support
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>

commit 765ff02e896a4f4e0fdb223aadab629aaf3756d2
Author: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date:   Sat Apr 12 18:55:12 2008 -0700

    [SCTP]: Remove an unused parameter from sctp_cmd_hb_timer_update
    
    The 'asoc' parameter to sctp_cmd_hb_timer_update() is unused, and
    we can remove it.
    
    Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9dbc15f055f05393ace4f1733f160ec3d188cf9b
Author: Robert P. J. Day <rpjday@crashcourse.ca>
Date:   Sat Apr 12 18:54:24 2008 -0700

    [SCTP]: "list_for_each()" -> "list_for_each_entry()" where appropriate.
    
    Replacing (almost) all invocations of list_for_each() with
    list_for_each_entry() tightens up the code and allows for the deletion
    of numerous list iterator variables that are no longer necessary.
    
    Signed-off-by: Robert P. J. Day <rpjday@crashcourse.ca>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 30e935600776b45db38238355f0de2b8f72b3847
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Sat Apr 12 18:53:48 2008 -0700

    [SCTP]: Correct /proc/net/assocs formatting error
    
    Recently I posted a patch to add some informational items to
    /proc/net/sctp/assocs.  All the information is correct, but because
    of how the seqfile show operation is laid out, some of the formatting
    is backwards.  This patch corrects that formatting, so that the new
    information appears at the end of each line, rather than in the middle.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a40a7d15ba602b547f56b7b19e0282fe4fc3dee3
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Sat Apr 12 18:40:38 2008 -0700

    [SCTP]: IPv4 vs IPv6 addresses mess in sctp_inet[6]addr_event.
    
    All IP addresses that are present in a system are duplicated on
    struct sctp_sockaddr_entry. They are linked in the global list
    called sctp_local_addr_list. And this struct unions IPv4 and IPv6
    addresses.
    
    So, there can be rare case, when a sockaddr_in.sin_addr coincides
    with the corresponding part of the sockaddr_in6 and the notifier
    for IPv4 will carry away an IPv6 entry.
    
    The fix is to check the family before comparing the addresses.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ab38fb04c9f8928cfaf6f4966633d783419906a1
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Apr 12 18:40:06 2008 -0700

    [SCTP]: Fix compiler warning about const qualifiers
    
    Fix 3 warnings about discarding const qualifiers:
    
    net/sctp/ulpevent.c:862: warning: passing argument 1 of 'sctp_event2skb' discards qualifiers from pointer target type
    net/sctp/sm_statefuns.c:4393: warning: passing argument 1 of 'SCTP_ASOC' discards qualifiers from pointer target type
    net/sctp/socket.c:5874: warning: passing argument 1 of 'cmsg_nxthdr' discards qualifiers from pointer target type
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f4ad85ca3ef8a1ede76c5020a28a8f4057b4d24f
Author: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date:   Sat Apr 12 18:39:34 2008 -0700

    [SCTP]: Fix protocol violation when receiving an error lenght INIT-ACK
    
    When receiving an error length INIT-ACK during COOKIE-WAIT,
    a 0-vtag ABORT will be responsed. This action violates the
    protocol apparently. This patch achieves the following things.
    1 If the INIT-ACK contains all the fixed parameters, use init-tag
      recorded from INIT-ACK as vtag.
    2 If the INIT-ACK doesn't contain all the fixed parameters,
      just reflect its vtag.
    
    Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 72da7b3860cabf427590b4982bc880bafab4d5c8
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Sat Apr 12 18:39:19 2008 -0700

    [SCTP]: Add check for hmac_algo parameter in sctp_verify_param()
    
    RFC 4890 has the following text:
    
      The HMAC algorithm based on SHA-1 MUST be supported and
      included in the HMAC-ALGO parameter.
    
    As a result, we need to check in sctp_verify_param() that HMAC_SHA1 is
    present in the list.  If not, we should probably treat this as a
    protocol violation.
    
    It should also be a protocol violation if the HMAC parameter is empty.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 996b1dbadcbcafb899f022303e01d46ab87920eb
Author: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
Date:   Thu Apr 10 03:50:13 2008 -0700

    [SCTP]: Use snmp_mib_{init,free}().
    
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit eab2e0b2ec150aec8887d0cf178f7c989296266f
Author: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date:   Thu Apr 10 02:00:23 2008 -0700

    SCTP: Remove useless assignment from __sctp_rcv_lookup_endpoint
    
    Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 935a7f6e4d2f2c69a2d94cbda377684fffbdcb27
Author: Li Zefan <lizf@cn.fujitsu.com>
Date:   Thu Apr 10 01:58:06 2008 -0700

    SCTP: fix wrong debug counting of bind_bucket
    
    Should not count it if the allocation of the object
    is failed.
    
    Signed-off-by: Li Zefan <lizf@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e8c38751be84e2e930642be60331fbb6d3c4becb
Author: Li Zefan <lizf@cn.fujitsu.com>
Date:   Thu Apr 10 01:57:24 2008 -0700

    SCTP: fix wrong debug counting of datamsg
    
    Should not count it if the allocation of this object
    failed.
    
    Signed-off-by: Li Zefan <lizf@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8258175c811440e93baa15ab1962a5905686dda3
Author: Denis V. Lunev <den@openvz.org>
Date:   Thu Apr 3 14:27:26 2008 -0700

    [SCTP]: Replace socket with sock for SCTP control socket.
    
    Signed-off-by: Denis V. Lunev <den@openvz.org>
    Acked-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4ffe0225e0628a5812168570b50d828f541c6b06
Author: Denis V. Lunev <den@openvz.org>
Date:   Thu Apr 3 14:26:36 2008 -0700

    [SCTP]: Use inet_ctl_sock_create for control socket creation.
    
    sk->sk_proc->(un)hash is noop right now, so the unification is correct.
    
    Signed-off-by: Denis V. Lunev <den@openvz.org>
    Acked-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bc09dff198e67a98a82c42000006b39f6d502031
Author: Ilpo Jrvinen <ilpo.jarvinen@helsinki.fi>
Date:   Thu Mar 27 17:54:29 2008 -0700

    [SCTP]: Remove sctp_add_cmd_sf wrapper bloat
    
    With a was number of callsites sctp_add_cmd_sf wrapper bloats
    kernel by some amount. Due to unlikely tracking allyesconfig,
    with the initial result were around ~7kB (thus caught my
    attention) while a non-debug config produced only ~2.3kB effect.
    
    I (ij) proposed first a patch to uninline it but Vlad responded
    with a patch that removed the only sctp_add_cmd call which is
    wrapped by sctp_add_cmd_sf (I wasn't sure if I could do that).
    I did minor cleanup to Vlad's patch.
    
    Signed-off-by: Ilpo Jrvinen <ilpo.jarvinen@helsinki.fi>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ca1a6ba57c5fca755b4ac7a13395bca2e2e371b1
Merge: d3073779f836 8f3ea33a5078
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Mar 24 13:07:24 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      sch_htb: fix "too many events" situation
      connector: convert to single-threaded workqueue
      [ATM]: When proc_create() fails, do some error handling work and return -ENOMEM.
      [SUNGEM]: Fix NAPI assertion failure.
      BNX2X: prevent ethtool from setting port type
      [9P] net/9p/trans_fd.c: remove unused variable
      [IPV6] net/ipv6/ndisc.c: remove unused variable
      [IPV4] fib_trie: fix warning from rcu_assign_poinger
      [TCP]: Let skbs grow over a page on fast peers
      [DLCI]: Fix tiny race between module unload and sock_ioctl.
      [SCTP]: Fix build warnings with IPV6 disabled.
      [IPV4]: Fix null dereference in ip_defrag

commit 80445cfb28a6b093540582b68d9ae928bf34cfe7
Author: Florian Westphal <fw@strlen.de>
Date:   Sun Mar 23 22:47:08 2008 -0700

    [SCTP]: Remove redundant wrapper functions.
    
    sctp_datamsg_free and sctp_datamsg_track are just aliases for
    sctp_datamsg_put and sctp_chunk_hold, respectively.
    
    Saves 32 Bytes on x86.
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2444844cefd2ce0ac73858cf980de07e33a5dd20
Author: Florian Westphal <fw@strlen.de>
Date:   Sun Mar 23 22:46:34 2008 -0700

    [SCTP]: Replace char msg[] with static const char[].
    
    133886    2004     220  136110   213ae sctp.new/sctp.o
    134018    2004     220  136242   21432 sctp.old/sctp.o
    
    Signed-off-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1233823b0847190976d69a86d7bb1287992ba2c7
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Mar 21 15:40:47 2008 -0700

    [SCTP]: Fix build warnings with IPV6 disabled.
    
    Introduced by 270637abff0cdf848b910b9f96ad342e1da61c66
    ("[SCTP]: Fix a race between module load and protosw access")
    
    Reported by Gabriel C:
    
    In file included from net/sctp/sm_statetable.c:50:
    include/net/sctp/sctp.h: In function 'sctp_v6_pf_init':
    include/net/sctp/sctp.h:392: warning: 'return' with a value, in function returning void
    In file included from net/sctp/sm_statefuns.c:62:
    include/net/sctp/sctp.h: In function 'sctp_v6_pf_init':
    include/net/sctp/sctp.h:392: warning: 'return' with a value, in function returning void
     ...
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7d3628b230ecbdc29566c18bc7800ff8ed66a71f
Merge: 2c7871982cf2 94833dfb8c98
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Mar 21 07:57:45 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (46 commits)
      [NET] ifb: set separate lockdep classes for queue locks
      [IPV6] KCONFIG: Fix description about IPV6_TUNNEL.
      [TCP]: Fix shrinking windows with window scaling
      netpoll: zap_completion_queue: adjust skb->users counter
      bridge: use time_before() in br_fdb_cleanup()
      [TG3]: Fix build warning on sparc32.
      MAINTAINERS: bluez-devel is subscribers-only
      audit: netlink socket can be auto-bound to pid other than current->pid (v2)
      [NET]: Fix permissions of /proc/net
      [SCTP]: Fix a race between module load and protosw access
      [NETFILTER]: ipt_recent: sanity check hit count
      [NETFILTER]: nf_conntrack_h323: logical-bitwise & confusion in process_setup()
      [RT2X00] drivers/net/wireless/rt2x00/rt2x00dev.c: remove dead code, fix warning
      [IPV4]: esp_output() misannotations
      [8021Q]: vlan_dev misannotations
      xfrm: ->eth_proto is __be16
      [IPV4]: ipv4_is_lbcast() misannotations
      [SUNRPC]: net/* NULL noise
      [SCTP]: fix misannotated __sctp_rcv_asconf_lookup()
      [PKT_SCHED]: annotate cls_u32
      ...

commit 270637abff0cdf848b910b9f96ad342e1da61c66
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Mar 20 15:17:14 2008 -0700

    [SCTP]: Fix a race between module load and protosw access
    
    There is a race is SCTP between the loading of the module
    and the access by the socket layer to the protocol functions.
    In particular, a list of addresss that SCTP maintains is
    not initialized prior to the registration with the protosw.
    Thus it is possible for a user application to gain access
    to SCTP functions before everything has been initialized.
    The problem shows up as odd crashes during connection
    initializtion when we try to access the SCTP address list.
    
    The solution is to refactor how we do registration and
    initialize the lists prior to registering with the protosw.
    Care must be taken since the address list initialization
    depends on some other pieces of SCTP initialization.  Also
    the clean-up in case of failure now also needs to be refactored.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bc92dd194d05e8334b210552fbc0ac5711d72ea9
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Mar 17 22:47:32 2008 -0700

    [SCTP]: fix misannotated __sctp_rcv_asconf_lookup()
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 609eb39c8d8a8d2930780428f6cbe2f63eb84734
Merge: 123d43acd2e5 22626216c46f
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Mar 12 13:08:09 2008 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (47 commits)
      [SCTP]: Fix local_addr deletions during list traversals.
      net: fix build with CONFIG_NET=n
      [TCP]: Prevent sending past receiver window with TSO (at last skb)
      rt2x00: Add new D-Link USB ID
      rt2x00: never disable multicast because it disables broadcast too
      libertas: fix the 'compare command with itself' properly
      drivers/net/Kconfig: fix whitespace for GELIC_WIRELESS entry
      [NETFILTER]: nf_queue: don't return error when unregistering a non-existant handler
      [NETFILTER]: nfnetlink_queue: fix EPERM when binding/unbinding and instance 0 exists
      [NETFILTER]: nfnetlink_log: fix EPERM when binding/unbinding and instance 0 exists
      [NETFILTER]: nf_conntrack: replace horrible hack with ksize()
      [NETFILTER]: nf_conntrack: add \n to "expectation table full" message
      [NETFILTER]: xt_time: fix failure to match on Sundays
      [NETFILTER]: nfnetlink_log: fix computation of netlink skb size
      [NETFILTER]: nfnetlink_queue: fix computation of allocated size for netlink skb.
      [NETFILTER]: nfnetlink: fix ifdef in nfnetlink_compat.h
      [NET]: include <linux/types.h> into linux/ethtool.h for __u* typedef
      [NET]: Make /proc/net a symlink on /proc/self/net (v3)
      RxRPC: fix rxrpc_recvmsg()'s returning of msg_name
      net/enc28j60: oops fix
      ...

commit 22626216c46f2ec86287e75ea86dd9ac3df54265
Author: Chidambar 'ilLogict' Zinnoury <illogict@online.fr>
Date:   Tue Mar 11 18:05:02 2008 -0700

    [SCTP]: Fix local_addr deletions during list traversals.
    
    Since the lists are circular, we need to explicitely tag
    the address to be deleted since we might end up freeing
    the list head instead.  This fixes some interesting SCTP
    crashes.
    
    Signed-off-by: Chidambar 'ilLogict' Zinnoury <illogict@online.fr>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 219b99a9edab4fdc478c819acb38f4a592dffd7d
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Mar 5 13:44:46 2008 -0800

    [SCTP]: Bring MAX_BURST socket option into ietf API extension compliance
    
    Brings max_burst socket option set/get into line with the latest ietf
    socket extensions api draft, while maintaining backwards
    compatibility.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 140ee9603c753ce11fc3088c1988a77e92183f9b
Author: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
Date:   Wed Mar 5 13:43:32 2008 -0800

    SCTP: Fix chunk parameter processing bug
    
    If an address family is not listed in "Supported Address Types"
    parameter(INIT Chunk), but the packet is sent by that family, this
    address family should be considered as supported by peer.  Otherwise,
    an error condition will occur. For instance, if kernel receives an
    IPV6 SCTP INIT chunk with "Support Address Types" parameter which
    indicates just supporting IPV4 Address family. Kernel will reply an
    IPV6 SCTP INIT ACK packet, but the source ipv6 address in ipv6 header
    will be vacant. This is not correct.
    
    refer to RFC4460 as following:
          IMPLEMENTATION NOTE: If an SCTP endpoint lists in the 'Supported
          Address Types' parameter either IPv4 or IPv6, but uses the other
          family for sending the packet containing the INIT chunk, or if it
          also lists addresses of the other family in the INIT chunk, then
          the address family that is not listed in the 'Supported Address
          Types' parameter SHOULD also be considered as supported by the
          receiver of the INIT chunk.  The receiver of the INIT chunk SHOULD
          NOT respond with any kind of error indication.
    
    Here is a fix to comply to RFC.
    
    Signed-off-by: Gui Jianfeng <guijianfeng@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 27d0483aa1ef66a8877d71b63bb97f46ab0246b2
Merge: 665c1ef83691 dea75bdfa57f
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Tue Mar 4 20:20:58 2008 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (22 commits)
      [IPCONFIG]: The kernel gets no IP from some DHCP servers
      b43legacy: Fix module init message
      rndis_wlan: fix broken data copy
      libertas: compare the current command with response
      libertas: fix sanity check on sequence number in command response
      p54: fix eeprom parser length sanity checks
      p54: fix EEPROM structure endianness
      ssb: Add pcibios_enable_device() return value check
      rc80211-pid: fix rate adjustment
      [ESP]: Add select on AUTHENC
      [TCP]: Improve ipv4 established hash function.
      [NETPOLL]: Revert two bogus cleanups that broke netconsole.
      [PPPOL2TP]: Add missing sock_put() in pppol2tp_tunnel_closeall()
      Subject: [PPPOL2TP] add missing sock_put() in pppol2tp_recv_dequeue()
      [BLUETOOTH]: l2cap info_timer delete fix in hci_conn_del
      [NET]: Fix race in generic address resolution.
      iucv: fix build error on !SMP
      [TCP]: Must count fack_count also when skipping
      [TUN]: Fix RTNL-locking in tun/tap driver
      [SCTP]: Use proc_create to setup de->proc_fops.
      ...

commit f0fd56ed40ec5fb889bfc7efccd1c5759e6e9937
Author: Denis V. Lunev <den@openvz.org>
Date:   Mon Mar 3 11:55:54 2008 -0800

    [SCTP]: seq_printf format warning. (fixed)
    
    sctp_association->hbinterval is unsigned long. Replace %8d with %8lu.
    
    Signed-off-by: Denis V. Lunev <den@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a90bcbd651b453d8259243115696c11b864b30fe
Author: Ilpo Jrvinen <ilpo.jarvinen@helsinki.fi>
Date:   Fri Feb 29 11:45:34 2008 -0800

    [SCTP]: Kill unused static inline sctp_sysctl_jiffies_ms
    
    After the patch:
    $ git-grep sctp_sysctl_jiffies_ms | wc -l
    0
    
    Signed-off-by: Ilpo Jrvinen <ilpo.jarvinen@helsinki.fi>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 58fbbed4fbc0094fc808a568fe99a915f85402ee
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Feb 29 11:40:56 2008 -0800

    [SCTP]: extend exported data in /proc/net/sctp/assoc
    
    RFC 3873 specifies several MIB objects that can't be obtained by the
    current data set exported by /proc/sys/net/sctp/assoc.  This patch
    adds the missing pieces of data that allow us to compute all the
    objects in the sctpAssocTable object.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 459eea74104ad85c30e17541c2b30d776445e985
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Fri Feb 29 11:24:45 2008 -0800

    [SCTP]: Use proc_create to setup de->proc_fops.
    
    In addition to commit 160f17 ("[SCTP]: Use proc_create() to setup
    ->proc_fops first") use proc_create in two more places.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 219ff3ad611ecfe8a2fd29b8c50a5313c9d15383
Merge: 547598d3a91f 2335f8ec27e1
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Feb 29 08:29:55 2008 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (79 commits)
      [X25]: Use proc_create() to setup ->proc_fops first
      [WANROUTER]: Use proc_create() to setup ->proc_fops first
      [8021Q]: Use proc_create() to setup ->proc_fops first
      [IPV4]: Use proc_create() to setup ->proc_fops first
      [IPV6]: Use proc_create() to setup ->proc_fops first
      [SCTP]: Use proc_create() to setup ->proc_fops first
      [PKTGEN]: Use proc_create() to setup ->proc_fops first
      [NEIGHBOUR]: Use proc_create() to setup ->proc_fops first
      [LLC]: Use proc_create() to setup ->proc_fops first
      [IPX]: Use proc_create() to setup ->proc_fops first
      [SUNRPC]: Use proc_create() to setup ->proc_fops first
      [ATM]: Use proc_create() to setup ->proc_fops first
      [SCTP]: Update AUTH structures to match declarations in draft-16.
      [SCTP]: Incorrect length was used in SCTP_*_AUTH_CHUNKS socket option
      [SCTP]: Clean up naming conventions of sctp protocol/address family registration
      [APPLETALK]: Use proc_create() to setup ->proc_fops first
      [BNX2X]: add bnx2x to MAINTAINERS
      [BNX2X]: update version, remove CVS strings
      [BNX2X]: Fix Xmit bugs
      [BNX2X]: Prevent PCI queue overflow
      ...

commit 160f17e345f5b50484d6cdc985b8686a05bf015d
Author: Wang Chen <wangchen@cn.fujitsu.com>
Date:   Thu Feb 28 14:13:16 2008 -0800

    [SCTP]: Use proc_create() to setup ->proc_fops first
    
    Use proc_create() to make sure that ->proc_fops be setup before gluing
    PDE to main tree.
    
    Signed-off-by: Wang Chen <wangchen@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7e8616d8e7731b026019d9af7cc9914b8bb42bc7
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Feb 27 16:04:52 2008 -0500

    [SCTP]: Update AUTH structures to match declarations in draft-16.
    
    The new SCTP socket api (draft 16) updates the AUTH API structures.
    We never exported these since we knew they would change.
    Update the rest to match the draft.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b40db6846847e82daf175641987df29324c425fa
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Feb 27 14:40:37 2008 -0500

    [SCTP]: Incorrect length was used in SCTP_*_AUTH_CHUNKS socket option
    
    The chunks are stored inside a parameter structure in the kernel
    and when we copy them to the user, we need to account for
    the parameter header.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 15efbe763978d7cc327d824d9e8f8f9e525dd40d
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Feb 15 09:53:59 2008 -0500

    [SCTP]: Clean up naming conventions of sctp protocol/address family registration
    
    I noticed while looking into some odd behavior in sctp, that the variable
    name sctp_pf_inet6_specific was used twice to represent two different
    pieces of data (its both a structure name and a pointer to that type of
    structure), which is confusing to say the least, and potentially dangerous
    depending on the variable scope.  This patch cleans that up, and makes the
    protocol and address family registration names in SCTP more regular,
    increasing readability.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    
     ipv6.c     |   12 ++++++------
     protocol.c |   12 ++++++------
     2 files changed, 12 insertions(+), 12 deletions(-)

commit b90a137d30a6322d76023d879d40fc31f3edf0a6
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Feb 14 10:18:20 2008 -0500

    [SCTP]: Correctly set the length of sctp_assoc_change notification
    
    sctp_assoc_change notification may contain the data from a received
    ABORT chunk.  Set the length correctly to account for that.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 5f31886ff03ef68dc078c585fa3a2af9a011a8fa
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Wed Feb 20 00:23:01 2008 -0800

    [SCTP]: Pick up an orphaned sctp_sockets_allocated counter.
    
    This counter is currently write-only.
    
    Drawing an analogy with the similar tcp counter, I think
    that this one should be pointed by the sockets_allocated
    members of sctp_prot and sctpv6_prot.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 25f666300625d894ebe04bac2b4b3aadb907c861
Merge: 0b6ca82af83a 21347456abfb
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Sun Feb 10 00:04:35 2008 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (28 commits)
      [NET_SCHED] sch_htb: htb_requeue fix
      [IPV6]: Replace using the magic constant "1024" with IP6_RT_PRIO_USER for fc_metric.
      starfire: secton fix
      via-velocity: section fix
      natsemi: section fix
      typhoon: section fix
      isdn: fix section mismatch warning for ISACVer
      isdn: fix section mismatch warnings from hisax_cs_setup_card
      isdn: fix section mismatch warnings in isac.c and isar.c
      isdn: fix section mismatch warning in hfc_sx.c
      [PKT_SCHED] ematch: tcf_em_destroy robustness
      [PKT_SCHED]: deinline functions in meta match
      [SCTP]: Convert sctp_dbg_objcnt to seq files.
      [SCTP]: Use snmp_fold_field instead of a homebrew analogue.
      [IGMP]: Optimize kfree_skb in igmp_rcv.
      [KEY]: Convert net/pfkey to use seq files.
      [KEY]: Clean up proc files creation a bit.
      pppol2tp: fix printk warnings
      bnx2: section fix
      bnx2x: section fix
      ...

commit 8ff65b46031c47e476f70c5b82499b98e487a50c
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Sat Feb 9 23:24:58 2008 -0800

    [SCTP]: Convert sctp_dbg_objcnt to seq files.
    
    This makes the code use a good proc API and the text ~50 bytes shorter.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3f5340a67e75c6e34abbeafda98c85bff236109d
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Sat Feb 9 23:23:44 2008 -0800

    [SCTP]: Use snmp_fold_field instead of a homebrew analogue.
    
    SCPT already depends in INET, so this doesn't create additional
    dependencies.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5f9646c3d9f92a93b96c40e65c3d268baada842f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Feb 5 14:23:44 2008 -0500

    [SCTP]: Make sure the chunk is off the transmitted list prior to freeing.
    
    In a few instances, we need to remove the chunk from the transmitted list
    prior to freeing it.  This is because the free code doesn't do that any
    more and so we need to do it manually.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit a869981423b96045c49420a6884c72528836cea8
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Feb 5 23:35:04 2008 +0900

    [SCTP]: Fix kernel panic while received ASCONF chunk with bad serial number
    
    While recevied ASCONF chunk with serial number less then needed, kernel
    will treat this chunk as a retransmitted ASCONF chunk and find cached
    ASCONF-ACK chunk used sctp_assoc_lookup_asconf_ack(). But this function
    will always return NO-NULL. So response with cached ASCONF-ACKs chunk
    will cause kernel panic.
    In function sctp_assoc_lookup_asconf_ack(), if the cached ASCONF-ACKs
    list asconf_ack_list is empty, or if the serial being requested does not
    exists, the function as it currectly stands returns the actuall
    list_head asoc->asconf_ack_list, this is not a cache ASCONF-ACK chunk
    but a bogus pointer.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b46ae36de451212d253f31112338517753739191
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 28 14:25:36 2008 -0500

    [SCTP]: Set ports in every address returned by sctp_getladdrs()
    
    Thomas Dreibholz has reported that port numbers are not filled
    in the results of sctp_getladdrs() when the socket was bound
    to an ephemeral port.  This is only true, if the address was
    not specified either.  So, fill in the port number correctly.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit c068be5491924c1c1c37dc046f36976c27bc7bb2
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 15 11:41:56 2008 -0500

    [SCTP]: Correctly reap SSNs when processing FORWARD_TSN chunk
    
    When we recieve a FORWARD_TSN chunk, we need to reap
    all the queued fast-forwarded chunks from the ordering queue
     However, if we don't have them queued, we need to see if
    the next expected one is there as well.  If it is, start
    deliver from that point instead of waiting for the next
    chunk to arrive.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 3d412f60b71e588544e7b75861084f12aa1d7acd
Merge: 3098a1801f8b 3113e88c3cb3
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Tue Feb 5 10:09:07 2008 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (21 commits)
      [PKT_SCHED]: vlan tag match
      [NET]: Add if_addrlabel.h to sanitized headers.
      [NET] rtnetlink.c: remove no longer used functions
      [ICMP]: Restore pskb_pull calls in receive function
      [INET]: Fix accidentally broken inet(6)_hash_connect's port offset calculations.
      [NET]: Remove further references to net-modules.txt
      bluetooth rfcomm tty: destroy before tty_close()
      bluetooth: blacklist another Broadcom BCM2035 device
      drivers/bluetooth/btsdio.c: fix double-free
      drivers/bluetooth/bpa10x.c: fix memleak
      bluetooth: uninlining
      bluetooth: hidp_process_hid_control remove unnecessary parameter dealing
      tun: impossible to deassert IFF_ONE_QUEUE or IFF_NO_PI
      hamradio: fix dmascc section mismatch
      [SCTP]: Fix kernel panic while received AUTH chunk with BAD shared key identifier
      [SCTP]: Fix kernel panic while received AUTH chunk while enabled auth
      [IPV4]: Formatting fix for /proc/net/fib_trie.
      [IPV6]: Fix sysctl compilation error.
      [NET_SCHED]: Add #ifdef CONFIG_NET_EMATCH in net/sched/cls_flow.c (latest git broken build)
      [IPV4]: Fix compile error building without CONFIG_FS_PROC
      ...

commit 01f2d38498957e967cd6f6011a6b208393957b4a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jan 11 11:17:27 2008 -0500

    [SCTP]: Kill silly inlines in ulpqueue.c
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 0eca8fee0ce3fa0962ac98ab30c10995754a3195
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jan 11 10:12:56 2008 -0500

    [SCTP]: Do not increase rwnd when reading partial notification.
    
    When a user reads a partial notification message, do not
    update rwnd since notifications must not be counted towards
    receive window.
    
    Tested-by: Oliver Roll <mail@oliroll.de>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 60c778b25972e095df8981dd41e99d161e8738f9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jan 11 09:57:09 2008 -0500

    [SCTP]: Stop claiming that this is a "reference implementation"
    
    I was notified by Randy Stewart that lksctp claims to be
    "the reference implementation".  First of all, "the
    refrence implementation" was the original implementation
    of SCTP in usersapce written ty Randy and a few others.
    Second, after looking at the definiton of 'reference implementation',
    we don't really meet the requirements.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 7cc08b55fc476a9474e4dc9da41071b5dc2b406e
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Feb 5 03:03:06 2008 -0800

    [SCTP]: Fix kernel panic while received AUTH chunk with BAD shared key identifier
    
    If SCTP-AUTH is enabled, received AUTH chunk with BAD shared key
    identifier will cause kernel panic.
    
    Test as following:
    step1: enabled /proc/sys/net/sctp/auth_enable
    step 2:  connect  to SCTP server with auth capable. Association is
    established between endpoints. Then send a AUTH chunk with a bad
    shareid, SCTP server will kernel panic after received that AUTH chunk.
    
    SCTP client                   SCTP server
      INIT         ---------->
        (with auth capable)
                   <----------    INIT-ACK
                                  (with auth capable)
      COOKIE-ECHO  ---------->
                   <----------    COOKIE-ACK
      AUTH         ---------->
    
    
    AUTH chunk is like this:
      AUTH chunk
        Chunk type: AUTH (15)
        Chunk flags: 0x00
        Chunk length: 28
        Shared key identifier: 10
        HMAC identifier: SHA-1 (1)
        HMAC: 0000000000000000000000000000000000000000
    
    The assignment of NULL to key can safely be removed, since key_for_each
    (which is just list_for_each_entry under the covers does an initial
    assignment to key anyway).
    
    If the endpoint_shared_keys list is empty, or if the key_id being
    requested does not exist, the function as it currently stands returns
    the actuall list_head (in this case endpoint_shared_keys.  Since that
    list_head isn't surrounded by an actuall data structure, the last
    iteration through list_for_each_entry will do a container_of on key, and
    we wind up returning a bogus pointer, instead of NULL, as we should.
    
    > Neil Horman wrote:
    >> On Tue, Jan 22, 2008 at 05:29:20PM +0900, Wei Yongjun wrote:
    >>
    >> FWIW, Ack from me.  The assignment of NULL to key can safely be
    >> removed, since
    >> key_for_each (which is just list_for_each_entry under the covers does
    >> an initial
    >> assignment to key anyway).
    >> If the endpoint_shared_keys list is empty, or if the key_id being
    >> requested does
    >> not exist, the function as it currently stands returns the actuall
    >> list_head (in
    >> this case endpoint_shared_keys.  Since that list_head isn't
    >> surrounded by an
    >> actuall data structure, the last iteration through
    >> list_for_each_entry will do a
    >> container_of on key, and we wind up returning a bogus pointer,
    >> instead of NULL,
    >> as we should.  Wei's patch corrects that.
    >>
    >> Regards
    >> Neil
    >>
    >> Acked-by: Neil Horman <nhorman@tuxdriver.com>
    >>
    >
    > Yep, the patch is correct.
    >
    > Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    >
    > -vlad
    >
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d2f19fa13ee5e78d4195a771f8f1ff7d42a80740
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Feb 5 03:02:26 2008 -0800

    [SCTP]: Fix kernel panic while received AUTH chunk while enabled auth
    
    If STCP is started while /proc/sys/net/sctp/auth_enable is set 0 and
    association is established between endpoints. Then if
    /proc/sys/net/sctp/auth_enable is set 1, a received AUTH chunk will
    cause kernel panic.
    
    Test as following:
    step 1: echo 0> /proc/sys/net/sctp/auth_enable
    step 2:
    
       SCTP client                  SCTP server
          INIT          --------->
                        <---------   INIT-ACK
          COOKIE-ECHO   --------->
                        <---------   COOKIE-ACK
    step 3:
        echo 1> /proc/sys/net/sctp/auth_enable
    step 4:
       SCTP client                  SCTP server
           AUTH        ----------->  Kernel Panic
    
    
    This patch fix this probleam to treat AUTH chunk as unknow chunk if peer
    has initialized with no auth capable.
    
    > Sorry for the delay.  Was on vacation without net access.
    >
    > Wei Yongjun wrote:
    >>
    >>
    >> This patch fix this probleam to treat AUTH chunk as unknow chunk if
    >> peer has initialized with no auth capable.
    >>
    >> Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    >
    > Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    >
    >>
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ab1e0a13d70299e792fd0527cefd070c1405fa5b
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Sun Feb 3 04:06:04 2008 -0800

    [SOCK] proto: Add hashinfo member to struct proto
    
    This way we can remove TCP and DCCP specific versions of
    
    sk->sk_prot->get_port: both v4 and v6 use inet_csk_get_port
    sk->sk_prot->hash:     inet_hash is directly used, only v6 need
                           a specific version to deal with mapped sockets
    sk->sk_prot->unhash:   both v4 and v6 use inet_hash directly
    
    struct inet_connection_sock_af_ops also gets a new member, bind_conflict, so
    that inet_csk_get_port can find the per family routine.
    
    Now only the lookup routines receive as a parameter a struct inet_hashtable.
    
    With this we further reuse code, reducing the difference among INET transport
    protocols.
    
    Eventually work has to be done on UDP and SCTP to make them share this
    infrastructure and get as a bonus inet_diag interfaces so that iproute can be
    used with these protocols.
    
    net-2.6/net/ipv4/inet_hashtables.c:
      struct proto                       |   +8
      struct inet_connection_sock_af_ops |   +8
     2 structs changed
      __inet_hash_nolisten               |  +18
      __inet_hash                        | -210
      inet_put_port                      |   +8
      inet_bind_bucket_create            |   +1
      __inet_hash_connect                |   -8
     5 functions changed, 27 bytes added, 218 bytes removed, diff: -191
    
    net-2.6/net/core/sock.c:
      proto_seq_show                     |   +3
     1 function changed, 3 bytes added, diff: +3
    
    net-2.6/net/ipv4/inet_connection_sock.c:
      inet_csk_get_port                  |  +15
     1 function changed, 15 bytes added, diff: +15
    
    net-2.6/net/ipv4/tcp.c:
      tcp_set_state                      |   -7
     1 function changed, 7 bytes removed, diff: -7
    
    net-2.6/net/ipv4/tcp_ipv4.c:
      tcp_v4_get_port                    |  -31
      tcp_v4_hash                        |  -48
      tcp_v4_destroy_sock                |   -7
      tcp_v4_syn_recv_sock               |   -2
      tcp_unhash                         | -179
     5 functions changed, 267 bytes removed, diff: -267
    
    net-2.6/net/ipv6/inet6_hashtables.c:
      __inet6_hash |   +8
     1 function changed, 8 bytes added, diff: +8
    
    net-2.6/net/ipv4/inet_hashtables.c:
      inet_unhash                        | +190
      inet_hash                          | +242
     2 functions changed, 432 bytes added, diff: +432
    
    vmlinux:
     16 functions changed, 485 bytes added, 492 bytes removed, diff: -7
    
    /home/acme/git/net-2.6/net/ipv6/tcp_ipv6.c:
      tcp_v6_get_port                    |  -31
      tcp_v6_hash                        |   -7
      tcp_v6_syn_recv_sock               |   -9
     3 functions changed, 47 bytes removed, diff: -47
    
    /home/acme/git/net-2.6/net/dccp/proto.c:
      dccp_destroy_sock                  |   -7
      dccp_unhash                        | -179
      dccp_hash                          |  -49
      dccp_set_state                     |   -7
      dccp_done                          |   +1
     5 functions changed, 1 bytes added, 242 bytes removed, diff: -241
    
    /home/acme/git/net-2.6/net/dccp/ipv4.c:
      dccp_v4_get_port                   |  -31
      dccp_v4_request_recv_sock          |   -2
     2 functions changed, 33 bytes removed, diff: -33
    
    /home/acme/git/net-2.6/net/dccp/ipv6.c:
      dccp_v6_get_port                   |  -31
      dccp_v6_hash                       |   -7
      dccp_v6_request_recv_sock          |   +5
     3 functions changed, 5 bytes added, 38 bytes removed, diff: -33
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ec9dbb1c3ee785ddc0c327497df42c16188d1fd8
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Jan 28 20:58:46 2008 -0800

    [SCTP]: Fix miss of report unrecognized HMAC Algorithm parameter
    
    This patch fix miss of check for report unrecognized HMAC Algorithm
    parameter.  When AUTH is disabled, goto fall through path to report
    unrecognized parameter, else, just break
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 853f4b505578ea3a1d9c2f5fb4ca58658ea15780
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Jan 20 06:10:46 2008 -0800

    [SCTP]: Correctly initialize error when parameter validation failed.
    
    When parameter validation fails, there should be error causes that
    specify what type of failure we've encountered.  If the causes are not
    there, we lacked memory to allocated them.  Thus make that the default
    value for the error.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 66688ea7c8e5cb3ea987d8945fffd099ce80a299
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Jan 18 04:47:58 2008 -0800

    [SCTP]: Fix build warning in sctp_sf_do_5_1C_ack().
    
    Reported by Andrew Morton.
    
    net/sctp/sm_statefuns.c: In function 'sctp_sf_do_5_1C_ack':
    net/sctp/sm_statefuns.c:484: warning: 'error' may be used uninitialized in this function
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9b1c2cfd7a8b3840cf5c99d0560e641ff4a3425b
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jan 14 23:48:02 2008 -0800

    [NETFILTER]: nf_conntrack_sctp: replace magic value by symbolic constant
    
    Use SCTP_CHUNK_FLAG_T instead of 0x1.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4a64830af0fd4dbec908cfbab117def5086acd4a
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jan 14 23:47:25 2008 -0800

    [NETFILTER]: nf_conntrack_sctp: don't take sctp_lock once per chunk
    
    Don't take and release the lock once per SCTP chunk, simply hold it
    the entire time while iterating through the chunks.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a5e73c29d9243cc2e889a9d7155f331923eee655
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jan 14 23:45:11 2008 -0800

    [NETFILTER]: nf_conntrack_{tcp,sctp}: shrink state table
    
    The TCP and SCTP conntrack state transition tables only holds
    small numbers, but gcc uses 4 byte per entry for the enum. Switching
    to an u8 reduces the size from 480 to 120 bytes for TCP and from
    576 to 144 bytes for SCTP.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8ce22fcab432313717d393c96ad35f0aee016e83
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jan 14 23:31:36 2008 -0800

    [NETFILTER]: Remove some EXPERIMENTAL dependencies
    
    Most of the netfilter modules are not considered experimental anymore,
    the only ones I want to keep marked as EXPERIMENTAL are:
    
    - TCPOPTSTRIP target, which is brand new.
    
    - SANE helper, which is quite new.
    
    - CLUSTERIP target, which I believe hasn't had much testing despite
      being in the kernel for quite a long time.
    
    - SCTP match and conntrack protocol, which are a mess and need to
      be reviewed and cleaned up before I would trust them.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3ab224be6d69de912ee21302745ea45a99274dbc
Author: Hideo Aoki <haoki@redhat.com>
Date:   Mon Dec 31 00:11:19 2007 -0800

    [NET] CORE: Introducing new memory accounting interface.
    
    This patch introduces new memory accounting functions for each network
    protocol. Most of them are renamed from memory accounting functions
    for stream protocols. At the same time, some stream memory accounting
    functions are removed since other functions do same thing.
    
    Renaming:
            sk_stream_free_skb()            ->      sk_wmem_free_skb()
            __sk_stream_mem_reclaim()       ->      __sk_mem_reclaim()
            sk_stream_mem_reclaim()         ->      sk_mem_reclaim()
            sk_stream_mem_schedule          ->      __sk_mem_schedule()
            sk_stream_pages()               ->      sk_mem_pages()
            sk_stream_rmem_schedule()       ->      sk_rmem_schedule()
            sk_stream_wmem_schedule()       ->      sk_wmem_schedule()
            sk_charge_skb()                 ->      sk_mem_charge()
    
    Removeing
            sk_stream_rfree():      consolidates into sock_rfree()
            sk_stream_set_owner_r(): consolidates into skb_set_owner_r()
            sk_stream_mem_schedule()
    
    The following functions are added.
            sk_has_account(): check if the protocol supports accounting
            sk_mem_uncharge(): do the opposite of sk_mem_charge()
    
    In addition, to achieve consolidation, updating sk_wmem_queued is
    removed from sk_mem_charge().
    
    Next, to consolidate memory accounting functions, this patch adds
    memory accounting calls to network core functions. Moreover, present
    memory accounting call is renamed to new accounting call.
    
    Finally we replace present memory accounting calls with new interface
    in TCP and SCTP.
    
    Signed-off-by: Takahiro Yasui <tyasui@redhat.com>
    Signed-off-by: Hideo Aoki <haoki@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d6701191329b51793bc56724548f0863d2149c29
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:13:31 2007 -0800

    [SCTP]: Follow Add-IP security consideratiosn wrt INIT/INIT-ACK
    
    The Security Considerations section of RFC 5061 has the following
    text:
    
       If an SCTP endpoint that supports this extension receives an INIT
       that indicates that the peer supports the ASCONF extension but does
       NOT support the [RFC4895] extension, the receiver of such an INIT
       MUST send an ABORT in response.  Note that an implementation is
       allowed to silently discard such an INIT as an option as well, but
       under NO circumstance is an implementation allowed to proceed with
       the association setup by sending an INIT-ACK in response.
    
       An implementation that receives an INIT-ACK that indicates that the
       peer does not support the [RFC4895] extension MUST NOT send the
       COOKIE-ECHO to establish the association.  Instead, the
       implementation MUST discard the INIT-ACK and report to the upper-
       layer user that an association cannot be established destroying the
       Transmission Control Block (TCB).
    
    Follow the recomendations.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 75205f478331cc64ce729ea72d3c8c1837fb59cb
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:12:59 2007 -0800

    [SCTP]: Implement ADD-IP special case processing for ABORT chunk
    
    ADD-IP spec has a special case for processing ABORTs:
        F4) ... One special consideration is that ABORT
            Chunks arriving destined to the IP address being deleted MUST be
            ignored (see Section 5.3.1 for further details).
    
    Check if the address we received on is in the DEL state, and if
    so, ignore the ABORT.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f57d96b2e92d209ab3991bba9a44e0d6ef7614a8
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:12:24 2007 -0800

    [SCTP]: Change use_as_src into a full address state
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a08de64d074b36a56ee3bb985cd171281db78e96
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:11:47 2007 -0800

    [SCTP]: Update ASCONF processing to conform to spec.
    
    The processing of the ASCONF chunks has changed a lot in the
    spec.  New items are:
        1. A list of ASCONF-ACK chunks is now cached
        2. The source of the packet is used in response.
        3. New handling for unexpect ASCONF chunks.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ba8a06daed7d7c8785c92c343da9e202e6988fda
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:11:11 2007 -0800

    [SCTP]: ADD-IP updates the states where ASCONFs can be sent
    
       C4)  Both ASCONF and ASCONF-ACK Chunks MUST NOT be sent in any SCTP
            state except ESTABLISHED, SHUTDOWN-PENDING, SHUTDOWN-RECEIVED,
            and SHUTDOWN-SENT.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit df21857714398acb8b24a8bb5a6d2286dd9c59ef
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:10:38 2007 -0800

    [SCTP]: Update association lookup to look at ASCONF chunks as well
    
    ADD-IP draft section 5.2 specifies that if an association can not
    be found using the source and destination of the IP packet,
    then, if the packet contains ASCONF chunks, the Address Parameter
    TLV should be used to lookup an association.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d6de3097592b7ae7f8e233a4dafb088e2aa8170f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:10:00 2007 -0800

    [SCTP]: Add the handling of "Set Primary IP Address" parameter to INIT
    
    The ADD-IP "Set Primary IP Address" parameter is allowed in the
    INIT/INIT-ACK exchange.  Allow processing of this parameter during
    the INIT/INIT-ACK.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 42e30bf3463cd37d73839376662cb79b4d5c416c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:08:56 2007 -0800

    [SCTP]: Handle the wildcard ADD-IP Address parameter
    
    The Address Parameter in the parameter list of the ASCONF chunk
    may be a wildcard address.  In this case special processing
    is required.  For the 'add' case, the source IP of the packet is
    added.  In the 'del' case, all addresses except the source IP
    of packet are removed. In the "mark primary" case, the source
    address is marked as primary.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6afd2e83cd86b17b074e1854d063b8ec590d7f5b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 20 14:08:04 2007 -0800

    [SCTP]: Discard unauthenticated ASCONF and ASCONF ACK chunks
    
    Now that we support AUTH, discard unauthenticated ASCONF and ASCONF ACK
    chunks as mandated in the ADD-IP spec.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c7212e9d3938258abe3fd17d15bb0d5c1856b8df
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Mon Dec 17 22:29:02 2007 -0800

    [NETFILTER]: nf_conntrack_sctp: add ctnetlink support
    
    This patch adds support for SCTP to ctnetlink.
    
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9ad0977fe10bd5d052a6db7738afe017367c2e32
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Dec 16 14:06:41 2007 -0800

    [SCTP]: Use crc32c library for checksum calculations.
    
    The crc32c library used an identical table and algorithm
    as SCTP.  Switch to using the library instead of carrying
    our own table.  Using crypto layer proved to have too
    much overhead compared to using the library directly.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a302002516a094015e5d004b8d939a8a34559c82
Author: Gerrit Renker <gerrit@erg.abdn.ac.uk>
Date:   Sat Nov 24 22:10:29 2007 -0200

    [CCID2]: Remove redundant ack-counting variable
    
    The code used two different variables to count Acks, one of them redundant.
    This patch reduces the number of Ack counters to one.
    
    The type of the Ack counter has also been changed to u32 (twice the range of int);
    and the variable has been renamed into `packets_acked' - for consistency with
    RFC 3465 (and similarly named variables are used by TCP and SCTP).
    
    Lastly, a slightly less aggressive `maxincr' increment is used (for even Ack Ratios,
    maxincr was Ack Ratio/2 + 1 instead of Ack Ratio/2).
    
    Signed-off-by: Gerrit Renker <gerrit@erg.abdn.ac.uk>
    Acked-by: Ian McDonald <ian.mcdonald@jandi.co.nz>
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 036b579b1146f52c51398f1ab663cf659094107d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 7 00:28:16 2008 -0800

    [SCTP]: Add back the code that accounted for FORWARD_TSN parameter in INIT.
    
    Some recent changes completely removed accounting for the FORWARD_TSN
    parameter length in the INIT and INIT-ACK chunk.  This is wrong and
    should be restored.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6df9cfc1ad45839e2a11330ab354330c6128cb73
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 7 00:27:45 2008 -0800

    [SCTP]: Correctly handle AUTH parameters in unexpected INIT
    
    When processing an unexpected INIT chunk, we do not need to
    do any preservation of the old AUTH parameters.  In fact,
    doing such preservations will nullify AUTH and allow connection
    stealing.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f691724c4d3b150bfa9cc8a969ea2020e20dfb12
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 7 00:27:16 2008 -0800

    [SCTP]: Fix the name of the authentication event.
    
    The even should be called SCTP_AUTHENTICATION_INDICATION.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5b825ed22b02691e39774e8b2a077d1807969ec7
Merge: a4c80d2ae2ca d883a0367149
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Dec 21 15:52:24 2007 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (23 commits)
      [IPV4]: OOPS with NETLINK_FIB_LOOKUP netlink socket
      [NET]: Fix function put_cmsg() which may cause usr application memory overflow
      [ATM]: Spelling fixes
      [NETFILTER] ipv4: Spelling fixes
      [NETFILTER]: Spelling fixes
      [SCTP]: Spelling fixes
      [NETLABEL]: Spelling fixes
      [PKT_SCHED]: Spelling fixes
      [NET] net/core/: Spelling fixes
      [IPV6]: Spelling fixes
      [IRDA]: Spelling fixes
      [DCCP]: Spelling fixes
      [NET] include/net/: Spelling fixes
      [NET]: Correct two mistaken skb_reset_mac_header() conversions.
      [IPV4] ip_gre: set mac_header correctly in receive path
      [XFRM]: Audit function arguments misordered
      [IPSEC]: Avoid undefined shift operation when testing algorithm ID
      [IPV4] ARP: Remove not used code
      [TG3]: Endianness bugfix.
      [TG3]: Endianness annotations.
      ...

commit 7aa1b54b74d813e01c46a5344c52f06037a95da0
Author: Joe Perches <joe@perches.com>
Date:   Thu Dec 20 14:03:52 2007 -0800

    [SCTP]: Spelling fixes
    
    Signed-off-by: Joe Perches <joe@perches.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit aa62a869454c5900687822ee117f2d3494e2ea62
Merge: de29cba9c9bb a26e01d71622
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Mon Dec 17 08:43:49 2007 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      [IRDA]: irda parameters warning fixes.
      [IRDA]: stir4200 fixes.
      [IRDA]: irlmp_unregister_link() needs to free lsaps.
      [IRDA]: mcs7780 needs to free allocated rx buffer.
      [IRDA]: Race between open and disconnect in irda-usb.
      [SCTP]: Flush fragment queue when exiting partial delivery.
      [AX25]: Locking dependencies fix in ax25_disconnect().
      [IPV4]: Make tcp_input_metrics() get minimum RTO via tcp_rto_min()
      [IPV6]: Fix the return value of ipv6_getsockopt
      [BRIDGE]: Assign random address.
      [IPV4]: Updates to nfsroot documentation
      [ATM]: Fix compiler warning noise with FORE200E driver
      [NETFILTER]: bridge: fix missing link layer headers on outgoing routed packets
      [SYNCPPP]: Endianness and 64bit fixes.
      [TIPC]: Fix semaphore handling.
      [NETFILTER]: xt_hashlimit should use time_after_eq()
      [XFRM]: Display the audited SPI value in host byte order.
      [NETFILTER]: ip_tables: fix compat copy race
      [NETFILTER]: ctnetlink: set expected bit for related conntracks

commit ef5d4cf2f9aae4e09883d2d664e367a16b47d857
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Dec 16 14:05:45 2007 -0800

    [SCTP]: Flush fragment queue when exiting partial delivery.
    
    At the end of partial delivery, we may have complete messages
    sitting on the fragment queue.  These messages are stuck there
    until a new fragment arrives.  This can comletely stall a
    given association.  When clearing partial delivery state, flush
    any complete messages from the fragment queue and send them on
    their way up.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 29ac0052ea454871273a1fc7ef09a97f3c214ee6
Merge: f3656b9a2740 4aa9cb320e80
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Dec 7 10:59:48 2007 -0800

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [AF_RXRPC]: Add a missing goto
      [VLAN]: Lost rtnl_unlock() in vlan_ioctl()
      [SCTP]: Fix the bind_addr info during migration.
      [SCTP]: Add bind hash locking to the migrate code
      [IPV4]: Remove prototype of ip_rt_advice
      [IPv4]: Reply net unreachable ICMP message
      [IPv6] SNMP: Increment OutNoRoutes when connecting to unreachable network
      [BRIDGE]: Section fix.
      [NIU]: Fix link LED handling.

commit 8e71a11c9f3c09a01fcb445772ffd61b140f2479
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 6 22:50:54 2007 -0800

    [SCTP]: Fix the bind_addr info during migration.
    
    During accept/migrate the code attempts to copy the addresses from
    the parent endpoint to the new endpoint.   However, if the parent
    was bound to a wildcard address, then we end up pointlessly copying
    all of the current addresses on the system.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f26f7c480555812ca7c4037e0a50fa54afe2cb4a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Dec 6 22:50:27 2007 -0800

    [SCTP]: Add bind hash locking to the migrate code
    
    SCTP accept code tries to add a newliy created socket
    to a bind bucket without holding a lock.   On a really
    busy system, that can causes slab corruptions.
    Add a lock around this code.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8002cedc1adbf51e2d56091534ef7551b88329b4
Merge: e87cb5db0dc3 d523a328fb02
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Mon Dec 3 08:15:36 2007 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/herbert/net-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/herbert/net-2.6: (27 commits)
      [INET]: Fix inet_diag dead-lock regression
      [NETNS]: Fix /proc/net breakage
      [TEXTSEARCH]: Do not allow zero length patterns in the textsearch infrastructure
      [NETFILTER]: fix forgotten module release in xt_CONNMARK and xt_CONNSECMARK
      [NETFILTER]: xt_TCPMSS: remove network triggerable WARN_ON
      [DECNET]: dn_nl_deladdr() almost always returns no error
      [IPV6]: Restore IPv6 when MTU is big enough
      [RXRPC]: Add missing select on CRYPTO
      mac80211: rate limit wep decrypt failed messages
      rfkill: fix double-mutex-locking
      mac80211: drop unencrypted frames if encryption is expected
      mac80211: Fix behavior of ieee80211_open and ieee80211_close
      ieee80211: fix unaligned access in ieee80211_copy_snap
      mac80211: free ifsta->extra_ie and clear IEEE80211_STA_PRIVACY_INVOKED
      SCTP: Fix build issues with SCTP AUTH.
      SCTP: Fix chunk acceptance when no authenticated chunks were listed.
      SCTP: Fix the supported extensions paramter
      SCTP: Fix SCTP-AUTH to correctly add HMACS paramter.
      SCTP: Fix the number of HB transmissions.
      [TCP] illinois: Incorrect beta usage
      ...

commit b7e0fe9f81e19c4f2a1369b324c3c062c1738be4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 29 09:53:52 2007 -0500

    SCTP: Fix build issues with SCTP AUTH.
    
    SCTP-AUTH requires selection of CRYPTO, HMAC and SHA1 since
    SHA1 is a MUST requirement for AUTH.  We also support SHA256,
    but that's optional, so fix the code to treat it as such.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 555d3d5d2be13675490a80df0d7961551822ef1f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 29 08:56:16 2007 -0500

    SCTP: Fix chunk acceptance when no authenticated chunks were listed.
    
    In the case where no autheticated chunks were specified, we were still
    trying to verify that a given chunk needs authentication and doing so
    incorrectly.  Add a check for parameter length to make sure we don't
    try to use an empty auth_chunks parameter to verify against.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 8ee4be37e8ac28e79ae673d441e83c1f51e7ecfd
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 29 08:50:35 2007 -0500

    SCTP: Fix the supported extensions paramter
    
    Supported extensions parameter was not coded right and ended up
    over-writing memory or causing skb overflows.  First, remove
    the FWD_TSN support from as it shouldn't be there and also fix
    the paramter encoding.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 9baffaa689a50ef9480ecd9017ffd1480c807328
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 29 08:44:34 2007 -0500

    SCTP: Fix SCTP-AUTH to correctly add HMACS paramter.
    
    There was a typo that cleared the HMACS parameters when no
    authenticated chunks were specified.  We whould be clearing
    the chunks pointer instead of the hmacs.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit fd10279bc7405c4f1e47a008686d3d9ad71d7f6d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 15 12:13:32 2007 -0500

    SCTP: Fix the number of HB transmissions.
    
    Our treatment of Heartbeats is special in that the inital HB chunk
    counts against the error count for the association, where as for
    other chunks, only retransmissions or timeouts count against us.
    As a result, we had an off-by-1 situation with a number of
    Heartbeats we could send.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 9ee46f1d31cf70b7e6375bc50b811f529b7bc82e
Author: Joe Perches <joe@perches.com>
Date:   Mon Nov 19 23:47:47 2007 -0800

    [SCTP]: Add missing "space"
    
    Signed-off-by: Joe Perches <joe@perches.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9abed245a6dc94c32b2f45a1ecc51a0829d11470
Author: Jesper Juhl <jesper.juhl@gmail.com>
Date:   Sun Nov 11 23:57:49 2007 +0100

    Fix memory leak in discard case of sctp_sf_abort_violation()
    
    In net/sctp/sm_statefuns.c::sctp_sf_abort_violation() we may leak
    the storage allocated for 'abort' by returning from the function
    without using or freeing it. This happens in case
    "sctp_auth_recv_cid(SCTP_CID_ABORT, asoc)" is true and we jump to
    the 'discard' label.
    Spotted by the Coverity checker.
    
    The simple fix is to simply move the creation of the "abort chunk"
    to after the possible jump to the 'discard' label. This way we don't
    even have to allocate the memory at all in the problem case.
    
    Signed-off-by: Jesper Juhl <jesper.juhl@gmail.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 7d54dc6876b83d6bb75b8f7e865b7b9051056d22
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:43:41 2007 -0500

    SCTP: Always flush the queue when uncorcking.
    
    When the code calls uncork, trigger a queue flush, even
    if the queue was not corked.  Most callers that explicitely
    cork the queue will have additinal checks to see if they
    corked it.  Callers who do not cork the queue expect packets
    to flow when they call uncork.
    
    The scneario that showcased this bug happend when we were not
    able to bundle DATA with outgoing COOKIE-ECHO.  As a result
    the data just sat in the outqueue and did not get transmitted.
    The application expected a response, but nothing happened.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit fa7ff654e14ccacd4e758c9878ff4884f816c877
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:43:41 2007 -0500

    SCTP: Clean-up some defines for regressions tests.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit cd3ae8e61570b55e32864c5f9e50085aa67126e9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:43:41 2007 -0500

    SCTP: Fix PR-SCTP to deliver all the accumulated ordered chunks
    
    There is a small bug when we process a FWD-TSN.  We'll deliver
    anything upto the current next expected SSN.  However, if the
    next expected is already in the queue, it will take another
    chunk to trigger its delivery.  The fix is to simply check
    the current queued SSN is the next expected one.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 7ab9080467040054e27ae54d67cc185f24d881ae
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:43:41 2007 -0500

    SCTP: Make sctp_verify_param return multiple indications.
    
    SCTP-AUTH and future ADD-IP updates have a requirement to
    do additional verification of parameters and an ability to
    ABORT the association if verification fails.  So, introduce
    additional return code so that we can clear signal a required
    action.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit d970dbf8455eb1b8cebd3cde6e18f73dd1b3ce38
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:43:40 2007 -0500

    SCTP: Convert custom hash lists to use hlist.
    
    Convert the custom hash list traversals to use hlist functions.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 123ed979eaa8de0dd2422862d247469eda0bd645
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 9 11:41:36 2007 -0500

    SCTP: Use hashed lookup when looking for an association.
    
    A SCTP endpoint may have a lot of associations on them and walking
    the list is fairly inefficient.  Instead, use a hashed lookup,
    and filter out the hash list based on the endopoing we already have.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 027f6e1ad32de32f9fe1c61d0f744e329e8acfd9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Nov 7 11:39:27 2007 -0500

    SCTP: Fix a potential race between timers and receive path.
    
    There is a possible race condition where the timer code will
    free the association and the next packet in the queue will also
    attempt to free the same association.
    
    The example is, when we receive an ABORT at about the same time
    as the retransmission timer fires.  If the timer wins the race,
    it will free the association.  Once it releases the lock, the
    queue processing will recieve the ABORT and will try to free
    the association again.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 73d9c4fd1a6ec4950b2eac8135d35506bf400d6c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Oct 24 17:24:26 2007 -0400

    SCTP: Allow ADD_IP to work with AUTH for backward compatibility.
    
    This patch adds a tunable that will allow ADD_IP to work without
    AUTH for backward compatibility.  The default value is off since
    the default value for ADD_IP is off as well.  People who need
    to use ADD-IP with older implementations take risks of connection
    hijacking and should consider upgrading or turning this tunable on.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 88799fe5ec65fad1d5cb1d4dc5d8f78edb949f1c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Oct 24 17:24:23 2007 -0400

    SCTP: Correctly disable ADD-IP when AUTH is not supported.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 0ed90fb0f668fd07f14ae2007a809e8b26cd27a6
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Oct 24 16:10:00 2007 -0400

    SCTP: Update RCU handling during the ADD-IP case
    
    After learning more about rcu, it looks like the ADD-IP hadling
    doesn't need to call call_rcu_bh.  All the rcu critical sections
    use rcu_read_lock, so using call_rcu_bh is wrong here.
    Now, restore the local_bh_disable() code blocks and use normal
    call_rcu() calls.  Also restore the missing return statement.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b6157d8e03e1e780660a328f7183bcbfa4a93a19
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Oct 24 15:59:16 2007 -0400

    SCTP: Fix difference cases of retransmit.
    
    Commit d0ce92910bc04e107b2f3f2048f07e94f570035d broke several retransmit
    cases including fast retransmit.  The reason is that we should
    only delay by rto while doing retranmists as a result of a timeout.
    Retransmit as a result of path mtu discover, fast retransmit, or
    other evernts that should trigger immidiate retransmissions got broken.
    
    Also, since rto is doubled prior to marking of packets elegable for
    retransmission, we never marked correct chunks anyway.
    
    The fix is provide a reason for a given retransmission so that we
    can mark chunks appropriately and to save the old rto value to do
    comparisons against.
    
    All regressions tests passed with this code.
    
    Spotted by Wei Yongjun <yjwei@cn.fujitsu.com>
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit f3830ccc2ea503ab37d605f6c313d61423ddd94e
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Oct 15 11:51:03 2007 +0900

    SCTP : Fix to process bundled ASCONF chunk correctly
    
    If ASCONF chunk is bundled with other chunks as the first chunk, when
    process the ASCONF parameters, full packet data will be process as the
    parameters of the ASCONF chunk, not only the real parameters. So if you
    send a ASCONF chunk bundled with other chunks, you will get an unexpect
    result.
    This problem also exists when ASCONF-ACK chunk is bundled with other chunks.
    
    This patch fix this problem.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 64b0812b6d26bb30cac74c65f51f4ebfb4ec5429
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Oct 15 11:50:38 2007 +0900

    SCTP : Fix bad formatted comment in outqueue.c
    
    Just fix the bad format of the comment in outqueue.c.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 8295b6d9e623879344ed0ca7565336e4fd698e42
Author: Eric Dumazet <dada1@cosmosbay.com>
Date:   Mon Nov 5 23:40:28 2007 -0800

    [SCTP]: Use the {DEFINE|REF}_PROTO_INUSE infrastructure
    
    Trivial patch to make "sctcp,sctpv6" protocols uses the fast "inuse
    sockets" infrastructure
    
    Each protocol use then a static percpu var, instead of a dynamic one.
    This saves some ram and some cpu cycles
    
    Signed-off-by: Eric Dumazet <dada1@cosmosbay.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d06f608265d5fc41aefe2fae5b62da4893ecae35
Author: Al Viro <viro@ftp.linux.org.uk>
Date:   Mon Oct 29 05:03:23 2007 +0000

    SCTP endianness annotations regression
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Acked-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

commit ec3b67c11df42362ccda81261d62829042f223f0
Merge: e868171a94b6 4be2700fb7b9
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Oct 26 08:43:05 2007 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6: (32 commits)
      [NetLabel]: correct usage of RCU locking
      [TCP]: fix D-SACK cwnd handling
      [NET] napi: use non-interruptible sleep in napi_disable
      [SCTP] net/sctp/auth.c: make 3 functions static
      [TCP]: Add missing I/O AT code to ipv6 side.
      [SCTP]: #if 0 sctp_update_copy_cksum()
      [INET]: Unexport icmpmsg_statistics
      [NET]: Unexport sock_enable_timestamp().
      [TCP]: Make tcp_match_skb_to_sack() static.
      [IRDA]: Make ircomm_tty static.
      [NET] fs/proc/proc_net.c: make a struct static
      [NET] dev_change_name: ignore changes to same name
      [NET]: Document some simple rules for actions
      [NET_CLS_ACT]: Use skb_act_clone
      [NET_CLS_ACT]: Introduce skb_act_clone
      [TCP]: Fix scatterlist handling in MD5 signature support.
      [IPSEC]: Fix scatterlist handling in skb_icv_walk().
      [IPSEC]: Add missing sg_init_table() calls to ESP.
      [CRYPTO]: Initialize TCRYPT on-stack scatterlist objects correctly.
      [CRYPTO]: HMAC needs some more scatterlist fixups.
      ...

commit 8ad7c62b752483982a678c78a52a70f498b84cbb
Author: Adrian Bunk <bunk@kernel.org>
Date:   Fri Oct 26 04:21:23 2007 -0700

    [SCTP] net/sctp/auth.c: make 3 functions static
    
    This patch makes three needlessly global functions static.
    
    Signed-off-by: Adrian Bunk <bunk@kernel.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d84d64dcb3b54c900113f8dcd1240205ae164922
Author: Adrian Bunk <bunk@kernel.org>
Date:   Fri Oct 26 04:07:20 2007 -0700

    [SCTP]: #if 0 sctp_update_copy_cksum()
    
    sctp_update_copy_cksum() is no longer used.
    
    Signed-off-by: Adrian Bunk <bunk@kernel.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 06dbbfef8296d6dc23e5d8030a0e8e7b20df3b7c
Merge: 22fa8d59be28 03cf786c4e83
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu Oct 25 15:50:32 2007 -0700

    Merge branch 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-2.6:
      [IPV4]: Explicitly call fib_get_table() in fib_frontend.c
      [NET]: Use BUILD_BUG_ON in net/core/flowi.c
      [NET]: Remove in-code externs for some functions from net/core/dev.c
      [NET]: Don't declare extern variables in net/core/sysctl_net_core.c
      [TCP]: Remove unneeded implicit type cast when calling tcp_minshall_update()
      [NET]: Treat the sign of the result of skb_headroom() consistently
      [9P]: Fix missing unlock before return in p9_mux_poll_start
      [PKT_SCHED]: Fix sch_prio.c build with CONFIG_NETDEVICES_MULTIQUEUE
      [IPV4] ip_gre: sendto/recvfrom NBMA address
      [SCTP]: Consolidate sctp_ulpq_renege_xxx functions
      [NETLINK]: Fix ACK processing after netlink_dump_start
      [VLAN]: MAINTAINERS update
      [DCCP]: Implement SIOCINQ/FIONREAD
      [NET]: Validate device addr prior to interface-up

commit 16d14ef9f29dfa9b1d99f3eff860e9f15bc99f39
Author: Pavel Emelyanov <xemul@openvz.org>
Date:   Tue Oct 23 20:30:25 2007 -0700

    [SCTP]: Consolidate sctp_ulpq_renege_xxx functions
    
    Both are equal, except for the list to be traversed.
    
    Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ebc3bbcfcf0a7fed2ac82f1a849a5f92cf4c217f
Author: Christian Borntraeger <borntraeger@de.ibm.com>
Date:   Tue Oct 23 12:46:32 2007 +0200

    Fix sctp compile
    
    sctp fails to compile with
    net/sctp/sm_make_chunk.c: In function 'sctp_pack_cookie':
    net/sctp/sm_make_chunk.c:1516: error: implicit declaration of function 'sg_init_table'
    net/sctp/sm_make_chunk.c:1517: error: implicit declaration of function 'sg_set_page'
    
    use the proper include file.
    
    SCTP maintainers Vlad Yasevich and Sridhar Samudrala  are CCed.
    
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: Jens Axboe <jens.axboe@oracle.com>

commit 009e8c965fd72a78636b9a96c7015109c5c70176
Author: Li Zefan <lizf@cn.fujitsu.com>
Date:   Thu Oct 18 05:12:21 2007 -0700

    [NETFILTER]: xt_sctp: fix mistake to pass a pointer where array is required
    
    Macros like SCTP_CHUNKMAP_XXX(chukmap) require chukmap to be an array,
    but match_packet() passes a pointer to these macros. Also remove the
    ELEMCOUNT macro and fix a bug in SCTP_CHUNKMAP_COPY.
    
    Signed-off-by: Li Zefan <lizf@cn.fujitsu.com>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit af49d9248fca6f26cbdb01918334f71d9040df80
Author: Rusty Russell <rusty@rustcorp.com.au>
Date:   Tue Oct 16 23:26:27 2007 -0700

    Remove "unsafe" from module struct
    
    Adrian Bunk points out that "unsafe" was used to mark modules touched by
    the deprecated MOD_INC_USE_COUNT interface, which has long gone.  It's time
    to remove the member from the module structure, as well.
    
    If you want a module which can't unload, don't register an exit function.
    
    (Vlad Yasevich says SCTP is now safe to unload, so just remove the
    __unsafe there).
    
    Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
    Acked-by: Shannon Nelson <shannon.nelson@intel.com>
    Acked-by: Dan Williams <dan.j.williams@intel.com>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Cc: Sridhar Samudrala <sri@us.ibm.com>
    Cc: Adrian Bunk <bunk@stusta.de>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

commit 06393009000779b00a558fd2f280882cc7dc2008
Author: Stephen Hemminger <shemminger@linux-foundation.org>
Date:   Wed Oct 10 17:30:18 2007 -0700

    [SCTP]: port randomization
    
    Add port randomization rather than a simple fixed rover
    for use with SCTP.  This makes it act similar to TCP, UDP, DCCP
    when allocating ports.
    
    No longer need port_alloc_lock as well (suggestion by Brian Haley).
    
    Signed-off-by: Stephen Hemminger <shemminger@linux-foundation.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6b2f9cb64db2d2460da17900bf54266030cc24f1
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:35:39 2007 -0700

    [SCTP]: Tie ADD-IP and AUTH functionality as required by spec.
    
    ADD-IP spec requires AUTH. It is, in fact, dangerous without AUTH.
    So, disable ADD-IP functionality if the peer claims to support
    ADD-IP, but not AUTH.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 65b07e5d0d09c77e98050b5f0146ead29e5add32
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:34:00 2007 -0700

    [SCTP]: API updates to suport SCTP-AUTH extensions.
    
    Add SCTP-AUTH API.  The API implemented here was
    agreed to between implementors at the 9th SCTP Interop.
    It will be documented in the next revision of the
    SCTP socket API spec.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bbd0d59809f923ea2b540cbd781b32110e249f6e
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Oct 3 17:51:34 2007 -0700

    [SCTP]: Implement the receive and verification of AUTH chunk
    
    This patch implements the receive path needed to process authenticated
    chunks.  Add ability to process the AUTH chunk and handle edge cases
    for authenticated COOKIE-ECHO as well.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4cd57c8078fae0a4b1bf421191e94626d0cba92a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:32:45 2007 -0700

    [SCTP]: Enable the sending of the AUTH chunk.
    
    SCTP-AUTH, Section 6.2:
    
       Endpoints MUST send all requested chunks authenticated where this has
       been requested by the peer.  The other chunks MAY be sent
       authenticated or not.  If endpoint pair shared keys are used, one of
       them MUST be selected for authentication.
    
       To send chunks in an authenticated way, the sender MUST include these
       chunks after an AUTH chunk.  This means that a sender MUST bundle
       chunks in order to authenticate them.
    
       If the endpoint has no endpoint pair shared key for the peer, it MUST
       use Shared Key Identifier 0 with an empty endpoint pair shared key.
       If there are multiple endpoint shared keys the sender selects one and
       uses the corresponding Shared Key Identifier
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 730fc3d05cd4ba4c9ce2de91f3d43349e95dbbf5
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:32:11 2007 -0700

    [SCTP]: Implete SCTP-AUTH parameter processing
    
    Implement processing for the CHUNKS, RANDOM, and HMAC parameters and
    deal with how this parameters are effected by association restarts.
    In particular, during unexpeted INIT processing, we need to reply with
    parameters from the original INIT chunk.  Also, after restart, we need
    to update the old association with new peer parameters and change the
    association shared keys.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a29a5bd4f5c3e8ba2e89688feab8b01c44f1654f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:31:35 2007 -0700

    [SCTP]: Implement SCTP-AUTH initializations.
    
    The patch initializes AUTH related members of the generic SCTP
    structures and provides a way to enable/disable auth extension.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1f485649f52929d9937b346a920a522a7363e202
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Oct 9 01:15:59 2007 -0700

    [SCTP]: Implement SCTP-AUTH internals
    
    This patch implements the internals operations of the AUTH, such as
    key computation and storage.  It also adds necessary variables to
    the SCTP data structures.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f7b0e93ba1a484700bd1b0e36bdaddaf4eb51b0b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 19:26:06 2007 -0700

    [SCTP]: protocol definitions for SCTP-AUTH implementation
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 007e3936bdaaa012483c9fe06ca71c272458c710
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 16:04:37 2007 -0700

    [SCTP]: Move sysctl_sctp_[rw]mem definitions to protocol.c
    
    The sctp_[rw]mem definitions should really be in protocol.c
    since that is where they are initialized.  This also allows
    one to build a kernel without sysctl support.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 131a47e31ab1a9defd50ff16b04008ab94c21c0d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 15:53:56 2007 -0700

    [SCTP]: Implement the Supported Extensions Parameter
    
    SCTP Supported Extenions parameter is specified in Section 4.2.7
    of the ADD-IP draft (soon to be RFC).  The parameter is
    encoded as:
    
          0                   1                   2                   3
          0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |     Parameter Type = 0x8008   |      Parameter Length         |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         | CHUNK TYPE 1  |  CHUNK TYPE 2 |  CHUNK TYPE 3 |  CHUNK TYPE 4 |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |                             ....                              |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         | CHUNK TYPE N  |      PAD      |      PAD      |      PAD      |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
    It contains a list of chunks that a particular SCTP extension
    uses.  Current extensions supported are Partial Reliability
    (FWD-TSN) and ADD-IP (ASCONF and ASCONF-ACK).
    
    When implementing new extensions (AUTH, PKT-DROP, etc..), new
    chunks need to be added to this parameter.  Parameter processing
    would be modified to negotiate support for these new features.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b6fa1a4d746488a7de95ec16afcaf3247fedb003
Author: Adrian Bunk <bunk@kernel.org>
Date:   Wed Sep 12 15:18:00 2007 +0200

    [SCTP] net/sctp/socket.c: make 3 variables static
    
    This patch makes the following needlessly global variables static:
    - sctp_memory_pressure
    - sctp_memory_allocated
    - sctp_sockets_allocated
    
    Signed-off-by: Adrian Bunk <bunk@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5c94bf86c865fb779f1743672b4d0f6cdd706728
Author: Adrian Bunk <bunk@kernel.org>
Date:   Wed Sep 12 15:16:21 2007 +0200

    [SCTP]: Make sctp_addto_param() static.
    
    sctp_addto_param() can become static.
    
    Signed-off-by: Adrian Bunk <bunk@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4d93df0abd50b9c9e2d4561439a1a1d21ec5e68f
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Wed Aug 15 16:07:44 2007 -0700

    [SCTP]: Rewrite of sctp buffer management code
    
    This patch introduces autotuning to the sctp buffer management code
    similar to the TCP.  The buffer space can be grown if the advertised
    receive window still has room.  This might happen if small message
    sizes are used, which is common in telecom environmens.
    New tunables are introduced that provide limits to buffer growth
    and memory pressure is entered if to much buffer spaces is used.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d85f57938ad1d674dff8077a2e6a36a45dbe0e22
Merge: acbbe6c28a91 45dfd5b5dd20
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Wed Sep 26 08:59:41 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [PPP_MPPE]: Don't put InterimKey on the stack
      SCTP : Add paramters validity check for ASCONF chunk
      SCTP: Discard OOTB packetes with bundled INIT early.
      SCTP: Clean up OOTB handling and fix infinite loop processing
      SCTP: Explicitely discard OOTB chunks
      SCTP: Send ABORT chunk with correct tag in response to INIT ACK
      SCTP: Validate buffer room when processing sequential chunks
      [PATCH] mac80211: fix initialisation when built-in
      [PATCH] net/mac80211/wme.c: fix sparse warning
      [PATCH] cfg80211: fix initialisation if built-in
      [PATCH] net/wireless/sysfs.c: Shut up build warning

commit 6f4c618ddb0e6b7e6d49cfc8134e694be1c0bc9b
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Wed Sep 19 17:19:52 2007 +0800

    SCTP : Add paramters validity check for ASCONF chunk
    
    If ADDIP is enabled, when an ASCONF chunk is received with ASCONF
    paramter length set to zero, this will cause infinite loop.
    By the way, if an malformed ASCONF chunk is received, will cause
    processing to access memory without verifying.
    
    This is because of not check the validity of parameters in ASCONF chunk.
    This patch fixed this.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 3c77f961b55b6060858c68a213d7f4470d7f3eb2
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Sep 17 15:14:28 2007 -0400

    SCTP: Discard OOTB packetes with bundled INIT early.
    
    RFC 4460 and future RFC 4960 (2960-bis) specify that packets
    with bundled INIT chunks need to be dropped.  We currenlty do
    that only after processing any leading chunks.  For OOTB chunks,
    since we already walk the entire packet, we should discard packets
    with bundled INITs.
    
    There are other chunks chunks that MUST NOT be bundled, but the spec
    is silent on theire treatment.  Thus, we'll leave their teatment
    alone for the moment.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Wei Yongjun <yjwei@cn.fujitsu.com>

commit ece25dfa0991f65c4e1d26beb1c3c45bda4239b8
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 7 16:30:54 2007 -0400

    SCTP: Clean up OOTB handling and fix infinite loop processing
    
    While processing OOTB chunks as well as chunks with an invalid
    length of 0, it was possible to SCTP to get wedged inside an
    infinite loop because we didn't catch the condition correctly,
    or didn't mark the packet for discard correctly.
    This work is based on original findings and work by
    Wei Yongjun <yjwei@cn.fujitsu.com>
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit d3f259687fd248aa4de477149481478c122ba48b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 7 11:47:45 2007 -0400

    SCTP: Explicitely discard OOTB chunks
    
    Explicitely discard OOTB chunks, whether the result is a
    SHUTDOWN COMPLETE or an ABORT.  We need to discard the OOTB
    SHUTDOWN ACK to prevent bombing attackes since responsed
    MUST NOT be bundled.  We also explicietely discard in the
    ABORT case since that function is widely used internally.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Neil Horman <nhorman@tuxdriver.com>

commit 02c4e12c6400b6dccdc6b5c2c18325551e4b2dc9
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Fri Aug 31 10:03:58 2007 +0800

    SCTP: Send ABORT chunk with correct tag in response to INIT ACK
    
    When SCTP client received an INIT ACK chunk with missing mandatory
    parameter such as "cookie parameter", it will send back a ABORT
    with T-bit not set and verification tag is set to 0.
    This is because before we accept this INIT ACK chunk, we do not know
    the peer's tag.  This patch change to reflect vtag when responding to
    INIT ACK with missing mandatory parameter.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit a09c83847b664dcd67a72613374061c900afb799
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Sep 5 15:53:58 2007 -0400

    SCTP: Validate buffer room when processing sequential chunks
    
    When we process bundled chunks, we need to make sure that
    the skb has the buffer for each header since we assume it's
    always there.  Some malicious node can send us something like
    DATA + 2 bytes and we'll try to walk off the end refrencing
    potentially uninitialized memory.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit edb1e9671a990e6eb9f593636deed7ac43ba9084
Merge: fa890d586cc1 d9f30ec0b0d1
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Sun Sep 16 21:14:54 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [VLAN]: Fix net_device leak.
      [PPP] generic: Fix receive path data clobbering & non-linear handling
      [PPP] generic: Call skb_cow_head before scribbling over skb
      [NET] skbuff: Add skb_cow_head
      [BRIDGE]: Kill clone argument to br_flood_*
      [PPP] pppoe: Fill in header directly in __pppoe_xmit
      [PPP] pppoe: Fix data clobbering in __pppoe_xmit and return value
      [PPP] pppoe: Fix skb_unshare_check call position
      [SCTP]: Convert bind_addr_list locking to RCU
      [SCTP]: Add RCU synchronization around sctp_localaddr_list
      [PKT_SCHED]: sch_cbq.c: Shut up uninitialized variable warning
      [PKTGEN]: srcmac fix
      [IPV6]: Fix source address selection.
      [IPV4]: Just increment OutDatagrams once per a datagram.
      [IPV6]: Just increment OutDatagrams once per a datagram.
      [IPV6]: Fix unbalanced socket reference with MSG_CONFIRM.
      [NET_SCHED] protect action config/dump from irqs
      [NET]: Fix two issues wrt. SO_BINDTODEVICE.

commit 559cf710b07c5e2cfa3fb8d8f4a1320fd84c53f9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 16:03:28 2007 -0700

    [SCTP]: Convert bind_addr_list locking to RCU
    
    Since the sctp_sockaddr_entry is now RCU enabled as part of
    the patch to synchronize sctp_localaddr_list, it makes sense to
    change all handling of these entries to RCU.  This includes the
    sctp_bind_addrs structure and it's list of bound addresses.
    
    This list is currently protected by an external rw_lock and that
    looks like an overkill.  There are only 2 writers to the list:
    bind()/bindx() calls, and BH processing of ASCONF-ACK chunks.
    These are already seriealized via the socket lock, so they will
    not step on each other.  These are also relatively rare, so we
    should be good with RCU.
    
    The readers are varied and they are easily converted to RCU.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
    Acked-by: Sridhar Samdurala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 293035479942400a7fe8e4f72465d4e4e466b91a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Sep 16 16:02:12 2007 -0700

    [SCTP]: Add RCU synchronization around sctp_localaddr_list
    
    sctp_localaddr_list is modified dynamically via NETDEV_UP
    and NETDEV_DOWN events, but there is not synchronization
    between writer (even handler) and readers.  As a result,
    the readers can access an entry that has been freed and
    crash the sytem.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
    Acked-by: Sridhar Samdurala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0ee13079906f0e0b185b13a1fbdaf24d853baa8d
Merge: 2d8348b429b4 88282c6ecf0d
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Aug 31 00:52:22 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [PKTGEN]: Remove write-only variable.
      [NETFILTER]: xt_tcpudp: fix wrong struct in udp_checkentry
      [NET_SCHED] sch_prio.c: remove duplicate call of tc_classify()
      [BRIDGE]: Fix OOPS when bridging device without ethtool.
      [BRIDGE]: Packets leaking out of disabled/blocked ports.
      [TCP]: Allow minimum RTO to be configurable via routing metrics.
      SCTP: Fix to handle invalid parameter length correctly
      SCTP: Abort on COOKIE-ECHO if backlog is exceeded.
      SCTP: Correctly disable listening when backlog is 0.
      SCTP: Do not retransmit chunks that are newer then rtt.
      SCTP: Uncomfirmed transports can't become Inactive
      SCTP: Pick the correct port when binding to 0.
      SCTP: Use net_ratelimit to suppress error messages print too fast
      SCTP: Fix to encode PROTOCOL VIOLATION error cause correctly
      SCTP: Fix sctp_addto_chunk() to add pad with correct length
      SCTP: Assign stream sequence numbers to the entire message
      SCTP: properly clean up fragment and ordering queues during FWD-TSN.
      [PKTGEN]: Fix multiqueue oops.
      [BNX2]: Add write posting comment.
      [BNX2]: Use msleep().

commit 6f333f6314bf003ee460abc633ea5037d1e53f06
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Aug 21 21:01:01 2007 -0700

    IPV6: Fix kernel panic while send SCTP data with IP fragments
    
    If ICMP6 message with "Packet Too Big" is received after send SCTP DATA,
    kernel panic will occur when SCTP DATA is send again.
    
    This is because of a bad dest address when call to skb_copy_bits().
    
    The messages sequence is like this:
    
    Endpoint A                             Endpoint B
                                   <-------  SCTP DATA (size=1432)
    ICMP6 message ------->
    (Packet Too Big pmtu=1280)
                                   <-------  Resend SCTP DATA (size=1432)
    ------------kernel panic---------------
    
     printing eip:
    c05be62a
    *pde = 00000000
    Oops: 0002 [#1]
    SMP
    Modules linked in: scomm l2cap bluetooth ipv6 dm_mirror dm_mod video output sbs battery lp floppy sg i2c_piix4 i2c_core pcnet32 mii button ac parport_pc parport ide_cd cdrom serio_raw mptspi mptscsih mptbase scsi_transport_spi sd_mod scsi_mod ext3 jbd ehci_hcd ohci_hcd uhci_hcd
    CPU:    0
    EIP:    0060:[<c05be62a>]    Not tainted VLI
    EFLAGS: 00010282   (2.6.23-rc2 #1)
    EIP is at skb_copy_bits+0x4f/0x1ef
    eax: 000004d0   ebx: ce12a980   ecx: 00000134   edx: cfd5a880
    esi: c8246858   edi: 00000000   ebp: c0759b14   esp: c0759adc
    ds: 007b   es: 007b   fs: 00d8  gs: 0000  ss: 0068
    Process swapper (pid: 0, ti=c0759000 task=c06d0340 task.ti=c0713000)
    Stack: c0759b88 c0405867 ce12a980 c8bff838 c789c084 00000000 00000028 cfd5a880
           d09f1890 000005dc 0000007b ce12a980 cfd5a880 c8bff838 c0759b88 d09bc521
           000004d0 fffff96c 00000200 00000100 c0759b50 cfd5a880 00000246 c0759bd4
    Call Trace:
     [<c0405e1d>] show_trace_log_lvl+0x1a/0x2f
     [<c0405ecd>] show_stack_log_lvl+0x9b/0xa3
     [<c040608d>] show_registers+0x1b8/0x289
     [<c0406271>] die+0x113/0x246
     [<c0625dbc>] do_page_fault+0x4ad/0x57e
     [<c0624642>] error_code+0x72/0x78
     [<d09bc521>] ip6_output+0x8e5/0xab2 [ipv6]
     [<d09bcec1>] ip6_xmit+0x2ea/0x3a3 [ipv6]
     [<d0a3f2ca>] sctp_v6_xmit+0x248/0x253 [sctp]
     [<d0a3c934>] sctp_packet_transmit+0x53f/0x5ae [sctp]
     [<d0a34bf8>] sctp_outq_flush+0x555/0x587 [sctp]
     [<d0a34d3c>] sctp_retransmit+0xf8/0x10f [sctp]
     [<d0a3d183>] sctp_icmp_frag_needed+0x57/0x5b [sctp]
     [<d0a3ece2>] sctp_v6_err+0xcd/0x148 [sctp]
     [<d09cf1ce>] icmpv6_notify+0xe6/0x167 [ipv6]
     [<d09d009a>] icmpv6_rcv+0x7d7/0x849 [ipv6]
     [<d09be240>] ip6_input+0x1dc/0x310 [ipv6]
     [<d09be965>] ipv6_rcv+0x294/0x2df [ipv6]
     [<c05c3789>] netif_receive_skb+0x2d2/0x335
     [<c05c5733>] process_backlog+0x7f/0xd0
     [<c05c58f6>] net_rx_action+0x96/0x17e
     [<c042e722>] __do_softirq+0x64/0xcd
     [<c0406f37>] do_softirq+0x5c/0xac
     =======================
    Code: 00 00 29 ca 89 d0 2b 45 e0 89 55 ec 85 c0 7e 35 39 45 08 8b 55 e4 0f 4e 45 08 8b 75 e0 8b 7d dc 89 c1 c1 e9 02 03 b2 a0 00 00 00 <f3> a5 89 c1 83 e1 03 74 02 f3 a4 29 45 08 0f 84 7b 01 00 00 01
    EIP: [<c05be62a>] skb_copy_bits+0x4f/0x1ef SS:ESP 0068:c0759adc
    Kernel panic - not syncing: Fatal exception in interrupt
    
    Arnaldo says:
    ====================
    Thanks! I'm to blame for this one, problem was introduced in:
    
    b0e380b1d8a8e0aca215df97702f99815f05c094
    
                    /*
                     *      Copy a block of the IP datagram.
                     */
    -               if (skb_copy_bits(skb, ptr, frag->h.raw, len))
    +               if (skb_copy_bits(skb, ptr, skb_transport_header(skb),
    len))
                            BUG();
                    left -= len;
    ====================
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Signed-off-by: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit cb243a1a9fef4aaff262a5dd14f987070d37229b
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Aug 6 13:55:58 2007 +0800

    SCTP: Fix to handle invalid parameter length correctly
    
    If an INIT with invalid parameter length look like this:
    Parameter Type : 1
    Parameter Length: 800
    and not contain any payload, SCTP will ignore this  parameter and send
    back a INIT-ACK.
    This patch is fix to handle this invalid parameter length correctly.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 609ee4679b8a0831257552dd2b0e54f509ba0c77
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Aug 31 03:10:59 2007 +0900

    SCTP: Abort on COOKIE-ECHO if backlog is exceeded.
    
    Currently we abort on the INIT chunk we our backlog is currenlty
    exceeded.  Delay this about untill COOKIE-ECHO to give the user
    time to accept the socket.  Also, make sure that we treat
    sk_max_backlog of 0 as no connections allowed.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 498d63071ef378e201979e441aefcc6565702ca7
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Aug 30 14:03:58 2007 -0400

    SCTP: Correctly disable listening when backlog is 0.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit d0ce92910bc04e107b2f3f2048f07e94f570035d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Aug 24 19:37:46 2007 +0900

    SCTP: Do not retransmit chunks that are newer then rtt.
    
    When performing a retransmit, do not include the chunk if
    it was sent less then 1 rtt ago.  The reason is that we
    may receive the SACK very soon and wouldn't retransmit.
    Suggested by Randy Stewart.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit cc75689a4c4eb94b2fd7e3870347b9237ab39503
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Aug 24 19:30:25 2007 +0900

    SCTP: Uncomfirmed transports can't become Inactive
    
    Do not set Unconfirmed transports to Inactive state.  This may
    result in an inactive association being destroyed since we start
    counting errors on "inactive" transports against the association.
    This was found at the SCTP interop event.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 2772b495efe341a02c867bc3a03d7362bd336832
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Aug 21 14:24:30 2007 +0900

    SCTP: Pick the correct port when binding to 0.
    
    sctp_bindx() allows the use of unspecified port.  The problem is
    that every address we bind to ends up selecting a new port if
    the user specified port 0.  This patch allows re-use of the
    already selected port when the port from bindx was 0.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit d99fa42963a5ae394cf1df9d5bb739eb378a189b
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Aug 27 11:19:24 2007 +0800

    SCTP: Use net_ratelimit to suppress error messages print too fast
    
    When multi bundling SHUTDOWN-ACK message is received in ESTAB state,
    this will cause "sctp protocol violation state" message print many times.
    If SHUTDOWN-ACK is bundled 300 times in one packet, message will be
    print 300 times. The same problem also exists when received unexpected
    HEARTBEAT-ACK message which is bundled message times.
    
    This patch used net_ratelimit() to suppress error messages print too fast.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 00f1c2df2a1c4903f4daa1333bafeb6dcbc9591d
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Aug 21 15:50:01 2007 +0800

    SCTP: Fix to encode PROTOCOL VIOLATION error cause correctly
    
    PROTOCOL VIOLATION error cause in ABORT is bad encode when make abort
    chunk. When SCTP encode ABORT chunk with PROTOCOL VIOLATION error cause,
    it just add the error messages to PROTOCOL VIOLATION error cause, the
    rest four bytes(struct sctp_paramhdr) is just add to the chunk, not
    change the length of error cause. This cause the ABORT chunk to be a bad
    format. The chunk is like this:
    
    ABORT chunk
      Chunk type: ABORT (6)
      Chunk flags: 0x00
      Chunk length: 72 (*1)
      Protocol violation cause
        Cause code: Protocol violation (0x000d)
        Cause length: 62 (*2)
        Cause information: 5468652063756D756C61746976652074736E2061636B2062...
        Cause padding: 0000
    [Needless] 00030010
    Chunk Length(*1) = 72 but Cause length(*2) only 62, not include the
    extend 4 bytes.
    ((72 - sizeof(chunk_hdr)) = 68) != (62 +3) / 4 * 4
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 8d614ade511fef11f992d6a73e538d33b3b81f12
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Mon Aug 6 13:55:47 2007 +0800

    SCTP: Fix sctp_addto_chunk() to add pad with correct length
    
    At function sctp_addto_chunk(), it do pad before add payload to chunk if
    chunk length is not 4-byte alignment. But it do pad with a bad length.
    This patch fixed this probleam.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit ab3e5e7b65dde661f5eb86b445496c5967283333
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Aug 2 16:51:42 2007 -0400

    SCTP: Assign stream sequence numbers to the entire message
    
    Currently we only assign the sequence number to a packet that
    we are about to transmit.  This however breaks the Partial
    Reliability extensions, because it's possible for us to
    never transmit a packet, i.e. it expires before we get to send
    it.  In such cases, if the message contained multiple SCTP
    fragments, and we did manage to send the first part of the
    message, the Stream sequence numbers would get into invalid
    state and cause receiver to stall.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit ea2dfb3733d53ac98b17756435d1f99e25490357
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jul 13 17:01:19 2007 -0400

    SCTP: properly clean up fragment and ordering queues during FWD-TSN.
    
    When we recieve a FWD-TSN (meaning the peer has abandoned the data),
    we need to clean up any partially received messages that may be
    hanging out on the re-assembly or re-ordering queues.  This is
    a MUST requirement that was not properly done before.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com.>

commit 676834f0a9091c428c63f5116657bd9944c35918
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Jul 18 02:52:33 2007 -0700

    [PATCH] Fix ipv6 link down handling.
    
    [IPV6]: Call inet6addr_chain notifiers on link down
    
    Currently if the link is brought down via ip link or ifconfig down,
    the inet6addr_chain notifiers are not called even though all
    the addresses are removed from the interface.  This caused SCTP
    to add duplicate addresses to it's list.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 844aa7759d867d26c4a63610c0da2354e235d80a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Jul 18 02:44:12 2007 -0700

    [PATCH] SCTP scope_id handling fix
    
    SCTP: Add scope_id validation for link-local binds
    
    SCTP currently permits users to bind to link-local addresses,
    but doesn't verify that the scope id specified at bind matches
    the interface that the address is configured on.  It was report
    that this can hang a system.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Willy Tarreau <w@1wt.eu>

commit 13c926e04602db207366c7d213dd99d443ac4ad8
Merge: 53ce2dc2718c 22117ea4fef4
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Wed Aug 22 11:13:00 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IRDA] irda_nl_get_mode: always results in failure
      [PPP]: Fix output buffer size in ppp_decompress_frame().
      [IRDA]: Avoid a label defined but not used warning in irda_init()
      [IPV6]: Fix kernel panic while send SCTP data with IP fragments
      [SNAP]: Check packet length before reading
      [DCCP]: Allocation in atomic context

commit 8984e41d18a545320201950b8721e7ce3ac2a5e7
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Tue Aug 21 20:59:08 2007 -0700

    [IPV6]: Fix kernel panic while send SCTP data with IP fragments
    
    If ICMP6 message with "Packet Too Big" is received after send SCTP DATA,
    kernel panic will occur when SCTP DATA is send again.
    
    This is because of a bad dest address when call to skb_copy_bits().
    
    The messages sequence is like this:
    
    Endpoint A                             Endpoint B
                                   <-------  SCTP DATA (size=1432)
    ICMP6 message ------->
    (Packet Too Big pmtu=1280)
                                   <-------  Resend SCTP DATA (size=1432)
    ------------kernel panic---------------
    
     printing eip:
    c05be62a
    *pde = 00000000
    Oops: 0002 [#1]
    SMP
    Modules linked in: scomm l2cap bluetooth ipv6 dm_mirror dm_mod video output sbs battery lp floppy sg i2c_piix4 i2c_core pcnet32 mii button ac parport_pc parport ide_cd cdrom serio_raw mptspi mptscsih mptbase scsi_transport_spi sd_mod scsi_mod ext3 jbd ehci_hcd ohci_hcd uhci_hcd
    CPU:    0
    EIP:    0060:[<c05be62a>]    Not tainted VLI
    EFLAGS: 00010282   (2.6.23-rc2 #1)
    EIP is at skb_copy_bits+0x4f/0x1ef
    eax: 000004d0   ebx: ce12a980   ecx: 00000134   edx: cfd5a880
    esi: c8246858   edi: 00000000   ebp: c0759b14   esp: c0759adc
    ds: 007b   es: 007b   fs: 00d8  gs: 0000  ss: 0068
    Process swapper (pid: 0, ti=c0759000 task=c06d0340 task.ti=c0713000)
    Stack: c0759b88 c0405867 ce12a980 c8bff838 c789c084 00000000 00000028 cfd5a880
           d09f1890 000005dc 0000007b ce12a980 cfd5a880 c8bff838 c0759b88 d09bc521
           000004d0 fffff96c 00000200 00000100 c0759b50 cfd5a880 00000246 c0759bd4
    Call Trace:
     [<c0405e1d>] show_trace_log_lvl+0x1a/0x2f
     [<c0405ecd>] show_stack_log_lvl+0x9b/0xa3
     [<c040608d>] show_registers+0x1b8/0x289
     [<c0406271>] die+0x113/0x246
     [<c0625dbc>] do_page_fault+0x4ad/0x57e
     [<c0624642>] error_code+0x72/0x78
     [<d09bc521>] ip6_output+0x8e5/0xab2 [ipv6]
     [<d09bcec1>] ip6_xmit+0x2ea/0x3a3 [ipv6]
     [<d0a3f2ca>] sctp_v6_xmit+0x248/0x253 [sctp]
     [<d0a3c934>] sctp_packet_transmit+0x53f/0x5ae [sctp]
     [<d0a34bf8>] sctp_outq_flush+0x555/0x587 [sctp]
     [<d0a34d3c>] sctp_retransmit+0xf8/0x10f [sctp]
     [<d0a3d183>] sctp_icmp_frag_needed+0x57/0x5b [sctp]
     [<d0a3ece2>] sctp_v6_err+0xcd/0x148 [sctp]
     [<d09cf1ce>] icmpv6_notify+0xe6/0x167 [ipv6]
     [<d09d009a>] icmpv6_rcv+0x7d7/0x849 [ipv6]
     [<d09be240>] ip6_input+0x1dc/0x310 [ipv6]
     [<d09be965>] ipv6_rcv+0x294/0x2df [ipv6]
     [<c05c3789>] netif_receive_skb+0x2d2/0x335
     [<c05c5733>] process_backlog+0x7f/0xd0
     [<c05c58f6>] net_rx_action+0x96/0x17e
     [<c042e722>] __do_softirq+0x64/0xcd
     [<c0406f37>] do_softirq+0x5c/0xac
     =======================
    Code: 00 00 29 ca 89 d0 2b 45 e0 89 55 ec 85 c0 7e 35 39 45 08 8b 55 e4 0f 4e 45 08 8b 75 e0 8b 7d dc 89 c1 c1 e9 02 03 b2 a0 00 00 00 <f3> a5 89 c1 83 e1 03 74 02 f3 a4 29 45 08 0f 84 7b 01 00 00 01
    EIP: [<c05be62a>] skb_copy_bits+0x4f/0x1ef SS:ESP 0068:c0759adc
    Kernel panic - not syncing: Fatal exception in interrupt
    
    Arnaldo says:
    ====================
    Thanks! I'm to blame for this one, problem was introduced in:
    
    b0e380b1d8a8e0aca215df97702f99815f05c094
    
    @@ -761,7 +762,7 @@ slow_path:
                    /*
                     *      Copy a block of the IP datagram.
                     */
    -               if (skb_copy_bits(skb, ptr, frag->h.raw, len))
    +               if (skb_copy_bits(skb, ptr, skb_transport_header(skb),
    len))
                            BUG();
                    left -= len;
    ====================
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Acked-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Signed-off-by: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7e2d130b1da457858791d8f8b00b17c821db039f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Jul 18 02:52:33 2007 -0700

    Fix ipv6 link down handling.
    
    [IPV6]: Call inet6addr_chain notifiers on link down
    
    Currently if the link is brought down via ip link or ifconfig down,
    the inet6addr_chain notifiers are not called even though all
    the addresses are removed from the interface.  This caused SCTP
    to add duplicate addresses to it's list.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 9bff1948de46273efed6801db7e6b822b88b6f9a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Jul 18 02:44:12 2007 -0700

    SCTP scope_id handling fix
    
    SCTP: Add scope_id validation for link-local binds
    
    SCTP currently permits users to bind to link-local addresses,
    but doesn't verify that the scope id specified at bind matches
    the interface that the address is configured on.  It was report
    that this can hang a system.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit e1d7e7fcf8625857de6b48975096c127e5cb1534
Merge: 3ff42e4f1309 49ff4bb4cd4c
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Aug 3 14:57:41 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [TCP]: DSACK signals data receival, be conservative
      [TCP]: Also handle snd_una changes in tcp_cwnd_down
      [TIPC]: Fix two minor sparse warnings.
      [TIPC]: Make function tipc_nameseq_subscribe static.
      [PF_KEY]: Fix ipsec not working in 2.6.23-rc1-git10
      [TCP]: Invoke tcp_sendmsg() directly, do not use inet_sendmsg().
      [IPV4] route.c: mostly kmalloc + memset conversion to k[cz]alloc
      [IPV4] raw.c: kmalloc + memset conversion to kzalloc
      [NETFILTER] nf_conntrack_l3proto_ipv4_compat.c: kmalloc + memset conversion to kzalloc
      [NETFILTER] nf_conntrack_expect.c: kmalloc + memset conversion to kzalloc
      [NET]: Removal of duplicated include net/wanrouter/wanmain.c
      SCTP: remove useless code in function sctp_init_cause
      SCTP: drop SACK if ctsn is not less than the next tsn of assoc
      SCTP: IPv4 mapped addr not returned in SCTPv6 accept()
      SCTP: IPv4 mapped addr not returned in SCTPv6 accept()
      sctp: fix shadow symbol in net/sctp/tsnmap.c
      sctp: try to fix readlock
      sctp: remove shadowed symbols
      sctp: move global declaration to header file.
      sctp: make locally used function static

commit 5f8f1c3c87e44f1bd0180cf19d0e7c83d062b4dc
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Aug 2 17:02:29 2007 +0800

    SCTP: remove useless code in function sctp_init_cause
    
    Some code in function sctp_init_cause() seem useless, this patch remove
    them.
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit aecedeab6fcf914929cd8ff6fa0b8ae9bfdf3d30
Author: Wei Yongjun <yjwei@cn.fujitsu.com>
Date:   Thu Aug 2 16:57:44 2007 +0800

    SCTP: drop SACK if ctsn is not less than the next tsn of assoc
    
    We need to drop the SACK if the peer is attempting to acknowledge
    unset data, i.e.  the CTSN in the SACK is greater or equal to the
    next TSN we will send.
    
    Example:
    Endpoint A                                      Endpoint B
                                 <---------------   DATA (TSN=1)
    SACK(TSN=1) --------------->
                                 <---------------   DATA (TSN=2)
                                 <---------------   DATA (TSN=3)
                                 <---------------   DATA (TSN=4)
                                 <---------------   DATA (TSN=5)
    SACK(TSN=1000) --------------->
                                 <---------------   DATA (TSN=6)
                                 <---------------   DATA (TSN=7)
    
    Signed-off-by: Wei Yongjun <yjwei@cn.fujitsu.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit e4d1feab5df035312494ce3037ac5f041d0f5fc9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Aug 1 10:56:43 2007 -0400

    SCTP: IPv4 mapped addr not returned in SCTPv6 accept()
    
    When issuing a connect call on an AF_INET6 sctp socket with
    a IPv4-mapped destination, the peer address that is returned
    by getpeeraddr() should be v4-mapped as well.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit b225b884a18a1932db5414abd3ef94a45e4e348e
Author: Dave Johnson <djohnson+linux-kernel@sw.starentnetworks.com>
Date:   Wed Jul 25 19:49:29 2007 -0400

    SCTP: IPv4 mapped addr not returned in SCTPv6 accept()
    
    An accept() call on a SCTPv6 socket that returns due to connection of
    a IPv4 mapped peer will fill out the 'struct sockaddr' with a zero
    IPv6 address instead of the IPv4 mapped address of the peer.
    
    This is due to the v4mapped flag not getting copied into the new
    socket on accept() as well as a missing check for INET6 socket type in
    sctp_v4_to_sk_*addr().
    
    Signed-off-by: Dave Johnson <djohnson@sw.starentnetworks.com>
    Cc: Srinivas Akkipeddi <sakkiped@starentnetworks.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit c61a7d10efbd187ab9bb54871238ebd1dfcacd44
Author: Dave Johnson <djohnson@sw.starentnetworks.com>
Date:   Mon Jul 30 17:19:31 2007 -0700

    [IPV6]: ipv6_addr_type() doesn't know about RFC4193 addresses.
    
    ipv6_addr_type() doesn't check for 'Unique Local IPv6 Unicast
    Addresses' (RFC4193) and returns IPV6_ADDR_RESERVED for that range.
    
    SCTP uses this function and will fail bind() and connect() calls that
    use RFC4193 addresses, SCTP will also ignore inbound connections from
    RFC4193 addresses if listening on IPV6_ADDR_ANY.
    
    There may be other users of ipv6_addr_type() that could also have
    problems.
    
    Signed-off-by: Dave Johnson <djohnson@sw.starentnetworks.com>
    Acked-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c88fee3c266ce5147abf2f4efd9bed4249e122d4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Jul 22 18:24:56 2007 +0200

    SCTP: Add scope_id validation for link-local binds
    
    SCTP currently permits users to bind to link-local addresses,
    but doesn't verify that the scope id specified at bind matches
    the interface that the address is configured on.  It was report
    that this can hang a system.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit de3b9c4f8bb51494e57f8f938d96cdddb0ce76d4
Author: Patrick McHardy <kaber@trash.net>
Date:   Sun Jul 22 17:31:40 2007 +0200

    [NETFILTER]: {ip,nf}_conntrack_sctp: fix remotely triggerable NULL ptr dereference (CVE-2007-2876)
    
    When creating a new connection by sending an unknown chunk type, we don't
    transition to a valid state, causing a NULL pointer dereference in
    sctp_packet when accessing sctp_timeouts[SCTP_CONNTRACK_NONE].
    
    Fix by don't creating new conntrack entry if initial state is invalid.
    
    Noticed by Vilmos Nebehaj <vilmos.nebehaj@ramsys.hu>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit ce8c2293be47999584908069e78bf6d94beadc53
Merge: 41e9d344bf52 ee6a99b539a5
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu Jul 19 10:23:21 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (25 commits)
      [TG3]: Fix msi issue with kexec/kdump.
      [NET] XFRM: Fix whitespace errors.
      [NET] TIPC: Fix whitespace errors.
      [NET] SUNRPC: Fix whitespace errors.
      [NET] SCTP: Fix whitespace errors.
      [NET] RXRPC: Fix whitespace errors.
      [NET] ROSE: Fix whitespace errors.
      [NET] RFKILL: Fix whitespace errors.
      [NET] PACKET: Fix whitespace errors.
      [NET] NETROM: Fix whitespace errors.
      [NET] NETFILTER: Fix whitespace errors.
      [NET] IPV4: Fix whitespace errors.
      [NET] DCCP: Fix whitespace errors.
      [NET] CORE: Fix whitespace errors.
      [NET] BLUETOOTH: Fix whitespace errors.
      [NET] AX25: Fix whitespace errors.
      [PATCH] mac80211: remove rtnl locking in ieee80211_sta.c
      [PATCH] mac80211: fix GCC warning on 64bit platforms
      [GENETLINK]: Dynamic multicast groups.
      [NETLIKN]: Allow removing multicast groups.
      ...

commit 9cbcbf4e010ec253df686257f99c819da9b895da
Author: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
Date:   Thu Jul 19 10:44:50 2007 +0900

    [NET] SCTP: Fix whitespace errors.
    
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>

commit 063ed369c97f8de4cce23bf93bebd7ffacb542ff
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sun Jul 15 00:16:35 2007 -0700

    [IPV6]: Call inet6addr_chain notifiers on link down
    
    Currently if the link is brought down via ip link or ifconfig down,
    the inet6addr_chain notifiers are not called even though all
    the addresses are removed from the interface.  This caused SCTP
    to add duplicate addresses to it's list.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 370786f9cfd430cb424f00ce4110e75bb1b95a19
Author: Jan Engelhardt <jengelh@gmx.de>
Date:   Sat Jul 14 20:47:26 2007 -0700

    [NETFILTER]: x_tables: add connlimit match
    
    ipt_connlimit has been sitting in POM-NG for a long time.
    Here is a new shiny xt_connlimit with:
    
     * xtables'ified
     * will request the layer3 module
       (previously it hotdropped every packet when it was not loaded)
     * fixed: there was a deadlock in case of an OOM condition
     * support for any layer4 protocol (e.g. UDP/SCTP)
     * using jhash, as suggested by Eric Dumazet
     * ipv6 support
    
    Signed-off-by: Jan Engelhardt <jengelh@gmx.de>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 99d24edeb6abc6ca3a0d0fbdb83c664c04403c8c
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jul 10 23:24:52 2007 -0700

    [NETFILTER]: {ip, nf}_conntrack_sctp: fix remotely triggerable NULL ptr dereference (CVE-2007-2876)
    
    When creating a new connection by sending an unknown chunk type, we
    don't transition to a valid state, causing a NULL pointer dereference
    in sctp_packet when accessing sctp_timeouts[SCTP_CONNTRACK_NONE].
    
    Fix by don't creating new conntrack entry if initial state is invalid.
    
    Noticed by Vilmos Nebehaj <vilmos.nebehaj@ramsys.hu>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8b1d585987bbac55cde85650b47b8eaebce54e13
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jun 5 14:14:22 2007 +0200

    NETFILTER: {ip, nf}_conntrack_sctp: fix remotely triggerable NULL ptr dereference (CVE-2007-2876)
    
    When creating a new connection by sending an unknown chunk type, we
    don't transition to a valid state, causing a NULL pointer dereference in
    sctp_packet when accessing sctp_timeouts[SCTP_CONNTRACK_NONE].
    
    Fix by don't creating new conntrack entry if initial state is invalid.
    
    Noticed by Vilmos Nebehaj <vilmos.nebehaj@ramsys.hu>
    
    CC: Kiran Kumar Immidi <immidi_kiran@yahoo.com>
    Cc: David Miller <davem@davemloft.net>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 1feb17e286339382a1ae36e0fecc4d88c2d7f123
Merge: dadde13ad86b 25442cafb8cc
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Jul 6 10:30:12 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [NETPOLL]: Fixups for 'fix soft lockup when removing module'
      [NET]: net/core/netevent.c should #include <net/netevent.h>
      [NETFILTER]: nf_conntrack_h323: add checking of out-of-range on choices' index values
      [NET] skbuff: remove export of static symbol
      SCTP: Add scope_id validation for link-local binds
      SCTP: Check to make sure file is valid before setting timeout
      SCTP: Fix thinko in sctp_copy_laddrs()

commit 1669d857a25d62c6d0a6d9216e01c21287a7c844
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jul 3 14:29:23 2007 -0400

    SCTP: Add scope_id validation for link-local binds
    
    SCTP currently permits users to bind to link-local addresses,
    but doesn't verify that the scope id specified at bind matches
    the interface that the address is configured on.  It was report
    that this can hang a system.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f50f95cab735ebe2993e8d1549f0615bad05f3f2
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jul 3 12:47:40 2007 -0400

    SCTP: Check to make sure file is valid before setting timeout
    
    In-kernel sockets created with sock_create_kern don't usually
    have a file and file descriptor allocated to them.  As a result,
    when SCTP tries to check the non-blocking flag, we Oops when
    dereferencing a NULL file pointer.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3663c306609a9322a484fba28b3da66142c50ee9
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jul 3 12:43:12 2007 -0400

    SCTP: Fix thinko in sctp_copy_laddrs()
    
    Correctly dereference bytes_copied in sctp_copy_laddrs().
    I totally must have spaced when doing this.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2d408b42ed0a287c64a94b48e24c6bfa95035019
Merge: fde937d826e4 5f0212174db3
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri Jun 29 21:29:57 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IRDA]: fix printk format
      [NETPOLL] netconsole: fix soft lockup when removing module
      [NETPOLL]: tx lock deadlock fix
      SCTP: lock_sock_nested in sctp_sock_migrate
      SCTP: Fix sctp_getsockopt_get_peer_addrs
      SCTP: update sctp_getsockopt helpers to allow oversized buffers

commit 5131a184a3458d9ac47d9eba032cf4c4d3295afd
Author: Zach Brown <zach.brown@oracle.com>
Date:   Fri Jun 22 15:14:46 2007 -0700

    SCTP: lock_sock_nested in sctp_sock_migrate
    
    sctp_sock_migrate() grabs the socket lock on a newly allocated socket while
    holding the socket lock on an old socket.  lockdep worries that this might
    be a recursive lock attempt.
    
     task/3026 is trying to acquire lock:
      (sk_lock-AF_INET){--..}, at: [<ffffffff88105b8c>] sctp_sock_migrate+0x2e3/0x327 [sctp]
     but task is already holding lock:
      (sk_lock-AF_INET){--..}, at: [<ffffffff8810891f>] sctp_accept+0xdf/0x1e3 [sctp]
    
    This patch tells lockdep that this locking is safe by using
    lock_sock_nested().
    
    Signed-off-by: Zach Brown <zach.brown@oracle.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 186e234358ba29a4094d0c8c0d3ea00f84d32a3e
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Jun 18 19:59:16 2007 -0400

    SCTP: Fix sctp_getsockopt_get_peer_addrs
    
            This is the split out of the patch that we agreed I should split
    out from my last patch.  It changes space_left to be computed in the same
    way the to variable is.  I know we talked about changing space_left to an
    int, but I think size_t is more appropriate, since we should never have
    negative space in our buffer, and computing using offsetof means space_left
    should now never drop below zero.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 408f22e81ea2fcf96c80e85ee12d20ef5148bf7c
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Sat Jun 16 14:03:45 2007 -0400

    SCTP: update sctp_getsockopt helpers to allow oversized buffers
    
            I noted the other day while looking at a bug that was ostensibly
    in some perl networking library, that we strictly avoid allowing getsockopt
    operations to complete if we pass in oversized buffers.  This seems to make
    libraries like Perl::NET malfunction since it seems to allocate oversized
    buffers for use in several operations.  It also seems to be out of line with
    the way udp, tcp and ip getsockopt routines handle buffer input (since the
    *optlen pointer in both an input and an output and gets set to the length
    of the data that we copy into the buffer).  This patch brings our getsockopt
    helpers into line with other protocols, and allows us to accept oversized
    buffers for our getsockopt operations.  Tested by me with good results.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 1e0e76cf1376a0a1b49a23396e945456c329814e
Merge: f701737deb59 559f0a2857f1
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu Jun 14 15:08:50 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IPV6] addrconf: Fix IPv6 on tuntap tunnels
      [TCP]: Add missing break to TCP option parsing code
      [SCTP] Don't disable PMTU discovery when mtu is small
      [SCTP] Flag a pmtu change request
      [SCTP] Update pmtu handling to be similar to tcp
      [SCTP] Fix leak in sctp_getsockopt_local_addrs when copy_to_user fails
      [SCTP]: Allow unspecified port in sctp_bindx()
      [SCTP]: Correctly set daddr for IPv6 sockets during peeloff
      [TCP]: Set initial_ssthresh default to zero in Cubic and BIC.
      [TCP]: Fix left_out setting during FRTO
      [TCP]: Disable TSO if MD5SIG is enabled.
      [PPP_MPPE]: Fix "osize too small" check.
      [PATCH] mac80211: Don't stop tx queue on master device while scanning.
      [PATCH] mac80211: fix debugfs tx power reduction output
      [PATCH] cfg80211: fix signed macaddress in sysfs
      [IrDA]: f-timer reloading when sending rejected frames.
      [IrDA]: Fix Rx/Tx path race.

commit 06ad391919b2078ec2e012f0593014b88e7a6c4e
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jun 12 15:26:22 2007 -0400

    [SCTP] Don't disable PMTU discovery when mtu is small
    
    Right now, when we receive a mtu estimate smaller then minim
    threshold in the ICMP message, we disable the path mtu discovery
    on the transport.  This leads to the never increasing sctp fragmentation
    point even when the real path mtu has increased.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 8a4794914f9cf2681235ec2311e189fe307c28c7
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Jun 7 14:21:05 2007 -0400

    [SCTP] Flag a pmtu change request
    
    Currently, if the socket is owned by the user, we drop the ICMP
    message.  As a result SCTP forgets that path MTU changed and
    never adjusting it's estimate.  This causes all subsequent
    packets to be fragmented.  With this patch, we'll flag the association
    that it needs to udpate it's estimate based on the already updated
    routing information.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>

commit c910b47e1811b3f8b184108c48de3d7af3e2999b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Jun 7 13:47:03 2007 -0400

    [SCTP] Update pmtu handling to be similar to tcp
    
    Introduce new function sctp_transport_update_pmtu that updates
    the transports and destination caches view of the path mtu.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>

commit fe979ac169970b3d12facd6565766735862395c5
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 23 11:11:37 2007 -0400

    [SCTP] Fix leak in sctp_getsockopt_local_addrs when copy_to_user fails
    
    If the copy_to_user or copy_user calls fail in sctp_getsockopt_local_addrs(),
    the function should free locally allocated storage before returning error.
    Spotted by Coverity.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>

commit 8b35805693e1915829355723537f99f1b8bc9cc0
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue May 15 17:14:58 2007 -0400

    [SCTP]: Allow unspecified port in sctp_bindx()
    
    Allow sctp_bindx() to accept multiple address with
    unspecified port.  In this case, all addresses inherit
    the first bound port.  We still catch full mis-matches.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>

commit d570ee490fb18220262cfe41284d7aede797ed4f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue May 15 16:32:39 2007 -0400

    [SCTP]: Correctly set daddr for IPv6 sockets during peeloff
    
    During peeloff of AF_INET6 socket, the inet6_sk(sk)->daddr
    wasn't set correctly since the code was assuming IPv4 only.
    Now we use a correct call to set the destination address.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>

commit 8c640bd0c68201dd0d71b78a07bb224973580ad3
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jun 5 14:14:22 2007 +0200

    [PATCH] NETFILTER: {ip, nf}_conntrack_sctp: fix remotely triggerable NULL ptr dereference (CVE-2007-2876)
    
    When creating a new connection by sending an unknown chunk type, we
    don't transition to a valid state, causing a NULL pointer dereference in
    sctp_packet when accessing sctp_timeouts[SCTP_CONNTRACK_NONE].
    
    Fix by don't creating new conntrack entry if initial state is invalid.
    
    Noticed by Vilmos Nebehaj <vilmos.nebehaj@ramsys.hu>
    
    CC: Kiran Kumar Immidi <immidi_kiran@yahoo.com>
    Cc: David Miller <davem@davemloft.net>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 13ad357c616a85828fa224c0876a393d1dd6f59f
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jun 5 14:14:22 2007 +0200

    [PATCH] NETFILTER: {ip, nf}_conntrack_sctp: fix remotely triggerable NULL ptr dereference (CVE-2007-2876)
    
    When creating a new connection by sending an unknown chunk type, we
    don't transition to a valid state, causing a NULL pointer dereference in
    sctp_packet when accessing sctp_timeouts[SCTP_CONNTRACK_NONE].
    
    Fix by don't creating new conntrack entry if initial state is invalid.
    
    Noticed by Vilmos Nebehaj <vilmos.nebehaj@ramsys.hu>
    
    CC: Kiran Kumar Immidi <immidi_kiran@yahoo.com>
    Cc: David Miller <davem@davemloft.net>
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 1c1ee4c3e7e16d23166a624a132889df3c540a18
Merge: 91396c1e2d73 14e50e57aedb
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu May 24 18:41:28 2007 -0700

    Merge branch 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * 'master' of master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (25 commits)
      [XFRM]: Allow packet drops during larval state resolution.
      [CASSINI]: Check pci_set_mwi() return value.
      [NET]: "wrong timeout value" in sk_wait_data() v2
      [NETFILTER]: nf_nat_h323: call set_h225_addr instead of set_h225_addr_hook
      [NETFILTER]: nf_conntrack_h323: add missing T.120 address in OLCA
      [NETFILTER]: nf_conntrack_h323: remove unnecessary process of Information signal
      [NETFILTER]: nf_conntrack_h323: fix get_h225_addr() for IPv6 address access
      [NETFILTER]: nf_conntrack_h323: fix ASN.1 types
      [NETFILTER]: nf_conntrack_ftp: fix newline sequence number calculation
      [NETFILTER]: nf_conntrack_ftp: fix newline sequence number update
      [NET_SCHED]: sch_htb: fix event cache time calculation
      [DCCP]: Fix build warning when debugging is disabled.
      [TIPC]: Fixed erroneous introduction of for_each_netdev
      [RTNETLINK]: Fix sending netlink message when replace route.
      [TR]: Use menuconfig objects.
      [ARCNET]: Use menuconfig objects.
      [TIPC]: Use menuconfig objects.
      [SCTP]: Use menuconfig objects.
      [IPVS]: Use menuconfig objects.
      [DCCP]: Use menuconfig objects.
      ...

commit 29e32ccdec8574aa5b6e0b6b555815dbb62591e1
Author: Jan Engelhardt <jengelh@gmx.de>
Date:   Wed May 23 14:48:57 2007 -0700

    [SCTP]: Use menuconfig objects.
    
    Use menuconfigs instead of menus, so the whole menu can be disabled at
    once instead of going through all options.
    
    Signed-off-by: Jan Engelhardt <jengelh@gmx.de>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ca526a57325f6ea331115069c44a58c4a85bfa9d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue May 15 01:32:35 2007 -0700

    [PATCH] SCTP: Prevent OOPS if hmac modules didn't load
    
    SCTP was checking for NULL when trying to detect hmac
    allocation failure where it should have been using IS_ERR.
    Also, print a rate limited warning to the log telling the
    user what happend.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 44884f81d150fe352ca4c6d694ad11cd5acf7fea
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 9 13:51:31 2007 -0700

    [PATCH] SCTP: Correctly copy addresses in sctp_copy_laddrs
    
    I broke the  non-wildcard case recently.  This is to fixes it.
    Now, explictitly bound addresses can ge retrieved using the API.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit fbae8ffe8398d38ed2fcd18a8c0376cb726642ff
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 9 01:31:28 2007 -0700

    [PATCH] SCTP: Fix sctp_getsockopt_local_addrs_old() to use local storage.
    
    sctp_getsockopt_local_addrs_old() in net/sctp/socket.c calls
    copy_to_user() while the spinlock addr_lock is held. this should not
    be done as copy_to_user() might sleep. the call to
    sctp_copy_laddrs_to_user() while holding the lock is also problematic
    as it calls copy_to_user()
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit ee54d2d87a8158d14434c1a3274bd7f713105836
Merge: bf61f8d357e5 da0dd231436b
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri May 11 09:10:19 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (31 commits)
      [NETFILTER]: xt_conntrack: add compat support
      [NETFILTER]: iptable_raw: ignore short packets sent by SOCK_RAW sockets
      [NETFILTER]: iptable_{filter,mangle}: more descriptive "happy cracking" message
      [NETFILTER]: nf_nat: Clears helper private area when NATing
      [NETFILTER]: ctnetlink: clear helper area and handle unchanged helper
      [NETFILTER]: nf_conntrack: Removes unused destroy operation of l3proto
      [NETFILTER]: nf_conntrack: Removes duplicated declarations
      [NETFILTER]: nf_nat: remove unused argument of function allocating binding
      [NETFILTER]: Clean up table initialization
      [NET_SCHED]: Avoid requeue warning on dev_deactivate
      [NET_SCHED]: Reread dev->qdisc for NETDEV_TX_OK
      [NET_SCHED]: Rationalise return value of qdisc_restart
      [NET]: Fix dev->qdisc race for NETDEV_TX_LOCKED case
      [UDP]: Fix AF-specific references in AF-agnostic code.
      [IrDA]: KingSun/DonShine USB IrDA dongle support.
      [IPV6] ROUTE: Assign rt6i_idev for ip6_{prohibit,blk_hole}_entry.
      [IPV6]: Do no rely on skb->dst before it is assigned.
      [IPV6]: Send ICMPv6 error on scope violations.
      [SCTP]: Do not include ABORT chunk header in the notification.
      [SCTP]: Correctly copy addresses in sctp_copy_laddrs
      ...

commit ac40e41f4ddec8882d3f7bc8fa98a4fce8796aff
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 9 13:52:35 2007 -0700

    [SCTP]: Do not include ABORT chunk header in the notification.
    
    The socket API draft is unclear about whether to include the
    chunk header or not.  Recent discussion on the sctp implementors
    mailing list clarified that the chunk header shouldn't be included,
    but the error parameter header still needs to be there.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 70b57b814ed5a93bf21d9dc5f8a7d23620a77e44
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 9 13:51:31 2007 -0700

    [SCTP]: Correctly copy addresses in sctp_copy_laddrs
    
    I broke the  non-wildcard case recently.  This is to fixes it.
    Now, explictitly bound addresses can ge retrieved using the API.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8dc4984a6bdcaf56cdb458a7338c32c16f32540c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed May 9 13:50:20 2007 -0700

    [SCTP]: Prevent OOPS if hmac modules didn't load
    
    SCTP was checking for NULL when trying to detect hmac
    allocation failure where it should have been using IS_ERR.
    Also, print a rate limited warning to the log telling the
    user what happend.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7e20ef030dde0e52dd5a57220ee82fa9facbea4e
Merge: a3d52136ee8f 07d939677166
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Fri May 4 19:36:58 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (49 commits)
      [SCTP]: Set assoc_id correctly during INIT collision.
      [SCTP]: Re-order SCTP initializations to avoid race with sctp_rcv()
      [SCTP]: Fix the SO_REUSEADDR handling to be similar to TCP.
      [SCTP]: Verify all destination ports in sctp_connectx.
      [XFRM] SPD info TLV aggregation
      [XFRM] SAD info TLV aggregationx
      [AF_RXRPC]: Sort out MTU handling.
      [AF_IUCV/IUCV] : Add missing section annotations
      [AF_IUCV]: Implementation of a skb backlog queue
      [NETLINK]: Remove bogus BUG_ON
      [IPV6]: Some cleanups in include/net/ipv6.h
      [TCP]: zero out rx_opt in tcp_disconnect()
      [BNX2]: Fix TSO problem with small MSS.
      [NET]: Rework dev_base via list_head (v3)
      [TCP] Highspeed: Limited slow-start is nowadays in tcp_slow_start
      [BNX2]: Update version and reldate.
      [BNX2]: Print bus information for PCIE devices.
      [BNX2]: Add 1-shot MSI handler for 5709.
      [BNX2]: Restructure PHY event handling.
      [BNX2]: Add indirect spinlock.
      ...

commit 07d939677166cc4f000c767196872a9becc2697b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 4 13:55:27 2007 -0700

    [SCTP]: Set assoc_id correctly during INIT collision.
    
    During the INIT/COOKIE-ACK collision cases, it's possible to get
    into a situation where the association id is not yet set at the time
    of the user event generation.  As a result, user events have an
    association id set to 0 which will confuse applications.
    
    This happens if we hit case B of duplicate cookie processing.
    In the particular example found and provided by Oscar Isaula
    <Oscar.Isaula@motorola.com>, flow looks like this:
    A                               B
    ---- INIT------->  (lost)
                <---------INIT------
    ---- INIT-ACK--->
                <------ Cookie ECHO
    
    When the Cookie Echo is received, we end up trying to update the
    association that was created on A as a result of the (lost) INIT,
    but that association doesn't have the ID set yet.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 827bf12236fbafc02bc899aec1b37c342c8cf4e5
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 4 13:36:30 2007 -0700

    [SCTP]: Re-order SCTP initializations to avoid race with sctp_rcv()
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ce5325c1338acf965f4300f4976eac2129aeb439
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 4 13:34:49 2007 -0700

    [SCTP]: Fix the SO_REUSEADDR handling to be similar to TCP.
    
    Update the SO_REUSEADDR handling to also check for listen state.  This
    was muliple listening server sockets can't be created and they will
    not steal packets from each other.
    
    Reported by Paolo Galtieri <pgaltieri@mvista.com>
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 16d00fb7765a43a1b05989062e985d283b3a1f2d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 4 13:34:09 2007 -0700

    [SCTP]: Verify all destination ports in sctp_connectx.
    
    We need to make sure that all destination ports are the same, since
    the association really must not connect to multiple different ports
    at once.  This was reported on the sctp-impl list.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6ed7257b46709e87d79ac2b6b819b7e0c9184998
Author: Patrick Caulfield <pcaulfie@redhat.com>
Date:   Tue Apr 17 15:39:57 2007 +0100

    [DLM] Consolidate transport protocols
    
    This patch consolidates the TCP & SCTP protocols for the DLM into a single file
    and makes it switchable at run-time (well, at least before the DLM actually
    starts up!)
    
    For RHEL5 this patch requires Neil Horman's patch that expands the in-kernel
    socket API but that has already been twice ACKed so it should be OK.
    
    The patch adds a new lowcomms.c file that replaces the existing lowcomms-sctp.c
    & lowcomms-tcp.c files.
    
    Signed-off-By: Patrick Caulfield <pcaulfie@redhat.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>

commit 152a6a9da1bd3ed5dcbbf6ff17c7ebde0eb9a754
Merge: cd9bb7e7367c 80787ebc2bbd
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Mon Apr 30 08:14:42 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (21 commits)
      [IPV4] SNMP: Support OutMcastPkts and OutBcastPkts
      [IPV4] SNMP: Support InMcastPkts and InBcastPkts
      [IPV4] SNMP: Support InTruncatedPkts
      [IPV4] SNMP: Support InNoRoutes
      [SNMP]: Add definitions for {In,Out}BcastPkts
      [TCP] FRTO: RFC4138 allows Nagle override when new data must be sent
      [TCP] FRTO: Delay skb available check until it's mandatory
      [XFRM]: Restrict upper layer information by bundle.
      [TCP]: Catch skb with S+L bugs earlier
      [PATCH] INET : IPV4 UDP lookups converted to a 2 pass algo
      [L2TP]: Add the ability to autoload a pppox protocol module.
      [SKB]: Introduce skb_queue_walk_safe()
      [AF_IUCV/IUCV]: smp_call_function deadlock
      [IPV6]: Fix slab corruption running ip6sic
      [TCP]: Update references in two old comments
      [XFRM]: Export SPD info
      [IPV6]: Track device renames in snmp6.
      [SCTP]: Fix sctp_getsockopt_local_addrs_old() to use local storage.
      [NET]: Remove NETIF_F_INTERNAL_STATS, default to internal stats.
      [NETPOLL]: Remove CONFIG_NETPOLL_RX
      ...

commit aad97f38b71dd2ecd730b3a3dce8264d13fbcd56
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Apr 28 21:09:04 2007 -0700

    [SCTP]: Fix sctp_getsockopt_local_addrs_old() to use local storage.
    
    sctp_getsockopt_local_addrs_old() in net/sctp/socket.c calls
    copy_to_user() while the spinlock addr_lock is held. this should not
    be done as copy_to_user() might sleep. the call to
    sctp_copy_laddrs_to_user() while holding the lock is also problematic
    as it calls copy_to_user()
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 703315712cfccfe0b45ef4aa6994527d8ee95e33
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Mar 23 11:34:36 2007 -0700

    [SCTP]: Implement SCTP_MAX_BURST socket option.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a5a35e76753d27e782028843a5186f176b50dd16
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Mar 23 11:34:08 2007 -0700

    [SCTP]: Implement sac_info field in SCTP_ASSOC_CHANGE notification.
    
    As stated in the sctp socket api draft:
    
       sac_info: variable
    
       If the sac_state is SCTP_COMM_LOST and an ABORT chunk was received
       for this association, sac_info[] contains the complete ABORT chunk as
       defined in the SCTP specification RFC2960 [RFC2960] section 3.3.7.
    
    We now save received ABORT chunks into the sac_info field and pass that
    to the user.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bdf3092af601ccad765974652ab103162fbe14f4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Mar 23 11:33:12 2007 -0700

    [SCTP]: Honor flags when setting peer address parameters
    
    Parameters only take effect when a corresponding flag bit is set
    and a value is specified. This means we need to check the flags
    in addition to checking for non-zero value.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1ae4114dce35dd1d32ed847f60b599dbbdfd5829
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Mar 23 11:32:26 2007 -0700

    [SCTP]: Implement SCTP_ADDR_CONFIRMED state for ADDR_CHNAGE event
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d49d91d79a8dc5e85108a5ae1c8eef23dec135c1
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Mar 23 11:32:00 2007 -0700

    [SCTP]: Implement SCTP_PARTIAL_DELIVERY_POINT option.
    
    This option induces partial delivery to run as soon
    as the specified amount of data has been accumulated on
    the association.  However, we give preference to fully
    reassembled messages over PD messages.  In any case,
    window and buffer is freed up.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@.hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b6e1331f3ce25a56edb956054eaf8011654686cb
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Apr 20 12:23:15 2007 -0700

    [SCTP]: Implement SCTP_FRAGMENT_INTERLEAVE socket option
    
    This option was introduced in draft-ietf-tsvwg-sctpsocket-13.  It
    prevents head-of-line blocking in the case of one-to-many endpoint.
    Applications enabling this option really must enable SCTP_SNDRCV event
    so that they would know where the data belongs.  Based on an
    earlier patch by Ivan Skytte Jrgensen.
    
    Additionally, this functionality now permits multiple associations
    on the same endpoint to enter Partial Delivery.  Applications should
    be extra careful, when using this functionality, to track EOR indicators.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a27ef749e7be3b06fb58df53d94eb97a21f18707
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Tue Mar 13 17:17:10 2007 -0300

    [SCTP]: Eliminate some pointer attributions to the skb layer headers
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2c0fd387b00a6758550b5ca1aae4408374483fe7
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Tue Mar 13 13:59:32 2007 -0300

    [SCTP]: Introduce sctp_hdr()
    
    For consistency with all the other skb->h.raw accessors.
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d0cf0d9940ef27b46fcbbd9e0cc8427c30fe05eb
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Apr 18 14:11:06 2007 -0700

    [SCTP]: Do not interleave non-fragments when in partial delivery
    
    The way partial delivery is currently implemnted, it is possible to
    intereleave a message (either from another steram, or unordered) that
    is not part of partial delivery process.  The only way to this is for
    a message to not be a fragment and be 'in order' or unorderd for a
    given stream.  This will result in bypassing the reassembly/ordering
    queues where things live duing partial delivery, and the
    message will be delivered to the socket in the middle of partial delivery.
    
    This is a two-fold problem, in that:
    1.  the app now must check the stream-id and flags which it may not
    be doing.
    2.  this clearing partial delivery state from the association and results
    in ulp hanging.
    
    This patch is a band-aid over a much bigger problem in that we
    don't do stream interleave.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 80d74d5123bf3aecd32302809c4e61bb8a16786b
Merge: 245d95a42366 19bb3506e270
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Tue Apr 17 16:51:32 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [BRIDGE]: Unaligned access when comparing ethernet addresses
      [SCTP]: Unmap v4mapped addresses during SCTP_BINDX_REM_ADDR operation.
      [SCTP]: Fix assertion (!atomic_read(&sk->sk_rmem_alloc)) failed message
      [NET]: Set a separate lockdep class for neighbour table's proxy_queue
      [NET]: Fix UDP checksum issue in net poll mode.
      [KEY]: Fix conversion between IPSEC_MODE_xxx and XFRM_MODE_xxx.
      [NET]: Get rid of alloc_skb_from_cache

commit 0304ff8a2d5f57defb011c7f261b4c1b3eff96d1
Author: Paolo Galtieri <pgaltieri@mvista.com>
Date:   Tue Apr 17 12:52:36 2007 -0700

    [SCTP]: Unmap v4mapped addresses during SCTP_BINDX_REM_ADDR operation.
    
    During the sctp_bindx() call to add additional addresses to the
    endpoint, any v4mapped addresses are converted and stored as regular
    v4 addresses.  However, when trying to remove these addresses, the
    v4mapped addresses are not converted and the operation fails.  This
    patch unmaps the addresses on during the remove operation as well.
    
    Signed-off-by: Paolo Galtieri <pgaltieri@mvista.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ea2bc483ff5caada7c4aa0d5fbf87d3a6590273d
Author: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
Date:   Tue Apr 17 12:49:53 2007 -0700

    [SCTP]: Fix assertion (!atomic_read(&sk->sk_rmem_alloc)) failed message
    
    In current implementation, LKSCTP does receive buffer accounting for
    data in sctp_receive_queue and pd_lobby. However, LKSCTP don't do
    accounting for data in frag_list when data is fragmented. In addition,
    LKSCTP doesn't do accounting for data in reasm and lobby queue in
    structure sctp_ulpq.
    When there are date in these queue, assertion failed message is printed
    in inet_sock_destruct because sk_rmem_alloc of oldsk does not become 0
    when socket is destroyed.
    
    Signed-off-by: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 703071b5b93d88d5acb0edd5b9dd86c69ad970f2
Merge: 6288c338661c 09c72ec8ed8f
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Mon Mar 26 14:51:24 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [SUNGEM]: Fix MAC address setting when interface is up.
      [IPV4] fib_trie: Document locking.
      [NET]: Correct accept(2) recovery after sock_attach_fd()
      [PPP]: Don't leak an sk_buff on interface destruction.
      [NET_SCHED]: Fix ingress locking
      [NET_SCHED]: cls_basic: fix NULL pointer dereference
      [DCCP]: make dccp_write_xmit_timer() static again
      [TG3]: Update version and reldate.
      [TG3]: Exit irq handler during chip reset.
      [TG3]: Eliminate the unused TG3_FLAG_SPLIT_MODE flag.
      [IPV6]: Fix routing round-robin locking.
      [DECNet] fib: Fix out of bound access of dn_fib_props[]
      [IPv4] fib: Fix out of bound access of fib_props[]
      [NET] AX.25 Kconfig and docs updates and fixes
      [NET]: Fix neighbour destructor handling.
      [NET]: Fix fib_rules compatibility breakage
      [SCTP]: Update SCTP Maintainers entry
      [NET]: remove unused header file: drivers/net/wan/lmc/lmc_media.h

commit 5f85813c33ddbf6d11ccfdbcc01f176e24a76bd2
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Mar 23 11:39:51 2007 -0700

    [SCTP]: Update SCTP Maintainers entry
    
    Add Vlad Yasevich as the primary maintainer of SCTP and add a
    link to the project website.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d6e8823e7bf423c6850c68f716d2f5f693c97447
Merge: f64cd9de37bf 848c29fd648e
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu Mar 22 19:34:09 2007 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [NETFILTER]: nat: avoid rerouting packets if only XFRM policy key changed
      [NETFILTER]: nf_conntrack_netlink: add missing dependency on NF_NAT
      [NET]: fix up misplaced inlines.
      [SCTP]: Correctly reset ssthresh when restarting association
      [BRIDGE]: Fix fdb RCU race
      [NET]: Fix fib_rules dump race
      [XFRM]: ipsecv6 needs a space when printing audit record.
      [X25] x25_forward_call(): fix NULL dereferences
      [SCTP]: Reset some transport and association variables on restart
      [SCTP]: Increment error counters on user requested HBs.
      [SCTP]: Clean up stale data during association restart
      [IrDA]: Calling ppp_unregister_channel() from process context
      [IrDA]: irttp_dup spin_lock initialisation
      [IrDA]: Delay needed when uploading firmware chunks

commit 289f42492c0958871b6045050474c752ec99704f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Mar 22 12:26:25 2007 -0700

    [SCTP]: Correctly reset ssthresh when restarting association
    
    Reset ssthresh to the correct value (peer's a_rwnd) when restarting
    association.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 749bf9215ed1a8b6edb4bb03693c2b62c6b9c2a4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Mar 19 17:02:30 2007 -0700

    [SCTP]: Reset some transport and association variables on restart
    
    If the association has been restarted, we need to reset the
    transport congestion variables as well as accumulated error
    counts and CACC variables.  If we do not, the association
    will use the wrong values and may terminate prematurely.
    
    This was found with a scenario where the peer restarted
    the association when lksctp was in the last HB timeout for
    its association.  The restart happened, but the error counts
    have not been reset and when the timeout occurred, a newly
    restarted association was terminated due to excessive
    retransmits.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fb78525ae1b75bfac1da600ceb008aef4d293649
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Mar 19 17:02:03 2007 -0700

    [SCTP]: Increment error counters on user requested HBs.
    
    2960bis states (Section 8.3):
    
       D) Request an on-demand HEARTBEAT on a specific destination transport
          address of a given association.
    
       The endpoint should increment the respective error counter of the
       destination transport address each time a HEARTBEAT is sent to that
       address and not acknowledged within one RTO.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0b58a811461ccf3cf848aba4cc192538fd3b0516
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Mar 19 17:01:17 2007 -0700

    [SCTP]: Clean up stale data during association restart
    
    During association restart we may have stale data sitting
    on the ULP queue waiting for ordering or reassembly.  This
    data may cause severe problems if not cleaned up.  In particular
    stale data pending ordering may cause problems with receive
    window exhaustion if our peer has decided to restart the
    association.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c5bfdb7261f2c426c730b65ce59440e8de219fda
Merge: 2ef550790ac0 e2eb8d452827
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Thu Mar 8 15:09:57 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [SCTP] ipv6: inconsistent lock state ipv6_add_addr/sctp_v6_copy_addrlist

commit e2eb8d452827b8d1f73db384cd7c6482eac29478
Author: Jarek Poplawski <jarkao2@o2.pl>
Date:   Thu Mar 8 14:43:41 2007 -0800

    [SCTP] ipv6: inconsistent lock state ipv6_add_addr/sctp_v6_copy_addrlist
    
    lockdep found that dev->lock taken from softirq in ipv6_add_addr
    is also taken in sctp_v6_copy_addrlist with softirqs enabled, so
    lockup is possible.
    
    Noticed-by: Simon Arlott <simon@arlott.org>
    Signed-off-by: Jarek Poplawski <jarkao2@o2.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5d5dde2ed928677028ef859f48a32a503b01c636
Merge: dafdcfba62f7 aef8811abbc9
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Mon Feb 26 12:23:08 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (25 commits)
      [XFRM]: Fix oops in xfrm4_dst_destroy()
      [XFRM_TUNNEL]: Reload header pointer after pskb_may_pull/pskb_expand_head
      [IPV4]: Use random32() in net/ipv4/multipath
      [BRIDGE]: eliminate workqueue for carrier check
      [BRIDGE]: get rid of miscdevice include
      [IPV6]: Fix __ipv6_addr_type() export in correct place.
      [IPV4] devinet: Register inetdev earlier.
      [IPV6] ADDRCONF: Register inet6_dev earlier.
      [IPV6] ADDRCONF: Manage prefix route corresponding to address manually added.
      [IPV6] IP6TUNNEL: Use update_pmtu() of dst on xmit.
      [IPV6] ADDRCONF: Statically link __ipv6_addr_type() for sunrpc subsystem.
      [IPV4]: Correct links in net/ipv4/Kconfig
      [SCTP]: Strike the transport before updating rto.
      [SCTP]: Fix connection hang/slowdown with PR-SCTP
      [TCP]: Fix MD5 signature pool locking.
      [TG3]: TSO workaround fixes.
      [AF_PACKET]: Remove unnecessary casts.
      [IPV6]: Adjust inet6_exit() cleanup sequence against inet6_init()
      [IPSEC]: More fix is needed for __xfrm6_bundle_create().
      [IRDA] net/irda/: proper prototypes
      ...

commit 1845a579e0c3084a822fbe610f7cfd1b0e0396ac
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Feb 21 02:06:19 2007 -0800

    [SCTP]: Strike the transport before updating rto.
    
    Once we reach a point where we exceed the max.path.retrans, strike the
    transport before updating the rto.  This will force transport switch at
    the right time, instead of 1 retransmit too late.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8c4a2d41a7eb5a8f214f537acca533dcd6430782
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Wed Feb 21 02:06:04 2007 -0800

    [SCTP]: Fix connection hang/slowdown with PR-SCTP
    
    The problem that this patch corrects happens when all of the following
    conditions are satisfisfied:
     1.  PR-SCTP is used and the timeout on the chunks is set below RTO.Max.
     2.  One of the paths on a multihomed associations is brought down.
    
    In this scenario, data will expire within the rto of the initial
    transmission and will never be retransmitted.  However this data still
    fills the send buffer and is counted against the association as outstanding
    data.  This causes any new data not to be sent and retransmission to not
    happen.
    
    The fix is to discount the abandoned data from the outstanding count and
    peers rwnd estimation.  This allows new data to be sent and a retransmission
    timer restarted.  Even though this new data will most likely expire within
    the rto, the timer still counts as a strike against the transport and forces
    the FORWARD-TSN chunk to be retransmitted as well.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cb18eccff48ef3986d1072964590bce6fec705fb
Merge: c827ba4cb49a 5ef213f68422
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Sun Feb 11 11:38:13 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (45 commits)
      [IPV4]: Restore multipath routing after rt_next changes.
      [XFRM] IPV6: Fix outbound RO transformation which is broken by IPsec tunnel patch.
      [NET]: Reorder fields of struct dst_entry
      [DECNET]: Convert decnet route to use the new dst_entry 'next' pointer
      [IPV6]: Convert ipv6 route to use the new dst_entry 'next' pointer
      [IPV4]: Convert ipv4 route to use the new dst_entry 'next' pointer
      [NET]: Introduce union in struct dst_entry to hold 'next' pointer
      [DECNET]: fix misannotation of linkinfo_dn
      [DECNET]: FRA_{DST,SRC} are le16 for decnet
      [UDP]: UDP can use sk_hash to speedup lookups
      [NET]: Fix whitespace errors.
      [NET] XFRM: Fix whitespace errors.
      [NET] X25: Fix whitespace errors.
      [NET] WANROUTER: Fix whitespace errors.
      [NET] UNIX: Fix whitespace errors.
      [NET] TIPC: Fix whitespace errors.
      [NET] SUNRPC: Fix whitespace errors.
      [NET] SCTP: Fix whitespace errors.
      [NET] SCHED: Fix whitespace errors.
      [NET] RXRPC: Fix whitespace errors.
      ...

commit d808ad9ab8b1109239027c248c4652503b9d3029
Author: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
Date:   Fri Feb 9 23:25:18 2007 +0900

    [NET] SCTP: Fix whitespace errors.
    
    Signed-off-by: YOSHIFUJI Hideaki <yoshfuji@linux-ipv6.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 190ff5b3a168b666925897558998b5d97fec8731
Merge: 6fd6b17c6d97 2e5530236645
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Wed Jan 31 16:58:12 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [NETFILTER]: xt_hashlimit: fix ip6tables dependency
      [SCTP]: Force update of the rto when processing HB-ACK
      [IPV6]: fix BUG of ndisc_send_redirect()
      [IPV6]: Fix up some CONFIG typos
      [NETFILTER]: SIP conntrack: fix out of bounds memory access
      [NETFILTER]: SIP conntrack: fix skipping over user info in SIP headers
      [NETFILTER]: xt_connbytes: fix division by zero
      [MAINTAINERS]: netfilter@ is subscribers-only

commit e533ca16f31f9e5abfaf5d8c7dbe7095f01474b6
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 30 14:36:14 2007 -0800

    [SCTP]: Force update of the rto when processing HB-ACK
    
    When processing a HEARTBEAT-ACK it's possible that the transport rto
    timers will not be updated because a prior T3-RTX processing would
    have cleared the rto_pending flag on the transport.  However, if
    we received a valid HEARTBEAT-ACK, we want to force update the
    rto variables, so re-set the rto_pending flag before calling
    sctp_transport_update_rto().
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6f3776c9cd03998f0e6d11774a03aa1788b4e463
Merge: 6e35c24b9f5b 1e5c11fc89ef
Author: Linus Torvalds <torvalds@woody.linux-foundation.org>
Date:   Wed Jan 24 07:45:35 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (23 commits)
      [SCTP]: Fix compiler warning.
      [IP] TUNNEL: Fix to be built with user application.
      [IPV6]: Fixed the size of the netlink message notified by inet6_rt_notify().
      [TCP]: rare bad TCP checksum with 2.6.19
      [NET]: Process include/linux/if_{addr,link}.h with unifdef
      [NETFILTER]: Fix iptables ABI breakage on (at least) CRIS
      [IRDA] vlsi_ir.{h,c}: remove kernel 2.4 code
      [TCP]: skb is unexpectedly freed.
      [IPSEC]: Policy list disorder
      [IrDA]: Removed incorrect IRDA_ASSERT()
      [IrDA]: irda-usb TX path optimization (was Re: IrDA spams logfiles - since 2.6.19)
      [X.25]: Add missing sock_put in x25_receive_data
      [SCTP]: Fix SACK sequence during shutdown
      [SCTP]: Correctly handle unexpected INIT-ACK chunk.
      [SCTP]: Verify some mandatory parameters.
      [SCTP]: Set correct error cause value for missing parameters
      [NETFILTER]: fix xt_state compile failure
      [NETFILTER]: ctnetlink: fix leak in ctnetlink_create_conntrack error path
      [SELINUX]: increment flow cache genid
      [IPV6] MCAST: Fix joining all-node multicast group on device initialization.
      ...

commit 1e5c11fc89ef6663aaa14db1e9e27477f07c24e0
Author: Brian Haley <brian.haley@hp.com>
Date:   Tue Jan 23 22:32:23 2007 -0800

    [SCTP]: Fix compiler warning.
    
    > --- a/net/sctp/sm_statefuns.c
    > +++ b/net/sctp/sm_statefuns.c
    > @@ -462,24 +461,6 @@ sctp_disposition_t sctp_sf_do_5_1C_ack(const struct sctp_endpoint *ep,
    
    > -     if (!init_tag) {
    > -             struct sctp_chunk *reply = sctp_make_abort(asoc, chunk, 0);
    > -             if (!reply)
    > -                     goto nomem;
    
    This introduced a compiler warning, easily fixed.
    
    Signed-off-by: Brian Haley <brian.haley@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 732ba35e759112be5cecd79d4351084edf88dba7
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 15 19:20:21 2007 -0800

    [SCTP]: Fix SACK sequence during shutdown
    
    Currently, when association enters SHUTDOWN state,the
    implementation will SACK any DATA first and then transmit
    the SHUTDOWN chunk.  This is against the order required by
    2960bis spec.  SHUTDOWN must always be first, followed by
    SACK. This change forces this order and also enables bundling.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 610ab73ac4cc8912fc253bbdc6d1f74bad3c8e3a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 15 19:18:30 2007 -0800

    [SCTP]: Correctly handle unexpected INIT-ACK chunk.
    
    Consider the chunk as Out-of-the-Blue if we don't have
    an endpoint.  Otherwise discard it as before.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d023f629451ace6f37eb5d2cf29ddd24497c91dc
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 15 19:15:45 2007 -0800

    [SCTP]: Verify some mandatory parameters.
    
    Verify init_tag and a_rwnd mandatory parameters in INIT and
    INIT-ACK chunks.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ebdfcad4dc2a6851f75fac0a3315046cbd9c4410
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 15 19:12:31 2007 -0800

    [SCTP]: Set correct error cause value for missing parameters
    
    sctp_process_missing_param() needs to use the SCTP_ERROR_MISS_PARAM
    error cause value.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8edf51a5ee38eb40de5449e131fd36450a229430
Merge: b3277dfaf025 483479ecc565
Author: Linus Torvalds <torvalds@woody.osdl.org>
Date:   Wed Jan 10 08:30:22 2007 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IPV4] devinet: inetdev_init out label moved after RCU assignment
      [INET]: style updates for the inet_sock->is_icsk assignment fix
      [SCTP]: Fix err_hdr assignment in sctp_init_cause.
      [NETFILTER]: tcp conntrack: fix IP_CT_TCP_FLAG_CLOSE_INIT value
      [NETFILTER]: nf_nat: fix hanging connections when loading the NAT module
      [NETFILTER]: arp_tables: fix userspace compilation
      [NETFILTER]: nf_conntrack_ipv6: fix crash when handling fragments

commit 4a1c0107bca2eccf4491b86fec41ce63268d803d
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 9 14:35:51 2007 -0800

    [SCTP]: Fix err_hdr assignment in sctp_init_cause.
    
    The subh->err_hdr should point to the error header, not the data.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f2a67a576959025549a3b6a884bdd21f4dc107da
Merge: 719d34027e1a 5c668704b7fa
Author: Linus Torvalds <torvalds@woody.osdl.org>
Date:   Fri Dec 22 14:14:17 2006 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [UDP]: Fix reversed logic in udp_get_port().
      [IPV6]: Dumb typo in generic csum_ipv6_magic()
      [SCTP]: make 2 functions static
      [SCTP]: Fix typo adaption -> adaptation as per the latest API draft.
      [SCTP]: Don't export include/linux/sctp.h to userspace.
      [TCP]: Fix ambiguity in the `before' relation.
      [ATM] drivers/atm/fore200e.c: Cleanups.
      [ATM]: Remove dead ATM_TNETA1570 option.
      NetLabel: correctly fill in unused CIPSOv4 level and category mappings
      NetLabel: perform input validation earlier on CIPSOv4 DOI add ops

commit 24123186fa271e7ad34a40f815782e6205f34ff7
Author: Adrian Bunk <bunk@stusta.de>
Date:   Wed Dec 20 16:08:22 2006 -0800

    [SCTP]: make 2 functions static
    
    This patch makes the following needlessly global functions static:
    - ipv6.c: sctp_inet6addr_event()
    - protocol.c: sctp_inetaddr_event()
    
    Signed-off-by: Adrian Bunk <bunk@stusta.de>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0f3fffd8ab1db7658c97c167e8ab001cc814e1f4
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Wed Dec 20 16:07:04 2006 -0800

    [SCTP]: Fix typo adaption -> adaptation as per the latest API draft.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a3f7f142f73ed4cb23826bee84afc31d10377e39
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Wed Dec 20 16:06:09 2006 -0800

    [SCTP]: Don't export include/linux/sctp.h to userspace.
    
    This file contains protocol definitions and there are no SCTP apps
    that use this file.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6ab792f577012312a760a3a1e679ae8fae012442
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Wed Dec 13 16:34:22 2006 -0800

    [SCTP]: Add support for SCTP_CONTEXT socket option.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 882a382c3e0b432fa91672e1c2754cac3f5a6b4f
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Wed Dec 13 16:33:35 2006 -0800

    [SCTP]: Enable auto loading of SCTP when creating an ipv6 SCTP socket.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 29c7cf96186ac14ce7380633f690fc39732ff03a
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Wed Dec 13 16:26:26 2006 -0800

    [SCTP]: Handle address add/delete events in a more efficient way.
    
    Currently in SCTP, we maintain a local address list by rebuilding the whole
    list from the device list whenever we get a address add/delete event.
    
    This patch fixes it by only adding/deleting the address for which we
    receive the event.
    
    Also removed the sctp_local_addr_lock() which is no longer needed as we
    now use list_for_each_safe() to traverse this list. This fixes the bugs
    in sctp_copy_laddrs_xxx() routines where we do copy_to_user() while
    holding this lock.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit af997d8c9568d556cd0a362d56de9fb14a6a012a
Author: Arnaldo Carvalho de Melo <acme@mandriva.com>
Date:   Tue Nov 21 01:20:33 2006 -0200

    [SCTP]: Use kzalloc where appropriate
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@mandriva.com>

commit 34bcca28335977e969338c98c6c43a1e08f592b2
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:27:15 2006 -0800

    [SCTP]: Even more trivial sctp annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2178eda82616566b7397791afa6e5487990bac8e
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:26:53 2006 -0800

    [SCTP]: SCTP_CMD_PROCESS_CTSN annotations.
    
    argument passed as __be32
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9f81bcd9429e9bb4006eb9b7df276706c5df926d
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:26:34 2006 -0800

    [SCTP]: More trivial sctp annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 962c837275e8a8c1df41f1882e971636093cdee4
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:26:08 2006 -0800

    [SCTP]: Netfilter sctp annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3dbe86566ed262dae3b5472b9360cb5b65d42716
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:25:49 2006 -0800

    [SCTP]: Annotate ->supported_addrs().
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e1857ea28dc76e2a929d1fff4d5d5cf712f12f4e
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:25:32 2006 -0800

    [SCTP]: sctp_association ->peer.i is a host-endian analog of sctp_inthdr.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dce116ae86cb224a9dad787e91fb552dae67b2e8
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:25:15 2006 -0800

    [SCTP]: Get rid of the last remnants of sin_port flipping.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6fbfa9f951878ab489147d9e459191d4aacfa819
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:24:53 2006 -0800

    [SCTP]: Annotate ->inaddr_any().
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c9c938cb050e6d45088c5c39e4097742e875c496
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:24:36 2006 -0800

    [SCTP]: flip_to_{h,n}() are not needed anymore.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7dcdbd9579c944bb833f95a7f276d01f49161734
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:24:21 2006 -0800

    [SCTP]: Don't bother setting sin_port in ->from_sk().
    
    ... the only caller will overwrite immediately
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 516b20ee2d4df76e7f76332e161a25c70e8f7bea
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:24:02 2006 -0800

    [SCTP]: ->a_h is gone now.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9fd76494855c974e9079e9812ba5ecf88dedab38
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:23:46 2006 -0800

    [SCTP]: ip6_send() doesn't need fl_ip_[sd]port.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7dd8a5821dd4991916c4eedf84e10fc2d0b47555
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:23:25 2006 -0800

    [SCTP]: sctp_sf_send_restart_abort() is endian-agnostic.
    
    ... so caller can use ->ipaddr instead of ->ipaddr_h
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8cec6b80664eb20b0c033fd20d2c7ed15621437f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:23:01 2006 -0800

    [SCTP]: We need to be careful when copying to sockaddr_storage.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b3f5b3b6654422bb0a6ef745fe4d11a4f01d006a
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:22:43 2006 -0800

    [SCTP]: Trivial ->ipaddr_h -> ->ipaddr conversions.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 74af924ab6562717ef9aab1061ec05bbbf31d979
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:22:26 2006 -0800

    [SCTP]: ->a_h is gone now.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5ae955cffdb96190c2bd4f57313f5f147f87854b
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:22:08 2006 -0800

    [SCTP]: sctp_make_asconf_update_ip() and sctp_find_unmatch_addr().
    
    ... switched to taking and returning pointers to net-endian
    sctp_addr resp.  Together, since the only user of sctp_find_unmatch_addr()
    just passes its value to sctp_make_asconf_update_ip().
    sctp_make_asconf_update_ip() is actually endian-agnostic.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6244be4e063075f6077f05e70f8fa1bf7f4a968e
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:21:44 2006 -0800

    [SCTP]: Trivial parts of a_h -> a switch.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 80f15d62418040e78849f5fc3a4a5af9c9d1fec7
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:14:23 2006 -0800

    [SCTP]: ->source_h is not used anymore.
    
    kill it
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a926626893aca20567f27af1c5edc830e1c51b2b
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:13:58 2006 -0800

    [SCTP]: Switch all remaining users of ->saddr_h to ->saddr.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 16b0a030330d179427edffbeddaa5b7dc5b31196
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:13:38 2006 -0800

    [SCTP]: Switch sctp_chunk ->dest to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d448388bdaca946aa2b07973cb72a9b834e530bf
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:13:21 2006 -0800

    [SCTP]: sctp_transport_route() switched to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cb7b4a0dcf67ae747406b58b1cdc875916019739
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:13:01 2006 -0800

    [SCTP]: Pass net-endian to ->get_dst().
    
    all instances are actually endian-agnostic...
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d3f7a54a295f2ffc9033b425c6538a7e9d7fbe8a
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:12:41 2006 -0800

    [SCTP]: ->get_saddr() switched to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6a1e5f335461567f593e88b218f1c06817cbd323
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:12:25 2006 -0800

    [SCTP]: sctp_process_init() and sctp_source() switched to net-endian.
    
    both are done in one go since almost always we have result of
    the latter immediately passed to the former.  Possibly non-obvious
    note: sctp_process_param() is endian-agnostic
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 02a8a4db3b38ad2dd8bcfcca41694e043e44d282
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:12:07 2006 -0800

    [SCTP]: sctp_copy_one_addr() switched to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6c7be55ca0c204473d07a030a03c49a7471b4508
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:11:50 2006 -0800

    [SCTP]: sctp_has_association() switched to net-endian.
    
    Ditto for its only caller (sctp_endpoint_is_peeled_off)
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cd4ff034e3572679f7ff8f126469b3addd1a4fbc
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:11:33 2006 -0800

    [SCTP]: sctp_endpoint_lookup_assoc() switched to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dd86d136f9feb72c52a5b07707affe80edbc8dda
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:11:13 2006 -0800

    [SCTP]: Switch ->from_addr_param() to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5ab7b859ab58e3479a5a66e383ecd6bc447f6c1d
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:10:38 2006 -0800

    [SCTP]: Switch sctp_add_bind_addr() to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4bdf4b5fe22c26750c39fdd2939a5f33df0cc341
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:10:20 2006 -0800

    [SCTP]: Switch sctp_assoc_add_peer() to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b488c7dd58f61e07b54e5d286c7b45c43dd52f1a
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:10:03 2006 -0800

    [SCTP]: sctp_transport_{init,new}() switched to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d55c41b115e74b30a3d1a61db806bd03bdd9dd6f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:09:40 2006 -0800

    [SCTP]: Switch ->from_skb() to net-endian.
    
    All instances switched, callers updated.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9b1dfad011d409bc56476a81810342751645ee54
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:09:17 2006 -0800

    [SCTP]: Switch sctp_cookie ->peer_addr to net-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f235fca389f23cd6c9e0f466611bb2d6a05ae758
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:09:01 2006 -0800

    [SCTP]: sctp_init_addrs() switched to net-endian.
    
    Caller adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e2fccedb0136205d02e97a41851503e2b96d2a17
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:08:41 2006 -0800

    [SCTP]: Switch sctp_assoc_is_match to net-endian.
    
    Along with it, statics in input.c that end up calling it
    (__sctp_lookup_association, sctp_lookup_association,
    __sctp_rcv_init_lookup, __sctp_rcv_lookup).  Callers
    are adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1c7d1fc14974f44809b22521bd9796411d8ba440
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:08:09 2006 -0800

    [SCTP]: Switch sctp_endpoint_is_match() to net-endian.
    
    The only caller (__sctp_rcv_lookup_endpoint()) also switched,
    its caller adjusted
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c9a08505ec0a0260fc94a823c014cc3970f72d25
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:07:48 2006 -0800

    [SCTP]: Switch sctp_del_bind_addr() to net-endian.
    
    Callers adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 63de08f45bb73a445edb482850f4cdccd84def48
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:07:25 2006 -0800

    [SCTP]: Switch address inside the heartbeat opaque data to net-endian.
    
    Its only use happens on the same host, when it gets quoted back to
    us.  So we are free to flip to net-endian and avoid extra PITA.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit be29681edfbad72167df735e243e8621840dca4f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:07:06 2006 -0800

    [SCTP]: Switch sctp_assoc_lookup_paddr() to net-endian.
    
    Callers updated.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 38a03145efcdbbcc60465fdffc0546208a52daf8
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:06:45 2006 -0800

    [SCTP]: sctp_assoc_del_peer() switched to net-endian.
    
    Callers adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 854d43a465cc8ba8e501320b3bc27359d909da2f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:06:24 2006 -0800

    [SCTP]: Annotate ->dst_saddr()
    
    switched to taking a pointer to net-endian sctp_addr
    and a net-endian port number.  Instances and callers
    adjusted; interestingly enough, the only calls are
    direct calls of specific instances - the method is not
    used at all.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit acd2bc96e19535fcd74c6eb94532c19c817857bd
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:06:04 2006 -0800

    [SCTP]: Switch ->primary_addr to net-endian.
    
    Users adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7e1e4a2b9dcc63ac3328f786f9d98bde90c8fc6c
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:05:43 2006 -0800

    [SCTP]: Switch sctp_bind_addr_match() to net-endian.
    
    Callers adjusted.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5f242a13e8505e0f3efd3113da6e029f6e7dfa32
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:05:23 2006 -0800

    [SCTP]: Switch ->cmp_addr() and sctp_cmp_addr_exact() to net-endian.
    
    instances of ->cmp_addr() are fine with switching both arguments
    to net-endian; callers other than in sctp_cmp_addr_exact() (both
    as ->cmp_addr(...) and direct calls of instances) adjusted;
    sctp_cmp_addr_exact() switched to net-endian itself and adjustment
    is done in its callers
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit c604e368a477ed1f7dd532605a8f1990d2b128ee
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:04:59 2006 -0800

    [SCTP]: Pass net-endian to ->seq_dump_addr()
    
    No actual modifications of method instances are needed -
    they don't look at port numbers.  Switch callers...
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2a6fd78adec062f16f8662563115679e669efaca
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:04:42 2006 -0800

    [SCTP] embedded sctp_addr: net-endian mirrors
    
    Add sctp_chunk->source, sctp_sockaddr_entry->a, sctp_transport->ipaddr
    and sctp_transport->saddr, maintain them as net-endian mirrors of
    their host-endian counterparts.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 09ef7fecea40c5e4c0dfe35bed3f0ed8da554cf5
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:04:10 2006 -0800

    [SCTP]: Beginning of conversion to net-endian for embedded sctp_addr.
    
    Part 1: rename sctp_chunk->source, sctp_sockaddr_entry->a,
    sctp_transport->ipaddr and sctp_transport->saddr (to ..._h)
    
    The next patch will reintroduce these fields and keep them as
    net-endian mirrors of the original (renamed) ones.  Split in
    two patches to make sure that we hadn't forgotten any instanes.
    
    Later in the series we'll eliminate uses of host-endian variants
    (basically switching users to net-endian counterparts as we
    progress through that mess).  Then host-endian ones will die.
    
    Other embedded host-endian sctp_addr will be easier to switch
    directly, so we leave them alone for now.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 30330ee00ce077de9d459c17125573ff618bd7a9
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:03:18 2006 -0800

    [SCTP] bug: endianness problem in sctp_getsockopt_sctp_status()
    
    Again, invalid sockaddr passed to userland - host-endiand sin_port.
    Potential leak, again, but less dramatic than in previous case.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0906e20fa03afdb14faf7fd166bfe4ed67c8db55
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:03:01 2006 -0800

    [SCTP] bug: sctp_assoc_control_transport() breakage
    
    a) struct sockaddr_storage * passed to sctp_ulpevent_make_peer_addr_change()
    actually points at union sctp_addr field in a structure.  Then that sucker
    gets copied to userland, with whatever junk we might have there.
    
    b) it's actually having host-endian sin_port.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d5c747f6efc03495635f129c8eb1dad0200ab183
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:02:40 2006 -0800

    [SCTP] bug: sctp_find_unmatch_addr() compares net-endian to host-endian
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 39940a48c42441da5e7428483ac515e822d52b1d
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:02:22 2006 -0800

    [SCTP] bug: sctp_assoc_lookup_laddr() is broken with ipv6.
    
    It expects (and gets) laddr with net-endian sin_port.  And then it calls
    sctp_bind_addr_match(), which *does* care about port numbers in case of
    ipv6 and expects them to be host-endian.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 04afd8b282d702bc122051751466000e9513ef96
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:02:01 2006 -0800

    [SCTP]: Beginning of sin_port fixes.
    
    That's going to be a long series.  Introduced temporary helpers
    doing copy-and-convert for sctp_addr; they are used to kill
    flip-in-place in global data structures and will be used
    to gradually push host-endian uses of sctp_addr out of existence.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dbc16db1e58da6c346ca3e63870c17b93fbed0f0
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:01:42 2006 -0800

    [SCTP]: Trivial sctp endianness annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 72f17e1c0984fbdb60abf245d81b947393910100
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:01:23 2006 -0800

    [SCTP]: Annotate tsn_dups.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5be291fe2d0d76681190589f6480ce1e28c2406b
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:01:06 2006 -0800

    [SCTP]: SCTP_CMD_ASSOC_FAILED annotations.
    
    also always get __be16 protocol error; switch to SCTP_PERR()
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit dc251b2b1c4bfea51903cb9fbc141a5b33f6aca7
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:00:44 2006 -0800

    [SCTP]: SCTP_CMD_INIT_FAILED annotations.
    
    argument stored for SCTP_CMD_INIT_FAILED is always __be16
    (protocol error).  Introduced new field and accessor for
    it (SCTP_PERR()); switched to their use (from SCTP_U32() and
    .u32)
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f94c0198dd98c2ca66a7a44e9ad310a3eb21ad31
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:00:25 2006 -0800

    [SCTP]: sctp_stop_t1_and_abort() annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 63706c5c6fd07f58bed85d0aa031ffbce3a0385f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 17:00:05 2006 -0800

    [SCTP]: sctp_make_op_error() annotations.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5bf2db03908b9121805af3c76e3ac2d0759e199f
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 16:59:45 2006 -0800

    [SCTP]: Annotate sctp_init_cause().
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit f3ffaf14681e3cad61006873be8656ab41b793e0
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Mon Nov 20 16:59:12 2006 -0800

    [SCTP]: Annotate SCTP headers.
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1ed176a801b83915b7c8ab80e0a2a6376a2d6051
Author: Peter Zijlstra <a.p.zijlstra@chello.nl>
Date:   Mon Nov 13 16:19:07 2006 -0800

    [SCTP]: Cleanup of the sctp state table code.
    
    I noticed an insane high density of repeated characters fixable by a
    simple regular expression:
    
      % s/{.fn = \([^,]*\),[[:space:]]\+\(\\\n[[:space:]]\+\)\?.name = "\1"}/TYPE_SCTP_FUNC(\1)/g
    
    (NOTE: the .name for .fn = sctp_sf_do_9_2_start_shutdown didn't match)
    
    Signed-off-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b68dbcab1dc70938fa5516d0ee82c0bf94e9a768
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Nov 9 16:29:57 2006 -0800

    [SCTP]: Fix warning
    
    An alternate solution would be to make the digest a pointer, allocate
    it in sctp_endpoint_init() and free it in sctp_endpoint_destroy().
    
    I guess I should have originally done it this way...
    
      CC [M]  net/sctp/sm_make_chunk.o
    net/sctp/sm_make_chunk.c: In function 'sctp_unpack_cookie':
    net/sctp/sm_make_chunk.c:1358: warning: initialization discards qualifiers from pointer target type
    
    The reason is that sctp_unpack_cookie() takes a const struct
    sctp_endpoint and modifies the digest in it (digest being embedded in
    the struct, not a pointer).  Make digest a pointer to fix this
    warning.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit fdda387f73947e6ae511ec601f5b3c6fbb582aac
Author: Patrick Caulfield <pcaulfie@redhat.com>
Date:   Thu Nov 2 11:19:21 2006 -0500

    [DLM] Add support for tcp communications
    
    The following patch adds a TCP based communications layer
    to the DLM which is compile time selectable. The existing SCTP
    layer gives the advantage of allowing multihoming, whereas
    the TCP layer has been heavily tested in previous versions of
    the DLM and is known to be robust and therefore can be used as
    a baseline for performance testing.
    
    Signed-off-by: Patrick Caulfield <pcaulfie@redhat.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>

commit 540218dd286964e2c4ee2ee2b6259fd89bf5035e
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Wed Nov 29 12:06:04 2006 +0100

    SCTP: Always linearise packet on input
    
    I was looking at a RHEL5 bug report involving Xen and SCTP
    (https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=212550).
    It turns out that SCTP wasn't written to handle skb fragments at
    all.  The absence of any calls to skb_may_pull is testament to
    that.
    
    It just so happens that Xen creates fragmented packets more often
    than other scenarios (header & data split when going from domU to
    dom0).  That's what caused this bug to show up.
    
    Until someone has the time sits down and audits the entire net/sctp
    directory, here is a conservative and safe solution that simply
    linearises all packets on input.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit cea23cd94f286008d382ccee265ca417c9ce9a58
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sun Oct 29 23:48:51 2006 -0800

    [PATCH] SCTP: Always linearise packet on input
    
    I was looking at a RHEL5 bug report involving Xen and SCTP
    (https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=212550).
    It turns out that SCTP wasn't written to handle skb fragments at
    all.  The absence of any calls to skb_may_pull is testament to
    that.
    
    It just so happens that Xen creates fragmented packets more often
    than other scenarios (header & data split when going from domU to
    dom0).  That's what caused this bug to show up.
    
    Until someone has the time sits down and audits the entire net/sctp
    directory, here is a conservative and safe solution that simply
    linearises all packets on input.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 612b322ade7954a1d984fa410a70d4ae50f75c0d
Merge: d2c59a22dd7c 1b7c2dbc07bf
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Tue Oct 31 08:08:31 2006 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IPV6]: fix flowlabel seqfile handling
      [IPV6]: return EINVAL for invalid address with flowlabel lease request
      [SCTP]: Remove temporary associations from backlog and hash.
      [SCTP]: Correctly set IP id for SCTP traffic
      [NetLabel]: protect the CIPSOv4 socket option from setsockopt()
      [NETFILTER]: ip_tables: compat code module refcounting fix
      [NETFILTER]: nf_conntrack: add missing unlock in get_next_corpse()
      [NETFILTER]: ip_tables: compat error way cleanup
      [NETFILTER]: Missed and reordered checks in {arp,ip,ip6}_tables
      [NETFILTER]: remove masq/NAT from ip6tables Kconfig help
      [IPV6]: fix lockup via /proc/net/ip6_flowlabel
      [NET]: fix uaccess handling
      [SCTP]: Always linearise packet on input
      [ETH1394]: Fix unaligned accesses.
      [DCCP]: fix printk format warnings
      [NET]: Fix segmentation of linear packets
      [XFRM] xfrm_user: Fix unaligned accesses.
      [APPLETALK]: Fix potential OOPS in atalk_sendmsg().
      [NET] sealevel: uses arp_broken_ops

commit de76e695a5ce19c121ba7e246b45f258be678a75
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Oct 30 18:55:11 2006 -0800

    [SCTP]: Remove temporary associations from backlog and hash.
    
    Every time SCTP creates a temporary association, the stack hashes it,
    puts it on a list of endpoint associations and increments the backlog.
    However, the lifetime of a temporary association is the processing time
    of a current packet and it's destroyed after that. In fact, we don't
    really want anyone else finding this association. There is no reason to
    do this extra work.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4f4443088b763ca4ac7521e9b4a881b52c294dec
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Oct 30 18:54:32 2006 -0800

    [SCTP]: Correctly set IP id for SCTP traffic
    
    Make SCTP 1-1 style and peeled-off associations behave like TCP when
    setting IP id. In both cases, we set the inet_sk(sk)->daddr and initialize
    inet_sk(sk)->id to a random value.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 28cd7752734563d5b0967b96a6bade7a1dc89c7f
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sun Oct 29 23:46:42 2006 -0800

    [SCTP]: Always linearise packet on input
    
    I was looking at a RHEL5 bug report involving Xen and SCTP
    (https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=212550).
    It turns out that SCTP wasn't written to handle skb fragments at
    all.  The absence of any calls to skb_may_pull is testament to
    that.
    
    It just so happens that Xen creates fragmented packets more often
    than other scenarios (header & data split when going from domU to
    dom0).  That's what caused this bug to show up.
    
    Until someone has the time sits down and audits the entire net/sctp
    directory, here is a conservative and safe solution that simply
    linearises all packets on input.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 23c435f7ff884caded4a1391ba2b308d465423c0
Author: Ville Nuorvala <vnuorval@tcs.hut.fi>
Date:   Mon Oct 16 22:08:28 2006 -0700

    [SCTP]: Fix minor typo
    
    Signed-off-by: Ville Nuorvala <vnuorval@tcs.hut.fi>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1ee48af22ed6dcddea8cdf93c7f2a268cbcf0d56
Author: Adrian Bunk <bunk@stusta.de>
Date:   Sun Oct 8 04:30:48 2006 +0200

    [DLM] Kconfig: don't show an empty DLM menu
    
    Don't show an empty "Distributed Lock Manager" menu if IP_SCTP=n.
    
    Reported by Dmytro Bagrii in kernel Bugzilla #7268.
    
    Signed-off-by: Adrian Bunk <bunk@stusta.de>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Patrick Caulfield <pcaulfie@redhat.com>
    Signed-off-by: Steven Whitehouse <swhiteho@redhat.com>

commit 9ff4680e9958508bebc5c683b98f37b66617e088
Merge: 83d3d3c52468 30bdbe397bf5
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Thu Oct 12 07:38:59 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [PKT_SCHED] sch_htb: use rb_first() cleanup
      [RTNETLINK]: Fix use of wrong skb in do_getlink()
      [DECNET]: Fix sfuzz hanging on 2.6.18
      [NET]: Do not memcmp() over pad bytes of struct flowi.
      [NET]: Introduce protocol-specific destructor for time-wait sockets.
      [NET]: Use typesafe inet_twsk() inline function instead of cast.
      [NET]: Use hton{l,s}() for non-initializers.
      [TCP]: Use TCPOLEN_TSTAMP_ALIGNED macro instead of magic number.
      [IPV6]: Seperate sit driver to extra module (addrconf.c changes)
      [IPV6]: Seperate sit driver to extra module
      [NET]: File descriptor loss while receiving SCM_RIGHTS
      [SCTP]: Fix the RX queue size shown in /proc/net/sctp/assocs output.
      [SCTP]: Fix receive buffer accounting.
      SELinux: Bug fix in polidydb_destroy
      IPsec: fix handling of errors for socket policies
      IPsec: correct semantics for SELinux policy matching
      IPsec: propagate security module errors up from flow_cache_lookup
      NetLabel: use SECINITSID_UNLABELED for a base SID
      NetLabel: fix a cache race condition

commit 6aa2551cf135f1d246d31482adc8c679eeea3a83
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Oct 9 21:34:26 2006 -0700

    [SCTP]: Fix the RX queue size shown in /proc/net/sctp/assocs output.
    
    Show the true receive buffer usage.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 331c4ee7faa4ee1e1404c872a139784753100498
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Oct 9 21:34:04 2006 -0700

    [SCTP]: Fix receive buffer accounting.
    
    When doing receiver buffer accounting, we always used skb->truesize.
    This is problematic when processing bundled DATA chunks because for
    every DATA chunk that could be small part of one large skb, we would
    charge the size of the entire skb.  The new approach is to store the
    size of the DATA chunk we are accounting for in the sctp_ulpevent
    structure and use that stored value for accounting.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bf603625660b1742004bf86432ce3c210d14d4fd
Merge: fbe96f92b3d9 6656e3c4c8e0
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Fri Sep 29 18:54:48 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [ATM]: [lec] use refcnt to protect lec_arp_entries outside lock
      [ATM]: [lec] add reference counting to lec_arp entries
      [ATM]: [lec] use work queue instead of timer for lec arp expiry
      [ATM]: [lec] old_close is no longer used
      [ATM]: [lec] convert lec_arp_table to hlist
      [ATM]: [lec] header indent, comment and whitespace cleanup
      [ATM]: [lec] indent, comment and whitespace cleanup [continued]
      [ATM]: [lec] indent, comment and whitespace cleanup
      [SCTP]: Do not timestamp every SCTP packet.
      [SCTP]: Use correct mask when disabling PMTUD.
      [SCTP]: Include sk_buff overhead while updating the peer's receive window.
      [SCTP]: Enable Nagle algorithm by default.
      [BNX2]: Disable MSI on 5706 if AMD 8132 bridge is present.
      [NetLabel]: audit fixups due to delayed feedback

commit f236218b7292bccb0f8754a0feb5d9e9a06fe5a2
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 29 17:10:03 2006 -0700

    [SCTP]: Do not timestamp every SCTP packet.
    
    We only need the timestamp on COOKIE-ECHO chunks, so instead of always
    timestamping every SCTP packet, let common code timestamp if the socket
    option is set.  For COOKIE-ECHO, simply get the time of day if we don't
    have a timestamp.  This introduces a small possibility that the cookie
    may be considered expired, but it will be renegotiated.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b56bab46f3220eb6b1f71c000faa44c6b13fb148
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Sep 29 17:09:34 2006 -0700

    [SCTP]: Use correct mask when disabling PMTUD.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cd49788563d3b9e2ec0b316fa57aef1c0cb3bd4b
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Sep 29 17:09:05 2006 -0700

    [SCTP]: Include sk_buff overhead while updating the peer's receive window.
    
    Currently if the sender is sending small messages, it can cause a receiver
    to run out of receive buffer space even when the advertised receive window
    is still open and results in packet drops and retransmissions. Including
    a overhead while updating the sender's view of peer receive window will
    reduce the chances of receive buffer space overshooting the receive window.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 208edef6a5b6c50363c77efcf34c4b4020681029
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Sep 29 17:08:01 2006 -0700

    [SCTP]: Enable Nagle algorithm by default.
    
    This allows more aggressive bundling of chunks when sending small
    messages.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 161643660129dd7d98f0b12418c0a2710ffa7db6
Author: Adrian Bunk <bunk@stusta.de>
Date:   Mon Sep 18 00:40:38 2006 -0700

    [SCTP]: Cleanups
    
    This patch contains the following cleanups:
    - make the following needlessly global function static:
      - socket.c: sctp_apply_peer_addr_params()
    - add proper prototypes for the several global functions in
      include/net/sctp/sctp.h
    
    Note that this fixes wrong prototypes for the following functions:
    - sctp_snmp_proc_exit()
    - sctp_eps_proc_exit()
    - sctp_assocs_proc_exit()
    
    The latter was spotted by the GNU C compiler and reported
    by David Woodhouse.
    
    Signed-off-by: Adrian Bunk <bunk@stusta.de>
    Acked-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4cbf1cae9f08c76ed92700090a69a5b1f1f6a982
Author: Brian Haley <brian.haley@hp.com>
Date:   Mon Sep 18 00:04:22 2006 -0700

    [SCTP]: Change globals to __read_mostly
    
    Change sctp globals to __read_mostly.
    
    Signed-off-by: Brian Haley <brian.haley@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3fd091e73b81f131e1567c4d4a1ec042940bf2f7
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Aug 22 13:29:17 2006 -0700

    [SCTP]: Remove multiple levels of msecs to jiffies conversions.
    
    The SCTP sysctl entries are displayed in milliseconds, but stored
    internally in jiffies. This results in multiple levels of msecs to
    jiffies conversion and as a result produces a truncation error. This
    patch makes things consistent in that we store and display defaults
    in milliseconds and only convert once for use by association.
    This patch also adds some sane min/max values so that we don't go off
    the deep end.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8abfedd889e46ad4977dfcdab737edf5c5803c62
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Tue Aug 22 00:24:09 2006 -0700

    [SCTP]: Use the flags value that is passed as an arg to sctp_accept.
    
    No need to do multiple dereferences - sk->sk_socket->file->f_flags
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit eb5fa39f5ef490c72901b547ac5e7211efd47d56
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Aug 22 00:23:13 2006 -0700

    [SCTP]: Fix IPv6 address flag setting when doing peel-off/accept.
    
    During accept/peeloff we try to copy the list of bound addresses from
    the original endpoint to the new one. However, we forgot to set the flag
    to say that IPv6 is allowed on the new endpoint.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit df7deeb5402087ea0387173aaf067d37a264a8f0
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Aug 22 00:19:51 2006 -0700

    [SCTP]: Cleanup nomem handling in the state functions.
    
    This patch cleans up the "nomem" conditions that may occur during the
    processing by the state machine functions. In most cases we delay adding
    side-effect commands until all memory allocations are done.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ac0b04627269ff16c3c7ab854a65fe6780c6e3e5
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Tue Aug 22 00:15:33 2006 -0700

    [SCTP]: Extend /proc/net/sctp/snmp to provide more statistics.
    
    This patch adds more statistics info under /proc/net/sctp/snmp
    that should be useful for debugging. The additional events that
    are counted now include timer expirations, retransmits, packet
    and data chunk discards.
    
    The Data chunk discards include all the cases where a data chunk
    is discarded including high tsn, bad stream, dup tsn and the most
    useful one(out of receive buffer/rwnd).
    
    Also moved the SCTP MIB data structures from the generic include
    directories to include/sctp/sctp.h.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6bbd9b6d694ff7242d63cda2faac4bd59ee4328e
Merge: a489d159229f 3c164bd8153c
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Fri Sep 22 12:51:33 2006 -0700

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6: (64 commits)
      [BLOCK] dm-crypt: trivial comment improvements
      [CRYPTO] api: Deprecate crypto_digest_* and crypto_alg_available
      [CRYPTO] padlock: Convert padlock-sha to use crypto_hash
      [CRYPTO] users: Use crypto_comp and crypto_has_*
      [CRYPTO] api: Add crypto_comp and crypto_has_*
      [CRYPTO] users: Use crypto_hash interface instead of crypto_digest
      [SCSI] iscsi: Use crypto_hash interface instead of crypto_digest
      [CRYPTO] digest: Remove old HMAC implementation
      [CRYPTO] doc: Update documentation for hash and me
      [SCTP]: Use HMAC template and hash interface
      [IPSEC]: Use HMAC template and hash interface
      [CRYPTO] tcrypt: Use HMAC template and hash interface
      [CRYPTO] hmac: Add crypto template implementation
      [CRYPTO] digest: Added user API for new hash type
      [CRYPTO] api: Mark parts of cipher interface as deprecated
      [PATCH] scatterlist: Add const to sg_set_buf/sg_init_one pointer argument
      [CRYPTO] drivers: Remove obsolete block cipher operations
      [CRYPTO] users: Use block ciphers where applicable
      [SUNRPC] GSS: Use block ciphers where applicable
      [IPSEC] ESP: Use block ciphers where applicable
      ...

commit 1b489e11d4df82514792f9f981f31976f8a94ddf
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sun Aug 20 15:07:14 2006 +1000

    [SCTP]: Use HMAC template and hash interface
    
    This patch converts SCTP to use the new HMAC template and hash interface.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e564f8a9cc64ebc06794d716e3240538b4a61f28
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Mon Aug 28 13:55:32 2006 -0700

    SCTP: Fix sctp_primitive_ABORT() call in sctp_close().
    
    With the recent fix, the callers of sctp_primitive_ABORT()
    need to create an ABORT chunk and pass it as an argument rather
    than msghdr that was passed earlier.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c30b0653f1bcaf04f8abf24cad5c1e642a3da47
Merge: 7288026b8671 ee1377c3eef4
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Wed Aug 30 15:54:35 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [STRIP]: Fix neighbour table refcount leak.
      [IPV6]: ipv6_add_addr should install dstentry earlier
      [NETLINK]: Call panic if nl_table allocation fails
      [TCP]: Two RFC3465 Appropriate Byte Count fixes.
      [IPV6]: SNMPv2 "ipv6IfStatsInAddrErrors" counter error
      [E100]: Add module option to ignore bad EEPROM checksums.
      [SCTP]: Fix sctp_primitive_ABORT() call in sctp_close().

commit b9ac86727fc02cc7117ef3fe518a4d51cd573c82
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Mon Aug 28 13:53:01 2006 -0700

    [SCTP]: Fix sctp_primitive_ABORT() call in sctp_close().
    
    With the recent fix, the callers of sctp_primitive_ABORT()
    need to create an ABORT chunk and pass it as an argument rather
    than msghdr that was passed earlier.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 13967acced1d331cb76a3392e53d3a72dfcbbd64
Author: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
Date:   Sat Aug 26 02:41:37 2006 +0200

    SCTP: Send only 1 window update SACK per message.
    
    Right now, every time we increase our rwnd by more then MTU bytes, we
    trigger a SACK.  When processing large messages, this will generate a
    SACK for almost every other SCTP fragment. However since we are freeing
    the entire message at the same time, we might as well collapse the SACK
    generation to 1.
    
    Signed-off-by: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit de8bcc327c65dc8fc707cbd25a745d3cecacd873
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Aug 26 02:41:12 2006 +0200

    SCTP: Reset rtt_in_progress for the chunk when processing its sack.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit 2d17897a633579202cb548e759756a1cc823568b
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Aug 26 02:40:29 2006 +0200

    SCTP: Limit association max_retrans setting in setsockopt.
    
    When using ASSOCINFO socket option, we need to limit the number of
    maximum association retransmissions to be no greater than the sum
    of all the path retransmissions. This is specified in Section 7.1.2
    of the SCTP socket API draft.
    However, we only do this if the association has multiple paths. If
    there is only one path, the protocol stack will use the
    assoc_max_retrans setting when trying to retransmit packets.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit fe7e513c0b87b1b41f162eb6d5ee9d48cdaaf578
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Sat Aug 26 02:39:48 2006 +0200

    SCTP: Fix persistent slowdown in sctp when a gap ack consumes rx buffer.
    
    In the event that our entire receive buffer is full with a series of
    chunks that represent a single gap-ack, and then we accept a chunk
    (or chunks) that fill in the gap between the ctsn and the first gap,
    we renege chunks from the end of the buffer, which effectively does
    nothing but move our gap to the end of our received tsn stream. This
    does little but move our missing tsns down stream a little, and, if the
    sender is sending sufficiently large retransmit frames, the result is a
    perpetual slowdown which can never be recovered from, since the only
    chunk that can be accepted to allow progress in the tsn stream necessitates
    that a new gap be created to make room for it. This leads to a constant
    need for retransmits, and subsequent receiver stalls. The fix I've come up
    with is to deliver the frame without reneging if we have a full receive
    buffer and the receiving sockets sk_receive_queue is empty(indicating that
    the receive buffer is being blocked by a missing tsn).
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit cf7260ee89f7b187304a35b188cc0c889f7bdd24
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Aug 26 02:39:03 2006 +0200

    SCTP: Reject sctp packets with broadcast addresses.
    
    Make SCTP handle broadcast properly
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Adrian Bunk <bunk@stusta.de>

commit d5af981e93aff0de5ad2a1a9935a3f6aa5cd3e3c
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jul 24 22:55:29 2006 -0700

    [NETFILTER]: Demote xt_sctp to EXPERIMENTAL
    
    After the recent problems with all the SCTP stuff it seems reasonable
    to mark this as experimental.
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 12157a8d78af50842774bedb80b7b84a87f60951
Merge: efab4cbe99f9 9df3f3d28bca
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Fri Jul 21 16:44:45 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (21 commits)
      [TIPC]: Removing useless casts
      [IPV4]: Fix nexthop realm dumping for multipath routes
      [DUMMY]: Avoid an oops when dummy_init_one() failed
      [IFB] After ifb_init_one() failed, i is increased. Decrease
      [NET]: Fix reversed error test in netif_tx_trylock
      [MAINTAINERS]: Mark LAPB as Oprhan.
      [NET]: Conversions from kmalloc+memset to k(z|c)alloc.
      [NET]: sun happymeal, little pci cleanup
      [IrDA]: Use alloc_skb() in IrDA TX path
      [I/OAT]: Remove pci_module_init() from Intel I/OAT DMA engine
      [I/OAT]: net/core/user_dma.c should #include <net/netdma.h>
      [SCTP]: ADDIP: Don't use an address as source until it is ASCONF-ACKed
      [SCTP]: Set chunk->data_accepted only if we are going to accept it.
      [SCTP]: Verify all the paths to a peer via heartbeat before using them.
      [SCTP]: Unhash the endpoint in sctp_endpoint_free().
      [SCTP]: Check for NULL arg to sctp_bucket_destroy().
      [PKT_SCHED] netem: Fix slab corruption with netem (2nd try)
      [WAN]: Converted synclink drivers to use netif_carrier_*()
      [WAN]: Cosmetic changes to N2 and C101 drivers
      [WAN]: Added missing netif_dormant_off() to generic HDLC
      ...

commit dc022a9874d026c7d1635ae66d1afafc5f053731
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Jul 21 14:49:25 2006 -0700

    [SCTP]: ADDIP: Don't use an address as source until it is ASCONF-ACKed
    
    This implements Rules D1 and D4 of Sec 4.3 in the ADDIP draft.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9faa730f1cbb951e95cb18e71b0fe265014c2450
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Jul 21 14:49:07 2006 -0700

    [SCTP]: Set chunk->data_accepted only if we are going to accept it.
    
    Currently there is a code path in sctp_eat_data() where it is possible
    to set this flag even when we are dropping this chunk.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ad8fec1720e000ba2384de6408076a60fc92a981
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Jul 21 14:48:50 2006 -0700

    [SCTP]: Verify all the paths to a peer via heartbeat before using them.
    
    This patch implements Path Initialization procedure as described in
    Sec 2.36 of RFC4460.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cfdeef3282705a4b872d3559c4e7d2561251363c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Jul 21 14:48:26 2006 -0700

    [SCTP]: Unhash the endpoint in sctp_endpoint_free().
    
    This prevents a race between the close of a socket and receive of an
    incoming packet.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 37fa6878bcd54c25fbe6ebb3da5cf0d3a4bc7a65
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri Jul 21 14:45:47 2006 -0700

    [SCTP]: Check for NULL arg to sctp_bucket_destroy().
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e37a72de84d27ee8bc0e7dbb5c2f1774ed306dbb
Merge: 93fdf10d4c28 f83ef8c0b58d
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Fri Jun 30 15:40:17 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [IPV6]: Added GSO support for TCPv6
      [NET]: Generalise TSO-specific bits from skb_setup_caps
      [IPV6]: Added GSO support for TCPv6
      [IPV6]: Remove redundant length check on input
      [NETFILTER]: SCTP conntrack: fix crash triggered by packet without chunks
      [TG3]: Update version and reldate
      [TG3]: Add TSO workaround using GSO
      [TG3]: Turn on hw fix for ASF problems
      [TG3]: Add rx BD workaround
      [TG3]: Add tg3_netif_stop() in vlan functions
      [TCP]: Reset gso_segs if packet is dodgy

commit dd7271feba61d5dc0fab1cb5365db9926d35ea3a
Author: Patrick McHardy <kaber@trash.net>
Date:   Thu Jun 29 21:40:23 2006 -0700

    [NETFILTER]: SCTP conntrack: fix crash triggered by packet without chunks
    
    When a packet without any chunks is received, the newconntrack variable
    in sctp_packet contains an out of bounds value that is used to look up an
    pointer from the array of timeouts, which is then dereferenced, resulting
    in a crash. Make sure at least a single chunk is present.
    
    Problem noticed by George A. Theall <theall@tenablesecurity.com>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 70a00d8615ea4c408978d6efc23c89d4e7c12518
Author: Patrick McHardy <kaber@trash.net>
Date:   Fri Jun 30 05:33:12 2006 +0200

    [PATCH] NETFILTER: SCTP conntrack: fix crash triggered by packet without chunks [CVE-2006-2934]
    
    When a packet without any chunks is received, the newconntrack variable
    in sctp_packet contains an out of bounds value that is used to look up an
    pointer from the array of timeouts, which is then dereferenced, resulting
    in a crash. Make sure at least a single chunk is present.
    
    Problem noticed by George A. Theall <theall@tenablesecurity.com>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit 9c48e1ea8cf8800cc5e2d39ccbb8b5ff9704f8e9
Author: Patrick McHardy <kaber@trash.net>
Date:   Fri Jun 30 05:33:12 2006 +0200

    [PATCH] NETFILTER: SCTP conntrack: fix crash triggered by packet without chunks [CVE-2006-2934]
    
    When a packet without any chunks is received, the newconntrack variable
    in sctp_packet contains an out of bounds value that is used to look up an
    pointer from the array of timeouts, which is then dereferenced, resulting
    in a crash. Make sure at least a single chunk is present.
    
    Problem noticed by George A. Theall <theall@tenablesecurity.com>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit c2ba44b229b04cbd57106107d0047e2c666040ce
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Tue Jun 20 00:09:03 2006 -0700

    [PATCH] SCTP: Fix persistent slowdown in sctp when a gap ack consumes rx buffer.
    
    In the event that our entire receive buffer is full with a series of
    chunks that represent a single gap-ack, and then we accept a chunk
    (or chunks) that fill in the gap between the ctsn and the first gap,
    we renege chunks from the end of the buffer, which effectively does
    nothing but move our gap to the end of our received tsn stream. This
    does little but move our missing tsns down stream a little, and, if the
    sender is sending sufficiently large retransmit frames, the result is a
    perpetual slowdown which can never be recovered from, since the only
    chunk that can be accepted to allow progress in the tsn stream necessitates
    that a new gap be created to make room for it. This leads to a constant
    need for retransmits, and subsequent receiver stalls. The fix I've come up
    with is to deliver the frame without reneging if we have a full receive
    buffer and the receiving sockets sk_receive_queue is empty(indicating that
    the receive buffer is being blocked by a missing tsn).
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit f0a0819784268d7ca479b4538b07124249137500
Author: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
Date:   Tue Jun 20 00:08:29 2006 -0700

    [PATCH] SCTP: Send only 1 window update SACK per message.
    
    Right now, every time we increase our rwnd by more then MTU bytes, we
    trigger a SACK.  When processing large messages, this will generate a
    SACK for almost every other SCTP fragment. However since we are freeing
    the entire message at the same time, we might as well collapse the SACK
    generation to 1.
    
    Signed-off-by: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit ac3e4adefd766840f20e7cad6aa430f3fb491c4d
Author: David Miller <davem@davemloft.net>
Date:   Tue Jun 20 00:06:27 2006 -0700

    [PATCH] SCTP: Reset rtt_in_progress for the chunk when processing its sack.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 8cd8533a381af92ff3febeb0ab82b4d145be1257
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jun 20 00:04:53 2006 -0700

    [PATCH] SCTP: Reject sctp packets with broadcast addresses.
    
    Make SCTP handle broadcast properly
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 617495463a301a956990b87913849dd740e58bcf
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jun 20 00:04:18 2006 -0700

    [PATCH] SCTP: Limit association max_retrans setting in setsockopt.
    
    When using ASSOCINFO socket option, we need to limit the number of
    maximum association retransmissions to be no greater than the sum
    of all the path retransmissions. This is specified in Section 7.1.2
    of the SCTP socket API draft.
    However, we only do this if the association has multiple paths. If
    there is only one path, the protocol stack will use the
    assoc_max_retrans setting when trying to retransmit packets.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit a4cfae13cef6a700a04b13ba1d819c0641b1b26f
Merge: be883da7594b ff7512e1a2a3
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Tue Jun 20 17:39:53 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [ATM]: fix broken uses of NIPQUAD in net/atm
      [SCTP]: sctp_unpack_cookie() fix
      [SCTP]: Fix unintentional change to SCTP_ASSERT when !SCTP_DEBUG
      [NET]: Prevent multiple qdisc runs
      [CONNECTOR]: Initialize subsystem earlier.
      [NETFILTER]: xt_sctp: fix endless loop caused by 0 chunk length

commit 8ca84481b69513f7bf341c7dd9897023a04d7d1d
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Tue Jun 20 03:26:14 2006 -0700

    [SCTP]: sctp_unpack_cookie() fix
    
    sizeof(pointer) != sizeof(array)...
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Andrew Morton <akpm@osdl.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b9d3e52e0e0f95ab5198ac20fbc47b3cb1a63407
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jun 19 19:14:21 2006 +0200

    [PATCH] xt_sctp: fix endless loop caused by 0 chunk length (CVE-2006-3085)
    
    Fix endless loop in the SCTP match similar to those already fixed in the
    SCTP conntrack helper (was CVE-2006-1527).
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit ab46ee26dc90c5608c0d51c33a029fe514c0a49d
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jun 19 19:14:21 2006 +0200

    [PATCH] xt_sctp: fix endless loop caused by 0 chunk length (CVE-2006-3085)
    
    Fix endless loop in the SCTP match similar to those already fixed in the
    SCTP conntrack helper (was CVE-2006-1527).
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 65fd28f743be6e3e3fd8eefa9a517656636fee42
Author: David S. Miller <davem@sunset.davemloft.net>
Date:   Tue Jun 20 00:07:52 2006 -0700

    [SCTP]: Fix unintentional change to SCTP_ASSERT when !SCTP_DEBUG
    
    A local debugging change slipped into a previous changeset.
    
    When SCTP_DEBUG is off SCTP_ASSERT should do nothing.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d3dcd4efe2ad1ad1865b2fe5c863c1ebd9482a84
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon Jun 19 23:39:45 2006 -0700

    [NETFILTER]: xt_sctp: fix endless loop caused by 0 chunk length
    
    Fix endless loop in the SCTP match similar to those already fixed in
    the SCTP conntrack helper (was CVE-2006-1527).
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d0b952a9837f81cd89e756b1b34293fa6e1cb59d
Merge: d90125bfe958 47552c4e555e
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Mon Jun 19 18:55:56 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6: (109 commits)
      [ETHTOOL]: Fix UFO typo
      [SCTP]: Fix persistent slowdown in sctp when a gap ack consumes rx buffer.
      [SCTP]: Send only 1 window update SACK per message.
      [SCTP]: Don't do CRC32C checksum over loopback.
      [SCTP] Reset rtt_in_progress for the chunk when processing its sack.
      [SCTP]: Reject sctp packets with broadcast addresses.
      [SCTP]: Limit association max_retrans setting in setsockopt.
      [PFKEYV2]: Fix inconsistent typing in struct sadb_x_kmprivate.
      [IPV6]: Sum real space for RTAs.
      [IRDA]: Use put_unaligned() in irlmp_do_discovery().
      [BRIDGE]: Add support for NETIF_F_HW_CSUM devices
      [NET]: Add NETIF_F_GEN_CSUM and NETIF_F_ALL_CSUM
      [TG3]: Convert to non-LLTX
      [TG3]: Remove unnecessary tx_lock
      [TCP]: Add tcp_slow_start_after_idle sysctl.
      [BNX2]: Update version and reldate
      [BNX2]: Use CPU native page size
      [BNX2]: Use compressed firmware
      [BNX2]: Add firmware decompression
      [BNX2]: Allow WoL settings on new 5708 chips
      ...
    
    Manual fixup for conflict in drivers/net/tulip/winbond-840.c

commit d5b9f4c083b0e3102f3101545279f623680cb3a0
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Sat Jun 17 22:59:03 2006 -0700

    [SCTP]: Fix persistent slowdown in sctp when a gap ack consumes rx buffer.
    
    In the event that our entire receive buffer is full with a series of
    chunks that represent a single gap-ack, and then we accept a chunk
    (or chunks) that fill in the gap between the ctsn and the first gap,
    we renege chunks from the end of the buffer, which effectively does
    nothing but move our gap to the end of our received tsn stream. This
    does little but move our missing tsns down stream a little, and, if the
    sender is sending sufficiently large retransmit frames, the result is a
    perpetual slowdown which can never be recovered from, since the only
    chunk that can be accepted to allow progress in the tsn stream necessitates
    that a new gap be created to make room for it. This leads to a constant
    need for retransmits, and subsequent receiver stalls. The fix I've come up
    with is to deliver the frame without reneging if we have a full receive
    buffer and the receiving sockets sk_receive_queue is empty(indicating that
    the receive buffer is being blocked by a missing tsn).
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d7c2c9e3977e4312d093ac092761798d4d47c9e0
Author: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
Date:   Sat Jun 17 22:58:28 2006 -0700

    [SCTP]: Send only 1 window update SACK per message.
    
    Right now, every time we increase our rwnd by more then MTU bytes, we
    trigger a SACK.  When processing large messages, this will generate a
    SACK for almost every other SCTP fragment. However since we are freeing
    the entire message at the same time, we might as well collapse the SACK
    generation to 1.
    
    Signed-off-by: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 503b55fd77d11381b1950d1651d3bc782c0cc2cd
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Sat Jun 17 22:57:28 2006 -0700

    [SCTP]: Don't do CRC32C checksum over loopback.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4c9f5d5305a23851e67471b147e0d459a7166717
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Jun 17 22:56:08 2006 -0700

    [SCTP] Reset rtt_in_progress for the chunk when processing its sack.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5636bef7324f49e36f05ec8a5f6284e11b1bcca4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Jun 17 22:55:35 2006 -0700

    [SCTP]: Reject sctp packets with broadcast addresses.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 402d68c43326d2f0e7e2e9a9013cd4c098d9b87c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Sat Jun 17 22:54:51 2006 -0700

    [SCTP]: Limit association max_retrans setting in setsockopt.
    
    When using ASSOCINFO socket option, we need to limit the number of
    maximum association retransmissions to be no greater than the sum
    of all the path retransmissions. This is specified in Section 7.1.2
    of the SCTP socket API draft.
    However, we only do this if the association has multiple paths. If
    there is only one path, the protocol stack will use the
    assoc_max_retrans setting when trying to retransmit packets.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 957dc80ac30f3c4d53259fa936df807663ba54fa
Author: Patrick McHardy <kaber@trash.net>
Date:   Mon May 29 18:19:56 2006 -0700

    [NETFILTER]: x_tables: add SCTP/DCCP support where missing
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1a9807fd86f9a112a39720e99be4eeae7b4e3694
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 14:25:53 2006 -0700

    [PATCH] SCTP: Validate the parameter length in HB-ACK chunk (CVE-2006-1857)
    
    If SCTP receives a badly formatted HB-ACK chunk, it is possible
    that we may access invalid memory and potentially have a buffer
    overflow.  We should really make sure that the chunk format is
    what we expect, before attempting to touch the data.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 0eca2317be1345e056fb75d256099a04c97f7021
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 11:52:20 2006 -0700

    [PATCH] SCTP: Respect the real chunk length when walking parameters (CVE-2006-1858)
    
    When performing bound checks during the parameter processing, we
    want to use the real chunk and paramter lengths for bounds instead
    of the rounded ones.  This prevents us from potentially walking of
    the end if the chunk length was miscalculated.  We still use rounded
    lengths when advancing the pointer. This was found during a
    conformance test that changed the chunk length without modifying
    parameters.
    
    (Vlad noted elsewhere: the most you'd overflow is 3 bytes, so problem
    is parameter dependent).
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit fee9167214e8e515b2a1f68afc34187f2b59c182
Merge: ae83e255045e b89498a1c294
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Fri May 19 16:48:54 2006 -0700

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [SCTP]: Allow linger to abort 1-N style sockets.
      [SCTP]: Validate the parameter length in HB-ACK chunk.
      [SCTP]: Respect the real chunk length when walking parameters.
      [SCTP]: A better solution to fix the race between sctp_peeloff() and
      [SCTP]: Set sk_err so that poll wakes up after a non-blocking connect failure.

commit b89498a1c2941c00889dd025f52dcb653a5083bc
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 14:32:06 2006 -0700

    [SCTP]: Allow linger to abort 1-N style sockets.
    
    Enable SO_LINGER functionality for 1-N style sockets. The socket API
    draft will be clarfied to allow for this functionality. The linger
    settings will apply to all associations on a given socket.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit a601266e4f3c479790f373c2e3122a766d123652
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 14:25:53 2006 -0700

    [SCTP]: Validate the parameter length in HB-ACK chunk.
    
    If SCTP receives a badly formatted HB-ACK chunk, it is possible
    that we may access invalid memory and potentially have a buffer
    overflow.  We should really make sure that the chunk format is
    what we expect, before attempting to touch the data.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit dd2d1c6f2958d027e4591ca5d2a04dfe36ca6512
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 11:52:20 2006 -0700

    [SCTP]: Respect the real chunk length when walking parameters.
    
    When performing bound checks during the parameter processing, we
    want to use the real chunk and paramter lengths for bounds instead
    of the rounded ones.  This prevents us from potentially walking of
    the end if the chunk length was miscalculated.  We still use rounded
    lengths when advancing the pointer. This was found during a
    conformance test that changed the chunk length without modifying
    parameters.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 61c9fed41638249f8b6ca5345064eb1beb50179f
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri May 19 11:01:18 2006 -0700

    [SCTP]: A better solution to fix the race between sctp_peeloff() and
    sctp_rcv().
    
    The goal is to hold the ref on the association/endpoint throughout the
    state-machine process.  We accomplish like this:
    
      /* ref on the assoc/ep is taken during lookup */
    
      if owned_by_user(sk)
            sctp_add_backlog(skb, sk);
      else
            inqueue_push(skb, sk);
    
      /* drop the ref on the assoc/ep */
    
    However, in sctp_add_backlog() we take the ref on assoc/ep and hold it
    while the skb is on the backlog queue.  This allows us to get rid of the
    sock_hold/sock_put in the lookup routines.
    
    Now sctp_backlog_rcv() needs to account for potential association move.
    In the unlikely event that association moved, we need to retest if the
    new socket is locked by user.  If we don't this, we may have two packets
    racing up the stack toward the same socket and we can't deal with it.
    If the new socket is still locked, we'll just add the skb to its backlog
    continuing to hold the ref on the association.  This get's rid of the
    need to move packets from one backlog to another and it also safe in
    case new packets arrive on the same backlog queue.
    
    The last step, is to lock the new socket when we are moving the
    association to it.  This is needed in case any new packets arrive on
    the association when it moved.  We want these to go to the backlog since
    we would like to avoid the race between this new packet and a packet
    that may be sitting on the backlog queue of the old socket toward the
    same association.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 8de8c8738086501bbe3057ed6f4b70dded657488
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 19 10:58:12 2006 -0700

    [SCTP]: Set sk_err so that poll wakes up after a non-blocking connect failure.
    
    Also fix some other cases where sk_err is not set for 1-1 style sockets.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 25958c671804a3829d822fc3ccc3eff534b1aaa0
Author: Vladislav Yasevich <vladsilav.yasevich@hp.com>
Date:   Fri May 5 17:03:49 2006 -0700

    [PATCH] SCTP: Prevent possible infinite recursion with multiple bundled DATA. (CVE-2006-2274)
    
    There is a rare situation that causes lksctp to go into infinite recursion
    and crash the system.  The trigger is a packet that contains at least the
    first two DATA fragments of a message bundled together. The recursion is
    triggered when the user data buffer is smaller that the full data message.
    The problem is that we clone the skb for every fragment in the message.
    When reassembling the full message, we try to link skbs from the "first
    fragment" clone using the frag_list. However, since the frag_list is shared
    between two clones in this rare situation, we end up setting the frag_list
    pointer of the second fragment to point to itself.  This causes
    sctp_skb_pull() to potentially recurse indefinitely.
    
    Proposed solution is to make a copy of the skb when attempting to link
    things using frag_list.
    
    Signed-off-by: Vladislav Yasevich <vladsilav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 2e2a2cd09dd7b3fbc99a1879a54090fd6db16f0c
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri May 5 17:02:09 2006 -0700

    [PATCH] SCTP: Allow spillover of receive buffer to avoid deadlock. (CVE-2006-2275)
    
    This patch fixes a deadlock situation in the receive path by allowing
    temporary spillover of the receive buffer.
    
    - If the chunk we receive has a tsn that immediately follows the ctsn,
      accept it even if we run out of receive buffer space and renege data with
      higher TSNs.
    - Once we accept one chunk in a packet, accept all the remaining chunks
      even if we run out of receive buffer space.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Mark Butler <butlerm@middle.net>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit cb19baa0bb7a4064e6d0c99e8f479673120a9f28
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 5 17:05:23 2006 -0700

    [PATCH] SCTP: Fix state table entries for chunks received in CLOSED state. (CVE-2006-2271)
    
    Discard an unexpected chunk in CLOSED state rather can calling BUG().
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 40885c13b394cd1b74acc196f1d7990a3e0a484d
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 5 17:04:43 2006 -0700

    [PATCH] SCTP: Fix panic's when receiving fragmented SCTP control chunks. (CVE-2006-2272)
    
    Use pskb_pull() to handle incoming COOKIE_ECHO and HEARTBEAT chunks that
    are received as skb's with fragment list.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Chris Wright <chrisw@sous-sol.org>

commit 35d63edb1c807bc5317e49592260e84637bc432e
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 5 17:05:23 2006 -0700

    [SCTP]: Fix state table entries for chunks received in CLOSED state.
    
    Discard an unexpected chunk in CLOSED state rather can calling BUG().
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 62b08083ec3dbfd7e533c8d230dd1d8191a6e813
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Fri May 5 17:04:43 2006 -0700

    [SCTP]: Fix panic's when receiving fragmented SCTP control chunks.
    
    Use pskb_pull() to handle incoming COOKIE_ECHO and HEARTBEAT chunks that
    are received as skb's with fragment list.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 672e7cca17ed6036a1756ed34cf20dbd72d5e5f6
Author: Vladislav Yasevich <vladsilav.yasevich@hp.com>
Date:   Fri May 5 17:03:49 2006 -0700

    [SCTP]: Prevent possible infinite recursion with multiple bundled DATA.
    
    There is a rare situation that causes lksctp to go into infinite recursion
    and crash the system.  The trigger is a packet that contains at least the
    first two DATA fragments of a message bundled together. The recursion is
    triggered when the user data buffer is smaller that the full data message.
    The problem is that we clone the skb for every fragment in the message.
    When reassembling the full message, we try to link skbs from the "first
    fragment" clone using the frag_list. However, since the frag_list is shared
    between two clones in this rare situation, we end up setting the frag_list
    pointer of the second fragment to point to itself.  This causes
    sctp_skb_pull() to potentially recurse indefinitely.
    
    Proposed solution is to make a copy of the skb when attempting to link
    things using frag_list.
    
    Signed-off-by: Vladislav Yasevich <vladsilav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 7c3ceb4fb9667f34f1599a062efecf4cdc4a4ce5
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri May 5 17:02:09 2006 -0700

    [SCTP]: Allow spillover of receive buffer to avoid deadlock.
    
    This patch fixes a deadlock situation in the receive path by allowing
    temporary spillover of the receive buffer.
    
    - If the chunk we receive has a tsn that immediately follows the ctsn,
      accept it even if we run out of receive buffer space and renege data with
      higher TSNs.
    - Once we accept one chunk in a packet, accept all the remaining chunks
      even if we run out of receive buffer space.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Acked-by: Mark Butler <butlerm@middle.net>
    Acked-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e17df688f7064dae1417ce425dd1e4b71d24d63b
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue May 2 23:23:07 2006 +0200

    [NETFILTER] SCTP conntrack: fix infinite loop
    
    fix infinite loop in the SCTP-netfilter code: check SCTP chunk size to
    guarantee progress of for_each_sctp_chunk(). (all other uses of
    for_each_sctp_chunk() are preceded by do_basic_checks(), so this fix
    should be complete.)
    
    Based on patch from Ingo Molnar <mingo@elte.hu>
    
    CVE-2006-1527
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

commit 25b6badde42165b717e3c232e4992b3f6761920a
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue May 2 23:23:07 2006 +0200

    [PATCH] NETFILTER: SCTP conntrack: fix infinite loop (CVE-2006-1527)
    
    [NETFILTER]: SCTP conntrack: fix infinite loop
    
    fix infinite loop in the SCTP-netfilter code: check SCTP chunk size to
    guarantee progress of for_each_sctp_chunk(). (all other uses of
    for_each_sctp_chunk() are preceded by do_basic_checks(), so this fix
    should be complete.)
    
    Based on patch from Ingo Molnar <mingo@elte.hu>
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

commit b55813a2e50088ca30df33fa62aeed5d3adb1796
Merge: 368d17e068f6 9e19bb6d7a09
Author: Linus Torvalds <torvalds@g5.osdl.org>
Date:   Sat Mar 25 08:39:20 2006 -0800

    Merge master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6
    
    * master.kernel.org:/pub/scm/linux/kernel/git/davem/net-2.6:
      [NETFILTER] x_table.c: sem2mutex
      [IPV4]: Aggregate route entries with different TOS values
      [TCP]: Mark tcp_*mem[] __read_mostly.
      [TCP]: Set default max buffers from memory pool size
      [SCTP]: Fix up sctp_rcv return value
      [NET]: Take RTNL when unregistering notifier
      [WIRELESS]: Fix config dependencies.
      [NET]: Fill in a 32-bit hole in struct sock on 64-bit platforms.
      [NET]: Ensure device name passed to SO_BINDTODEVICE is NULL terminated.
      [MODULES]: Don't allow statically declared exports
      [BRIDGE]: Unaligned accesses in the ethernet bridge

commit 2babf9daae4a3561f3264638a22ac7d0b14a6f52
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sat Mar 25 01:25:29 2006 -0800

    [SCTP]: Fix up sctp_rcv return value
    
    I was working on the ipip/xfrm problem and as usual I get side-tracked by
    other problems.
    
    As part of an attempt to change the IPv4 protocol handler calling
    convention I found that SCTP violated the existing convention.
    
    It's returning non-zero values after freeing the skb.  This is doubly bad
    as 1) the skb gets resubmitted; 2) the return value is interpreted as a
    protocol number.
    
    This patch changes those return values to zero.
    
    IPv6 doesn't suffer from this problem because it uses a positive return
    value as an indication for resubmission.  So the only effect of this patch
    there is to increment the IPSTATS_MIB_INDELIVERS counter which IMHO is
    the right thing to do.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 27852c26baab8b95fc9a2b3e8a18770ecd553f10
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Feb 2 16:57:31 2006 -0800

    [SCTP]: Fix 'fast retransmit' to send a TSN only once.
    
    SCTP used to "fast retransmit" a TSN every time we hit the number
    of missing reports for the TSN.  However the Implementers Guide
    specifies that we should only "fast retransmit" a given TSN once.
    Subsequent retransmits should be timeouts only. Also change the
    number of missing reports to 3 as per the latest IG(similar to TCP).
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit e2c2fc2c8f3750e1f7ffbb3ac2b885a49416110c
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 30 16:00:40 2006 -0800

    [SCTP]: heartbeats exceed maximum retransmssion limit
    
    The number of HEARTBEAT chunks that an association may transmit is
    limited by Association.Max.Retrans count; however, the code allows
    us to send one extra heartbeat.
    
    This patch limits the number of heartbeats to the maximum count.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 81845c21dc1ec7ce2bf12845dbc01e4880f9ea9a
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jan 30 15:59:54 2006 -0800

    [SCTP]: correct the number of INIT retransmissions
    
    We currently count the initial INIT/COOKIE_ECHO chunk toward the
    retransmit count and thus sends a total of sctp_max_retrans_init chunks.
    The correct behavior is to retransmit the chunk sctp_max_retrans_init in
    addition to sending the original.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ab67a4d511188680beb8a0d82a90f55dbeb53d5c
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jan 17 13:01:31 2006 -0800

    [EBTABLES]: Handle SCTP/DCCP in ebt_{ip,log}
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ae82af54d73becd66804d942cf39b049e625fa89
Author: Patrick McHardy <kaber@trash.net>
Date:   Tue Jan 17 13:01:06 2006 -0800

    [PKT_SCHED]: Handle SCTP/DCCP in sfq_hash
    
    Signed-off-by: Patrick McHardy <kaber@trash.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit a7d1f1b66c05ef4ebb58a34be7caad9af15546a4
Author: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
Date:   Tue Jan 17 11:57:09 2006 -0800

    [SCTP]: Fix sctp_rcv_ootb() to handle the last chunk of a packet correctly.
    
    Signed-off-by: Tsutomu Fujii <t-fujii@nb.jp.nec.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit c4d2444e992c4eda1d7fc3287e93ba58295bf6b9
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Tue Jan 17 11:56:26 2006 -0800

    [SCTP]: Fix couple of races between sctp_peeloff() and sctp_rcv().
    
    Validate and update the sk in sctp_rcv() to avoid the race where an
    assoc/ep could move to a different socket after we get the sk, but before
    the skb is added to the backlog.
    
    Also migrate the skb's in backlog queue to new sk when doing a peeloff.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 313e7b4d2588539e388d31c1febd50503a0083fc
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 17 11:55:57 2006 -0800

    [SCTP]: Fix machine check/connection hang on IA64.
    
    sctp_unpack_cookie used an on-stack array called digest as a result/out
    parameter in the call to crypto_hmac. However, hmac code
    (crypto_hmac_final)
    assumes that the 'out' argument is in virtual memory (identity mapped
    region)
    and can use virt_to_page call on it.  This does not work with the on-stack
    declared digest.  The problems observed so far have been:
     a) incorrect hmac digest
     b) machine check and hardware reset.
    
    Solution is to define the digest in an identity mapped region by
    kmalloc'ing
    it.  We can do this once as part of the endpoint structure and re-use it
    when
    verifying the SCTP cookie.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 8116ffad4180b39d7a755345c1fde09da83930c0
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 17 11:55:17 2006 -0800

    [SCTP]: Fix bad sysctl formatting of SCTP timeout values on 64-bit m/cs.
    
    Change all the structure members that hold jiffies to be of type
    unsigned long.  This also corrects bad sysctl formating on 64 bit
    architectures.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 38b0e42aba928d9929a26ec23b850c36a31fca5f
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 17 11:54:06 2006 -0800

    [SCTP]: Fix sctp_assoc_seq_show() panics on big-endian systems.
    
    This patch corrects the panic by casting the argument to the
    pointer of correct size.  On big-endian systems we ended up loading
    only 32 bits of data because we are treating the pointer as an int*.
    By treating this pointer as loff_t*, we'll load the full 64 bits
    and then let regular integer demotion take place which will give us
    the correct value.
    
    Signed-off-by: Vlad Yaseivch <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 49392e5ecf608da6770fd8723b534a0fc851edc4
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 17 11:53:06 2006 -0800

    [SCTP]: sctp doesn't show all associations/endpoints in /proc
    
    When creating a very large number of associations (and endpoints),
    /proc/assocs and /proc/eps will not show all of them.  As a result
    netstat will not show all of the either.  This is particularly evident
    when creating 1000+ associations (or endpoints).  As an example with
    1500 tcp style associations over loopback, netstat showed 1420 on my
    system instead of 3000.
    
    The reason for this is that the seq_operations start method is invoked
    multiple times bacause of the amount of data that is provided.  The
    start method always increments the position parameter and since we use
    the position as the hash bucket id, we end up skipping hash buckets.
    
    This patch corrects this situation and get's rid of the silly hash-1
    decrement.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 9834a2bb4970547540222fcba04e0a37d04cb0a0
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jan 17 11:52:12 2006 -0800

    [SCTP]: Fix sctp_cookie alignment in the packet.
    
    On 64 bit architectures, sctp_cookie sent as part of INIT-ACK is not
    aligned on a 64 bit boundry and thus causes unaligned access exceptions.
    
    The layout of the cookie prameter is this:
    |<----- Parameter Header --------------------|<--- Cookie DATA --------
    -----------------------------------------------------------------------
    | param type (16 bits) | param len (16 bits) | sig [32 bytes] | cookie..
    -----------------------------------------------------------------------
    
    The cookie data portion contains 64 bit values on 64 bit architechtures
    (timeval) that fall on a 32 bit alignment boundry when used as part of
    the on-wire format, but align correctly when used in internal
    structures.  This patch explicitely pads the on-wire format so that
    it is properly aligned.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 7a48f923b8b27bfaa5f7b2a449a6fe268724ddd5
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Tue Jan 17 11:51:28 2006 -0800

    [SCTP]: Fix potential race condition between sctp_close() and sctp_rcv().
    
    Do not release the reference to association/endpoint if an incoming skb is
    added to backlog. Instead release it after the chunk is processed in
    sctp_backlog_rcv().
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>

commit 7708610b1bff4a0ba8a73733d3c7c4bda9f94b21
Author: Frank Filz <ffilz@us.ibm.com>
Date:   Thu Dec 22 11:37:30 2005 -0800

    [SCTP]: Add support for SCTP_DELAYED_ACK_TIME socket option.
    
    Signed-off-by: Frank Filz <ffilz@us.ibm.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 52ccb8e90c0ace233b8b740f2fc5de0dbd706b27
Author: Frank Filz <ffilz@us.ibm.com>
Date:   Thu Dec 22 11:36:46 2005 -0800

    [SCTP]: Update SCTP_PEER_ADDR_PARAMS socket option to the latest api draft.
    
    This patch adds support to set/get heartbeat interval, maximum number of
    retransmissions, pathmtu, sackdelay time for a particular transport/
    association/socket as per the latest SCTP sockets api draft11.
    
    Signed-off-by: Frank Filz <ffilz@us.ibm.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 9bffc4ace1ed875667dbe5b29065d96bec558c62
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Mon Dec 19 14:24:40 2005 -0800

    [SCTP]: Fix sctp to not return erroneous POLLOUT events.
    
    Make sctp_writeable() use sk_wmem_alloc rather than sk_wmem_queued to
    determine the sndbuf space available. It also removes all the modifications
    to sk_wmem_queued as it is not currently used in SCTP.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bf031fff1fac77775b2cd2c72ad8b017f4c0af13
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Dec 2 20:32:29 2005 -0800

    [SCTP]: Fix getsockname for sctp when an ipv6 socket accepts a connection from
    an ipv4 socket.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6736dc35e9e1b9c8084d5c362a429a3e8189af6b
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Dec 2 20:30:06 2005 -0800

    [SCTP]: Return socket errors only if the receive queue is empty.
    
    This patch fixes an issue where it is possible to get valid data after
    a ENOTCONN error. It returns socket errors only after data queued on
    socket receive queue is consumed.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 049b3ff5a86d0187184a189d2e31b8654d58fe22
Author: Neil Horman <nhorman@tuxdriver.com>
Date:   Fri Nov 11 16:08:24 2005 -0800

    [SCTP]: Include ulpevents in socket receive buffer accounting.
    
    Also introduces a sysctl option to configure the receive buffer
    accounting policy to be either at socket or association level.
    Default is all the associations on the same socket share the
    receive buffer.
    
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 19c7e9eef503dc1ae926f3d26c56f88bee568d7b
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 11 16:07:40 2005 -0800

    [SCTP]: Fix ia64 NaT consumption fault with sctp_sideffect commands.
    
    On ia64, it is possible to get NaT Consumption Fault and a kernel panic
    when initializing sctp sideeffect commands arguments.  The union
    sctp_arg_t contains different sized elements and when loading a smaller
    sized element (32 or 16 bits), it is possible for a speculative load to
    fail and result in a NaT bit set which causes a kernel crash.  The easy
    way to get around it is to load the largerst member of the union.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1e7d3d90c95b32374057e454417b2f50440be20e
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 11 16:06:16 2005 -0800

    [SCTP]: Remove timeouts[] array from sctp_endpoint.
    
    The socket level timeout values are maintained in sctp_sock and
    association level timeouts are in sctp_association. So there is
    no need for ep->timeouts.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 23ec47a0889dabf4b9e7f8d52e848194734159ee
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Fri Nov 11 16:05:55 2005 -0800

    [SCTP]: Fix potential NULL pointer dereference in sctp_v4_get_saddr
    
    It is possible to get to sctp_v4_get_saddr() without a valid
    association.  This happens when processing OOTB packets and
    the cached route entry is no longer valid.
    However, when responding to OOTB packets we already properly
    set the source address based on the information in the OOTB
    packet.  So, if we we get to sctp_v4_get_saddr() without an
    association we can simply return.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 64a0c1c81e300f0f56f26604c81040784e3717f0
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Fri Oct 28 15:39:02 2005 -0700

    [SCTP] Do not allow unprivileged programs initiating new associations on
    privileged ports.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 96a339985d4c6874d32909e8f1903e6e6c141399
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Fri Oct 28 15:36:12 2005 -0700

    [SCTP] Allow SCTP_MAXSEG to revert to default frag point with a '0' value.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit a1ab3582699def352dab1355adcadd3d47f79f0f
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Fri Oct 28 15:33:24 2005 -0700

    [SCTP] Fix SCTP_SETADAPTION sockopt to use the correct structure.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit eaa5c54dbec70e2a93d6ed412bb589bbf9c90a17
Author: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
Date:   Fri Oct 28 15:10:00 2005 -0700

    [SCTP] Rename SCTP specific control message flags.
    
    Rename SCTP specific control message flags to use SCTP_ prefix rather than
    MSG_ prefix as per the latest sctp sockets API draft.
    
    Signed-off-by: Ivan Skytte Jorgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>

commit 20c9c825b12fcb8526a29cf20a17a5a3fc581726
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Thu Oct 6 21:37:01 2005 -0700

    [SCTP] Fix SCTP socket options to work with 32-bit apps on 64-bit kernels.
    
    Adds alignment attribute to a few structures used with SCTP socket
    options so that the sizes and offsets remain the same when built using
    either 32 or 64 bit tools.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5fe467ee9787007dd9b263eb42dde3742deb743b
Author: Ivan Skytte Jrgensen <isj-sctp@i1.dk>
Date:   Thu Oct 6 21:36:17 2005 -0700

    [SCTP] Fix sctp_get{pl}addrs() API to work with 32-bit apps on 64-bit kernels.
    
    The old socket options are marked with a _OLD suffix so that the
    existing 32-bit apps on 32-bit kernels do not break.
    
    Signed-off-by: Ivan Skytte Jrgensen <isj-sctp@i1.dk>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 13402580021a52e49c6d1068ff28ade4d5a175f1
Author: James Morris <jmorris@namei.org>
Date:   Fri Sep 30 14:24:34 2005 -0400

    [PATCH] SELinux - fix SCTP socket bug and general IP protocol handling
    
    The following patch updates the way SELinux classifies and handles IP
    based protocols.
    
    Currently, IP sockets are classified by SELinux as being either TCP, UDP
    or 'Raw', the latter being a default for IP socket that is not TCP or UDP.
    
    The classification code is out of date and uses only the socket type
    parameter to socket(2) to determine the class of IP socket.  So, any
    socket created with SOCK_STREAM will be classified by SELinux as TCP, and
    SOCK_DGRAM as UDP.  Also, other socket types such as SOCK_SEQPACKET and
    SOCK_DCCP are currently ignored by SELinux, which classifies them as
    generic sockets, which means they don't even get basic IP level checking.
    
    This patch changes the SELinux IP socket classification logic, so that
    only an IPPROTO_IP protocol value passed to socket(2) classify the socket
    as TCP or UDP.  The patch also drops the check for SOCK_RAW and converts
    it into a default, so that socket types like SOCK_DCCP and SOCK_SEQPACKET
    are classified as SECCLASS_RAWIP_SOCKET (instead of generic sockets).
    
    Note that protocol-specific support for SCTP, DCCP etc. is not addressed
    here, we're just getting these protocols checked at the IP layer.
    
    This fixes a reported problem where SCTP sockets were being recognized as
    generic SELinux sockets yet still being passed in one case to an IP level
    check, which then fails for generic sockets.
    
    It will also fix bugs where any SOCK_STREAM socket is classified as TCP or
    any SOCK_DGRAM socket is classified as UDP.
    
    This patch also unifies the way IP sockets classes are determined in
    selinux_socket_bind(), so we use the already calculated value instead of
    trying to recalculate it.
    
    Signed-off-by: James Morris <jmorris@namei.org>
    Signed-off-by: Stephen Smalley <sds@tycho.nsa.gov>
    Signed-off-by: Linus Torvalds <torvalds@osdl.org>

commit 8ddec7460d2f5db3ac35812c03676b1473d1d668
Author: Harald Welte <laforge@netfilter.org>
Date:   Sat Sep 24 16:56:08 2005 -0700

    [NETFILTER] ip_conntrack: Update event cache when status changes
    
    The GRE, SCTP and TCP protocol helpers did not call
    ip_conntrack_event_cache() when updating ct->status.  This patch adds
    the respective calls.
    
    Signed-off-by: Harald Welte <laforge@netfilter.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit eb0e0076878a4f9e8e6e7e524ded0d6f7d4a6130
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Thu Sep 22 23:48:38 2005 -0700

    [SCTP]: Fix SCTP_SHUTDOWN notifications.
    
    Fix to allow SCTP_SHUTDOWN notifications to be received on 1-1 style
    SCTP SOCK_STREAM sockets.
    
    Add SCTP_SHUTDOWN notification to the receive queue before updating
    the state of the association.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: Neil Horman <nhorman@tuxdriver.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8c5955d83ed26455a49d12e783cc2258d11279a9
Author: Adrian Bunk <bunk@stusta.de>
Date:   Mon Sep 5 18:07:42 2005 -0700

    [SCTP]: net/sctp/sysctl.c should #include <net/sctp/sctp.h>
    
    Every file should #include the header files containing the prototypes of
    it's global functions.
    
    sctp.h contains the prototypes of sctp_sysctl_{,un}register().
    
    Signed-off-by: Adrian Bunk <bunk@stusta.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 8728b834b226ffcf2c94a58530090e292af2a7bf
Author: David S. Miller <davem@davemloft.net>
Date:   Tue Aug 9 19:25:21 2005 -0700

    [NET]: Kill skb->list
    
    Remove the "list" member of struct sk_buff, as it is entirely
    redundant.  All SKB list removal callers know which list the
    SKB is on, so storing this in sk_buff does nothing other than
    taking up some space.
    
    Two tricky bits were SCTP, which I took care of, and two ATM
    drivers which Francois Romieu <romieu@fr.zoreil.com> fixed
    up.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Francois Romieu <romieu@fr.zoreil.com>

commit d2287f844187158e5eddd0d5de8e95bd607abcb7
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Aug 23 10:12:04 2005 -0700

    [SCTP]: Add SENTINEL to SCTP MIB stats
    
    Add SNMP_MIB_SENTINEL to the definition of the sctp_snmp_list so that
    the output routine in proc correctly terminates.  This was causing some
    problems running on ia64 systems.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit d1ad1ff299dd908d07c5e5f27f88bbdb235eb7a5
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Mon Jul 18 13:44:10 2005 -0700

    [SCTP]: Fix potential null pointer dereference while handling an icmp error
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit ee71a29eb5e341fe977c5ad7a43782c29bd9cb9e
Author: Christophe Lucas <clucas@rotomalug.org>
Date:   Mon Jul 18 13:38:07 2005 -0700

    [SCTP]: Audit return code of create_proc_*
    
    From: Christophe Lucas <clucas@rotomalug.org>
    
    Audit return of create_proc_* functions.
    
    Signed-off-by: Christophe Lucas <clucas@rotomalug.org>
    Signed-off-by: Domen Puncer <domen@coderock.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3182cd84f0e132558bbe106c070405ae49f1f0e3
Author: Alexey Dobriyan <adobriyan@gmail.com>
Date:   Mon Jul 11 20:57:47 2005 -0700

    [SCTP]: __nocast annotations
    
    Signed-off-by: Alexey Dobriyan <adobriyan@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 79af02c2538d54ff0dcd3f43646f506207f2ee62
Author: David S. Miller <davem@davemloft.net>
Date:   Fri Jul 8 21:47:49 2005 -0700

    [SCTP]: Use struct list_head for chunk lists, not sk_buff_head.
    
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2f85a42964dd43fed3a339701db046bee5a8b903
Author: Vlad Yasevich <vladislav.yasevich@hp.com>
Date:   Tue Jun 28 13:24:23 2005 -0700

    [SCTP] Make init & delayed sack timeouts configurable by user.
    
    Signed-off-by: Vlad Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 3f7a87d2fa9b42f7aade43914f060df68cc89cc7
Author: Frank Filz <ffilzlnx@us.ibm.com>
Date:   Mon Jun 20 13:14:57 2005 -0700

    [SCTP] sctp_connectx() API support
    
    Implements sctp_connectx() as defined in the SCTP sockets API draft by
    tunneling the request through a setsockopt().
    
    Signed-off-by: Frank Filz <ffilzlnx@us.ibm.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 1e061ab2e5aa50a84d68ca654773632f9c425bb6
Author: Herbert Xu <herbert@gondor.apana.org.au>
Date:   Sat Jun 18 22:56:42 2005 -0700

    [SCTP]: Replace spin_lock_irqsave with spin_lock_bh
    
    This patch replaces the spin_lock_irqsave call on the receive queue
    lock in SCTP with spin_lock_bh.  Despite the proliferation of
    spin_lock_irqsave calls in this stack, it is only entered from the
    IPv4/IPv6 stack and user space.  That is, it is never entered from
    hardirq context.
    
    The call in question is only called from recvmsg which means that
    IRQs aren't disabled.  Therefore it is safe to replace it with
    spin_lock_bh.
    
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 6a6ddb2a9c11fcc3e8d7517841d28c9ea206ddef
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Mon Jun 13 15:13:05 2005 -0700

    [SCTP] Fix incorrect setting of sk_bound_dev_if when binding/sending to a ipv6
    link local address.
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit cdac4e07748934e37e415437055ed591aed9eb21
Author: Neil Horman <nhorman@redhat.com>
Date:   Mon Jun 13 15:12:33 2005 -0700

    [SCTP] Add support for ip_nonlocal_bind sysctl & IP_FREEBIND socket option
    
    Signed-off-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit bca735bd0d5969497704a125b05344b92155172f
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jun 13 15:11:57 2005 -0700

    [SCTP] Extend the info exported via /proc/net/sctp to support netstat for SCTP.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 0fd9a65a76e883b7d16e72dde3f8bf20ebc1e82a
Author: Neil Horman <nhorman@redhat.com>
Date:   Mon Jun 13 15:11:24 2005 -0700

    [SCTP] Support SO_BINDTODEVICE socket option on incoming packets.
    
    Signed-off-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4243cac1e76228f7ba916d5df9e75a219352160a
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Mon Jun 13 15:10:49 2005 -0700

    [SCTP]: Fix bug in restart of peeled-off associations.
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 4eb701dfc618491c9b97377df6e61de36dfc39ce
Author: Neil Horman <nhorman@redhat.com>
Date:   Thu Apr 28 12:02:04 2005 -0700

    [SCTP] Fix SCTP sendbuffer accouting.
    
    - Include chunk and skb sizes in sendbuffer accounting.
    - 2 policies are supported. 0: per socket accouting, 1: per association
      accounting
    
    DaveM: I've made the default per-socket.
    
    Signed-off-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 594ccc14dfe4d61b476491758425a1c2ca4ec71b
Author: Sridhar Samudrala <sri@us.ibm.com>
Date:   Thu Apr 28 12:00:23 2005 -0700

    [SCTP] Replace incorrect use of dev_alloc_skb with alloc_skb in sctp_packet_transmit().
    
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 5e6bc34f86e450ff14c4817902d66aa9c786bc06
Author: Neil Horman <nhorman@redhat.com>
Date:   Thu Apr 28 11:59:49 2005 -0700

    [SCTP] Fix bug in sctp_init() error handling code.
    
    Signed-off-by: Neil Horman <nhorman@redhat.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit b9b9e10f180fa63b55b93412edf0ab9648675646
Author: Brian Haley <Brian.Haley@hp.com>
Date:   Thu Apr 28 11:59:16 2005 -0700

    [SCTP] Use ipv6_addr_any() rather than ipv6_addr_type() in sctp_v6_is_any().
    
    Signed-off-by: Brian Haley <Brian.Haley@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 047a2428a14216a83980ed26b6a59b3ca40a1fb0
Author: Jerome Forissier <jerome.forissier@hp.com>
Date:   Thu Apr 28 11:58:43 2005 -0700

    [SCTP] Implement Sec 2.41 of SCTP Implementers guide.
    
    - Fixed sctp_vtag_verify_either() to comply with impguide 2.41 B) and C).
    - Make sure vtag is reflected when T-bit is set in SHUTDOWN-COMPLETE sent
      due to an OOTB SHUTDOWN-ACK and in ABORT sent due to an OOTB packet.
    - Do not set T-Bit in ABORT chunk in response to INIT.
    - Fixed some comments to reflect the new meaning of the T-Bit.
    
    Signed-off-by: Jerome Forissier <jerome.forissier@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 173372162ddbd414cc471c1a3a52ad7ea279aaf4
Author: Vladislav Yasevich <vladislav.yasevich@hp.com>
Date:   Thu Apr 28 11:57:54 2005 -0700

    [SCTP] Fix SCTP_ASSOCINFO getsockopt for 1-1 style
    
    Signed-off-by: Vladislav Yasevich <vladislav.yasevich@hp.com>
    Signed-off-by: Sridhar Samudrala <sri@us.ibm.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

commit 2fac6f3fec2303649e9cd572255776cb93d3f888
Author: Deepak Saxena <dsaxena@net.rmk.(none)>
Date:   Mon Apr 25 23:40:05 2005 +0100

    [PATCH] ARM: 2653/1: Fix memset and memzero macro double-reference of parameters
    
    Patch from Deepak Saxena
    
    The current memset() and memzero() macros on ARM reference the
    incoming parameters more than once and this can cause uninted
    side-effects. The issue was found while debugging SCTP protocol
    and with the specific usage of memzero(skb_put(skb,size),size).
    This call would call skb_put(skb,size) twice leading to badness.
    The fixed version copies the incoming parameters into local
    variables and uses those instead.
    
    Signed-off-by: Deepak Saxena
    Signed-off-by: Russell King

commit edec231a8a652384cb6d61e648338aa5155f2b72
Author: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
Date:   Sun Apr 24 20:22:28 2005 -0700

    [IPV6]: export inet6_sock_nr
    
    Please apply, SCTP/DCCP needs this when INET_REFCNT_DEBUG
    is set.
    
    Signed-off-by: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
